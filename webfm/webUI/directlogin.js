/* Copyright (c) 2015 Synology Inc. All rights reserved. */

SYNOFILESTATION_LOGINDIALOG=Ext.extend(Ext.form.FormPanel,{form:null,messageContainer:null,text_field_password:null,photo_url:null,IsHandheldIOSWinDeviceBrowser:(/iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile|windows phone os 7|windows phone 8/i.test(navigator.userAgent)),constructor:function(a){a=a?a:{};Ext.form.FormPanel.superclass.constructor.call(this,Ext.apply(this.fillConfig(),a))},fillConfig:function(){this.messageContainer=new Ext.form.DisplayField({style:"margin-top: 10px; font-size: 12px",hideLabel:true,autoScroll:false,value:"",disableKeyFilter:true});this.desc=new Ext.form.DisplayField({hideLabel:true,autoScroll:false,value:g_LoginDesc,cls:"desc",disableKeyFilter:true});this.text_field_username=new Ext.form.TextField({tabIndex:2,hideLabel:true,name:"name",width:196,height:40,validateOnBlur:true,validationEvent:"blur",disableKeyFilter:true,listeners:{afterrender:function(b){b.el.set({placeholder:g_LoginName})},scope:this}});this.text_field_password=new Ext.form.TextField({tabIndex:2,hideLabel:true,name:"pwd",inputType:"password",width:196,height:40,validateOnBlur:true,validationEvent:"blur",el:"webfm-login_passwd",disableKeyFilter:true,listeners:{afterrender:function(b){b.el.set({placeholder:g_LoginPasswd})},scope:this}});Ext.fly("webfm-sds-login-dialog").dom.removeAttribute("style");var a={applyTo:"webfm-sds-login-dialog",standardSubmit:true,url:"fbdownload",method:"POST",labelAlign:"right",buttonAlign:"right",trackResetOnLoad:true,height:220,width:500,border:false,formId:"webfm-login-form",bodyCfg:{onsubmit:"return true;",target:"webfm-login_iframe"},items:[this.desc,{xtype:"compositefield",hideLabel:true,hidden:(b_dsuser==="true")?false:true,items:[this.text_field_username]},{xtype:"compositefield",hideLabel:true,hidden:(b_pwd==="true"||b_dsuser==="true")?false:true,items:[this.text_field_password,{xtype:"button",id:"webfm-login-btn",iconCls:"submitbutton",scope:this,handler:this.onClickSubmit}]},{xtype:"box",hidden:(b_pwd==="true")?false:true,cls:"hline"},{xtype:"compositefield",hideLabel:true,items:[{xtype:"syno_button",id:"facebook_login_btn",text:g_facebookLogin,cls:"facebook-login-btn ",iconCls:"facebook-icon-left",hidden:(b_facebook==="true")?false:true,handler:this.onFacebookLogin,scope:this},{xtype:"syno_button",id:"google_login_btn",cls:"google-login-btn",iconCls:"google-icon-left",text:g_googleLogin,hidden:(b_google==="true")?false:true,handler:this.onGoogleLogin,scope:this},{xtype:"displayfield"}]},{id:"webfm-login_submit",xtype:"field",hideLabel:true,name:"webfm-login_submit",autoCreate:{tag:"input",type:"submit",style:"position: absolute; top: -10000px; left: -10000px;",tabindex:"-1"}},this.messageContainer,{xtype:"hidden",name:SYNO.Encryption.CipherKey}],keys:[{key:[10,13],fn:this.onClickSubmit,scope:this}],listeners:{afterlayout:{fn:this.onAfterLayout,scope:this,single:true}}};return a},initComponent:function(){this.form=this.createForm();Ext.form.FormPanel.superclass.initComponent.call(this);this.bodyCfg=Ext.applyIf(this.bodyCfg||{},{tag:"form",cls:this.baseCls+"-body",method:this.method||"POST",id:this.formId||Ext.id()});if(this.fileUpload){this.bodyCfg.enctype="multipart/form-data"}this.initItems();this.addEvents("clientvalidation");this.relayEvents(this.form,["beforeaction","actionfailed","actioncomplete"])},onAfterLayout:function(){this.btnLogin=Ext.getCmp("webfm-login-btn");this.mon(this.form.el,"submit",this.onSubmit,this)},focusField:function(){if("true"===b_dsuser){this.text_field_username.focus(true,500)}else{this.text_field_password.focus(true,500)}},onSubmit:function(h){var c=this.form.findField("pwd"),a=this.form.findField("name"),g=SYNO.Encryption.CipherKey,d="",b=this.form.findField(g),i={};if(this.submitType==="passwd"){if(!this.isValidate()){h.stopEvent();return false}i[c.getName()]=c.getValue();if("true"===b_dsuser){i[a.getName()]=a.getValue()}else{a.setValue("");i[a.getName()]=""}}else{if(this.submitType==="socialAuth"){i.social_id=window.socialResp.uid;i.access_token=window.socialResp.token;window.socialResp=""}else{h.stopEvent();return false}}i.k=g_key;i.api="SYNO.FileStation.Download";i.version="1";i.method="download";i.mode="download";i=SYNO.Encryption.EncryptParam(i);d=i[g]||"";b.setValue(d);this.initIFrameEvent();this.setFormDisabled(true,!!d);var f=this.messageContainer.getEl();f.dom.innerHTML=g_DownloadDesc},isValidate:function(){var b=this.form.findField("pwd");var a=this.form.findField("name");var c;if("true"===b_dsuser&&a&&a.getValue()===""){c=this.messageContainer.getEl();c.dom.innerHTML="<font color='#FF0000'>"+g_NoUsername+"</font><br>";return false}if("false"===b_dsuser&&b&&b.getValue()===""){c=this.messageContainer.getEl();c.dom.innerHTML="<font color='#FF0000'>"+g_NoPasswd+"</font><br>";return false}return true},setFormDisabled:function(c,d){var b=this.form.findField("pwd");var a=this.form.findField("name");this.btnLogin.setDisabled(c);b.setReadOnly(c);a.setReadOnly(c);if(!c||d){b.setDisabled(c);a.setReadOnly(c)}},initIFrameEvent:function(){var a=this;if(a.iframe){return}a.iframe=Ext.get("webfm-login_iframe");if(Ext.isIE){a.iframe.dom.onreadystatechange=function(){if("complete"!==this.readyState&&"loaded"!==this.readyState){return}a.onCallback()}}else{a.iframe.dom.onload=function(){a.onCallback()}}},reset:function(){this.form.reset();var a=this.messageContainer.getEl();a.dom.innerHTML=""},onClickSubmit:function(){if(!this.isValidate()){return false}if(this.form.isValid()){this.submitType="passwd";Ext.getDom("webfm-login_submit").click()}},onFacebookLogin:function(){window._loginCallback=this.loginCallback.createDelegate(this);var d="_loginCallback";var b=window.location.href.indexOf("/",window.location.protocol.length+2);var c=window.location.href.slice(0,b)+"/webman/modules/FileBrowser/index_ds.php";var a="http://update.synology.com/FileStation/facebook/login.php?callback="+d+"&fmHost="+c;window.open(a,"mywindow","menubar=1,resizable=0,width=630,height=250, top=100, left=300")},onGoogleLogin:function(){window._loginCallback=this.loginCallback.createDelegate(this);var d="_loginCallback";var b=window.location.href.indexOf("/",window.location.protocol.length+2);var c=window.location.href.slice(0,b)+"/webman/modules/FileBrowser/index_ds.php";var a="http://update.synology.com/FileStation/google/login.php?callback="+d+"&fmHost="+c;window.open(a,"mywindow","menubar=1,resizable=0,width=630,height=250, top=100, left=300")},loginCallback:function(a){window.socialResp=a;this.submitType="socialAuth";Ext.getDom("webfm-login_submit").click()},downloadFile:function(){if(!this.iframe){this.iframe=Ext.get("webfm-login_iframe")}var b=window.location.href;var a={};if(this.submitType==="passwd"){a.passwd=this.form.findField("pwd").getValue();if("true"===b_dsuser){a.username=this.form.findField("name").getValue()}}else{if(this.submitType==="socialAuth"){a.social_id=window.socialResp.uid}}a=SYNO.Encryption.EncryptParam(a);b=Ext.urlAppend(b,Ext.urlEncode(a));if(this.IsHandheldIOSWinDeviceBrowser&&!this.isFolderSharing){window.location.href=b}else{this.iframe.dom.src=b}},onCallback:function(){var a=this.messageContainer.getEl();if(Ext.isString((this.iframe.dom.contentWindow||window.frames["webfm-login_iframe"]).g_MD5)){this.iframe.setStyle({display:"block",position:"absolute",top:0,width:"100%",height:"100%",overflow:"hidden"});Ext.fly(Ext.getBody().select(".outer").elements[0]).setStyle({display:"none"});return}var d=g_LoginPriErr;try{var b=Ext.decode(this.iframe.dom.contentWindow.document.body.firstChild.innerHTML);switch(b.data.status){case"success":d=g_DownloadDesc;if(b.data.sharingType==="folder_sharing"){this.isFolderSharing=true}this.downloadFile();return;case"error_no_path":d=g_NoPathErr;break;case"password_error":d=g_PasswordError;break;default:d=g_LoginPriErr;break}}catch(c){if((/iPhone|iPad|iPod|windows phone/i.test(window.navigator.userAgent))){this.iframe.setStyle({display:"block",position:"absolute",top:0,width:"100%",height:"100%",overflow:"hidden"});Ext.fly(Ext.getBody().select(".outer").elements[0]).setStyle({display:"none"})}}a.dom.innerHTML="<font color='#FF0000'>"+d+"</font><br>";this.setFormDisabled(false)}});