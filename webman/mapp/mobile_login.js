/* Copyright (c) 2015 Synology Inc. All rights reserved. */

Ext.namespace("SYNO.API");SYNO.API.Manager=Ext.extend(Ext.util.Observable,{baseURL:"/webapi",constructor:function(){SYNO.API.Manager.superclass.constructor.apply(this,arguments);this.knownAPI={"SYNO.API.Info":{path:"query.cgi",minVersion:1,maxVersion:1}}},queryAPI:function(c,a,d){var b=[];if(!Ext.isArray(c)){c=[c]}Ext.each(c,function(e){if(!this.knownAPI.hasOwnProperty(e)){b.push(e)}},this);this.requestAPI("SYNO.API.Info","query",1,{query:b.join(",")},Ext.createDelegate(this.onQueryAPI,this,[a,d],true))},onQueryAPI:function(b,e,d,a,c){if(b){Ext.apply(this.knownAPI,e)}if(a){a.call(c,b,e)}},requestAPI:function(d,g,b,f,a,c){var e;e=this.knownAPI[d];if(!e){SYNO.Log.error("No Such API: "+d);return}if(b<e.minVersion||e.maxVersion<b){SYNO.Log.warn(String.format("WARN: API({0}) version ({1}) is higher then server ({2})",d,b,e.version))}return Ext.Ajax.request({url:this.baseURL+"/"+e.path,params:Ext.apply({},{api:d,method:g,version:b},f),scope:this,callback:this.onRequestAPI,userInfo:{cb:a,scope:c}})},onRequestAPI:function(b,a,d){var e=false,c=null;if(a){d=Ext.decode(d.responseText);if(d.success){e=true;c=d.data}else{e=false;c=d.error}}else{e=false;c=d}if(b.userInfo.cb){b.userInfo.cb.call(b.userInfo.scope,e,c,b.params)}}});SYNO.API.Proxy=Ext.extend(Ext.data.ServerProxy,{filterParam:"filter",startParam:"offset",limitParam:"limit",doRequest:function(a,d,b){var c=Ext.apply({},this.extraParams);this.getParams(c,a);SYNO.API.currentManager.requestAPI(this.api,this.method,this.version,c,Ext.createDelegate(this.onRequestAPI,this,[a,d,b],true))},onRequestAPI:function(a,e,d,b,f,c){if(!a){b.setException(e)}else{Ext.apply(b,{resultSet:this.getReader().read(e)});b.setCompleted();b.setSuccessful()}if(f){f.call(c||me,b)}}});Ext.data.ProxyMgr.registerType("synoapi",SYNO.API.Proxy);function _S(a){try{return SYNO.MobileDSM.Session[a]}catch(b){return""}}function _T(c,a){try{return SYNO_Strings[c][a]}catch(b){return c+":"+a}}Ext.data.Connection.prototype.timeout=120000;if(Ext.is.iOS){Ext.form.Text.prototype.useClearIcon=true;Ext.form.Password.prototype.useClearIcon=true}Ext.form.Text.prototype.autoCapitalize=false;Ext.form.Password.prototype.autoCapitalize=false;Ext.regApplication("SYNO.MobileDSM",{useHistory:false,launch:function(){var d,c,b,f=Ext.Element.getViewportWidth(),a=Ext.Element.getViewportHeight();try{b=Ext.decode(window.localStorage.login)}catch(g){}if(640>f||512>a){this.isPhone=true}if(this.isPhone){Ext.getBody().addCls("x-viewport-phone")}else{Ext.getBody().addCls("x-viewport-tablet")}Ext.get("hostname").setWidth(this.isPhone?300:370);Ext.get("hostname").update(_S("hostname"));c=Ext.create({renderTo:"content",width:this.isPhone?300:370,xtype:"form",id:"form",submitOnAction:false,listeners:{scope:this,action:this.onLogin},items:[{id:"dialog",xtype:"fieldset",defaults:{autoCapitalize:false,autoComplete:false,autoCorrect:false},items:[{xtype:"textfield",name:"username",placeHolder:_T("login","account")},{xtype:"passwordfield",name:"passwd",placeHolder:_T("login","password")},{id:"otp_field",xtype:"passwordfield",name:"OTPcode",placeHolder:_T("login","otp_code"),disabled:true,hidden:true},{xtype:"togglefield",name:"rememberme",label:_T("login","stay_login"),value:b&&b.rememberme},{xtype:"hiddenfield",name:"client_time",value:Math.floor((new Date()).getTime()/1000)}]}]});d=Ext.create({renderTo:c.el,xtype:"button",id:"login-btn",baseCls:"login-btn",pressedCls:"pressed",text:this.isPhone?_T("login","login"):undefined,scope:this,handler:this.onLogin});this.onViewportResize();Ext.Viewport.on("resize",this.onViewportResize,this)},setControllerEnabled:function(a){var b=a?"enable":"disable";Ext.getCmp("form").items.getAt(0).items.each(function(c){c[b]()})},onLogin:function(){this.formValues=Ext.getCmp("form").getValues();this.setControllerEnabled(false);Ext.defer(function(){Ext.getBody().mask(Ext.LoadingSpinner,"x-mask-loading");Ext.defer(this.doQueryAPI,200,this)},200,this)},doQueryAPI:function(){SYNO.API.currentManager=new SYNO.API.Manager();SYNO.API.currentManager.queryAPI("all",this.onQueryAPI,this)},onQueryAPI:function(a,c,b){SYNO.API.currentManager.requestAPI("SYNO.API.Encryption","getinfo",1,{format:"module"},this.onEncryptionDone,this)},onEncryptionDone:function(a,c,b){if(a){SYNO.Encryption.CipherKey=c.cipherkey;SYNO.Encryption.RSAModulus=c.public_key;SYNO.Encryption.CipherToken=c.ciphertoken;SYNO.Encryption.TimeBias=c.server_time-Math.floor(+new Date()/1000)}this.doLogin()},doLogin:function(){var a=this.formValues;Ext.Ajax.request({url:"login.cgi",params:SYNO.Encryption.EncryptParam(a),scope:this,callback:this.onLoginDone})},onLoginDone:function(g,a,i){var b;Ext.getBody().unmask();this.setControllerEnabled(true);try{i=Ext.decode(i.responseText);if(a&&i.success){try{window.localStorage.login=Ext.encode(Ext.getCmp("form").getValues())}catch(h){}var d=window.location.href;if(0<=d.indexOf("report=")){var f=d.substring(d.indexOf("report=")+"report=".length);window.location="/dar/"+f}else{window.location="/index.cgi?desktop=1"}return}}catch(h){}if(!a){b="connection_fail"}else{if(i.request_otp){var c=Ext.getCmp("otp_field");c.enable();c.show(false);b="login_otp_require"}else{b=i.reason?i.reason.replace("error_","login_"):"unknown"}}Ext.Msg.alert("",_T("error",b)||_T("error","unknown"))},onViewportResize:function(){var b,d=Ext.getCmp("login-btn"),c=Ext.getCmp("dialog"),a=Ext.Element.getViewportHeight();if(this.isPhone){Ext.get("footer").setVisible(a>370)}else{Ext.get("header").setStyle("min-height",(a-c.getHeight())/2+"px");b=d.el.getAlignToXY(c.el,"l-r",[20,0]);d.setPosition(b[0],b[1])}}});