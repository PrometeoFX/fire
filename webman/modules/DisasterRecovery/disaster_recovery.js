/* Copyright (c) 2015 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.DisasterRecovery.ListDataView",{extend:"SYNO.ux.ExpandableListView",singleExpanded:true,constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.progressTpl=a.progressTpl;c.innerTpl=a.innerTpl;c.blRestore=a.blRestore;b={trackResetOnLoad:false,tpl:c.createTpl()};c.callParent([Ext.apply(b,a)])},createTpl:function(){var b=this;var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap {cls}" id="{name}">','<div class="item-summary">','<div class="item-icon {iconCls}"></div>','<div class="{statusCls}"></div>',"<div>",'<span class="item-title">{name}</span>',"{snapStatus}",(b.blRestore)?'<div class="item-status" style="color:#505A64;">{restorePageLastSnapshot}</div>':'<div class="item-status" style="color:#505A64;">{capacity}</div>',"</div>",(b.progressTpl)?b.progressTpl.html:"",(b.innerTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail" style="display:none">',(b.innerTpl)?b.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>');return a},getSelectedItems:function(){return this.getSelectedItemIds()},getSelectedItem:function(){var a=this.getSelectedItems();if(0===a.length){return}return a[0]},expandDetail:function(b,c){if(!this.innerTpl||!b){return}var d,a;d=this.getRecord(b.dom);if(b.child(".item-toggle-expanded")){this.doExpand(true,b,false)}else{this.doExpand(true,b,c);a=this.toggledItemIds.indexOf(d.id);if(0>a){this.toggledItemIds.push(d.id)}}}});Ext.define("SYNO.SDS.DisasterRecovery.ShareList.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;b={autoDestroy:true,idProperty:"name",fields:["name","encryption","snapshots","isProtected","capacity","snapshotProp","restoreProp","iconCls","type","isSnapScheduled","snapStatus","lastSnapshot","support_action","enable_snapshot_browsing","is_usb_share","plans","vol_path","support_snapshot","restorePageLastSnapshot"]};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.DisasterRecovery.LunList.Store",{extend:"Ext.data.JsonStore",constructor:function(a){var c=this,b;c.sortField="name";c.sortDir="ASC";b={autoDestroy:true,idProperty:"name",fields:["name","id","lid","snapshots","vaai_support","is_actioning","status","snapStatus","isProtected","capacity","snapshotProp","restoreProp","iconCls","type","isSnapScheduled","progress","barWidth","displayProg","lastSnapshot","plans","restorePageLastSnapshot"],listeners:{load:function(){c.sort(c.sortField,c.sortDir)},scope:c}};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.DisasterRecovery.ListPanel",{extend:"SYNO.ux.Panel",targetChange:function(b){var c=this,d=c.list,a=d.store;c.appWin.storeLoadData(c.type);if(a&&0<a.getCount()&&0===d.getSelectedItemIds().length){d.select(0,true,true)}},onActivate:function(){this.targetChange();this.onSelectionChange()},getButton:function(a){return this.getTopToolbar().get(a)}});Ext.define("SYNO.SDS.DisasterRecovery.iSCSILun.TextFilter",{extend:"SYNO.ux.TextFilter",reset:function(){if(this.localFilterField===false&&this.store){this.store.clearFilter(false);this.trigger.hide()}}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.SearchField",{extend:"SYNO.ux.SearchField",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.protectedDisplayText=a.protectedDisplayText;c.allDisaplsyText=a.allDisaplsyText;c.notProtectedDisplayText=a.notProtectedDisplayText;var b=this.fillConfig(a);SYNO.SDS.DisasterRecovery.Snapshot.SearchField.superclass.constructor.call(this,b)},fillConfig:function(a){var c=this;var b={iconStyle:"search",itemId:"searchShareName",listeners:{keyup:c.owner.onActivate,scope:c.owner}};Ext.apply(b,a);return b},getSearchText:function(){return this.getValue().trim()},getMenu:function(){if(this.menu){return this.menu}return(this.menu=new SYNO.ux.Menu({defaults:{group:"filter",scope:this},items:[{text:this.allDisaplsyText,checked:true,itemId:"all",checkHandler:this.setSearchFilter},{text:this.protectedDisplayText,checked:false,itemId:"protected",checkHandler:this.setSearchFilter},{text:this.notProtectedDisplayText,checked:false,itemId:"notProtected",checkHandler:this.setSearchFilter}],listeners:{scope:this,beforeshow:function(a){a.items.get(this.getSearchFilter()).setChecked(true)}}}))},setSearchFilter:function(b){var a=b.itemId;if(a===this.gSearchFilter){return}this.gSearchFilter=a;this.owner.onActivate()},getSearchFilter:function(){return this.gSearchFilter||"all"}});Ext.define("SYNO.SDS.DisasterRecovery.AdvancedSearchField",{extend:"SYNO.ux.SearchField",initEvents:function(){this.callParent(arguments);this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this);this.mon(this,"keypress",function(b,a){if(a.getKey()===Ext.EventObject.ENTER){this.searchPanel.setKeyWord(this.getValue());this.searchPanel.onSearch()}},this)},isInnerComponent:function(c,b){var a=false;b.items.each(function(d){if(d instanceof Ext.form.ComboBox){if(d.view&&c.within(d.view.getEl())){a=true;return false}}else{if(d instanceof Ext.form.DateField){if(d.menu&&c.within(d.menu.getEl())){a=true;return false}}else{if(d instanceof Ext.form.CompositeField){if(this.isInnerComponent(c,d)){a=true;return false}}}}},this);return a},onMouseDown:function(b){var a=this.searchPanel;if(a&&a.isVisible()&&!a.isDestroyed&&!a.inEl&&!b.within(a.getEl())&&!b.within(this.searchtrigger)&&!this.isInnerComponent(b,this.searchPanel.getForm())){a.hide()}},onSearchTriggerClick:function(){if(this.searchPanel.isVisible()){this.searchPanel.hide();return}this.searchPanel.getEl().alignTo(this.wrap,"tr-br?",[6,0]);this.searchPanel.show();this.searchPanel.setKeyWord(this.getValue())},onTriggerClick:function(){this.callParent();this.searchPanel.onReset();this.searchPanel.onSearch()}});Ext.define("SYNO.SDS.DisasterRecovery.SearchFormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.dateType={custom:1,today:2,yesterday:4,lastweek:8,lastmonth:16};this.dataRange=[[this.dateType.custom,_T("log","date_custom")],[this.dateType.today,_T("log","date_today")],[this.dateType.yesterday,_T("log","date_yesterday")],[this.dateType.lastweek,_T("log","date_lastweek")],[this.dateType.lastmonth,_T("log","date_lastmonth")]];this.logLevelType={info:"1",warn:"2",error:"3"};this.logLevel=[[this.logLevelType.info,_T("log","info_level")],[this.logLevelType.warn,_T("log","warn_level")],[this.logLevelType.error,_T("log","error_level")]];this.defaultAnimation=["#000",1,{duration:0.35}];Ext.apply(this,a||{});var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",function(){this.defineBehaviors()},this)},initComponent:function(){this.callParent(arguments);this.addEvents("search")},fillConfig:function(b){var a,f,g,e;var c=[];a=this.createKeyword();f=this.createFriendlyDate();g=this.createCustDate();e=this.createLevel();c.push(a);c.push(f);c.push(g);c.push(e);c.push({xtype:"toolbar",border:false,itemId:"btns",id:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"lctbtext",itemId:"search-loading",text:""},{xtype:"lctbtext",itemId:"msg",height:26,style:"-webkit-text-size-adjust:none;font-size:11px;height:26px;overflow:hidden;",cls:"red-status",text:""},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("log","search"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("smart","smart_test_button_stop"),itemId:"btn_stop",hidden:true,handler:this.onStop,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]});var d={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:c,listeners:{actionfailed:{fn:function(){this.setMsg("");this.form.reset()},scope:this},beforeshow:{fn:function(){this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}else{if(!this.btnStop.hidden&&!this.btnStop.disabled){this.onStop()}}},scope:this}]};return d},setComboBoxValue:function(b,a){this.frameAnimation(b.el,this.defaultAnimation);if(b.setMultiValue){b.setMultiValue(a.split(","))}},getComboBoxValue:function(b){var a=this.getForm().findField(b);return a.getMultiValue?a.getMultiValue().toString():a.getValue()},multiSelect:function(c,e,a,d,b){Ext.applyIf(c,{setMultiValue:function(f){if(!Ext.isArray(f)){f=[f]}this.multiValue=f},getMultiValue:function(){return this.multiValue&&this.multiValue.length>0?this.multiValue:this.getValue().split(",")}});if("more"===e.get("value")){this.attriWin=new SYNO.SDS.LogCenter.MultiSelectedDialog({title:d,combo:c,emptyValue:b,anim:this.defaultAnimation,owner:this.owner.appInst});this.attriWin.showUp();c.collapse();return false}},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" ext:qtip="{displayText:htmlEncode}">',"{displayText:htmlEncode}","</div>","</tpl>")},logSelect:function(c,a,b){this.setComboBoxValue(c,c.getValue())},createKeyword:function(){return[{xtype:"syno_displayfield",value:_T("log","attr_keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""}]},setDate:function(c,b,a){if(a===true){this.frameAnimation(this.form.findField("searchdatefrom").el,this.defaultAnimation);this.frameAnimation(this.form.findField("searchdateto").el,this.defaultAnimation)}this.form.findField("searchdatefrom").setMaxValue(b);this.form.findField("searchdateto").setMinValue(c);this.form.findField("searchdatefrom").setValue(c);this.form.findField("searchdateto").setValue(b)},getFromToDate:function(c){var e,d,b=new Date();if(c===this.dateType.today){e=b;d=b}else{if(c===this.dateType.yesterday){e=b.add(Date.DAY,-1);d=e}else{if(c===this.dateType.lastweek){var a=b.getDay();e=b.add(Date.DAY,-7-a);d=e.add(Date.DAY,6)}else{if(c===this.dateType.lastmonth){b=b.add(Date.MONTH,-1);e=b.getFirstDateOfMonth();d=b.getLastDateOfMonth()}}}}return{from:e,to:d}},friendlyDateSelect:function(c,e,a){var b=e.get("id"),d=this.getFromToDate(b);this.setDate(d.from,d.to,true)},getFriendlyDateStore:function(){var a=this.dataRange;return new Ext.data.ArrayStore({autoDestroy:true,fields:["id","displayText"],data:a})},createFriendlyDate:function(){this.FriendlyDate=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"dateRange",tpl:this.createTpl(),resizable:true,store:this.getFriendlyDateStore(),displayField:"displayText",valueField:"id",triggerAction:"all",lazyRender:true,flex:6,value:this.dateType.custom,listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.friendlyDateSelect}});return[{xtype:"syno_displayfield",value:_T("log","date_range")+_T("common","colon"),flex:1},this.FriendlyDate]},createCustDate:function(){this.DateFrom=new SYNO.ux.DateField({name:"searchdatefrom",editable:false,format:"m/d/Y",emptyText:_T("log","date_from"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdateto").setMinValue(a)}}});this.DateTo=new SYNO.ux.DateField({name:"searchdateto",editable:false,format:"m/d/Y",emptyText:_T("log","date_to"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdatefrom").setMaxValue(a)}}});return[{xtype:"syno_displayfield",value:_T("time","time_date")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.DateFrom,this.DateTo]}]},getLogLevelStore:function(){var a=this.logLevel.slice(0,this.logLevel.length);if(a.length>1){a.splice(0,0,["",_T("log","log_all")])}return new Ext.data.ArrayStore({autoDestroy:true,fields:["value","displayText"],data:a})},multiLogLevelSelect:function(b,c,a){this.multiSelect(b,c,a,_T("log","logattr"),"")},createLevel:function(){this.LogLevel=new SYNO.ux.ComboBox({xtype:"syno_combobox",mode:"local",editable:false,name:"logLevel",tpl:this.createTpl(),resizable:true,store:this.getLogLevelStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,flex:3,value:"",listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.multiLogLevelSelect,select:this.logSelect}});return[{xtype:"syno_displayfield",name:"logLevelLabel",value:_T("log","logattr")+_T("common","colon"),flex:1},this.LogLevel]},hideItems:function(b){var c;if(!Ext.isArray(b)){b=[b]}for(var a=b.length-1;a>=0;a--){c=this.form.findField(b[a]);if(c){c.setVisible(false)}}},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setMsg:function(c){var a=this.get("btns");var b=a.get("msg");b.setText(c);if(c.trim()!==""){this.frameAnimation(b.el,this.defaultAnimation)}},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)){b.setValue(a)}b.focus("",1)},onShowHideBtn:function(a){if(a){this.btnSearch.hide();this.btnStop.show()}else{this.btnSearch.show();this.btnStop.hide()}},onEnableDisableBtn:function(a){if(a){this.btnSearch.enable();this.btnStop.enable()}else{this.btnSearch.disable();this.btnStop.disable()}},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().alert(b,a)}},hideMsg:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},isFieldDirty:function(a){return this.form.findField(a).isDirty()},validateForm:function(){if(!this.form.isValid()){return false}return this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")||this.isFieldDirty("keyword")},onSearch:function(c,f){var d,b,i,h,a;var g;d=this.getForm();b=d.findField("keyword").getValue();i=d.findField("searchdatefrom").getRawValue();h=d.findField("searchdateto").getRawValue();a=this.getComboBoxValue("logLevel");g={keyword:b,loglevel:a,datefrom:i?new Date(i+" 00:00:00").getTime()/1000:0,dateto:h?new Date(h+" 23:59:59").getTime()/1000:0};this.fireEvent("search",this,g)},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.setMsg("");this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null);this.form.findField("logLevel").multiValue=""}});Ext.define("SYNO.SDS.DisasterRecovery.Comp.TextItem",{extend:"Ext.Toolbar.TextItem",onRender:function(b,a){this.autoEl={cls:"xtb-text",html:this.text||"","ext:qtip":this.text||""};SYNO.SDS.DisasterRecovery.Comp.TextItem.superclass.onRender.call(this,b,a)},setText:function(a){SYNO.SDS.DisasterRecovery.Comp.TextItem.superclass.setText.call(this,a);if(this.rendered){this.el.set({"ext:qtip":a})}}});Ext.reg("lctbtext",SYNO.SDS.DisasterRecovery.Comp.TextItem);SYNO.SDS.DisasterRecovery.SnapshotTpl=function(){var a=new Ext.XTemplate("<div>",'<tpl for="snapshotProp">',"<dl>",'<dt class="dr-grid-property-name">{name}</dt>','<dt class="dr-grid-property-value">{value}</dt>','<div style="clear:both"></div>',"</dl>","</tpl>",'<div class="x-clear"></div>',"</div>");return a};SYNO.SDS.DisasterRecovery.RestoreTpl=function(){var a=new Ext.XTemplate("<div>",'<tpl for="restoreProp">',"<dl>",'<dt class="dr-grid-property-name">{name}</dt>','<dt class="dr-grid-property-value">{value}</dt>','<div style="clear:both"></div>',"</dl>","</tpl>",'<div class="x-clear"></div>',"</div>");return a};SYNO.SDS.DisasterRecovery.ProgressTpl=function(){var a=new Ext.XTemplate('<div class="dr-progress dr-progress-{displayProg}">',"<div>{progress}</div>",'<div class="dr-progress-bg">','<div class="dr-progress-bar" style="width:{barWidth}px"></div>',"</div>","</div>");return a};SYNO.SDS.DisasterRecovery.SharedFolderAdditionalInfo=function(){var a=["support_snapshot","encryption","share_quota","snapshot_info","enable_snapshot_browsing"];return a};SYNO.SDS.DisasterRecovery.lunCanSnapshot=function(b){var a;if(!b){return false}if(!!(b.get("is_actioning"))){return false}a=b.get("status");if("crashed"===a){return false}if(true!==b.get("vaai_support")){return false}if("be_cloning"!==a&&"using"!==a&&"snapshotting"!==a&&!!(b.get("is_actioning"))){return false}return true};SYNO.SDS.DisasterRecovery.isUpToiSCSILunMaxCount=function(a){var b=parseInt(_D("max_iscsiluns",10),10);if(!a){return false}return(a.length>=b)};SYNO.SDS.DisasterRecovery.MAX_SNAPSHOT_ACTIONING_COUNT=8;SYNO.SDS.DisasterRecovery.isUpToiSCSISnapShotActionCount=function(c){var a=SYNO.SDS.DisasterRecovery.MAX_SNAPSHOT_ACTIONING_COUNT,b,d=0;Ext.each(c,function(e){b=e.status;if(!e.vaai_support){return true}if("cloning"===b||"restoring"===b){d=d+1}else{Ext.each(e.snapshots,function(f){if("creating"===f.status.type){d=d+1}})}});return d>=a};SYNO.SDS.DisasterRecovery.SnapShotStatusRender=function(a){var b=SYNO.SDS.Utils.StorageUtils.UiRenderHelper;return b.SnapShotStatusRender(a)};SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg=function(a,b){var c;switch(a){case 3329:c=SYNO.API.Erros.core[a];c=c.replace("{0}",(Ext.isObject(b))?b._D.call(b,"max_snapshots_per_share","256"):_D("max_snapshots_per_share","256"));break;case 402:case 3118:case 3328:case 3330:case 3331:c=SYNO.API.Erros.core[a];break;default:break}return c};SYNO.SDS.DisasterRecovery.GetErrMsg=function(a){var b;switch(a){case 1001:b=_T("s2s","err_invalid_param_value");break;case 1002:b=_T("snapmgr","err_get_ret_policy");break;case 1003:b=_T("snapmgr","err_set_ret_policy");break;default:b=_T("common","error_system");break}return b};(function(){SYNO.SDS.DisasterRecovery.RTT_CFG_MAX={};SYNO.SDS.DisasterRecovery.RTT_CFG_MAX.Share=_D("max_snapshots_per_share","256");SYNO.SDS.DisasterRecovery.RTT_CFG_MAX.Lun=_D("max_snapshot_per_lun","256")})();SYNO.SDS.DisasterRecovery.RTT_ALL=0;SYNO.SDS.DisasterRecovery.RTT_POL_TIME=(1<<0);SYNO.SDS.DisasterRecovery.RTT_DEL_OLD=(1<<4);(function(){var c=function(t){var u=t.clone();u.setHours(0);u.setMinutes(0);u.setSeconds(0);u.setMilliseconds(0);return u},i=function(t){var u=t.clone();u.setHours(0);u.setMinutes(0);u.setSeconds(0);u.setMilliseconds(0);u.setDate(1);return u},f=function(x,v,t){var u=new Ext.Template(v,{compiled:true,disableFormats:true}),w=u.append(x,t||{},true);return w},s=function(u){var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return t[u.getMonth()]},o=function(x,v,t){var u=new Ext.Template(v,{compiled:true,disableFormats:true}),w=u.overwrite(x,t||{},true);return w},j="dr-timeline-wrapper",k="dr-timeline-scroller",e="dr-timeline-calendar",d="dr-timeline-pin",b="Y/m/d/H",a="Y-m",m=1000*60*60*24,r=40,g=6,n=24*g,p=r*1,l=r*g,h=r*n,q=10980;Ext.define("SYNO.SDS.DisasterRecovery.SnapMenu",{extend:"Ext.menu.Menu",cls:"dr-timeline-snap-menu",initComponent:function(){Ext.apply(this,{showSeparator:false,hideBorders:false,shadow:false});this.callParent(arguments);this.selectedType="share";this.addEvents("select")},renderSnapInfo:function(){var z=this;if(!z.rendered){z.mon(z,"afterrender",z.renderSnapInfo,z);return}var y=z.getSnapInfo(),u=("share"===z.selectedType),w=['<div class="dr-timeline-snap-ct">','<div class="snap-menu-header">',"{time}","</div>",z.getTypeSelector(y,u),"</div>"],v,x,A,t=[];if(u){A=y.share}else{A=y.lun}t.push("<content><table>");for(v=0;v<A.length;v+=1){t.push('<tr><td snap_trg="'+A[v]+'" class="'+((A[v]===z.selectedTrg)?'type-selected"':'"')+">"+A[v]+"</td></tr>")}t.push("</table></content>");x=o(z.getEl(),w.join(""),{time:z.renderTagDateFormat(y.dateId)});z._box=new Ext.BoxComponent({renderTo:x,html:t});new Ext.BoxComponent({renderTo:x,cls:"snap-menu-footer"});new Ext.BoxComponent({renderTo:x,cls:"snap-menu-arrow"});new Ext.BoxComponent({renderTo:x,cls:"snap-menu-tag-line"});if(A.length>4){z._box.setHeight(8+28*4+2*3);z._box.updateScroller(0)}x.on("click",z.onClickType,z);return x},getTypeSelector:function(v,t){var u="";if(0<v.share.length&&0<v.lun.length){u+="<type><table><tr>";u+='<td snap_type="share" class="left '+(t?'type-selected"':'"')+'><div snap_type="share" class="snap-menu-type-icon left"></div></td>';u+='<td snap_type="lun" class="right '+(!t?'type-selected"':'"')+'><div snap_type="lun" class="snap-menu-type-icon right"></div></td>';u+="</tr></table></type>"}return u},renderTagDateFormat:function(x){var w=x.split("/");var y=w[3].split("-");var t=parseInt(y[1],10);var v=new Date(w[0]+"/"+w[1]+"/"+w[2]+" "+y[0]+":00");var u=new Date(v.getTime()+(t-1)*10*60*1000);var z=new Date(v.getTime()+t*10*60*1000);return v.format("Y-m-d")+'<span style="font-weight: bold;"> '+u.format("H:i")+" - "+z.format("H:i")+"</span>"},setSnapInfo:function(u){var t=this;t.snapinfo=u;if(0===u.share.length&&0!==u.lun.length){t.selectedType="lun"}else{if(0===u.lun.length&&0!==u.share.length){t.selectedType="share"}else{if(t.changed){t.selectedType=("share"===t.selectedType)?"lun":"share"}}}t.changed=false;delete t.selectedTrg;return t.renderSnapInfo(u)},getSnapInfo:function(){return this.snapinfo},onClickType:function(x,y,u){var w=this;if((y.tagName==="TD"||y.tagName==="DIV")&&!!y.getAttribute("snap_type")){var v=y.getAttribute("snap_type");w.changed=(w.selectedType!==v);w.selectedSnapInfo=w.getSnapInfo();w.fireEvent("select",w.selectedSnapInfo);w.owner.renderDate(w.owner.selectedDate,true)}else{if(y.tagName==="TD"&&!!y.getAttribute("snap_trg")){var t=y.getAttribute("snap_trg");w.selectedTrg=t;w.renderSnapInfo(w.getSnapInfo());w.hide.defer(300,w,[true]);w.owner.appWin.onLaunchPage.defer(300,w.owner.appWin,[{fn:"SYNO.SDS.DisasterRecovery.Recovery.Main",tab:("share"===w.selectedType)?0:1,trg:t}])}}}});Ext.define("SYNO.SDS.DisasterRecovery.TimeLine",{extend:"Ext.Panel",calendar:null,snapMenu:null,minDate:null,maxDate:null,selectedDate:null,_elMonth:null,_elTimeline:null,OFF_X_RESERVED_RIGHT:0,constructor:function(t){var u=new Date();if(t.selectedDate){this._selectedDate=t.selectedDate;delete t.selectedDate}if(t.markedDate){if(Ext.isArray(t.markedDate)){this._markedDate=t.markedDate}else{this._markedDate=[t.markedDate]}delete t.markedDate}if(t.unmarkedDate){if(Ext.isArray(t.unmarkedDate)){this._unmarkedDate=t.unmarkedDate}else{this._unmarkedDate=[t.unmarkedDate]}delete t.unmarkedDate}var v=Ext.apply({appWin:t.appWin,owner:t.owner,detailData:t.detailData,border:false,frame:false,cls:"syno-sds-timeline-cmp "+t.cls,minDate:t.minDate||u.add(Date.MONTH,-1),maxDate:t.maxDate||u.add(Date.MONTH,1)},t);v.minDate=c(v.minDate);v.maxDate=c(v.maxDate);this._elMonth={};this.renderedMon=[];this.markedDate=[];return this.callParent([v])},initComponent:function(){this.callParent(arguments);this.addEvents("select");this.mon(this,"afterrender",this.onAfterRender,this);this.mon(this,"resize",this.onCmpResize,this)},onAfterRender:function(){var t=new Date();this.OFF_X_RESERVED_RIGHT=this.getWidth()/2+15;this.renderTimeLine();this.setDateInterval(this.minDate,this.maxDate);this.renderMonth(t);this.initData()},onCmpResize:function(u,t){if(!t){return}this.OFF_X_RESERVED_RIGHT=t/2+15;if(this.scroll){this.resizeScroller()}if(this.pin_dom){this.pin_dom.setAttribute("style","left: "+(t/2+4)+"px")}this.updateMonthEl();if(this.selectedDate){this.scrollToDate(this.selectedDate,0)}this.preW=this.getWidth()},initData:function(){if(this._markedDate){var t;for(t=0;t<this._markedDate.length;t++){this.markDate(this._markedDate[t])}}if(this._selectedDate){this.selectDate(this._selectedDate)}},reRenderView:function(v,B,u,x,t,z){var A=this;if(!v||!B||!u||!x||!t){return}A.minDate=c(x);A.maxDate=c(t);if(z){A.setDateInterval(A.minDate,A.maxDate)}A.detailData=u;if(Ext.isArray(v)){A._markedDate=v}else{A._markedDate=[v]}if(Ext.isArray(B)){A._unmarkedDate=B}else{A._unmarkedDate=[B]}if(A._markedDate){var y;for(y=0;y<A._markedDate.length;y++){A.markDate(A._markedDate[y])}}if(A._unmarkedDate){var w;for(w=0;w<A._unmarkedDate.length;w++){A.unmarkDate(A._unmarkedDate[w])}}},getScrollerWidth:function(){return this._elTimeline.child(".dr-timeline-scroller").getWidth()},setScrollerWidth:function(t){return this._elTimeline.child(".dr-timeline-scroller").setWidth(t)},getDateByOffsetX:function(x,t){if(x===undefined){x=-this.scroll.x}var u=t?t:this.getWidth();var v=-Math.ceil((this.getScrollerWidth()-u-x)/h);return this.maxDate.add(Date.DAY,v)},getOffsetXByDate:function(t){var v=c(t);var u=this.getScrollerWidth()-this.OFF_X_RESERVED_RIGHT-((this.maxDate-v)/m)*h+t.getHours()*l+this.getHourIdx(t)*p;return u},getOffsetXByMonthDate:function(t){return this.getOffsetXByDate(t.getFirstDateOfMonth())},getMonthEl:function(t){var u=t.getFirstDateOfMonth();return this._elMonth[u.format(b)]},setMonthEl:function(t,u){var v=t.getFirstDateOfMonth();this._elMonth[v.format(b)]=u},getDomByDate:function(t){var u=this.getMonthEl(t);return u.dom.childNodes[(t.getDate()-1)*n+t.getHours()*g+this.getHourIdx(t)-1]},renderTimeLine:function(){var u=this,t=f(u.getEl(),['<div class="{wrapper_cls}">','<div class="{pin_cls}"></div>','<div class="{scroller_cls}"></div>','<div class="{calendar_cls}"></div>',"</div>"],{wrapper_cls:j,scroller_cls:k,calendar_cls:e,pin_cls:d});u.pin_dom=t.dom.children[0];u.pin_dom.setAttribute("style","left: "+(u.getWidth()/2+4)+"px");u.scroll=new SYNO.SDS.Utils.IScroll(t.dom,{scrollX:true,scrollY:false,scroller:t.dom.children[1],mouseWheel:true,deceleration:0.01,startX:this.getWidth()*1.2-q,tap:Ext.isIE8?false:true});window.removeEventListener("resize",u.scroll);t.on(Ext.isIE8?"click":"tap",function(x,w,v){var y=null;if(w.hasClassName("dr-timeline-calendar")){u.onCalendarClick(w)}else{if(w.hasClassName("selected-time")||w.hasClassName("dot")){y=w.parentNode.parentNode;u.onDateClick(y)}else{if(w.tagName==="B"){y=w.parentNode;if(y!==u._lastClickDom){u.onDateClick(y)}else{y=null}}}}u._lastClickDom=y});u.scroll.on("scrollEnd",function(){u.updateCurrentView()});u.scroll.on("scrollStart",function(){if(u.snapMenu){u.snapMenu.hide(true)}},u);u._elTimeline=t;return t},updateMonthEl:function(){var v,u,t;for(v in this._elMonth){if(this._elMonth.hasOwnProperty(v)){u=this._elMonth[v];t=this.getOffsetXByMonthDate(new Date(v));u.dom.style.left=t+"px"}}},renderMonth:function(w){if(this.getMonthEl(w)){return this.getMonthEl(w)}var F=this,A,u,t=w.getDaysInMonth(),C=['<ul class="timeline-month" data-mon="{monId}" style="left:{offsetX}px; width:{width}px">'];for(A=0;A<=t*n-1;A+=1){var D=Math.floor(A/n),x=Math.floor((A%n)/g),y=(A%n)%g,B=D+1,E,z;if((A%n)===0){z=w.getFullYear()+" "+(w.getMonth()+1)+"/"+(D+1)+" 00:00";C.push('<li data-day="'+(B*10000)+'"><a>'+z+"</a></li>")}else{if((A%g)===0&&0!==x){E=(10>x)?("0"+x):x;C.push('<li data-day="'+(B*10000+x*100)+'"><a>'+E+":00</a></li>")}else{if((A%g)===5){C.push('<li class="dr-timeline-hourend" data-day="'+(B*10000+x*100+y*10)+'"></li>')}else{C.push('<li data-day="'+(B*10000+x*100+y*10)+'"></li>')}}}}C.push("</ul>");var v=this.getMonthId(w);u=f(F._elTimeline.child("."+k),C,{offsetX:F.getOffsetXByMonthDate(w),month:w.format("Y")+"<br/>"+s(w),monId:v,width:t*h});u.date=w.getFirstDateOfMonth();F.setMonthEl(w,u);this.renderedMon.push(v);return u},scrollToDate:function(u,v){var t=-this.getOffsetXByDate(u)+this.getWidth()-this.OFF_X_RESERVED_RIGHT;var z=0;var w=Ext.isDefined(v)?v:700;this.scroll.scrollTo(t,z,w)},updateMonthOffset:function(){for(var t in this._elMonth){if(this._elMonth[t]){this._elMonth[t].setLeft(this.getOffsetXByDate(this._elMonth[t].date))}}},resizeScroller:function(){var u=(this.maxDate.getTime()-this.minDate.getTime())/86400000;var t=(u*h)+this.getWidth();this.setScrollerWidth(t);this.updateMonthOffset();this.updateMonthEl();this.scroll.refresh()},renderDate:function(t,u){if(typeof(t)!=="object"){t=new Date(t)}var v=this,z=v.getDomByDate(t),y="";var w=z.getElementsByTagName("A");z.removeClassName("date-marked");z.removeClassName("date-selected");if(u){z.addClassName("date-selected");var x=v.createSnapMenu(v.getSelectedDetail(t));if(v.appWin.isVisible()){x.show(v.pin_dom,"b-t?");x.getEl().alignTo(v.pin_dom,"b-t?")}}else{if(v.isMarked(t)){y=(w.length>0)?w[w.length-1].innerHTML:"";z.innerHTML=v.innerHtmlFormat(t,'<b><div class="dot"></div></b>',y);z.addClassName("date-marked");if(v.snapMenu){v.snapMenu.hide(true)}}else{y=(w.length>0)?w[w.length-1].innerHTML:"";z.innerHTML=v.innerHtmlFormat(null,"",y)}}return z},getSelectedDetail:function(t){return this.detailData[this.getDateId(t)]},innerHtmlFormat:function(w,z,y){var B=this,A='<div class="dr-timeline-icon-margintop"></div>',v="",x="",u,t;if(null===w){A="";v="";x=""}else{u=B.getDateId(w);if(0<B.detailData[u].share.length){v='<div class="dr-timeline-share-icon"></div>'}else{v='<div class="dr-timeline-non-icon"></div>'}if(0<B.detailData[u].lun.length){x='<div class="dr-timeline-lun-icon"></div>'}else{x='<div class="dr-timeline-non-icon"></div>'}}t=(""===y)?"":"<a>"+y+"</a>";return A+v+z+x+t},renderTagDateFormat:function(v){var w=new Date(v.format("Y-m-d H:00"));var t=this.getHourIdx(v);var u=new Date(w.getTime()+(t-1)*10*60*1000);var x=new Date(w.getTime()+t*10*60*1000);return v.format("Y-m-d")+" "+u.format("H:i")+" - "+x.format("H:i")},inValidRange:function(v){if(typeof(v)!="object"){v=new Date(v)}var x=v.valueOf();var t=this.minDate.valueOf();var u=this.maxDate.add(Date.DAY,1).valueOf()-1;var w=(x<t||x>u)?false:true;return w},isSelected:function(t){if(!this.selectedDate){return false}var v=this.getDateId(t);var u=this.getDateId(this.selectedDate);return(v===u)?true:false},isMarked:function(u){var t=this.getMarkedIdx(u);if(t===-1){return false}else{return true}},getMarkedIdx:function(t){var w=this.getDateId(t);var u,v=this.markedDate.length;for(u=0;u<v;u++){if(w==this.getDateId(this.markedDate[u])){return u}}return -1},isValidDate:function(t){if(typeof(t)!=="object"){t=new Date(t)}if(Object.prototype.toString.call(t)!=="[object Date]"){return false}return !isNaN(t.getTime())},selectDate:function(t){if(typeof(t)!=="object"){t=new Date(t)}if(!this.isValidDate(t)||!this.inValidRange(t)){return}if(this.selectedDate){this.renderDate(this.selectedDate,false)}if(!this.monthRendered(t)){this.renderMonth(t)}this.renderDate(t,true);this.scrollToDate(t);this.fireEvent("select",t);this.selectedDate=t},unselectDate:function(t){if(typeof(t)!=="object"){t=new Date(t)}this.selectedDate=null;this.renderDate(t,false)},markDate:function(t){if(typeof(t)!=="object"){t=new Date(t)}if(!this.isValidDate(t)||!this.inValidRange(t)){return}if(!this.isMarked(t)){this.markedDate.push(t)}if(this.monthRendered(t)){this.renderDate(t)}},unmarkDate:function(u){var t=this.getMarkedIdx(u);if(t!==-1){this.markedDate.splice(t,1);this.renderDate(u)}},getHourIdx:function(u){var t=Math.floor(u.getMinutes()/10);return t+1},getDateId:function(t){if(typeof(t)!=="object"){t=new Date(t)}return t.format(b)+"-"+this.getHourIdx(t)},getMonthId:function(t){if(typeof(t)!=="object"){t=new Date(t)}return t.format(a)},createSnapMenu:function(u){var t=this;if(!t.snapMenu){t.snapMenu=new SYNO.SDS.DisasterRecovery.SnapMenu({width:260,renderTo:t.appWin.id,owner:t})}t.snapMenu.setSnapInfo(u);return t.snapMenu},updateCurrentView:function(){var u=this.getDateByOffsetX(-this.scroll.x);var t=this.getPreloadWindow(u,1);if(t){this.preloadMonths(t.minDate,t.maxDate)}},preloadMonths:function(t,u){while(u>=t){this.renderMonth(u);u=u.add(Date.MONTH,-1)}},binarySearch:function(t,A){var z=0;var w=t.length;var y=0;var v,x,u;while(z<w){v=(z+w)>>1;x=t[v];u=A.getTime()>x.getTime()?1:A.getTime()<x.getTime()?-1:0;if(u>0){z=v+1}else{w=v;y=!u;if(y){z=v}}}return y?z:z-1},onCalendarClick:function(t){if(null===this.calendar){this.calendar=new Ext.menu.DateMenu({hideOnClick:true,focusOnSelect:false});this.calendar.addClass("syno-ux-datefield-menu");this.calendar.picker.setMinDate(this.minDate);this.calendar.picker.setMaxDate(this.maxDate);this.mon(this.calendar,"select",function(v,u){if(!this.monthRendered(u)){this.renderMonth(u)}var w=this.binarySearch(this.markedDate,u);if(w>=0&&w<this.markedDate.length&&this.markedDate[w].getFullYear()===u.getFullYear()&&this.markedDate[w].getMonth()===u.getMonth()&&this.markedDate[w].getDate()===u.getDate()){this.scrollToDate(this.markedDate[w])}else{if((w+1)>=0&&(w+1)<this.markedDate.length&&this.markedDate[w+1].getFullYear()===u.getFullYear()&&this.markedDate[w+1].getMonth()===u.getMonth()&&this.markedDate[w+1].getDate()===u.getDate()){this.scrollToDate(this.markedDate[w+1])}else{this.scrollToDate(u)}}},this);this.mon(this.calendar.picker,"update",function(A,w){var u=w.getFirstDateOfMonth();var z=u.getDay();var x=w.add("mo",-1);var C=x.getDaysInMonth()-z;var B=(new Date(x.getFullYear(),x.getMonth(),C));for(var y=0;y<A.cells.elements.length;y++){B.setDate(B.getDate()+1);if(!A.cells.elements[y].className.match("x-date-active")){continue}var v=this.binarySearch(this.markedDate,B);if(v>=0&&v<this.markedDate.length&&this.markedDate[v].getFullYear()===B.getFullYear()&&this.markedDate[v].getMonth()===B.getMonth()&&this.markedDate[v].getDate()===B.getDate()||(v+1)>=0&&(v+1)<this.markedDate.length&&this.markedDate[v+1].getFullYear()===B.getFullYear()&&this.markedDate[v+1].getMonth()===B.getMonth()&&this.markedDate[v+1].getDate()===B.getDate()){A.cells.elements[y].className+=" x-date-hasSnapshot"}}},this)}this.calendar.show(t,"bl-tl?")},getMarkedDateById:function(v){var u,t=this.markedDate.length;for(u=0;u<t;u++){if(v===this.getDateId(this.markedDate[u])){return this.markedDate[u]}}return null},onDateClick:function(w){var C=this;var D=w.getAttribute("data-day");var B=Math.floor(D/10000);var z=Math.floor((D%10000)/100);var x=(D%100);var A=w.parentNode.getAttribute("data-mon").split("-");var F=parseInt(A[0],10);var v=parseInt(A[1],10)-1;var E=new Date(F,v,B,z,x);var t=C.getDateId(E);var u=C.getMarkedDateById(t);if(!C.isSelected(u)||(C.snapMenu&&!C.snapMenu.isVisible())){C.selectDate(u)}},setDateInterval:function(t,u){this.minDate=c(t);this.maxDate=c(u);this.minMon=i(t);this.maxMon=i(u);if(this.calendar&&!this.calendar.isVisible()){this.calendar.picker.setMinDate(this.minDate);this.calendar.picker.setMaxDate(this.maxDate)}this.resizeScroller();return this},getPreloadWindow:function(w,v){var t={},x=i(w),z=false;t.maxDate=w;t.minDate=w;if(this.monthRendered(x)){if(!this.monthRendered(w.add(Date.HOUR,-6))){t.minDate=w.add(Date.HOUR,-6);z=true}if(!this.monthRendered(w.add(Date.HOUR,6))){t.maxDate=w.add(Date.HOUR,6);z=true}if(!z){return undefined}}var y,u;while(true===z){z=false;y=t.minDate;u=t.maxDate;if(!this.monthRendered(y)&&0<v){t.minDate=y;--v;z=true}if(!this.monthRendered(u)&&0<v){t.maxDate=u;--v;z=true}}return t},monthRendered:function(u){var v=u.format(a);var t=(this.renderedMon.indexOf(v)===-1)?false:true;return t}})})();Ext.define("SYNO.SDS.DisasterRecovery.Overview.Main",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.summaryPanel=new SYNO.SDS.DisasterRecovery.Overview.SummaryPanel({appWin:c.appWin,owner:c.owner});c.timelinePanel=new SYNO.SDS.DisasterRecovery.Overview.TimeLinePanel({appWin:c.appWin,owner:c.owner});b={appWin:c.appWin,owner:c.owner,layout:"border",items:[c.summaryPanel,c.timelinePanel]};c.callParent([b]);c.mon(c,"dataready",function(){c.items.items.each(function(d){d.fireEvent("dataready")},c)},c)}});Ext.define("SYNO.SDS.DisasterRecovery.Overview.SummaryPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("snapmgr","overview_sum"),border:false,layout:"card",region:"north",height:349,frame:false,hideMode:"offsets",header:true,activeItem:0,items:[new SYNO.SDS.DisasterRecovery.Overview.NoInfoPanel({appWin:c.appWin,owner:c}),new SYNO.SDS.DisasterRecovery.Overview.InfoPanel({appWin:c.appWin,owner:c})]};c.callParent([b]);c.mon(c,"dataready",function(){if(0===c.appWin.scheAutoData.length&&0===c.appWin.scheManData.length){c.layout.setActiveItem(0)}else{c.layout.setActiveItem(1);c.get("overview_top_info").fireEvent("dataready")}},c)}});Ext.define("SYNO.SDS.DisasterRecovery.Overview.NoInfoPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;b={layout:"fit",items:[{border:false,html:'<div class="dr-summary-nodata">&nbsp</div><div class="dr-summary-nodata-text">'+_T("snapmgr","overview_no_snapinfo")+"</div>"}]};c.callParent([Ext.apply(b,a)])}});Ext.define("SYNO.SDS.DisasterRecovery.Overview.InfoPanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;var e=400;var d='<div class="dr-data-size-property" id="dr-snap-type-{id}"><div style="background-color: {color}" class="dr-data-size-color"></div>{name}:&nbsp{size}</div>';c.appWin=a.appWin;c.owner=a.owner;b={layout:"hbox",itemId:"overview_top_info",items:[new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div id="dr-summary-pie" class="dr-summary-pie"></div>','<tpl for="datasize">',d,"</tpl>","</tpl>"),width:e,height:320,border:false,store:c.snapTypeStore=new Ext.data.JsonStore({autoDestroy:true,fields:["datasize"]})}),new SYNO.ux.GridPanel({width:418,height:312,layout:"fit",border:false,cls:"dr-summary-grid",bwrapCfg:{cls:"x-panel-bwrap",style:{"padding-bottom":"2px"}},itemId:"summary_grid",columns:[{header:_T("common","name"),dataIndex:"name",width:150,sortable:false,renderer:function(j,g,f,k,i,h){if("share"===f.get("type")){return'<div class="dr-gridview-share"><span style="padding-left:22px">'+j+"</span></div>"}else{return'<div class="dr-gridview-lun"><span style="padding-left:22px">'+j+"</span></div>"}}},{header:_T("common","size"),dataIndex:"capacity",width:110,sortable:false},{header:_T("snapmgr","snap_last_time"),dataIndex:"lastSnapshot",width:150,sortable:false}],enableHdMenu:false,enableColumnMove:false,disableSelection:true,trackMouseOver:false,bbar:new SYNO.ux.PagingToolbar({store:c.appWin.SummaryStore,displayButtons:false,displayInfo:true,doRefresh:function(){c.appWin.processSummaryData()}}),viewConfig:{forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(f){f.scrollTop=f.scroller.dom.scrollTop},refresh:function(f){f.scroller.dom.scrollTop=f.scrollTop}}},listeners:{viewready:function(){this.getView().updateScroller()}},store:c.appWin.SummaryStore})]};c.snapTypeData={datasize:[{id:"auto",name:_T("snapmgr","overview_auto_snap"),color:"#1CA600",size:"60 TB"},{id:"man",name:_T("snapmgr","overview_man_snap"),color:"#0086E5",size:"30 TB"},{id:"non",name:_T("snapmgr","overview_no_snap"),color:"#FA4B4B",size:"10 TB"}]};c.dummy={def:{color:"#00AA00",value:60},def1:{color:"#0088A8",value:30},def2:{color:"#FF0000",value:10}};c.callParent([Ext.apply(b,a)]);c.mon(c,"dataready",function(){c.updateUI()},c);c.mon(c,"afterlayout",function(){c.createChart();c.updateUI();c.updateLegendColor()},c,{single:true});c.mon(c,"resize",function(){if("0"!=c.getWidth()){c.get("summary_grid").setWidth(c.getWidth()-e)}else{c.get("summary_grid").setWidth(c.owner.layout.getLayoutTargetSize().width-e)}},c)},createChart:function(e){var c=this,d=0,b,f;var a=SYNO.SDS.Utils.StorageUtils.UiRenderHelper.GetSizeUnit;if(Ext.isDefined(e)){for(b in e){if(e.hasOwnProperty(b)){d+=e[b].value}}f=a(d)}if(Ext.get("dr-snap-type-auto")){Ext.get("dr-snap-type-auto").un("click",c.setSelectAutoFilter,c)}if(Ext.get("dr-snap-type-man")){Ext.get("dr-snap-type-man").un("click",c.setSelectManFilter,c)}if(Ext.get("dr-snap-type-non")){Ext.get("dr-snap-type-non").un("click",c.setSelectNonFilter,c)}c.snapTypeStore.loadData([c.snapTypeData],false);c.chart=new SYNO.SDS.Utils.canvas.IncrementalCircle({radius:94,lineWidth:34,data:Ext.isDefined(e)?e:c.dummy,labelTitle:Ext.isDefined(e)?f.size:"--",labelUnit:Ext.isDefined(e)?f.unit:" TB",fontColor:"#505A64",canvasConfig:{height:188,width:188},renderTo:"dr-summary-pie"})},updateUI:function(){var a=this,b={};if(!a.chart){return}Ext.get("dr-summary-pie").dom.innerHTML="";a.chart.destroy();a.prepareData(b);a.createChart(b);a.bindEvents();a.updateLegendColor()},prepareData:function(d){var a=this,c,b=a.snapTypeData.datasize;c=0;a.appWin.scheAutoData.each(function(e){if("lun"===e.type){c+=parseInt(e.size,10)}else{c+=e.share_quota_used*1024*1024}},a);d.set1={color:"#1EB400",value:c};b[0].size=a.appWin.SizeRender(c);c=0;a.appWin.scheManData.each(function(e){if("lun"===e.type){c+=parseInt(e.size,10)}else{c+=e.share_quota_used*1024*1024}},a);d.set2={color:"#0086E6",value:c};b[1].size=a.appWin.SizeRender(c);c=0;a.appWin.scheNonData.each(function(e){if("lun"===e.type){c+=parseInt(e.size,10)}else{if(e.support_snapshot){c+=e.share_quota_used*1024*1024}}},a);d.set3={color:"#F9575D",value:c};b[2].size=a.appWin.SizeRender(c)},setSelectAutoFilter:function(){var a=this;a.appWin.scheFilter="auto";a.appWin.processSummaryData();a.updateLegendColor()},setSelectManFilter:function(){var a=this;a.appWin.scheFilter="man";a.appWin.processSummaryData();a.updateLegendColor()},setSelectNonFilter:function(){var a=this;a.appWin.scheFilter="non";a.appWin.processSummaryData();a.updateLegendColor()},bindEvents:function(){var a=this;Ext.get("dr-snap-type-auto").on("click",a.setSelectAutoFilter,a);Ext.get("dr-snap-type-man").on("click",a.setSelectManFilter,a);Ext.get("dr-snap-type-non").on("click",a.setSelectNonFilter,a)},updateLegendColor:function(){var a=this;if("auto"===a.appWin.scheFilter){Ext.get("dr-snap-type-auto").addClass("dr-property-selected");Ext.get("dr-snap-type-man").removeClass("dr-property-selected");Ext.get("dr-snap-type-non").removeClass("dr-property-selected")}else{if("man"===a.appWin.scheFilter){Ext.get("dr-snap-type-auto").removeClass("dr-property-selected");Ext.get("dr-snap-type-man").addClass("dr-property-selected");Ext.get("dr-snap-type-non").removeClass("dr-property-selected")}else{Ext.get("dr-snap-type-auto").removeClass("dr-property-selected");Ext.get("dr-snap-type-man").removeClass("dr-property-selected");Ext.get("dr-snap-type-non").addClass("dr-property-selected")}}}});Ext.define("SYNO.SDS.DisasterRecovery.Overview.TimeLinePanel",{extend:"SYNO.ux.Panel",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:_T("snapmgr","overview_recent_snap"),layout:"fit",region:"center",header:true,style:"padding-top: 8px;padding-bottom: 12px;",items:[{border:false,html:'<div id="dr-timeline"></div>'}]};c.callParent([Ext.apply(b,a)]);c.mon(c,"dataready",function(){if(0===c.appWin.scheAutoData.length&&0===c.appWin.scheManData.length){if(!this.body.isMasked()){c.body.mask()}}else{c.body.unmask()}c.createTimeLine()},c);c.mon(c,"resize",function(e,d){if(e.timeline){e.timeline.fireEvent("resize",e,d)}},c)},setMarkedDate:function(){var c=this,b=[],a;c.appWin.sharedFolders.each(function(d){if(d.isProtected){d.snapshots.each(function(e){b.push(e.epoch_msec)},c)}},c);c.appWin.iSCSILuns.each(function(d){if(d.isProtected){d.snapshots.each(function(e){b.push(e.epoch_msec)},c)}},c);b.sort();if(c.unmarkedDate){delete c.unmarkedDate}c.unmarkedDate=[];if(c.markedDate){for(a=0;a<c.markedDate.length;a++){if(-1===b.indexOf(c.markedDate[a])){c.unmarkedDate.push(c.markedDate[a])}}}delete c.markedDate;c.markedDate=b},setSelectedDate:function(){var a=this;if(0===a.markedDate.length){a.selectedDate=undefined;return}a.selectedDate=new Date(a.markedDate[a.markedDate.length-1])},setDetailData:function(){var a=this;if(a.detailData){delete a.detailData}a.detailData={};a.appWin.sharedFolders.each(function(b){if(b.isProtected){b.snapshots.each(function(c){var d=a.getDateId(c.epoch_msec);if(!Ext.isDefined(a.detailData[d])){a.detailData[d]={share:[],lun:[],dateId:d}}if(-1===a.detailData[d].share.indexOf(c.ownername)){a.detailData[d].share.push(c.ownername)}},a)}},a);a.appWin.iSCSILuns.each(function(b){if(b.isProtected){b.snapshots.each(function(c){var d=a.getDateId(c.epoch_msec);if(!Ext.isDefined(a.detailData[d])){a.detailData[d]={share:[],lun:[],dateId:d}}if(-1===a.detailData[d].lun.indexOf(c.ownername)){a.detailData[d].lun.push(c.ownername)}},a)}},a)},setMinDate:function(a){var b=this;if(0===b.markedDate.length){b.minDate=new Date(a.getTime()-1*86400*1000);return}b.minDate=new Date(b.markedDate[0]-1*86400*1000)},setMaxDate:function(a){var b=this;if(0===b.markedDate.length){b.maxDate=new Date(a.getTime()+1*86400*1000);return}b.maxDate=new Date(b.markedDate[b.markedDate.length-1]+1*86400*1000)},prepareData:function(){var a=this,b=new Date();a.setMarkedDate();a.setDetailData();a.setSelectedDate();a.setMinDate(b);a.setMaxDate(b)},createTimeLine:function(){var b=this,a;b.prepareData();if(b.timeline){a=(-1!==b.appWin.getActivePage().itemId.indexOf("Overview"));b.timeline.reRenderView(b.markedDate,b.unmarkedDate,b.detailData,b.minDate,b.maxDate,a);return}b.timeline=new SYNO.SDS.DisasterRecovery.TimeLine({appWin:b.appWin,owner:b.owner,selectedDate:b.selectedDate,maxDate:b.maxDate,minDate:b.minDate,markedDate:b.markedDate,unmarkedDate:b.unmarkedDate,detailData:b.detailData,renderTo:"dr-timeline",listeners:{scope:b,select:{fn:function(c){if(!b.record){return}b.record.time=c.format("Y-m-d_H-i-s")}}}})},getDateId:function(a){if(typeof(a)!=="object"){a=new Date(a)}return a.format("Y/m/d/H")+"-"+this.getHourIdx(a)},getHourIdx:function(b){var a=Math.floor(b.getMinutes()/10);return a+1}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.Main",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var d=this,c,b=[];d.appWin=a.appWin;d.owner=a.owner;if("yes"===_D("support_share_snapshot","no")){b.push(new SYNO.SDS.DisasterRecovery.Snapshot.SharedFolder({appWin:d.appWin,owner:d.owner}))}if("yes"===_D("support_vaai","no")&&"lio"===_D("iscsi_target_type","")){b.push(new SYNO.SDS.DisasterRecovery.Snapshot.iSCSILUN({appWin:d.appWin,owner:d.owner}))}c={appWin:d.appWin,owner:d.owner,itemId:"snapshot",activeTab:0,items:b};this.callParent([c])},onPageActivate:function(){this.getActiveTab().fireEvent("activate")}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.SharedFolder",{extend:"SYNO.SDS.DisasterRecovery.ListPanel",constructor:function(a){var c=this,b,e=[];c.appWin=a.appWin;c.owner=a.owner;c.type="share";c.list=new SYNO.SDS.DisasterRecovery.ListDataView({appWin:c.appWin,owner:c,multiSelect:false,singleSelect:true,store:c.appWin.sharedFolderStore,innerTpl:SYNO.SDS.DisasterRecovery.SnapshotTpl(),listeners:{selectionchange:c.onSelectionChange,scope:c}});e.push({itemId:"take_snapshot",text:_T("iscsilun","take_snapshot"),handler:c.onTakeSnapshot,disabled:true,scope:c},{itemId:"manage",text:_T("snapmgr","snap_list"),handler:c.onManage,disabled:true,scope:c},{itemId:"configure",text:_T("snapmgr","set_schedule"),handler:c.onConfigure,disabled:true,scope:c});var d=new SYNO.SDS.DisasterRecovery.Snapshot.SearchField({appWin:c.appWin,owner:c,protectedDisplayText:_T("snapmgr","snap_share_protected"),allDisaplsyText:_T("snapmgr","snap_share_all"),notProtectedDisplayText:_T("snapmgr","snap_share_not_protected")});b={title:_T("tree","leaf_sharefolder"),border:false,layout:"fit",tbar:{defaultType:"syno_button",items:[e,"->",d]},items:[c.list],listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},onSelectionChange:function(){var c=this,a=c.list.getSelectedItemIds();c.getButton("take_snapshot").setDisabled(true);c.getButton("manage").setDisabled(true);c.getButton("configure").setDisabled(true);if(1===a.length){var b=c.list.getSelectedRecords();var e=b[0].get("support_action");var d=b[0].get("support_snapshot");if(e&1){c.getButton("take_snapshot").setDisabled(false)}if(d){c.getButton("manage").setDisabled(false);c.getButton("configure").setDisabled(false)}}},onTakeSnapshot:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.SharedFolderSnapshot({appWin:b.appWin,owner:b.appWin,share:a,title:_T("iscsilun","take_snapshot")+" - "+a[0].get("name"),mode:"create"});c.open()},onManage:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.SharedFolderManage({appWin:b.appWin,owner:b.appWin,title:_T("snapmgr","snap_list")+" - "+a[0].get("name"),share:a[0]});c.open()},onConfigure:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.Configure({appWin:b.appWin,owner:b.appWin,share:a[0],title:_T("snapmgr","set_schedule")+" - "+a[0].get("name"),func:"sharedFolders"});c.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.SharedFolderSnapshot",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.share=a.share;c.mode=a.mode;c.snapshot=a.snapshot;var b={width:450,height:250,resizable:false,buttons:[{itemId:"btSave",xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:c,handler:c.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}],items:[c.createForm()]};c.callParent([Ext.apply(b,a)])},getForm:function(){return this.getComponent("snapshot").getForm()},onOpen:function(){this.callParent(arguments);this.initValues();this.addTip()},addTip:function(){SYNO.SDS.Utils.AddTip(this.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){var a=this;if(a.isEditMode()){a.getForm().setValues({desc:a.snapshot.get("desc"),lock:a.snapshot.get("lock")})}},onSave:function(){var b=this,c;var a={};if(!b.getForm().isValid()){return}if(b.isEditMode()&&!b.getForm().isDirty()){b.close();return}a.desc=this.getForm().findField("desc").getValue();a.lock=this.getForm().findField("lock").getValue();b.setStatusBusy({text:_T("common","saving")});if(b.getFooterToolbar().get("btSave")){b.getFooterToolbar().get("btSave").disable()}var d={snapinfo:a};if(b.isEditMode()){c="set";d.name=b.share.get("name");d.snapshot=b.snapshot.get("time")}else{if(b.isCreateMode()){c="create";d.name=b.share[0].get("name")}}b.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:c,params:d,version:1,scope:this,callback:function(h,f,e){this.clearStatusBusy();if(!h){var g=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(f.code,this)||_T("common","error_system");this.owner.getMsgBox().alert(_T("snapmgr","app_title"),g)}this.isDataChanged=true;this.close()}})},onCancel:function(){var a=this;if(a.getForm().isDirty()){a.getMsgBox().confirm(_T("iscsilun","take_snapshot"),_T("common","confirm_lostchange"),function(b){if("yes"===b){a.close()}},a);return}a.close()},createForm:function(){var a={xtype:"form",itemId:"snapshot",border:false,trackResetOnLoad:true,defaults:{width:250,labelWidth:150},items:[{xtype:"syno_textfield",name:"desc",itemId:"desc",maxLength:511,fieldLabel:_T("share","share_comment")},{xtype:"syno_checkbox",name:"lock",itemId:"lock",boxLabel:_T("iscsilun","snapshot_lock"),checked:true}]};return a},isCreateMode:function(){return("create"===this.mode)},isEditMode:function(){return("edit"===this.mode)}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.MultiDeleteError",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.share=a.share;c.data=a.errorData;var b={layout:"fit",items:[],width:350,height:300,minHeight:200,buttons:[{text:_T("common","alt_close"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){var a=this;a.items.push(a.createPanel());a.callParent(arguments)},onCancel:function(){this.close()},initEvents:function(){this.callParent(arguments);var b=this;var c=[];for(var a=0;a<b.data.length;++a){c[a]=[];c[a][0]=a;c[a][1]=String(b.data[a])}b.store.loadData(c);b.setHeight(350)},createPanel:function(){var f=this;var a=Ext.data.Record.create([{idIndex:"idIndex"},{name:"time"}]);var b=new Ext.data.Store({appWindow:f.appWin,autoDestroy:true,reader:new Ext.data.ArrayReader({idIndex:0},a)});f.store=b;var d=new Ext.grid.ColumnModel({defaults:{width:120,sortable:false},columns:[{id:"idIndex",header:_T("time","time_time"),dataIndex:"idIndex",hidden:true},{id:"time",header:_T("time","time_time"),dataIndex:"time",renderer:function(j,g,i){var h=new Date(f.appWin.getSnapTime(i.data,"share"));return h.format("Y/m/d H:i:s")}}]});var e={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(g){g.scrollTop=g.scroller.dom.scrollTop},refresh:function(g){g.scroller.dom.scrollTop=g.scrollTop}}};var c={layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"0px 12px 0px 16px"},store:b,colModel:d,selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),enableHdMenu:false,viewConfig:e,enableColumnMove:false,cls:"without-dirty-red-grid"};return c}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.SharedFolderManage",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.share=a.share;var b={layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,buttons:[{text:_T("common","alt_close"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){var a=this;a.items.push(a.createPanel());a.callParent(arguments)},getGrid:function(){return this.get("snapshots")},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},getSelections:function(){return this.getGrid().getSelectionModel().getSelections()},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},initEvents:function(){this.callParent(arguments);this.setLoadingMask();this.getGrid().getStore().load({callback:function(){this.appOwner.clearLoadingMask()}})},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},onSelectionChange:function(d){var b=this;var a=d.getCount();var c=b.share.get("support_action");if(0!==a){if(c&2){b.getButton("btDelete").enable()}}else{b.getButton("btDelete").disable()}if(1===a){b.getButton("btEdit").enable();if(c&16){b.getButton("btBrowse").enable()}}else{b.getButton("btEdit").disable();b.getButton("btBrowse").disable()}return},onCancel:function(){this.close()},createPanel:function(){var e=this;var a=new SYNO.API.JsonStore({appWindow:e.appWin,appOwner:e,autoDestroy:true,api:"SYNO.Core.Share.Snapshot",method:"list",version:1,baseParams:{name:e.share.get("name"),offset:0,limit:-1,filter:{attr:["!hide==true"]},additional:["desc","lock"]},fields:["time","desc","lock"],root:"snapshots",id:"time",listeners:{exception:{scope:e.owner,fn:function(j,k,i,h,g){var l=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(g.code,this)||_T("common","error_system");e.getMsgBox().alert(_T("snapmgr","app_title"),l)}}}});e.store=a;var c=new Ext.grid.ColumnModel({defaults:{width:120,sortable:false},columns:[{id:"time",header:_T("common","name"),dataIndex:"time"},{id:"time",header:_T("time","time_time"),dataIndex:"time",renderer:function(j,g,i){var h=new Date(e.appWin.getSnapTime(i.data,"share"));return h.format("Y/m/d H:i:s")}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",width:100,renderer:Ext.util.Format.htmlEncode},{id:"lock",header:_T("iscsilun","snapshot_lock"),width:60,dataIndex:"lock",renderer:e.lockIconRenderer}]});var f=new Ext.Toolbar({defaultType:"syno_button",items:[{text:_T("download","upload_browse"),itemId:"btBrowse",handler:e.snapshotBrowse,disabled:true,scope:e},{text:_T("common","remove"),itemId:"btDelete",handler:e.snapshotDelete,disabled:true,scope:e},{text:_T("common","alt_edit"),itemId:"btEdit",handler:e.snapshotEdit,disabled:true,scope:e},"->",new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",store:this.store,queryAction:"list",enumAction:"list",queryParam:"substr"})]});var d={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(g){g.scrollTop=g.scroller.dom.scrollTop},refresh:function(g){g.scroller.dom.scrollTop=g.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"snapshots",style:{padding:"0px 12px 0px 16px"},tbar:f,store:a,colModel:c,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:e.onSelectionChange,scope:e}}),listeners:{scope:e,activate:e.onActivate,rowdblclick:{scope:e,fn:function(h,j,i){var g=e.store.getAt(j);if(g){e.snapshotEdit()}}}},enableHdMenu:false,autoExpandColumn:"desc",viewConfig:d,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},lockIconRenderer:function(b){var c="";var a="";switch(b){case true:c="share-lock";break;case false:break;default:break}if(c!==""){a=String.format('<div class="syno-admincenter-{0}"></div>',c)}return a},snapshotBrowse:function(){var b=this,a=b.getSelected();b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Core.Share",method:"get",version:1,params:{name:b.share.get("name"),additional:["enable_snapshot_browsing"]},callback:function(e,d,c){b.clearStatusBusy();if(e){if(d.enable_snapshot_browsing){SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+b.share.get("name")+"/#snapshot/"+a.get("time")+"/"});return}b.getMsgBox().confirm(_T("snapmgr","app_title"),_T("snapmgr","snap_browse_msg"),function(f){if("yes"===f){b.makeSnapshotBrowsable(a)}},b)}},scope:b})},makeSnapshotBrowsable:function(a){var b=this;b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Core.Share",method:"set",version:1,params:{name:b.share.get("name"),shareinfo:{name:b.share.get("name"),vol_path:b.share.get("vol_path"),desc:"",enable_snapshot_browsing:true}},callback:function(e,d,c){b.clearStatusBusy();if(e){SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+b.share.get("name")+"/#snapshot/"+a.get("time")+"/"})}},scope:b})},snapshotDelete:function(){var a=this;var c=a.getSelections();if(!c){return}var b=[];var d=_T("common","remove_cfrmrmv");c.each(function(e){b.push(e.get("time"))});a.getMsgBox().confirmDelete(_T("common","remove"),d,function(e){if("yes"===e){a.doSnapshotDelete(b)}},a)},doSnapshotDelete:function(b){var a=this;a.setStatusBusy({text:_T("common","msg_waiting")});a.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"delete",version:1,params:{name:a.share.get("name"),snapshots:b},callback:function(g,d,c){a.clearStatusBusy();if(!g){var f=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(d.code,this)||_T("common","error_system");a.getMsgBox().alert(_T("snapmgr","app_title"),f)}else{if(d&&0<d.length){var e=new SYNO.SDS.DisasterRecovery.Snapshot.MultiDeleteError({appWin:a.appWin,owner:a,title:_T("share","share_snapshot_delete_failed"),share:a.share,errorData:d});e.open()}}a.getGrid().getStore().load()},scope:a})},snapshotEdit:function(){var c=this;var a=c.getSelected();var b=new SYNO.SDS.DisasterRecovery.Snapshot.SharedFolderSnapshot({appWin:c.appWin,owner:c,title:_T("common","alt_edit")+" - "+c.share.get("name"),mode:"edit",share:c.share,snapshot:a});c.mon(b,"close",function(){if(b.isDataChanged){c.isDataChanged=true;c.getGrid().getStore().load()}},c,{single:true});b.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.Configure",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var d=this,b=[];d.owner=a.owner;d.appWin=a.appWin;b.push(new SYNO.SDS.DisasterRecovery.Snapshot.Configure.Schedule({appWin:d.appWin,owner:d}));b.push(new SYNO.SDS.DisasterRecovery.Snapshot.Configure.Retention({appWin:d.appWin,owner:d}));if("sharedFolders"===a.func){d.share=a.share;d.type="Share"}else{d.lun=a.lun;d.type="Lun";b.push(new SYNO.SDS.DisasterRecovery.Snapshot.Configure.LunApplication({appWin:d.appWin,owner:d}))}d.tabPanel=new SYNO.SDS.Utils.TabPanel({appWin:d.appWin,owner:d.owner,activeTab:0,items:b});var c={items:[d.tabPanel],width:600,height:460,minWidth:600,minHeight:460,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}]};d.callParent([Ext.apply(c,a)]);if("sharedFolders"===a.func){d.getSharedFolderScheData()}else{d.getiSCSILunScheData()}},getForm:function(a){return this.tabPanel.getItem(a).getForm()},onSave:function(){var b=this,a=b.getForm("retentionSnapshot"),c=_T("snapmgr","err_max_rtt_cfg");if(!a.isValid()){b.tabPanel.setActiveTab("retentionSnapshot");return}if(!b.isRTTCfgValid(b.type)){b.tabPanel.setActiveTab("retentionSnapshot");b.getMsgBox().alert(_T("snapmgr","app_title"),String.format(c,SYNO.SDS.DisasterRecovery.RTT_CFG_MAX[b.type]));return}if(a.isDirty()&&(SYNO.SDS.DisasterRecovery.RTT_ALL!==a.findField("policyType").getGroupValue())){b.getMsgBox().confirm(_T("snapmgr","set_schedule"),_T("snapmgr","run_retention_immed"),function(d){if("ok"===d){if("Share"===b.type){b.setSharedFolderConf()}else{b.setiSCSILunConf()}}},b,Ext.MessageBox.OKCANCEL)}else{if("Share"===b.type){b.setSharedFolderConf()}else{b.setiSCSILunConf()}}},isRTTCfgValid:function(b){var e=this,d=e.getForm("retentionSnapshot"),c=0;var a=function(f){return d.findField(f).getValue()};c=a("hourly")+a("daily")+a("weekly")+a("monthly")+a("yearly");if(c>SYNO.SDS.DisasterRecovery.RTT_CFG_MAX[b]){return false}return true},setSharedFolderConf:function(){var a=this,b=a.getScheData();a.setStatusBusy({text:_T("common","msg_waiting")});a.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"set_schedule",version:1,params:{name:a.share.get("name"),enable_snapshot_schedule:a.getForm("scheduleSnapshot").findField("enable_snapshot_schedule").getValue(),schedule:b,task_id:a.getForm("scheduleSnapshot").findField("task_id").getValue()},scope:a,callback:function(f,d,c){if(!f){var e=_T("snapmgr","err_set_sche");a.clearStatusBusy();a.getMsgBox().alert(_T("snapmgr","set_schedule"),e,function(){a.close()},a);a.setStatusError({text:e,clear:true});return false}else{a.setRetention()}}})},setiSCSILunConf:function(){var b=this,a=b.getGeneralData(),c=b.getScheData();b.setStatusBusy({text:_T("common","msg_waiting")});Ext.Ajax.request({url:b.appWin.getLunActionURL(),params:Ext.encode({action:"set_sched_snap_task",lid:b.lun.get("lid"),general:a,schedule:c}),callback:function(e,h,g){var d;if(h){d=Ext.util.JSON.decode(g.responseText)}if(!h||!d.success){var f=_T("snapmgr","err_set_sche");b.clearStatusBusy();b.getMsgBox().alert(_T("snapmgr","set_schedule"),f,function(){b.close()},b);b.setStatusError({text:f,clear:true});return false}else{b.setRetention()}},scope:b})},onCancel:function(){this.close()},getSharedFolderScheData:function(){var a=this;a.setStatusBusy({text:_T("common","msg_waiting")});a.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"get_schedule",version:1,params:{name:a.share.get("name")},scope:a,callback:function(e,c,b){if(!e){var d=_T("snapmgr","err_get_sche");a.clearStatusBusy();a.getMsgBox().alert(_T("snapmgr","set_schedule"),d,function(){a.close()},a);a.setStatusError({text:d,clear:true});return}else{a.tabPanel.items.each(function(f){if(Ext.isFunction(f.updateScheData)){f.updateScheData(c)}},a);a.getRetention()}}})},getiSCSILunScheData:function(){var a=this;a.setStatusBusy({text:_T("common","msg_waiting")});Ext.Ajax.request({url:a.appWin.getLunActionURL(),params:{action:"load_sched_snap_task",lid:a.lun.get("lid")},callback:function(c,g,f){var b,d={};if(g){b=Ext.util.JSON.decode(f.responseText)}if(!g||!b.success){var e=_T("snapmgr","err_get_sche");a.clearStatusBusy();a.getMsgBox().alert(_T("snapmgr","set_schedule"),e,function(){a.close()},a);a.setStatusError({text:e,clear:true});return}else{a.processLunResp(b.data[0],d);a.tabPanel.items.each(function(h){if(Ext.isFunction(h.updateScheData)){h.updateScheData(d)}},a);a.getRetention()}},scope:a})},processLunResp:function(b,a){a.enable_snapshot_schedule=b.general.task_enabled;a.tid=b.general.tid;a.task_name=b.general.task_name;a.enable_app_consist=("crash"===b.general.snap_type)?false:true;a.schedule=b.schedule},updateShareListPanel:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.Share",method:"list",version:1,params:{shareType:"all",additional:SYNO.SDS.DisasterRecovery.SharedFolderAdditionalInfo()},scope:a,callback:function(d,c,b){if(d){a.appWin.processShareData(c.shares);if(0<=a.appWin.sharedFolders.length){a.appWin.storeLoadData("share")}}a.clearStatusBusy();a.close()}})},updateLunListPanel:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,params:{blSink:true,offset:0,limit:-1},scope:a,callback:function(d,c,b){if(d){a.appWin.processLunData(c.luns);if(0<=a.appWin.iSCSILuns.length){a.appWin.storeLoadData("lun")}}a.clearStatusBusy();a.close()}})},setRetention:function(){var b=this,a=b.getForm("retentionSnapshot");if(!a.isDirty()){if("Share"===b.type){b.updateShareListPanel()}else{b.updateLunListPanel()}return}var c={type:b.type,name:("Lun"===b.type)?b.lun.get("lid").toString():b.share.get("name"),policyType:a.findField("policyType").getGroupValue(),hourly:a.findField("hourly").getValue(),daily:a.findField("daily").getValue(),weekly:a.findField("weekly").getValue(),monthly:a.findField("monthly").getValue(),yearly:a.findField("yearly").getValue()};b.sendWebAPI({api:"SYNO.DisasterRecovery.Retention",method:"set",version:1,params:c,scope:b,callback:function(g,e,d){b.clearStatusBusy();if(!g){var f=SYNO.SDS.DisasterRecovery.GetErrMsg(e.code);b.getMsgBox().alert(_T("snapmgr","set_schedule"),f,function(){b.close()},b);b.setStatusError({text:f,clear:true});return}else{if("Share"===b.type){b.updateShareListPanel()}else{b.updateLunListPanel()}}}})},getRetention:function(){var a=this;a.sendWebAPI({api:"SYNO.DisasterRecovery.Retention",method:"get",version:1,params:{type:a.type,name:("Lun"===a.type)?a.lun.get("lid").toString():a.share.get("name")},scope:a,callback:function(e,c,b){a.clearStatusBusy();if(!e){var d=SYNO.SDS.DisasterRecovery.GetErrMsg(c.code);a.getMsgBox().alert(_T("snapmgr","set_schedule"),d,function(){a.close()},a);a.setStatusError({text:d,clear:true});return}else{a.tabPanel.items.each(function(f){if(Ext.isFunction(f.updateRetData)){f.updateRetData(c)}},a)}}})},getGeneralData:function(){var b=this,a={};var d=b.tabPanel.getItem("scheduleSnapshot").getForm(),c=b.tabPanel.getItem("lunApplication").getForm();a.task_enabled=d.findField("enable_snapshot_schedule").getValue();a.task_name=d.findField("task_name").getValue();a.tid=d.findField("tid").getValue();a.snap_type=c.findField("enable_app_consist").getValue()?"app":"crash";return a},getScheData:function(){var c=this,b=c.tabPanel.getItem("scheduleSnapshot"),a={};a.date_type=0;a.week_name=Ext.getCmp(b.week_name_id).getValue();a.hour=Ext.getCmp(b.hour_id).getValue();a.min=Ext.getCmp(b.min_id).getValue();a.repeat_hour=Ext.getCmp(b.repeat_hour_id).getValue()%100;a.repeat_min=parseInt(Ext.getCmp(b.repeat_hour_id).getValue()/100,10);a.last_work_hour=Ext.getCmp(b.last_work_hour_id).getValue();return a}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.Configure.Schedule",{extend:"SYNO.SDS.TaskScheduler2.EditSchedulePanel",constructor:function(){var a=this;a.callParent(arguments);a.mon(a,"afterlayout",function(){a.dummy1=new SYNO.ux.Utils.EnableCheckGroup(a.form,"enable_snapshot_schedule",[a.week_name_id,a.hour_id,a.min_id,a.repeat_hour_id,a.last_work_hour_id])},a,{single:true})},fillConfig:function(e){var f=this,d;var g=[];var c=[];for(d=0;d<24;++d){g.push([String.leftPad(String(d),2,"0"),d])}var h=new Ext.data.ArrayStore({fields:["display","value"],data:g});f.addManagedComponent(h);for(d=0;d<60;++d){c.push([String.leftPad(String(d),2,"0"),d])}var a=new Ext.data.ArrayStore({fields:["display","value"],data:c});f.addManagedComponent(a);f.repeat_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});f.addManagedComponent(f.repeat_hour_store);f.last_work_hour_store=new Ext.data.ArrayStore({fields:["display","value"]});f.addManagedComponent(f.last_work_hour_store);var b={title:_T("common","schedule"),itemId:"scheduleSnapshot",border:false,MinInterval:[5,15,30],HourInterval:[1,2,3,4,6,8,12],items:[{xtype:"syno_numberfield",name:"task_id",hidden:true},{xtype:"syno_numberfield",name:"tid",hidden:true},{xtype:"syno_displayfield",name:"task_name",hidden:true},{xtype:"syno_checkbox",name:"enable_snapshot_schedule",boxLabel:_T("iscsilun","snapshot_schedule_enable")},{xtype:"syno_compositefield",fieldLabel:_T("snapmgr","sche_exec_day"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_schedulefield",id:f.week_name_id=Ext.id(),hideLabel:true,allowBlank:false,editable:false,width:200}]},{xtype:"syno_combobox",store:f.repeat_hour_store,value:0,fieldLabel:_T("snapmgr","sche_repeat_every"),labelWidth:180,displayField:"display",valueField:"value",id:f.repeat_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1,listeners:{select:{fn:function(){f.updateLastWorkTimeStore()},scope:f}}},{xtype:"syno_compositefield",fieldLabel:_T("snapmgr","sche_start_at"),labelWidth:180,width:200,indent:1,items:[{xtype:"syno_combobox",store:h,displayField:"display",id:f.hour_id=Ext.id(),valueField:"value",triggerAction:"all",mode:"local",width:92,editable:false,listeners:{select:{fn:function(){f.updateRepeatHourStore();f.updateLastWorkTimeStore()},scope:f}}},{xtype:"syno_displayfield",value:":"},{xtype:"syno_combobox",store:a,displayField:"display",valueField:"value",id:f.min_id=Ext.id(),triggerAction:"all",width:93,mode:"local",editable:false,listeners:{select:{fn:function(){f.updateLastWorkTimeStore()},scope:f}}}]},{xtype:"syno_combobox",store:f.last_work_hour_store,value:0,labelWidth:180,fieldLabel:_T("snapmgr","sche_repeat_until"),displayField:"display",valueField:"value",id:f.last_work_hour_id=Ext.id(),triggerAction:"all",width:200,mode:"local",editable:false,indent:1}]};Ext.apply(b,e);return b},updateLastWorkTimeStore:function(){var a=this;a.callParent(arguments);if(!a.form.findField("enable_snapshot_schedule").getValue()){Ext.getCmp(a.min_id).disable(false)}if(a.last_work_hour_store.totalLength>0){Ext.getCmp(a.last_work_hour_id).setValue(a.last_work_hour_store.getAt(a.last_work_hour_store.totalLength-1).data.value)}},updateScheData:function(b){var a=this,c=b.schedule;Ext.getCmp(a.form.findField("task_id").setValue(b.task_id));Ext.getCmp(a.form.findField("tid").setValue(b.tid));Ext.getCmp(a.form.findField("task_name").setValue(b.task_name));Ext.getCmp(a.week_name_id).setValue(c.week_name);a.form.findField("enable_snapshot_schedule").setValue(b.enable_snapshot_schedule);Ext.getCmp(a.hour_id).setValue(c.hour);Ext.getCmp(a.min_id).setValue(c.min);a.updateRepeatHourStore();Ext.getCmp(a.repeat_hour_id).setValue(c.repeat_hour+c.repeat_min*100);a.updateLastWorkTimeStore();Ext.getCmp(a.last_work_hour_id).setValue(c.last_work_hour)}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.Configure.Retention",{extend:"SYNO.ux.FormPanel",MAX_RET_HOURLY:256,MAX_RET_DAILY:256,MAX_RET_WEEKLY:256,MAX_RET_MONTHLY:120,MAX_RET_YEARLY:10,constructor:function(a){var c=this,b;b={title:_T("snapmgr","ret_title"),itemId:"retentionSnapshot",trackResetOnLoad:true,items:[{xtype:"syno_displayfield",name:"ret_desc",value:_T("snapmgr","ret_desp")},{xtype:"syno_radio",name:"policyType",id:"ret_del_old",boxLabel:_T("snapmgr","ret_del_old"),inputValue:SYNO.SDS.DisasterRecovery.RTT_DEL_OLD},{xtype:"syno_radio",name:"policyType",id:"ret_all",boxLabel:_T("snapmgr","ret_all_desc"),inputValue:SYNO.SDS.DisasterRecovery.RTT_ALL},{xtype:"syno_radio",name:"policyType",id:"ret_policy",boxLabel:_T("snapmgr","ret_pol_desc"),inputValue:SYNO.SDS.DisasterRecovery.RTT_POL_TIME},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:12,width:90,name:"hourly",me:c,id:c.ret_hourly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_HOURLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_hourly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:3,width:90,name:"daily",me:c,id:c.ret_daily_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_DAILY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_daily")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:1,width:90,name:"weekly",me:c,id:c.ret_weekly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_WEEKLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_weekly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"monthly",me:c,id:c.ret_monthly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_MONTHLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_monthly")}]},{xtype:"syno_compositefield",hideLabel:true,height:28,indent:1,items:[{xtype:"syno_numberfield",value:0,width:90,name:"yearly",me:c,id:c.ret_yearly_id=Ext.id(),minValue:0,maxValue:c.MAX_RET_YEARLY,enableKeyEvents:true,listeners:{keypress:function(f,d){if(!this.isValid()&&this.el.dom.selectionStart===this.el.dom.selectionEnd&&this.getRawValue()!==""){d.stopEvent()}},disable:function(){this.reset()}}},{xtype:"syno_displayfield",width:10,value:""},{xtype:"syno_displayfield",value:_T("snapmgr","ret_yearly")}]}]};c.callParent([Ext.apply(b,a)]);c.mon(c,"afterlayout",function(){var d={};d[SYNO.SDS.DisasterRecovery.RTT_DEL_OLD]=[];d[SYNO.SDS.DisasterRecovery.RTT_ALL]=[];d[SYNO.SDS.DisasterRecovery.RTT_POL_TIME]=[c.ret_hourly_id,c.ret_daily_id,c.ret_weekly_id,c.ret_monthly_id,c.ret_yearly_id];c.dummy1=new SYNO.ux.Utils.EnableRadioGroup(c.form,"policyType",d);SYNO.SDS.Utils.AddTip(c.form.findField("ret_all").getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","ret_all_tip")));SYNO.SDS.Utils.AddTip(c.form.findField("ret_policy").getEl(),Ext.util.Format.htmlEncode(_T("snapmgr","ret_all_tip")))},c,{single:true})},updateRetData:function(a){this.form.setValues(a)}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.Configure.LunApplication",{extend:"SYNO.ux.FormPanel",constructor:function(a){var c=_D("upnpmodelname","");var d=String.format(_T("snapmgr","app_link"),c);var b={title:_T("snapmgr","application"),itemId:"lunApplication",items:[{xtype:"syno_checkbox",name:"enable_app_consist",boxLabel:_T("snapmgr","app_desc")},{xtype:"syno_displayfield",value:d}]};this.callParent([Ext.apply(b,a)])},updateScheData:function(a){Ext.getCmp(this.form.findField("enable_app_consist").setValue(a.enable_app_consist))}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.iSCSILUN",{extend:"SYNO.SDS.DisasterRecovery.ListPanel",constructor:function(a){var c=this,b,e=[];c.appWin=a.appWin;c.owner=a.owner;c.type="lun";c.list=new SYNO.SDS.DisasterRecovery.ListDataView({appWin:c.appWin,owner:c,multiSelect:false,singleSelect:true,store:c.appWin.iSCSILunStore,progressTpl:SYNO.SDS.DisasterRecovery.ProgressTpl(),innerTpl:SYNO.SDS.DisasterRecovery.SnapshotTpl(),listeners:{selectionchange:c.onSelectionChange,scope:c}});e.push({itemId:"take_snapshot",text:_T("iscsilun","take_snapshot"),handler:c.onTakeSnapshot,disabled:true,scope:c},{itemId:"manage",text:_T("snapmgr","snap_list"),handler:c.onManage,disabled:true,scope:c},{itemId:"configure",text:_T("snapmgr","set_schedule"),handler:c.onConfigure,disabled:true,scope:c},{itemId:"application",text:_T("iscsilun","snapshot_manager_list"),handler:c.onApplication,disabled:true,scope:c});var d=new SYNO.SDS.DisasterRecovery.Snapshot.SearchField({appWin:c.appWin,owner:c,protectedDisplayText:_T("snapmgr","snap_lun_protected"),allDisaplsyText:_T("snapmgr","snap_lun_all"),notProtectedDisplayText:_T("snapmgr","snap_lun_not_protected")});b={title:_T("tree","leaf_iscsilun"),border:false,layout:"fit",tbar:{defaultType:"syno_button",items:[e,"->",d]},items:[c.list],listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},onSelectionChange:function(){var b=this,a=b.list.getSelectedRecords(),c=true;b.getButton("take_snapshot").setDisabled(false);b.getButton("manage").setDisabled(false);b.getButton("configure").setDisabled(false);b.getButton("application").setDisabled(false);a.each(function(d){if(!SYNO.SDS.DisasterRecovery.lunCanSnapshot(d)){c=false;return false}},b);if(!c){b.getButton("take_snapshot").setDisabled(true)}if(0===a.length){b.getButton("take_snapshot").setDisabled(true);b.getButton("manage").setDisabled(true);b.getButton("configure").setDisabled(true);b.getButton("application").setDisabled(true)}},onTakeSnapshot:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunSnapshot({appWin:b.appWin,owner:b.appWin,lun:a[0],title:_T("iscsilun","take_snapshot")+" - "+a[0].get("name"),mode:"create"});c.open()},onManage:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunManage({appWin:b.appWin,owner:b.appWin,title:_T("snapmgr","snap_list")+" - "+a[0].get("name"),lun:a[0]});c.open()},onConfigure:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Snapshot.Configure({appWin:b.appWin,owner:b.appWin,lun:a[0],title:_T("snapmgr","set_schedule")+" - "+a[0].get("name"),func:"iSCSILuns"});c.open()},onApplication:function(){var a=this;var b=new SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunServerList({title:_T("iscsilun","snapshot_manager_list"),appWin:a.appWin,owner:a.appWin});b.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunSnapshot",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var d=this,b,c;d.appWin=a.appWin;d.owner=a.owner;d.lun=a.lun;d.mode=a.mode;c=("create"===d.mode&&d.IsAnyMappedTargetConnected(d.lun,d.appWin.iscsiTrgs));b={title:a.title,width:550,height:c?450:250,resizable:false,buttons:[{xtype:"syno_button",btnStyle:"blue",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","alt_apply"),scope:d,handler:d.onSave},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:d,handler:d.onCancel}],items:[d.createFrom(c)]};d.callParent([Ext.apply(b,a)])},IsAnyMappedTargetConnected:function(d,a){var c=false,b;Ext.each(a,function(e){if("connected"!==e.status){return true}for(b=0;b<e.mapped_luns.length;b++){if(d.get("lid")===e.mapped_luns[b]){c=true;return false}}});return c},getForm:function(){return this.getComponent("lunSnapshot").getForm()},onOpen:function(){var a=this;a.callParent(arguments);a.initValues();a.addTip()},addTip:function(){var a=this;SYNO.SDS.Utils.AddTip(a.getForm().findField("lock").getEl(),Ext.util.Format.htmlEncode(_T("iscsilun","snapshot_lock_notify")))},initValues:function(){var b=this,a;if(b.IsCreateMode()){a=new Date();b.getForm().setValues({name:b.genNewSnapShotName(b.lun.get("snapshots")),time:a.format("Y/m/d H:i:s"),type:"app"})}else{a=new Date(b.snapshot.time*1000);b.getForm().setValues(b.snapshot);b.getForm().setValues({time:a.format("Y/m/d H:i:s")})}},genNewSnapShotName:function(c){var b="SnapShot-",a=b.length,d=0;Ext.each(c,function(e){var f=parseInt(e.name.slice(a),10);if(d<f){d=f}});d=d+1;return b+d},onCancel:function(){if(this.getForm().isDirty()){this.getMsgBox().confirm(_T("snapmgr","app_title"),_T("common","confirm_lostchange"),function(a){if("yes"===a){this.close()}},this);return}this.close()},createFrom:function(a){var c=this;var b={xtype:"form",itemId:"lunSnapshot",border:false,trackResetOnLoad:true,defaults:{width:300,labelWidth:200},items:[{xtype:"syno_displayfield",name:"name",itemId:"name",submitValue:true,fieldLabel:_T("common","name")},{xtype:"syno_textfield",name:"desc",itemId:"desc",maxLength:1023,fieldLabel:_T("share","share_comment")},{xtype:"syno_displayfield",name:"time",fieldLabel:_T("time","time_time"),hideLabel:false},{xtype:"syno_combobox",name:"type",hiddenName:"type",itemId:"type",disabled:(c.IsCreateMode()?false:true),hidden:((a||c.IsEditMode())?false:true),fieldLabel:_T("iscsilun","snapshot_method"),store:[["app",_T("iscsilun","snapshot_application_consistent")],["crash",_T("iscsilun","snapshot_crash_consistent")]]},{xtype:"syno_checkbox",name:"lock",itemId:"lock",boxLabel:_T("iscsilun","snapshot_lock"),checked:true},{xtype:"syno_displayfield",width:510,hidden:a?false:true,value:String.format('<span class="red-status"> {0}</span>',String.format(_T("iscsilun","clone_snapshot_inconsistent_warning"),c.lun.get("name")))}]};return b},IsCreateMode:function(){if("create"===this.mode){return true}return false},IsEditMode:function(){if("edit"===this.mode){return true}return false},prepareParams:function(){var e=this,d=e.getForm(),a=d.findField("name").getValue(),g=d.findField("desc").getValue(),c=d.findField("type").getValue(),b=d.findField("lock").getValue(),f;if(e.IsCreateMode()){f={action:"snapshot",mode:"create",plid:e.lun.get("lid"),name:a,desc:g,type:c,lock:b}}else{f={action:"snapshot",mode:"edit",lid:e.lun.get("lid"),sid:e.snapshot.sid,name:a,desc:g,type:c,lock:b}}return Ext.util.JSON.encode(f)},IsSnapShotCountExceeded:function(){var a=this.lun.get("snapshots").size();if(a>=_D("max_snapshot_per_lun","256")){return true}return false},onSave:function(){var c=this,a=String.format(_T("iscsilun","iscsitrg_max_snapshot_per_lun"),_D("max_snapshot_per_lun","256")),b=c.getForm();if(c.IsEditMode()&&!b.isDirty()){c.close();return}if(!b.isValid()){return}if("create"===c.mode){if(c.IsSnapShotCountExceeded()){c.getMsgBox().alert(c.title,a,function(){c.close()});return}}c.setStatusBusy({text:_T("common","saving")});Ext.Ajax.request({url:c.appWin.getLunActionURL(),params:c.prepareParams(),callback:function(e,g,f){var d=null;c.clearStatusBusy();if(g){d=Ext.util.JSON.decode(f.responseText)}if(!g||!d.success){c.reportFailure(d);return}c.close()},scope:c})},reportFailure:function(a){this.getMsgBox().alert(_T("snapmgr","spp_title"),_T(a.errinfo.sec,a.errinfo.key))}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunManage",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:a.title,layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,buttons:[{text:_T("common","alt_close"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},getGrid:function(){return this.get("lunSnapshots")},getSelections:function(){return this.getGrid().getSelectionModel().getSelections()},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},initEvents:function(){this.callParent(arguments)},onSelectionChange:function(d){var b=this,a=d.getCount(),c=false;d.selections.items.each(function(e){if("Healthy"!==e.data.status.type&&"Unhealthy"!==e.data.status.type){c=true;return false}});if(0!==a&&false===c){b.getButton("btDelete").enable()}else{b.getButton("btDelete").disable()}if(1===a&&false===c){b.getButton("btEdit").enable()}else{b.getButton("btEdit").disable()}return},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addAjaxTask({url:a.appWin.getLunActionURL(),params:{action:"snapshot_load",lid:a.lun.get("lid")},interval:5000,autoJsonDecode:true,success:a.loadGrid,scope:a})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},loadGrid:function(d){var c=this,a,b;if(undefined===c.getGrid()){return}a=c.getGrid().getStore();if(!d.success){return}a.loadData(d);b=c.getGrid().getTopToolbar().get("search").getValue();if(""!==b){a.filter("desc",b,true)}c.clearLoadingMask()},createPanel:function(){var e=this;var a=new Ext.data.JsonStore({autoDestroy:true,pruneModifiedRecords:true,sortInfo:{field:"time",direction:"DESC"},idProperty:"sid",root:"data",fields:["sid","name","desc","time","status","canClone","type","lock"]});e.store=a;var d=[{id:"name",header:_T("common","name"),width:90,dataIndex:"name"},{id:"time",header:_T("time","time_time"),dataIndex:"time",width:170,renderer:function(h){var g=new Date(h*1000);return g.format("Y/m/d H:i:s")}},{id:"snapshot_method",header:_T("iscsilun","snapshot_method"),dataIndex:"type",width:160,renderer:function(g){return("app"===g?_T("iscsilun","snapshot_application_consistent"):_T("iscsilun","snapshot_crash_consistent"))}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",width:190,renderer:Ext.util.Format.htmlEncode},{id:"status",header:_T("iscsitrg","iscsitrg_status"),dataIndex:"status",width:70,renderer:SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SnapShotStatusRender},{id:"lock",header:_T("iscsilun","snapshot_lock"),dataIndex:"lock",width:45,renderer:function(g){return(true===g?'<div class="sm-snapshot-lun-lock"></div>':"")}}];var f={defaultType:"syno_button",items:[{text:_T("common","remove"),itemId:"btDelete",handler:this.snapshotDelete,disabled:true,scope:this},{text:_T("common","alt_edit"),itemId:"btEdit",handler:this.snapshotEdit,disabled:true,scope:this},"->",new SYNO.SDS.DisasterRecovery.iSCSILun.TextFilter({iconStyle:"filter",itemId:"search",store:a,localFilter:true,localFilterField:"desc"})]};var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(g){g.scrollTop=g.scroller.dom.scrollTop},refresh:function(g){g.scroller.dom.scrollTop=g.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"lunSnapshots",style:{padding:"0px 12px 0px 16px"},tbar:f,store:a,columns:d,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:e.onSelectionChange,scope:e}}),listeners:{scope:e,activate:e.onActivate,rowdblclick:{scope:e,fn:function(h,j,i){var g=e.store.getAt(j);if(g){e.snapshotEdit()}}}},enableHdMenu:false,autoExpandColumn:"desc",viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},snapshotDelete:function(){this.getMsgBox().confirmDelete(this.title,_T("common","remove_cfrmrmv"),function(a){if("yes"===a){this.doSnapshotDelete()}},this)},doSnapshotDelete:function(){var b=this,c=b.getSelections(),a=[];b.setStatusBusy({text:_T("common","saving")});c.each(function(d){a.push(d.get("sid"))});b.stopPollingTask();Ext.Ajax.request({url:b.appWin.getLunActionURL(),params:Ext.util.JSON.encode({action:"snapshot",mode:"delete",lid:b.lun.get("lid"),sids:a}),callback:function(e,g,f){var d=null;b.clearStatusBusy();b.startPollingTask();if(g){d=Ext.util.JSON.decode(f.responseText)}if(!g||!d.success){b.reportFailure(d);return}b.isDataChanged=true},scope:b})},snapshotEdit:function(){var c=this,a=c.getSelected().data;var b=new SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunSnapshot({owner:c,appWin:c.appWin,title:_T("common","alt_edit")+" - "+c.lun.get("name"),lun:c.lun,mode:"edit",snapshot:a});b.mon(b,"close",function(){if(b.isDataChanged){c.isDataChanged=true;c.setLoadingMask()}},c,{single:true});b.open()},reportFailure:function(a){this.getMsgBox().alert(this.title,a.text)}});Ext.define("SYNO.SDS.DisasterRecovery.Snapshot.iSCSILunServerList",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;b={title:a.title,layout:"fit",items:[],minWidth:500,minHeight:400,width:600,height:450,buttons:[{text:_T("common","alt_close"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},createPanel:function(){var a=new Ext.data.JsonStore({autoDestroy:true,root:"data",fields:["ip","type"]});var d=[{id:"ip",header:_T("common","ip_addr"),dataIndex:"ip"},{id:"type",header:_T("network","interface_type"),dataIndex:"type",renderer:function(e){return _T("iscsilun",e)}}];var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(e){e.scrollTop=e.scroller.dom.scrollTop},refresh:function(e){e.scroller.dom.scrollTop=e.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"plugins",style:{padding:"0px 12px 0px 16px"},store:a,columns:d,enableHdMenu:false,viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addAjaxTask({url:a.appWin.getLunActionURL(),params:{action:"load_plugin"},interval:5000,autoJsonDecode:true,success:a.loadGrid,scope:a})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},loadGrid:function(c){var b=this;var a=b.get("plugins").getStore();if(!c.success){return}a.loadData(c);b.clearLoadingMask()},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.Main",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var d=this,c,b=[];d.appWin=a.appWin;d.owner=a.owner;if("yes"===_D("support_share_snapshot","no")){b.push(new SYNO.SDS.DisasterRecovery.Recovery.SharedFolder({appWin:d.appWin,owner:d.owner}))}if("yes"===_D("support_vaai","no")&&"lio"===_D("iscsi_target_type","")){b.push(new SYNO.SDS.DisasterRecovery.Recovery.iSCSILUN({appWin:d.appWin,owner:d.owner}))}c={appWin:d.appWin,owner:d.owner,itemId:"recovery",activeTab:0,items:b};this.callParent([c])},onPageActivate:function(){this.getActiveTab().fireEvent("activate")}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.TargetList",{extend:"SYNO.SDS.DisasterRecovery.ListPanel",constructor:function(a){var c=this,b,e=[];c.appWin=a.appWin;c.owner=a.owner;e.push({itemId:"manage",text:_T("snapmgr","rec_start"),handler:c.onManage,disabled:true,scope:c});var d=new SYNO.ux.TextFilter({iconStyle:"search",itemId:"searchShareName",listeners:{keyup:c.onActivate,scope:c}});b={border:false,layout:"fit",tbar:{defaultType:"syno_button",items:[e,"->",d]},items:[c.list],listeners:{activate:c.onActivate,scope:c}};c.callParent([Ext.apply(b,a)])},onSelectionChange:function(){var b=this,a=b.list.getSelectedRecords(),c=true;b.getButton("manage").setDisabled(true);if(1!==a.length){return}if("lun"===b.type){a.each(function(d){if(!SYNO.SDS.DisasterRecovery.lunCanSnapshot(d)){c=false;return false}},b);if(!c){return}}b.getButton("manage").setDisabled(false)}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.SharedFolder",{extend:"SYNO.SDS.DisasterRecovery.Recovery.TargetList",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.type="share";c.list=new SYNO.SDS.DisasterRecovery.ListDataView({appWin:c.appWin,owner:c,multiSelect:false,singleSelect:true,store:c.appWin.sharedFolderStore,innerTpl:SYNO.SDS.DisasterRecovery.RestoreTpl(),blRestore:true,listeners:{selectionchange:c.onSelectionChange,scope:c}});b={title:_T("tree","leaf_sharefolder")};c.callParent([Ext.apply(b,a)])},onManage:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Recovery.SharedFolderManage({appWin:b.appWin,owner:b.appWin,share:a[0],title:_T("snapmgr","rec_start")+" - "+a[0].get("name"),blNfsEnabled:b.appWin.nfsEnabled,blKerberosSupport:b.appWin.nfsKerberosSupport,blKerberosEnabled:b.appWin.nfsKerberosEnabled});c.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.SharedFolderManage",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.share=a.share;c.blNfsEnabled=a.blNfsEnabled;c.blKerberosSupport=a.blKerberosSupport;c.blKerberosEnabled=a.blKerberosEnabled;var b={layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,buttons:[{text:_T("common","alt_close"),scope:c,handler:c.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){var a=this;a.items.push(a.createPanel());a.callParent(arguments)},getGrid:function(){return this.get("recovery")},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},initEvents:function(){this.callParent(arguments);this.setLoadingMask();this.getGrid().getStore().load({callback:function(){this.appOwner.clearLoadingMask()}})},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},onSelectionChange:function(e){var c=this;var b=e.getCount();var d=c.share.get("support_action");var a=c.share.get("encryption");if(1===b){if((d&4)||(d&8)||a){c.getButton("restoreTo").enable()}if(d&4||a){c.getButton("restoreTo").menu.get("btRestore").enable()}if(d&8){c.getButton("restoreTo").menu.get("btClone").enable()}if(d&16){c.getButton("btBrowse").enable()}}else{c.getButton("btBrowse").disable();c.getButton("restoreTo").disable();c.getButton("restoreTo").menu.get("btClone").disable();c.getButton("restoreTo").menu.get("btRestore").disable()}return},onCancel:function(){this.close()},createPanel:function(){var e=this;var a=new SYNO.API.JsonStore({appWindow:e.appWin,appOwner:e,autoDestroy:true,api:"SYNO.Core.Share.Snapshot",method:"list",version:1,baseParams:{name:e.share.get("name"),offset:0,limit:-1,filter:{attr:["!hide==true"]},additional:["desc","lock"]},fields:["time","desc","lock"],root:"snapshots",id:"time",listeners:{exception:{scope:e.owner,fn:function(j,k,i,h,g){var l=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(g.code,this)||_T("common","error_system");e.getMsgBox().alert(_T("snapmgr","app_title"),l)}}}});e.store=a;var c=new Ext.grid.ColumnModel({defaults:{width:120,sortable:false},columns:[{id:"time",header:_T("common","name"),dataIndex:"time"},{id:"time",header:_T("time","time_time"),dataIndex:"time",renderer:function(j,g,i){var h=new Date(e.appWin.getSnapTime(i.data,"share"));return h.format("Y/m/d H:i:s")}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",width:100,renderer:Ext.util.Format.htmlEncode},{id:"lock",header:_T("iscsilun","snapshot_lock"),width:60,dataIndex:"lock",renderer:e.lockIconRenderer}]});var f=new Ext.Toolbar({defaultType:"syno_button",items:[{text:_T("download","upload_browse"),itemId:"btBrowse",handler:e.snapshotBrowse,disabled:true,scope:e},{itemId:"restoreTo",text:_T("snapmgr","btn_restore_to"),disabled:true,menu:[{text:_T("snapmgr","btn_restore"),itemId:"btRestore",handler:e.snapshotRestore,disabled:true,scope:e},{text:_T("snapmgr","btn_clone"),itemId:"btClone",handler:function(){e.snapshotClone({blNewShare:true,blClone:true})},disabled:true,scope:e}]},"->",new SYNO.ux.TextFilter({iconStyle:"filter",itemId:"search",store:e.store,queryAction:"list",enumAction:"list",queryParam:"substr"})]});var d={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(g){g.scrollTop=g.scroller.dom.scrollTop},refresh:function(g){g.scroller.dom.scrollTop=g.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"recovery",style:{padding:"0px 12px 0px 16px"},tbar:f,store:a,colModel:c,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:e.onSelectionChange,scope:e}}),listeners:{scope:e,activate:e.onActivate},enableHdMenu:false,autoExpandColumn:"desc",viewConfig:d,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},lockIconRenderer:function(b){var c="";var a="";switch(b){case true:c="share-lock";break;case false:break;default:break}if(c!==""){a=String.format('<div class="syno-admincenter-{0}"></div>',c)}return a},snapshotBrowse:function(){var b=this,a=b.getSelected();b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Core.Share",method:"get",version:1,params:{name:b.share.get("name"),additional:["enable_snapshot_browsing"]},callback:function(e,d,c){b.clearStatusBusy();if(e){if(d.enable_snapshot_browsing){SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+b.share.get("name")+"/#snapshot/"+a.get("time")+"/"});return}b.getMsgBox().confirm(_T("snapmgr","app_title"),_T("snapmgr","snap_browse_msg"),function(f){if("yes"===f){b.makeSnapshotBrowsable(a)}},b)}},scope:b})},makeSnapshotBrowsable:function(a){var b=this;b.setStatusBusy({text:_T("common","msg_waiting")});b.sendWebAPI({api:"SYNO.Core.Share",method:"set",version:1,params:{name:b.share.get("name"),shareinfo:{name:b.share.get("name"),vol_path:b.share.get("vol_path"),desc:"",enable_snapshot_browsing:true}},callback:function(e,d,c){b.clearStatusBusy();if(e){SYNO.SDS.AppLaunch("SYNO.SDS.App.FileStation3.Instance",{openfile:"/"+b.share.get("name")+"/#snapshot/"+a.get("time")+"/"})}},scope:b})},snapshotClone:function(b,a){var c=this;SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Share.Main",dlg:"clone",params:{blNfsEnabled:c.blNfsEnabled,blKerberosSupport:c.blKerberosSupport,blKerberosEnabled:c.blKerberosEnabled,share:c.share,snapshot:c.getSelected().get("time")}})},snapshotRestore:function(){var c=this;var a=c.getSelected();var f=new Date(c.appWin.getSnapTime(c.store.getAt(0).data,"share"));var b=f.format("Y/m/d H:i:s");var e=new SYNO.SDS.DisasterRecovery.Recovery.SharedFolderManage.SnapshotRestore({appWin:c.appWin,owner:c,share:c.share,snapshot:a,latestTime:b});e.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.SharedFolderManage.SnapshotRestore",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this;c.appWin=a.appWin;c.owner=a.owner;c.share=a.share;c.snapshot=a.snapshot;c.latestTime=a.latestTime;var b={title:_T("iscsilun","restore"),width:450,height:250,resizable:false,buttons:[{itemId:"btApply",xtype:"syno_button",btnStyle:"blue",text:_T("common","alt_apply"),scope:c,handler:c.onApply},{xtype:"syno_button",text:_T("common","alt_cancel"),scope:c,handler:c.onCancel}],items:[c.createForm()]};c.callParent([Ext.apply(b,a)])},getForm:function(){return this.getComponent("snapshot").getForm()},onOpen:function(){this.callParent(arguments)},onApply:function(){var a=this;if(a.getFooterToolbar().get("btApply")){a.getFooterToolbar().get("btApply").disable()}a.setStatusBusy({text:_T("common","msg_waiting")});if(a.getForm().findField("take_snap").getValue()){a.doTakeSnapAndRestore()}else{a.doSnapshotRestore()}},doTakeSnapAndRestore:function(){var b=this;var a={};a.desc="Automatic snapshot before in-place restore";a.lock=true;var c={snapinfo:a,name:b.share.get("name")};b.sendWebAPI({api:"SYNO.Core.Share.Snapshot",method:"create",params:c,version:1,scope:this,callback:function(g,e,d){this.isDataChanged=true;b.owner.getGrid().getStore().load();if(!g){b.clearStatusBusy();var f=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(e.code,this)||_T("common","error_system");this.owner.getMsgBox().alert(_T("snapmgr","app_title"),f);this.close()}else{this.doSnapshotRestore()}}})},doSnapshotRestore:function(){var a=this;a.sendWebAPI({api:"SYNO.Core.Share",method:"restore",version:1,scope:a,params:{name:a.share.get("name"),snapshot:a.snapshot.get("time")},callback:function(g,e,d){a.clearStatusBusy();if(!g){var f=String.format(_T("share","share_snapshot_restore_fail"),a.snapshot.get("time"));var c=SYNO.SDS.DisasterRecovery.ShareSnapGetErrMsg(e.code,this)||SYNO.API.Erros.core[e.code];if(c){f+="<br/>"+c}if(e.errors&&e.errors.errMsg){var b=e.errors.errMsg.split(":");f+="<br/>"+_T(b[0],b[1])||""}a.owner.getMsgBox().alert(_T("snapmgr","app_title"),f)}this.close()}})},onCancel:function(){this.close()},createForm:function(){var b=this;var a={xtype:"form",itemId:"snapshot",border:false,trackResetOnLoad:true,items:[{xtype:"syno_displayfield",name:"desc",value:String.format(_T("share","share_snapshot_restore_confirm"),b.snapshot.get("time"))},{xtype:"syno_checkbox",name:"take_snap",boxLabel:_T("share","share_snapshot_take_now")},{xtype:"syno_displayfield",name:"take_snap_desc",indent:1,value:String.format(_T("share","share_snapshot_take_now_desc"),b.latestTime)}]};return a}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.iSCSILUN",{extend:"SYNO.SDS.DisasterRecovery.Recovery.TargetList",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.type="lun";c.list=new SYNO.SDS.DisasterRecovery.ListDataView({appWin:c.appWin,owner:c,multiSelect:false,singleSelect:true,store:c.appWin.iSCSILunStore,progressTpl:SYNO.SDS.DisasterRecovery.ProgressTpl(),innerTpl:SYNO.SDS.DisasterRecovery.RestoreTpl(),blRestore:true,listeners:{selectionchange:c.onSelectionChange,scope:c}});b={title:_T("tree","leaf_iscsilun")};c.callParent([Ext.apply(b,a)])},onManage:function(){var b=this;var a=b.list.getSelectedRecords();var c=new SYNO.SDS.DisasterRecovery.Recovery.iSCSILunManage({appWin:b.appWin,owner:b.appWin,title:_T("snapmgr","rec_start")+" - "+a[0].get("name"),lun:a[0]});c.open()}});Ext.define("SYNO.SDS.DisasterRecovery.Recovery.iSCSILunManage",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var c=this,b;c.appWin=a.appWin;c.owner=a.owner;c.lun=a.lun;b={title:a.title,layout:"fit",items:[],minWidth:760,minHeight:450,width:760,height:450,buttons:[{text:_T("common","alt_close"),scope:this,handler:this.onCancel}]};c.callParent([Ext.apply(b,a)])},initComponent:function(){this.items.push(this.createPanel());this.callParent(arguments)},getGrid:function(){return this.get("lunSnapshots")},getSelected:function(){return this.getGrid().getSelectionModel().getSelected()},getButton:function(a){return this.getGrid().getTopToolbar().get(a)},initEvents:function(){this.callParent(arguments)},onSelectionChange:function(d){var b=this,a=d.getCount(),c=false;d.selections.items.each(function(e){if("Healthy"!==e.data.status.type&&"Unhealthy"!==e.data.status.type){c=true;return false}});b.getButton("restoreTo").disable();b.getButton("restoreTo").menu.get("btClone").disable();b.getButton("restoreTo").menu.get("btRestore").disable();if(1!==a||c||SYNO.SDS.DisasterRecovery.isUpToiSCSISnapShotActionCount(b.appWin.iSCSILuns)){return}b.getButton("restoreTo").enable();if(!b.lun.get("is_actioning")){b.getButton("restoreTo").menu.get("btRestore").enable()}if(!SYNO.SDS.DisasterRecovery.isUpToiSCSILunMaxCount(b.appWin.iSCSILuns)){b.getButton("restoreTo").menu.get("btClone").enable()}},onOpen:function(){var a=this;a.callParent(arguments);a.startPollingTask()},onCancel:function(){this.close()},startPollingTask:function(){var a=this;if(!Ext.isDefined(a.storePollingTask)){a.storePollingTask=a.addAjaxTask({url:a.appWin.getLunActionURL(),params:{action:"snapshot_load",lid:a.lun.get("lid")},interval:5000,autoJsonDecode:true,success:a.loadGrid,scope:a})}if(true!==a.storePollingTask.running){a.setLoadingMask();a.storePollingTask.start()}},stopPollingTask:function(){var a=this.storePollingTask;if(Ext.isDefined(a)&&true===a.running){a.stop()}},setLoadingMask:function(){this.setStatusBusy({text:_T("common","loading")});this.loadingMask=true},clearLoadingMask:function(){var a=this;if(true===a.loadingMask){a.clearStatusBusy();a.loadingMask=false}},loadGrid:function(d){var c=this,a,b;if(undefined===c.getGrid()){return}a=c.getGrid().getStore();if(!d.success){return}a.loadData(d);b=c.getGrid().getTopToolbar().get("search").getValue();if(""!==b){a.filter("desc",b,true)}c.clearLoadingMask()},createPanel:function(){var e=this;var a=new Ext.data.JsonStore({autoDestroy:true,sortInfo:{field:"time",direction:"DESC"},idProperty:"sid",root:"data",fields:["sid","name","desc","time","status","canClone","type","lock"]});var d=[{id:"name",header:_T("common","name"),width:90,dataIndex:"name"},{id:"time",header:_T("time","time_time"),dataIndex:"time",width:155,renderer:function(h){var g=new Date(h*1000);return g.format("Y/m/d H:i:s")}},{id:"snapshot_method",header:_T("iscsilun","snapshot_method"),dataIndex:"type",renderer:function(g){return(("app"===g)?_T("iscsilun","snapshot_application_consistent"):_T("iscsilun","snapshot_crash_consistent"))}},{id:"desc",header:_T("share","share_comment"),dataIndex:"desc",renderer:Ext.util.Format.htmlEncode},{id:"status",header:_T("iscsitrg","iscsitrg_status"),dataIndex:"status",width:70,renderer:SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SnapShotStatusRender},{id:"lock",header:_T("iscsilun","snapshot_lock"),dataIndex:"lock",width:40,renderer:function(g){return(true===g?'<div class="sm-snapshot-lun-lock"></div>':"")}}];var f={defaultType:"syno_button",items:[{itemId:"restoreTo",text:_T("snapmgr","btn_restore_to"),disabled:true,menu:[{text:_T("snapmgr","btn_restore"),itemId:"btRestore",handler:e.snapshotRestore,disabled:true,scope:e},{text:_T("snapmgr","btn_clone"),itemId:"btClone",handler:e.snapshotClone,disabled:true,scope:e}]},"->",new SYNO.SDS.DisasterRecovery.iSCSILun.TextFilter({iconStyle:"filter",itemId:"search",store:a,localFilter:true,localFilterField:"desc"})]};var c={forceFit:true,onLoad:Ext.emptyFn,listeners:{beforerefresh:function(g){g.scrollTop=g.scroller.dom.scrollTop},refresh:function(g){g.scroller.dom.scrollTop=g.scrollTop}}};var b={layout:"fit",xtype:"syno_gridpanel",itemId:"lunSnapshots",style:{padding:"0px 12px 0px 16px"},tbar:f,store:a,columns:d,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:e.onSelectionChange,scope:e}}),enableHdMenu:false,autoExpandColumn:"desc",viewConfig:c,enableColumnMove:false,cls:"without-dirty-red-grid"};return b},snapshotClone:function(){var b=this,a=b.getSelected().data;if(!a.canClone){b.getMsgBox().alert(b.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance",{fn:"SYNO.SDS.StorageManager.iSCSILun.Main",dlg:"CloneLun",params:{lun_id:b.lun.get("id"),snapshot:a}})},snapshotRestore:function(){var a=this,c=a.getSelected(),b='<span class="red-status">'+String.format(_T("iscsilun","restore_data_lost_warning"),c.get("name"))+"</span><br/>"+String.format(_T("iscsilun","snapshot_restore_confirm"),c.get("name"));if(!c.get("canClone")){a.getMsgBox().alert(a.title,_T("iscsitrg","iscsitrg_set_failed_space_not_enough"));return}a.getMsgBox().confirm(a.title,b,function(d){if("yes"===d){a.doSnapshotRestore()}},a)},doSnapshotRestore:function(){var a=this,b=a.getSelected();a.setStatusBusy({text:_T("common","msg_waiting")});Ext.Ajax.request({url:a.appWin.getLunActionURL(),params:Ext.util.JSON.encode({action:"snapshot",mode:"restore",lid:a.lun.get("lid"),sid:b.get("sid")}),callback:function(d,f,e){var c=null;a.clearStatusBusy();if(f){c=Ext.util.JSON.decode(e.responseText)}if(!f||!c.success){a.reportFailure(c);a.close();return}a.isDataChanged=true;a.close()},scope:this})},reportFailure:function(a){this.getMsgBox().alert(_T("snapmgr","app_title"),a.text)}});Ext.define("SYNO.SDS.DisasterRecovery.Log.Main",{extend:"SYNO.ux.GridPanel",itemsPerPage:1000,constructor:function(a){var c=this,b;Ext.apply(c,a);b=c.fillConfig(a);c.itemsPerPage=c.appWin.appInstance.getUserSettings(c.itemId+"-dsPageLimit")||c.itemsPerPage;c.callParent([b]);c.mon(c,"resize",function(d,f,e){c.updateFbarItems(f)},c)},onPageActivate:function(){this.onActive()},getPageRecordStore:function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[100,100],[500,500],[1000,1000],[3000,3000]]});return a},onChangeDisplayRecord:function(d,e,b){var c=this,a=c.logStore;if(c.itemsPerPage!==d.getValue()){c.itemsPerPage=d.getValue();c.paging.pageSize=c.itemsPerPage;a.load({params:{start:0,limit:c.itemsPerPage}});c.appWin.appInstance.setUserSettings(c.itemId+"-dsPageLimit",c.itemsPerPage)}},initPageComboBox:function(a){var b=new SYNO.ux.ComboBox({name:"page_rec",hiddenName:"page_rec",hiddenId:Ext.id(),store:a,displayField:"display",valueField:"value",triggerAction:"all",value:this.itemsPerPage,editable:false,width:72,mode:"local",listeners:{select:{fn:this.onChangeDisplayRecord,scope:this}}});return b},initPagingToolbar:function(){var a=new SYNO.ux.PagingToolbar({store:this.logStore,displayInfo:true,pageSize:this.itemsPerPage,showRefreshBtn:true,items:["-",_T("common","items_perpage"),this.initPageComboBox(this.getPageRecordStore()),"-",{xtype:"tbtext",text:"",itemId:"infoLevel"},"-",{xtype:"tbtext",text:"",itemId:"warnLevel"},"-",{xtype:"tbtext",text:"",itemId:"errorLevel"},"-"]});return a},initSearchForm:function(){var a=new SYNO.SDS.DisasterRecovery.SearchFormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,hidden:true,owner:this});return a},initToolbar:function(){var b=this,a=new SYNO.ux.Toolbar();b.exportButton=new SYNO.ux.SplitButton({xtype:"syno_splitbutton",text:_TT("SYNO.SDS.LogCenter.Instance","logview","btn_export"),handler:b.onExportHtml,scope:b,menu:{items:[{text:_T("log","html_type"),handler:b.onExportHtml,scope:b},{text:_T("log","csv_type"),handler:b.onExportCSV,scope:b}]}});b.searchField=new SYNO.SDS.DisasterRecovery.AdvancedSearchField({iconStyle:"filter",owner:b});b.searchField.searchPanel=b.searchPanel;a.add(b.exportButton);a.add("->");a.add(b.searchField);return a},initEvents:function(){this.mon(this.searchPanel,"search",this.onSearch,this);this.mon(this,"activate",this.onActive,this);this.mon(this.logStore,"load",this.onAfterStoreLoad,this);this.mon(this.logStore,"beforeload",this.onBeforeStoreLoad,this)},getStore:function(){var a=new SYNO.API.Store({api:"SYNO.DisasterRecovery.Log",version:1,method:"list",baseParams:{offset:0,limit:-1},appWindow:this.appWin,autoLoad:true,sortInfo:{field:"time",direction:"DESC"},remoteSort:false,reader:new Ext.data.JsonReader({idProperty:"id",root:"log_list",totalProperty:"total",fields:[{name:"level",mapping:"level"},{name:"log_type",mapping:"log_type"},{name:"time",mapping:"time"},{name:"user",mapping:"user"},{name:"event",mapping:"event"}]})});return a},logLevelRenderer:function(a){switch(a){case"emerg":case"alert":case"crit":case"err":return"<span class='red-status'>Error</span>";case"warn":case"warning":case"notice":return"<span class='orange-status'>Warning</span>";case"info":case"debug":return"<span class='green-status'>Information</span>";default:return"Undefined"}},htmlEncodeRender:function(c,b){var a=Ext.util.Format.htmlEncode(c);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a},getColumnModel:function(){var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.LogCenter.Instance","logattr","attr_priority"),dataIndex:"level",width:100,align:"center",renderer:this.logLevelRenderer},{header:_T("log","log_time"),dataIndex:"time",width:150,align:"center",renderer:this.htmlEncodeRender},{header:_T("log","log_account"),dataIndex:"user",width:100,align:"center",renderer:this.htmlEncodeRender},{id:"descr",header:_T("log","log_action"),dataIndex:"event",css:"white-space:normal;",width:300,renderer:this.htmlEncodeRender}],defaults:{sortable:false,menuDisabled:false}});return a},fillConfig:function(a){var c=this;c.searchPanel=c.initSearchForm();c.logStore=c.getStore();c.paging=c.initPagingToolbar();var b={border:false,trackResetOnLoad:true,layout:"fit",itemId:"dr_log",tbar:c.initToolbar(),enableColumnMove:false,enableHdMenu:false,bbar:c.paging,store:c.logStore,colModel:c.getColumnModel(),view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:27,scrollDelay:30,borderHeight:1}),loadMask:true,stripeRows:true};Ext.apply(b,a);return b},isTheSame:function(b,a){var c;for(c in a){if(a[c]!==b[c]){return false}}return true},onSearch:function(c,d){var b=this,a=b.logStore;if(!b.isTheSame(a.baseParams,d)){Ext.apply(a.baseParams,d);b.loadData()}},onActive:function(){var a=this.logStore,b={datefrom:0,dateto:0,keyword:"",loglevel:""};Ext.applyIf(a.baseParams,b);this.loadData()},loadData:function(){var a=this.logStore,b={start:0,limit:this.itemsPerPage};a.load({params:b})},onBeforeStoreLoad:function(a,b){this.getEl().unmask()},onAfterStoreLoad:function(a,f,c){var e=this,d,b='<div class="{0}" style="width:40px;" ext:qtip="{1}">{2}</div>';if(f.length<1){e.body.mask(_T("log","no_log_available"))}else{e.body.unmask()}d=a.reader.jsonData;e.setLogLevelText(e.getInfoCompoent(),b,"syno-log-info",_T("log","info_level"),d.info_count);e.setLogLevelText(e.getWarnCompoent(),b,"syno-log-warn",_T("log","warn_level"),d.warn_count);e.setLogLevelText(e.getErrorCompoent(),b,"syno-log-err",_T("log","error_level"),d.error_count);e.setPagingToolbar(a,e.paging)},setLogLevelText:function(b,a,c,e,d){if(b){d=d||"0";b.setText(String.format(a,c,e,d))}},getInfoCompoent:function(){return this.paging.getComponent("infoLevel")},getWarnCompoent:function(){return this.paging.getComponent("warnLevel")},getErrorCompoent:function(){return this.paging.getComponent("errorLevel")},setPagingToolbar:function(a,b){this.setPagingToolbarVisible(b,a.getTotalCount()>this.itemsPerPage)},setPagingToolbarVisible:function(a,b){a.setButtonsVisible(true)},updateFbarItems:function(b){var a=0;if(!this.isVisible()){return}if(b<880){for(a=16;a<23;a++){this.paging.items.get(a).hide()}}else{for(a=16;a<23;a++){this.paging.items.get(a).show()}}},onExportCSV:function(){this.onLogSave("csv")},onExportHtml:function(){this.onLogSave("html")},onLogSave:function(a){if(_S("demo_mode")){this.appWin.getMsgBox().alert(this.appWin.title,_JSLIBSTR("uicommon","error_demo"));return}this.saveLog(a)},saveLog:function(c){var f="&title="+_T("snapmgr","app_title"),b="&filename="+_T("snapmgr","app_title");var a=this.logStore,e=a.baseParams,d="/webapi/entry.cgi?api=SYNO.DisasterRecovery.Log&method=export&version=1";if(e.keyword){d+="&keyword="+a.baseParams.keyword}if(e.datefrom){d+="&datefrom="+a.baseParams.datefrom}if(e.dateto){d+="&dateto="+a.baseParams.dateTo}if(e.loglevel){d+="&loglevel="+a.baseParams.loglevel}if(c){d+="&exporttype="+c}d+=f+b;d=Ext.urlAppend(d);if(!this.downloadiframe){this.downloadiframe=Ext.DomHelper.append(document.body,{tag:"iframe",id:Ext.id(),frameBorder:0,width:0,height:0,css:"display:none;visibility:hidden;height:1px;",src:d})}else{this.downloadiframe.src=d}},destroy:function(){if(this.rowNav){Ext.destroy(this.rowNav);this.rowNav=null}this.callParent([this])}});Ext.define("SYNO.SDS.DisasterRecovery.Application",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.DisasterRecovery.MainWindow"});Ext.define("SYNO.SDS.DisasterRecovery.MainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.DisasterRecovery.Overview.Main",SizeRender:SYNO.SDS.Utils.StorageUtils.UiRenderHelper.SizeRender,pollingInterval:5,constructor:function(a){var b=this;var c=[{text:_T("tree","leaf_overview"),iconCls:"icon-overview",help:"DisasterRecovery/overview.html",fn:"SYNO.SDS.DisasterRecovery.Overview.Main",appWin:b,owner:b},{text:_T("snapmgr","page_snapshots"),iconCls:"icon-snapshot",help:"DisasterRecovery/snapshots.html",fn:"SYNO.SDS.DisasterRecovery.Snapshot.Main",appWin:b,owner:b},{text:_T("snapmgr","page_recovery"),iconCls:"icon-recovery",help:"DisasterRecovery/recovery.html",fn:"SYNO.SDS.DisasterRecovery.Recovery.Main",appWin:b,owner:b},{text:_T("tree","leaf_log"),iconCls:"icon-log",fn:"SYNO.SDS.DisasterRecovery.Log.Main",appWin:b,owner:b}];b.initStore();b.initWebAPI();b.scheFilter="auto";b.loaded=false;b.callParent([Ext.apply({cls:"syno-app-disaster-recovery",dsmStyle:"v5",width:990,height:580,minWidth:990,minHeight:580,listItems:c},a)]);b.mon(b,"dataready",function(){b.getActivePage().fireEvent("dataready")},b)},initStore:function(){var a=this;a.sharedFolderStore=new SYNO.SDS.DisasterRecovery.ShareList.Store();a.iSCSILunStore=new SYNO.SDS.DisasterRecovery.LunList.Store();a.SummaryStore=new Ext.data.JsonStore({autoDestroy:true,idProperty:"name",fields:["name","type","capacity","lastSnapshot"],listeners:{load:function(b,c){b.sort("name","ASC");b.sort("type","DESC")},scope:a}})},initWebAPI:function(){this.webapiNfsGet={api:"SYNO.Core.FileServ.NFS",version:1,method:"get"};this.webapiNfsKerberosGet={api:"SYNO.Core.FileServ.NFS.Kerberos",version:1,method:"get"};this.webapiShareList={api:"SYNO.Core.Share",method:"list",version:1,shareType:"all",additional:SYNO.SDS.DisasterRecovery.SharedFolderAdditionalInfo()};this.webapiLunList={api:"SYNO.Core.Storage.iSCSILUN",method:"list",version:1,blSink:true,offset:0,limit:-1};this.webapiTrgList={api:"SYNO.Core.Storage.iSCSITargets",method:"list",version:1,offset:0,limit:-1}},getPage:function(a){return this.getPageCt().get(a)},selectPage:function(a){var b;if(!a){return}b=this.pageList.getNodeById(a);if(!b||!this.pageList.getSelectionModel().isSelected(b)){this.pageList.selectModule(a)}this.handleOpenParams()},handleOpenParams:function(){this.callParent(arguments);if(this.openParams&&this.openParams.trg){this.setFocus(this.openParams.trg)}},setFocus:function(d){var a=this,c,b;if(!a.activePage){return}c=a.activePage;if(c instanceof Ext.TabPanel){c=a.activePage.getActiveTab()}if(!(c.list instanceof SYNO.ux.ExpandableListView)){return}b=c.list;b.focusNode(d);b.select(d);b.expandDetail(Ext.get(d),true)},onOpen:function(a){var b=this;b.callParent(arguments);b.selectPage(b.activePage);b.mon(SYNO.SDS.StatusNotifier,"redirect",b.stopPollTask,b);b.mon(SYNO.SDS.StatusNotifier,"logout",b.stopPollTask,b);b.mon(SYNO.SDS.StatusNotifier,"halt",b.stopPollTask,b);b.createPollTask();b.setStatusBusy(null,null,50);b.startPollTask()},onClose:function(){this.stopPollTask()},createPollTask:function(){var a=this;a.pollTaskConf={interval:a.pollingInterval,immediate:true,appWindow:a,webapi:{api:"SYNO.Entry.Request",version:1,method:"request",params:{stopwhenerror:false,compound:[a.webapiShareList,a.webapiNfsGet,a.webapiNfsKerberosGet,a.webapiLunList,a.webapiTrgList]}},scope:a,status_callback:function(d,c,b){if(!d){a.clearStatusBusy();a.getMsgBox().alert(_T("snapmgr","app_title"),_T("common","error_system"));a.stopPollTask();return}a.processData(c);a.processSummaryData();if(!a.loaded){a.clearStatusBusy();a.loaded=true}a.fireEvent("dataready")}}},processData:function(b){var a=this;b.result.each(function(c){if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiNfsGet,c)){a.nfsEnabled=c.data.enable_nfs}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiNfsKerberosGet,c)){a.nfsKerberosSupport=c.data.kerberos_support;a.nfsKerberosEnabled=(0<c.data.kerberos_principal.length)}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiShareList,c)){a.processShareData(c.data.shares);if(0<=a.sharedFolders.length){a.storeLoadData("share")}}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiLunList,c)){a.processLunData(c.data.luns);if(0<=a.iSCSILuns.length){a.storeLoadData("lun")}}else{if(true===SYNO.ux.Utils.checkApiConsistency(a.webapiTrgList,c)){a.processTrgData(c.data.trgs)}}}}}},a)},processShareData:function(a){var b=this;delete b.sharedFolders;b.sharedFolders=[];a.each(function(c){var e;if(c.is_usb_share){c.support_snapshot=false}Ext.apply(c,c.snapshot_info);delete c.snapshot_info;c.iconCls="dr-list-icon dr-list-icon-share";c.type="share";c.isProtected=(c.snapshots&&(0<c.snapshots.length))?true:false;c.isSnapScheduled=(c.schedule)?true:false;c.snapStatus=b.statusRender(false,c.isProtected);c.capacity=c.support_snapshot?b.SizeRender(c.share_quota_used*1024*1024):"--";if(c.support_snapshot){c.snapshotProp=[{name:_T("snapmgr","snap_freq"),value:c.isSnapScheduled?b.freqRender(c.schedule):"--"},{name:_T("snapmgr","snap_ret_time"),value:b.retentionRender(c.retention)}]}else{c.snapshotProp=[{name:_T("snapmgr","snap_support"),value:_T("common","no")}]}e=new Date();c.lastSnapshot=(!c.isProtected)?"--":b.timeRender(Math.round((e.getTime()-b.getSnapTime(c.snapshots[0],c.type))/1000));c.restorePageLastSnapshot=_T("snapmgr","snap_last_time")+" - "+c.lastSnapshot;c.restoreProp=[{name:_T("snapmgr","snap_can_restore"),value:c.isProtected?c.snapshots.length:"--"}];if(c.isProtected){c.snapshots.each(function(d){d.epoch_msec=b.getSnapTime(d,"share");d.ownername=c.name},b)}b.sharedFolders.push(c)},b)},processLunData:function(a){var b=this;a.each(function(f){var e,c;Ext.apply(f,f.iscsi_lun);delete f.iscsi_lun;c=(f.is_actioning)?b.getLunActionProgress(f):0;f.iconCls="dr-list-icon dr-list-icon-lun";f.type="lun";f.isProtected=(f.snapshots&&(0<f.snapshots.length))?true:false;f.isSnapScheduled=(f.scheduled_task&&f.scheduled_task[0].general.task_enabled)?true:false;f.snapStatus=b.statusRender(f.is_actioning,f.isProtected);f.capacity=b.SizeRender(f.size);f.displayProg=(f.is_actioning)?"show":"hide";f.progress=c.toString()+" %";f.barWidth=200*c/100;if(f.vaai_support){f.snapshotProp=[{name:_T("snapmgr","snap_freq"),value:f.isSnapScheduled?b.freqRender(f.scheduled_task[0].schedule):"--"},{name:_T("snapmgr","snap_ret_time"),value:b.retentionRender(f.retention)}]}else{f.snapshotProp=[{name:_T("snapmgr","snap_support"),value:_T("common","no")}]}e=new Date();f.lastSnapshot=(!f.isProtected)?"--":b.timeRender(Math.round((e.getTime()-b.getSnapTime(f.snapshots[f.snapshots.length-1],f.type))/1000));f.restorePageLastSnapshot=_T("snapmgr","snap_last_time")+" - "+f.lastSnapshot;f.restoreProp=[{name:_T("snapmgr","snap_can_restore"),value:f.isProtected?f.snapshots.length:"--"}];if(f.isProtected){f.snapshots.each(function(d){d.epoch_msec=b.getSnapTime(d,"lun");d.ownername=f.name},b)}},b);delete b.iSCSILuns;b.iSCSILuns=a},processTrgData:function(a){var b=this;delete b.iscsiTrgs;b.iscsiTrgs=a},storeLoadData:function(d){var g=[];var b="";var e=this,a,f,c="protected";if(e.getActivePage()&&"SYNO.SDS.DisasterRecovery.Snapshot.Main"===e.getActivePage().getItemId()){c=e.getActivePage().getActiveTab().getTopToolbar().get("searchShareName").getSearchFilter();b=e.getActivePage().getActiveTab().getTopToolbar().get("searchShareName").getSearchText()}if(e.getActivePage()&&"SYNO.SDS.DisasterRecovery.Recovery.Main"===e.getActivePage().getItemId()){b=e.getActivePage().getActiveTab().getTopToolbar().get("searchShareName").getValue()}if("lun"===d){if(!e.iSCSILuns){return}a=e.iSCSILunStore;f=e.iSCSILuns}else{if("share"===d){if(!e.sharedFolders){return}a=e.sharedFolderStore;f=e.sharedFolders}}a.suspendEvents(true);a.loadData(f,false);if("protected"===c){g.push({property:"isProtected",value:true,anyMatch:true})}if("notProtected"===c){g.push({property:"isProtected",value:false,anyMatch:true})}if(""!==b){g.push({property:"name",value:b,anyMatch:true})}if(g.length>0){a.filter(g)}a.resumeEvents()},processSummaryData:function(){var a=this,b;delete a.scheAutoData;delete a.scheManData;delete a.scheNonData;a.scheAutoData=[];a.scheManData=[];a.scheNonData=[];a.iSCSILuns.each(function(c){if(!c.isProtected){a.scheNonData.push(c)}else{if(c.isSnapScheduled){a.scheAutoData.push(c)}else{a.scheManData.push(c)}}},a);a.sharedFolders.each(function(c){if(!c.isProtected){a.scheNonData.push(c)}else{if(c.isSnapScheduled){a.scheAutoData.push(c)}else{a.scheManData.push(c)}}},a);if("auto"===a.scheFilter){b=a.scheAutoData}else{if("man"===a.scheFilter){b=a.scheManData}else{if("non"===a.scheFilter){b=a.scheNonData}else{return}}}a.SummaryStore.suspendEvents(true);a.SummaryStore.loadData(b,false);a.SummaryStore.resumeEvents()},onSelectionChange:function(){var a=this;a.callParent(arguments);if("SYNO.SDS.DisasterRecovery.Snapshot.Main"===a.getActivePage().getItemId()||"SYNO.SDS.DisasterRecovery.Recovery.Main"===a.getActivePage().getItemId()){a.storeLoadData(a.getActivePage().getActiveTab().type)}},stopPollTask:function(){var a=this;if(a.pollTaskID!==undefined){a.pollUnreg(a.pollTaskID);delete a.pollTaskID}},startPollTask:function(){var a=this;if(undefined===a.pollTaskID){a.pollTaskID=a.pollReg(a.pollTaskConf)}},getLunActionURL:function(){return"/webman/modules/StorageManager/iscsi.cgi"},getLunActionProgress:function(b){var a;if("-1"!==b.progress.percent){a=parseInt(b.progress.percent,10)}else{a=parseInt(b.snapshots[b.snapshots.length-1].status.progress.percent,10)}return(0>a)?0:a},statusRender:function(a,b){var c;if(b){c=String.format("&nbsp;-&nbsp;{0}",'<font class="green-status">'+_T("snapmgr","status_protected")+"</font>")}else{c=String.format("&nbsp;-&nbsp;{0}",'<font class="red-status">'+_T("snapmgr","status_no_protection")+"</font>")}if(a){c=String.format("&nbsp;-&nbsp;{0}",'<font class="blue-status">'+_T("snapmgr","status_processing")+"</font>")}return c},freqRender:function(a){if(0!==a.repeat_hour){return String.format(_T("schedule","every_x_hours"),a.repeat_hour.toString())}else{if(0!==a.repeat_min){return String.format(_T("schedule","every_x_minutes"),a.repeat_min.toString())}else{return _T("schedule","schedule_every_once")}}},timeRender:function(c){var b,a;if(0>c){c=0}if(2>c){b=c;a=_T("common","time_second")}else{if(60>c){b=c;a=_T("common","time_seconds")}else{if(2*60>c){b=Math.floor(c/60);a=_T("common","time_minute")}else{if(60*60>c){b=Math.floor(c/60);a=_T("common","time_minutes")}else{if(2*60*60>c){b=Math.floor(c/(60*60));a=_T("common","time_hour")}else{if(24*60*60>c){b=Math.floor(c/(60*60));a=_T("common","time_hours")}else{if(2*24*60*60>c){b=Math.floor(c/(24*60*60));a=_T("common","time_day")}else{b=Math.floor(c/(24*60*60));a=_T("common","time_days")}}}}}}}return String.format(_T("snapmgr","snap_last_time_msg"),b,a)},retentionRender:function(a){if(!a||!a.policyType||SYNO.SDS.DisasterRecovery.RTT_ALL===a.policyType){return _T("snapmgr","ret_all_snap")}else{if(SYNO.SDS.DisasterRecovery.RTT_DEL_OLD===a.policyType){return _T("snapmgr","ret_del_old")}}if(0!==a.yearly){return a.yearly+" "+_T("snapmgr","ret_yearly")}if(0!==a.monthly){return a.monthly+" "+_T("snapmgr","ret_monthly")}if(0!==a.weekly){return a.weekly+" "+_T("snapmgr","ret_weekly")}if(0!==a.daily){return a.daily+" "+_T("snapmgr","ret_daily")}if(0!==a.hourly){return a.hourly+" "+_T("snapmgr","ret_hourly")}return _T("snapmgr","ret_late_snap")},getSnapTime:function(f,c){var g,a,e,b,h;if("share"===c){g=f.time;a=g.split("-");e=a[1].split(".");b=a[2].split(".");h=new Date(Date.UTC(e[0],e[1]-1,e[2],b[0],b[1],b[2]));return h.getTime()}else{return f.time*1000}}});