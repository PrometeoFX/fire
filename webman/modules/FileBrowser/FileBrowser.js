/* Copyright (c) 2015 Synology Inc. All rights reserved. */

Ext.ns("SYNO.FileStation");SYNO.FileStation.TreeScrollMgr=function(){var d=Ext.dd.DragDropMgr;var f={};var c=null;var j={};var h=function(m){c=null;a()};var k=function(){if(d.dragCurrent){d.refreshCache(d.dragCurrent.groups)}};var b=function(o){var m=o.fleXdata.scrollPosition,n={hasVerticalScroll:m[1][0]!==false,hasHorizontalScroll:m[0][0]!==false,scrollTop:m[1][0],scrollLeft:m[0][0],maxVerticalScroll:m[1][1],maxHorizontalScroll:m[0][1]};return n};var i=function(n,m,p){var t=n.dom,u=(m===true)?0:p,s=(m===true)?p:0,o=b(t),q=o.scrollLeft+u,r=o.scrollTop+s;q=Math.min(q,o.maxHorizontalScroll);r=Math.min(r,o.maxVerticalScroll);q=Math.max(q,0);r=Math.max(r,0);t.fleXcroll.setScrollPos(q,r)};var e=function(){if(d.dragCurrent){var m=SYNO.FileStation.TreeScrollMgr;var n=j.el.ddScrollConfig?j.el.ddScrollConfig.increment:m.incrementm,o=(j.dir=="up"||j.dir=="down");n=(j.dir=="up"||j.dir=="left")?n*(-1):n;if(!m.animate){if(j.el._hasFlexcroll){i(j.el,o,n)}else{if(j.el.scroll(j.dir,n)){k()}}}else{if(j.el._hasFlexcroll){i(j.el,o,n)}else{j.el.scroll(j.dir,n,true,m.animDuration,k)}}}};var a=function(){if(j.id){clearInterval(j.id)}j.id=0;j.el=null;j.dir=""};var g=function(n,m){a();j.el=n;j.dir=m;var p=n.ddScrollConfig?n.ddScrollConfig.ddGroup:undefined,o=(n.ddScrollConfig&&n.ddScrollConfig.frequency)?n.ddScrollConfig.frequency:SYNO.FileStation.TreeScrollMgr.frequency;if(p===undefined||d.dragCurrent.ddGroup==p){j.id=setInterval(e,o)}};var l=function(p,s){if(s||!d.dragCurrent){return}var t=SYNO.FileStation.TreeScrollMgr;if(!c||c!=d.dragCurrent){c=d.dragCurrent;t.refreshCache()}var u=Ext.lib.Event.getXY(p);var v=new Ext.lib.Point(u[0],u[1]);for(var n in f){if(f.hasOwnProperty(n)){var o=f[n],m=(o._hasFlexcroll===true)?o._contentEl._region:o._region;var q=o.ddScrollConfig?o.ddScrollConfig:t;if(m&&m.contains(v)&&(o._hasFlexcroll||o.isScrollable())){if(m.bottom-v.y<=q.vthresh){if(j.el!=o){g(o,"down")}return}else{if(m.right-v.x<=q.hthresh){if(j.el!=o){g(o,"left")}return}else{if(v.y-m.top<=q.vthresh){if(j.el!=o){g(o,"up")}return}else{if(v.x-m.left<=q.hthresh){if(j.el!=o){g(o,"right")}return}}}}}}}a()};d.fireEvents=d.fireEvents.createSequence(l,d);d.stopDrag=d.stopDrag.createSequence(h,d);return{register:function(o){if(Ext.isArray(o)){for(var n=0,m=o.length;n<m;n++){this.register(o[n])}}else{o=Ext.get(o);f[o.id]=o}},unregister:function(o){if(Ext.isArray(o)){for(var n=0,m=o.length;n<m;n++){this.unregister(o[n])}}else{o=Ext.get(o);delete f[o.id]}},vthresh:25,hthresh:25,increment:100,frequency:500,animate:true,animDuration:0.4,ddGroup:undefined,refreshCache:function(){for(var n in f){if(f.hasOwnProperty(n)){if(!f[n].dom){return}var m=f[n].dom.fleXcroll;if(typeof f[n]=="object"){f[n]._region=f[n].getRegion()}if(m){f[n]._hasFlexcroll=true;f[n]._contentEl=f[n].child(".mcontentwrapper");f[n]._contentEl._region=f[n]._contentEl.getRegion()}}}}}}();Ext.ns("SYNO.FileStation");SYNO.FileStation.FavDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.apply(this,a||{});var b=this.fillConfig(a);SYNO.FileStation.FavDialog.superclass.constructor.call(this,b);this.defineBehaviors()},fillConfig:function(){var a={owner:this.owner,width:500,height:180,shadow:true,minWidth:500,minHeight:150,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:"",layout:"fit",items:[{xtype:"form",itemId:"form",labelWidth:75,labelAlign:"top",trackResetOnLoad:true,waitMsgTarget:true,border:false,items:[{xtype:"syno_textfield",itemId:"newname",fieldLabel:_WFT("favorite","enter_favorite"),name:"newname",width:400}],listeners:{actionfailed:{fn:this.callbackHandler,scope:this}}}],buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.saveNewName},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveNewName,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:function(){this.focusEl=this.get("form").form.findField("newname");this.center()},scope:this,single:true}}};return a},defineBehaviors:function(){},callbackHandler:function(){this.hide()},closeHandler:function(){if(this.get("form").form.isDirty()){this.getMsgBox().confirm(this.title,_WFT("common","confirm_lostchange"),function(a){if("yes"==a){this.callbackHandler()}else{return}},this)}else{this.callbackHandler()}},saveNewName:function(){var a="";if(!this.get("form")||!this.get("form").form.findField("newname")){this.closeHandler();return}if(this.blEdit&&!this.get("form").form.isDirty()){this.callbackHandler();return}a=Ext.util.Format.trim(this.get("form").form.findField("newname").getValue());if(!a){this.setStatusError({text:_WFT("error","error_empty_name")});return}this.onAction(a)},onAction:function(b){var a=this.getFavDir();this.setStatusBusy(_T("common","saving"));this.addWebAPITask({single:true,api:"SYNO.FileStation.Favorite",method:this.blRename?"edit":"add",version:1,params:Ext.apply({name:SYNO.API.EscapeStr(b),path:SYNO.API.EscapeStr(a),index:-1},this.getParams()),callback:function(f,c,e){var d;this.clearStatusBusy();if(!f){d=SYNO.webfm.utils.getWebAPIErr(f,c,e);this.getMsgBox().alert(this.title,d)}else{this.fireEvent("callback",this);this.callbackHandler()}},scope:this}).start(true)},resetDialogForm:function(){if(this.get("form")){this.get("form").form.reset()}},setName:function(a){this.name=a},getName:function(){return this.name},setFavDir:function(a){this.favDir=a},getFavDir:function(){return this.favDir},getParams:function(){return this.params},setParams:function(a){this.params=a},setDefaultText:function(){var b=this.getName();var a=this.getFavDir();if(b){var c=a.substr(1,a.indexOf("/",1)-1);c=c?" - "+c:"";this.get("form").form.setValues({newname:this.blRename?b:(b+c)})}},onAddFav:function(){this.blRename=false;this.load()},onEditFav:function(){this.blRename=true;this.load()},load:function(){this.setTitle(this.blRename?_WFT("favorite","rename_favorite"):_WFT("favorite","add_favorite"));this.resetDialogForm();this.setDefaultText();this.clearStatus();this.show()}});Ext.ns("SYNO.FileStation");SYNO.FileStation._Clipboard=Ext.extend(Ext.util.Observable,{constructor:function(){SYNO.FileStation._Clipboard.superclass.constructor.apply(this,arguments);this.data=null;this.addEvents("set","get","clean")},set:function(a,b,c){this.fireEvent("beforeset",this,this.data);this.data={action:a,recs:b,params:SYNO.Util.copy(c)};this.fireEvent("set",this,this.data);return this.data},get:function(){this.fireEvent("get",this,this.data);return this.data},getFilenames:function(){var a=[];Ext.each(this.data.recs,function(b){a.push(b.get("filename"))});return a},clean:function(){this.data=null;this.fireEvent("clean",this)},isEmpty:function(){return Ext.isEmpty(this.data)}});SYNO.FileStation.Clipboard=new SYNO.FileStation._Clipboard();Ext.ns("SYNO.FileStation.Action.Uploader");SYNO.FileStation.Action.Uploader.HTML5UploaderMgr=Ext.extend(Object,{constructor:function(a){this.uploader=new SYNO.FileStation.Action.Uploader.Uploader({cfg:this.getCfg(a),htmlcfg:this.getHTML5Cfg(a),btncfg:a.btncfg})},init:function(a){this.uploader.init(a);this.dragovertime=0},getCfg:function(a){return{limitFiles:1000,listeners:this.getUploadListeners(a.owner)}},getHTML5Cfg:function(a){return{url:a.url,filefiledname:"file",instantStart:true,listeners:{scope:a.owner,onBeforeDropfile:this.onBeforeDropfile,onDragEnter:this.onDragEnter,onDrop:this.onDrop,onDragEnd:this.onDragEnd,onBeforeDragEnter:this.onBeforeDragEnter,onDragOver:{fn:this.onDragOver,scope:this}}}},getUploadListeners:function(a){return{scope:a,onOpen:this.onOpen,onSelect:this.onSelect,onAllSelect:this.onAllSelect,onError:this.onError,onBeforeBrowse:this.onBeforeBrowse}},onBeforeBrowse:function(b,a){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return false}if(!this.onCheckVFSAction("upload",null,this.getUploadPath(a))){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return false}if(!this.onCheckPrivilege("upload",null,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return false}if(a.disabled||1===AppletProgram.blJavaPermission){return false}b.params={path:this.getUploadPath(a)}},onOpen:function(a,b){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}this.getUploadInstance().onOpen({id:b.id})},onSelect:function(a,b){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}if(!b.params.path){Ext.apply(b.params,{path:this.getCurrentDir()})}this.getUploadInstance().onSelect({id:b.id,name:b.name})},onAllSelect:function(c,b,a){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}this.getUploadInstance().onAllSelect(b,a)},onError:function(c,a,b){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}if(!b){var d=_WFT("error","error_error_system");if(Ext.isString(a)){d=a}this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),d);return}},onBeforeDropfile:function(g,e,d,a,c){var b=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false;if(!this.onCheckVFSAction("upload",null,this.getUploadPath())){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return false}if(!this.onCheckPrivilege("upload",null,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return false}var f=new SYNO.FileStation.DropConfirmDialog({owner:this.owner},{cb:a,filenames:e},c);if(b){f.upload(b)}else{f.show()}},onBeforeDragEnter:function(f,b,d){if(1===AppletProgram.blJavaPermission){if((Ext.isIE||Ext.isModernIE||Ext.isChrome)&&SYNO.SDS.AppMgr){var a=false;var g=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance");if(g.length<1){return false}Ext.each(g,function(e){if(e.window===SYNO.SDS.WindowMgr.getActive()){a=true;return false}});var c;if(a){c=SYNO.SDS.WindowMgr.getActive()}else{c=g[0].window;SYNO.SDS.WindowMgr.bringToFront(c)}if(b.owner.appWindow!==c){return false}}return(b.owner.getCurrentSource()==="remote")}},onDragEnter:function(c,a){if(!_S("demo_mode")&&1===AppletProgram.blJavaPermission){var b=a.html5cfg.dropppanelapplet;if(b){b.showDropPanel()}return false}},onDragOver:function(c,a){if(!_S("demo_mode")&&1===AppletProgram.blJavaPermission){var b=a.html5cfg.dropppanelapplet;if(b){if(100<new Date().getTime()-this.dragovertime){b.showDropPanel();this.dragovertime=new Date().getTime()}}}},onDrop:function(b,a){if(!_S("demo_mode")&&1===AppletProgram.blJavaPermission){return false}},onDragEnd:function(c,a){if(!_S("demo_mode")&&1===AppletProgram.blJavaPermission){var b=a.html5cfg.dropppanelapplet;if(b&&!b.processing){b.hideDropPanel();this.dragovertime=0}return false}},onRemoveBtnClick:function(a){if(this.uploader){this.uploader.onRemoveBtnClick(a)}},onAddBtnClick:function(a){if(this.uploader){this.uploader.onAddBtnClick(a)}},onAddJavaDropPanel:function(a,b){if(this.uploader){this.uploader.onAddJavaDropPanel(a,b)}}});SYNO.FileStation.Action.Uploader.Uploader=Ext.extend(SYNO.SDS.App.Uploader.Uploader,{constructor:function(a){SYNO.FileStation.Action.Uploader.Uploader.superclass.constructor.apply(this,arguments);this.initContainer(a)},initContainer:function(a){var b=this;this.init=function(c){c.mon(c,"afterlayout",function(d){d.html5cfg={};d.html5cfg.btncfg=a.btncfg;this.initHTML5Uploader(c)},b,{single:true})}},initHTML5Uploader:function(a){this.html5uploader=new SYNO.FileStation.Action.Uploader.HTML5Uploader(Ext.apply({limitFiles:this.opts.limitFiles},this.htmlopts||{}),{container:a,opts:this.opts})},onRemoveBtnClick:function(a){if(this.html5uploader){this.html5uploader.onRemoveBtnClick(a)}},onAddBtnClick:function(a){if(this.html5uploader){this.html5uploader.onAddBtnClick(a)}},onAddJavaDropPanel:function(a,b){if(this.html5uploader){this.html5uploader.onAddJavaDropPanel(a,b)}}});SYNO.FileStation.Action.Uploader.HTML5Uploader=Ext.extend(SYNO.SDS.App.Uploader.HTML5Uploader,{blFolderEabled:true,constructor:function(b,a){this.initDefData();if(!SYNO.FileStation.HTML5Uploader){this.HTMLUploaderTask=new SYNO.SDS.App.Uploader.HTMLUploaderTaskMgr({uploader:this});SYNO.FileStation.HTMLUploaderTaskMgr=this.HTMLUploaderTask}else{this.HTMLUploaderTask=SYNO.FileStation.HTMLUploaderTaskMgr}Ext.apply(this.opts,b);SYNO.SDS.App.Uploader.HTML5Uploader.superclass.constructor.apply(this,arguments);this.init(a);if(!this.blInitListener){this.mon(this,{scope:this,onProgress:this.onProgressFn,onComplete:this.onCompleteFn,onAllComplete:this.onAllCompleteFn,onError:this.onErrorFn,onCompleteFolderFile:this.onCompleteFolderFileFn});this.blInitListener=true}this.webfm=this.opts.listeners.scope;this.folderFiles={}},getUploadInstance:function(){if(!this.uploadGird){if(_S("standalone")){var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance")[0];this.uploadGird=b.window.panelObj.monitorPanel.getUploadGrid()}else{var a=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0];this.uploadGird=a?a.getUploadGrid():null}}return this.uploadGird},onProgressFn:function(e,b,d){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}var f,a,h;if(b.isSubFile){var c=b.rootObj,g=c.uploadByte,i=c.totalByte;f=Math.floor(((g+d)/i)*100);b.byteswrite=d;a=b.rootObj.name;h=b.params.path.replace(c.params.path+"/","")+"/"+b.name}else{f=Math.floor((d/b.size)*100);a=b.name;h=b.name}if(b.isSubFile||0<f){this.getUploadInstance().onProgressWithTime({id:b.id,byteswrite:d,progress:f,name:a,curname:h,taskInfo:{progress:f,isSubFile:b.isSubFile,complete:(d===b.size)}})}},onCompleteFn:function(c,a,b){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}this.getUploadInstance().onComplete({id:b.id,remotedir:b.params.path,isSkip:a.blSkip,name:b.name,isSubFile:b.isSubFile,isSubFolder:b.isSubFolder,rootObj:b.rootObj})},onCompleteFolderFileFn:function(c,a,b){if(this.getUploadInstance().onCompleteFolderFile){this.getUploadInstance().onCompleteFolderFile({id:b.id,size:b.size,rootObj:b.rootObj})}},onAllCompleteFn:function(a){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}this.getUploadInstance().onAllComplete()},onErrorFn:function(g,b,e){if(!this.blForceHtmlUpload&&1===AppletProgram.blJavaPermission){return false}if(!e){return}if(e.isSubFile||e.isSubFolder){if(!e.rootObj.errors){e.rootObj.errors=[]}var d;if(b&&b.error&&b.error.code){d=SYNO.webfm.utils.getWebAPIErr(false,b.error)}else{if(b&&b.errno&&b.errno.section&&b.errno.key){var f=b.errno.section,a=b.errno.key;d=_WFT(f,a)||_T(f,a)}else{if(Ext.isString(b)){d=b}else{d=_WFT("common","commfail")}}}var c={name:e.params.path+"/"+e.name,errStr:d};e.rootObj.errors.push(c)}this.getUploadInstance().onError({id:e.id,curname:e.name,response:b,status:e.status,size:e.size,byteswrite:e.byteswrite||0,isSubFile:e.isSubFile,isSubFolder:e.isSubFolder,rootObj:e.rootObj})},initDefData:function(){SYNO.FileStation.Action.Uploader.HTML5Uploader.superclass.initDefData.apply(this,arguments);this.blAppenddata=true;this.btncfgs=[]},init:function(a){SYNO.FileStation.Action.Uploader.HTML5Uploader.superclass.init.apply(this,arguments);a.container.html5cfg.html5uploader=this},onAddJavaDropPanel:function(a,b){if(1===AppletProgram.blJavaPermission){a.html5cfg.dropppanelapplet=new AppletProgram.DropPanel(b)}},onDestroy:function(a){SYNO.FileStation.Action.Uploader.HTML5Uploader.superclass.onDestroy.apply(this,arguments);if(a.html5cfg.skipinputel){Ext.destroy(a.html5cfg.skipinputel)}if(a.html5cfg.overinputel){Ext.destroy(a.html5cfg.overinputel)}if(a.html5cfg.dropppanelapplet){a.html5cfg.dropppanelapplet.onDestroy()}},onCreateInputEl:function(){var b,a=Ext.id();b=document.createElement("input");b.setAttribute("id",a);b.setAttribute("type","file");b.setAttribute("multiple","multiple");b.setAttribute("style","position:absolute;left:-10000px;width:1px;1px;");return Ext.getBody().appendChild(b)},onAddSkipBtnClick:function(b,c){var a=b.html5cfg;if(!a.skipinputel){a.skipinputel=this.onCreateInputEl();b.mon(a.skipinputel,"change",function(e,f){this.blFolderEabled=false;this.addFiles.call(this,f.files,true,false,Ext.apply(c,this.params||{}),undefined,false);var d=f.disabled;f.disabled=true;f.value="";f.disabled=d},this)}Ext.each(a.btncfg.skipbtncfg,function(e){var d=e.cmp||Ext.getCmp(e.id);if(d){d.html5cfg={};d.html5cfg.container=b;b.mon(d,"click",this.onClickSkipBtn,this)}},this)},onClickSkipBtn:function(a,b){b.preventDefault();if(false!==this.fireEvent("onBeforeBrowse",this,a)){a.html5cfg.container.html5cfg.skipinputel.dom.click()}},onRemoveSkipBtnClick:function(a){Ext.each(a.html5cfg.btncfg.skipbtncfg,function(c){var b=c.cmp||Ext.getCmp(c.id);a.mun(b,"click",this.onClickSkipBtn,this)},this)},onAddOvwrBtnClick:function(b,c){var a=b.html5cfg;if(!a.overinputel){a.overinputel=this.onCreateInputEl();b.mon(a.overinputel,"change",function(e,f){this.blFolderEabled=false;this.addFiles.call(this,f.files,true,false,Ext.apply(c,this.params||{}),undefined,false);var d=f.disabled;f.disabled=true;f.value="";f.disabled=d},this)}Ext.each(a.btncfg.ovwrbtncfg,function(e){var d=e.cmp||Ext.getCmp(e.id);if(d){d.html5cfg={};d.html5cfg.container=b;b.mon(d,"click",this.onClickOvwrBtn,this)}},this)},onClickOvwrBtn:function(a,b){b.preventDefault();if(false!==this.fireEvent("onBeforeBrowse",this,a)){a.html5cfg.container.html5cfg.overinputel.dom.click()}},onRemoveOvwrBtnClick:function(a){Ext.each(a.html5cfg.btncfg.ovwrbtncfg,function(c){var b=c.cmp||Ext.getCmp(c.id);a.mun(b,"click",this.onClickOvwrBtn,this)},this)},onRemoveBtnClick:function(a){this.onRemoveOvwrBtnClick(a);this.onRemoveSkipBtnClick(a)},onAddBtnClick:function(a){this.onAddOvwrBtnClick(a,{overwrite:true});this.onAddSkipBtnClick(a,{overwrite:false})},preprocFolder:function(d){var a,b,c=function(){a.readEntries(function(e){if(e.length===0){while(d.dirArr.length!==0){a=d.dirArr.splice(0,1)[0].createReader();c()}return}for(b=0;b<e.length;b++){if(e[b].isFile){d.fileNum++}if(e[b].isDirectory){d.folderNum++;d.dirArr.push(e[b])}}c()})};d.fileNum=0;d.folderNum=1;d.totalByte=0;d.uploadByte=0;d.dirArr=[];a=d.dtItem.createReader();c();this.uploadFolder(d,d,d.id)},uploadFolder:function(h,g,e,b,d){var a=g.params.path,f=g.name,c;SYNO.API.currentManager.requestAPI("SYNO.FileStation.CreateFolder","create","1",{folder_path:SYNO.API.EscapeStr(a),name:SYNO.API.EscapeStr(f),force_parent:false},function(l,k,j,i){if(!l){for(c=0;c<k.errors.length;c++){if(k.errors[c].code!=414){this.onError({error:{code:k.errors[c].code}},g);return}}}h.folderNum--;this.onUploadFolderFiles(h,g,e,a,d);if(h===g){this.getUploadInstance().onCompleteRootFolder({id:g.id,remotedir:g.params.path})}},this)},onUploadFolderFiles:function(h,d,k,e,f){var a=d.dtItem||d,m=this,n=a.createReader(),i,l=h.params.path,c={path:(f)?l+"/"+f+"/"+d.name:l+"/"+d.name,overwrite:h.params.overwrite},b=0,g,j=function(){n.readEntries(function(o){if(!o.length){return}var q=function(s){c.mtime=s.lastModifiedDate.getTime();var r=new m.FileObj(s,c);r.id=k;r.fileId=b++;r.isSubFile=true;r.rootObj=h;h.totalByte+=s.size;m.sendFolderCheckInfo(r)};for(i=0;i<o.length;i++){var p=o[i];if(p.isFile){p.file(q)}else{if(p.isDirectory){p.params=c;p.isSubFolder=true;p.id=k;p.rootObj=h;g=(f)?f+"/"+d.name:d.name;m.uploadFolder(h,p,k,e+"/"+d.name,g)}}}j()})};j();if(h.fileNum===0&&h.folderNum===0){m.onFinish({blSkip:false},d)}},onSendFile:function(a){if(a.isDirectory){a.finishedFile=0;this.preprocFolder(a);return}this.sendCheckInfo(a)},sendNextFile:function(c){if(this.folderFiles==={}){return}var b=c.rootObj.name,d=this.folderFiles[b],a;if(d&&d.length>0){for(a=0;a<d.length;a++){if(d[a]===c){d.splice(a,1)}}if(d.length>0){this.sendCheckInfo(d[0])}}},clearFolderFiles:function(b){var a=null;if(b.isSubFolder||b.isSubFile){a=b.rootObj.name}else{a=b.name}if(a===null||!this.folderFiles[a]){return}this.folderFiles[a]=null},sendFolderCheckInfo:function(b){if(b.isSubFile!==true||!b.rootObj){return}var a=b.rootObj.name;if(!this.folderFiles[a]){this.folderFiles[a]=[]}this.folderFiles[a].push(b);if(this.folderFiles[a].length==1){this.sendCheckInfo(this.folderFiles[a][0])}},sendCheckInfo:function(a){Ext.Ajax.request({url:this.url,params:{action:"checkfile",path:a.params.path,filename:a.name,size:a.size,overwrite:a.params.overwrite},method:"POST",callback:function(c,e,d){if(!e){this.onError({},a);return}var b=Ext.util.JSON.decode(d.responseText);if(b.errno){this.onError(b,a);return}if(!b.blSkip){this.onUploadFile(a)}else{this.onFinish(b,a)}},scope:this})}});SYNO.FileStation.DropConfirmDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(d,c,b){this.callback=c.cb;var h;var g=c.filenames;var a=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false;if(g.length==1){var e=g[0];e=e.substring(e.lastIndexOf(((Ext.isWindows)?"\\":"/"))+1);h=String.format(_WFT("upload","upload_one_file"),Ext.util.Format.ellipsis(Ext.util.Format.htmlEncode(e),50))}else{h=String.format(_WFT("upload","upload_files"),g.length)}if(b&&b!==""){h+="<br>("+b+")"}var f={owner:d.owner,resizable:false,minimizable:false,maximizable:false,closable:true,stateful:false,buttonAlign:"center",width:500,height:(b&&b!=="")?260:225,footer:true,cls:"x-window-dlg",title:_WFT("filetable","filetable_upload"),items:[{xtype:"syno_displayfield",value:h},{xtype:"syno_checkbox",itemId:"option",checked:a,boxLabel:_WFT("filetable","upload_copy_auto_overwrite")}],fbar:new Ext.Toolbar({defaultType:"syno_button",items:[{text:_WFT("filetable","filetable_overwrite"),scope:this,handler:function(){this.onUpload(true)}},{text:_WFT("filetable","filetable_skip"),scope:this,handler:function(){this.onUpload(false)}}],enableOverflow:false}),keys:[{key:[10,13],fn:function(){this.onUpload(true)},scope:this},{key:27,fn:this.close,scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true}}};SYNO.FileStation.DropConfirmDialog.superclass.constructor.call(this,f)},onUpload:function(a){var b=this.getComponent("option").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite",b);this.upload(a);this.close()},upload:function(a){this.callback.fn.apply(this.callback.scope,[this.callback.files,{overwrite:a}])}});Ext.ns("SYNO.FileStation");SYNO.FileStation.TreeDialog=function(b){var d;if(b){d=Ext.copyTo({},b,["createNode"]);delete b.createNode}Ext.apply(this,b||{});var a=this.initTreeArea(d);var c={owner:this.owner,width:480,height:500,shadow:true,minWidth:480,minHeight:300,collapsible:false,resizable:false,autoScroll:false,constrainHeader:true,plain:true,layout:"fit",items:a,buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.saveSelections},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveSelections,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true},beforeshow:{fn:function(){this.initLayout(this.blShowForm)},scope:this}}};this.addEvents({beforesubmit:true,callback:true});SYNO.FileStation.TreeDialog.superclass.constructor.call(this,c)};Ext.extend(SYNO.FileStation.TreeDialog,SYNO.SDS.ModalWindow,{writeStrategyForm:undefined,fdrName:null,blOverWrite:false,fileStr:null,action:null,gUID:null,gGID:null,crtDialog:null,reloadTree:function(){var c=this.dirTree.getRootNode().childNodes||[];for(var a=0;a<c.length;a++){var b=c[a];b.reload()}},initTreeArea:function(d){var e;var c=Ext.apply({timeout:SYNO.webfm.Cfg.timeout,api:"SYNO.FileStation.List",method:"list_share",version:1,baseParams:{sort_by:"name",additional:"real_path,owner,perm,mount_point_type",onlywritable:true,filetype:"dir",status_filter:"valid"},createNode:function(f,g){SYNO.webfm.utils.parseRemoteTreeNode(f,g);return SYNO.API.TreeLoader.prototype.createNode.call(this,f,g)},processResponse:function(j,h,s,t){var u=j.responseText,l;try{var f=j.responseData||Ext.decode(u);if(h.id==="fm_fav_root"){l=["data","favorites"]}else{if(h.id==="fm_root"){l=["data","shares"]}else{l=["data","files"]}}if(!Ext.isArray(l)){l=l.split(",")}for(var r in l){if(l.hasOwnProperty(r)){f=f[l[r]]}}h.beginUpdate();for(var k=0,m=f.length;k<m;k++){var g=this.createNode(f[k],h);if(g){var q=h.appendChild(g);this.doNodeload(q)}}h.endUpdate();this.runCallback(s,t||h,[h])}catch(p){SYNO.Debug("exception: "+p+", response: "+j);this.handleFailure(j)}},doNodeload:function(j){if(j.attributes.children){if(j.childNodes.length<1){var h=j.attributes.children;j.beginUpdate();for(var g=0,f=h.length;g<f;g++){var k=j.appendChild(this.createNode(h[g],j));this.doNodeload(k)}j.endUpdate()}return true}return false},listeners:{scope:this,beforeload:function(g,f){if(this.goto_path){g.baseParams.goto_path=this.goto_path}else{delete g.baseParams.goto_path}this.bltreeloaded=false;(function(){if(!this.bltreeloadedmask&&!this.bltreeloaded){if(this.isDestroyed){return}this.bltreeloadedmask=true;this.setStatusBusy({text:_T("common","loading")})}}).createDelegate(this).defer(1000);SYNO.webfm.utils.getRemoteTreeParams(g,f)},load:function(i,h,f){if(this.isDestroyed){return}this.bltreeloaded=true;if(this.bltreeloadedmask){this.clearStatusBusy()}if(h.id==="fm_fav_root"){var g=h.ui;if(!g){return}if(!h.childNodes||0>=h.childNodes.length){g.hide()}else{g.show()}}else{if(this.goto_path){this.onGoToPathWithDir(this.goto_path);delete this.goto_path}}},loadexception:function(h,g,f){if(this.isDestroyed){return}this.bltreeloaded=true;if(this.bltreeloadedmask){this.clearStatusBusy()}if(g.id==="fm_fav_root"){g.ui.hide()}}}},d);e=new SYNO.API.TreeLoader(c);var b=new SYNO.ux.TreePanel({animate:false,loader:e,containerScroll:true,border:false,useArrows:true,rootVisible:false,height:378,bodyStyle:"padding-right: 12px; padding-left: 0px;",baseCls:"syno-webfm",updateScrollBarEventNames:["afterlayout","append","insert","remove","expandnode","collapsenode","resize"],root:(new Ext.tree.AsyncTreeNode({id:"fm_top_root",allowDrag:false,allowDrop:false,children:[{cls:"root_node",text:_WFT("favorite","my_favorite"),draggable:false,allowDrop:true,expanded:true,id:"fm_fav_root",hidden:true},{cls:"root_node",text:_S("hostname"),draggable:false,expanded:true,allowDrop:false,id:"fm_root",listeners:{expand:{fn:function(f){var g=f.childNodes;if(g&&g.length>0){Ext.each(g,function(h){if(!h.attributes.cls||-1===h.attributes.cls.indexOf("node_display_none")){this.dirTree.getSelectionModel().select(h);return false}},this)}},scope:this}}}]})),tbar:[new SYNO.ux.Button({text:_WFT("common","refresh"),handler:function(){this.reloadTree()},scope:this}),this.btnCreateFolder=new SYNO.ux.Button({text:_WFT("filetable","filetable_create_folder"),tooltip:_WFT("filetable","filetable_create_folder"),handler:this.createFolder,scope:this,disabled:true})],listeners:{beforedestroy:{fn:function(){Ext.destroy(this.dirTree)},scope:this}}});b.mon(b.getSelectionModel(),"beforeselect",function(h,f,g){if(f.id=="fm_root"||f.parentNode.id==="fm_top_root"){return false}this.btnCreateFolder.enable();return true},this);if(this.blDynamicForm){b.mon(b.getSelectionModel(),"selectionchange",function(i,h){if(!h){return}var g=0;if(_S("is_admin")===true){}else{if(h.parentNode.id!="fm_root"){g=SYNO.webfm.utils.getShareFtpRight(this.dirTree,h)}else{g=h.attributes.ftpright}}var f=(g&SYNO.webfm.utils.FTP_PRIV_DISABLE_LIST)||(g&SYNO.webfm.utils.FTP_PRIV_DISABLE_MODIFY);this.enableDisableWriteStrategyForm(f)},this)}this.dirTree=b;if(this.blVFSFolder){this.setVFSRemoteProtocol(e)}var a=new SYNO.ux.FormPanel({border:false,trackResetOnLoad:true,waitMsgTarget:true,items:this.dirTree,layout:"form",baseCls:"syno-webfm",autoFlexcroll:false,useGradient:false,bbarCfg:{cls:"form-pannel-bbar"},bbar:[new Ext.form.Label({height:32,text:_WFT("filetable","filetable_same_file")+":"}),new SYNO.ux.DisplayField({style:"width: 13px",fieldLabel:"",value:"&nbsp;"}),new SYNO.ux.Radio({itemId:"skip",boxLabel:_WFT("filetable","filetable_skip"),name:"writestrategy",inputValue:"skip",checked:true}),new SYNO.ux.DisplayField({style:"width: 13px",fieldLabel:"",value:"&nbsp;"}),new SYNO.ux.Radio({itemId:"overwrite",boxLabel:_WFT("filetable","filetable_overwrite"),name:"writestrategy",inputValue:"overwrite"})],listeners:{actionfailed:{fn:this.closeHandler,scope:this}}});this.writeStrategyForm=a;return a},setVFSRemoteProtocol:function(a){var b=this.getBaseURL({api:"SYNO.FileStation.VFS.Protocol",method:"list",version:1});b=Ext.urlAppend(b,Ext.urlEncode({v:_S("fullversion")}));Ext.Ajax.request({url:b,method:"GET",scope:this,disableCaching:false,callback:function(e,j,d){if(!d||!d.responseText){return}var h=JSON.parse(d.responseText).data;if(j){var f=0,g=h.protocols;for(f=0;f<g.length;f++){var c=g[f];this.dirTree.root.appendChild(this.createVFSRoot(a,c.protocol,c.name))}}}})},createVFSRoot:function(a,d,b){var c=new SYNO.FileStation.MixedTreeLoader({api:"SYNO.FileStation.VirtualFolder",method:"list",version:1,dataroot:["data","folders"],baseParams:{type:d,sort_by:"name",additional:"real_path,owner,time,perm,mount_point_type"},listeners:{scope:this,beforeload:function(g,f){SYNO.webfm.utils.getRemoteTreeParams(g,f,d)},load:function(h,g,f){if(!g.childNodes||0>=g.childNodes.length){g.ui.hide()}else{g.ui.show()}},loadexception:function(h,g,f){if(g.parentNode.id==="fm_top_root"){g.ui.hide()}}},createNode:function(f,g){var h=f.path;f.name=f.name+" ("+h.substring(h.indexOf("://")+3)+")";f.loader=a;SYNO.webfm.utils.parseRemoteTreeNode(f,g);return SYNO.FileStation.MixedTreeLoader.prototype.createNode.call(this,f)}});var e=new Ext.tree.AsyncTreeNode({cls:"root_node",text:b,draggable:false,expanded:true,id:d,allowDrop:false,hidden:true,loader:c});e.expand();return e},onCrtFdrHide:function(){var b=this.crtDialog.getFolderName();var d=this.dirTree.getSelectionModel();var c=d.getSelectedNode();if(!c||!b){return}var a=c.attributes.path;SYNO.API.currentManager.requestAPI("SYNO.FileStation.CreateFolder","create","1",{folder_path:SYNO.API.EscapeStr(a),name:SYNO.API.EscapeStr(b),force_parent:false},function(i,g,f,e){if(i){c.reload(function(k){var j=k.findChild("text",b);if(j){j.select()}});this.webfm.setHighlightEntry(a+"/"+b);this.webfm.refreshTreeNode([a],true)}else{var h=SYNO.webfm.utils.getWebAPIErr(i,g,e);if(this.isDestroyed){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",_WFT("filetable","filetable_create_folder"),h)}else{this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),h)}}},this)},createFolder:function(){var e=this.dirTree.getSelectionModel();var c=e.getSelectedNode(),a;if(!c){return}if(!SYNO.webfm.VFS.isVFSPath(c.attributes.path)&&_S("is_admin")!==true&&_S("domainUser")!=="true"){var b=false;if(c.parentNode.id!="fm_root"){a=SYNO.webfm.utils.getShareRight(this.dirTree,c)}else{a=c.attributes.right;b=true}if(!SYNO.webfm.utils.checkShareRight(a,SYNO.webfm.utils.RW)){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_privilege_not_enough"));return false}if(!b){var d={right:c.attributes.right,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Create};if(!SYNO.webfm.utils.checkFileRight(d)){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_privilege_not_enough"));return false}}}if(!this.crtDialog||this.crtDialog.isDestroyed){this.crtDialog=new SYNO.FileStation.CrtFdrDialog({RELURL:this.RELURL,owner:this})}this.crtDialog.mon(this.crtDialog,"callback",this.onCrtFdrHide,this,{single:true});this.crtDialog.setParentDir(c.attributes.path);this.crtDialog.load()},closeHandler:function(){this.hide();this.fireEvent("callback")},saveSelections:function(){var d="";if(!this.writeStrategyForm||!this.writeStrategyForm.getBottomToolbar()){this.closeHandler();return}var e=this.dirTree.getSelectionModel();var c=e.getSelectedNode();if(c&&c.id){this.fdrName=c.attributes.path}else{this.getMsgBox().alert(this.title,_WFT("filetable","filetable_select_one"));return}if(this.blShowForm){d=this.writeStrategyForm.bottomToolbar.get("skip").getGroupValue();if("overwrite"==d){this.blOverWrite=true}else{this.blOverWrite=false}}var b;var a=0;if(this.hasListener("beforesubmit")){if(_S("is_admin")===true){}else{if(c.parentNode.id!="fm_root"){a=SYNO.webfm.utils.getShareFtpRight(this.dirTree,c)}else{a=c.attributes.ftpright}}if(c.parentNode.id!="fm_root"){b={path:c.attributes.path||"",real_path:c.attributes.real_path,folderRight:c.attributes.right,uid:c.attributes.uid,gid:c.attributes.gid,shareRight:SYNO.webfm.utils.getShareRight(this.dirTree,c),ftpRight:a}}else{b={path:c.attributes.path||"",real_path:c.attributes.real_path,shareRight:c.attributes.right,ftpRight:a}}if(!this.fireEvent("beforesubmit",b)){this.resetDialog();return}}this.closeHandler()},resetDialog:function(){if(this.writeStrategyForm){this.writeStrategyForm.form.reset()}this.blOverWrite=false;this.fdrName=null},getParameters:function(){var a={};a.fdrName=this.fdrName;a.blOverWrite=this.blOverWrite;return a},initLayout:function(a){this.reloadTree();this.dirTree.getSelectionModel().clearSelections();if(!a){this.writeStrategyForm.bbar.hide()}else{this.writeStrategyForm.show()}},load:function(e,d,a,b,c){this.goto_path=c;this.blShowForm=d;this.resetDialog();this.gUID=a;this.gGID=b;this.title=e;this.setTitle(e+" - "+_WFT("filetable","filetable_select_path"));this.show()},enableDisableWriteStrategyForm:function(a){if(a){this.writeStrategyForm.bottomToolbar.get("skip").setValue(true);this.writeStrategyForm.bottomToolbar.get("overwrite").disable();this.writeStrategyForm.bottomToolbar.get("skip").disable()}else{if(this.writeStrategyForm.bottomToolbar.get("overwrite").disabled){this.writeStrategyForm.bottomToolbar.get("overwrite").enable();this.writeStrategyForm.bottomToolbar.get("skip").enable()}}},onFindAvailableNode:function(a){if(!a){return null}var b,c=this.dirTree.getNodeById(SYNO.webfm.utils.source.remote+a);if(!c){b=a.lastIndexOf("/");if(b==-1||b===0){return a}c=this.onFindAvailableNode(a.substr(0,b))}return c},onGoToPathWithDir:function(b){var a=this.onFindAvailableNode(b);if(!a||!Ext.isObject(a)){return}if(a.attributes.path===b){this.dirTree.getSelectionModel().select(a)}else{a.expand(false,false,function(c){this.onGoToPathCallBack(c,b)},this)}},onGoToPathCallBack:function(b,a){this.expandChildNodes(b,a);var c=this.dirTree.getNodeById(SYNO.webfm.utils.source.remote+a);if(c){this.dirTree.getSelectionModel().select(c)}},expandChildNodes:function(e,b){if(e.childNodes.length>0){var d=e.childNodes;for(var c=0,a=d.length;c<a;c++){if(d[c].attributes.children&&SYNO.webfm.utils.isSubNotEqualPath(d[c].attributes.path,b,(SYNO.webfm.utils.isLocalSource(d[c].attributes.type)&&Ext.isWindows)?"\\":"/")){d[c].expand(false);this.expandChildNodes(d[c],b)}}}}});Ext.ns("SYNO.FileStation");SYNO.FileStation.SelTreeDialog=function(a){Ext.apply(this,a||{});var b={bodyStyle:"padding-right: 20px; padding-left: 20px;"};SYNO.FileStation.SelTreeDialog.superclass.constructor.call(this,b)};Ext.extend(SYNO.FileStation.SelTreeDialog,SYNO.FileStation.TreeDialog,{autoScroll:false,initTreeArea:function(){var b=new SYNO.API.TreeLoader({timeout:SYNO.webfm.Cfg.timeout,api:"SYNO.FileStation.List",method:"list_share",version:1,dataroot:["data","shares"],baseParams:{sort_by:"name",additional:"real_path,owner,perm,mount_point_type",filetype:"dir",status_filter:"valid"},baseAttrs:{uiProvider:Ext.tree.TriTreeNodeUI},createNode:function(c,d){SYNO.webfm.utils.parseRemoteTreeNode(c,d);if(SYNO.webfm.utils.isRecycleBinFolder(c.path)||SYNO.webfm.utils.isSnapshotFolder(c.path,true)){c.disabled=true}return SYNO.API.TreeLoader.prototype.createNode.call(this,c,d)},processResponse:function(g,f,p,q){var r=g.responseText,j;try{var c=g.responseData||Ext.decode(r);if(f.id==="fm_fav_root"){j=["data","favorites"]}else{if(f.id==="fm_root"){j=["data","shares"]}else{j=["data","files"]}}if(!Ext.isArray(j)){j=j.split(",")}for(var m in j){if(j.hasOwnProperty(m)){c=c[j[m]]}}f.beginUpdate();for(var h=0,k=c.length;h<k;h++){var d=this.createNode(c[h],f);if(d){f.appendChild(d)}}f.endUpdate();this.runCallback(p,q||f,[f])}catch(l){this.handleFailure(g)}},listeners:{scope:this,beforeload:function(e,d,c){SYNO.webfm.utils.getRemoteTreeParams(e,d);return !(true===d.disabled)},load:function(f,e,c){if(e.id==="fm_fav_root"){var d=e.ui;if(!d){return}if(!e.childNodes||0>=e.childNodes.length){d.hide()}else{d.show()}}},loadexception:function(e,d,c){if(d.id==="fm_fav_root"){d.ui.hide()}}}});var a=new SYNO.ux.TreePanel({animate:false,loader:b,containerScroll:true,enableDD:false,border:false,useArrows:true,rootVisible:false,cls:"webfm-selfolder-tree",bodyStyle:"padding-left:0px; padding-right: 12px;",root:(new Ext.tree.AsyncTreeNode({id:"fm_top_root",allowDrag:false,allowDrop:false,children:[{cls:"root_node",text:_WFT("favorite","my_favorite"),draggable:false,allowDrop:true,expanded:true,id:"fm_fav_root",hidden:true},{cls:"root_node",text:_WFT("search","all_shares"),draggable:false,expanded:true,allowDrop:false,id:"fm_root",checked:true,uiProvider:Ext.tree.TriTreeNodeUI,listeners:{expand:{fn:function(d){var e=d.childNodes;if(e&&e.length>0){if(this.btnCreateFolder&&this.btnCreateFolder.enable){this.btnCreateFolder.enable()}var c=this.dirTree.getNodeById(SYNO.webfm.utils.source.remote+e[0].attributes.path);if(c){this.dirTree.getSelectionModel().select(c)}}},scope:this}}}]})),tbar:[new SYNO.ux.Button({text:_WFT("common","refresh"),handler:this.initLayout,scope:this})],listeners:{beforedestroy:{fn:function(){Ext.destroy(this.dirTree)},scope:this}},getChecked:function(c,e,d){e=e||this.root;var g=d||[];var f=e.firstChild;while(f){switch(f.getUI().getCheckIndex(f)){case Ext.tree.TriTreeNodeUI.GRAYSTATE:if(f.firstChild){this.getChecked(c,f,g)}else{this.getMsgBox().alert(this.title,_WFT("common","error_system"))}break;case Ext.tree.TriTreeNodeUI.CHECKSTATE:g.push(!c?f:(c=="id"?f.id:f.attributes[c]));break;default:break}f=f.nextSibling}return g}});this.dirTree=a;return a},closeHandler:function(){this.hide()},saveSelections:function(){var a=[];var d=this.dirTree.getRootNode().childNodes||[];for(var b=0;b<d.length;b++){var c=d[b];this.dirTree.getChecked(undefined,c,a)}if(!a||a.length===0){this.getMsgBox().alert(this.title,_WFT("filetable","filetable_select_one"));return}if(this.hasListener("beforesubmit")){if(!this.fireEvent("beforesubmit",this.dirTree,a)){return}}this.fireEvent("callback",this.dirTree,a);this.closeHandler()},initLayout:function(){this.reloadTree();var c=this.dirTree.getRootNode().childNodes||[];for(var a=0;a<c.length;a++){var b=c[a];b.getUI().clearCheck()}},load:function(a){this.title=a;this.setTitle(a+" - "+_WFT("filetable","filetable_select_path"));this.show()}});Ext.ns("SYNO.FileStation");Ext.define("SYNO.FileStation.DateField",{extend:"SYNO.ux.DateField",constructor:function(a){this.callParent([a]);this.addEvents("menuShow","menuHide")},onTriggerClick:function(a){this.callParent(arguments);this.fireEvent("menuShow")},onMenuHide:function(){this.callParent(arguments);this.fireEvent("menuHide")}});Ext.reg("syno_file_datefield",SYNO.FileStation.DateField);SYNO.FileStation.SearchFormPanel=Ext.extend(SYNO.ux.FormPanel,{defLocRec:null,selPath:"",oldSelPath:"",selTree:null,dbidArr:[],constructor:function(a){Ext.apply(this,a||{});this.ownerCGI=this.RELURL+"webUI/file_property.cgi";var b=this.fillConfig();SYNO.FileStation.SearchFormPanel.superclass.constructor.call(this,b);this.defineBehaviors();this.defaultAnimation=["888888",1,{duration:0.35}]},fillConfig:function(){var g=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","display"],data:[["any",_WFT("search","search_any")],["dir",_WFT("search","folder")],["fileonly",_WFT("search","file")],["documents",_T("report","reportUI_file_type_document")],["videos",_T("report","reportUI_file_type_video")],["pictures",_T("report","reportUI_file_type_image")],["Audio",_T("report","reportUI_file_type_audio")],["webpages",_T("report","reportUI_file_type_web")],["executablefiles",_T("report","reportUI_file_type_exe")],["diskimagefiles",_T("report","reportUI_file_type_iso")],["zippedfiles",_T("report","reportUI_file_type_zip")],["file",_WFT("search","extension")]]});var b=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","display"],data:[["any",_WFT("search","search_any")],["equal",_WFT("search","size_equal")],["greater",_WFT("search","size_greater")],["less",_WFT("search","size_less")]]});var f=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","display"],data:[["mtime",_WFT("filetable","filetable_mtime")],["crtime",_WFT("filetable","filetable_ctime")],["atime",_WFT("filetable","filetable_atime")]]});var e=[["any",_WFT("search","search_any")],["owner",_WFT("filetable","filetable_owner")]];if(!_S("diskless")){e.push(["group",_WFT("filetable","filetable_group")])}var a=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","display"],data:e});this.groupStore=this.getGroupStore();this.userStore=this.getUserStore();this.shareStore=this.getShareStore();this.localShareStore=this.getLocalShareStore();this.addManagedComponent(this.groupStore);this.addManagedComponent(this.userStore);this.addManagedComponent(this.localShareStore);var d=this;var c={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:[{xtype:"syno_displayfield",value:_WFT("search","keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""},{xtype:"syno_displayfield",value:_WFT("property","file_location")+_T("common","colon"),flex:1},{xtype:"syno_combobox",name:"location",mode:"local",editable:false,store:this.localShareStore,displayField:"text",valueField:"path",triggerAction:"all",lazyRender:true,flex:2,listeners:{scope:this,expand:function(k){var i=k.getStore();var j=i.getCount();if(j<2){return}var h=this.isSearchableSource();if(!this.blcurdirnode&&h){i.insert(j-1,new Ext.data.Record({type:"curlocation",path:"curlocation",text:_WFT("search","recursive_folder")}));i.insert(j-1,new Ext.data.Record({type:"justcurlocation",path:"curlocation",text:_WFT("search","curfolder")}));this.blcurdirnode=true}else{if(this.blcurdirnode&&!h&&j>3){i.removeAt(j-2);i.removeAt(j-3);this.blcurdirnode=false}}this.inEl=true},beforeselect:{fn:this.showSelTreePanel,scope:this},collapse:{fn:function(){this.inEl=false},scope:this},select:{fn:function(i,l,h){if(l.get("type")==="location_selection"){i.setValue(this.oldSelPath)}else{if(l.get("type")==="curlocation"){if(this.isSearchableSource()){this.setLocation(this.webfm.getCurrentDir()+"("+_WFT("search","recursive_folder")+")",this.webfm.getCurrentDir())}}else{if(l.get("type")==="justcurlocation"){if(this.isSearchableSource()){this.setLocation(this.webfm.getCurrentDir())}}else{if(l.get("type")==="location_all"){var k="",j=[];this.shareStore.each(function(n,m){if(n.get("type")){return}if(m>0){k+=", "}k+=n.get("path").substr(1);j.push(n.get("path"))});this.setLocation(k,j)}}}}},scope:this}}},{xtype:"syno_displayfield",value:_WFT("filetable","filetable_title_file_type")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[{xtype:"syno_combobox",name:"extopt",mode:"local",editable:false,store:g,displayField:"display",valueField:"value",triggerAction:"all",lazyRender:true,value:"any",listeners:{expand:{fn:function(){this.inEl=true},scope:this},collapse:{fn:function(){this.inEl=false},scope:this},select:{fn:function(l,i,h){var k=i.get("value"),j=this.form.findField("exttext");if(k==="file"){this.frameAnimation(j.el,this.defaultAnimation);j.enable()}else{j.reset();j.disable()}},scope:this}}},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"exttext",maxlength:253,disabled:true,validator:function(i){var h=d.form.findField("extopt").getValue();if(i.length<1&&h==="file"){return _JSLIBSTR("extlang","fieldblank")}return true}}]},{xtype:"syno_displayfield",value:_T("time","time_date")+_T("common","colon")},{xtype:"syno_combobox",name:"datetype",triggerAction:"all",editable:false,mode:"local",store:f,displayField:"display",valueField:"value",lazyRender:true,value:"mtime",listeners:{expand:{fn:function(){this.inEl=true},scope:this},collapse:{fn:function(){this.inEl=false},scope:this}}},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[{xtype:"syno_file_datefield",name:"searchdatefrom",editable:false,format:"m/d/Y",emptyText:_T("log","date_from"),value:"",listeners:{select:{fn:function(i,h){this.form.findField("searchdateto").setMinValue(h)},scope:this},menuShow:{fn:function(){this.inEl=true},scope:this},menuHide:{fn:function(){this.inEl=false},scope:this}}},{xtype:"syno_file_datefield",name:"searchdateto",editable:false,format:"m/d/Y",emptyText:_T("log","date_to"),value:"",listeners:{select:{fn:function(i,h){this.form.findField("searchdatefrom").setMaxValue(h)},scope:this},menuShow:{fn:function(){this.inEl=true},scope:this},menuHide:{fn:function(){this.inEl=false},scope:this}}}]},{xtype:"syno_displayfield",value:_WFT("common","common_filesize")+" (MB)"+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[{xtype:"syno_combobox",name:"filesizeopt",editable:false,mode:"local",store:b,displayField:"display",valueField:"value",triggerAction:"all",lazyRender:true,value:"any",listeners:{select:{fn:function(j,i,h){this.enalbeDisableItem(i.get("value"),this.form.findField("filesize"))},scope:this},expand:{fn:function(){this.inEl=true},scope:this},collapse:{fn:function(){this.inEl=false},scope:this}}},{xtype:"syno_numberfield",name:"filesize",minValue:0,disabled:true,validator:function(h){if(h.length<1&&d.isFieldDirty("filesizeopt")){return _JSLIBSTR("extlang","fieldblank")}return true}}]},{xtype:"syno_displayfield",value:(_S("diskless")?_WFT("filetable","filetable_owner"):_WFT("filetable","filetable_owner_group"))+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[{xtype:"syno_combobox",name:"ownerpot",triggerAction:"all",mode:"local",editable:false,store:a,displayField:"display",valueField:"value",lazyRender:true,value:"any",listeners:{select:{fn:function(l,i,h){var k=i.get("value");var j=this.form.findField("ownertext");if(this.enalbeDisableItem(k,this.form.findField("ownertext"))){if(k==="owner"&&this.userStore!==j.getStore()){j.bindStore(this.userStore,false)}else{if(k==="group"&&this.groupStore!==j.getStore()){j.bindStore(this.groupStore,false)}}}j.reset()},scope:this},expand:{fn:function(){this.inEl=true},scope:this},collapse:{fn:function(){this.inEl=false},scope:this}}},{xtype:"syno_combobox",triggerAction:"all",name:"ownertext",editable:true,displayField:"name",valueField:"name",lazyRender:true,store:this.userStore,mode:"remote",resizable:true,pageSize:50,minListWidth:200,listEmptyText:_WFT("error","error_invalid_user_group"),grow:true,listWidth:360,maxHeight:360,minChars:1,typeAhead:true,initList:function(){if(!this.list){this.constructor.prototype.initList.call(this);this.pageTb.first.hide();this.pageTb.last.hide();this.pageTb.refresh.hide()}},disabled:true,validator:function(h){if(h.length<1&&d.isFieldDirty("ownerpot")){return _JSLIBSTR("extlang","fieldblank")}return true},listeners:{expand:{fn:function(){this.inEl=true},scope:this},collapse:{fn:function(){this.inEl=false},scope:this}}}]},{xtype:"toolbar",border:false,itemId:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"fstbtext",itemId:"search-loading",text:""},{xtype:"fstbtext",itemId:"msg",height:26,style:"-webkit-text-size-adjust:none;font-size:11px;color:red;height:26px;overflow:hidden;",text:""},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_WFT("filetable","filetable_search"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_WFT("search","stop"),itemId:"btn_stop",hidden:true,handler:this.onStop,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]}],listeners:{actionfailed:{fn:function(){this.setMsg("");this.form.reset()},scope:this},beforeshow:{fn:function(){var h=this.getComponent("btns").getComponent("btn_search");if(this.webfm.fileFilter.disableAdvancedSearch){h.disable()}else{h.enable()}this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}else{if(!this.btnStop.hidden&&!this.btnStop.disabled){this.onStop()}}},scope:this}]};return c},showSearchIcon:function(){var b=this.get("btns"),a=b.get("search-loading");a.getEl().addClass("search-loading")},hideSearchIcon:function(){var b=this.get("btns"),a=b.get("search-loading");a.getEl().removeClass("search-loading")},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)&&!Ext.isEmpty(a)&&Ext.isEmpty(b.getValue())){b.setValue(a)}b.focus("",1)},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){this.initSearchDS();this.onListenTreeNodeClick();var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setMsg:function(c){var a=this.get("btns");var b=a.get("msg");b.setText(c);if(c.trim()!==""){this.frameAnimation(b.el,this.defaultAnimation)}},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.setMsg("");this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null);this.form.findField("exttext").disable();this.form.findField("filesize").disable();this.form.findField("ownertext").disable();if(this.isSearchableSource()){this.setLocation(this.webfm.getCurrentDir()+"("+_WFT("search","recursive_folder")+")",this.webfm.getCurrentDir())}else{if(this.shareStore.getCount()>0){this.setLocation(this.shareStore.getAt(0).get("path")+"("+_WFT("search","recursive_folder")+")",this.shareStore.getAt(0).get("path"))}}this.onListenTreeNodeClick()},onListenTreeNodeClick:function(){if(!this.listenNode){this.mon(this.webfm,"onNodeClick",this.onTreeNodeClick,this);this.listenNode=true}},unListenTreeNodeClick:function(){if(true===this.listenNode){this.mun(this.webfm,"onNodeClick",this.onTreeNodeClick,this);this.listenNode=false}},onTreeNodeClick:function(a){this.webfm.fileFilter.enable();if(this.webfm.getCurrentSource().substr(0,5)===SYNO.webfm.utils.source.local||SYNO.webfm.VFS.isVFSPath(this.webfm.getCurrentDir())){return}if(a.id==="fm_search_root"||a.attributes.disabledsearch===true){return}this.setLocation(a.attributes.path+"("+_WFT("search","recursive_folder")+")",a.attributes.path)},onLoadShareDone:function(a,c,b){this.blcurdirnode=false;this.localShareStore.removeAll();if(c.length<1){return}this.localShareStore.add(new Ext.data.Record({type:"location_all",path:"location_all",text:_WFT("search","location_all")}));this.localShareStore.add(new Ext.data.Record({type:"location_selection",path:"location_selection",text:_T("common","customize")}));if(this.isSearchableSource()){this.setLocation(this.webfm.getCurrentDir()+"("+_WFT("search","recursive_folder")+")",this.webfm.getCurrentDir())}else{this.setLocation(c[0].get("path")+"("+_WFT("search","recursive_folder")+")",c[0].get("path"))}},exceptionLoadShare:function(a){if(!a){this.owner.getMsgBox().alert(_WFT("filetable","filetable_search"),_WFT("error","error_system_busy"))}else{if(a.errno){this.owner.getMsgBox().alert(_WFT("filetable","filetable_search"),_WFT("error","error_system_busy"))}}},enalbeDisableItem:function(b,a){if(b!=="any"){this.frameAnimation(a.el,this.defaultAnimation);a.enable();return 1}else{a.reset();a.disable();return 0}},getUserStore:function(){return new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.ownerCGI,method:"GET"}),reader:new Ext.data.JsonReader({root:"items",totalProperty:"total",id:"name"},[{name:"name",mapping:"name"}]),remoteSort:true,baseParams:{action:"owner_enum"},pruneModifiedRecords:true,listeners:{beforeload:function(a,b){var c=b.params,d=a.paramNames;return Ext.isNumber(c[d.limit])}}})},getGroupStore:function(){return new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.ownerCGI,method:"GET"}),reader:new Ext.data.JsonReader({root:"items",totalProperty:"total",id:"name"},[{name:"name",mapping:"name"}]),remoteSort:false,baseParams:{action:"group_enum"},pruneModifiedRecords:true,listeners:{beforeload:function(a,b){var c=b.params,d=a.paramNames;return Ext.isNumber(c[d.limit])}}})},onCheckPrivilege:function(a,b){if(_S("is_admin")===true||_S("domainUser")=="true"){return true}var c=true;Ext.each(b,function(f){var d=(f.parentNode.id!="fm_root")?SYNO.webfm.utils.getShareRight(a,f):f.attributes.right;if(!SYNO.webfm.utils.checkShareRight(d,SYNO.webfm.utils.RW|SYNO.webfm.utils.RO)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_search"),_WFT("error","error_privilege_not_enough"));c=false;return true}var e=0;if(_S("is_admin")===true){}else{if(f.parentNode.id!="fm_root"){e=SYNO.webfm.utils.getShareFtpRight(a,f)}else{e=f.attributes.ftpright}}c=(e&SYNO.webfm.utils.FTP_PRIV_DISABLE_LIST);if(c){this.owner.getMsgBox().alert(_WFT("filetable","filetable_search"),_WFT("error","error_privilege_not_enough"));c=false;return true}},this);return c},showSelTreePanel:function(c,e,a){if(e.get("type")==="location_selection"){this.oldSelPath=c.getValue();if(!this.selTree||this.selTree.isDestroyed){this.selTree=new SYNO.FileStation.SelTreeDialog({RELURL:this.RELURL,owner:this.owner});this.selTree.mon(this.selTree,"beforesubmit",this.onCheckPrivilege,this);this.selTree.mon(this.selTree,"callback",this.onSelPanelHide,this)}var b=this.selTree;var d=_WFT("filetable","filetable_search");b.load(d);this.getEl().setStyle("z-index",b.getEl().getStyle("z-index")-1)}},onSelPanelHide:function(a,b){var d="",c=[];Ext.each(b,function(f,e){if(-1!=c.indexOf(f.attributes.path)){return}if(e>0){d+=", "}d+=f.attributes.path.substr(1);c.push(f.attributes.path)},this);this.setLocation(d+"("+_WFT("search","recursive_folder")+")",c)},getShareStore:function(){return new Ext.data.Store({autoDestroy:true,autoLoad:true,proxy:new SYNO.API.Proxy({timeout:SYNO.webfm.Cfg.timeout,api:"SYNO.FileStation.List",method:"list_share",version:1,listeners:{scope:this,beforeload:function(a,b){var c=a.activeRequest.read;if(c){Ext.Ajax.abort(c)}}}}),remoteSort:true,paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},sortInfo:{field:"name",direction:"ASC"},baseParams:{sort_by:"name"},reader:new Ext.data.JsonReader({root:"shares",id:"path"},[{name:"path"},{name:"type"},{name:"text",mapping:"name",convert:function(b,a){return Ext.util.Format.htmlEncode(b)}}]),listeners:{load:{fn:this.onLoadShareDone,scope:this},exception:{fn:this.exceptionLoadShare,scope:this}}})},getLocalShareStore:function(){return new Ext.data.JsonStore({autoDestroy:true,fields:["path","type","text"],listeners:{exception:{fn:this.exceptionLoadShare,scope:this}}})},isSubUnSearchableDir:function(c){var a=["#recycle","#snapshot"];var b=false;if(Ext.isEmpty(c)||Ext.isArray(c)||!c.match){return false}Ext.iterate(a,function(f,d){var g=new RegExp("/"+f+"$");var e=new RegExp("/"+f+"/");b=!Ext.isEmpty(c.match(g))||!Ext.isEmpty(c.match(e));return !b});return b},setLocation:function(c,f){var a=this.form.findField("location");var e=this.getComponent("btns").getComponent("btn_search");if(this.webfm.fileFilter.disableAdvancedSearch){e.disable();return}if(!this.isSubUnSearchableDir(f)&&!a.disabled&&!Ext.isEmpty(c)){var b=("/"===c.substr(0,1))?1:0;a.setValue(c.substr(b));f=f||c;if(!Ext.isArray(f)){f=[f]}for(var d in f){if(f.hasOwnProperty(d)){f[d]=SYNO.API.EscapeStr(f[d])}}this.selPath=f.join(",")}},onSearch:function(c,j){if(!this.validateForm()){this.setMsg(_WFT("search","least_one"));return}var h=this.form.findField("location");var d=h.findRecord(h.valueField,h.getValue());var f={folder_path:(d)?h.getValue():this.selPath};d=h.getStore().getAt(h.selectedIndex);Ext.apply(f,{recursive:!(d&&(d.get("type")==="justcurlocation"))});var i;if(this.isFieldDirty("keyword")){i=this.form.findField("keyword").getValue()||"";if(!Ext.isEmpty(i)){var l=new RegExp("\\\\","g");i=i.replace(l,"\\\\");Ext.apply(f,{pattern:i})}}var k="",b;if(this.isFieldDirty("extopt")){b=this.form.findField("extopt").getValue();if(!Ext.isEmpty(b)){switch(b){case"fileonly":Ext.apply(f,{filetype:"file"});break;case"dir":Ext.apply(f,{filetype:"dir"});break;case"documents":k=SYNO.webfm.utils.DocumentFileTypes;break;case"videos":k=SYNO.webfm.utils.VideoFileTypes;break;case"pictures":k=SYNO.webfm.utils.ImageFileTypes;break;case"Audio":k=SYNO.webfm.utils.AudioFileTypes;break;case"webpages":k=SYNO.webfm.utils.WebPageFileTypes;break;case"executablefiles":k="*.exe";break;case"diskimagefiles":k=SYNO.webfm.utils.DiscFileTypes;break;case"zippedfiles":k=SYNO.webfm.utils.ZippedFileTypes;break;case"file":if(this.isFieldDirty("exttext")){k=this.form.findField("exttext").getValue()}break}}}if(!Ext.isEmpty(k)){Ext.apply(f,{extension:k})}if(this.isFieldDirty("filesizeopt")&&this.isFieldDirty("filesize")){b=this.form.findField("filesizeopt").getValue();if(!Ext.isEmpty(b)){var m=this.form.findField("filesize").getValue()*1048576;switch(b){case"equal":var g=(m>>2)/5;g=(g>0)?g:1;Ext.apply(f,{size_from:Math.floor((m>g)?(m-g):0)});Ext.apply(f,{size_to:Math.ceil(m+g)});break;case"greater":Ext.apply(f,{size_from:m});break;case"less":Ext.apply(f,{size_to:m});break}}}if(this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")){var a=this.form.findField("datetype").getValue();if(this.form.findField("searchdatefrom").value){f[a+"_from"]=(new Date(this.form.findField("searchdatefrom").value).valueOf()/1000)}if(this.form.findField("searchdateto").value){f[a+"_to"]=(new Date(this.form.findField("searchdateto").value).valueOf()/1000)+60*60*24}}if(this.isFieldDirty("ownerpot")&&this.isFieldDirty("ownertext")){b=this.form.findField("ownerpot").getValue();if(!Ext.isEmpty(b)){switch(b){case"owner":Ext.apply(f,{owner:this.form.findField("ownertext").getValue()});break;case"group":Ext.apply(f,{group:this.form.findField("ownertext").getValue()});break}}}this.setMsg("");this.onSendSearch(f)},onStop:function(a,b){this.owner.removeTask("sendsearch");var c=this.searchtaskid;if(c){this.owner.removeTask(c);this.owner.addWebAPITask({api:"SYNO.FileStation.Search",method:"stop",version:1,params:{taskid:c},callback:this.onStopDone,scope:this,single:true}).start(true)}this.onStopStatus();this.getSearchGrid().getStore().reload()},onStopDone:function(a,c,b){if(!a){var d=SYNO.webfm.utils.getWebAPIErr(a,c,b);this.showMsg(_WFT("filetable","filetable_search"),d)}},isFieldDirty:function(a){return this.form.findField(a).isDirty()},validateForm:function(){if(!this.form.isValid()){return false}return this.isFieldDirty("ownertext")||this.isFieldDirty("filesize")||this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")||this.isFieldDirty("extopt")||this.isFieldDirty("exttext")||this.isFieldDirty("keyword")},onCleanSearch:function(a){if(this.dbidArr.length>0){var b=[];for(var c=0;c<this.dbidArr.length;c++){b.push(this.dbidArr[c].id)}SYNO.API.currentManager.requestAjaxAPI("SYNO.FileStation.Search","clean",1,{async:a,timeout:a?30:10},{taskid:b.join(",")});this.dbidArr=[]}},onSendSearch:function(a){this.onCleanSearch(true);this.owner.addWebAPITask({id:"sendsearch",api:"SYNO.FileStation.Search",method:"start",version:1,params:a,callback:this.onSendSearchDone,scope:this,single:true}).start(true);this.onBeginStatus();this.getSearchStore().params=a},onSendSearchDone:function(d,b,a){if(!d){var c=SYNO.webfm.utils.getWebAPIErr(d,b,a);this.showMsg(_WFT("filetable","filetable_search"),c);this.onFailStatus()}else{if(b.taskid){this.searchtaskid=b.taskid;this.dsStart=this.webfm.paging.cursor;this.updateRecords(true);if(b.taskid!=this.dbidArr[this.dbidArr.length-1]){this.dbidArr.push({id:b.taskid})}}else{this.onUpdateError(b,a);this.onFailStatus()}}this.onBeginSearchingStatus()},getUpdateRecordParams:function(){var b={additional:"real_path,size,owner,time,perm,type",taskid:this.searchtaskid,offset:this.dsStart,limit:this.webfm.paging.pageSize,filetype:this.webfm.showContent};var a=this.webfm.fileFilter.getValue();if(a){b.pattern=a}return b},onBeforeStartUpdateRecords:function(a){if(this.updateTask===a){a.reqConfig.params=this.getUpdateRecordParams()}},updateRecords:function(a){if(this.updateTask&&this.updateTask.running===true){this.updateTask.stop()}if(!this.searchtaskid){return}if(!this.updateTask||this.updateTask.removed){this.updateTask=this.owner.addWebAPITask({id:this.searchtaskid,interval:3000,api:"SYNO.FileStation.Search",method:"list",version:1,params:this.getUpdateRecordParams(),callback:function(e,c,d){if(e&&c.finished===true){this.updateTask.stop()}if(!e){this.updateTask.stop();this.onUpdateError(c,d);this.onFailStatus()}else{this.onSearchDone(e,c,d)}},scope:this});var b=this.owner.getTaskRunner();this.mon(b,"beforestart",this.onBeforeStartUpdateRecords,this)}this.updateTask.start(a||false)},onSearchDone:function(d,b,c){var a=this.webfm.fileFilter.getValue();if(c.filetype!==this.webfm.showContent||(a&&c.pattern!==a)||(c.pattern&&c.pattern!==a)){this.updateRecords(true);return}if(b.files){this.onSearchUpdated(b)}if(b.finished){this.onFinishStatus();this.webfm.setDragToDesktop.call(this.webfm);if(!b.files||b.files.length<1){if(this.checkSearchPage()){this.maskView(_WFT("search","no_search_result"))}}}this.getSearchStore().search_taskid=this.searchtaskid},onUpdateError:function(a,c){this.getSearchStore().removeAll();var b=SYNO.webfm.utils.getWebAPIErr(false,a,c);this.maskView(b)},onSearchUpdated:function(e){var i=this.getSearchGrid().getStore();var b=this.webfm.paging;var c=false;var h=e.files;if(e.total!=i.getTotalCount()){c=true}else{for(var d=0;d<h.length;d++){var g=i.getById(h[d].file_id);var f=i.getAt(d);if(!g||!f||h[d].file_id!=f.get("file_id")){c=true;break}}}var a=this.checkSearchPage();if(a){if(this.isViewMasked()){this.unmaskView()}if(0===h.length){this.maskView(_WFT("common","searching"),"x-mask-loading")}}if(a&&c){b.unbind(i);i.loadData(e,false);b.bind(i);b.onLoad(i,h,{params:{offset:this.dsStart}})}},checkSearchPage:function(){return(this.webfm.activeDS.storetype===SYNO.webfm.utils.source.remotes)},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().alert(b,a)}},hideMsg:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},getSearchStore:function(){return this.webfm.remoteSearchDS},getSearchGrid:function(){return this.webfm.grid},maskView:function(b,a){return this.webfm.maskView(b,a)},unmaskView:function(){return this.webfm.unmaskView()},isViewMasked:function(){return this.webfm.isViewMasked()},initSearchDS:function(c){var b=this.webfm;var a=new Ext.data.Store({blSearhDone:true,storetype:SYNO.webfm.utils.source.remotes,proxy:new SYNO.API.Proxy({timeout:SYNO.webfm.Cfg.timeout,api:"SYNO.FileStation.Search",method:"list",version:1,listeners:{scope:this,beforeload:function(d,e){var f=d.activeRequest.read;if(f){Ext.Ajax.abort(f)}}}}),reader:new Ext.data.JsonReader({root:"files",id:"path"},b.remoteDS.reader.recordType),remoteSort:true,pruneModifiedRecords:true,paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},sortInfo:{field:"name",direction:"ASC"},baseParams:{sort_by:"name",additional:"real_path,size,owner,time,perm,type,mount_point_type"},listeners:{scope:this,beforeload:function(d,e){var h=e.params;var g=d.fields.get(d.sortInfo.field);var f=g?(g.mapping||g.name):"name";f=f.split(".",3);h.sort_by=f[2]||f[1]||f[0];return this.checkSearchParams(h)},load:function(d,f,e){if(this.checkSearchPage()){this.unmaskView()}var h=this.getSearchGrid().getStore();if(h.getTotalCount()<=this.dsStart&&this.dsStart>0){var g=Math.ceil((d.getTotalCount()-this.webfm.displayNum)/this.webfm.displayNum);h.load({params:{offset:(g*this.webfm.displayNum),limit:this.webfm.displayNum}});return}},exception:function(f,g,h,e,i,d){this.onUpdateError(i,e.params)}}});b.remoteSearchDS=a},checkSearchParams:function(b){if(!this.searchtaskid){return false}b.taskid=this.searchtaskid;b.limit=this.webfm.paging.pageSize;if(this.getSearchStore().blSearhDone){var a=this.webfm.fileFilter.getValue();if(a){b[this.webfm.fileFilter.queryParam]=a}else{delete b[this.webfm.fileFilter.queryParam]}if(this.getSearchStore().blSearchSorted!==true){delete b.sort_by}}return true},onShowHideBtn:function(a){if(a){this.btnSearch.hide();this.btnStop.show()}else{this.btnSearch.show();this.btnStop.hide()}},onEnableDisableBtn:function(a){if(a){this.btnSearch.enable();this.btnStop.enable()}else{this.btnSearch.disable();this.btnStop.disable()}},onGridSortable:function(a){this.webfm.setSortColumnModel(a)},onBeginStatus:function(){this.onEnableDisableBtn(false);this.onShowHideBtn(true);this.getSearchStore().blSearhDone=false;this.webfm.dirTree.selectSearchNode();this.getSearchStore().blSearchSorted=false;this.getSearchStore().removeAll();if(this.checkSearchPage()){this.maskView(_WFT("common","searching"),"x-mask-loading");this.onGridSortable(false);this.webfm.enableDisableFilterBtn(false)}this.webfm.paging.onLoad(this.getSearchStore(),null,{});this.webfm.onChangeDisplayTypeMenu("all");this.webfm.showContent="all";this.searchtaskid=null;this.showSearchIcon();this.webfm.showLoading();this.unListenTreeNodeClick()},onBeginSearchingStatus:function(){this.onEnableDisableBtn(true)},onFailStatus:function(){this.onEnableDisableBtn(true);this.onShowHideBtn(false);this.getSearchStore().removeAll();if(this.checkSearchPage()){this.onGridSortable(true)}this.onFinalStatus()},onFinishStatus:function(){this.onShowHideBtn(false);if(this.checkSearchPage()){this.onGridSortable(true)}this.onFinalStatus()},onStopStatus:function(){this.onEnableDisableBtn(true);this.onShowHideBtn(false);if(this.checkSearchPage()){this.unmaskView();this.onGridSortable(true)}this.onFinalStatus()},onFinalStatus:function(){this.webfm.enableDisableFilterBtn(true);this.getSearchStore().blSearhDone=true;this.hideSearchIcon();this.webfm.hideLoading()},isSearchableSource:function(){var a=this.isSubUnSearchableDir(this.webfm.getCurrentDir());return !a&&(SYNO.webfm.utils.isRemoteSource(this.webfm.getCurrentSource()))&&!SYNO.webfm.VFS.isVFSPath(this.webfm.getCurrentDir())}});Ext.ns("SYNO.FileStation");SYNO.FileStation.CompressDialog=function(b){Ext.apply(this,b||{});var a=this.initArchiveOption();var c={owner:this.owner,width:580,height:450,shadow:true,minWidth:500,minHeight:300,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,monitorResize:true,title:_WFT("filetable","filetable_add_archive"),layout:"fit",items:a,buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.onCompress},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.onCompress,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true},beforeshow:{fn:function(){if(this.archiveOptionForm){var d=this.archiveOptionForm.form.findField("compressformat").getValue();if("zip"===d){this.setCodepageValue()}}},scope:this}}};this.addEvents({callback:true});SYNO.FileStation.CompressDialog.superclass.constructor.call(this,c)};Ext.extend(SYNO.FileStation.CompressDialog,SYNO.SDS.ModalWindow,{archiveOptionForm:undefined,codepage:undefined,initArchiveOption:function(){var a=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","mode"],data:[["zip","Zip"],["7z","7z"]]});var f=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","level"],data:[["store",_WFT("filetable","filetable_compression_level_store")],["fastest",_WFT("filetable","filetable_compression_level_fastest")],["normal",_WFT("filetable","filetable_compression_level_normal")],["best",_WFT("filetable","filetable_compression_level_best")]]});var c=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","mode"],data:[["replace",_WFT("filetable","filetable_replace_file")],["update",_WFT("filetable","filetable_update_file")],["freshen",_WFT("filetable","filetable_freshen_file")],["synchroize",_WFT("filetable","filetable_synchroize_file")]]});var e=new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.webfm.utils.getSupportedLanguage()});var b={labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,labelWidth:180,border:false,items:[{xtype:"syno_fieldset",title:_WFT("filetable","filetable_archive_option"),synodefaults:{width:200},items:[{xtype:"syno_textfield",fieldLabel:_WFT("filetable","filetable_archive_name"),name:"archivename",allowBlank:false,width:200,blankText:_WFT("compress","compress_error_empty_name"),validateOnBlur:true,scope:this,validator:function(g){if(!SYNO.webfm.utils.checkFileLen(g)){return _WFT("compress","compress_error_long_name")}if(SYNO.webfm.utils.isNameCharIllegal(g)){return _WFT("error","error_reserved_name")}return true},maxlength:255},{xtype:"syno_combobox",fieldLabel:_WFT("filetable","filetable_compression_level"),name:"compresslevel",store:f,valueField:"value",displayField:"level",triggerAction:"all",value:"normal",editable:false,mode:"local"},{xtype:"syno_combobox",fieldLabel:_WFT("filetable","filetable_compression_format"),name:"compressformat",store:a,valueField:"value",displayField:"mode",triggerAction:"all",value:"zip",editable:false,mode:"local",listeners:{select:function(j,k,h,i){var g=this.archiveOptionForm.form.findField("codepage");if(0===h){g.show()}else{g.hide()}},scope:this}},{xtype:"syno_combobox",fieldLabel:_WFT("filetable","filetable_update_mode"),name:"compressmode",store:c,valueField:"value",displayField:"mode",triggerAction:"all",value:"replace",editable:false,mode:"local"},{xtype:"syno_combobox",fieldLabel:_WFT("common","lang_codepage"),name:"codepage",store:e,valueField:"value",displayField:"display",triggerAction:"all",editable:false,mode:"local"}]},{xtype:"syno_fieldset",title:_WFT("filetable","filetable_encryption"),synodefaults:{width:200},items:[{xtype:"syno_textfield",fieldLabel:_WFT("filetable","filetable_enter_pw"),name:"enterpw",textType:"password",readOnly:false,width:229,maxlength:128},{xtype:"syno_textfield",fieldLabel:_WFT("filetable","filetable_reenter_pw"),name:"reenterpw",textType:"password",readOnly:false,width:229,scope:this,validateOnBlur:true,validator:function(h){var g=this.scope.archiveOptionForm.form.findField("enterpw").getValue();if(g!=h){return _WFT("error","error_repswd")}return true},maxlength:128}]}],listeners:{actionfailed:{fn:this.closeHandler,scope:this},afterrender:{fn:this.setCodepageValue,scope:this}}};var d=new SYNO.ux.FormPanel(b);this.archiveOptionForm=d;return d},setCodepageValue:function(){this.archiveOptionForm.form.findField("codepage").show();if(this.codepage){this.archiveOptionForm.form.findField("codepage").setValue(this.codepage);return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.DSM.Info",method:"GetInfo",version:1,callback:function(c,a,b){if(c){this.codepage=a.codepage}else{this.codepage="utf8"}this.archiveOptionForm.form.findField("codepage").setValue(this.codepage);this.clearStatusBusy()},scope:this})},load:function(b,d,c){var a=(4>c.length)?c:c.slice(0,c.length-4);if(SYNO.webfm.utils.checkFileLen(c,4)){this.archiveOptionForm.form.findField("archivename").setValue(a)}this.rec=b;this.targetDir=d;this.show()},closeHandler:function(){this.archiveOptionForm.form.reset();this.hide();this.fireEvent("callback")},validateForm:function(c,b,a){if(!this.archiveOptionForm.form.isValid()){return false}if(b!=a&&a===""){this.archiveOptionForm.form.findField("reenterpw").markInvalid(_WFT("error","error_repswd"));return false}return true},onCompress:function(f,i){i.cancel=false;var c=this.archiveOptionForm.form;var a=c.findField("archivename").getValue();var b=c.findField("compresslevel").getValue();var h=c.findField("compressmode").getValue();var k=c.findField("compressformat").getValue();var j=c.findField("enterpw").getValue();var m=c.findField("reenterpw").getValue();var l=c.findField("codepage").getValue();if(!this.validateForm(a,j,m)){i.cancel=true;return}var d=k.length+1;if(d>a.length){a+=("."+k)}else{var g=a.slice(a.length-d,a.length);if(g!==("."+k)){a+=("."+k)}}this.hide();this.fireEvent("callback",this.rec,this.targetDir,a,b,h,j,k,l);this.archiveOptionForm.form.reset()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.ExtractDialog=function(a){Ext.apply(this,a||{});var c=this.initFileTab();var d=this.initPropertyTab();this.tabPanel=new SYNO.ux.TabPanel({deferredRender:false,activeTab:0,enableTabScroll:true,plain:true,items:[{title:_WFT("extract","filelist"),layout:"fit",items:[c]},{title:_WFT("common","options"),layout:"fit",items:[d]}]});var b={owner:this.owner,width:650,height:605,shadow:true,minWidth:200,minHeight:200,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_extract"),layout:"fit",items:this.tabPanel,buttons:[this.btnExtract=new SYNO.ux.Button({btnStyle:"blue",text:_WFT("extract","btn_extract_selected"),scope:this,handler:function(){this.onExtract(false)}}),this.btnExtractAll=new SYNO.ux.Button({btnStyle:"blue",text:_WFT("extract","btn_extract_all"),scope:this,handler:function(){this.onExtract(true)}}),new SYNO.ux.Button({text:_WFT("common","close"),scope:this,handler:function(){this.closeHandler()}})],keys:[{key:[10,13],fn:function(){this.onExtract(true)},scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true},hide:{scope:this,fn:function(){this.dsFileList.removeAll()}},beforeshow:{fn:function(){this.SetDefaultDest(this.fileID);this.InitUIElement(this.blMultiFile,this.zipPath)},scope:this}}};SYNO.FileStation.ExtractDialog.superclass.constructor.call(this,b);this.addEvents("extract:true")};Ext.extend(SYNO.FileStation.ExtractDialog,SYNO.SDS.ModalWindow,{userGrid:undefined,propertyform:undefined,userRec:null,groupRec:null,gExtractValArr:null,gZipPath:null,gDest:null,gUID:null,gGID:null,gIsLoading:false,gZipFiles:null,pfiles:null,TreeDialog:null,initTToolbar:function(){var b=new Ext.Toolbar();var d=new SYNO.ux.Button({text:_WFT("common","common_refresh"),tooltip:_WFT("common","common_refresh"),listeners:{click:{fn:function(){this.dsFileList.removeAll();this.dsFileList.reload()},scope:this}}});b.add(d);var c=new SYNO.ux.Button({text:_WFT("common","all"),tooltip:_WFT("common","all"),listeners:{click:{fn:function(){var e=this.fileGrid.getSelectionModel();e.selectAll()},scope:this}}});b.add(c);var a=new SYNO.ux.Button({text:_WFT("common","none"),tooltip:_WFT("common","none"),listeners:{click:{fn:function(){var e=this.fileGrid.getSelectionModel();e.clearSelections()},scope:this}}});b.add(a);return b},initBToolbar:function(d){var c=new Ext.Toolbar({height:33});var e=new SYNO.ux.Button({text:_WFT("extract","dest_folder"),tooltip:_WFT("extract","dest_folder"),listeners:{click:{fn:function(){this.onChooseDest()},scope:this}}});c.add(e);c.addSeparator();this.btnDest=e;var b=new Ext.Toolbar.TextItem("");c.add(b);c.addSeparator();this.txtDest=b;var a=new SYNO.ux.PagingToolbar({store:d,pageSize:100,displayInfo:true});return new Ext.Panel({xtype:"syno_panel",cls:"webfm-extract-panel",border:false,items:[c,a]})},initFileTab:function(){var f=new Ext.data.Store({autoDestroy:true,remoteSort:true,pruneModifiedRecords:true,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.Extract",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"items",totalProperty:"total",id:"name"},[{name:"name"},{name:"path"},{name:"size"},{name:"pack_size"},{name:"mtime"},{name:"is_dir"},{name:"fileID",mapping:"item_id"}]),sortInfo:{field:"name",direction:"ASC"},paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},baseParams:{action:"list"},listeners:{beforeload:{fn:function(i,h){this.gIsLoading=true;this.btnExtractAll.disable();h.params.codepage=this.propertyform.form.findField("codepage").getValue();h.params.password=this.propertyform.form.findField("pass").getValue()},scope:this},load:{fn:function(){this.gIsLoading=false;this.btnExtractAll.enable();this.btnExtract.disable();this.onGridSelectionChanged()},scope:this},exception:{fn:function(i,j,k,h,n){var m=_WFT("filetable","filetable_extract");var l;if(n&&n.code==1403){l=_WFT("extract","extract_enter_pass");this.getMsgBox().prompt(m,l,function(o,p){if(o=="ok"){this.propertyform.form.setValues({pass:p});this.dsFileList.reload()}},this,undefined,undefined,true)}else{l=SYNO.webfm.utils.getWebAPIErrStr(false,n,h);this.getMsgBox().alert(m,l);this.closeHandler()}},scope:this}}});var c=function(m,k,h,j,l,i){if(h.get("is_dir")){return""}else{return Ext.util.Format.fileSize(m)}};var e=this.RELURL;var b=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{id:"filename",header:_WFT("common","common_filename"),dataIndex:"name",renderer:function(i,k,j,p,h,o){var n=Ext.util.Format.htmlEncode(i);k.attr='ext:qtip="'+Ext.util.Format.htmlEncode(n)+'"';var l=i.substr(i.lastIndexOf(".")+1).toLowerCase();var m="misc.png";if(j.data.is_dir){m="folder.png"}else{if(-1!==SYNO.webfm.utils.icon_type.indexOf(l)){m=l+".png"}}return String.format('<img width="16" height="16" src="'+e+"images/files_ext/{0}?v="+_S("version")+'" align="absmiddle" />&nbsp;{1}',m,n)}},{id:"size",header:_WFT("common","common_filesize"),dataIndex:"size",width:80,align:"right",renderer:c},{id:"pack_size",header:_WFT("extract","pack_size"),dataIndex:"pack_size",width:80,align:"right",renderer:c},{id:"mtime",header:_WFT("filetable","filetable_mtime"),dataIndex:"mtime",width:150,align:"right"}]});b.defaultSortable=true;var d=this.initTToolbar();var g=this.initBToolbar(f);this.delayTask=new Ext.util.DelayedTask(this.onGridSelectionChanged,this);var a=new SYNO.ux.GridPanel({enableHdMenu:false,ds:f,cm:b,loadMask:true,autoExpandColumn:"filename",enableColumnMove:false,enableColumnHide:false,selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:{fn:function(){this.delayTask.delay(100)},scope:this}}}),viewConfig:{forceFit:true},enableColLock:false,stripeRows:true,bbar:g,tbar:d,listeners:{render:{fn:function(){a.getGridEl().addClass("without-dirty-red-grid")}},celldblclick:{fn:function(k,l,j){var h="";var i=a.getStore().getAt(l);if(i.get("is_dir")===false){return}h=i.get("fileID");this.onChangeDir(h)},scope:this},rowclick:{fn:function(h,j,i){if(i&&j&&!i.hasModifier()){h.getSelectionModel().selectRow(j)}}}}});this.dsFileList=f;this.fileGrid=a;return a},initPropertyTab:function(){var c=new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.webfm.utils.getSupportedLanguage()});var a={labelWidth:200,url:"/webapi/dsm/info.cgi",trackResetOnLoad:true,waitMsgTarget:true,border:false,autoScroll:true,items:[{xtype:"syno_fieldset",title:_WFT("common","password"),synodefaults:{width:300},items:{xtype:"syno_textfield",textType:"password",width:210,fieldLabel:_WFT("common","password"),name:"pass",readOnly:false}},{xtype:"syno_fieldset",title:_WFT("filetable","filetable_overwrite"),itemId:"filetable_overwrite",items:{xtype:"radiogroup",itemId:"dup_mode",columns:1,vertical:true,hideLabel:true,items:[{xtype:"syno_radio",boxLabel:_WFT("extract","skip_exist"),inputValue:"skip",name:"dup_mode",checked:true},{xtype:"syno_radio",boxLabel:_WFT("filetable","filetable_overwrite"),name:"dup_mode",inputValue:"overwrite",checked:false}]}},{xtype:"syno_fieldset",title:_WFT("extract","file_path"),itemId:"file_path",items:{xtype:"radiogroup",itemId:"path_mode",columns:1,vertical:true,hideLabel:true,items:[{xtype:"syno_radio",boxLabel:_WFT("extract","extract_full_path"),inputValue:"full",name:"path_mode",checked:true},{xtype:"syno_radio",boxLabel:_WFT("extract","extract_no_path"),name:"path_mode",inputValue:"none",checked:false}]}},{xtype:"syno_fieldset",title:_WFT("common","lang_codepage"),synodefaults:{width:300},items:[{xtype:"syno_combobox",width:200,fieldLabel:_WFT("common","lang_codepage"),hiddenName:"codepage",store:c,displayField:"display",valueField:"value",triggerAction:"all",editable:false,mode:"local",listeners:{select:{fn:function(){if(this.tabPanel.getTabEl(0).style.display!=="none"){this.dsFileList.removeAll();this.dsFileList.reload()}},scope:this}}}]},{xtype:"syno_fieldset",itemId:"dest_field",title:_WFT("extract","dest_folder"),viewConfig:{forceFit:true},items:[{xtype:"syno_button",itemId:"btnDestField",text:_WFT("extract","dest_folder"),scope:this,handler:this.onChooseDest},{xtype:"syno_displayfield",itemId:"txtDestField",hideLabel:true,name:"extract_dest",value:""}]}],listeners:{actionfailed:{fn:function(e,d){var g=_WFT("filetable","filetable_extract");var f=_WFT("error","error_error_system");this.owner.getMsgBox().alert(g,f);this.closeHandler()},scope:this}}};var b=new SYNO.ux.FormPanel(a);this.dest_field=b.get("dest_field");this.btnDestField=this.dest_field.getComponent("btnDestField");this.txtDestField=this.dest_field.getComponent("txtDestField");this.propertyform=b;return b},onGridSelectionChanged:function(){var a=this.fileGrid.getSelectionModel();var b=a.getCount();if(b===0){this.btnExtract.disable()}else{if(!this.gIsLoading&&!(b==1&&a.getSelected().get("name")=="..")){this.btnExtract.enable()}else{this.btnExtract.disable()}}},onChooseDest:function(){if(!this.TreeDialog||this.TreeDialog.isDestroyed){this.TreeDialog=new SYNO.FileStation.TreeDialog({RELURL:this.RELURL,blDynamicForm:false,blVFSFolder:false,owner:this,webfm:this.webfm});this.TreeDialog.mon(this.TreeDialog,"beforesubmit",this.onCheckDestPrivilege,this);this.TreeDialog.mon(this.TreeDialog,"callback",this.onTreeDialogHide,this)}var a=this.TreeDialog;a.load(_WFT("filetable","filetable_extract"),false,this.gUID,this.gGID,this.gDest)},onCheckDestPrivilege:function(a){var b=this.TreeDialog;if(b){if(_S("is_admin")===true||_S("domainUser")=="true"){return true}if(!SYNO.webfm.utils.checkShareRight(a.shareRight,SYNO.webfm.utils.RW)){b.getMsgBox().alert(_WFT("filetable","filetable_extract"),_WFT("error","error_privilege_not_enough"));return false}if(Ext.isDefined(a.folderRight)){var c={right:a.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Extract};if(!SYNO.webfm.utils.checkFileRight(c)){b.getMsgBox().alert(_WFT("filetable","filetable_extract"),_WFT("error","error_privilege_not_enough"));return false}}return true}},onTreeDialogHide:function(){var a=this.TreeDialog;if(!a){return}var b=a.getParameters();if(b.fdrName){this.UpdateTargetPath(b.fdrName)}},onChangeDir:function(a){this.dsFileList.baseParams.item_id=a;this.dsFileList.load({params:{start:0,limit:100}})},LoadFileList:function(a){this.gZipPath=a;this.dsFileList.baseParams.file_path=a;this.dsFileList.baseParams.item_id=-1;this.dsFileList.load({params:{start:0,limit:100}});this.propertyform.load({params:{api:"SYNO.DSM.Info",method:"GetInfo",version:1},waitMsg:_WFT("common","loading")})},InitGlobalVal:function(){this.gZipPath=null;this.gExtractValArr=null;this.gDest=null},InitUIElement:function(b,a){this.btnExtract.disable();if(b){this.dest_field.show();this.tabPanel.hideTabStripItem(0);this.btnExtractAll.enable();this.propertyform.load({params:{api:"SYNO.DSM.Info",method:"GetInfo",version:1},waitMsg:_WFT("common","loading")});this.tabPanel.setActiveTab(1)}else{this.dest_field.hide();this.tabPanel.unhideTabStripItem(0);this.btnExtractAll.disable();this.LoadFileList(a);this.tabPanel.setActiveTab(0)}this.fileGrid.getColumnModel().setHidden(1,this.zipPath&&("bz2"===SYNO.webfm.utils.getExt(this.zipPath)))},load:function(b,f,d,e,g){if(f===""||b===""){return}var a=605;var c=SYNO.SDS.Desktop?SYNO.SDS.Desktop.getEl().getHeight():Ext.lib.Dom.getViewHeight();if(c<a){a=c}this.setSize(this.width,a);this.gUID=d;this.gGID=e;this.InitGlobalVal();this.fileID=b;this.blMultiFile=g;this.zipPath=f;this.show().center()},SetPathFiles:function(a){this.pFiles=a},GetPathFiles:function(){return this.pFiles},SetMultiZipFile:function(a){this.gZipFiles=a},GetMultiZipFile:function(){return this.gZipFiles},SetDefaultDest:function(d){var b=d;var c="",a;a=b.lastIndexOf("/");if(a==-1){return false}c=b.substr(0,a);this.UpdateTargetPath(c)},UpdateTargetPath:function(a){this.gDest=a;this.txtDest.getEl().update("<b>"+Ext.util.Format.htmlEncode(a)+"</b>");this.txtDestField.setRawValue("<b>"+Ext.util.Format.htmlEncode(a)+"</b>")},closeHandler:function(){this.delayTask.cancel();this.propertyform.form.reset();this.hide()},onExtract:function(a){if(!this.SaveOptions(a)){return}this.fireEvent("extract")},SaveOptions:function(a){var h=this.fileGrid.getSelectionModel();var f="";var c="";if(!a){f=h.getSelections();c=SYNO.webfm.utils.ParseArr(f,"fileID").join(",")}var e=this.propertyform.get("filetable_overwrite").get("dup_mode").getValue().inputValue;var b=this.propertyform.form.findField("pass").getValue();var d=this.propertyform.get("file_path").get("path_mode").getValue().inputValue;var g=this.propertyform.form.findField("codepage").getValue();if(Ext.isEmpty(this.gDest)){this.getMsgBox().alert(_WFT("filetable","filetable_extract"),_WFT("filetable","filetable_select_path"));return false}this.gExtractValArr={zipPath:this.gZipPath,dest:this.gDest,all:a,files:c,mode:e,pass:b,pathMode:d,codepage:g};return true},getOptions:function(){return this.gExtractValArr}});Ext.ns("SYNO.FileStation");SYNO.FileStation.ContainerFlexcrollPlugin=Ext.extend(Ext.Component,{eventNames:["afterlayout","resize"],init:function(a){Ext.apply(a,{updateScrollbar:this.updateScrollbar});a.mon(a,"afterrender",function(b){this.eventNames.each(function(c){this.mon(this,c,function(){var d=this.getLayoutTarget();this.updateScrollbar(d.dom)},this)},b)},this)},updateScrollbar:function(c,a){var b=this;if(b.isVisible()){if(c&&c.fleXcroll){if(a){c.fleXcroll.setScrollPos(false,0)}c.fleXcroll.updateScrollBars();if(!a){c.fleXcroll.setScrollPos(0,0,true)}}else{if(c){fleXenv.fleXcrollMain(c)}}}}});SYNO.FileStation.QRCode=Ext.extend(Ext.BoxComponent,{constructor:function(a){a=a||{};SYNO.FileStation.QRCode.superclass.constructor.call(this,a)},onRender:function(b,a){var c=this;SYNO.FileStation.QRCode.superclass.onRender.apply(this,arguments);if(c.qrcodeWrap){c.qrcodeWrapEl=c.el.createChild({tag:"div",cls:c.qrcodeWrapCls})}if(c.qrcode){(c.qrcodeWrapEl||c.el).createChild({tag:"img",cls:c.qrcodeCls,alt:c.qrcodeAlt||"",title:c.qrcodeTitle||"",src:c.qrcode,draggable:false});c.synologyIconImg=(c.qrcodeWrapEl||c.el).createChild({tag:"div",cls:c.logoCls,height:38,width:80});c.synologyIconImg.alignTo(c.qrcodeWrapEl,"c-t",[0,15]);c.qrcodeWrapEl.addListener("mouseover",function(){this.synologyIconImg.hide()},this);c.qrcodeWrapEl.addListener("mouseout",function(){this.synologyIconImg.show()},this)}if(c.description){c.el.createChild({tag:"div",cls:c.descriptionCls,"ext:qtip":Ext.util.Format.htmlEncode(c.description),html:c.description})}if(c.url){c.el.createChild({tag:"div",cls:c.urlCls,html:c.url})}}});SYNO.FileStation.EditSharingFileWindow=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.apply(this,a||{});var b={owner:this.owner,width:450,height:250,minWidth:420,minHeight:200,shadow:true,collapsible:false,title:_WFT("sharing","sharing_links"),layout:"fit",trackResetOnLoad:true,forceSelection:true,waitMsgTarget:true,border:false,items:this.panel=this.initPanel(),buttons:[{btnStyle:"blue",text:_T("common","apply"),scope:this,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):undefined,handler:this.onApplyHandler},{text:_T("common","cancel"),scope:this,handler:this.onCloseEdit}],keys:[{key:[10,13],scope:this,handler:this.onApplyHandler},{key:27,scope:this,handler:this.onCloseEdit}]};SYNO.FileStation.EditSharingFileWindow.superclass.constructor.call(this,b)},initPanel:Ext.emptyFn,onApplyHandler:Ext.emptyFn,onCloseEdit:function(){var a=this.panel.form.isDirty();if(a){var c=_WFT("sharing","edit_link");var b=_WFT("common","confirm_lostchange");this.getMsgBox().confirm(c,b,function(d){if("yes"==d){this.close()}else{return}},this)}else{this.close()}},saveEdit:function(b){var a=this.target;this.setStatusBusy();this.addWebAPITask({api:"SYNO.FileStation.Sharing",method:"edit",version:1,single:true,params:b,callback:function(e,c,d){this.clearStatusBusy();if(e){a.updateTextArea();this.close()}else{this.setStatusError()}},scope:this}).start(true)}});SYNO.FileStation.DurationWindow=Ext.extend(SYNO.FileStation.EditSharingFileWindow,{constructor:function(a){SYNO.FileStation.DurationWindow.superclass.constructor.call(this,a);this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.panel.getComponent("enableValidTimes").getEl(),_WFT("sharing","valid_times_tip"))},this,{single:true})},initPanel:function(){var d={xtype:"syno_combobox",fieldLabel:_WFT("sharing","exp_after"),forceSelection:true,value:this.enableDate?this.option:1,itemId:"comboBox_duration",name:"comboBox_duration",valueField:"ID",displayField:"displayText",disabled:!this.enableDate,width:160,labelWidth:180,indent:1,store:new Ext.data.ArrayStore({id:0,fields:["ID","displayText"],data:[[1,_WFT("sharing","week")],[2,_WFT("sharing","month")],[3,_T("common","customize")+"..."]]}),listeners:{beforeselect:{fn:function(g,e,f){this.priviousChoice=g.getValue()},scope:this},collapse:{fn:function(e){if(e.getValue()==3){this.showDatesDialog()}},scope:this}}};this.initDSToday();var b={labelWidth:140,itemId:"file_sharing_duration",border:false,items:[{itemId:"enableDates",xtype:"syno_checkbox",boxLabel:_WFT("sharing","enable_duration"),hideMode:"display",name:"enableDates",checked:this.enableDate,listeners:{check:{fn:function(f,e){if(e===true){this.panel.get("comboBox_duration").enable()}else{this.panel.get("comboBox_duration").disable()}},scope:this}}},d,{itemId:"enableValidTimes",xtype:"syno_checkbox",boxLabel:_WFT("sharing","enable_valid_times"),name:"enable_valid_times",checked:this.enableValidTimes,disabled:this.hasFolder},{itemId:"validTimesField",xtype:"syno_numberfield",name:"valid_times",width:160,labelWidth:180,fieldLabel:_WFT("sharing","valid_times"),value:this.validTimes||1,maxLength:2,allowNegative:false,disabled:this.hasFolder,indent:1}]};var a=new SYNO.ux.FormPanel(b),c;c=new SYNO.ux.Utils.EnableCheckGroup(a.form,"enable_valid_times",["valid_times"]);return a},onApplyHandler:function(){if(_S("demo_mode")){this.getMsgBox().alert(_WFT("common","options"),_JSLIBSTR("uicommon","error_demo"));return}if(!this.panel.form.isDirty()){this.close();return}if(!this.panel.form.isValid()){this.getMsgBox().alert("",_T("common","forminvalid"));return}var g=this.target;var a=this.panel.get("enableDates").getValue();var k=this.panel.get("enableValidTimes").getValue();this.option=a?this.panel.get("comboBox_duration").getValue():4;this.validTimes=this.panel.get("validTimesField").getValue();g.enableDate=a;g.enableValidTimes=k;g.savedAvailDate=this.savedAvailDate;g.savedExpDate=this.savedExpDate;g.AvailDate=this.availDate;g.ExpDate=this.expDate;g.option=this.option;g.validTimes=this.validTimes;var j=new Date(this.DStoday);var h,d;switch(this.option){case 1:var b=new Date(j.getFullYear(),j.getMonth(),j.getDate()+6,0,0,0,0);h=j.getFullYear()+"-"+(j.getMonth()+1)+"-"+j.getDate();d=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate();break;case 2:var c=new Date(j.getFullYear(),j.getMonth()+1,j.getDate()-1,0,0,0,0);h=j.getFullYear()+"-"+(j.getMonth()+1)+"-"+j.getDate();d=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate();break;case 3:var i=new Date(this.availDate);var f=new Date(this.expDate);h=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate();d=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate();break;case 4:h="0";d="0";break}var e={id:g.linkIDs.join(","),date_available:h,date_expired:d,valid_times:(k)?this.validTimes:-1};this.saveEdit(e)},initDSToday:function(){this.addWebAPITask({api:"SYNO.DSM.Info",method:"GetInfo",version:1,single:true,callback:function(c,a,b){if(c&&a.time){this.DStoday=Date.parse(a.time)}else{this.getMsgBox().alert(_WFT("common","share"),_WFT("common","error_system"))}},scope:this}).start(true)},showDatesDialog:function(){var d=new Date(this.DStoday);var f=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0);var a=new Date(d.getFullYear(),d.getMonth(),d.getDate()+6,0,0,0,0);var c={dialogWidth:525,dialogHeight:295,labelWidth:200};var e={border:false,items:[{xtype:"syno_datefield",name:"AvailDate",fieldLabel:_WFT("sharing","avail_date"),value:this.savedAvailDate?this.savedAvailDate:f,minValue:f,format:"Y-m-d",showToday:false,markToday:false,editable:false,width:150},{xtype:"syno_displayfield",width:"auto",value:" "},{xtype:"syno_datefield",name:"ExpDate",fieldLabel:_WFT("sharing","exp_date"),allowBlank:false,value:this.savedExpDate?this.savedExpDate:a,format:"Y-m-d",showToday:false,markToday:false,editable:false,minValue:f,width:150,validator:function(){var j=b.form.findField("AvailDate").getValue().getTime();var i=b.form.findField("ExpDate").getValue().getTime();var h=f.getTime();if(i<h){return _WFT("sharing","exp_before_today")}else{if(j>i){return _WFT("sharing","exp_before_avail")}else{return true}}}},{xtype:"syno_displayfield",width:"auto",value:String.format('<span class="syno-ux-note">{0}: </span>{1}',_T("common","note"),_WFT("sharing","dates_desc_content"))}]};var b=new SYNO.ux.FormPanel(e);var g=new SYNO.SDS.ModalWindow({owner:this,width:c.dialogWidth,height:c.dialogHeight,minWidth:c.dialogWidth,minHeight:c.dialogHeight,shadow:true,collapsible:false,resizable:true,title:_WFT("sharing","customize_duration"),layout:"fit",items:b,buttons:[{btnStyle:"blue",itemId:"ok_button",text:_WFT("common","ok"),scope:this,handler:function(){var i=b.form.findField("AvailDate").getValue();var h=b.form.findField("ExpDate").getValue();if(b.form.findField("ExpDate").isValid()){this.availDate=i.getTime();this.expDate=h.getTime();this.savedAvailDate=i;this.savedExpDate=h;g.close()}}},{itemId:"cancel_button",text:_WFT("common","cancel"),scope:this,handler:function(){this.panel.form.findField("comboBox_duration").setValue(this.priviousChoice);g.close()}}]});g.show().center();b.form.findField("AvailDate").label.setWidth(c.labelWidth);b.form.findField("ExpDate").label.setWidth(c.labelWidth)}});Ext.define("SYNO.FileStation.SharingDialog",{extend:"SYNO.SDS.ModalWindow",sharingform:null,constructor:function(a){this.files=[];this.filenames=[];this.urls=[];this.md5=[];this.password=null;this.ExpDate=null;this.AvailDate=new Date().valueOf();this.savedExpDate=null;this.savedAvailDate=null;var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.panel.getComponent("copy_link_message").getEl(),_WFT("sharing","mailto_desc"))},this,{single:true})},fillConfig:function(a){Ext.apply(this,a||{});this.panel=this.initMainPanel();var b={owner:this.owner,width:700,height:(!this.restrictField.isNeedHideSocialField())?580:500,collapsible:false,resizable:false,title:_WFT("sharing","add_share_link"),tbar:this.initToolbar(),tbarCfg:{cls:"webfm-sharing-tbar"},layout:"fit",items:this.panel,buttons:[{btnStyle:"blue",itemId:"submit_button",text:_T("common","apply"),scope:this,listeners:{click:this.updateLinks,scope:this}},{text:_T("common","cancel"),scope:this,listeners:{click:{fn:this.cancelLinks,scope:this}}}]};return b},initToolbar:function(){var b={items:[{xtype:"syno_button",text:_WFT("sharing","exp_after"),handler:function(){var c={owner:this,target:this,enableDate:this.enableDate||false,savedAvailDate:this.savedAvailDate,savedExpDate:this.savedExpDate,option:this.option||1,hasFolder:this.hasFolder,enableValidTimes:this.enableValidTimes||false,validTimes:this.validTimes||1},d=new SYNO.FileStation.DurationWindow(c);d.show()},scope:this},{xtype:"syno_button",itemId:"qrcodeBnt",name:"qrcodeBnt",text:_WFT("sharing","get_qrcode"),handler:function(){var c={owner:this,target:this,urls:this.urls,filenames:this.filenames,linkQRCodes:this.linkQRCodes};var d=new SYNO.FileStation.QRCodeDialog(c);d.show().center()},scope:this}]};var a=new Ext.Toolbar(b);return a},initMainPanel:function(){this.restrictField=new SYNO.FileStation.RestrictFieldSet({enableRestrict:this.enableRestrict,facebookBoxselectId:this.facebookBoxselectId=Ext.id(),googleBoxselectId:this.googleBoxselectId=Ext.id(),passwdFieldId:this.passwdFieldId=Ext.id(),facebookData:[],facebookValues:"",googleData:[],googleValues:"",password:this.password,passwdInputType:"text"});this.secureFieldSet=new SYNO.FileStation.SecureFieldSet({enableSecure:false,enableRestrict:false,enableDSUser:false,dsUserValue:[],dsUserData:{users:[]},restrictField:this.restrictField});var a={labelWidth:200,autoFlexcroll:true,trackResetOnLoad:true,waitMsgTarget:true,border:false,items:[{xtype:"syno_displayfield",hideLabel:true,width:"auto",value:'<div class="text-overflow-hidden" ext:qtip="'+Ext.util.Format.htmlEncode(_WFT("sharing","newlink_instruction"))+'">'+_WFT("sharing","newlink_instruction")+"</div>"},{xtype:"syno_textarea",itemId:"path",name:"path",width:450,height:50,readOnly:true,autoFlexcroll:true,fieldLabel:_WFT("common","file_path"),selectOnFocus:true,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_displayfield",hideLabel:true,itemId:"copy_link_message",value:String.format(_WFT("sharing","full_instruction"),"<a class='pathlink'>"+_WFT("common","buildin_mail")+"</a>","<a class='pathlink'>"+_WFT("common","mail")+"</a>"),listeners:{render:function(c){this.mon(c.el.child("a:nth-child(1)"),"click",this.onBuildInMail,this);this.mon(c.el.child("a:nth-child(2)"),"click",this.onMail,this)},scope:this,single:true,buffer:80}},{xtype:"syno_textarea",itemId:"urls",name:"urls",width:450,height:50,readOnly:true,autoFlexcroll:true,labelStyle:"width: 180px",selectOnFocus:true,fieldLabel:_WFT("sharing","share_url"),cls:"selectabletext allowDefCtxMenu sds-selectable-text "},{xtype:"syno_checkbox",itemId:"enableRst",name:"enableRst",checked:this.enableRestrict,boxLabel:_WFT("sharing","restrict_sharing"),listeners:{check:{fn:function(){if(this.sharingform.get("enableRst").getValue()===true){var c=this.sharingform.get("secureFieldSet");c.enable();if(!c.get("dsUserRadio").getValue()&&!c.get("dsRestRadio").getValue()){c.get("dsUserRadio").setValue(true)}}else{this.sharingform.get("secureFieldSet").disable()}},scope:this}}},this.secureFieldSet]};var b=new SYNO.ux.FormPanel(a);this.sharingform=b;return b},updateTextArea:function(){this.setUrls()},onAddDone:function(f,c,b){if(f&&Ext.isArray(c.links)){this.urls=[];this.linkIDs=[];this.linkQRCodes=[];this.hasFolder=c.has_folder;var h,g=c.links,j=g.length;for(var d=0;d<j;d++){h=g[d];this.urls.push(h.error?"":h.url);this.linkIDs.push(h.error?"":h.id);this.linkQRCodes.push(h.error?"":h.qrcode)}this.updateTextArea();this.clearStatusBusy()}else{var e=_WFT("common","share");var a=SYNO.webfm.utils.getWebAPIErr(f,c,b);this.owner.getMsgBox().alert(e,a);this.closeHandler()}},loadTextArea:function(){var b,a=[];for(b=0;b<this.files.length;b++){a.push(SYNO.API.EscapeStr(this.files[b]))}this.addWebAPITask({api:"SYNO.FileStation.Sharing",method:"create",version:1,params:{path:a.join(","),sharing_list:JSON.stringify(this.selectedList)},single:true,callback:this.onAddDone,scope:this}).start(true)},load:function(){this.loadTextArea();this.show().center()},setFiles:function(d){var b=0,a;for(a=0;a<d.length;a++){this.files[b]=d[a].get("file_id");this.filenames[b]=d[a].get("filename");b++}var c=this.files.join("\n");this.sharingform.get("path").setValue(c)},setUrls:function(){this.sharingform.get("urls").setValue(this.urls.join("\n"))},onMail:function(){var a=this.urls.join("%0A%0A");SYNO.webfm.utils.onMailTo(a)},onBuildInMail:function(){SYNO.SDS.AppLaunch("SYNO.SDS.App.MailDialog.Application",{content:this.urls.reduce(function(a,b){return a+"<div>"+b+"</div>"},"")})},cancelLinks:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.FileStation.Sharing",method:"delete",version:1,params:{id:this.linkIDs.join(",")},callback:function(e,a,b){if(e){this.clearStatusBusy();this.close()}else{var d=_WFT("common","share");var c=_WFT("error","error_error_system");this.owner.getMsgBox().alert(d,c);this.clearStatusBusy()}},scope:this})},updateLinks:function(){var e,p;var k=this.sharingform.get("enableRst").getValue();var h=this.secureFieldSet.get("dsUserRadio").getValue();var j=this.secureFieldSet.get("dsRestRadio").getValue();var b=Ext.getCmp(this.passwdFieldId).getValue();var d=Ext.getCmp(this.facebookBoxselectId).isDirty()||Ext.getCmp(this.googleBoxselectId).isDirty();var l=true,m=false,o=[];e=Ext.getCmp(this.passwdFieldId);this.password=(e.isValid())?e.getValue():"";this.restrictField.updateAllList();p=this.restrictField.getSelectedList();l=(p.Facebook.length+p.Google.length===0);m=j&&d&&!l;var g=0,a=this.secureFieldSet.get("dsUser_cmb").getSelectedRecords();for(g=0;g<a.length;g++){o.push({name:a[g].data.name,type:a[g].data.type})}if(!k){this.close();return}var n=_WFT("common","share"),c="";if(h&&0===o.length){c=_WFT("sharing","dsm_user_alert");this.getMsgBox().alert(n,c);return}if(j&&l&&b.empty()){c=_WFT("sharing","restrict_alert");this.getMsgBox().alert(n,c);return}if(h){p.DSM=o;p.Facebook=[];p.Google=[]}var f={id:this.linkIDs.join(","),password:(h)?"":this.password,sharing_list:JSON.stringify(p)};this.setStatusBusy();this.sendWebAPI({api:"SYNO.FileStation.Sharing",method:"edit",version:1,params:f,callback:function(u,s,t){this.clearStatusBusy();if(u){var i=this.restrictField.getSelectedListValue();var q=this.restrictField.getSelectedList();if(m&&0!==i.Facebook.length){var r=new SYNO.FileStation.NotificationDialog({owner:this.owner,target:this.owner,urls:this.urls.join("\n"),facebookValues:i.Facebook,facebookData:q.Facebook,googleValues:i.Google,googleData:q.Google});r.show().center();this.close()}else{this.close()}}else{this.setStatusError()}},scope:this})},closeHandler:function(){this.close()}});Ext.define("SYNO.FileStation.SecureFieldSet",{extend:"SYNO.ux.FieldSet",constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",this.initDailog,this,{single:true})},fillConfig:function(a){Ext.apply(this,a||{});var d=new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item acl-icon-combo-item acl-combo-item-{type}">{name}</div></tpl>');var e=new Ext.XTemplate('<div class="acl-icon-combo-item acl-combo-item-{type} sharing-combo-item-{type}">{name}</div>');var c=function(g,f){return f.name+":"+f.type};this.user_store=new Ext.data.Store({autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.ACL",method:"list_owners",version:1}),reader:new Ext.data.JsonReader({root:"owners",totalProperty:"total",id:"value"},[{name:"name"},{name:"type"},{name:"value",convert:c}]),paramNames:{start:"offset",limit:"limit"},remoteSort:true,baseParams:{type:"all"},pruneModifiedRecords:true,listeners:{load:function(h,g,f){g.each(function(i){if(this.isUsersGroup(i.data.name)){this.user_store.remove(i)}},this)},scope:this}});var b={owner:this.owner,target:this.owner,itemId:"secureFieldSet",name:"secureFieldSet",border:false,disabled:!this.enableSecure,cls:"webfm-superboxselect",items:[{xtype:"syno_radio",itemId:"dsUserRadio",name:"grpRadio",checked:this.enableDSUser,boxLabel:_WFT("sharing","share_dsm_user"),listeners:{check:function(g,f){if(f){this.get("dsUser_cmb").enable()}else{this.get("dsUser_cmb").disable()}},scope:this}},{xtype:"syno_superboxselect",itemId:"dsUser_cmb",fieldLabel:_T("helptoc","personal_account"),width:320,disabled:!this.enableDSUser,valueField:"value",displayField:"name",displayFieldTpl:e,triggerAction:"all",mode:_S("is_admin")?"remote":"local",queryParam:"prefix",minChars:2,allowQueryAll:_S("is_admin")?true:false,pageSize:50,editable:true,grow:true,typeAhead:true,allowBlank:false,indent:1,tpl:d,store:this.user_store,listeners:{afterrender:function(f){this.mon(f,"additem",this.doRefreshLayout,this);this.mon(f,"removeitem",this.doRefreshLayout,this);this.mon(f,"clear",this.doRefreshLayout,this)},scope:this}},{xtype:"syno_radio",itemId:"dsRestRadio",name:"grpRadio",checked:this.enableRestrict,boxLabel:_WFT("sharing","share_public_user"),listeners:{check:function(g,f){if(f){this.get("restrictField").enable()}else{this.get("restrictField").disable()}},scope:this}},this.restrictField]};return b},initDailog:function(){var a=0;var b=this.getComponent("dsUser_cmb");b.allowAddNewData=true;b.addNewDataOnBlur=true;for(a=0;a<this.dsUserData.users.size();a++){b.addNewItem({name:this.dsUserData.users[a].name,type:this.dsUserData.users[a].type,value:this.dsUserData.users[a].value},true)}b.setValue(this.dsUserValue);b.originalValue=b.getValue();if(!_S("is_admin")){this.mon(b,"newitem",function(f,c){if(""===c||this.isUsersGroup(c)){return}var d,e;e=("@"===c[0])?"group":"user";d=("@"===c[0])?c.substr(1,c.length):c;f.addNewItem({name:d,type:e,value:d+":"+e},true)},this)}},doRefreshLayout:function(){this.doLayout();this.ownerCt.doLayout()},isUsersGroup:function(a){if(!a){return false}if("guest"===a||"users"===a||a.match(/^users@.*/i)||a.match(/.*\\Domain Users$/i)){return true}return false}});Ext.define("SYNO.FileStation.RestrictFieldSet",{extend:"SYNO.ux.FieldSet",constructor:function(a){this.selectedList={};this.selectedList.Facebook=[];this.selectedList.Google=[];this.friendList={};this.friendList.Facebook=[];this.friendList.Google=[];var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){Ext.apply(this,a||{});var b={owner:this.owner,target:this.owner,itemId:"restrictField",name:"restrictField",border:false,cls:"webfm-sharing-restrict-fieldset",disabled:!this.enableRestrict,items:[{xtype:"syno_displayfield",width:"auto",value:'<div class="text-overflow-hidden" ext:qtip="'+Ext.util.Format.htmlEncode(_WFT("sharing","select_friends"))+'">'+_WFT("sharing","select_friends")+"</div>",hidden:this.isNeedHideSocialField()},{xtype:"compositefield",cls:"webfm-superboxselect",hidden:this.isNeedHideSocialField(),items:[{xtype:"syno_superboxselect",id:this.facebookBoxselectId,itemId:"facebookboxselect",name:"Facebook",fieldLabel:_WFT("sharing","facebook_desc"),displayField:"name",valueField:"id",emptyText:_WFT("sharing","superboxselect_hint"),triggerAction:"all",mode:"local",allowBlank:true,flex:5,readOnly:true,value:this.facebookValues.toString(),store:new Ext.data.JsonStore({data:this.facebookData,fields:["id","name","picture","selected"]}),listeners:{afterrender:function(c){this.mon(c,"additem",this.doRefreshLayout,this);this.mon(c,"removeitem",this.doRefreshLayout,this);this.mon(c,"clear",this.doRefreshLayout,this)},scope:this}},{xtype:"syno_button",itemId:"addFacebookBnt",name:"Facebook",text:_WFT("sharing","add_friends"),handler:this.addFacebookFriends,scope:this}]},{xtype:"compositefield",cls:"webfm-superboxselect",hidden:this.isNeedHideSocialField(),items:[{xtype:"syno_superboxselect",id:this.googleBoxselectId,itemId:"googleboxselect",name:"Google",fieldLabel:_WFT("sharing","googleplus_desc"),emptyText:_WFT("sharing","superboxselect_hint"),triggerAction:"all",mode:"local",allowBlank:true,displayField:"name",valueField:"id",readOnly:true,flex:5,value:this.googleValues.toString(),store:new Ext.data.JsonStore({data:this.googleData,fields:["id","name","picture","selected"]}),listeners:{afterrender:function(c){this.mon(c,"additem",this.doRefreshLayout,this);this.mon(c,"removeitem",this.doRefreshLayout,this);this.mon(c,"clear",this.doRefreshLayout,this)},scope:this}},{xtype:"syno_button",itemId:"addGoogleBnt",name:"Google",text:_WFT("sharing","add_friends"),handler:this.addGoogleFriends,scope:this}]},{xtype:"syno_displayfield",value:_WFT("sharing","passwd_desc"),hidden:this.isNeedHideSocialField()},{xtype:"syno_textfield",id:this.passwdFieldId,name:"passwdField",itemId:"passwd",width:320,maxLength:16,textType:this.passwdInputType,allowBlank:true,value:this.password,fieldLabel:_WFT("sharing","enter_password")},{xtype:"syno_textfield",hidden:("password"===this.passwdInputType)?false:true,id:this.confirmPasswdFieldId,name:"comfirm_passwd_field",itemId:"comfirm_passwd_field",width:320,maxLength:16,textType:"password_confirm",allowBlank:true,value:this.password,fieldLabel:_WFT("sharing","reenter_password")}]};return b},doRefreshLayout:function(){this.doLayout();this.ownerCt.doLayout();this.ownerCt.ownerCt.doLayout()},showFriendDialog:function(b){var c={owner:this.ownerCt.ownerCt.ownerCt,target:this.ownerCt.ownerCt.ownerCt,caller:this,callback:this.addFriendsDone,nextPageToken:(undefined!==this.nextPageToken)?this.nextPageToken:"",cacheFriendList:this.friendList[window.socialType],cacheSelectedFriendList:this.selectedList[window.socialType]};var a=new SYNO.FileStation.FriendListDialog(Ext.apply(c,b));a.show()},addFriendsDone:function(a,d,b){var e;var c=[];if(d==="Facebook"){e=Ext.getCmp(b.facebookBoxselectId)}else{e=Ext.getCmp(b.googleBoxselectId)}e.store.loadData(b.friendList[d]);c=e.getValue().split(",");c=c.concat(a);e.setValue(c);e.readOnly=false},addGoogleFriends:function(b,c){window.socialType=b.name;var a={appid:"933144811772.apps.googleusercontent.com",socialType:window.socialType};this.updateSelectedList(Ext.getCmp(this.googleBoxselectId));this.showFriendDialog(a)},addFacebookFriends:function(b,c){window.socialType=b.name;var a={appid:"182214881982305",socialType:window.socialType};this.updateSelectedList(Ext.getCmp(this.facebookBoxselectId));this.showFriendDialog(a)},updateSelectedList:function(c){var a=c.getSelectedRecords();this.selectedList[c.name].clear();for(var b=0;b<a.length;b++){this.selectedList[c.name].push(a[b].data)}},updateAllList:function(){this.updateSelectedList(Ext.getCmp(this.facebookBoxselectId));this.updateSelectedList(Ext.getCmp(this.googleBoxselectId))},getSelectedList:function(){return this.selectedList},getSelectedListValue:function(){var a={},b;a.Facebook=[];a.Google=[];for(b=0;b<this.selectedList.Facebook.length;b++){a.Facebook.push(this.selectedList.Facebook[b].id)}for(b=0;b<this.selectedList.Google.length;b++){a.Google.push(this.selectedList.Google[b].id)}return a},getFilterSelectedListValue:function(c){var b,d;var a={};a.Facebook=[];a.Google=[];for(b=0;b<this.selectedList.Facebook.length;b++){d=this.selectedList.Facebook[b].id;if(!this.findValue(c.Facebook,d)){a.Facebook.push(d)}}for(b=0;b<this.selectedList.Google.length;b++){d=this.selectedList.Google[b].id;if(!this.findValue(c.Google,d)){a.Google.push(d)}}return a},findValue:function(b,c){var a=0;for(a=0;a<b.length;a++){if(b[a]===c){return true}}return false},isNeedHideSocialField:function(){return true}});Ext.define("SYNO.FileStation.QRCodeDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){Ext.apply(this,a||{});var b={title:_WFT("sharing","qrcode_links"),owner:this.owner,width:500,height:Ext.isGecko?416:406,collapsible:false,resizable:false,layout:"fit",buttons:[{btnStyle:"blue",itemId:"submit_button",text:_T("common","apply"),scope:this,handler:function(){this.close()}}],items:this.initMainPanel()};return b},initMainPanel:function(){var b={items:[{xtype:"container",id:this.qrcodecontainerId=Ext.id(),name:"urls",itemId:"urls",style:"outline: 0;",ctCls:"webfm-sharing-area",plugins:[new SYNO.FileStation.ContainerFlexcrollPlugin()],layout:{type:"hbox",defaultMargins:{top:0,right:25,bottom:8,left:25},pack:"center"},height:268,cls:"selectabletext allowDefCtxMenu sds-selectable-text "}]};var a=new SYNO.ux.FormPanel(b);this.mainPanel=a;this.setQRCodeField();return a},setQRCodeField:function(){var b=null;var a=Ext.getCmp(this.qrcodecontainerId),c;for(c=0;c<this.urls.length;c++){b=new SYNO.FileStation.QRCode({qrcode:"data:image/png;base64,"+this.linkQRCodes[c],description:Ext.util.Format.htmlEncode(this.filenames[c]),url:Ext.util.Format.htmlEncode(this.urls[c]),cls:"webfm-sharing",qrcodeCls:"webfm-sharing-qrcode",logoCls:"webfm-sharing-synology-logo",descriptionCls:"webfm-sharing-description",urlCls:"webfm-sharing-url",qrcodeWrap:true,qrcodeWrapCls:"webfm-sharing-qrcode-wrap",qrcodeAlt:Ext.util.Format.htmlEncode(this.filenames[c]),qrcodeTitle:Ext.util.Format.htmlEncode(this.filenames[c]),width:250,height:248});a.add(b);this.addManagedComponent(b)}a.doLayout()}});Ext.define("SYNO.FileStation.FriendListDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){Ext.apply(this,a||{});this.mainPanel=null;this.friendList=[];this.selectedList=[];this.friendDataStore=new Ext.ux.data.PagingJsonStore({data:[],fields:["id","name","picture","selected"]});this.pageSize=50;this.pagingBar=new SYNO.ux.PagingToolbar({pageSize:this.pageSize,displayInfo:true,showRefreshBtn:false,smallStyle:true,store:this.friendDataStore,listeners:{change:function(d,c){if(this.nextPageToken!==undefined&&this.nextPageToken!==""&&!this.isSearchMode&&c.activePage===c.pages){this.onLoad()}},scope:this}});this.pagingBar.updateInfo=function(){if(this.displayItem){var d=this.store.getCount();var c=(this.ownerCt.ownerCt.totalItems)?this.ownerCt.ownerCt.totalItems:this.store.getTotalCount();var e=d===0?this.emptyMsg:String.format(this.displayMsg,this.cursor+1,this.cursor+d,c);this.displayItem.setText(e)}};var b={owner:this.owner,width:480,autoFlexcroll:false,height:Ext.isGecko?500:480,collapsible:false,resizable:false,tbar:this.initToolbar(),tbarCfg:{cls:"webfm-sharing-tbar"},title:_WFT("sharing","friend_lists"),layout:"fit",items:this.initPanel(),buttons:[{btnStyle:"blue",itemId:"submit_button",text:_T("common","apply"),handler:this.onConfirm,scope:this},{text:_T("common","cancel"),handler:this.onCancel,scope:this}],listeners:{show:function(){if(0===this.cacheFriendList.length){this.onLoad()}else{this.setDataView(this.cacheFriendList)}},scope:this}};this.callParent([b])},initToolbar:function(){var c=this;this.searchField=new SYNO.ux.TextFilter({store:this.friendDataStore,width:300});this.searchField.filter=function(){var d=this.getRawValue();this.store.clearFilter();c.isSearchMode=false;if(0<d.length){c.isSearchMode=true;this.store.filter({property:"name",value:d,anyMatch:true,caseSensitive:false})}c.pagingBar.moveFirst()};var b={owner:this,target:this,items:[this.searchField]};var a=new Ext.Toolbar(b);c.toolBar=a;return a},initPanel:function(){var c=new Ext.XTemplate('<tpl for=".">','<div class="dataviewtag">','<input class="syno-ux-checkbox-icon friend-dialog-checkbox-vertical <tpl if="selected==true">syno-ux-cb-checked</tpl>"','type="button" id="{id}"> ','<img height=26 width=26 src={picture} hspace=10 style="vertical-align:middle">{name}</img>',"</div></tpl>");this.dataView=new SYNO.ux.FleXcroll.DataView({autoFlexcroll:true,store:this.friendDataStore,tpl:c,multiSelect:true,itemSelector:"input",emptyText:"No Friends Return",listeners:{afterrender:function(){this.el.on("click",function(g,h){var f=h.children[0];var e=f.getAttribute("id");var d=this.store.getById(e);if(f.hasClassName("syno-ux-cb-checked")){f.removeClassName("syno-ux-cb-checked");d.data.selected=false}else{f.addClassName("syno-ux-cb-checked");d.data.selected=true}},this,{delegate:"div.dataviewtag"})}}});var b={owner:this,target:this,collapsible:false,autoFlexcroll:false,useGradient:false,layout:"fit",bbar:this.pagingBar,bbarCfg:{cls:"webfm-friend-dialog-bbar-noborder"},items:[this.dataView]};var a=new SYNO.ux.FormPanel(b);this.mainPanel=a;return a},setDataView:function(a){a=a.filter(this.filterCallback,this);this.friendDataStore.loadData(a,true);this.friendDataStore.load({params:{start:this.pagingBar.cursor,limit:this.pageSize}})},filterCallback:function(b){var a=0;for(a=0;a<this.cacheSelectedFriendList.length;a++){if(b.id==this.cacheSelectedFriendList[a].id){return false}}return true},onLoad:function(){var a=this;this.setStatusBusy();this.sendWebAPI({api:"SYNO.SocialAccount.Friend",method:"list",version:1,params:{social_type:a.socialType,next_token:a.nextPageToken},callback:function(f,b,c){if(f){this.caller.friendList[a.socialType]=this.caller.friendList[a.socialType].concat(b.data);this.caller.nextPageToken=b.next_token;this.nextPageToken=b.next_token;this.totalItems=b.total;this.setDataView(b.data);this.clearStatusBusy()}else{var e=_WFT("common","share");var d=_WFT("sharing","social_network_login_hint");this.owner.getMsgBox().confirm(e,d,function(g){if("yes"==g){SYNO.SDS.AppLaunch("SYNO.SDS.App.PersonalSettings.Instance",{tab:"socialAcountForm"})}});this.clearStatusBusy();this.close()}},scope:this})},onConfirm:function(){var a=this;this.dataView.store.clearFilter();this.dataView.store.allData.each(function(b){if(true===b.data.selected){a.selectedList.push(b.data.id)}});this.callback(this.selectedList,this.socialType,this.caller);this.close()},onCancel:function(){this.callback([],this.socialType,this.caller);this.close()}});Ext.define("SYNO.FileStation.NotificationDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){Ext.apply(this,a||{});var b={owner:this.owner,width:700,autoHeight:true,collapsible:false,resizable:false,autoScroll:true,title:_WFT("sharing","notification_title"),buttons:[{btnStyle:"blue",itemId:"submit_button",text:_T("common","send"),handler:this.onConfirm,scope:this},{text:_T("common","skip"),handler:this.onCancel,scope:this}],items:this.initPanel()};return b},initPanel:function(){var b={autoFlexcroll:false,cls:"webfm-superboxselect",items:[{xtype:"syno_displayfield",value:_WFT("sharing","notification_desc")},{xtype:"syno_superboxselect",itemId:"facebooksharelist",name:"facebooksharelist",width:450,displayField:"name",fieldLabel:_WFT("sharing","facebook_desc"),valueField:"id",mode:"local",value:this.facebookValues.toString(),store:new Ext.data.JsonStore({data:this.facebookData,fields:["id","name","picture","selected"]}),listeners:{afterrender:function(c){this.mon(c,"additem",this.doLayout,this);this.mon(c,"removeitem",this.doLayout,this);this.mon(c,"clear",this.doLayout,this)},scope:this}},{xtype:"syno_textarea",itemId:"messagefield",width:450,value:this.urls,fieldLabel:_WFT("sharing","notification_title")}]};var a=new SYNO.ux.FormPanel(b);this.panel=a;return a},onConfirm:function(){var a=this.panel.get("facebooksharelist").getValue();if(0===a.length){this.close();return}this.setStatusBusy();this.sendWebAPI({api:"SYNO.SocialAccount.Message",method:"send",version:1,params:{social_type:"Facebook",to:a,message:this.panel.get("messagefield").getValue(),links:""},callback:function(f,b,c){if(f){this.clearStatusBusy();this.close()}else{this.clearStatusBusy();var e=_WFT("common","share");var d=_WFT("sharing","social_network_login_hint");this.owner.getMsgBox().alert(e,d,function(){SYNO.SDS.AppLaunch("SYNO.SDS.App.PersonalSettings.Instance",{tab:"socialAcountForm"})})}},scope:this})},onCancel:function(){this.close()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.RenameDialog=function(b){this.checkName=true;Ext.apply(this,b||{});var a=this.init();var c={owner:this.owner,width:500,height:180,shadow:true,minWidth:500,minHeight:150,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_rename"),layout:"fit",items:[a],buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.saveNewName},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveNewName,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:function(){this.focusEl=this.RenameForm.form.findField("newname");this.center()},scope:this,single:true}}};this.addEvents({callback:true});SYNO.FileStation.RenameDialog.superclass.constructor.call(this,c)};Ext.extend(SYNO.FileStation.RenameDialog,SYNO.SDS.ModalWindow,{init:function(){var a={labelWidth:75,labelAlign:"top",trackResetOnLoad:true,waitMsgTarget:true,border:false,autoFlexcroll:false,items:[{xtype:"syno_textfield",itemId:"newname",fieldLabel:_WFT("filetable","filetable_enter_newname"),name:"newname",width:400,maxlength:255}],listeners:{actionfailed:{fn:this.closeHandler,scope:this}}};var b=new SYNO.ux.FormPanel(a);this.RenameForm=b;return b},callbackHandler:function(){this.hide();this.fireEvent("callback")},closeHandler:function(){if(this.RenameForm.form.isDirty()){this.getMsgBox().confirm(_WFT("filetable","filetable_rename"),_WFT("common","confirm_lostchange"),function(a){if("yes"==a){this.callbackHandler()}else{return}},this)}else{this.callbackHandler()}},saveNewName:function(){var a="";if(!this.RenameForm||!this.RenameForm.form.findField("newname")){this.closeHandler();return}if(!this.RenameForm.form.isDirty()){this.closeHandler();return}a=this.RenameForm.form.findField("newname").getValue();a=Ext.util.Format.trim(a);if(!a){this.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_empty_name"));return}if(this.checkName){if(!SYNO.webfm.utils.checkFileLen(a)){this.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_long_path"));return}if(SYNO.webfm.utils.isNameReserved(a)){this.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_reserved_name"));return}if(SYNO.webfm.utils.isNameCharIllegal(a)){this.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_reserved_name"));return}}this.newName=a;this.callbackHandler()},resetDialogForm:function(){if(this.RenameForm){this.RenameForm.form.reset()}},getNewName:function(){return this.newName},resetNewName:function(){this.newName=null},setParentDir:function(a){this.parentDir=a},getParentDir:function(){return this.parentDir},setOldName:function(a){this.oldName=a},getOldName:function(){return this.oldName},setCurrentDir:function(a){this.currentDir=a},getCurrentDir:function(){return this.currentDir},setCheckName:function(a){if(SYNO.webfm.utils.isLocalSource(a)){this.checkName=false}else{this.checkName=true}},setDefaultText:function(){var a=this.getOldName();if(a&&this.RenameForm&&this.RenameForm.form.findField("newname")){this.RenameForm.form.setValues({newname:a})}},setIsDir:function(a){this.isDir=a},getIsDir:function(a){return this.isDir},setSelection:function(c,e,b){if(c.createTextRange){var d=b-e;var a=c.createTextRange();a.collapse(true);a.moveStart("character",e);a.moveEnd("character",d);a.select()}else{if(c.setSelectionRange){c.setSelectionRange(e,b)}}c.focus()},setFileNameSelection:function(){var a=this.RenameForm.form.findField("newname").getEl().dom,b=this.getOldName(),c=b.lastIndexOf(".");if(!a){return}else{if(this.getIsDir()===true){this.setSelection(a,0,b.length)}else{if(c!==-1){this.setSelection(a,0,c)}else{this.setSelection(a,0,b.length)}}}},load:function(){this.resetDialogForm();this.resetNewName();this.setDefaultText();this.show();this.setFileNameSelection()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.UploadDialog=function(b){Ext.apply(this,b||{});var a=this.init();var c={owner:this.owner,width:580,height:450,shadow:true,minWidth:580,minHeight:200,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_upload"),layout:"fit",items:a,buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.submitForm},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:function(){this.center()},scope:this,single:true},beforeshow:{fn:function(){this.reset(this.blDisableWriteOption);this.addUpFileForm()},scope:this}}};SYNO.FileStation.UploadDialog.superclass.constructor.call(this,c);this.upFormArr=[]};Ext.extend(SYNO.FileStation.UploadDialog,SYNO.SDS.ModalWindow,{MaxUploadCount:10,limitSize:2147482624,parentDir:null,uploadCnt:0,upFormArr:[],init:function(){var a=new SYNO.ux.FormPanel({autoFlexcroll:false,trackResetOnLoad:true,labelWidth:200,defaults:{style:"padding-top: 10px"},items:[new SYNO.ux.CompositeField({name:"writestrategyComposite",fieldLabel:_WFT("filetable","filetable_same_file"),items:[{xtype:"syno_radio",boxLabel:_WFT("filetable","filetable_skip"),name:"writestrategy",inputValue:"skip",width:100,checked:true},{xtype:"syno_radio",boxLabel:_WFT("filetable","filetable_overwrite"),name:"writestrategy",inputValue:"overwrite",width:100}]})],listeners:{actionfailed:{fn:this.closeHandler,scope:this}}});this.writeStrategyForm=a;var c=_WFT("filetable","filetable_select_max");c=c.replace("_MAXNO_",this.MaxUploadCount);var b=new Ext.Panel({border:false,autoFlexcroll:true,defaults:{border:false,style:"padding-left: 38px; padding-top: 1px; font-size: 12px"},items:[new SYNO.ux.DisplayField({hideLabel:true,autoScroll:false,value:c}),this.writeStrategyForm]});this.formContainer=b;return b},addUpFileForm:function(){if(this.uploadCnt>=this.MaxUploadCount){return}this.uploadCnt++;var a=new Ext.form.Field({synotype:"indent",itemId:"file",fieldLabel:_WFT("upload","upload_file"),name:"file",hiddenName:"file",hideLabel:true,value:"",autoCreate:{tag:"input",type:"file",size:"20",autocomplete:"off"}});var c={autoFlexcroll:false,url:this.UploadCGI,labelWidth:0,labelAlign:"left",fileUpload:true,trackResetOnLoad:true,border:false,items:[new Ext.form.Field({inputType:"hidden",value:"",name:"overwrite",hiddenName:"overwrite"}),new Ext.form.Field({inputType:"hidden",value:"",name:"taskid",hiddenName:"taskid"}),new Ext.form.Field({inputType:"hidden",value:"/AAtest",name:"path",hiddenName:"path"}),{xtype:"syno_compositefield",fieldLabel:_WFT("upload","upload_file"),name:"fileComposite",itemId:"fileComposite",items:[a]}]};var d=new SYNO.ux.FormPanel(c);d.fileField=a;this.formContainer.add(d);this.formContainer.doLayout();var b=this.upFormArr.length;this.onFieldChangeFn=function(){this.onFieldChange(b)};d.mon(a.getEl(),"change",this.onFieldChangeFn,this);this.upFormArr.push(d)},closeHandler:function(){this.close()},testFile:function(){var b=0;for(var a=0;a<this.upFormArr.length;a++){var c=this.upFormArr[a].fileField.getValue();c=Ext.util.Format.trim(c);if(c){b++}}return b},submitForm:function(){var a=0;if(1>(a=this.testFile())){this.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("filetable","filetable_select_one"));return}var b="overwrite"===this.writeStrategyForm.form.getValues().writestrategy;this.hide();SYNO.FileStation.FormUploader.initForm(this,this.upFormArr,b,this.parentDir,a)},setParameters:function(a){this.parentDir=a},reset:function(a){var b=this.writeStrategyForm.getEl();if(a){b.setStyle("display","none")}else{b.setStyle("display","block")}},load:function(a){this.blDisableWriteOption=a;this.show()},onBrowserFileSize:function(a){var b=this.upFormArr[a].fileField.getEl().dom.files[0];return b.fileSize},onCheckFileSize:function(b){var a=-1;if(Ext.isSafari||Ext.isGecko){a=this.onBrowserFileSize(b)}if(a>this.limitSize){this.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("upload","upload_exceed_maximum_filesize"));this.upFormArr[b].fileField.setValue("");return false}return true},onFieldChange:function(a){if(!this.onCheckFileSize(a)){return}var b=this.upFormArr[this.upFormArr.length-1];var c=b.fileField;b.mun(c.getEl(),"change",this.onFieldChangeFn,this);b.mon(c.getEl(),"change",function(){this.onCheckFileSize(a)},this);this.addUpFileForm()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.MountTypeConfig=Ext.extend(Object,{type:undefined,constructor:function(b){var a={iso:{title_list:_WFT("mount","virtual_device"),header_source:_WFT("mount","image_file"),hideProtocol:true},remote:{title_list:_WFT("mount","remote_volume"),header_source:_WFT("mount","server_ip"),hideProtocol:false}};this.type=b;if(this.type in a){Ext.apply(this,a[this.type])}else{throw Error("unknown mount type")}}});SYNO.FileStation.MountGrid=Ext.extend(SYNO.ux.GridPanel,{type:undefined,typeConfig:null,constructor:function(b){Ext.copyTo(this,b,"owner,type,typeConfig,RELURL,itemId");this.createStore();this.createActions();var d=[this.getAction("unmount")];if("iso"===b.type){d.push(this.getAction("remount"))}else{if("remote"===b.type){d.push(this.getAction("reconnect"))}else{throw Error("unknown type")}}var c=new Ext.Toolbar({defaultType:"syno_button",items:d});var a=Ext.apply({title:this.typeConfig.title_list,store:this.getStore(),colModel:this.createColumnModel(),autoExpandColumn:"mount_point",stripeRows:true,keys:this.getHotKeyMap(),selModel:new Ext.grid.RowSelectionModel({singleSelect:false}),tbar:c},b);SYNO.FileStation.MountGrid.superclass.constructor.call(this,a)},initEvents:function(){SYNO.FileStation.MountGrid.superclass.initEvents.apply(this,arguments);this.mon(this.getSelectionModel(),"selectionchange",this.checkState,this,{buffer:50})},createStore:function(){this.store=new Ext.data.JsonStore({root:"items",id:"name",fields:["type","source","mount_point","actor","date","auto_mount"],autoDestroy:true});return this.store},createColumnModel:function(){return new Ext.grid.ColumnModel([{header:_WFT("mount","protocol"),dataIndex:"type",width:80,hidden:this.typeConfig.hideProtocol},{header:this.typeConfig.header_source,dataIndex:"source",width:this.typeConfig.hideProtocol?280:200},{id:"mount_point",header:_WFT("mount","mount_point"),dataIndex:"mount_point",width:200},{header:_WFT("mount","actor"),dataIndex:"actor",width:100},{header:_WFT("mount","mount_date"),dataIndex:"date",width:80,renderer:function(a){if(!a){return""}return(new Date(a*1000)).toLocaleString()}},{header:_WFT("mount","auto_mount"),dataIndex:"auto_mount",renderer:function(a){if(!a){return""}if("yes"===a){return _T("common","yes")}if("no"===a){return _T("common","no")}if("fail"===a){return _T("usbbackup","usbbkp_error")}return""},width:80}])},actions:null,createActions:function(){var a=function(e,d,c,b){return new Ext.Action(Ext.apply({text:e,scope:c,handler:d},b))};this.actions={unmount:a(_WFT("mount","umount"),this.beforeUnMount,this),remount:a(_WFT("common","remount"),this.onRemount,this),reconnect:a(_WFT("common","reconnect"),this.onReconnect,this)};return this.actions},getAction:function(a){if(a in this.actions){return this.actions[a]}else{SYNO.Debug("no this action: "+a);return undefined}},enableAction:function(a,b){var c=this.getAction(a);if(c){c[b?"enable":"disable"]()}},checkState:function(){var a=this.getSelectionModel().getCount();this.enableAction("unmount",0<a);this.enableAction("remount",0<a);this.enableAction("reconnect",0<a)},loadData:function(a){this.getStore().loadData({success:true,items:a});this.checkState()},onRemount:function(){var a=this.ownerCt.getActiveTab().getItemId();this.owner.setStatusBusy({text:_WFT("common","common_plz_wait")});Ext.Ajax.request({url:this.RELURL+"webUI/file_mount_list.cgi",params:{action:"apply",subAction:"remount",mountType:a},method:"POST",scope:this,callback:function(c,e,b){this.owner.clearStatusBusy();var d=this.owner.reportAjaxResponse(e,b,this.owner.ajaxErrorHandler,this.owner);if(!d||!d.success||!d.data){return false}this.owner.webfm.reloadTree();this.owner.loadData(d.data)}})},onReconnect:function(){var a=[];Ext.each(this.getSelectionModel().getSelections(),function(b){a.push(b.get("mount_point"))});this.owner.setStatusBusy({text:_WFT("common","common_plz_wait")});Ext.Ajax.request({url:this.RELURL+"webUI/file_mount_list.cgi",params:{action:"apply",subAction:"reconnect",mountpoint:Ext.encode(a)},method:"POST",scope:this,callback:function(c,e,b){this.owner.clearStatusBusy();var d=this.owner.reportAjaxResponse(e,b,this.owner.ajaxErrorHandler,this.owner);if(!d||!d.success||!d.data){return false}this.owner.webfm.reloadTree();this.owner.loadData(d.data)}})},listeners:{scope:this,afterrender:{fn:function(a){a.getEl().on("keyup",function(c){var b=a.getCmdCode();if(Ext.isArray(b)){a.cmdKeyDown=a.cmdKeyDown&&(b.indexOf(c.getKey())===-1)}else{a.cmdKeyDown=a.cmdKeyDown&&(b!==c.getKey())}},this)}}},onSelectAllRowAction:function(){if(Ext.isMac&&!this.cmdKeyDown){return}this.getSelectionModel().selectAll()},getCmdCode:function(){return SYNO.webfm.utils.getCmdCode()},getHotKeyMap:function(){if(Ext.isMac){var a=this.getCmdCode();this.keys=[{key:a,fn:function(){this.cmdKeyDown=true},scope:this},{key:Ext.EventObject.A,fn:this.onSelectAllRowAction,stopEvent:true,scope:this}]}else{this.keys=[{key:Ext.EventObject.A,ctrl:true,fn:this.onSelectAllRowAction,scope:this}]}return this.keys},beforeUnMount:function(){var a=[];Ext.each(this.getSelectionModel().getSelections(),function(b){a.push(b.get("mount_point"))});this.owner.getMsgBox().confirm(this.title,String.format(_WFT("mount","umount_confirm")+"<br>"+a.join(", "),this.title),function(b){if("yes"===b){this.onUnMount()}},this)},onUnMount:function(){var b=[];var a=this.getSelectionModel().getSelections();Ext.each(a,function(c){b.push(c.get("mount_point"))});this.owner.setStatusBusy({text:_WFT("common","common_plz_wait")});Ext.Ajax.request({url:this.RELURL+"webUI/file_mount_list.cgi",params:{action:"apply",subAction:"unmount",mountpoint:Ext.encode(b)},method:"POST",scope:this,callback:function(d,f,c){var e=this.owner.reportAjaxResponse(f,c,this.owner.ajaxErrorHandler,this.owner);if(!e||!e.success||!e.data){this.owner.clearStatusBusy();return false}this.onUnmountDone(e,b,a);this.owner.webfm.reloadTree();this.owner.loadData(e.data)}})},onUnmountDone:function(f,j,a){var l=[],d=[];var n,k,g=0;var e=false;var h;for(g=0;g<f.data.UseDefPathList.length;g++){if("yes"==f.data.UseDefPathList[g].UseDefPath){e=true;h=new Ext.data.Record({file_id:"",path:"",isdir:true});n=SYNO.webfm.utils.getParentDirArr(j[g]);k=n[0].indexOf("/",1);l.push(n[0].substr(k));h.set("file_id",j[g].substr(k));h.set("path",a[g].get("mount_point"));d.push(h)}}if(e){var m=SYNO.webfm.utils.ParsePairArr(d,"file_id",l).sort(function(o,i){return(o.file<i.file)});var b=[];Ext.each(m,function(i){b.push(SYNO.API.EscapeStr(i.file))});var c={pFiles:SYNO.webfm.utils.ParseArr(d,"file_id"),srcIdArr:SYNO.webfm.utils.getParentDirArr(d)};SYNO.API.currentManager.requestAPI("SYNO.FileStation.Delete","start","1",{path:b.join(","),accurate_progress:true,recursive:false},function(r,q,o,i){this.owner.module.onDeleteSendDone(r,q,c,i);this.owner.clearStatusBusy()},this)}else{this.owner.clearStatusBusy()}}});SYNO.FileStation.MountListDialog=Ext.extend(SYNO.SDS.ModalWindow,{isoTypeConfig:null,remoteTypeConfig:null,constructor:function(b){Ext.copyTo(this,b,"webfm,owner,RELURL");this.isoTypeConfig=new SYNO.FileStation.MountTypeConfig("iso");this.remoteTypeConfig=new SYNO.FileStation.MountTypeConfig("remote");var a=Ext.apply({title:_WFT("mount","mount_list"),width:740,height:400,layout:"fit",buttons:[{text:_WFT("common","close"),scope:this,handler:this.close}],items:[{xtype:"syno_tabpanel",activeTab:0,plain:true,itemId:"tabpanel",items:[new SYNO.FileStation.MountGrid({owner:this,type:"iso",typeConfig:this.isoTypeConfig,RELURL:this.RELURL,itemId:"iso"}),new SYNO.FileStation.MountGrid({owner:this,type:"remote",typeConfig:this.remoteTypeConfig,RELURL:this.RELURL,itemId:"remote"})]}],listeners:{afterlayout:{fn:this.center,scope:this,single:true},beforeshow:{fn:function(){this.load()},scope:this}}},b);SYNO.FileStation.MountListDialog.superclass.constructor.call(this,a)},getTab:function(a){return this.getComponent("tabpanel").getComponent(a)},load:function(){if(!this.el.isMasked()){this.el.mask(_WFT("common","loading"),"x-mask-loading")}this.addAjaxTask({url:this.RELURL+"webUI/file_mount_list.cgi",single:true,autoJsonDecode:true,params:{action:"load",type:this.type},method:"GET",success:function(b,a){this.el.unmask();if(!b||!b.success){this.getMsgBox().alert(this.title,this.formErrinfoString(b,_WFT("common","commfail")),this.close,this);return false}this.loadData(b.data)},scope:this}).start()},loadData:function(a){var b=0;if(!a||!a.mountConfig){return false}if(a.mountConfig.enable_iso_mount){this.getTab("iso").loadData(a.isoList);if(this.webfm.btnMountISO){this.webfm.btnMountISO.show()}if(this.webfm.gridCtxMenu.items.get("gc_mount_iso")){this.webfm.gridCtxMenu.items.get("gc_mount_iso").show()}}else{this.getComponent("tabpanel").hideTabStripItem("iso");this.getComponent("tabpanel").setActiveTab("remote");if(this.webfm.btnMountISO){this.webfm.btnMountISO.hide()}if(this.webfm.gridCtxMenu.items.get("gc_mount_iso")){this.webfm.gridCtxMenu.items.get("gc_mount_iso").hide()}b++}if(a.mountConfig.enable_remote_mount){this.getTab("remote").loadData(a.remoteList);if(this.webfm.btnMountRemote){if(!_S("is_admin")&&!this.webfm.dirTree.getNodeById("remote/home")){this.webfm.btnMountRemote.hide()}else{this.webfm.btnMountRemote.show()}}}else{this.getComponent("tabpanel").hideTabStripItem("remote");if(this.webfm.btnMountRemote){this.webfm.btnMountRemote.hide()}b++}if(2===b){this.getMsgBox().alert(this.title,_WFT("error","error_privilege_not_enough"),this.close,this);if("yes"===_D("supportmount")){this.webfm.btnToolsMenu.menu.hideMountItem()}}else{if("yes"===_D("supportmount")){this.webfm.btnToolsMenu.menu.showMountItem()}}return true},ajaxErrorHandler:function(a){this.getMsgBox().alert(this.title,a)},formErrinfoString:function(c,a){var d=Ext.isString(a)?a:"";if(c&&c.success!==true&&c.errinfo){var b=c.errinfo;if(b.sec in SYNO_FileStation_Strings&&b.key in SYNO_FileStation_Strings[b.sec]){d=_WFT(b.sec,b.key)}else{d=String.format("{0}:{1}",b.sec,b.key)}if(Ext.isNumber(b.line)){d=String.format("{0} ({1})",d,b.line)}}return d},reportAjaxResponse:function(g,b,a,d){var f="";var e=null;if(!g){f=_WFT("common","commfail")}else{if(Ext.isString(b.responseText)){try{e=Ext.decode(b.responseText)}catch(c){SYNO.Debug("exception: responseText:",b.responseText);f="Unknown exception"}}f=this.formErrinfoString(e,f)}if(f&&a){d=d||this;a.call(d,f)}return e}});SYNO.FileStation.MountConfig=Ext.extend(SYNO.ux.FormPanel,{constructor:function(a){var b=this.fillConfig(a);SYNO.FileStation.MountConfig.superclass.constructor.call(this,b);this.mon(this,"afterlayout",function(){if("yes"===_D("supportmount")){SYNO.SDS.Utils.AddTip(this.getForm().findField("rf_allow").getEl(),Ext.util.Format.htmlEncode(_WFT("mount","config_remote_info")))}},this,{single:true})},fillConfig:function(a){var b={border:false,trackResetOnLoad:true,items:[]};if("yes"===_D("supportmount")){b.items.push({xtype:"syno_fieldset",title:_WFT("mount","remote_volume"),items:[{xtype:"syno_displayfield",value:String.format(_WFT("mount","config_desc"),_WFT("mount","remote_volume"))},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","everyone"),name:"rf_allow",inputValue:"everyone"},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","admin"),name:"rf_allow",inputValue:"admin"}]},{xtype:"syno_fieldset",title:_WFT("mount","virtual_device"),items:[{xtype:"syno_displayfield",value:String.format(_WFT("mount","config_desc"),_WFT("mount","virtual_device"))},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","everyone"),name:"vd_allow",inputValue:"everyone"},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","admin"),name:"vd_allow",inputValue:"admin"}]})}if(_S("is_admin")){b.items.push({xtype:"syno_fieldset",title:_WFT("vfs","remote_connection_server"),items:[{xtype:"syno_displayfield",value:_WFT("vfs","config_desc")},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","everyone"),name:"vfs_allow",inputValue:"all"},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","admin"),name:"vfs_allow",inputValue:"admin"},{xtype:"syno_radio",indent:1,boxLabel:_T("sharewizard","access_user"),name:"vfs_allow",inputValue:"custom",handler:this.onCheckChanged,scope:this},{xtype:"syno_button",indent:1,text:_T("sharewizard","access_user"),ref:"../customUserSettingsBtn",disabled:true,scope:this,handler:this.onClickCustomUserSettingsBtn}]})}Ext.apply(b,a||{});return b},onCheckChanged:function(a,b){this.customUserSettingsBtn.setDisabled(b===false)},onClickCustomUserSettingsBtn:function(){var a=new SYNO.FileStation.ProtocolUserConfigDialog({owner:this.findWindow()});a.show()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.MountISODialog=Ext.extend(SYNO.SDS.ModalWindow,{mntPointUserSet:false,title:null,currSubDir:null,subDirName:null,constructor:function(a){Ext.apply(this,a||{});this.mntPointUserSet=false;this.currSubDir=null;this.subDirName=null;this.title=_WFT("filetable","filetable_mount_iso");var c=this.initFileTab();var b={owner:this.owner,width:600,height:300,shadow:true,minWidth:450,minHeight:280,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_mount_iso"),layout:"fit",items:c,buttons:[this.btnMountISO=new SYNO.ux.Button({btnStyle:"blue",text:_WFT("mount","btn_mount"),scope:this,handler:this.onMountISO}),new SYNO.ux.Button({text:_WFT("common","close"),scope:this,handler:this.close})],listeners:{afterlayout:{fn:this.center,scope:this,single:true},beforeshow:{fn:function(){this.SetDefaultDest(this.fileID,this.filename)},scope:this}}};SYNO.FileStation.MountISODialog.superclass.constructor.call(this,b);this.addEvents("mountiso:true")},afterRender:function(){SYNO.FileStation.MountISODialog.superclass.afterRender.call(this,arguments);var b=SYNO.webfm.utils.getParentDirArr(this.rec[0].get("path"));var a=b[0];this.webfm.getCurrDirSubFdr(this,SYNO.webfm.utils.getImageName(this.rec[0].get("filename")),a)},initFileTab:function(){var b={labelWidth:200,trackResetOnLoad:true,border:false,autoScroll:true,items:[{fieldLabel:_WFT("mount","image_file"),xtype:"hidden",itemId:"source",name:"source",value:"",width:200},{xtype:"syno_compositefield",width:330,fieldLabel:_WFT("mount","mount_point"),items:[{xtype:"syno_textfield",width:200,itemId:"mount_point",name:"mount_point",allowBlank:false,readOnly:true,validationEvent:false},{xtype:"syno_button",text:_WFT("mount","browse"),scope:this,handler:this.onChooseDest}]},{xtype:"syno_checkbox",name:"auto_mount",boxLabel:_WFT("mount","auto_mount")},{xtype:"syno_displayfield",value:"&nbsp"},{xtype:"syno_displayfield",value:"<font color=red>"+_WFT("mount","ro_folder")+"</font>"}]};var a=new SYNO.ux.FormPanel(b);this.panel=a;return a},getCurrDirSubFdrCallBack:function(b){this.currSubDir=b;this.SetDefPath();var a=this.webfm.getCurrentDir(),c=SYNO.webfm.utils.getParentDirArr(this.rec[0].get("path"));if(SYNO.webfm.utils.source.remotes===this.webfm.getCurrentSource()){a=c[0]}this.UpdateTargetPath(a+"/"+this.subDirName)},SetDefPath:function(){var d=0;var e=false;var b=SYNO.webfm.utils.getImageName(this.rec[0].get("filename"));var f=false;var a=/^(.+)\((\d+)\)$/;this.subDirName=b;for(d=0;d<this.currSubDir.length;d++){if(this.currSubDir[d].name===b){e=true;continue}var c=this.currSubDir[d].name.match(a);if(c){if(c[1]===b){f=true;this.subDirName=b+"("+(parseInt(c[2],10)+1).toString()+")"}}else{if(false===f){this.subDirName=b+"(2)"}}}if(false===e){this.subDirName=b}else{if(this.subDirName===b){this.subDirName=b+"(2)"}}},onChooseDest:function(){if(!this.TreeDialog||this.TreeDialog.isDestroyed){this.TreeDialog=new SYNO.FileStation.TreeDialog({RELURL:this.RELURL,blDynamicForm:false,blVFSFolder:false,owner:this,webfm:this.webfm,createNode:function(b,c){SYNO.webfm.utils.parseRemoteTreeNode(b,c);if("remotefail"==b.mountType){b.cls=(b.cls||"")+(" node_display_none")}return SYNO.API.TreeLoader.prototype.createNode.call(this,b,c)}});this.TreeDialog.mon(this.TreeDialog,"beforesubmit",this.onCheckDestPrivilege,this);this.TreeDialog.mon(this.TreeDialog,"callback",this.onTreeDialogHide,this)}var a=this.TreeDialog;a.load(_WFT("filetable","filetable_mount_iso"),false,this.gUID,this.gGID)},onCheckDestPrivilege:function(a){var b=this.TreeDialog;if(b){if(_S("is_admin")===true||_S("domainUser")=="true"){return true}if(!SYNO.webfm.utils.checkShareRight(a.shareRight,SYNO.webfm.utils.RW)){b.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("error","error_privilege_not_enough"));return false}if(Ext.isDefined(a.folderRight)){var c={right:a.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Mount};if(!SYNO.webfm.utils.checkFileRight(c)){b.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("error","error_privilege_not_enough"));return false}}return true}},onTreeDialogHide:function(){var a=this.TreeDialog;if(!a){return}var b=a.getParameters();if(b.fdrName){this.UpdateTargetPath(b.fdrName);this.mntPointUserSet=true}},SetDefaultDest:function(e,b){var c=e;var d="",a;this.panel.getForm().findField("source").setValue(e);a=c.lastIndexOf("/");if(a==-1){return false}d=c.substr(0,a)+"/"+SYNO.webfm.utils.getImageName(b)+"/"},UpdateTargetPath:function(a){this.panel.getForm().findField("mount_point").setValue(a)},load:function(a,e,b,c,d){if(""===e||""===a||""===b){return}this.fileID=a;this.isoPath=e;this.gUID=c;this.gGID=d;this.filename=b;this.show().center()},onMountISO:function(){if(!this.panel.getForm().isValid()){return false}this.fireEvent("mountiso")},getSubDirName:function(){return this.subDirName},getMntPointUserSet:function(){return this.mntPointUserSet},getSource:function(){return this.panel.getForm().findField("source").getValue()},getMntPoint:function(){return this.panel.getForm().findField("mount_point").getValue()},getAutoMnt:function(){return this.panel.getForm().findField("auto_mount").getValue()},getFileID:function(){return this.fileID}});Ext.ns("SYNO.FileStation");SYNO.FileStation.MountRemoteDialog=Ext.extend(SYNO.SDS.ModalWindow,{mount_name:"",title:null,subDirName:"",currSubDir:null,mntPointUserSet:false,constructor:function(b){Ext.apply(this,b||{});this.mntPointUserSet=false;this.mount_name="";this.subDirName="";this.currSubDir=null;this.title=_WFT("filetable","filetable_mount_remote_volume");var a=this.initFileTab();var c={owner:this.owner,width:600,height:350,shadow:true,minWidth:450,minHeight:280,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_mount_remote_volume"),layout:"fit",items:a,buttons:[this.btnMountRemote=new SYNO.ux.Button({btnStyle:"blue",text:_WFT("mount","btn_mount"),scope:this,handler:this.onMountRemote}),new SYNO.ux.Button({text:_WFT("common","close"),scope:this,handler:this.close})],listeners:{afterlayout:{fn:this.center,scope:this,single:true},beforeshow:{fn:function(){var d;d=new SYNO.webfm.utils.EnableCheckGroup(this.panel.getForm(),"enable_adv_opt",["adv_opt"])},scope:this}}};SYNO.FileStation.MountRemoteDialog.superclass.constructor.call(this,c);this.addEvents("mountremote:true");this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.panel.getForm().findField("server_ip").getEl(),Ext.util.Format.htmlEncode(String.format(_WFT("mount","example"),"\\\\192.168.1.1\\Share")))},this,{single:true})},getCurrDirSubFdrCallBack:function(a){this.currSubDir=a;this.SetDefPath();this.UpdateTargetPath(this.webfm.getCurrentDir()+"/"+this.subDirName)},SetDefPath:function(){var c=0;var e=false;var f=false;var a=/^(.+)\((\d+)\)$/;var d=SYNO.webfm.utils.source.remote+this.webfm.getCurrentDir();this.subDirName=this.mount_name;if((SYNO.webfm.utils.source.remote!=this.webfm.getCurrentSource())||(!Ext.isDefined(this.webfm.dirTree.getNodeById(d)))||("remotefail"==this.webfm.dirTree.getNodeById(d).attributes.mountType)||SYNO.webfm.VFS.isVFSPath(this.webfm.getCurrentDir())){return}if((false===SYNO.SDS.Session.is_admin&&"/home"!=this.webfm.getCurrentDir())||true===this.mntPointUserSet){return}if(""!==this.mount_name&&this.currSubDir){for(c=0;c<this.currSubDir.length;c++){if(this.currSubDir[c].name===this.mount_name){e=true;continue}var b=this.currSubDir[c].name.match(a);if(b){if(b[1]===this.mount_name){f=true;this.subDirName=this.mount_name+"("+(parseInt(b[2],10)+1).toString()+")"}}else{if(false===f){this.subDirName=this.mount_name+"(2)"}}}if(false===e){this.subDirName=this.mount_name}else{if(this.subDirName===this.mount_name){this.subDirName=this.mount_name+"(2)"}}}},initFileTab:function(){var c=this;var b={labelWidth:200,trackResetOnLoad:true,border:false,autoScroll:true,height:350,items:[{fieldLabel:_WFT("mount","protocol"),xtype:"syno_displayfield",itemId:"protocol",name:"protocol",value:"CIFS",width:200},{fieldLabel:_WFT("mount","server_ip"),xtype:"syno_textfield",width:200,maxlength:255,itemId:"server_ip",name:"server_ip",validationEvent:"keyup",validator:function(d){var i,g;var f=new RegExp("^(\\/\\/|\\\\\\\\)([^\\/\\\\]*)[\\/\\\\]?(.*)");var e=new RegExp("^(localhost|"+_S("hostname")+"|"+_S("hostname")+"\\.local|"+_S("external_ip")+"|127\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})$","i");var h=SYNO.webfm.utils.source.remote+c.webfm.getCurrentDir();g=d.match(f);if(Ext.isEmpty(g)){return _WFT("mount","bad_remote_folder")}i=g[2];if(!Ext.isEmpty(i.match(e))){return _WFT("mount","invalid_local_host")}if(""!==g[3]){c.mount_name=c.findLastSubDir(g[3]);c.subDirName=c.mount_name;if((SYNO.webfm.utils.source.remote!=c.webfm.getCurrentSource())||(!Ext.isDefined(c.webfm.dirTree.getNodeById(h)))||("remotefail"==c.webfm.dirTree.getNodeById(h).attributes.mountType)||SYNO.webfm.VFS.isVFSPath(c.webfm.getCurrentDir())){return true}if((false===SYNO.SDS.Session.is_admin&&"/home"!=c.webfm.getCurrentDir())||true===c.mntPointUserSet){return true}c.SetDefPath();c.UpdateTargetPath(c.webfm.getCurrentDir()+"/"+c.subDirName)}return true}},{xtype:"syno_textfield",fieldLabel:_WFT("mount","acc_name"),width:200,itemId:"acc_name",name:"acc_name"},{xtype:"syno_textfield",textType:"password",fieldLabel:_WFT("mount","passwd"),width:200,itemId:"passwd",name:"passwd"},{xtype:"syno_compositefield",width:330,fieldLabel:_WFT("mount","mount_point"),items:[{xtype:"syno_textfield",width:200,itemId:"mount_point",name:"mount_point",allowBlank:false,readOnly:true,validationEvent:false},{xtype:"syno_button",text:_WFT("mount","browse"),scope:this,handler:this.onChooseDest}]},{xtype:"syno_checkbox",name:"enable_adv_opt",boxLabel:_WFT("mount","adv_opt"),hidden:true},{xtype:"hidden",indent:1,fieldLabel:_WFT("mount","params"),width:200,itemId:"adv_opt",name:"adv_opt"},{xtype:"syno_checkbox",name:"auto_mount",boxLabel:_WFT("mount","auto_mount")}]};var a=new SYNO.ux.FormPanel(b);this.panel=a;return a},findLastSubDir:function(f){var c=f.lastIndexOf("\\");var a=f.lastIndexOf("/");var e=f.split("\\");var d=f.split("/");var b="";if(c===a&&-1==c){b=f}else{b=(c>a)?f.substr(c+1):f.substr(a+1)}if(""===b){b=(c>a)?e[e.length-2]:d[d.length-2]}return b},onChooseDest:function(){if(!this.TreeDialog||this.TreeDialog.isDestroyed){this.TreeDialog=new SYNO.FileStation.TreeDialog({RELURL:this.RELURL,blDynamicForm:false,blVFSFolder:false,owner:this,webfm:this.webfm,createNode:function(a,b){SYNO.webfm.utils.parseRemoteTreeNode(a,b);if(!_S("is_admin")){if("fm_root"!==a.id&&"remote/home"!==a.id&&"remote/home/"!==a.id.substr(0,12)){a.cls=(a.cls||"")+(" node_display_none")}}if("remotefail"==a.mountType){a.cls=(a.cls||"")+(" node_display_none")}return SYNO.API.TreeLoader.prototype.createNode.call(this,a,b)}});this.TreeDialog.mon(this.TreeDialog,"beforesubmit",this.onCheckDestPrivilege,this);this.TreeDialog.mon(this.TreeDialog,"callback",this.onTreeDialogHide,this)}this.TreeDialog.load(_WFT("filetable","filetable_mount_remote_volume"),false,this.gUID,this.gGID)},onCheckDestPrivilege:function(a){var b=this.TreeDialog;if(b){if(_S("is_admin")===true||_S("domainUser")=="true"){return true}if(!SYNO.webfm.utils.checkShareRight(a.shareRight,SYNO.webfm.utils.RW)){b.getMsgBox().alert(_WFT("filetable","filetable_mount_remote_volume"),_WFT("error","error_privilege_not_enough"));return false}if(Ext.isDefined(a.folderRight)){var c={right:a.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Mount};if(!SYNO.webfm.utils.checkFileRight(c)){b.getMsgBox().alert(_WFT("filetable","filetable_mount_remote_volume"),_WFT("error","error_privilege_not_enough"));return false}}return true}},onTreeDialogHide:function(){var a=this.TreeDialog;if(!a){return}var b=a.getParameters();if(b.fdrName){this.UpdateTargetPath(b.fdrName);this.mntPointUserSet=true}},UpdateTargetPath:function(a){this.panel.getForm().findField("mount_point").setValue(a)},load:function(a,b){this.gUID=a;this.gGID=b;this.show().center()},onMountRemote:function(){if(!this.panel.getForm().isValid()){return false}this.fireEvent("mountremote")},getSubDirName:function(){return this.subDirName},getMntPointUserSet:function(){return this.mntPointUserSet},getMountType:function(){return this.panel.getForm().findField("protocol").getValue()},getServerIP:function(){return this.panel.getForm().findField("server_ip").getValue()},getAccount:function(){return this.panel.getForm().findField("acc_name").getValue()},getPasswd:function(){return this.panel.getForm().findField("passwd").getValue()},getMntPoint:function(){return this.panel.getForm().findField("mount_point").getValue()},getAutoMnt:function(){return this.panel.getForm().findField("auto_mount").getValue()},getAdvOpt:function(){if(this.panel.getForm().findField("enable_adv_opt").checked){return this.panel.getForm().findField("adv_opt").getValue()}else{return""}}});Ext.ns("SYNO.FileStation");Ext.define("SYNO.FileStation.RemoteConnection.FormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={editMode:false,keys:[{key:Ext.EventObject.ENTER,fn:function(){if(!this.owner||!Ext.isFunction(this.owner.applyHandler)){return}this.owner.applyHandler()},scope:this}],labelWidth:230,trackResetOnLoad:true,border:false,autoFlexcroll:true,defaults:{width:300},items:[{xtype:"syno_textfield",fieldLabel:_WFT("vfs","ip_fqdn"),itemId:"hostname",name:"hostname",allowBlank:false,hidden:true,enableKeyEvents:true,validator:function(c){if(!c||-1!==c.indexOf("/")||-1!==c.indexOf("://")){return false}return true},listeners:{keyup:function(c,f){if(!this.editMode||f.keyCode===Ext.EventObject.ENTER){return}var g=this.getComponent("account");var d=this.getComponent("password");if(g&&!g.isDirty()){g.setValue("")}if(d&&!d.isDirty()){d.setValue("")}},scope:this}},{xtype:"syno_textfield",fieldLabel:_T("common","port"),itemId:"port",name:"port",vtype:"port",hidden:true,allowBlank:false},{xtype:"syno_textfield",fieldLabel:_WFT("mount","uri_path"),itemId:"uri_path",name:"uri_path",allowBlank:true,hidden:true},{xtype:"syno_textfield",fieldLabel:_WFT("mount","acc_name"),itemId:"account",hidden:true,name:"account"},{xtype:"syno_textfield",fieldLabel:_WFT("mount","passwd"),itemId:"password",name:"password",hidden:true,textType:"password"},{xtype:"syno_combobox",fieldLabel:_WFT("common","lang_codepage"),itemId:"codepage",name:"codepage",hidden:true,value:"UTF-8",valueField:"value",displayField:"name",store:new Ext.data.ArrayStore({fields:["value","name"],data:SYNO.webfm.utils.GetIconvCodepageList()})},{xtype:"syno_textfield",fieldLabel:_WFT("vfs","server_alias"),itemId:"alias",name:"alias",hidden:true,minlength:1,maxlength:255},{xtype:"syno_checkbox",boxLabel:_WFT("vfs","dav_use_ssl"),itemId:"use_ssl",name:"use_ssl",hidden:true,listeners:{check:function(f){var e=SYNO.FileStation.RemoteConnection.Utils.getProtocolInfo("dav");var d=SYNO.FileStation.RemoteConnection.Utils.getProtocolInfo("davs");var c=parseInt(this.getComponent("port").getValue(),10);if(!e||!d){return}if(f.getValue()&&c===e.defaultPort){this.getComponent("port").setValue(d.defaultPort)}else{if(!f.getValue()&&c===d.defaultPort){this.getComponent("port").setValue(e.defaultPort)}}},scope:this}},{xtype:"syno_checkbox",boxLabel:_WFT("vfs","ftp_use_one_connection"),itemId:"use_one_connection",name:"use_one_connection",hidden:true}]};Ext.apply(b,a);return b},getServerID:function(){return this.server_id},getFieldOriginalValue:function(b){var a=this.getForm().findField(b);return a.originalValue},getFieldValue:function(c,b){var a=this.getForm().findField(c);if(b&&!a.isDirty()){return}return a.getValue()},setFieldValue:function(c,b){var a=this.getForm().findField(c);a.setValue(b)},cleanDirtyFlag:function(){this.getForm().setValues(this.getForm().getValues())},isFormDirty:function(){return this.getForm().isDirty()},isFormValid:function(){return this.getForm().isValid()},getTimeFormat:function(e){var b=new Date(e||0);var c=b.getFullYear();var d=b.getMonth()+1;var a=b.getDate();return c+"/"+d+"/"+a},load:function(a){this.server_id=a;SYNO.API.currentManager.requestAPI("SYNO.FileStation.VFS.Profile","get","1",{id:a},function(e,c,d,b){this.fireEvent("loadcomplete");this.applyMode(SYNO.webfm.VFS.getSchemaFromPath(a),true);if(!e){this.findWindow().getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,c,b));return}c.password="12345678";c.use_one_connection=1===c.max_connection?true:false;this.getForm().setValues(c)},this)},applyMode:function(k,h){var i=this.getForm().findField("hostname");var g=this.getForm().findField("port");var e=this.getForm().findField("uri_path");var f=this.getForm().findField("account");var c=this.getForm().findField("password");var j=this.getForm().findField("codepage");var b=this.getForm().findField("alias");var d=this.getForm().findField("use_ssl");var a=this.getForm().findField("use_one_connection");if(!h){g.setValue(SYNO.FileStation.RemoteConnection.Utils.getProtocolInfo(k).defaultPort)}b.setDisabled(false).setVisible(true);this.protocol=k;switch(k){case"ftp":case"sftp":i.setDisabled(false).setVisible(true);g.setDisabled(false).setVisible(true);e.setDisabled(true).setVisible(false);f.setDisabled(false).setVisible(true);c.setDisabled(false).setVisible(true);j.setDisabled(false).setVisible(true);d.setDisabled(true).setVisible(false);a.setDisabled(false).setVisible(true);break;case"dav":case"davs":i.setDisabled(false).setVisible(true);g.setDisabled(false).setVisible(true);e.setDisabled(false).setVisible(true);f.setDisabled(false).setVisible(true);c.setDisabled(false).setVisible(true);j.setDisabled(false).setVisible(true);d.setDisabled(this.editMode?true:false).setVisible(this.editMode?false:true);a.setDisabled(true).setVisible(false);break;default:i.setDisabled(true).setVisible(false);g.setDisabled(true).setVisible(false);e.setDisabled(true).setVisible(false);f.setDisabled(true).setVisible(false);c.setDisabled(true).setVisible(false);j.setDisabled(true).setVisible(false);d.setDisabled(true).setVisible(false);a.setDisabled(true).setVisible(false);break}}});Ext.define("SYNO.FileStation.RemoteConnection.ProfileGrid",{extend:"SYNO.ux.GridPanel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={autoScroll:true,store:this.getStore(),colModel:this.getColumnModel(),selModel:this.getSelectionModel(),tbar:this.getToolbar(),listeners:{rowdblclick:this.onEditBtnClicked,scope:this}};Ext.apply(b,a);return b},getStore:function(){if(!Ext.isDefined(this.protocolStore)){this.protocolStore=new Ext.data.Store({autoLoad:true,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.VFS.Profile",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"profiles"},[{name:"protocol",mapping:"protocol_name"},{name:"protocol_value",mapping:"protocol"},{name:"uri"},{name:"hostname"},{name:"port"},{name:"alias"},{name:"account"},{name:"codepage"},{name:"connect_status"}]),remoteSort:true,paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},sortInfo:{field:"alias",direction:"ASC"},listeners:{scope:this,beforeload:function(){if(this.getEl()){this.getEl().mask(_WFT("common","loading"),"x-mask-loading")}return true},load:function(){if(this.getEl()){this.getEl().unmask()}this.checkButtonState()},exception:function(d,b,f,c,e,a){if(this.getEl()){this.getEl().unmask()}this.findWindow().getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,e,c))}}})}return this.protocolStore},getColumnModel:function(){if(!Ext.isDefined(this.protocolColumnModel)){this.protocolColumnModel=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:[{header:_WFT("vfs","server_alias"),dataIndex:"alias",width:160},{header:_WFT("mount","protocol"),dataIndex:"protocol",width:130},{header:_WFT("vfs","uri"),dataIndex:"uri",width:250},{header:_WFT("vfs","ip_fqdn"),dataIndex:"hostname",width:180,hidden:true},{header:_T("common","port"),dataIndex:"port",width:80,hidden:true},{header:_WFT("mount","acc_name"),dataIndex:"account",width:120,renderer:function(f,d,a,c,e,b){return(""===f)?"("+_WFT("vfs","acc_anonymous")+")":f}},{header:_WFT("common","lang_codepage"),dataIndex:"codepage",width:120},{header:_WFT("vfs","connect_status"),dataIndex:"connect_status",width:160,renderer:function(f,d,a,c,e,b){return 1===f?_WFT("vfs","server_connected"):_WFT("vfs","server_disconnected")}}]})}return this.protocolColumnModel},getSelectionModel:function(){if(!Ext.isDefined(this.protocolSelectionModel)){this.protocolSelectionModel=new Ext.grid.RowSelectionModel({listeners:{selectionchange:{fn:this.checkButtonState,scope:this}}})}return this.protocolSelectionModel},getToolbar:function(){if(!Ext.isDefined(this.protocolToolbar)){this.protocolToolbar=new Ext.Toolbar({defaultType:"syno_button",items:[{text:_WFT("vfs","connect"),itemId:"connectBtn",disabled:true,handler:this.onConnectBtnClicked,scope:this},{text:_WFT("vfs","disconnect"),itemId:"diconnectBtn",disabled:true,handler:this.onDisconnectBtnClicked,scope:this},{text:_WFT("vfs","edit_profile"),itemId:"editBtn",disabled:true,handler:this.onEditBtnClicked,scope:this},{text:_WFT("vfs","remove_profile"),itemId:"removeBtn",disabled:true,handler:this.onRemoveBtnClicked,scope:this}]})}return this.protocolToolbar},checkButtonState:function(){var d;var c=this.getToolbar().getComponent("removeBtn");var f=this.getToolbar().getComponent("diconnectBtn");var g=this.getToolbar().getComponent("editBtn");var a=this.getToolbar().getComponent("connectBtn");var b=this.getSelectionModel().getCount();var e=this.getSelectionModel().getSelections();f.setDisabled(true);a.setDisabled(true);if(0<b){c.setDisabled(false);g.setDisabled(1===b?false:true);a.setDisabled(1===b?false:true);for(d=0;d<e.length;d++){if(1===e[d].get("connect_status")){f.setDisabled(false);break}}}else{c.setDisabled(true);g.setDisabled(true)}},onDisconnectBtnClicked:function(){var c=this.getSelectionModel().getSelections();var a,b=[];for(a=0;a<c.length;a++){b.push(c[a].id)}SYNO.FileStation.RemoteConnection.Utils.deleteServer(b,true,this.findWindow(),function(g,d,f,e){if(!g||d.has_fail){return}this.getStore().reload();this.findWindow().webfm.FileAction.fireEvent("refreshTreeNode",[""],null,null,true)},this)},onRemoveBtnClicked:function(){var a=this.getSelectionModel().getSelections();this.findWindow().getMsgBox().confirmDelete("",_WFT("vfs","confirm_remove_profile"),function(b){if("yes"!==b){return}var c,d=[];for(c=0;c<a.length;c++){d.push(a[c].id)}SYNO.FileStation.RemoteConnection.Utils.deleteServer(d,false,this.findWindow(),function(m,e,j,h){var f,l,k={};this.getStore().reload();for(f=0;f<j.compound.length;f++){l=SYNO.webfm.VFS.getSchemaFromPath(j.compound[f].id);if(!Ext.isDefined(k[l])){this.findWindow().webfm.FileAction.fireEvent("refreshVFSTreeNode",Ext.emptyFn,this,l);k[l]=true}}if(!m||e.has_fail){var g=SYNO.API.Util.GetFirstError(e);this.findWindow().getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,g))}},this)},this)},onEditBtnClicked:function(){var b=this.getSelectionModel().getSelected().id;var a=new SYNO.FileStation.RemoteConnection.EditDialog({owner:this.findWindow(),title:_WFT("vfs","edit_profile")});this.mon(a,"editcomplete",function(){this.getStore().reload()},this);a.load(b)},connectByProfileID:function(a){SYNO.FileStation.RemoteConnection.Utils.createServer(false,{profile_id:a},true,this.findWindow(),function(){this.getStore().reload()},this)},onConnectBtnClicked:function(){var a=this.getSelectionModel().getSelected();if(!a){return}this.connectByProfileID(a.id)}});Ext.define("SYNO.FileStation.RemoteConnection.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);this.addEvents({editcomplete:true})},fillConfig:function(a){var b={width:600,height:350,shadow:true,minWidth:350,minHeight:280,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,layout:"fit",items:this.getConnectionFormPanel(a),buttons:[this.btnOK=new SYNO.ux.Button({btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.applyHandler}),new SYNO.ux.Button({text:_WFT("common","cancel"),scope:this,handler:this.close})]};Ext.apply(b,a);return b},getConnectionFormPanel:function(){if(!Ext.isDefined(this.connectionFormPanel)){this.connectionFormPanel=new SYNO.FileStation.RemoteConnection.FormPanel({editMode:true,owner:this})}return this.connectionFormPanel},onRender:function(){this.callParent(arguments);this.mon(this.getConnectionFormPanel(),{loadcomplete:function(){this.clearStatusBusy()},scope:this})},load:function(a){this.getConnectionFormPanel().load(a);this.show().center()},editProfile:function(c){var b,a=this.getConnectionFormPanel();if(!a.isFormValid()){return false}if(!a.isFormDirty()){this.close();return}b={id:a.getServerID(),hostname:a.getFieldValue("hostname").trim(),port:a.getFieldValue("port"),alias:a.getFieldValue("alias")||a.getFieldValue("hostname").trim(),account:a.getFieldValue("account"),codepage:a.getFieldValue("codepage"),uri_path:a.getFieldValue("uri_path"),max_connection:a.getFieldValue("use_one_connection")?1:0};if(a.getFieldValue("password",true)){b.password=a.getFieldValue("password",true)}SYNO.FileStation.RemoteConnection.Utils.editServer(false,b,this.findWindow(),function(g,d,f,e){this.fireEvent("editcomplete");this.close()},this)},applyHandler:function(){this.editProfile(false)}});Ext.ns("SYNO.FileStation.RemoteConnection");SYNO.FileStation.RemoteConnection.Utils={};Ext.apply(SYNO.FileStation.RemoteConnection.Utils,{createServer:function(e,a,c,f,h,b){var g;if(!c){g={protocol:a.protocol,client_id:a.client_id,hostname:a.hostname?a.hostname.trim():"",port:a.port,alias:a.alias||(a.hostname?a.hostname.trim():""),account:a.account,password:a.password,codepage:a.codepage,uri_path:a.uri_path,access_token:a.access_token,refresh_token:a.refresh_token,expires_in:a.expires_in,max_connection:a.max_connection}}else{g={profile_id:a.profile_id}}var d=[{api:"SYNO.FileStation.VFS.Connection",method:"create",version:1,params:Ext.apply(g,{force:e?true:false})}];if(!c){d.push({api:"SYNO.FileStation.VFS.Profile",method:"create",version:1,params:g})}f.setStatusBusy({text:_WFT("common","common_plz_wait")});SYNO.API.Request({params:{},compound:{stopwhenerror:true,params:d},encryption:["password","access_token","refresh_token"],scope:this,callback:function(n,i,m,l){f.clearStatusBusy();if(!n||i.has_fail){var k=SYNO.API.Util.GetFirstError(i);var j=[2107,2112,2115];if(k&&(-1!==j.indexOf(k.code))){var o=function(){SYNO.FileStation.RemoteConnection.Utils.createServer(true,a,c,f,h,b)};SYNO.webfm.utils.handleRemoteConnectionException(i,{id:m.compound[0].profile_id},f,o,Ext.emptyFn,this,true)}else{f.getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,k))}return}f.webfm.FileAction.fireEvent("refreshVFSTreeNode",Ext.emptyFn,this,m.compound[0].protocol);h.apply(b,[n,i,m,l])}})},editServer:function(d,a,e,g,b){e.setStatusBusy({text:_WFT("common","common_plz_wait")});var f={id:a.id,hostname:a.hostname?a.hostname.trim():"",port:a.port,alias:a.alias||(a.hostname?a.hostname.trim():""),account:a.account,password:a.password,codepage:a.codepage,uri_path:a.uri_path,max_connection:a.max_connection};var c=[{api:"SYNO.FileStation.VFS.Connection",method:"set",version:1,params:Ext.apply(f,{force:d?true:false})},{api:"SYNO.FileStation.VFS.Profile",method:"set",version:1,params:f}];SYNO.API.Request({params:{},compound:{stopwhenerror:true,params:c},encryption:["password","access_token","refresh_token"],scope:this,callback:function(m,h,l,k){e.clearStatusBusy();if(!m||h.has_fail){var j=SYNO.API.Util.GetFirstError(h);var i=[2107,2112,2115];if(j&&(-1!==i.indexOf(j.code))){SYNO.webfm.utils.handleRemoteConnectionException(h,{id:l.compound[0].id},e,function(){this.editServer(true,a,e,g,b)},Ext.emptyFn,this)}else{e.getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,j))}return}e.findAppWindow().panelObj.FileAction.fireEvent("refreshVFSTreeNode",Ext.emptyFn,this,SYNO.webfm.VFS.getSchemaFromPath(l.compound[0].id));g.apply(b,[m,h,l,k])}})},deleteServer:function(d,c,f,g,b){var a,e=[];for(a=0;a<d.length;a++){e.push({api:"SYNO.FileStation.VFS.Connection",method:"delete",version:1,params:{id:d[a]}});if(!c){e.push({api:"SYNO.FileStation.VFS.Profile",method:"delete",version:1,params:{id:d[a]}})}}f.setStatusBusy({text:_WFT("common","common_plz_wait")});SYNO.API.Request({params:{},compound:{stopwhenerror:false,params:e},scope:this,callback:function(k,h,j,i){f.clearStatusBusy();g.apply(b,[k,h,j,i])}})},ProtocolInfo:[],getProtocolInfo:function(b){for(var a=0;a<this.ProtocolInfo.length;a++){if(b!==this.ProtocolInfo[a].protocol){continue}return Ext.apply({},this.ProtocolInfo[a])}return null},isCloudServer:function(b){var a=["google","dropbox","baidu","onedrive","box"];return -1!==a.indexOf(b)}});Ext.define("SYNO.FileStation.RemoteConnection.ChooseType",{extend:"SYNO.ux.Panel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){this.protocolStore=new Ext.data.Store({autoLoad:false,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.VFS.Protocol",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"protocols"},[{name:"protocol",mapping:"protocol"},{name:"name",mapping:"name"},{name:"defaultPort",mapping:"default_port"},{name:"is_cloud",convert:function(d,c){return SYNO.FileStation.RemoteConnection.Utils.isCloudServer(c.protocol)?1:0}}]),listeners:{load:function(f,c,e){f.multiSort([{field:"is_cloud",direction:"DESC"},{field:"name",direction:"ASC"}]);f.filterBy(function(g,h){switch(g.get("protocol")){case"davs":return false;case"dav":g.set("name",_WFT("vfs","dav_davs_name"));return true;default:return true}});for(var d=0;d<c.length;d++){SYNO.FileStation.RemoteConnection.Utils.ProtocolInfo.push(c[d].data)}this.getChooseConnectionDataView().select(0);this.fireEvent("loadcomplete")},exception:function(){this.fireEvent("loadcomplete")},scope:this}});var b={headline:_WFT("vfs","wizard_choose_type_headline"),description:_WFT("vfs","wizard_choose_type_desc"),layout:"fit",items:[this.getChooseConnectionPanelCt()]};Ext.apply(b,a);return b},getChooseConnectionPanelCt:function(){if(!Ext.isDefined(this.chooseConnectionPanelCt)){this.chooseConnectionPanelCt=new SYNO.ux.Panel({layout:"fit",autoFlexcroll:true,items:this.getChooseConnectionDataView()})}return this.chooseConnectionPanelCt},getChooseConnectionDataView:function(){if(!Ext.isDefined(this.chooseConnectionDataView)){this.chooseConnectionDataView=new SYNO.ux.FleXcroll.DataView({store:this.protocolStore,tpl:new Ext.XTemplate('<tpl for=".">','<div class="webfm-remote-server-provider-template">','<div class="icon-wrapper">','<div class="icon-ct-{protocol}"></div>',"</div>",'<div class="title-wrapper">',"<strong>{name}</strong>","</div>","</div>","</tpl>"),singleSelect:true,itemSelector:"div.webfm-remote-server-provider-template",cls:"webfm-remote-server-dataview",overClass:"provider-over",listeners:{scope:this,dblclick:function(){if(_S("demo_mode")===true){this.owner.getMsgBox().alert("",_JSLIBSTR("uicommon","error_demo"));return}this.owner.goNext(this.getNext())}},getTemplateTarget:function(){var a=this;a.scrollBar=a.scrollBar||a.el.createChild({tag:"div",style:"width:100%;display:inline-block;"});return a.scrollBar}})}return this.chooseConnectionDataView},load:function(){this.protocolStore.reload()},getNext:function(){if(_S("demo_mode")===true){this.owner.getMsgBox().alert("",_JSLIBSTR("uicommon","error_demo"));return}if(1!==this.getChooseConnectionDataView().getSelectionCount()){return false}var a=this.getChooseConnectionDataView().getSelectedRecords()[0].get("protocol");this.owner.setServerType(a);if(!SYNO.FileStation.RemoteConnection.Utils.isCloudServer(a)){return"vfs_setting"}else{SYNO.webfm.utils.startOAuth(a,function(b){b.protocol=a;SYNO.FileStation.RemoteConnection.Utils.createServer(false,b,false,this.owner,function(h,c,f,e){if(!h||c.has_fail){return}var d=c.result[0].data;var g=SYNO.FileStation.RemoteConnection.Utils.getProtocolInfo(f.compound[0].protocol);d.cloud_name=g?g.name:"";this.owner.CloudSummaryPanel.load(d);this.owner.setActiveStep("cloud_summary")},this)},this);return false}}});Ext.define("SYNO.FileStation.RemoteConnection.VFSSetting",{extend:"SYNO.ux.Panel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={headline:_WFT("vfs","wizard_vfs_setting_headline"),description:_WFT("vfs","wizard_vfs_setting_desc"),layout:"fit",items:[this.formPanel=new SYNO.FileStation.RemoteConnection.FormPanel({owner:this})],listeners:{beforeshow:function(){this.formPanel.applyMode(this.owner.getServerType())},scope:this}};Ext.apply(b,a);return b},applyHandler:function(){this.getNext()},getNext:function(){if(!this.formPanel.isFormValid()){return false}var a=this.formPanel.getForm().getValues();a.protocol=this.owner.getServerType();if("dav"===a.protocol&&("true"===a.use_ssl||true===a.use_ssl)){a.protocol="davs"}a.max_connection=("true"===a.use_one_connection)?1:0;SYNO.FileStation.RemoteConnection.Utils.createServer(false,a,false,this.owner,function(e,b,d,c){this.owner.close()},this);return false},getBack:function(){return"choose_type"}});Ext.define("SYNO.FileStation.RemoteConnection.CloudSummary",{extend:"SYNO.ux.Panel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={headline:_WFT("vfs","wizard_cloud_summary_headline"),description:_WFT("vfs","wizard_cloud_summary_desc"),layout:"fit",items:[this.formPanel=new SYNO.ux.FormPanel({items:[{xtype:"syno_displayfield",value:_WFT("vfs","wizard_cloud_summary_greeting")},{xtype:"syno_displayfield",name:"cloud_name",fieldLabel:_WFT("vfs","cloud_name")},{xtype:"syno_displayfield",name:"email",fieldLabel:_WFT("mount","acc_name")}]})],listeners:{beforeshow:function(){this.owner.getButton("next").hide();this.owner.getButton("cancel").setText(_T("common","close"));this.owner.syncView()},scope:this}};Ext.apply(b,a);return b},load:function(a){this.formPanel.getForm().setValues(a)}});Ext.define("SYNO.FileStation.RemoteConnection.Wizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b=[this.chooseTypePanel=new SYNO.FileStation.RemoteConnection.ChooseType({itemId:"choose_type"}),this.VFSSettingPanel=new SYNO.FileStation.RemoteConnection.VFSSetting({itemId:"vfs_setting",nextId:null}),this.CloudSummaryPanel=new SYNO.FileStation.RemoteConnection.CloudSummary({itemId:"cloud_summary",nextId:null})];var c={title:_WFT("vfs","wizard_title"),cls:"webfm-remote-server-setup-wizard",showHelp:false,width:620,height:476,steps:b};Ext.apply(c,a);return c},onOpen:function(){this.setActiveStep("choose_type");SYNO.FileStation.RemoteConnection.Wizard.superclass.onOpen.apply(this,arguments)},onRender:function(){SYNO.FileStation.RemoteConnection.Wizard.superclass.onRender.apply(this,arguments);this.mon(this.chooseTypePanel,{loadcomplete:function(){this.syncView();this.clearStatusBusy()},scope:this})},setServerType:function(a){this.serverType=a},getServerType:function(){return this.serverType},load:function(){this.chooseTypePanel.load();this.show().center()}});Ext.define("SYNO.FileStation.RemoteConnection.ServerListDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={width:810,height:470,shadow:true,minWidth:550,minHeight:350,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("vfs","server_list"),layout:"fit",items:[this.serverListGridPanel=new SYNO.FileStation.RemoteConnection.ProfileGrid({owner:this,title:_WFT("vfs","server_list")})],buttons:[new SYNO.ux.Button({text:_WFT("common","close"),scope:this,handler:this.close})]};Ext.apply(b,a);return b},load:function(){this.show().center()},applyHandler:function(){this.serverListGridPanel.applyHandler()}});Ext.namespace("SYNO.FileStation");Ext.define("SYNO.FileStation.ProtocolUserGrid",{extend:"SYNO.ux.GridPanel",pageSize:100,DEFAULT_ROLES:[["local",_T("share","share_local_user")]],LDAP_ROLES:[["ldap",_T("share","ldap_user")]],DOMAIN_ROLES:[["domain",_T("share","share_domain_user")]],constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={title:_WFT("vfs","user_and_protocol"),enableHdMenu:false,colModel:this.getColModel(),plugins:[this.getColumnEnabled()],tbar:this.getToolbar(),bbar:new SYNO.ux.PagingToolbar({pageSize:this.pageSize,store:this.getUserStore(),displayInfo:true}),store:this.getUserStore()};Ext.apply(b,a);return b},getColModel:function(){if(!Ext.isDefined(this.columnModel)){this.columnModel=new Ext.grid.ColumnModel({defaults:{align:"center",sortable:false},columns:[this.getColumnEnabled(),{header:_T("common","name"),dataIndex:"name",align:"left",width:160}]})}return this.columnModel},getColumnEnabled:function(){if(!Ext.isDefined(this.columnEnabled)){this.columnEnabled=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enabled",disableSelectAll:true,width:120,isIgnore:function(b,a){return !a.get("is_modifiable")},renderer:function(c,b,a){if(a.get("is_modifiable")){return SYNO.ux.EnableColumn.prototype.renderer.call(this,c)}else{if(a.get("enabled")){return'<div class="syno-ux-grid-enable-column-disabled-checked">&nbsp;</div>'}else{return'<div class="syno-ux-grid-enable-column-disabled">&nbsp;</div>'}}}})}return this.columnEnabled},getToolbar:function(){if(!Ext.isDefined(this.protocolUserToolbar)){this.protocolUserToolbar=new Ext.Toolbar({items:[this.getRoleComboBox(),"->",this.getDomainListLabel(),this.getDomainListComboBox(),this.getUsernameFilter()]})}return this.protocolUserToolbar},getRoleComboBox:function(){if(!Ext.isDefined(this.roleComboBox)){this.roleComboBox=new SYNO.ux.ComboBox({valueField:"role",displayField:"display",store:this.getRoleStore(),mode:"local",editable:false,forceSelection:true,width:200,listeners:{scope:this,select:function(c,a,b){this.setDomainFilterVisible("domain"===a.get("role"));this.getUserStore().load({params:{offset:0}})}}})}return this.roleComboBox},getDomainListLabel:function(){if(!Ext.isDefined(this.domainListLabel)){this.domainListLabel=new SYNO.ux.DisplayField({value:_T("helptoc","directory_service_domain")+":",hidden:true})}return this.domainListLabel},getDomainListComboBox:function(){if(!Ext.isDefined(this.domainListComboBox)){this.domainListComboBox=new SYNO.ux.ComboBox({valueField:"value",displayField:"domain",store:{xtype:"arraystore",autoDestroy:true,fields:["domain","value","comment"]},hidden:true,mode:"local",editable:false,value:"",forceSelection:true,tpl:'<tpl for="."><div ext:qtip="{comment}" class="x-combo-list-item">{domain}</div></tpl>',listeners:{scope:this,select:function(){this.getUserStore().load({params:{offset:0}})}}})}return this.domainListComboBox},getUsernameFilter:function(){if(!Ext.isDefined(this.usernameFilter)){this.usernameFilter=new SYNO.ux.TextFilter({iconStyle:"filter",emptyText:_WFT("filetable","filetable_search"),store:this.getUserStore(),queryParam:"substr",pageSize:this.pageSize})}return this.usernameFilter},getUserStore:function(){if(!Ext.isDefined(this.userStore)){this.userStore=new Ext.data.Store({autoLoad:false,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.VFS.User",method:"get",version:1}),reader:new Ext.data.JsonReader({root:"user_settings"},[{name:"name"},{name:"enabled"},{name:"uid"},{name:"is_modifiable"}]),baseParams:{content:"user_settings",offset:0,limit:this.pageSize},paramNames:{start:"offset",limit:"limit"},listeners:{scope:this,exception:function(d,b,f,c,e,a){this.findWindow().clearStatusBusy();this.findWindow().getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,e,c))},beforeload:function(a,b){if(!this.isChanged()){b.params.type=this.getRoleComboBox().getValue();if("domain"===b.params.type){b.params.domain=this.getDomainListComboBox().getValue()}else{delete b.params.domain}this.findWindow().setStatusBusy({text:_T("common","loading")});return true}this.findWindow().getMsgBox().confirm(this.title,_WFT("vfs","save_chg_before_reload"),function(d){var c=this.getUserStore();if("yes"===d){this.submitChanges(b)}else{c.rejectChanges();c.load(b)}},this);return false},load:function(){this.findWindow().clearStatusBusy()}}})}return this.userStore},getRoleStore:function(){if(!Ext.isDefined(this.roleStore)){this.roleStore=new Ext.data.ArrayStore({autoDestroy:true,fields:["role","display"]});this.roleStore.loadData(this.DEFAULT_ROLES)}return this.roleStore},setDomainFilterVisible:function(a){this.getDomainListLabel().setVisible(a);this.getDomainListComboBox().setVisible(a)},loadRoles:function(f){var e=SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Directory.LDAP","get","enable_client");var d=SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Directory.Domain","get","enable_domain");var a=SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Directory.Domain","test_dc","test_join_success");var b=this._D("supportdomain")==="yes"?SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Directory.Domain","get_domain_list","domain_list"):[];var c=[];if(e){this.getRoleStore().loadData(this.LDAP_ROLES,true)}if(d&&a){this.getRoleStore().loadData(this.DOMAIN_ROLES,true);b.each(function(g){if(typeof g==="object"){c.push(g)}else{c.push([g,g,g])}});this.getDomainListComboBox().getStore().loadData(c);if(!this.getDomainListComboBox().getValue()){this.getDomainListComboBox().setValue(c[0][1])}if(1===SYNO.API.Util.GetValByAPI(f,"SYNO.Core.Directory.Domain","get","manage_mode")){this.getDomainListLabel().setValue(_T("directory_service","organizational_unit")+": ")}else{this.getDomainListLabel().setValue(_T("helptoc","directory_service_domain")+": ")}}this.roleComboBox.setValue("local");this.getUserStore().load()},isChanged:function(){return(this.getUserStore().getModifiedRecords().length!==0)},getSubmitParams:function(){var b=this.getUserStore().getModifiedRecords();var a=[],d={settings:{}};if(0===b.length){return null}for(var c=0;c<b.length;c++){a.push({uid:b[c].get("uid"),enabled:b[c].get("enabled")})}d.settings.user_settings=a;return d},submitChanges:function(a,b){var c=this.getSubmitParams();if(!c){if(true===b){this.findWindow().close()}else{return}}this.findWindow().setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:"SYNO.FileStation.VFS.User",method:"set",version:1,params:c,load_options:a,scope:this,callback:function(h,f,g,e){var d=this.getUserStore();this.findWindow().clearStatusBusy();if(!h){this.findWindow().getMsgBox().alert(SYNO.webfm.utils.getWebAPIErr(false,f))}else{d.commitChanges();if(Ext.isDefined(e.load_options)){d.load(e.load_options)}else{if(true===b){this.findWindow().close()}}}}})}});Ext.define("SYNO.FileStation.ProtocolUserConfigDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b])},fillConfig:function(a){var b={width:800,height:600,title:_T("sharewizard","access_user"),shadow:true,minWidth:700,minHeight:500,collapsible:false,layout:"fit",items:this.protocolUserGrid=new SYNO.FileStation.ProtocolUserGrid({}),buttons:[this.btnOK=new SYNO.ux.Button({btnStyle:"blue",text:_T("common","ok"),scope:this,handler:this.applyHandler}),new SYNO.ux.Button({text:_WFT("common","cancel"),scope:this,handler:this.close})],listeners:{afterrender:function(){var d=[{api:"SYNO.Core.Directory.LDAP",method:"get",version:1},{api:"SYNO.Core.Directory.Domain",method:"get",version:1},{api:"SYNO.Core.Directory.Domain",method:"test_dc",version:1}];if("yes"===this._D("supportdomain")){var c={api:"SYNO.Core.Directory.Domain",method:"get_domain_list",version:1};if(this._S("version")>4959){c.version=2}d.push(c)}this.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({params:{},compound:{stopwhenerror:false,params:d},scope:this,callback:function(h,e,g,f){this.clearStatusBusy();this.protocolUserGrid.loadRoles(e)}})},scope:this}};Ext.apply(b,a||{});return b},applyHandler:function(){this.protocolUserGrid.submitChanges(undefined,true)}});Ext.ns("SYNO.FileStation");SYNO.FileStation.SharingSummaryWindow=function(a){Ext.apply(this,a||{});var b={owner:this.owner,width:550,height:425,minWidth:500,minHeight:250,shadow:true,collapsible:false,title:_WFT("sharing","sharing_links"),layout:"fit",trackResetOnLoad:true,forceSelection:true,waitMsgTarget:true,border:false,items:this.initPanel(),buttons:[{itemId:"close_button",text:_WFT("common","close"),scope:this,handler:function(){this.close()}}]};SYNO.FileStation.SharingSummaryWindow.superclass.constructor.call(this,b);this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.get("textarea").get("share_link_message").getEl(),_WFT("sharing","mailto_desc"))},this,{single:true})};Ext.extend(SYNO.FileStation.SharingSummaryWindow,SYNO.SDS.ModalWindow,{initPanel:function(){var b={itemId:"textarea",border:false,items:[{xtype:"syno_displayfield",width:"auto",itemId:"share_link_message",value:String.format(_WFT("sharing","full_instruction"),"<a class='pathlink'>"+_WFT("common","buildin_mail")+"</a>","<a class='pathlink'>"+_WFT("common","mail")+"</a>"),listeners:{render:function(c){this.mon(c.el.child("a:nth-child(1)"),"click",this.onBuildInMail,this);this.mon(c.el.child("a:nth-child(2)"),"click",this.onMail,this)},scope:this,single:true,buffer:80}},{xtype:"syno_textarea",name:"urls",itemId:"urls",layout:"fit",hideLabel:true,anchor:"99% 80%",value:this.content,cls:"selectabletext allowDefCtxMenu",selectOnFocus:true}]};var a=new SYNO.ux.FormPanel(b);return a},onMail:function(){SYNO.webfm.utils.onMailTo(this.mailBody)},onBuildInMail:function(){var b=this.mailBody.split("%0A%0A");var a=b.reduce(function(c,d){return c+"<div>"+d+"</div>"},"");SYNO.SDS.AppLaunch("SYNO.SDS.App.MailDialog.Application",{content:a})},load:function(){this.focusEl=this.get("textarea").get("urls");this.show().center()}});SYNO.FileStation.SharingManagerWindow=function(b){this.pageSize=50;this.blForceClean=true;Ext.apply(this,b||{});var a=this.initGridPanel();var d=new SYNO.FileStation.ShareWithMePanel({owner:this});var e=new SYNO.ux.TabPanel({activeTab:(this.activeTab)?this.activeTab:0,items:[a,d]});var c={owner:this.owner,width:750,height:405,shadow:true,collapsible:false,title:_WFT("sharing","sharing_manager"),layout:"fit",items:e,buttons:[{itemId:"close_button",text:_WFT("common","close"),scope:this,handler:this.close}]};SYNO.FileStation.SharingManagerWindow.superclass.constructor.call(this,c)};Ext.extend(SYNO.FileStation.SharingManagerWindow,SYNO.SDS.ModalWindow,{initToolBar:function(){this.editBtn=new SYNO.ux.Button({itemId:"editBtn",text:_WFT("common","alt_edit"),handler:this.onbeforeEdit,scope:this});this.deletBtn=new SYNO.ux.Button({itemId:"deleteBtn",text:_WFT("common","delete"),handler:this.onbeforeDelete,scope:this});this.cleanBtn=new SYNO.ux.Button({itemId:"cleanBtn",text:_WFT("sharing","clean_badlinks"),handler:this.onbeforeClean,scope:this});this.SummarizeBtn=new SYNO.ux.Button({itemId:"SummarizeBtn",text:_WFT("sharing","summarize"),handler:this.onSummarize,scope:this});var a=new Ext.Toolbar({border:false,items:[this.editBtn,this.deletBtn,this.SummarizeBtn,this.cleanBtn]});return a},initGridPanel:function(){var b=_S("is_admin");var d=this.RELURL;var a=new Ext.grid.ColumnModel([{header:_WFT("common","user"),dataIndex:"link_owner",sortable:true,width:80,hidden:!b,renderer:function(k,h,e,g,i,f){var j;if(k){j=k}else{j=_WFT("sharing","user_non_exist");h.attr='ext:qtip="'+j+'"'}return j}},{header:_WFT("common","file_name"),dataIndex:"name",width:120,sortable:true,renderer:function(f,h,g,m,e,l){var k=Ext.util.Format.htmlEncode(f);h.attr='ext:qtip="'+Ext.util.Format.htmlEncode(k)+'"';var i=f.substr(f.lastIndexOf(".")+1).toLowerCase();var j="misc.png";if(g.get("isFolder")){j="folder.png"}else{if(-1!==SYNO.webfm.utils.icon_type.indexOf(i)){j=i+".png"}}return String.format('<div class="webfm-file-type-icon" style="background-image:url('+d+"images/files_ext/{0}?v="+_S("version")+')"/>&nbsp;{1}</div>',j,k)}},{header:_WFT("common","file_path"),dataIndex:"path",sortable:true,width:250,renderer:function(k,i,e,h,j,f){var g=Ext.util.Format.htmlEncode(k);i.attr='ext:qtip="'+Ext.util.Format.htmlEncode(g)+'"';return g}},{header:_WFT("sharing","exp_date"),dataIndex:"date_expired",sortable:true,width:120,renderer:(function(j,h,e,g,i,f){if(j=="0"){return _WFT("sharing","never")}else{return j}}).createDelegate(this)},{header:_WFT("common","status"),dataIndex:"status",sortable:true,width:100,renderer:function(k,h,e,g,i,f){var j;if(k=="broken"){j=_WFT("sharing","broken")}else{if(k=="expired"){j=_WFT("sharing","expired")}else{if(k=="inactive"){j=_WFT("sharing","inactive")}else{j=_WFT("sharing","status_ok")}}}return j}}]);this.createStore();this.setDSTimeZone();var c=new SYNO.ux.GridPanel({title:_WFT("sharing","sharing_all"),store:this.store,cm:a,tbar:this.initToolBar(),bbar:new SYNO.ux.PagingToolbar({pageSize:this.pageSize,store:this.store,loadMask:true,displayInfo:true,showRefreshBtn:true,listeners:{beforechange:{fn:function(f,g){var e=this.store.getSortState();g.force_clean=this.blForceClean;g.sort_by=e?e.field:"";g.sort_direction=e?e.direction:"";this.blForceClean=false;return true},scope:this}}}),listeners:{sortchange:{fn:function(f,e){this.grid.bottomToolbar.doRefresh()},scope:this},dblclick:{fn:this.onbeforeEdit,scope:this},afterrender:{fn:function(e){this.loadPageOne()},scope:this}}});this.grid=c;this.grid.mon(this.grid.getSelectionModel(),"selectionchange",this.checkSelection,this,{buffer:50});this.grid.mon(this.grid.getBottomToolbar().refresh,"click",function(){this.blForceClean=true},this,null);return c},checkSelection:function(){var a=this.grid.getSelectionModel().getSelections();var c=(0<a.length);var b=(1==a.length);this.deletBtn.setDisabled(!c);this.SummarizeBtn.setDisabled(!c);this.editBtn.setDisabled(!b)},createStore:function(){var a=new Ext.data.Store({autoDestroy:true,autoLoad:false,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.Sharing",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"links"},[{name:"name"},{name:"isFolder"},{name:"path"},{name:"date_expired"},{name:"date_available"},{name:"status"},{name:"has_password"},{name:"id"},{name:"url"},{name:"link_owner"},{name:"sharing_list"},{name:"valid_times"}]),paramNames:{start:"offset",limit:"limit"},listeners:{beforeload:{fn:function(){if(this.grid){this.grid.getGridEl().mask(_WFT("common","loading"))}},scope:this},load:{fn:function(){if(this.grid){this.grid.getGridEl().unmask()}},scope:this}}});this.store=a;return a},loadPageOne:function(){var a=this.store.getSortState();this.store.load({params:{offset:0,limit:this.pageSize,force_clean:this.blForceClean,sort_by:a?a.field:"",sort_direction:a?a.direction:""}});this.blForceClean=false},setDSTimeZone:function(){var c=_SYNOINFODEF.timezone;var a=SYNO.SDS.Utils.getTimeZoneStore();var b=a.getById(c);var e=b?b.get("offset"):0;var d=new Date().getTimezoneOffset();this.timeZoneAdjust=(e+d)*60;if(e/60>=0){this.DStimeZoneInfo="(GMT +"+e/60+")"}else{this.DStimeZoneInfo="(GMT "+e/60+")"}},onbeforeDelete:function(){var b=_WFT("common","delete");var a=_WFT("sharing","delete_confirm");this.getMsgBox().confirmDelete(b,a,function(c){if("yes"==c){this.onDelete()}},this);return},onDelete:function(){var a=this.grid.getSelectionModel().getSelections();var c=[];var b;for(b=0;b<a.length;b++){c[b]=a[b].get("id")}this.addWebAPITask({api:"SYNO.FileStation.Sharing",method:"delete",version:1,single:true,params:{id:c.join(",")},callback:function(f,d,e){if(f){this.grid.bottomToolbar.doRefresh()}else{this.errorHandler(_WFT("common","delete"),f,d,e)}},scope:this}).start(true)},onbeforeClean:function(){var b=_WFT("sharing","clean_badlinks");var a=_WFT("sharing","clean_confirm");this.getMsgBox().confirmDelete(b,a,function(c){if("yes"==c){this.onClean()}},this);return},onClean:function(){var b=_WFT("sharing","clean_badlinks");var a;this.addWebAPITask({api:"SYNO.FileStation.Sharing",method:"clear_invalid",version:1,single:true,timeout:3600000,callback:function(e,c,d){if(e){this.loadPageOne();a=_WFT("sharing","cleaned");this.getMsgBox().alert(b,a)}else{this.errorHandler(b,e,c,d)}},scope:this}).start(true)},onbeforeEdit:function(){var a=this.grid.getSelectionModel().getSelections();if(0===a.length){return}if(a[0].get("status")=="broken"){this.getMsgBox().alert(_WFT("common","alt_edit"),_WFT("error","edit_bklink"));return}this.setStatusBusy({text:_T("common","msg_waiting")});this.addWebAPITask({api:"SYNO.DSM.Info",method:"GetInfo",version:1,single:true,params:{},callback:function(d,b,c){if(d&&b.time){this.DStoday=Date.parse(b.time);this.clearStatusBusy();this.onEdit()}else{this.getMsgBox().alert(_WFT("common","share"),_WFT("common","error_system"));this.clearStatusBusy()}},scope:this}).start(true)},onEdit:function(){var o=this.grid.getSelectionModel().getSelections();var f=o[0].get("url");var c=o[0].get("has_password");var e=o[0].get("date_expired")=="0"?false:true;var w=new Date(this.DStoday);var d=new Date(w.getFullYear(),w.getMonth(),w.getDate(),0,0,0,0);var t=new Date(w.getFullYear(),w.getMonth(),w.getDate()+6,0,0,0,0);var m=(o[0].get("date_available")=="0")?d:new Date(o[0].get("date_available"));var a=(o[0].get("date_expired")=="0")?t:new Date(o[0].get("date_expired"));var x=new Date(m.getFullYear(),m.getMonth(),m.getDate(),0,0,0,0);var k=o[0].get("valid_times");var s=o[0].get("isFolder");var B={};var p=[],u=[],b=[];var j=[],v=[],n=[];var r=0;if(o[0].get("sharing_list")!==""){B=JSON.parse(o[0].get("sharing_list"))}if(B.Facebook!==undefined){p=JSON.parse(B.Facebook)}if(B.Google!==undefined){u=JSON.parse(B.Google)}if(B.DSM!==undefined){b=JSON.parse(B.DSM)}for(r=0;r<p.length;r++){j.push(p[r].id)}for(r=0;r<u.length;r++){v.push(u[r].id)}this.orignalUserList={};this.orignalUserList.DSM=[];for(r=0;r<b.length;r++){b[r].value=b[r].name+":"+b[r].type;n.push(b[r].value);this.orignalUserList.DSM.push({name:b[r].name,type:b[r].type})}this.orignalList={};this.orignalList.Facebook=j;this.orignalList.Google=v;var z=(c)?true:false;var l=(b.length!==0)?true:false;var g=z||l;if(d.getTime()<x.getTime()){x=d}this.restrictField=new SYNO.FileStation.RestrictFieldSet({enableRestrict:z,facebookBoxselectId:this.facebookBoxselectId=Ext.id(),googleBoxselectId:this.googleBoxselectId=Ext.id(),passwdFieldId:this.passwdFieldId=Ext.id(),confirmPasswdFieldId:this.confirmPasswdFieldId=Ext.id(),facebookData:p,facebookValues:j,googleData:u,googleValues:v,password:c?"0000000000":"",passwdInputType:"password"});this.secureFieldSet=new SYNO.FileStation.SecureFieldSet({enableSecure:g,enableRestrict:z,enableDSUser:l,dsUserValue:n,dsUserData:{users:b},restrictField:this.restrictField});var y={itemId:"panel",labelWidth:200,border:false,items:[{xtype:"syno_textfield",fieldLabel:_WFT("common","file_name"),name:"name",itemId:"name",value:o[0].get("name"),selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_textfield",fieldLabel:_WFT("common","file_path"),name:"path",itemId:"path",value:o[0].get("path"),selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_textfield",fieldLabel:_WFT("sharing","sharing_link"),name:"url",itemId:"url",value:f,selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},{itemId:"enableDates",xtype:"syno_checkbox",boxLabel:_WFT("sharing","enable_duration"),hideMode:"display",checked:e,name:"enableDates",listeners:{check:{fn:function(C,i){if(i===true){this.editWindow.get("panel").get("AvailDate").enable();this.editWindow.get("panel").get("ExpDate").enable()}else{this.editWindow.get("panel").get("AvailDate").disable();this.editWindow.get("panel").get("ExpDate").disable()}},scope:this}}},new SYNO.ux.DateField({itemId:"AvailDate",name:"AvailDate",fieldLabel:_WFT("sharing","avail_date"),editable:false,format:"Y-m-d",showToday:false,markToday:false,value:m,minValue:x,indent:1,width:157}),new SYNO.ux.DateField({itemId:"ExpDate",name:"ExpDate",fieldLabel:_WFT("sharing","exp_date"),editable:false,format:"Y-m-d",showToday:false,markToday:false,value:a,minValue:d,indent:1,width:157,validator:function(){if(q){var E=q.get("panel").get("AvailDate").getValue();var D=q.get("panel").get("ExpDate").getValue();var C=d.getTime();var F=E?E.getTime():0;var i=D?D.getTime():0;if(0!==i){if(i<C){return _WFT("sharing","exp_before_today")}else{if(i<F){return _WFT("sharing","exp_before_avail")}}}}return true}}),{itemId:"enableValidTimes",xtype:"syno_checkbox",boxLabel:_WFT("sharing","enable_valid_times"),name:"enable_valid_times",disabled:s,checked:("-1"!==k)},{itemId:"validTimesField",xtype:"syno_numberfield",name:"valid_times",width:157,fieldLabel:_WFT("sharing","valid_times"),value:("-1"===k)?"1":k,disabled:s,maxLength:2,allowNegative:false,indent:1},{xtype:"syno_checkbox",id:this.enableRst=Ext.id(),itemId:"enableRst",name:"enableRst",checked:g,boxLabel:_WFT("sharing","restrict_sharing"),listeners:{check:{fn:function(){if(Ext.getCmp(this.enableRst).getValue()===true){var i=this.editWindow.get("panel").get("secureFieldSet");i.enable();if(!i.get("dsUserRadio").getValue()&&!i.get("dsRestRadio").getValue()){i.get("dsUserRadio").setValue(true)}}else{this.editWindow.get("panel").get("secureFieldSet").disable()}},scope:this}}},this.secureFieldSet]};var h=new SYNO.ux.FormPanel(y),A;A=new SYNO.ux.Utils.EnableCheckGroup(h.form,"enable_valid_times",["valid_times"]);A=new SYNO.ux.Utils.EnableCheckGroup(h.form,"enableDates",["AvailDate","ExpDate"]);var q=new SYNO.SDS.ModalWindow({owner:this,width:700,height:570,shadow:true,resizable:false,collapsible:false,title:_WFT("sharing","edit_link"),layout:"fit",items:h,buttons:[{btnStyle:"blue",itemId:"save_button",text:_WFT("common","save"),scope:this,handler:this.setEditedData},{itemId:"cancel_button",text:_WFT("common","cancel"),scope:this,handler:function(){this.onCloseEdit()}}],listeners:{afterlayout:{fn:function(){SYNO.SDS.Utils.AddTip(h.getComponent("enableValidTimes").getEl(),_WFT("sharing","valid_times_tip"))},scope:this,single:true}}});this.editWindow=q;this.editWindow.show().center()},onCloseEdit:function(){var a=this.editWindow.get("panel").form.isDirty();if(a){var c=_WFT("sharing","edit_link");var b=_WFT("common","confirm_lostchange");this.editWindow.getMsgBox().confirm(c,b,function(d){if("yes"==d){this.editWindow.close()}else{return}},this)}else{this.editWindow.close()}},setEditedData:function(){var w=this.editWindow.get("panel").get("ExpDate");var x=this.grid.getSelectionModel().getSelections();var G=x[0].get("id");var f=null;var u=null;var d=null;var E={};if(!this.pwIsValid()||!w.isValid()){return}var j=(this.editWindow.get("panel").get("enableDates").isDirty()||this.editWindow.get("panel").get("AvailDate").isDirty()||this.editWindow.get("panel").get("ExpDate").isDirty());if(j){var z=this.editWindow.get("panel").get("enableDates").getValue();if(z){var n=this.editWindow.get("panel").get("AvailDate").getValue();var b=this.editWindow.get("panel").get("ExpDate").getValue();u=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();d=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()}else{u="0";d="0"}}var s="";var c=false;var B=this.editWindow.get("panel").get("enableValidTimes").isDirty()||this.editWindow.get("panel").get("validTimesField").isDirty();if(B){c=this.editWindow.get("panel").get("enableValidTimes").getValue();if(c){s=this.editWindow.get("panel").get("validTimesField").getValue()}else{s="-1"}}var q=Ext.getCmp(this.facebookBoxselectId);var p=Ext.getCmp(this.googleBoxselectId);var g=q.isDirty()||p.isDirty();var o=Ext.getCmp(this.passwdFieldId).isDirty();var v=this.secureFieldSet.getComponent("dsUser_cmb").getValue();var m=this.secureFieldSet.getComponent("dsUser_cmb").getSelectedRecords();var a=this.secureFieldSet.getComponent("dsUser_cmb").isDirty();var r=Ext.getCmp(this.enableRst).getValue();var t=this.secureFieldSet.getComponent("dsUserRadio").getValue();var A=this.secureFieldSet.getComponent("dsRestRadio").getValue();this.restrictField.updateAllList();E=this.restrictField.getSelectedList();var y=0,e=[];for(y=0;y<m.length;y++){e.push({name:m[y].data.name,type:m[y].data.type})}E.DSM=e;if(r&&A&&0===E.Facebook.length+E.Google.length&&Ext.getCmp(this.passwdFieldId).getValue().empty()){var F=_WFT("common","share");var l=_WFT("sharing","restrict_alert");this.editWindow.getMsgBox().alert(F,l);return}if(r&&t&&v===""){this.editWindow.getMsgBox().alert("Title",_WFT("sharing","dsm_user_alert"));return}if(!this.editWindow.get("panel").get("validTimesField").isValid()){this.editWindow.getMsgBox().alert("",_T("common","forminvalid"));return}if(o){f=Ext.getCmp(this.passwdFieldId).getValue()}if(!r||!A){f="";o=true}if(!r||!A){E.Facebook=[];E.Google=[];g=true}if(!r||!t){E.DSM=[];a=true}if(o||j||g||a||B){this.onSaveEdit(G,f,u,d,E,s)}var h=this.restrictField.getFilterSelectedListValue(this.orignalList);if(A&&g&&0!==h.Facebook.length){var D=this.restrictField.getSelectedList();var k=x[0].get("url");var C=new SYNO.FileStation.NotificationDialog({owner:this,target:this,urls:k,facebookValues:h.Facebook,facebookData:D.Facebook,googleValues:h.Google,googleData:D.Google});C.show().center()}this.editWindow.close()},onSaveEdit:function(f,b,e,a,d,c){var g={id:f,date_expired:a,date_available:e,valid_times:c};if(b!==null){g.password=b}if(d!==null){g.sharing_list=JSON.stringify(d)}if(d.DSM!==null&&0!==d.DSM.length){g.origin_user_list=JSON.stringify(this.orignalUserList)}this.sendWebAPI({api:"SYNO.FileStation.Sharing",method:"edit",version:1,params:g,callback:function(j,h,i){if(j){this.grid.bottomToolbar.doRefresh()}else{this.errorHandler(_WFT("common","alt_edit"),j,h,i)}},scope:this})},pwIsValid:function(){var c=false;var f=Ext.getCmp(this.enableRst).getValue();var e=Ext.getCmp(this.passwdFieldId);var a=Ext.getCmp(this.confirmPasswdFieldId);if(!f){c=true}else{if(e.isValid()&&a.isValid()){var b=e.getValue();var d=a.getValue();if(b===d){c=true}else{a.markInvalid(_WFT("error","error_repswd"));c=false}}}return c},onSummarize:function(){var b=this.getSummary();var a=new SYNO.FileStation.SharingSummaryWindow({content:b,mailBody:this.urls.join("%0A%0A"),owner:this});a.load()},parseDate:function(f){var a=new Date((parseInt(f,10)+this.timeZoneAdjust)*1000);var g=a.toDateString();var e=a.getHours()>9?a.getHours():"0"+a.getHours();var b=a.getMinutes()>9?a.getMinutes():"0"+a.getMinutes();var d=a.getSeconds()>9?a.getSeconds():"0"+a.getSeconds();var c=e+":"+b+":"+d;var h=g+" "+c+" "+this.DStimeZoneInfo;return h},getSummary:function(){var a=this.grid.getSelectionModel().getSelections();var d,b,f="",h="",c,g,e=0;this.urls=[];for(g=0;g<a.length;g++){b=a[g].get("status");d=a[g].get("name");c=a[g].get("date_expired")=="0"?false:true;if(b=="valid"){this.urls[e]=a[g].get("url");f+=d+":\n"+this.urls[e];e++;if(c){f+="\n"+_WFT("sharing","exp_date")+": "+a[g].get("date_expired")}f+="\n\n"}else{if(b=="inactive"){this.urls[e]=a[g].get("url");f+=d+":\n"+this.urls[e];e++;if(c){f+="\n"+_WFT("sharing","avail_date")+": "+a[g].get("date_available")}f+="\n\n"}else{if(b=="broken"){h+=d+":\n"+_WFT("sharing","summary_broken")+"\n\n"}else{if(b=="expired"){h+=d+":\n"+_WFT("sharing","summary_expired")+"\n\n"}}}}}f+=h;return f},errorHandler:function(e,a,d,b){var c=SYNO.webfm.utils.getWebAPIErr(a,d,b);e=e?e:_WFT("common","share");this.getMsgBox().alert(e,c);this.blForceClean=true;this.grid.bottomToolbar.doRefresh()},load:function(){this.deletBtn.disable();this.editBtn.disable();this.SummarizeBtn.disable();this.show().center()}});Ext.define("SYNO.FileStation.ShareWithMePanel",{extend:"SYNO.ux.GridPanel",constructor:function(a){this.pageSize=50;Ext.apply(this,a);var b=this.fillConfig();this.callParent([b])},fillConfig:function(){this.store=this.createStore();var c=this.initColumnModel();var b=new SYNO.ux.PagingToolbar({pageSize:this.pageSize,store:this.store,loadMask:true,displayInfo:true,showRefreshBtn:true,listeners:{beforechange:{fn:function(e,f){var d=this.store.getSortState();f.force_clean=this.blForceClean;f.sort_by=d?d.field:"";f.sort_direction=d?d.direction:"";this.blForceClean=false;return true},scope:this}}});var a={title:_WFT("sharing","share_with_me"),store:this.store,cm:c,bbar:b,listeners:{sortchange:{fn:function(e,d){e.bottomToolbar.doRefresh()},scope:this},dblclick:{fn:this.onbeforeEdit,scope:this},afterlayout:{fn:this.loadPageOne,scope:this}}};return a},initColumnModel:function(){var a=new Ext.grid.ColumnModel([{header:_WFT("common","user"),dataIndex:"link_owner",sortable:true,width:80,renderer:function(h,e,b,d,f,c){var g;if(h){g=h}else{g=_WFT("sharing","user_non_exist");e.attr='ext:qtip="'+g+'"'}return g}},{header:_WFT("common","file_name"),dataIndex:"name",width:120,sortable:true,renderer:function(d,g,e,k,c,j){var b="modules/FileBrowser/webfm/";var i=Ext.util.Format.htmlEncode(d);g.attr='ext:qtip="'+Ext.util.Format.htmlEncode(i)+'"';var f=d.substr(d.lastIndexOf(".")+1).toLowerCase();var h="misc.png";if(e.get("isFolder")){h="folder.png"}else{if(-1!==SYNO.webfm.utils.icon_type.indexOf(f)){h=f+".png"}}return String.format('<div class="webfm-file-type-icon" style="background-image:url('+b+"images/files_ext/{0}?v="+_S("version")+')"/>&nbsp;{1}</div>',h,i)}},{header:_WFT("common","file_path"),dataIndex:"path",sortable:true,width:200,renderer:function(h,f,b,e,g,c){var d=Ext.util.Format.htmlEncode(h);f.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return d}},{header:_WFT("sharing","sharing_link"),dataIndex:"url",sortable:false,width:200,renderer:function(h,f,b,e,g,c){var d=Ext.util.Format.htmlEncode(h);f.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return d}},{header:_WFT("sharing","exp_date"),dataIndex:"date_expired",sortable:true,width:120,renderer:(function(i,f,b,e,g,c){var h=i;if(i=="0"){h=_WFT("sharing","never")}var d=Ext.util.Format.htmlEncode(h);f.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return h}).createDelegate(this)},{header:_WFT("common","status"),dataIndex:"status",sortable:true,width:100,renderer:function(i,f,b,e,g,c){var h;if(i=="broken"){h=_WFT("sharing","broken")}else{if(i=="expired"){h=_WFT("sharing","expired")}else{if(i=="inactive"){h=_WFT("sharing","inactive")}else{h=_WFT("sharing","status_ok")}}}var d=Ext.util.Format.htmlEncode(h);f.attr='ext:qtip="'+Ext.util.Format.htmlEncode(d)+'"';return h}}]);return a},createStore:function(){var a=new Ext.data.Store({autoDestroy:true,autoLoad:false,proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.Sharing",method:"list_share_me",version:2}),reader:new Ext.data.JsonReader({root:"links"},[{name:"name"},{name:"isFolder"},{name:"path"},{name:"date_available"},{name:"date_expired"},{name:"status"},{name:"id"},{name:"url"},{name:"link_owner"},{name:"valid_times"}]),paramNames:{start:"offset",limit:"limit"},listeners:{beforeload:{fn:function(){this.ownerCt.el.mask(_WFT("common","loading"))},scope:this},load:{fn:function(){this.ownerCt.el.unmask()},scope:this}}});this.store=a;return a},loadPageOne:function(){var a=this.store.getSortState();this.store.load({params:{offset:0,limit:this.pageSize,force_clean:this.blForceClean,sort_by:a?a.field:"",sort_direction:a?a.direction:""}});this.blForceClean=false},onbeforeEdit:function(){var a=this.getSelectionModel().getSelections();if(0===a.length){return}if(a[0].get("status")=="broken"){this.owner.getMsgBox().alert(_WFT("common","alt_edit"),_WFT("error","edit_bklink"));return}this.owner.setStatusBusy({text:_T("common","msg_waiting")});this.owner.sendWebAPI({api:"SYNO.DSM.Info",method:"GetInfo",version:1,single:true,params:{},callback:function(d,b,c){if(d&&b.time){this.DStoday=Date.parse(b.time);this.owner.clearStatusBusy();this.onEdit(a[0])}else{this.owner.getMsgBox().alert(_WFT("common","share"),_WFT("common","error_system"));this.owner.clearStatusBusy()}},scope:this})},onEdit:function(e){var h=new Date(this.DStoday);var g=new Date(h.getFullYear(),h.getMonth(),h.getDate(),0,0,0,0);var a=new Date(h.getFullYear(),h.getMonth(),h.getDate()+6,0,0,0,0);var k=(e.get("date_available")=="0")?g:new Date(e.get("date_available"));var c=(e.get("date_expired")=="0")?a:new Date(e.get("date_expired"));var b=new Date(k.getFullYear(),k.getMonth(),k.getDate(),0,0,0,0);var f=e.get("valid_times");var i=("-1"!==f);var d=e.data;d.AvailDate=k;d.ExpDate=c;d.minADate=b;d.Today=g;d.blValidTimes=i;d.validTimesField=("-1"===f)?3:f;var j=new SYNO.FileStation.ShareMeDialog({owner:this.owner,formData:d});j.show().center()}});Ext.define("SYNO.FileStation.ShareMeDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",this.setDataValues,this,{single:true})},fillConfig:function(a){Ext.apply(this,a||{});var b={owner:this.owner,width:600,minWidth:450,collapsible:false,resizable:false,autoScroll:false,constrainHeader:true,title:_WFT("sharing","sharing_link"),layout:"fit",items:this.initPanel(),buttons:[{text:_WFT("common","close"),scope:this,handler:this.close}]};return b},initPanel:function(){var a;a={itemId:"panel",labelWidth:200,border:false,items:[{xtype:"syno_textfield",fieldLabel:_WFT("common","file_name"),name:"name",itemId:"name",selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_textfield",fieldLabel:_WFT("common","file_path"),name:"path",itemId:"path",selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},{xtype:"syno_textfield",fieldLabel:_WFT("sharing","sharing_link"),name:"url",itemId:"url",selectOnFocus:true,readOnly:true,width:320,cls:"selectabletext allowDefCtxMenu"},new SYNO.ux.DateField({itemId:"AvailDate",fieldLabel:_WFT("sharing","avail_date"),editable:false,format:"Y-m-d",showToday:false,markToday:false,disabled:true,minValue:this.formData.minADate,width:157}),new SYNO.ux.DateField({itemId:"ExpDate",fieldLabel:_WFT("sharing","exp_date"),editable:false,format:"Y-m-d",showToday:false,markToday:false,disabled:true,minValue:this.formData.Today,width:157}),{itemId:"validTimesField",xtype:"syno_numberfield",name:"valid_times",width:157,fieldLabel:_WFT("sharing","valid_times"),value:"1",maxLength:2,allowNegative:false,disabled:true,hidden:true}]};this.panel=new SYNO.ux.FormPanel(a);return this.panel},setDataValues:function(){this.panel.form.setValues(this.formData);if(this.formData.blValidTimes){this.panel.form.findField("valid_times").show()}}});Ext.ns("SYNO.FileStation.Comp");Ext.apply(SYNO.FileStation.Comp,{cFavBtn:function(c,b,a){var d=_WFT("favorite","my_favorite");return new (c)({text:d,tooltip:d,iconCls:b?"webfm-favorite-icon":"",listeners:{click:{fn:a.onAddFav,scope:a}}})},cDSMDeskShortcutBtn:function(c,b,a,d){return new (c)({itemId:"gc_dsmshortcut",text:d,tooltip:d,iconCls:b?"webfm-createshortcut-icon":"",listeners:{click:{fn:a.onAddShortCut,scope:a}}})},cAddFavMenuBtn:function(e,c,b){var a=SYNO.FileStation.Comp,d=Ext.menu.Item;return new (e)({itemId:"gc_fav_menu",iconCls:c?"webfm-favorite-icon":"",tooltip:_WFT("shortcut","make_to"),text:_WFT("shortcut","make_to"),hideOnClick:false,menu:new SYNO.ux.Menu({cls:"syno-webfm",ignoreParentClicks:true,items:[a.cFavBtn(d,true,b),a.cDSMDeskShortcutBtn(d,true,b,_WFT("shortcut","dsm_dekstop"))]})})},cUpFolder:function(c,b,a){return new (c)({icon:b?(a.RELURL+"images/site/last_folder.gif"):"",listeners:{click:{fn:function(){this.onChangeDir(this.upDirPath)},scope:a}}})},cUploadLocal:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_upload"),tooltip:_WFT("filetable","filetable_upload"),iconCls:b?"webfm-upload-icon":"",listeners:{click:{fn:a.onBrowserUploadAction,scope:a}}})},cUploadSkip:function(c,b,a){return new (c)({itemId:"upload_skip",iconCls:b?"webfm-upload-icon":"",text:_WFT("filetable","filetable_upload")+" - "+_WFT("filetable","filetable_skip"),handler:a.onUploadItemClick,scope:a})},cUploadOvwr:function(c,b,a){return new (c)({itemId:"upload_overwrite",iconCls:b?"webfm-upload-icon":"",text:_WFT("filetable","filetable_upload")+" - "+_WFT("filetable","filetable_overwrite"),handler:a.onUploadItemClick,scope:a})},cReloadDS:function(c,b,a){return new (c)({text:_WFT("common","common_refresh"),tooltip:_WFT("common","common_refresh"),icon:b?(a.RELURL+"images/button/toolbar_refresh.png"):"",listeners:{click:{fn:function(){this.activeDS.reload()},scope:a}}})},cReloadTree:function(c,b,a){return new (c)({text:_WFT("common","common_refresh"),tooltip:_WFT("common","common_refresh"),icon:b?(a.RELURL+"images/button/toolbar_refresh.png"):"",listeners:{click:{fn:function(){this.reloadTree()},scope:a}}})},cNewFolder:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_create_folder"),tooltip:_WFT("filetable","filetable_create_folder"),iconCls:b?"webfm-createfolder-icon":"",listeners:{click:{fn:a.onCreateFolder,scope:a}}})},cNewShareFolder:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_create_sharefolder"),tooltip:_WFT("filetable","filetable_create_sharefolder"),iconCls:b?"webfm-createfolder-icon":"",listeners:{click:{fn:a.onCreateShareFolder,scope:a}}})},cToolsMenu:function(a){return new SYNO.ux.Button({text:_WFT("filetable","tools"),menu:a,hidden:!(_S("is_admin")&&"yes"===_D("supportmount"))})},cMountList:function(c,b,a){return new (c)({hidden:true,text:_WFT("mount","mount_list"),tooltip:_WFT("mount","mount_list"),iconCls:b?"webfm-connection-list-icon":"",listeners:{click:{fn:a.onMountList,scope:a}}})},cSettings:function(c,b,a){return new (c)({text:_WFT("mount","setting"),tooltip:_WFT("mount","setting"),icon:b?(a.RELURL+"images/button/mount_config.png"):"",listeners:{click:{fn:a.onSettings,scope:a}}})},cDownloadMenu:function(e,c,b){var a=SYNO.FileStation.Comp,d=Ext.menu.Item;var f=_WFT("filetable","filetable_download");return new (e)({itemId:"gc_download_menu",text:f,tooltip:f,iconCls:c?"webfm-download-icon":"",hideOnClick:false,menu:new SYNO.ux.Menu({cls:"syno-webfm",ignoreParentClicks:true,items:[a.cDownload(d,true,b,_WFT("filetable","filetable_download_directly")),a.cDownloadOverwrite(d,true,b),a.cDownloadSkip(d,true,b)]})})},cDownload:function(c,b,a,d){d=d||_WFT("filetable","filetable_download");return new (c)({itemId:"gc_download",text:d,tooltip:d,iconCls:b?"webfm-download-icon":"",listeners:{click:{fn:a.onDownloadAction,scope:a}}})},cDownloadSkip:function(d,b,a,c){var e=_WFT("filetable","filetable_download_queue")+" - "+_WFT("filetable","filetable_skip");return new (d)({text:e,tooltip:e,iconCls:b?"webfm-download-icon":"",listeners:{click:{fn:function(f){this.onJavaDownloadAction(f,false)},scope:a}}})},cDownloadOverwrite:function(d,b,a,c){var e=_WFT("filetable","filetable_download_queue")+" - "+_WFT("filetable","filetable_overwrite");return new (d)({text:e,tooltip:e,iconCls:b?"webfm-download-icon":"",listeners:{click:{fn:function(f){this.onJavaDownloadAction(f,true)},scope:a}}})},cOpenWin:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_openwin"),tooltip:_WFT("filetable","filetable_openwin"),iconCls:b?"webfm-open-newwin-icon":"",listeners:{click:{fn:a.onOpenWinAction,scope:a}}})},cExtractMenuBtn:function(e,c,b){var a=SYNO.FileStation.Comp,d=Ext.menu.Item,g=_WFT("filetable","filetable_extract");var f=new SYNO.ux.Menu({cls:"syno-webfm",ignoreParentClicks:true,items:[a.cExtract(d,true,b),a.cExtractHere(d,true,b),a.cExtractFolderName(d,true,b)]});f.render();return new (e)({hideOnClick:false,itemId:"gc_extract_menu",iconCls:c?"webfm-extract-icon":"",tooltip:g,text:g,menu:f})},cExtract:function(c,b,a){return new (c)({itemId:"gc_extract",text:_WFT("filetable","filetable_extract")+"...",tooltip:_WFT("filetable","filetable_extract")+"...",iconCls:b?"webfm-extract-icon":"",listeners:{click:{fn:a.onExtractClick,scope:a}}})},cExtractHere:function(c,b,a){return new (c)({itemId:"gc_extract_here",text:_WFT("filetable","filetable_extract_here"),tooltip:_WFT("filetable","filetable_extract_here"),iconCls:b?"webfm-extract-icon":"",listeners:{click:{fn:a.onExtractHereClick,scope:a}}})},cExtractFolderName:function(c,b,a){return new (c)({itemId:"gc_extract_folder",text:_WFT("filetable","filetable_extract_to"),tooltip:_WFT("filetable","filetable_extract_to"),iconCls:b?"webfm-extract-icon":"",listeners:{click:{fn:function(){this.onExtractFolderNameClick()},scope:a}}})},cCompressAdv:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_add_archive"),tooltip:_WFT("filetable","filetable_add_archive"),iconCls:b?"webfm-compress-icon":"",listeners:{click:{fn:a.onCompressAdvItemsClick,scope:a}}})},cCompress:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_compress_to"),tooltip:_WFT("filetable","filetable_compress_to"),iconCls:b?"webfm-compress-icon":"",listeners:{click:{fn:a.onCompressItemsClick,scope:a}}})},cMountRemote:function(c,b,a){return new (c)({hidden:true,text:_WFT("filetable","filetable_mount_remote_volume"),tooltip:_WFT("filetable","filetable_mount_remote_volume"),iconCls:b?"webfm-mount-remote-icon":"",listeners:{click:{fn:a.onMountRemoteClick,scope:a}}})},cRemoteConnect:function(f,c,b){var a=SYNO.FileStation.Comp,e=Ext.menu.Item;var d=new (f)({hidden:true,text:_WFT("vfs","remote_connect"),tooltip:_WFT("vfs","remote_connect"),iconCls:c?"webfm-mount-remote-icon":"",hideOnClick:false,menu:new SYNO.ux.Menu({cls:"syno-webfm",ignoreParentClicks:true,items:[a.cRemoteConnectSetup(e,true,b),a.cRemoteConnectServerList(e,true,b)]})});return d},cRemoteConnectSetup:function(c,b,a){return new (c)({text:_WFT("vfs","setup_server"),tooltip:_WFT("vfs","setup_server"),iconCls:b?"webfm-mount-remote-icon":"",listeners:{click:{fn:a.onRemoteConnectClick,scope:a}}})},cRemoteConnectServerList:function(c,b,a){return new (c)({text:_WFT("vfs","server_list"),tooltip:_WFT("vfs","server_list"),iconCls:b?"webfm-mount-remote-icon":"",listeners:{click:{fn:a.onRemoteConnectServerListClick,scope:a}}})},cMountISO:function(c,b,a){return new (c)({hidden:true,text:_WFT("filetable","filetable_mount_iso"),tooltip:_WFT("filetable","filetable_mount_iso"),iconCls:b?"webfm-mount-iso-icon":"",listeners:{click:{fn:a.onMountISOClick,scope:a}}})},cUmount:function(c,b,a){return new (c)({hidden:true,text:_WFT("mount","umount"),tooltip:_WFT("mount","umount"),iconCls:b?"webfm-umount-eject-icon":"",listeners:{click:{fn:a.onUmountClick,scope:a}}})},cSnapshotHistory:function(b,a){return new (b)({text:_T("disk_info","disk_view_history"),tooltip:_T("disk_info","disk_view_history"),iconCls:"webfm-snapshot-icon",itemId:"gc_snapshot_history",listeners:{click:{fn:a.onViewHistoryAction,scope:a}}})},cCut:function(c,b,a){var d=_WFT("filetable","filetable_cut");return new (c)({text:d,tooltip:d,iconCls:b?"webfm-cut-icon":"",listeners:{click:{fn:a.onCutAction,scope:a}}})},cCopy:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_copy"),tooltip:_WFT("filetable","filetable_copy"),iconCls:b?"webfm-copy-icon":"",listeners:{click:{fn:a.onCopyAction,scope:a}}})},cMVCPToMenu:function(f,c,b){var a=SYNO.FileStation.Comp,e=Ext.menu.Item;var g=_WFT("filetable","filetable_copy_to")+"/"+_WFT("filetable","filetable_move_to")+" ...";var d=new (f)({itemId:"mvcpto",text:g,tooltip:g,iconCls:c?"webfm-copymove-to-icon":"",hideOnClick:false,menu:new SYNO.ux.Menu({cls:"syno-webfm",ignoreParentClicks:true,items:[a.cCopyTo(e,true,b,true),a.cCopyTo(e,true,b,false),a.cMoveTo(e,true,b,true),a.cMoveTo(e,true,b,false)]}),setMoveDisabled:function(h){var i=this.menu.items;i.get("moveto_ovwr").setDisabled(h);i.get("moveto_skip").setDisabled(h)},setOvwrVisible:function(j){var i=this.menu.items;i.get("moveto_ovwr").setVisible(j);i.get("copyto_ovwr").setVisible(j);var h=_WFT("filetable","filetable_move_to")+" ...";var k=_WFT("filetable","filetable_copy_to")+" ...";if(j){h+=" - "+_WFT("filetable","filetable_skip");k+=" - "+_WFT("filetable","filetable_skip")}i.get("moveto_skip").setText(h);i.get("copyto_skip").setText(k)}});return d},cCopyTo:function(d,b,a,c){var e=_WFT("filetable","filetable_copy_to")+" ... - "+(c?_WFT("filetable","filetable_overwrite"):_WFT("filetable","filetable_skip"));return new (d)({itemId:c?"copyto_ovwr":"copyto_skip",text:e,tooltip:e,iconCls:b?"webfm-copymove-to-icon":"",listeners:{click:{fn:function(f){this.onCopyAction(f,c)},scope:a}}})},cMoveTo:function(d,b,a,c){var e=_WFT("filetable","filetable_move_to")+" ... - "+(c?_WFT("filetable","filetable_overwrite"):_WFT("filetable","filetable_skip"));return new (d)({itemId:c?"moveto_ovwr":"moveto_skip",text:e,tooltip:e,iconCls:b?"webfm-copymove-to-icon":"",listeners:{click:{fn:function(f){this.onCutAction(f,c)},scope:a}}})},cPasteSkip:function(c,b,a){var d=_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_skip");return new (c)({text:d,tooltip:d,iconCls:b?"webfm-paste-icon":"",listeners:{click:{fn:function(e){this.onPasteAction(e,false)},scope:a}}})},cPasteOvwr:function(c,b,a){var d=_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_overwrite");return new (c)({text:d,tooltip:d,iconCls:b?"webfm-paste-icon":"",listeners:{click:{fn:function(e){this.onPasteAction(e,true)},scope:a}}})},cDelete:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_delete"),tooltip:_WFT("filetable","filetable_delete"),iconCls:b?"webfm-delete-icon":"",listeners:{click:{fn:a.onDeleteAction,scope:a}}})},cRename:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_rename"),tooltip:_WFT("filetable","filetable_rename"),iconCls:b?"webfm-rename-icon":"",listeners:{click:{fn:a.onRenameAction,scope:a}}})},cProperty:function(c,b,a){return new (c)({text:_WFT("filetable","filetable_properties"),tooltip:_WFT("filetable","filetable_properties"),iconCls:b?"webfm-property-icon":"",listeners:{click:{fn:a.onPropertyClick,scope:a}}})},cSharing:function(c,b,a){return new (c)({text:_WFT("common","share"),tooltip:_WFT("common","share"),iconCls:b?"webfm-share-link-icon":"",listeners:{click:{fn:a.onShareClick,scope:a}}})},cSharingManager:function(c,b,a){return new (c)({text:_WFT("sharing","sharing_manager"),tooltip:_WFT("sharing","sharing_manager"),iconCls:b?"webfm-share-link-icon":"",listeners:{click:{fn:a.onSharingManager,scope:a}}})},cCmbDisplayType:function(a){var b=new Ext.data.SimpleStore({autoDestroy:true,fields:["value","display"],data:[["all",_WFT("filetable","filetable_all_files")],["file",_WFT("filetable","filetable_file_only")],["dir",_WFT("filetable","filetable_dir_only")]]});var c=new Ext.form.ComboBox({name:"display_type",hiddenName:"display_type",hiddenId:Ext.id(),store:b,displayField:"display",valueField:"value",triggerAction:"all",value:"all",editable:false,width:120,mode:"local",listeners:{select:{fn:function(f,d,e){this.onChangeDisplayType(f.getValue())},scope:a}}});return c},cBtnDisplayType:function(a){var b=new SYNO.ux.Button({hidden:true,text:_WFT("filetable","filetable_file_dispaly"),menu:new SYNO.ux.Menu({cls:"syno-webfm",items:[{itemId:"all",text:_WFT("filetable","filetable_all_files"),iconCls:"syno-sds-fs-tbar-sel-display",listeners:{click:{fn:function(){this.onChangeDisplayType("all")},scope:a}}},{itemId:"file",text:_WFT("filetable","filetable_file_only"),listeners:{click:{fn:function(){this.onChangeDisplayType("file")},scope:a}}},{itemId:"dir",text:_WFT("filetable","filetable_dir_only"),listeners:{click:{fn:function(){this.onChangeDisplayType("dir")},scope:a}}}]})});return b},cActionMenu:function(b){var a=new SYNO.ux.Button({text:_WFT("common","start"),menu:b});return a},cFileFilter:function(a){return new SYNO.FileStation.Comp.AdvancedSearchField({emptyText:_WFT("common","filter_label_text"),store:a.activeDS,queryAction:"list",enumAction:"list",queryParam:"pattern",width:188,pageSize:a.displayNum,owner:a})},cUploadRemote:function(c,b,a){return new (c)({iconCls:b?"webfm-upload-icon":"",text:_WFT("filetable","filetable_upload"),menu:{owner:this,cls:"syno-webfm syno-ux-menu",items:[SYNO.FileStation.Comp.cUploadSkip(Ext.menu.Item,true,a),SYNO.FileStation.Comp.cUploadOvwr(Ext.menu.Item,true,a)],listeners:{afterrender:{fn:this.UploadMenuRegistEvent,scope:a}}}})},UploadMenuRegistEvent:function(b){var a=b.get("upload_overwrite");b.mon(b,"beforeshow",function(){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));SYNO.FileStation.FlashUploader.setLowZindex();return false}if(!this.onCheckVFSAction("upload",null,this.getCurrentDir())){SYNO.FileStation.FlashUploader.setLowZindex()}if(!this.onCheckPrivilege("upload",null,false,false)){SYNO.FileStation.FlashUploader.setLowZindex()}var c=this.checkFtpModifyRight(this.dirTree.getSelectionModel().getSelectedNode());if(c){a.disable()}else{a.enable()}},this);b.mon(b,"show",function(g){if(AppletProgram.blJavaPermission==1||(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload())||(!this.onCheckPrivilege("upload",null,false,false))||!this.onCheckVFSAction("upload",null,this.getUploadPath(g))){return}var e=this.checkFtpModifyRight(this.dirTree.getSelectionModel().getSelectedNode());var d=e?b.getHeight()/2:b.getHeight();if(SYNO.FileStation.FlashUploader.swiffy===null){var f=this.getUploadInstance();var c=(f)?true:false;SYNO.FileStation.FlashUploader.init(this.RELURL,b,f,d,c,this)}else{SYNO.FileStation.FlashUploader.reinit(g);SYNO.FileStation.FlashUploader.setHighZindex();SYNO.FileStation.FlashUploader.swiffyReposition(d)}SYNO.FileStation.FlashUploader.setParameters(this.getUploadPath(g),this.session)},this);b.mon(b,"hide",function(){if(AppletProgram.blJavaPermission==1||(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload())){if(SYNO.FileStation.FlashUploader.swiffy!==null){SYNO.FileStation.FlashUploader.setLowZindex();SYNO.FileStation.FlashUploader.swiffy=null}return}if(SYNO.FileStation.FlashUploader.swiffy!==null){SYNO.FileStation.FlashUploader.setLowZindex()}},this)},cHisBack:function(b,a){return new (b)({itemId:"back",tooltip:_WFT("common","back"),iconCls:"syno-sds-fs-tbar-back",disabled:true,listeners:{click:{fn:function(c){this.historyIndex--;var e=this.historyPath[this.historyIndex];var d=false;if(e.source!==this.getCurrentSource()){this.switchSource(e.source);d=true}if(d||e.directory!==this.getCurrentDir()){this.onChangeDir(e.directory,true);this.historyBtnCheck()}},scope:a}}})},cHisNext:function(b,a){return new (b)({itemId:"next",tooltip:_WFT("common","next"),iconCls:"syno-sds-fs-tbar-next",disabled:true,listeners:{click:{fn:function(c){this.historyIndex++;var e=this.historyPath[this.historyIndex];var d=false;if(e.source!==this.getCurrentSource()){this.switchSource(e.source);d=true}if(d||e.directory!==this.getCurrentDir()){this.onChangeDir(e.directory,true);this.historyBtnCheck()}},scope:a}}})},cSort:function(i,d,a){var g=d.activeDS,e=(a&&a.type_group)?a.type_group:"webfm_sort_type",c=(a&&a.dir_group)?a.dir_group:"webfm_sort_dir",h=function(l){var k=l.sortInfo.field,j=l.sortInfo.direction,m=this.menu.getComponent(k)||this.menu.getComponent("filename"),n=this.menu.getComponent(j);if(m){m.setChecked(true)}if(n){n.setChecked(true)}this.sortType=k;this.sortDir=j},f=function(l,j){var k=d.activeDS;if(k.data.length===0){return}if(l.group===e){b.sortType=l.itemId}else{b.sortDir=l.itemId}k.sort(b.sortType,b.sortDir)},b=new (i)({text:_T("filebrowser","sort"),tooltip:_T("filebrowser","sort"),itemId:(a&&a.itemId)?a.itemId:"",iconCls:(a&&a.iconCls)?a.iconCls:"",bindEvent:function(j){this.mun(j,"datachanged",h,this);this.mon(j,"datachanged",h,this)},menu:{ignoreParentClicks:true,defaults:{checked:false},cls:"syno-webfm-sort-menu syno-ux-searchfield-menu",items:[{group:e,text:_WFT("common","common_filename"),itemId:"filename"},{group:e,text:_WFT("common","common_filesize"),itemId:"filesize"},{group:e,text:_WFT("filetable","filetable_title_file_type"),itemId:"type"},{group:e,text:_WFT("filetable","filetable_mtime"),itemId:"mt"},{group:e,text:_WFT("filetable","filetable_ctime"),itemId:"ct"},{group:e,text:_WFT("filetable","filetable_atime"),itemId:"at"},{group:e,text:_WFT("filetable","filetable_privilege"),itemId:"privilege"},{group:e,text:_WFT("filetable","filetable_owner"),itemId:"owner"},{group:e,text:_WFT("filetable","filetable_group"),itemId:"group"},"-",{group:c,itemId:"ASC",text:_WFT("common","order_asc")},{group:c,itemId:"DESC",text:_WFT("common","order_desc")}],listeners:{scope:this,itemclick:f}}});b.bindEvent(g);return b},cViewMode:function(h,d,e){var g="webfm-viewmode-btn-thumb-small",b="webfm-viewmode-btn-thumb-medium",f="webfm-viewmode-btn-thumb-large",c="webfm-viewmode-btn-list",a="syno-sds-webfm-tbar-viewmode-btn ";return new (h)({cls:"syno-sds-webfm-tbar-viewmode-btn-no-margin",iconCls:"syno-sds-webfm-tbar-viewmode-btn "+c,webfm:d,handler:function(){var i=this.iconCls;if(i==a+c){this.setIconClass(a+g);d.changeView("thumbnailView");d.changeThumbSize(SYNO.webfm.utils.ThumbSize.SMALL)}else{if(i==a+g){this.setIconClass(a+b);d.changeThumbSize(SYNO.webfm.utils.ThumbSize.MEDIUM)}else{if(i==a+b){this.setIconClass(a+f);d.changeThumbSize(SYNO.webfm.utils.ThumbSize.LARGE)}else{if(i==a+f){this.setIconClass(a+c);d.changeView("fileGrid")}}}}},menu:{cls:"syno-sds-webfm-tbar-viewmode-menu",items:[{text:_WFT("common","list_view"),iconCls:c,itemId:"fileGrid",handler:function(){this.changeView("fileGrid");this.btnViewMode.setIconClass(a+c)},scope:d},{text:_WFT("common","thumb_small"),iconCls:g,itemId:"thumbnailView"+SYNO.webfm.utils.ThumbSize.SMALL,handler:function(){this.changeView("thumbnailView");this.changeThumbSize(SYNO.webfm.utils.ThumbSize.SMALL);this.btnViewMode.setIconClass(a+g)},scope:d},{text:_WFT("common","thumb_medium"),iconCls:b,itemId:"thumbnailView"+SYNO.webfm.utils.ThumbSize.MEDIUM,handler:function(){this.changeView("thumbnailView");this.changeThumbSize(SYNO.webfm.utils.ThumbSize.MEDIUM);this.btnViewMode.setIconClass(a+b)},scope:d},{text:_WFT("common","thumb_large"),iconCls:f,itemId:"thumbnailView"+SYNO.webfm.utils.ThumbSize.LARGE,handler:function(){this.changeView("thumbnailView");this.changeThumbSize(SYNO.webfm.utils.ThumbSize.LARGE);this.btnViewMode.setIconClass(a+f)},scope:d}]},resetViewMode:function(){this.setIconClass(a+c);d.changeView("fileGrid")}})}});SYNO.FileStation.Comp.AdvancedSearchField=Ext.extend(SYNO.ux.SearchField,{onMouseDown:function(c){var b=this,a=b.searchPanel;if(a&&!a.isDestroyed&&a.isVisible()&&!a.inEl&&!c.within(a.getEl())&&!(a.selTree&&a.selTree.isVisible())&&!c.within(this.searchtrigger)){a.hide()}},onSearchTriggerClick:function(){var a=this;if(a.disabled===true){return}if(!a.searchPanel){a.searchPanel=a.owner.searchPanel;a.mon(Ext.getDoc(),"mousedown",a.onMouseDown,a)}if(a.searchPanel.isVisible()){a.searchPanel.hide();return}a.searchPanel.getEl().alignTo(this.container,"tr-br?");a.searchPanel.show();a.searchPanel.setKeyWord(a.getValue())}});SYNO.FileStation.Comp.TextItem=Ext.extend(Ext.Toolbar.TextItem,{onRender:function(b,a){this.autoEl={cls:"xtb-text",html:this.text||"","ext:qtip":this.text||""};SYNO.FileStation.Comp.TextItem.superclass.onRender.call(this,b,a)},setText:function(a){SYNO.FileStation.Comp.TextItem.superclass.setText.call(this,a);if(this.rendered){this.el.set({"ext:qtip":a})}}});Ext.reg("fstbtext",SYNO.FileStation.Comp.TextItem);Ext.ns("SYNO.FileStation.Comp");SYNO.FileStation.Comp.WinToolbar=function(c){var b=SYNO.FileStation.Comp;var a=function(){var h=SYNO.FileStation.Comp;var i=new SYNO.ux.Menu({itemId:"rToolbarCtx",cls:"syno-webfm",items:[{itemId:"gc_extern_last",hidden:true}],listeners:{beforeshow:{fn:this.onUpdateBtnStatus,scope:this},show:{fn:function(){SYNO.webfm.utils.ShowHideMenu(this.items)},scope:i}}});this.toolbarMenu=i;this.btnDownloadMenu=h.cDownloadMenu(Ext.menu.Item,true,this);i.add(this.btnDownloadMenu);this.btnDownloadMenu.hide();this.btnDownload=h.cDownload(Ext.menu.Item,true,this);i.add(this.btnDownload);i.addSeparator();this.btnOpenWin=h.cOpenWin(Ext.menu.Item,true,this);i.addItem(this.btnOpenWin);i.add(new Ext.menu.Separator({xtype:"tbseparator",itemId:"sep_extract"}));i.add(this.btnExtractMenu=h.cExtractMenuBtn(Ext.menu.Item,true,this));this.btnCompressAdv=h.cCompressAdv(Ext.menu.Item,true,this);i.add(this.btnCompressAdv);this.btnCompress=h.cCompress(Ext.menu.Item,true,this);i.add(this.btnCompress);i.add(new Ext.menu.Separator({xtype:"tbseparator",itemId:"sep_archive"}));i.add(this.btnMVCPToMenu=h.cMVCPToMenu(Ext.menu.Item,true,this));this.btnCut=h.cCut(Ext.menu.Item,true,this);i.add(this.btnCut);this.btnCopy=h.cCopy(Ext.menu.Item,true,this);i.add(this.btnCopy);this.btnPasteOvwr=h.cPasteOvwr(Ext.menu.Item,true,this);i.add(this.btnPasteOvwr);this.btnPasteSkip=h.cPasteSkip(Ext.menu.Item,true,this);i.add(this.btnPasteSkip);this.btnDelete=h.cDelete(Ext.menu.Item,true,this);i.add(this.btnDelete);this.btnRename=h.cRename(Ext.menu.Item,true,this);i.add(this.btnRename);i.addSeparator();i.add(this.btnFavSubMenu=h.cAddFavMenuBtn(Ext.menu.Item,true,this));i.add(this.btnDSMShortcut=h.cDSMDeskShortcutBtn(Ext.menu.Item,true,this,_WFT("shortcut","make_to_dsm_dekstop")));i.addItem(this.sepFav=new Ext.menu.Separator());i.add(this.btnProperty=h.cProperty(Ext.menu.Item,true,this));i.add(this.btnShare=h.cSharing(Ext.menu.Item,true,this));return i};var g=function(){var i=SYNO.FileStation.Comp;var k=new SYNO.ux.Menu({cls:"syno-webfm",listeners:{beforeshow:{fn:function(){this.onUpdateBtnStatus();k.showMountItem()},scope:this}}});this.btnRemoteConnect=i.cRemoteConnect(Ext.menu.Item,true,this);k.add(this.btnRemoteConnect);var j=function(l){this.btnRemoteConnect.setVisible(l)};k.showRemoteConnectItem=j.createDelegate(this,[true]);k.hideRemoteConnectItem=j.createDelegate(this,[false]);k.showMountItem=Ext.emptyFn;k.hideMountItem=Ext.emptyFn;if("yes"===_D("supportmount")){this.btnMountRemote=i.cMountRemote(Ext.menu.Item,true,this);k.add(this.btnMountRemote);this.btnMountISO=i.cMountISO(Ext.menu.Item,true,this);k.add(this.btnMountISO);this.btnUmount=i.cUmount(Ext.menu.Item,true,this);k.add(this.btnUmount);this.btnMountList=i.cMountList(Ext.menu.Item,true,this);k.add(this.btnMountList);k.add(new Ext.menu.Separator({itemId:"sep_mount",hidden:true}));var h=function(l){if(!_S("is_admin")&&!this.dirTree.getNodeById("remote/home")){this.btnMountRemote.setVisible(false)}else{this.btnMountRemote.setVisible(l)}this.btnMountISO.setVisible(l);this.btnUmount.setVisible(l);this.btnMountList.setVisible(l);k.get("sep_mount").setVisible(l);if(l&&"yes"===_D("supportmount")&&this.mountConfig){if(this.mountConfig.enable_remote_mount||this.mountConfig.enable_iso_mount){if(this.btnUmount){this.btnUmount.show()}}else{if(this.btnUmount){this.btnUmount.hide()}}if(!this.mountConfig.enable_remote_mount){if(this.btnMountRemote){this.btnMountRemote.hide()}}else{if(!_S("is_admin")&&!this.dirTree.getNodeById("remote/home")){this.btnMountRemote.hide()}else{if(this.btnMountRemote){this.btnMountRemote.show()}}}if(!this.mountConfig.enable_iso_mount){if(this.btnMountISO){this.btnMountISO.hide()}}else{if(this.btnMountISO){this.btnMountISO.show()}}if(!this.mountConfig.enable_remote_mount&&!this.mountConfig.enable_iso_mount){this.btnMountList.hide()}else{this.btnMountList.show()}}SYNO.webfm.utils.ShowHideMenu(k.items)};k.showMountItem=h.createDelegate(this,[true]);k.hideMountItem=h.createDelegate(this,[false])}this.btnSharingManager=i.cSharingManager(Ext.menu.Item,true,this);k.add(this.btnSharingManager);return k};var d=function(){var h=new Ext.Toolbar({cls:"syno-sds-fs-btbar"});this.displayType=b.cBtnDisplayType(this);h.add(this.displayType);this.btnLocalUpload=b.cUploadLocal(SYNO.ux.Button,false,this);h.add(this.btnLocalUpload);this.btnRemoteUpload=b.cUploadRemote(SYNO.ux.Button,false,this);h.add(this.btnRemoteUpload);if(!_S("is_admin")||_S("diskless")||_S("standalone")){this.btnNewFolder=b.cNewFolder(SYNO.ux.Button,false,this);h.add(this.btnNewFolder);if(_S("demo_mode")){this.btnNewFolder.hide()}}else{this.btnNewFolder=b.cNewFolder(Ext.menu.Item,true,this);this.btnNewShareFolder=b.cNewShareFolder(Ext.menu.Item,true,this);this.menuCreateFolder=new SYNO.ux.Button({text:_WFT("common","create"),menu:new SYNO.ux.Menu({cls:"syno-webfm",items:[this.btnNewFolder,this.btnNewShareFolder]})});h.add(this.menuCreateFolder);if(_S("demo_mode")){this.menuCreateFolder.hide()}}this.btntoolbarMenu=b.cActionMenu(a.call(this));h.add(this.btntoolbarMenu);this.btnToolsMenu=b.cToolsMenu(g.call(this));h.add(this.btnToolsMenu);this.btnSettings=b.cSettings(SYNO.ux.Button,false,this);h.add(this.btnSettings);h.addFill();this.btnViewMode=b.cViewMode(SYNO.ux.SplitButton,this);h.addItem(this.btnViewMode);this.btnSort=b.cSort(SYNO.ux.Button,this);this.btnSort.setText("");this.btnSort.addClass("webfm-sort-btn");h.addItem(this.btnSort);return h};var e=function(){this.fileFilter=b.cFileFilter(this);this.pathBar=new SYNO.FileStation.PathBar({webfm:this});this.pathBar.tbPanel.mon(this.pathBar,"updatepath",this.updateFavBtn,this);this.btnHisBack=b.cHisBack(SYNO.ux.Button,this);this.btnHisNext=b.cHisNext(SYNO.ux.Button,this);this.btnRefreshTree=new SYNO.ux.Button({tooltip:_WFT("common","common_refresh"),iconCls:"syno-sds-fs-tbar-refresh",listeners:{click:{fn:this.reloadTree,scope:this}}});var h=new Ext.Toolbar({cls:"syno-sds-fs-ttbar",itemId:"topToolbar",items:[this.btnHisBack,this.btnHisNext,{xtype:"syno_displayfield",width:3},this.btnRefreshTree,{xtype:"syno_displayfield",width:3},this.pathBar.tbPanel,{itemId:"addfav",iconCls:"sds-window-tbar-fav sds-window-tbar-addfav",ctCls:"sds-window-tbar-nomargin-btn",scope:this,tooltip:_WFT("favorite","add_favorite"),handler:function(){var i=this.dirTree.getNodeById(this.getCurrentSource()+this.getCurrentDir());if(i){var j=SYNO.webfm.utils.transNodeToRecs(i);this.FileAction.AddFav(j)}}},{itemId:"delfav",iconCls:"sds-window-tbar-fav sds-window-tbar-delfav",ctCls:"sds-window-tbar-nomargin-btn",scope:this,hidden:true,tooltip:_WFT("favorite","del_favorite"),handler:function(){var i=this.dirTree.getNodeById("fm_fav_root");if(i){i.childNodes.each(function(j){if(this.getCurrentDir()===j.attributes.path){this.FileAction.DelFav(j.attributes.path,j.attributes.text);return false}},this)}}},{xtype:"syno_displayfield",width:8,height:28},this.fileFilter],listeners:{resize:{fn:function(){var j=0;h.items.each(function(l){if(true!==l.hidden){j+=l.getOuterSize().width}});j-=this.pathBar.tbPanel.getWidth();var i=h.getWidth()-h.getResizeEl().getPadding("lr");var k=i-j+1;if(k>0){this.pathBar.setWidth(k)}},scope:this},afterlayout:{fn:function(){var i=this.pathBar.tbPanel.getEl();i.setStyle("overflow","hidden")},scope:this,single:true}}});return h};var f=function(){var i=e.call(c);var j=d.call(c);var h=new Ext.Container({cls:"syno-sds-fs-tbar",layout:{type:"vbox",pack:"start",align:"stretch"},height:36*2,defaults:{flex:1},items:[i,j],getTopToolBar:function(){return i},getBottomToolbar:function(){return j}});return h};return f.call(c)};Ext.ns("SYNO.FileStation.Action");SYNO.FileStation.Action.Basic=Ext.extend(Ext.Component,{constructor:function(b,d,a){this.initVaribles(b,a);var c=d?d.id:b.bkTaskCfg.taskid;if(!d){if(b.bkTaskCfg&&!b.bkTaskCfg.api){d=SYNO.SDS.BackgroundTaskMgr.addTask({id:c,title:this.genBkTitle(this.actionStr,this.fileStr),query:{url:b.bkTaskCfg.url,params:{action:"readprogress",taskid:c}},cancel:{url:b.bkTaskCfg.url,params:{action:"cancelprogress",taskid:c}}})}else{d=SYNO.SDS.BackgroundTaskMgr.addWebAPITask({id:c,title:this.genBkTitle(this.actionStr,this.fileStr),query:{api:b.bkTaskCfg.api,method:"status",version:b.bkTaskCfg.version||1,params:{taskid:c}},cancel:{api:b.bkTaskCfg.api,method:"stop",version:b.bkTaskCfg.version||1,params:{taskid:c}}})}}d.addCallback(this.onTaskCallBack,this);if(!this.blMsgMinimized&&!this.isOwnerDestroyed()){var e=((b.msgCfg.msg)?b.msgCfg.msg:this.actingText)+"...";this.showProgress(this.actionText,e,this.onCancelCallBack.createDelegate(this,[d]),true,b.msgCfg.progress)}this.bkTask=d},initVaribles:function(b,a){Ext.apply(this,b.actionCfg||{});this.webfm=b.webfm;this.owner=b.owner||this.webfm.owner;this.blMsgMinimized=(this.blMsgMinimized===true)?true:((b.msgCfg&&b.msgCfg.blMsgMinimized)?b.msgCfg.blMsgMinimized:false);this.actionStr=b.actionStr;this.actingStr=b.actingStr;this.actionText=SYNO.webfm.utils.getLangText(this.actionStr);this.actingText=SYNO.webfm.utils.getLangText(this.actingStr);this.extra=a},genBkTitle:function(a,b){return["{0}: {1}","filebrowser:"+a.key,b]},onCancelCallBack:function(a){a.cancel()},onCancelTask:function(d,e,c){this.hideProgress();if(d.errno&&d.errno.section&&d.errno.key){var a=d.errno;var b=_WFT(a.section,a.key);if(this.isOwnerDestroyed()||!this.isOwnerVisible()){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",this.actionText,b)}else{this.getMsgBox().alert(this.actionText,b)}}},onFinishTask:function(a,c,d,b){if(c&&c.errors){this.showWebAPIErr(c,d,b)}else{if((c.result&&c.result=="fail")||a===-1){this.showErrItems(c,d,b)}else{this.onCompleteTask(c,d,b)}}},onCompleteTask:function(b,c,a){},onProgressTask:function(b,f,h,e){if(this.blMsgMinimized||this.isOwnerDestroyed()){return}if(f&&b&&0<b){var a=Ext.util.Format.htmlEncode(SYNO.webfm.utils.parseFullPathToFileName(f.processing_path||f.pfile||""));var d=(b*100).toFixed(2);var g,c;c=d+"&#37;";if(Ext.isNumber(f.total)&&0<f.total){if(Ext.isNumber(f.processed_num)){c=d+"&#37;&nbsp;("+(f.processed_num||0)+"/"+f.total+")"}else{if(Ext.isNumber(f.processed_size)){c=d+"&#37;&nbsp;("+Ext.util.Format.fileSize(f.processed_size||0)+"/"+Ext.util.Format.fileSize(f.total)+")"}}}c="<center>"+c+"</center>";g=a;this.getMsgBox().updateProgress(b,c,g,true)}},onTaskCallBack:function(a,d,g,b,e,f,c){if(!e){this.hideProgress();return}if("fail"===d){this.hideProgress()}else{if("cancel"===d){this.onCancelTask(e,f,c)}else{if(g){this.onFinishTask(b,e,f,c)}else{this.onProgressTask(b,e,f,c)}}}},showProgress:function(h,g,a,f,c){var e={};if(f){e.ok=_WFT("common","hide")}if(a){e.cancel=_WFT("common","common_cancel")}var b={title:h,msg:g,width:300,progress:c,progressText:c?"<center>0&#37;</center>":"",cls:"syno-webfm-progress",closable:false,buttons:e,cancelCb:(a?a:null),fn:function(i,k,j){if(i==="ok"){this.onMinimzieMsgBox()}else{if(i==="cancel"){j.cancelCb()}}}.createDelegate(this),hideDlg:true,scope:this};var d={owner:this.owner||this.webfm.owner};this.getMsgBox(d).show(b)},onMinimzieMsgBox:function(){var a=this.getMsgBox().getDialog();a.mon(a,"hide",function(){a.doClose()});if(_S("standalone")){a.hide(this.webfm.monitorPanel.el);this.webfm.monitorPanel.activeTabPanel("background")}else{var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0].getBKTray().taskButton.el;a.hide(b)}this.blMsgMinimized=true;this.sendFileTaskNotify()},sendFileTaskNotify:function(){this.webfm.owner.sendFileTaskNotify(true,this.bkTask.id)},hideProgress:function(){if(!this.blMsgMinimized&&!this.isOwnerDestroyed()){this.getMsgBox().hide()}},showWebAPIErr:function(b,d,a){this.hideProgress();if(this.blMsgMinimized||this.isOwnerDestroyed()||!this.isOwnerVisible()){return}var c=SYNO.webfm.utils.getWebAPIErr(false,b,d);this.getMsgBox().alert(this.actionText,c)},showErrItems:function(e){this.hideProgress();if(this.blMsgMinimized||this.isOwnerDestroyed()||!this.isOwnerVisible()){return}var d="";var c=0;if(e.errno){d+=_WFT(e.errno.section,e.errno.key)+"<br>"}var f,b,a;if(e.errItems&&0<e.errItems.length){a=(e.errItems.length>15)?15:e.errItems.length;d+=_WFT("error","error_files");for(c=0;c<a;c++){f=e.errItems[c].name;b=f.lastIndexOf("/");b=(b==-1)?1:b+1;f=f.substr(b);if(f.length>40){f=f.substr(0,37)+"..."}d+="<br>"+Ext.util.Format.htmlEncode(f);if(e.errItems[c].section){d+="<br>"+_WFT(e.errItems[c].section,e.errItems[c].key)}}if(a<e.errItems.length){d+="<br>..."}}if(d===""){d=_WFT("common","error_system")}this.getMsgBox().alert(this.actionText,d)},isOwnerVisible:function(){return(this.owner&&this.owner.isVisible())},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},getMsgBox:function(a){return this.webfm.owner.getMsgBox(a)},callFileBrowsers:function(b,a){var c=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance");Ext.each(c,function(e){var d=e.window.getPanelInstance();var f=Ext.getClassByName("SYNO.FileStation.WindowPanel.superclass."+b);f.apply(d,a)})},setHighlightEntry:function(){this.callFileBrowsers("setHighlightEntry",arguments)},refreshTreeNode:function(){this.callFileBrowsers("refreshTreeNode",arguments)},refreshSearhGrid:function(a){this.callFileBrowsers("refreshSearhGrid",arguments)}});Ext.ns("SYNO.FileStation.LocalAction");SYNO.FileStation.LocalAction.Basic=Ext.extend(SYNO.FileStation.Action.Basic,{constructor:function(a,c){this.initVaribles(a);this.localGrid=SYNO.FileStation.instance().getFileTaskInstance();var b=this.localGrid.getStore();this.pollingTask=this.addTask({interval:600,run:function(){var h=b.getById(c);if(h){var e=h.get("status");switch(e){case"NOT_STARTED":break;case"PROCESSING":this.onProgressTask(h.get("progress"),h.get("statusText"),h.data);break;case"FAIL":this.refreshTreeNode(this.srcIdArr,true);this.hideProgress();this.pollingTask.stop();var g=h.get("statusQtip");if(!this.blMsgMinimized&&(!(this.isOwnerDestroyed()||!this.isOwnerVisible()))){this.getMsgBox().alert(this.actionText,g)}else{SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",this.actionText,g)}break;case"SUCCESS":this.onCompleteTask(c);break;default:this.hideProgress();this.pollingTask.stop();break}}else{var f=AppletProgram.action({action:"gettask",id:c});if(!f){this.refreshTreeNode(this.srcIdArr,true);this.hideProgress();this.pollingTask.stop()}else{if(f.status==="SUCCESS"){this.onCompleteTask(c)}}}},scope:this});var d=((a.msgCfg.msg)?a.msgCfg.msg:this.actingText)+"...";this.showProgress(this.actionText,d,this.removeTask.createDelegate(this,[c]),true,a.msgCfg.progress);this.pollingTask.start(true)},removeTask:function(a){var b=this.localGrid.getStore().getById(a);this.localGrid.removeOneTask(b)},initVaribles:function(a){Ext.apply(this,a.actionCfg||{});this.webfm=a.webfm;this.owner=a.owner||this.webfm.owner;this.blMsgMinimized=(this.blMsgMinimized===true)?true:((a.msgCfg&&a.msgCfg.blMsgMinimized)?a.msgCfg.blMsgMinimized:false);this.actionStr=a.actionStr;this.actingStr=a.actingStr;this.actionText=SYNO.webfm.utils.getLangText(this.actionStr);this.actingText=SYNO.webfm.utils.getLangText(this.actingStr)},onProgressTask:function(a,e,c){if(this.blMsgMinimized||this.isOwnerDestroyed()){return}if(a&&0<a){var d,b,f=a/100;a=(a).toFixed(2);b=a+"&#37;";if(Ext.isNumber(c.total)&&0<c.total){if(Ext.isNumber(c.processed_num)){b=a+"&#37;&nbsp;("+(c.processed_num||0)+"/"+c.total+")"}else{if(Ext.isNumber(c.processed_size)){b=a+"&#37;&nbsp;("+Ext.util.Format.fileSize(c.processed_size||0)+"/"+Ext.util.Format.fileSize(c.total)+")"}}}b="<center>"+b+"</center>";d=e;this.getMsgBox().updateProgress(f,b,d)}},onCompleteTask:function(a){this.hideProgress();this.pollingTask.stop();this.removeTask(a)},sendFileTaskNotify:Ext.emptyFn,onMinimzieMsgBox:function(){var a=this.getMsgBox().getDialog();a.mon(a,"hide",function(){a.doClose()});if(_S("standalone")){a.hide(this.webfm.monitorPanel.el);this.webfm.monitorPanel.activeTabPanel("local")}else{var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0].getBKTray().taskButton.el;a.hide(b)}this.blMsgMinimized=true}});Ext.ns("SYNO.FileStation.Action");SYNO.FileStation.Action.MVCP=Ext.extend(SYNO.FileStation.Action.Basic,{onProgressTask:function(b,h,f,a){if(this.blMsgMinimized||this.isOwnerDestroyed()){return}if(h&&b&&(0<b||0<parseInt(h.found_file_num,10)||0<parseInt(h.found_dir_num,10))){var i=this.getRemainTimeStr(h);var d=Ext.util.Format.fileSize(h.transfer_rate.toFixed(2))+"/s";var c=Ext.util.Format.htmlEncode(SYNO.webfm.utils.parseFullPathToFileName(h.processing_path||h.pfile||""));var j=(b*100).toFixed(2);var e,g;if("NOT_STARTED"===h.status){g=_T("background_task","task_waiting")}else{if(0<b){g=j+"&#37;";if(Ext.isNumber(h.total)&&0<h.total){if(Ext.isNumber(h.processed_num)){g=j+"&#37;&nbsp;("+(h.processed_num||0)+"/"+h.total+")"}else{if(Ext.isNumber(h.processed_size)){g=j+"&#37;&nbsp;("+Ext.util.Format.fileSize(h.processed_size||0)+"/"+Ext.util.Format.fileSize(h.total)+")"}}}g='<div><div style="float:left;">'+g+'</div><div style="float: right; padding-right: 28px;">'+d+'</div></div> </br><div style="padding-top: 5px;">'+_WFT("common","time_remain")+": "+i+"</div>"}else{g=String.format(_WFT("common","count_file_dir_size"),h.found_file_num,h.found_dir_num,Ext.util.Format.fileSize(h.found_file_size));c=_WFT("common","calculating")}}e=c;this.getMsgBox().updateProgress(b,g,e,true)}},getRemainTimeStr:function(e){if(!e){return _T("common","unknown")}var g,b,a,c,d,f;g=(e.total-e.processed_size)/e.transfer_rate;b=g/(24*3600);if(b>1){f=_WFT("common","time_greater_day")}else{f="";a=parseInt(g/3600,10);c=parseInt(g/60-a*60,10);d=parseInt(g-c*60-a*3600,10);f+=(a>=1)?a+" "+_T("status","status_hour")+", ":"";f+=(c>=1)?c+" "+_T("status","status_minute"):"";if(f===""){f=_WFT("common","time_less_min")}}return f},onCancelTask:function(b,c,a){SYNO.FileStation.Action.MVCP.superclass.onCancelTask.call(this,b);this.refreshTreeNode(this.srcIdArr.concat(this.destId),true);if(this.extra&&Ext.isDefined(this.extra.search_taskid)){this.refreshSearhGrid(this.extra.search_taskid)}},onCompleteTask:function(b,c,a){this.hideProgress();this.refreshTreeNode(this.srcIdArr.concat(this.destId),true);if(this.extra&&Ext.isDefined(this.extra.search_taskid)){this.refreshSearhGrid(this.extra.search_taskid)}}});SYNO.FileStation.LocalAction.MVCP=Ext.extend(SYNO.FileStation.LocalAction.Basic,{onCancelTask:function(a){SYNO.FileStation.LocalAction.MVCP.superclass.onCancelTask.call(this,a);this.refreshTreeNode(this.srcIdArr.concat(this.destId),true,SYNO.webfm.utils.source.local)},onCompleteTask:function(a){this.refreshTreeNode(this.srcIdArr.concat(this.destId),true,SYNO.webfm.utils.source.local);SYNO.FileStation.LocalAction.MVCP.superclass.onCompleteTask.apply(this,arguments)}});Ext.ns("SYNO.FileStation.Action");SYNO.FileStation.Action.Delete=Ext.extend(SYNO.FileStation.Action.Basic,{showWebAPIErr:function(b,c,a){this.refreshTreeNode(this.srcIdArr,true);SYNO.FileStation.Action.Delete.superclass.showWebAPIErr.call(this,b)},onCompleteTask:function(b,c,a){this.hideProgress();this.refreshTreeNode(this.srcIdArr,true);if(this.extra&&Ext.isDefined(this.extra.search_taskid)){this.refreshSearhGrid(this.extra.search_taskid)}},onProgressTask:function(b,f,h,e){if(this.blMsgMinimized||this.isOwnerDestroyed()){return}if(f&&b&&(0<b||0<parseInt(f.found_file_num,10)||0<parseInt(f.found_dir_num,10))){var a=Ext.util.Format.htmlEncode(SYNO.webfm.utils.parseFullPathToFileName(f.processing_path||f.pfile||""));var d=(b*100).toFixed(2);var g,c;if(0<b){c=d+"&#37;";if(Ext.isNumber(f.total)&&0<f.total){if(Ext.isNumber(f.processed_num)){c=d+"&#37;&nbsp;("+(f.processed_num||0)+"/"+f.total+")"}else{if(Ext.isNumber(f.processed_size)){c=d+"&#37;&nbsp;("+Ext.util.Format.fileSize(f.processed_size||0)+"/"+Ext.util.Format.fileSize(f.total)+")"}}}c="<center>"+c+"</center>"}else{c=String.format(_WFT("common","count_file_dir_size"),f.found_file_num,f.found_dir_num,Ext.util.Format.fileSize(f.found_file_size))}g=a;this.getMsgBox().updateProgress(b,c,g,true)}}});SYNO.FileStation.LocalAction.Delete=Ext.extend(SYNO.FileStation.LocalAction.Basic,{onCompleteTask:function(a){this.refreshTreeNode(this.srcIdArr,true,this.source);SYNO.FileStation.LocalAction.Delete.superclass.onCompleteTask.apply(this,arguments)}});Ext.ns("SYNO.FileStation.Action");SYNO.FileStation.Action.Extract=Ext.extend(SYNO.FileStation.Action.Basic,{blMultiExtract:false,blCancel:false,gZipArr:[],gZipIndex:0,gDestArr:[],initVaribles:function(a){SYNO.FileStation.Action.Extract.superclass.initVaribles.call(this,a);this.cfg=a;this.url=a.bkTaskCfg.url;this.gZipArr=this.gZipArr?this.gZipArr:[];this.gDestArr=this.gDestArr?this.gDestArr:[]},getCurZipFile:function(){var a;if(this.blMultiExtract&&this.gZipArr&&this.gZipArr.length>0){a=this.gZipArr[this.gZipIndex]}else{a=this.file_path}return a},getCurZipName:function(){return SYNO.webfm.utils.parseFullPathToFileName(this.getCurZipFile())},resetExtractAction:function(){this.gZipArr=[];this.gDestArr=[];this.gZipIndex=0},genBkTitle:function(a,b){return["{0}: {1}","filebrowser:"+a.key,this.getCurZipName()+b]},onCancelCallBack:function(c,a,b){this.blCancel=true;this.resetExtractAction();SYNO.FileStation.Action.Extract.superclass.onCancelCallBack.apply(this,arguments)},onFinishTask:function(a,d,f,c){if(d.errors&&d.errors[0].code==1403){this.hideProgress();this.blMsgMinimized=false;var b=this.getCurZipFile();var e=this.actionText+" "+Ext.util.Format.htmlEncode(SYNO.webfm.utils.parseFullPathToFileName(b));this.getMsgBox().show({title:e,msg:_WFT("extract","extract_enter_pass"),buttons:Ext.MessageBox.OKCANCEL,fn:function(h,g){if(h=="ok"){var i=this.ajaxParams;var j=i;j.file_path=SYNO.API.EscapeStr(b);j.dest_folder_path=(this.gDestArr.length>1)?this.gDestArr[this.gZipIndex]:i.dest_folder_path;j.dest_folder_path=SYNO.API.EscapeStr(j.dest_folder_path);j.password=g;SYNO.API.currentManager.requestAPI("SYNO.FileStation.Extract","start","1",j,this.onExtractSendDone,this);this.ajaxParams=j}},width:310,minWidth:250,scope:this,prompt:true,password:true})}else{if(d.errors){this.showWebAPIErr(d,f,c);this.refreshTreeNode([this.destId],true)}else{this.onCompleteTask(d,f,c)}}},onCompleteTask:function(b,d,a){this.refreshTreeNode([this.destId],true);if(this.blMultiExtract&&!this.blCancel){this.gZipIndex++;if(this.gZipIndex<this.gZipArr.length&&this.gZipArr[this.gZipIndex]){var c=this.ajaxParams;var e=c;e.file_path=SYNO.API.EscapeStr(this.gZipArr[this.gZipIndex]);e.dest_folder_path=(this.gDestArr.length>1)?this.gDestArr[this.gZipIndex]:c.dest_folder_path;e.dest_folder_path=SYNO.API.EscapeStr(e.dest_folder_path);this.hideProgress();SYNO.API.currentManager.requestAPI("SYNO.FileStation.Extract","start","1",e,this.onExtractSendDone,this);this.ajaxParams=e;return}}this.hideProgress()},onExtractSendDone:function(d,c,b){if(!d||!c||!c.taskid){var a=SYNO.webfm.utils.getWebAPIErrStr(d,c,b);if(this.blMsgMinimized||this.isOwnerDestroyed()||!this.isOwnerVisible()){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",this.actionText,a)}else{this.getMsgBox().alert(this.actionText,a)}}else{this.cfg.bkTaskCfg.taskid=c.taskid;SYNO.FileStation.Action.Extract.superclass.constructor.call(this,this.cfg)}}});Ext.ns("SYNO.FileStation.Action");SYNO.FileStation.Action.Compress=Ext.extend(SYNO.FileStation.Action.Basic,{onProgressTask:function(a,b){},onCompleteTask:function(a){this.hideProgress();this.setHighlightEntry(this.fileid);this.refreshTreeNode(this.srcIdArr,true)}});SYNO.FileStation.WebCache=Ext.extend(Object,{constructor:function(a){this.data=a||new Ext.util.MixedCollection(false,function(b){return b.name.toLowerCase()})},destroy:function(){delete this.data},getSharingPrivilege:function(){return this.data.clone()},getCount:function(){return this.data.getCount()},get:function(a){return this.data.get(a)},addData:function(a,b){this.data.add(a,b)},addAllData:function(a){this.data.addAll(a)},removeKey:function(a){this.data.removeKey(a)},clear:function(){this.data.clear()}});SYNO.FileStation.SharingConfigGrid=Ext.extend(SYNO.ux.GridPanel,{constructor:function(b){var a=this.fillConfig(b);SYNO.FileStation.SharingConfigGrid.superclass.constructor.call(this,a)},fillConfig:function(b){this.enableColumn=new SYNO.ux.EnableColumn({header:_T("common","enabled"),dataIndex:"enabled",width:50,align:"center",enableFastSelectAll:true});this.columnModel=new Ext.grid.ColumnModel([this.enableColumn,{header:_T("user","user_account"),dataIndex:"name",width:100}]);this.userStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:b.RELURL+"webUI/settings.cgi",method:"POST"}),baseParams:{action:"loaduser",start:0,limit:1000},reader:new Ext.data.JsonReader({root:"data.items",totalProperty:"data.total",id:"name"},["enabled","name"]),remoteSort:true,listeners:{load:{fn:function(d,c,e){var f=0,g=null;for(f=0;f<c.length;f++){g=this.sharingPrivilege.get(c[f].get("name").toLowerCase());if(g&&true===g.enabled){c[f].set("enabled",true)}else{if(g&&false===g.enabled){c[f].set("enabled",false)}}}d.commitChanges()},scope:this},beforeload:{fn:function(d,e){if(this.query!==e.query){this.query=e.query;this.sharingPrivilege.clear();return}var c=d.getModifiedRecords();if(this.sharingPrivilege){this.sharingPrivilege.addAllData(Ext.pluck(c,"data"))}},scope:this}}});this.addManagedComponent(this.userStore);var a={header:false,cm:this.columnModel,ds:this.userStore,loadMask:true,tbar:{items:["->",new SYNO.ux.TextFilter({itemId:"search",queryAction:"finduser",enumAction:"loaduser",emptyText:_T("group","search_group"),store:this.userStore,pageSize:1000})]},view:new SYNO.ux.FleXcroll.grid.BufferView({scrollDelay:false,forceFit:true}),bbar:this.paging=new SYNO.ux.PagingToolbar({store:this.userStore,displayInfo:true,pageSize:1000,showRefreshBtn:true,doRefresh:function(){this.store.rejectChanges();SYNO.ux.PagingToolbar.prototype.doRefresh.call(this)}}),plugins:[this.enableColumn]};Ext.apply(a,b);return a},load:function(){this.paging.doRefresh()},setSharingPrivilege:function(a){this.sharingPrivilege=new SYNO.FileStation.WebCache(a)},getSharingPrivilege:function(){var b=this.getStore(),a=b.getModifiedRecords();this.sharingPrivilege.addAllData(Ext.pluck(a,"data"));return this.sharingPrivilege}});SYNO.FileStation.SharingConfig=Ext.extend(SYNO.ux.FormPanel,{constructor:function(a){var b=this.fillConfig(a);SYNO.FileStation.SharingConfig.superclass.constructor.call(this,b);this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.getComponent("security_fieldset").getComponent("disable_html_checkbox").getEl(),_WFT("security","disable_html_info"))},this,{single:true})},fillConfig:function(a){var b={border:false,trackResetOnLoad:true,items:[{xtype:"syno_fieldset",title:_T("helptoc","sharing"),items:[{xtype:"syno_displayfield",value:_WFT("sharing","config_desc")},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","everyone"),name:"sharing_allow",inputValue:"everyone"},{xtype:"syno_radio",indent:1,boxLabel:_WFT("mount","admin"),name:"sharing_allow",inputValue:"admin"},{xtype:"syno_radio",indent:1,boxLabel:_T("sharewizard","access_user"),name:"sharing_allow",inputValue:"per_user",handler:this.onCheckChanged.createDelegate(this)},{xtype:"hidden",ref:"../hiddenField",value:""},{xtype:"syno_button",indent:1,text:_T("sharewizard","access_user"),ref:"../setSharingPriviledgeBtn",disabled:true,scope:this,handler:this.onClickSetSharingPriviledge},{xtype:"syno_displayfield"},{xtype:"syno_checkbox",itemId:"gofileme_protocol",name:"sharing_gofile_protocol",boxLabel:_WFT("sharing","sharing_gofile_desc")},{xtype:"syno_displayfield",value:_WFT("sharing","sharing_gofile_note"),indent:1}]},{xtype:"syno_fieldset",itemId:"security_fieldset",title:_T("dsmsetting","session_legend"),items:[{xtype:"syno_checkbox",itemId:"disable_html_checkbox",name:"sharing_disable_html",boxLabel:_WFT("security","disable_html")}]}]};Ext.apply(b,a||{});return b},onCheckChanged:function(a,b){this.setSharingPriviledgeBtn.setDisabled(b!==true)},openSharingPrivilege:function(){var a=this,c=new SYNO.FileStation.SharingConfigGrid({owner:this,RELURL:this.RELURL});var b=new SYNO.SDS.ModalWindow({owner:a.owner,resizable:true,minimizable:false,maximizable:false,closable:true,layout:"fit",width:600,height:400,title:_T("sharewizard","access_user"),items:[c],buttons:[{btnStyle:"blue",text:_T("common","apply"),handler:this.onApplySharingPriviledge.createDelegate(this,[c]).createSequence(function(){b.close()})},{text:_T("common","cancel"),handler:function(){b.close()}}]});b.show(null,function(){c.setSharingPrivilege(this.sharingPrivilege.getSharingPrivilege());c.load()},this)},onApplySharingPriviledge:function(a){this.sharingPrivilege=a.getSharingPrivilege();this.hiddenField.setValue(this.sharingPrivilege)},onClickSetSharingPriviledge:function(){this.openSharingPrivilege()},setSharingPrivilege:function(a){if(this.sharingPrivilege){this.sharingPrivilege.clear()}else{this.sharingPrivilege=new SYNO.FileStation.WebCache()}this.sharingPrivilege.addAllData(a)},getSharingPrivilege:function(){if(!this.sharingPrivilege){return{enable:"",disable:""}}var b=this.sharingPrivilege.getSharingPrivilege(),a=[],c=[];if(b.getCount()>0){b.each(function(d){if(d.enabled){a.push(d.name)}else{c.push(d.name)}},this)}return{enable:a.join(","),disable:c.join(",")}}});Ext.ns("SYNO.FileStation");SYNO.FileStation.BasicTabPanel=Ext.extend(SYNO.ux.TabPanel,{constructor:function(a){var c={plain:true,height:300,deferredRender:false,autoWidth:true,listeners:{scope:this,activate:this.onActivate,tabchange:this.onTabchange,beforetabchange:this.onBeforeTabChange,beforeshow:{scope:this,fn:this.onBeforeshow,single:true}}};Ext.apply(c,a||{});this.addEvents(["applyfail","loadfail","requestfail","applysuccess"]);SYNO.FileStation.BasicTabPanel.superclass.constructor.call(this,c);var b=this.getAllForms();Ext.each(b,function(f,d,e){f.items.each(function(i,g,h){if(i.isFormField&&i.clearInvalid){i.mon(i,"disable",i.clearInvalid,i)}})},this);this.defineBehaviors()},defineBehaviors:function(){this.checkTabDirty=true;this.ERR_STR_FN=_T;this.ERR_STR_STRUCT=SYNO_WebManager_Strings},applyHandler:function(b,a){this.applyAllForm()},cancelHandler:function(b,a){},resetHandler:function(){this.resetAllForm();this.resetAllGrid()},loadAllForm:function(a){if(!this.url){SYNO.Debug("No url in TabPanel "+_T("helptoc","settings"));return}var b=Ext.applyIf({params:{action:"load"}},a);if(false===this.onBeforeRequest(b)){return false}this.sendAjaxRequest(b)},applyAllForm:function(a){var c={};if(!this.url){SYNO.Debug("No url in TabPanel "+_T("helptoc","settings"));return false}if(this.checkTabDirty&&!this.isAnyTabDirty()){this.owner.mun(this.owner,"beforeclose",this.onBeforeDeactivate,this);this.owner.close();return true}var b=Ext.applyIf({method:"POST",params:{action:"apply"}},a);if(false===this.onBeforeRequest(b)){return false}if(!_S("is_admin")){this.owner.setStatusOK();this.owner.mun(this.owner,"beforeclose",this.onBeforeDeactivate,this);this.owner.close();return}this.items.each(function(h,e,g){if(!h.getForm){return}var f=h.getForm();var d=f.getValues();Ext.apply(c,d)},this);this.processBandwidthApplyData(c);Ext.apply(b.params,c);this.sendAjaxRequest(b)},resetAllForm:function(){var a=this.getAllForms();Ext.each(a,function(d,b,c){d.reset()},this)},resetAllGrid:function(){var a=this.getAllGrids();Ext.each(a,function(d,b,c){d.getStore().rejectChanges()},this)},isAnyTabDirty:function(){var a=this.getAllForms();var b=this.getAllGrids();var c=false;Ext.each(a,function(f,d,e){if(f.isDirty()){c=true;return false}},this);Ext.each(b,function(f,d,e){if(0<f.getStore().getModifiedRecords().length){c=true;return false}},this);return c},onBeforeDeactivate:function(){if(!this.checkTabDirty){this.resetHandler()}else{if(this.isAnyTabDirty()){this.owner.getMsgBox().confirm(this.owner.title,_T("common","confirm_lostchange"),function(a){if(a==="yes"){this.resetHandler();this.owner.close()}},this);return false}}return true},getAllGrids:function(){var a=[];this.items.each(function(d,b,c){if(!(d instanceof Ext.grid.GridPanel)){return}a.push(d)},this);return a},getAllForms:function(){var a=[];this.items.each(function(e,b,d){if(!e.getForm){return}var c=e.getForm();a.push(c)},this);return a},sendAjaxRequest:function(a){Ext.applyIf(a,{url:this.url,scope:this,single:true,success:this.onRequestSuccess,failure:this.onRequestFailure});if(a.params.action==="load"){this.owner.setStatusBusy()}else{this.owner.setStatusBusy({text:_T("common","saving")})}this.addAjaxTask(a).start(true)},onBeforeRequest:function(b){var a=this.getAllForms();var c=b.params.action;var d=true;if(c==="load"){return true}Ext.each(a,function(g,e,f){if(!g.isValid()){d=false;this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});this.setActiveByForm(g,e);return false}},this);if(!d){return false}return true},onRequestSuccess:function(a,b){if(this.isDestroyed){return}this.owner.clearStatusBusy();var c=(!a.responseText)?true:Ext.decode(a.responseText);var d=b.params.action;if(c===true||!c.success){if(d==="load"){this.reportLoadFail(b,c)}else{if(d==="apply"||d==="submit"){this.reportSubmitFail(b,c)}else{SYNO.Debug("Not handled action:",d)}}return}if(d==="apply"||d==="submit"){this.fireEvent("applysuccess",this,d);this.owner.setStatusOK();this.owner.mun(this.owner,"beforeclose",this.onBeforeDeactivate,this);this.owner.close();return}this.processBandwidthLoadData(c.data);this.items.each(function(h,e,g){if(!h.getForm){return}var f=h.getForm();f.loadRecord(c)},this)},onRequestFailure:function(a,b){if(this.isDestroyed){return}this.owner.clearStatusBusy();var c=_T("common","commfail");this.owner.getMsgBox().alert(_T("helptoc","settings"),c,function(d){this.fireEvent("requestfail",this,d,c)},this)},processBandwidthLoadData:function(a){if("bandwidth_enable"===a.bandwidth_enable){a.FileStation_policy="enabled"}else{if("bandwidth_schedule"===a.bandwidth_enable){a.FileStation_policy="scheduled"}else{a.FileStation_policy="disabled"}}if(a.schedule_plan){a.FileStation_schedule_plan=a.schedule_plan}delete a.bandwidth_enable;delete a.schedule_plan},processBandwidthApplyData:function(a){if("enabled"===a.FileStation_policy){a.bandwidth_enable="bandwidth_enable"}else{if("scheduled"===a.FileStation_policy){a.bandwidth_enable="bandwidth_schedule"}else{a.bandwidth_enable="bandwidth_disable"}}if(a.FileStation_schedule_plan){a.schedule_plan=a.FileStation_schedule_plan}delete a.FileStation_schedule_plan;delete a.FileStation_policy},onBeforeTabChange:function(c,a,d){if(a.disabled===true){return false}var b=c.getFooterToolbar();if(!b){return true}if(a instanceof Ext.form.FormPanel){b.show()}else{b.hide()}return true},reportLoadFail:function(a,b){var d;if(Ext.isObject(b.errinfo)){var c=b.errinfo;if(c.sec in this.ERR_STR_STRUCT&&c.key in this.ERR_STR_STRUCT[c.sec]){d=this.ERR_STR_FN(c.sec,c.key)}else{d=String.format("{0}{1}",c.sec,c.key)}if(Ext.isNumber(c.line)){d=String.format("{0} ({1})",d,c.line)}}else{d=_T("common","error_system")}this.owner.getMsgBox().alert(_T("helptoc","settings"),d,function(e){this.fireEvent("loadfail",this,e,d)},this)},setActiveByForm:function(c,b){var a=this.getAllForms();if(Ext.isNumber(b)&&this.items.getCount()===a.length){this.setActiveTab(b)}else{this.items.each(function(g,e,d){if(g.getForm&&g.getForm()===c){this.setActiveTab(e);return false}},this)}},reportSubmitFail:function(b,c){var f;if(c.errors){var a=this.getAllForms();var d;for(d in c.errors){if(c.errors.hasOwnProperty(d)){break}}Ext.each(a,function(g){g.markInvalid(c.errors);if(g.findField(d)){this.setActiveByForm(g)}},this);f=_T("error","error_bad_field")}else{if(Ext.isObject(c.errinfo)){var e=c.errinfo;if(e.sec in this.ERR_STR_STRUCT&&e.key in this.ERR_STR_STRUCT[e.sec]){f=this.ERR_STR_FN(e.sec,e.key)}else{f=String.format("{0}{1}",e.sec,e.key)}if(Ext.isNumber(e.line)){f=String.format("{0} ({1})",f,e.line)}}else{f=_T("common","error_system")}}this.owner.getMsgBox().alert(_T("helptoc","settings"),f,function(g){this.fireEvent("applyfail",this,g,f)},this)},addDeactivateCheck:function(a){a.mon(a,"beforeclose",this.onBeforeDeactivate,this)},onActivate:function(){},onBeforeshow:function(){},onTabchange:function(){this.owner.clearStatus()}});Ext.ns("SYNO.FileStation.SettingDialog");SYNO.FileStation.SettingTabpanel=Ext.extend(SYNO.FileStation.BasicTabPanel,{defineBehaviors:function(){SYNO.FileStation.SettingTabpanel.superclass.defineBehaviors.apply(this,arguments);this.ERR_STR_FN=_WFT;this.ERR_STR_STRUCT=SYNO_FileStation_Strings;this.mon(this,"applyfail",this.onApplyRequestFail,this);this.mon(this,"applysuccess",this.onApplyRequestSuccess)},onBeforeRequest:function(e){if(e.params.action=="apply"){this.isMountFormDirty=this.getComponent("mount_config_form").getForm().isDirty();var m=this.getComponent("general").getForm().findField("enable_java").isDirty();if(m){var l=this.getComponent("general").getForm().findField("enable_java").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava",l)}var q=this.getComponent("general").getForm().findField("enable_drag_to_desktop").isDirty();if(q){var n=this.getComponent("general").getForm().findField("enable_drag_to_desktop").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enabledragtodesktop",n);if(Ext.isChrome){SYNO.SDS.DragToDesktop[n?"init":"destroy"]()}}var s=this.getComponent("general").getForm().findField("enable_auto_overwrite").isDirty();if(s){var r=this.getComponent("general").getForm().findField("enable_auto_overwrite").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite",r)}var j=this.getComponent("general").getForm().findField("enable_7z_extract").isDirty();if(j){var g=this.getComponent("general").getForm().findField("enable_7z_extract").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enable7zextract",g)}var b=this.getComponent("general").getForm().findField("codepage"),k=b.getValue();if(b.isDirty()){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","codepage",k)}var f=this.getComponent("security_config_form").getForm().findField("disable_html").isDirty();if(f){var c=this.getComponent("security_config_form").getForm().findField("disable_html").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","disablehtml",c)}var i=this.getComponent("general").getForm().findField("enable_cross_browser_dd").isDirty();if(i){var t=this.getComponent("general").getForm().findField("enable_cross_browser_dd").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enable_cross_browser_dd",t)}var d=this.getComponent("general").getForm().findField("enable_smart_mvcp").isDirty();if(d){var h=this.getComponent("general").getForm().findField("enable_smart_mvcp").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enablesmartmvcp",h)}var a=this.getComponent("general").getForm().findField("smart_mvcp_overwrite").isDirty();if(a){var p=this.getComponent("general").getForm().findField("smart_mvcp_overwrite").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","smartmvcpoverwrite",p)}var o=this.getComponent("sharing_config_form").getSharingPrivilege();e.params.enabled_sharing_privilege=o.enable;e.params.disabled_sharing_privilege=o.disable}return SYNO.FileStation.SettingTabpanel.superclass.onBeforeRequest.apply(this,arguments)},onApplyRequestSuccess:function(){if(this.isMountFormDirty){this.owner.webfm.reloadTree()}},onRequestSuccess:function(a,b){var c=(!a.responseText)?true:Ext.decode(a.responseText);SYNO.FileStation.SettingTabpanel.superclass.onRequestSuccess.apply(this,arguments);if(c!==true&&c.success===true&&!this.isDestroyed){Ext.getCmp(this.getComponent("general").logBtnId).setDisabled(!c.data.transfer_log_enable);if(c.data.sharing_privilege){this.getComponent("sharing_config_form").setSharingPrivilege(c.data.sharing_privilege.items)}else{this.getComponent("sharing_config_form").setSharingPrivilege([])}}if(_S("is_admin")&&!this.isDestroyed){this.findWindow().setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:"SYNO.FileStation.VFS.User",method:"get",version:1,params:{content:"user_enabled_type"},scope:this,callback:function(g,d,f,e){this.findWindow().clearStatusBusy();if(!g){this.findWindow().getMsgBox().alert(SYNO.webfm.utils.getWebAPIErr(false,d));return}this.getComponent("mount_config_form").getForm().setValues({vfs_allow:d.user_enabled_type})}})}},onApplyRequestFail:function(a,b,c){if(!_S("standalone")&&c===_WFT("mount","config_remote_warning")){if("ok"===b){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.User.Main",userHomeDialog:true});this.findWindow().clearStatusBusy()}}}});SYNO.FileStation.GenSetting=Ext.extend(SYNO.ux.FormPanel,{constructor:function(a){var b=this.fillConfig(a);SYNO.FileStation.GenSetting.superclass.constructor.call(this,b);this.mon(this,"afterlayout",function(){var c;c=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable_smart_mvcp",["smart_mvcp_desc","smart_mvcp_radio"])},this,{single:true})},fillConfig:function(f){var j=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")===true)?true:((SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")!==false)&&(_S("gpo_enable_java")==="yes"))?true:false;var c=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false;var g=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablesmartmvcp")===true)?true:false;var l=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enable_cross_browser_dd")===true)?true:false;var i=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","smartmvcpoverwrite")===true)?true:false;var e=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enabledragtodesktop")===true)?true:false;var h=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enable7zextract")===true)?true:false;var k=SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","codepage")||_S("lang");var a=new Ext.data.SimpleStore({fields:["value","display"],data:SYNO.webfm.utils.getSupportedLanguage()});var d=Ext.isIE||Ext.isIEQuirks||Ext.isIE6||Ext.isIE7||Ext.isIE8||Ext.isIE9||Ext.isIE9m||Ext.isIE9p||Ext.isIE10||Ext.isIE10p||Ext.isIE10Touch||Ext.isIE11||Ext.isIE12;var b={border:false,trackResetOnLoad:true,height:530,labelWidth:180,items:[{xtype:"syno_fieldset",title:_T("log","log_filebrowser_xfer"),defaults:{hidden:!_S("is_admin")},items:[{xtype:"syno_displayfield",value:_T("service","service_file_transfer_log_desc")},{xtype:"syno_checkbox",name:"transfer_log_enable",boxLabel:_T("service","service_file_browser_log"),listeners:{check:{scope:this,fn:function(o,n){var m=this.getForm();if(n&&("yes"===_D("usbstation"))&&m.findField("runpgsql").getValue()==="false"){m.findField("transfer_log_enable").setValue(false);this.findAppWindow().getMsgBox().confirm(_T("helptoc","settings"),_T("metadata","metadata_warning_required"),_S("standalone")?Ext.emptyFn:function(p){if("yes"===p){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.SystemDatabase.Main"})}},this)}}}}},{xtype:"syno_button",id:this.logBtnId=Ext.id(),indent:1,text:_T("log","log_subtitle"),hidden:_S("standalone"),handler:function(){SYNO.SDS.AppLaunch("SYNO.SDS.LogCenter.Instance",{logType:"fileTransfer",protocol:"dsmfmxfer"})}},{xtype:"syno_checkbox",name:"enable_auto_overwrite",hidden:false,boxLabel:_WFT("filetable","upload_copy_auto_overwrite"),checked:c},{xtype:"syno_checkbox",name:"enable_cross_browser_dd",disabled:d,hidden:false,boxLabel:_WFT("filetable","enable_cross_browser_dd"),checked:l},{xtype:"syno_checkbox",itemId:"enable_smart_mvcp",name:"enable_smart_mvcp",hidden:false,boxLabel:_WFT("filetable","mvcp_enable_smart_label"),checked:g,listeners:{check:function(o,n){var m=this.getForm().findField("smart_mvcp_overwrite");var p=this.getForm().findField("smart_mvcp_skip");if(n&&!m.getValue()&&!p.getValue()){m.setValue(true)}},scope:this}},{xtype:"syno_displayfield",name:"smart_mvcp_desc",value:_WFT("filetable","mvcp_enable_desc"),indent:1},{xtype:"syno_radio",itemId:"smart_mvcp_overwrite",name:"smart_mvcp_radio",hidden:false,boxLabel:_WFT("filetable","filetable_overwrite"),checked:g&&i,indent:1},{xtype:"syno_radio",itemId:"smart_mvcp_skip",name:"smart_mvcp_radio",hidden:false,boxLabel:_WFT("filetable","filetable_skip"),checked:g&&!i,indent:1},{xtype:"syno_checkbox",name:"enable_drag_to_desktop",hidden:true,boxLabel:_WFT("filetable","drag_file_to_local_desktop"),checked:e},{xtype:"syno_checkbox",hidden:true,name:"enable_7z_extract",boxLabel:_T("extract","7z_extract"),checked:h},{xtype:"syno_checkbox",name:"use_unix_default_perm",boxLabel:_T("common","apply_default_umask"),checked:false},{xtype:"hidden",name:"runpgsql"}]},{xtype:"syno_fieldset",title:_WFT("java","enable_java_title"),items:[{xtype:"syno_checkbox",name:"enable_java",boxLabel:_T("java","enable_java"),checked:j},{xtype:"syno_displayfield",value:_T("java","enable_java_desc"),indent:1}]},{xtype:"syno_fieldset",title:_WFT("common","lang_codepage"),items:[{xtype:"syno_displayfield",value:_WFT("compress","download_compress_codepage_desc")},{width:200,xtype:"syno_combobox",fieldLabel:_WFT("common","lang_codepage"),hiddenName:"codepage",store:a,displayField:"display",valueField:"value",triggerAction:"all",editable:false,value:k,mode:"local"}]}]};Ext.apply(b,f||{});return b}});Ext.define("SYNO.FileStation.SecurityConfig",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);this.mon(this,"afterlayout",function(){SYNO.SDS.Utils.AddTip(this.getComponent("security_fieldset").getComponent("disable_html_checkbox").getEl(),_WFT("security","disable_html_info"))},this,{single:true})},fillConfig:function(b){var a=(false===SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","disablehtml"))?false:true;var c={border:false,trackResetOnLoad:true,height:430,labelWidth:180,items:{xtype:"syno_fieldset",itemId:"security_fieldset",title:_T("dsmsetting","session_legend"),items:[{xtype:"syno_checkbox",itemId:"disable_html_checkbox",name:"disable_html",boxLabel:_WFT("security","disable_html"),checked:a},{xtype:"syno_displayfield",value:_WFT("security","disable_html_desc"),indent:1}]}};SYNO.LayoutConfig.fill(Ext.apply(c,b||{}));return c}});SYNO.FileStation.BandwidthConfig=Ext.extend(SYNO.ux.FormPanel,{constructor:function(a){var b=this.fillConfig(a);SYNO.FileStation.BandwidthConfig.superclass.constructor.call(this,b);this.defineBehaviors()},getScheduleForm:function(){return this.getForm()},fillConfig:function(b){var a=SYNO.SDS.BandwidthControl.SchedulePanelConfig(this,"FileStation");var c={border:false,trackResetOnLoad:true,height:430,labelWidth:180,items:{xtype:"syno_fieldset",title:_T("bandwidth","bandwidth_tab_title"),items:a.items,listeners:a.listeners}};SYNO.LayoutConfig.fill(Ext.apply(c,b||{}));return c},defineBehaviors:function(){}});SYNO.FileStation.SettingDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(a){Ext.copyTo(this,a,"owner,webfm,RELURL");var b=this.fillConfig(a);SYNO.FileStation.SettingDialog.superclass.constructor.call(this,b);this.defineBehaviors()},defineBehaviors:function(){if(("yes"!==_D("supportmount")&&true!==this.webfm.supportVFS)||true!==_S("is_admin")){this.getTabPanel().hideTabStripItem("mount_config_form")}if(_S("is_admin")!==true){this.getTabPanel().hideTabStripItem("sharing_config_form");this.getTabPanel().hideTabStripItem("bandwidth_config_form")}this.getTabPanel().addDeactivateCheck(this)},fillConfig:function(a){var b={owner:this.owner,width:820,height:580,minWidth:200,minHeight:200,constrainHeader:true,title:_WFT("mount","setting"),layout:"fit",items:[this.getTabPanel()],buttons:[{btnStyle:"blue",text:_T("common","apply"),scope:this,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):undefined,handler:this.onApplyHandler},{text:_T("common","cancel"),scope:this,handler:this.close}],keys:[{key:[10,13],scope:this,handler:this.onApplyHandler},{key:27,scope:this,handler:this.close}],listeners:{scope:this,beforeshow:{fn:this.onBeforeShow,scope:this,single:true}}};Ext.apply(b,a);return b},onApplyHandler:function(){if(_S("demo_mode")){this.getMsgBox().alert(_WFT("common","options"),_JSLIBSTR("uicommon","error_demo"));return}if(!_S("is_admin")||!this.getTabPanel().getComponent("mount_config_form").getForm().isDirty()){this.getTabPanel().applyHandler();return}this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({api:"SYNO.FileStation.VFS.User",method:"set",timeout:600000,version:1,params:{settings:{user_enabled_type:this.getTabPanel().getComponent("mount_config_form").getForm().findField("vfs_allow").getGroupValue()}},scope:this,callback:function(d,a,c,b){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_WFT("common","options"),SYNO.webfm.utils.getWebAPIErr(false,a));return}this.getTabPanel().applyHandler()}})},onBeforeShow:function(){this.getTabPanel().loadAllForm()},getTabPanel:function(){if(!this.tabPanel){var a=new SYNO.FileStation.GenSetting({owner:this,itemId:"general",title:_T("common","general")});var e=new SYNO.FileStation.MountConfig({owner:this,itemId:"mount_config_form",title:"yes"===_D("supportmount")?_WFT("vfs","mount_connections"):_WFT("vfs","remote_connect")});var f=new SYNO.FileStation.SharingConfig({owner:this,itemId:"sharing_config_form",title:_WFT("sharing","sharing"),RELURL:this.RELURL});var b=new SYNO.FileStation.BandwidthConfig({owner:this,itemId:"bandwidth_config_form",title:_T("bandwidth","bandwidth_tab_title")});var d=new SYNO.FileStation.SecurityConfig({owner:this,itemId:"security_config_form",title:_T("dsmsetting","session_legend")});var c={owner:this,height:550,layoutOnTabChange:true,url:this.RELURL+"webUI/settings.cgi",activeTab:0,items:[a,e,f,b,d]};this.tabPanel=new SYNO.FileStation.SettingTabpanel(c)}return this.tabPanel}});Ext.namespace("SYNO.FileStation");Ext.define("SYNO.FileStation.MVCPAskDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){this.fileIndex=0;this.RELURL="modules/FileBrowser/webfm/";this.overwriteArray=[];var b=this.fillConfig(a);this.callParent([b]);this.addEvents({onAskDone:true})},fillConfig:function(a){Ext.apply(this,a||{});var b=this.conflictSrcFiles.length-1;var d=String.format(_WFT("filetable","filetable_mvcp_replace"),_WFT("filetable",this.action));var c={owner:this.owner,width:480,height:(0===b)?475:500,shadow:true,collapsible:false,autoScroll:false,resizable:false,constrainHeader:true,plain:true,title:d,layout:"fit",items:this.initPanel(),buttons:[new SYNO.ux.Button({text:_WFT("common","cancel"),scope:this,handler:this.close})]};return c},createDataview:function(){var c=new Ext.XTemplate('<tpl for="."> <div class="webfm-mvcp-dialog-template" style="height=100px"><div class="webfm-mvcp-dialog-rec-title"> {action} </div><div class="webfm-mvcp-dialog-rec-desc webfm-mvcp-dialog-template-padding"> {desc} </div><table class="webfm-mvcp-dialog-template-padding"> <tbody><tr> <td> <div style="height:64px;width:64px;margin-right:5px"><img src="{img_src}" style="width:64px; height:64px;"></img></div> </td><td> <div><div class="webfm-mvcp-dialog-text-overflow" style="line-height:16px;font-weight:bold;"> {filename} </div><div class="webfm-mvcp-dialog-text-overflow" style="line-height:16px;"> Path: {path} </div><div class={sizecss}> Size: {filesize} </div><div style="line-height:16px;"> Date modified: {mt}</div></div> </td></tr></tbody></table></div></tpl>');var d=this.getDataViewStoreData(0);var b=new Ext.data.JsonStore({fields:["action","desc","filename","path","filesize","img_src","mt","sizecss"],data:d});var a=new SYNO.ux.FleXcroll.DataView({autoFlexcroll:false,store:b,tpl:c,singleSelect:true,itemSelector:"div.webfm-mvcp-dialog-template",overClass:"webfm-mvcp-dialog-template-over",listeners:{click:this.onSelect,scope:this}});this.store=b;this.dataview=a;return a},initPanel:function(){var a=this.conflictSrcFiles.length-1;var b={trackResetOnLoad:true,border:false,autoScroll:true,items:[{xtype:"syno_displayfield",cls:"webfm-mvcp-dialog-title",value:_WFT("filetable","filetable_mvcp_dialog_desc")},this.createDataview(),{xtype:"syno_checkbox",itemId:"apply_same_checkbox",ctCls:"webfm-mvcp-dialog-checkbox",boxLabel:String.format(_WFT("filetable","mvcp_apply_label"),a),hidden:(0===a)}]};this.panel=new SYNO.ux.FormPanel(b);return this.panel},getDataViewStoreData:function(b){var f=[];var c=this.conflictSrcFiles[b];var e=this.conflictDestFiles[b];var d,a;d=this.fillRecData(c);d.action=String.format(_WFT("filetable","filetable_mvcp_replace"),_WFT("filetable",this.action));d.desc=_WFT("filetable","filetable_replace_desc");f.push(d);a=this.fillRecData(e);a.action=_WFT("filetable","filetable_skip");a.desc=_WFT("filetable","filetable_skip_desc");f.push(a);return f},fillRecData:function(c){var g;var f,a,b,e,d;g=Ext.copyTo({},c,"filename, path, filesize, isdir, mt");if(c&&c.filename){e=c.filename.substr(c.filename.lastIndexOf(".")+1).toLowerCase()}d="misc.png";g.sizecss="webfm-mvcp-dialog-file";if(c&&c.isdir){d="folder.png";g.sizecss="webfm-mvcp-dialog-folder"}else{if(-1!==SYNO.webfm.utils.icon_type.indexOf(e)){d=e+".png"}}f=this.RELURL+"images/files_ext_256/"+d+"?v="+_S("version");a=Ext.util.Format.fileSize(c.filesize);b=new Date(1000*c.mt).toLocaleString();g.filesize=a;g.mt=b;g.img_src=f;g.filename=Ext.util.Format.htmlEncode(g.filename);g.path=Ext.util.Format.htmlEncode(g.path);return g},updatePanel:function(){var b=this.panel.getComponent("apply_same_checkbox");var a=this.conflictSrcFiles.length-this.fileIndex-1;if(0===a){b.boxlabelEl.update(_WFT("filetable","mvcp_apply_all_label"))}else{b.boxlabelEl.update(String.format(_WFT("filetable","mvcp_apply_label"),a))}this.store.loadData(this.getDataViewStoreData(this.fileIndex),false);this.doLayout()},onSelect:function(d,a,c,b){var e=(0===a)?true:false;this.onConfirm(e)},updateOverwirteArray:function(c){var b=0,a=this.panel.getComponent("apply_same_checkbox");this.overwriteArray.push({path:this.conflictSrcFiles[this.fileIndex].path,blOverwrite:c});this.fileIndex++;if(a.getValue()){for(b=this.fileIndex;b<this.conflictSrcFiles.length;b++){this.overwriteArray.push({path:this.conflictSrcFiles[b].path,blOverwrite:c})}this.fileIndex=b}},onConfirm:function(a){this.updateOverwirteArray(a);if(this.fileIndex===this.conflictSrcFiles.length){this.fireEvent("onAskDone",this.overwriteArray);this.close()}else{this.updatePanel()}}});Ext.define("SYNO.FileStation.DragDropHintDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);this.callParent([b]);this.addEvents({onAskDone:true});this.mon(this,"afterlayout",function(){var c;c=new SYNO.ux.Utils.EnableCheckGroup(this.panel.getForm(),"enable_smart_mvcp",["smart_mvcp_desc","smart_mvcp_radio"])},this,{single:true})},fillConfig:function(a){Ext.apply(this,a||{});var b={owner:this.owner,resizable:false,minimizable:false,maximizable:false,closable:true,width:600,height:300,shadow:true,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","mvcp_enable_title"),layout:"fit",items:this.initPanel(),buttons:[new SYNO.ux.Button({text:_WFT("common","commit"),btnStyle:"blue",scope:this,handler:this.onConfirm}),new SYNO.ux.Button({text:_WFT("common","skip"),scope:this,handler:this.onBeforeClose})]};return b},initPanel:function(){var a={trackResetOnLoad:true,border:false,autoScroll:true,items:[{xtype:"syno_checkbox",itemId:"enable_smart_mvcp",name:"enable_smart_mvcp",hidden:false,boxLabel:_WFT("filetable","mvcp_enable_smart_label"),checked:false,listeners:{check:function(d,c){var b=this.panel.getForm().findField("smart_mvcp_overwrite");var e=this.panel.getForm().findField("smart_mvcp_skip");if(c&&!b.getValue()&&!e.getValue()){b.setValue(true)}},scope:this}},{xtype:"syno_displayfield",name:"smart_mvcp_desc",value:_WFT("filetable","mvcp_enable_desc"),indent:1},{xtype:"syno_radio",itemId:"smart_mvcp_overwrite",name:"smart_mvcp_radio",hidden:false,boxLabel:_WFT("filetable","filetable_overwrite"),indent:1},{xtype:"syno_radio",itemId:"smart_mvcp_skip",name:"smart_mvcp_radio",hidden:false,boxLabel:_WFT("filetable","filetable_skip"),indent:1},{xtype:"syno_displayfield",value:_WFT("filetable","mvcp_hint_desc")}]};this.panel=new SYNO.ux.FormPanel(a);return this.panel},onConfirm:function(){this.blEnableSmartMVCP=this.panel.getForm().findField("enable_smart_mvcp").getValue();var a=this.panel.getForm().findField("smart_mvcp_overwrite").getValue()&&this.blEnableSmartMVCP;SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enablesmartmvcp",this.blEnableSmartMVCP);SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","smartmvcpoverwrite",a);this.close()},onBeforeClose:function(){this.blEnableSmartMVCP=false;this.close()},onClose:function(){SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","isfirstdd",false);this.fireEvent("onAskDone",this.blEnableSmartMVCP)}});SYNO.webfm.utils.Download=Ext.extend(Ext.util.Observable,{constructor:function(a){Ext.apply(this,a||{});SYNO.webfm.utils.Download.superclass.constructor.call(this);this.DownloadCGI="/webapi/FileStation/file_download.cgi"},GetDownloadIframe:function(){var a=Ext.fly("download_iframe");if(a){a.removeAllListeners();a=a.dom;try{var c=(Ext.isIE||Ext.isModernIE)?a.contentWindow.document:(a.contentDocument||window.frames[a.id].document);c.open();c.close()}catch(b){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("download","download_bigfile"));Ext.destroy(Ext.get("download_iframe"));return null}}else{a=Ext.DomHelper.append(document.body,{tag:"iframe",id:"download_iframe",frameBorder:0,width:0,height:0,css:"display:none;visibility:hidden;height:1px;"});a.src=Ext.SSL_SECURE_URL}return a},DirectDownload:function(b,g,h,f){if(!Ext.isArray(g)){g=[g]}var d=SYNO.webfm.utils.replaceDLNameSpecChars(b);var a,c;if(Ext.isDefined(f)){if(d.length<=f.length||-1===d.toLowerCase().indexOf("."+f,d.length-f.length-1)){d+="."+f}a="fbgdrivedownload";c=String.format("/"+a+'/{0}?dlink="{1}"',encodeURIComponent(d),SYNO.webfm.utils.bin2hex(g[0]));c+="&noCache="+(new Date().getTime())+"&mode=download&stdhtml=false&format="+f}else{a="fbdownload";c=String.format("/"+a+"/{0}?dlink={1}",encodeURIComponent(d),SYNO.webfm.utils.bin2hex(g[0]));c+="&noCache="+(new Date().getTime())+"&mode=download&stdhtml=false"}c=Ext.urlAppend(c);if(!h.get("isdir")&&("exe"===h.get("type").toLowerCase())){c+="&f=.exe"}if((Ext.isIE||Ext.isModernIE)&&c.length>=(2048-(window.location.protocol+"//"+window.location.hostname+":"+window.location.port).length)){this.Download(g,b);return}var e=this.GetDownloadIframe();if(!e){return}Ext.EventManager.on(e,"load",function(){Ext.EventManager.removeListener(e,"load",arguments.callee,this);this.Download(g,b)},this);e.src=c},Download:function(h,g){var c=(SYNO.SDS.Session.SynoToken?("?SynoToken="+(SYNO.SDS.Session.SynoToken)):"");var a=SYNO.webfm.utils.Download.DlFrameTemplate.applyTemplate({cgi:this.DownloadCGI,dlfile:encodeURIComponent(SYNO.webfm.utils.replaceDLNameSpecChars(g))+c});if(!Ext.isArray(h)){h=[h]}if(Ext.fly("download_iframe")){Ext.destroy(Ext.fly("download_iframe"))}var d=this.GetDownloadIframe();if(!d){return}var f=(Ext.isIE||Ext.isModernIE)?d.contentWindow.document:(d.contentDocument||window.frames[d.id].document);f.open("text/html");f.write(a);f.close();var b;var e=[];for(b=0;b<h.length;b++){e.push(SYNO.API.EscapeStr(h[b]))}f.dlform.path.value=e.join(",");f.dlform.dlname.value=g;Ext.EventManager.on(d,"load",function(){var j=(Ext.isIE||Ext.isModernIE)?d.contentWindow.document:(d.contentDocument||window.frames[d.id].document);Ext.EventManager.removeListener(d,"load",arguments.callee,this);try{if(j&&j.body){var i=Ext.decode(j.body.firstChild.innerHTML);if(SYNO.API.CheckResponse(i.success,i.error)===true||this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),SYNO.webfm.utils.getWebAPIErr(false,i.error))){return true}}}catch(k){}return false},this);f.dlform.submit()}});SYNO.webfm.utils.Download.DlFrameTemplate=new Ext.Template('<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body><form accept-charset="utf-8" name="dlform" action="{cgi}/{dlfile}" method="POST"><input type="hidden" name="path" value="" /><input type="hidden" name="dlname" value="" /><input type="hidden" name="7z" value="" /><input type="hidden" name="api" value="SYNO.FileStation.Download" /><input type="hidden" name="version" value="1" /><input type="hidden" name="method" value="download" /><input type="hidden" name="mode" value="download" /></form></body></html>');SYNO.webfm.utils.Download.DlFrameTemplate.compile();var SYNOFileStationFileAction=function(a){Ext.apply(this,a||{});SYNOFileStationFileAction.superclass.constructor.call(this);this.MountCGI=this.RELURL+"webUI/file_mount.cgi";this.UmountCGI=this.RELURL+"webUI/file_mount.cgi";this.PropertyCGI=this.RELURL+"webUI/file_property.cgi";this.UploadCGI=this.RELURL+"webUI/file_upload.cgi";this.downloadAction=new SYNO.webfm.utils.Download(a);this.addEvents({setHighlightEntry:true,refreshTreeNode:true})};Ext.extend(SYNOFileStationFileAction,Ext.util.Observable,{genErrItems:function(f){var d="";var e="";var c=0;if(f.errno){d+=_WFT(f.errno.section,f.errno.key)+"<br>"}var g,b,a;if(f.errItems&&0<f.errItems.length){a=(f.errItems.length>15)?15:f.errItems.length;d+=_WFT("error","error_files");for(c=0;c<a;c++){g=f.errItems[c].name;b=g.lastIndexOf("/");b=(b==-1)?1:b+1;g=g.substr(b);if(g.length>40){g=g.substr(0,37)+"..."}d+="<br>"+Ext.util.Format.htmlEncode(g);d+="<br>"+_WFT(f.errItems[c].section,f.errItems[c].key)}if(a<f.errItems.length){d+="<br>..."}}e=d.replace(/<br>/gi," ");return{text:e,qtip:d}},showErrItems:function(f,d){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}var c="";var b=0;if(d.errno){if(d.errno.arg){c+=String.format(_WFT(d.errno.section,d.errno.key),d.errno.arg)}else{c+=_WFT(d.errno.section,d.errno.key)}c+="<br>"}var e,a;if(d.errItems&&0<d.errItems.length){a=(d.errItems.length>15)?15:d.errItems.length;c+=_WFT("error","error_files")+_WFT("common","colon");for(b=0;b<a;b++){e=d.errItems[b].name;if(e.length>50){e=e.substr(0,47)+"..."}c+="<br>"+Ext.util.Format.htmlEncode(e);c+="&nbsp;("+_WFT(d.errItems[b].section,d.errItems[b].key)+")"}if(a<d.errItems.length){c+="<br>..."}}if(c!==""){this.showMsg(f,c)}},showErrStatus:function(e){var d="";var c=0;if(e.errno){d+=_WFT(e.errno.section,e.errno.key)+"<br>"}var f,b,a;if(e.errItems&&0<e.errItems.length){a=(e.errItems.length>15)?15:e.errItems.length;d+=_WFT("error","error_files");for(c=0;c<a;c++){f=e.errItems[c].name;b=f.lastIndexOf("/");b=(b==-1)?1:b+1;f=f.substr(b);if(f.length>40){f=f.substr(0,37)+"..."}d+="<br>"+Ext.util.Format.htmlEncode(f);d+="<br>"+_WFT(e.errItems[c].section,e.errItems[c].key)}if(a<e.errItems.length){d+="<br>..."}}return d},MVCP:function(e,a,b,c,d){d=d||this.webfm.getCurrentSource();if("copy"!=a&&"move"!=a){return}SYNO.FileStation.Clipboard.set(a,e,{source:d,uid:b,gid:c})},MVCPTo:function(j,f,e,d,l,a,c){if("copy"!=f&&"move"!=f){return}var h=SYNO.webfm.utils.isLocalSource(a),b=[];if(h){j.each(function(m){b.push(m.data)});AppletProgram.showFileDialog(this.webfm,{action:f,files:b,overwrite:c});return}if(!this.MVCPTreeDialog||this.MVCPTreeDialog.isDestroyed){this.MVCPTreeDialog=new SYNO.FileStation.TreeDialog({RELURL:this.RELURL,blDynamicForm:true,blVFSFolder:true,owner:this.owner,webfm:this.webfm})}var g=this.MVCPTreeDialog;var k={that:this,rec:j,action:f,uid:e,gid:d,win:g};g.mon(g,"beforesubmit",this.onBeforeMVCPToSubmit,k);g.mon(g,"callback",this.onMVCPHide,{that:this,act:f,scope:k,rec:j,win:g,webfm:this.webfm},{single:true});var i=l.text;g.load(i,true,e,d)},onBeforeMVCPToSubmit:function(a){var c=new Ext.data.Record({isdir:true,file_id:a.path,real_path:a.real_path,right:a.folderRight});var b=this.that;return b.onBeforeMVCPSubmit.call(b,{recs:this.rec,action:this.action},c,SYNO.webfm.utils.isLocalSource(b.webfm.getCurrentSource()),this.win)},onMVCPHide:function(){var d=this.that;var b=this.act;var e=this.rec;var a={};var c=this.win;c.mun(c,"beforesubmit",d.onBeforeMVCPToSubmit,this.scope);a=c.getParameters();if(!a.fdrName||!b){d.resetCTNode();return}d.onMVCPSend(b,e,a.fdrName,a.blOverWrite,d.webfm.getCurrentSource());d.resetCTNode()},onBeforeMVCPSubmit:function(b,o,m,k){var c=b.recs;var d=b.action;k=k||this.webfm.owner;var p=m&&Ext.isWindows?"\\":"/";var a=!o.get("isdir")?SYNO.webfm.utils.getParentDirArr(o.get("real_path"),p)[0]:o.get("real_path");var n=(d=="copy")?_WFT("filetable","filetable_copy"):_WFT("filetable","filetable_move");if(k){var f;for(f=0;f<c.length;f++){var l=c[f].get("real_path");if(SYNO.webfm.utils.isConflictTargetPath(l,a,p)){k.getMsgBox().alert(n,_WFT("error","error_select_conflict"));return false}}if(m||_S("is_admin")===true||_S("domainUser")=="true"){return true}if(SYNO.webfm.VFS.isVFSPath(o.get("file_id"))){return true}var e=SYNO.webfm.utils.getShareRightBySPath(this.webfm.dirTree,o.get("file_id"));if(!SYNO.webfm.utils.checkShareRight(e,SYNO.webfm.utils.RW)){k.getMsgBox().alert(n,_WFT("error","error_privilege_not_enough"));return false}if(SYNO.webfm.utils.isShareByPath(o.get("file_id"))){return true}var h,g;var j=0;for(f=0;f<c.length;f++){c=c[f];if(c.get("isdir")===true){if(0===j){j=2}else{if(1===j){j=3;break}}}else{if(0===j){j=1}else{if(2===j){j=3;break}}}}switch(j){case 1:g=SYNO.webfm.utils.ReqPrivilege.DestFolder.Copy;break;case 2:g=SYNO.webfm.utils.ReqPrivilege.DestFolder.CopyDir;break;default:g=SYNO.webfm.utils.ReqPrivilege.DestFolder.Copy|SYNO.webfm.utils.ReqPrivilege.DestFolder.CopyDir;break}if(Ext.isDefined(o.get("right"))){h={right:o.get("right"),needRight:g};if(!SYNO.webfm.utils.checkFileRight(h)){k.getMsgBox().alert(n,_WFT("error","error_privilege_not_enough"));return false}}return true}},onDDMVCP:function(a,l,i,g,n){var j="";var d;var b=n.srcsource;var m=SYNO.webfm.utils.isLocalSource(b);if(Ext.isEmpty(b)&&Ext.isArray(a)&&a[0]&&a[0].store){b=a[0].store.storetype}if(a instanceof Array){d=SYNO.webfm.utils.ParseArr(a,"file_id");var c=SYNO.webfm.utils.ParseArr(a,"file_id").sort(function(r,q){return(r<q)});if(m){j=c}else{var e=[];Ext.each(c,function(q){e.push(SYNO.API.EscapeStr(q))});j=e.join(",")}}else{if(m){j=[a]}else{j=SYNO.API.EscapeStr(a)}d=[a]}var p=[];if("copy"!==l){p=SYNO.webfm.utils.getParentDirArr(a,m&&Ext.isWindows?"\\":"/")}var f={srcIdArr:p,destId:g,pFiles:d,action:l,source:b};if(m){var h=AppletProgram.action({files:j,destpath:g,overwrite:i,action:l});if(AppletProgram.checkResponse(h,this.webfm)){this.addLocalTask(l,{bkTaskCfg:{taskid:h.taskid},actionCfg:f},h.taskid)}}else{var o={path:j,dest_folder_path:SYNO.API.EscapeStr(g),overwrite:i,remove_src:"move"===l?true:false,accurate_progress:true};var k=true;if(Ext.isArray(a)){k=false;a.each(function(q){if(q.get("isdir")){k=true;return false}})}if(("copy"===l&&b===SYNO.webfm.utils.source.remotes&&n.blsame===true)||("move"===l&&Ext.isDefined(n.search_taskid))){Ext.apply(o,{search_taskid:n.search_taskid})}SYNO.API.currentManager.requestAPI("SYNO.FileStation.CopyMove","start","1",o,function(t,s,r,q){this.onMVCPSendDone(t,s,Ext.apply(f,{bldir:k}),q)},this)}},getTreeDirInfo:function(a){var c,b={};if(Ext.isEmpty(a)){return}c=a.attributes;b.filename=c.name||c.text;b.file_id=c.path;b.path=c.path;b.mt=c.mt;b.real_path=c.real_path;b.isdir=true;b.filesize=0;return b},onBeforeSmartDDMVCP:function(e,b,a,g){var f=this.getDefaultSmartMVCPOption();var d=g.srcsource;var c=SYNO.webfm.utils.isLocalSource(d);if(Ext.isEmpty(d)&&Ext.isArray(e)&&e[0]&&e[0].store){d=e[0].store.storetype}if("upload"===b||("copymove"===b&&!c)){this.onSmartDDMVCPToRemote(e,b,f,a,g,d)}else{if("download"===b||("copymove"===b&&c)){this.onSmartDDMVCPToLocal(e,b,f,a,g,d)}}},onSmartDDMVCPToRemote:function(f,q,g,u,e,l){var h=this.webfm;var a,s,b,r;var m=SYNO.webfm.SmartDDMVCPMgr.getAction();var o=[],d=[];var k=[],n=[],j=[];if(Ext.isArray(f)){f.each(function(v){n.push(v.data);k.push(v)});k.sort(function(w,v){return w.get("file_id")<v.get("file_id")});a=SYNO.webfm.utils.ParseArr(f,"file_id");r=SYNO.webfm.utils.ParseArr(f,"filename");b=SYNO.webfm.utils.ParseArr(k,"file_id");Ext.each(b,function(v){d.push(SYNO.API.EscapeStr(v))});Ext.each(r,function(v){j.push(SYNO.API.EscapeStr(v))});s=d.join(",")}else{s=SYNO.API.EscapeStr(f);d=[s];a=d;n=[this.getTreeDirInfo(e.srcnode)];k=s;j=[n[0].filename]}if("copy"!==m){o=SYNO.webfm.utils.getParentDirArr(f,"/")}var t={path:s,filename:j.join(","),dest_folder_path:SYNO.API.EscapeStr(u),additional:"size,time"};var c=true;if(Ext.isArray(f)){c=false;f.each(function(v){if(v.get("isdir")){c=true;return false}})}var p={srcIdArr:o,destId:u,pFiles:a,action:q,source:l,fileInfo:n};var i={path:s,dest_folder_path:SYNO.API.EscapeStr(u),overwrite:g,remove_src:"move"===m?true:false,accurate_progress:true};if(("copy"===m&&l===SYNO.webfm.utils.source.remotes&&e.blsame===true)||("move"===m&&Ext.isDefined(e.search_taskid))){Ext.apply(i,{search_taskid:e.search_taskid})}h.owner.setStatusBusy();SYNO.API.currentManager.requestAPI("SYNO.FileStation.CheckExist","check","1",t,function(B,A,x,w){h.owner.clearStatusBusy();if(B&&A){if(0===A.total){this.doSmartDDMVCPRemote(k,q,p,i,c)}else{var z=this.convertConflictFiles(A.files);var v=new SYNO.FileStation.MVCPAskDialog({owner:this.webfm.owner,action:("move"===m)?"filetable_move":"filetable_copy",conflictDestFiles:z,conflictSrcFiles:this.getConflictFiles(p.fileInfo,j,z)});v.on("onAskDone",function(C){if("upload"===q){i.overwrite=this.getSmartOverwriteParams(d,C)}else{i.overwrite=this.getSmartOverwriteParams(d,C).toString()}this.doSmartDDMVCPRemote(k,q,p,i,c)},this);v.show().center()}}else{var y=SYNO.webfm.utils.getWebAPIErr(B,A,p);h.owner.getMsgBox().alert("",y)}},this)},doSmartDDMVCPRemote:function(d,a,c,b,e){if("upload"===a){this.directlyUpload(b.dest_folder_path,d,b.overwrite)}else{if("copymove"===a){SYNO.API.currentManager.requestAPI("SYNO.FileStation.CopyMove","start","2",b,function(i,h,g,f){this.onMVCPSendDone(i,h,Ext.apply(c,{bldir:e}),f)},this)}}},onSmartDDMVCPToLocal:function(d,s,e,v,c,m){var f=this.webfm;var u="",a,b;var r=SYNO.webfm.utils.isLocalSource(m);var q=[],p=[];var i=[],h=[];var n=SYNO.webfm.SmartDDMVCPMgr.getAction();if(Ext.isArray(d)){d.each(function(w){p.push(w.data);i.push(w)});i.sort(function(x,w){return x.get("file_id")<w.get("file_id")});a=SYNO.webfm.utils.ParseArr(d,"file_id");h=SYNO.webfm.utils.ParseArr(d,"filename");b=SYNO.webfm.utils.ParseArr(i,"file_id");u=b}else{u=[d];a=u;p=[this.getTreeDirInfo(c.srcnode)];i=p;h=[p[0].filename]}if("copy"!==n){q=SYNO.webfm.utils.getParentDirArr(d,r&&Ext.isWindows?"\\":"/")}var t={srcIdArr:q,destId:v,pFiles:a,action:n,source:m,fileInfo:p};f.owner.setStatusBusy();var j=AppletProgram.action({files:u,filename:h,destpath:v,action:"checkdir"});f.owner.clearStatusBusy();if(AppletProgram.checkResponse(j,this.webfm)){var g={files:u,destpath:v,overwrite:e,action:n};if(0===j.total){this.doSmartDDMVCPLocal(i,s,t,g,c)}else{var k=[],l=[];Ext.each(h,function(w){k.push(SYNO.API.EscapeStr(w))});Ext.each(u,function(w){l.push(SYNO.API.EscapeStr(w))});var o=new SYNO.FileStation.MVCPAskDialog({owner:this.webfm.owner,action:("move"===n)?"filetable_move":"filetable_copy",conflictDestFiles:j.files,conflictSrcFiles:this.getConflictFiles(t.fileInfo,k,j.files)});o.on("onAskDone",function(w){g.overwrite=this.getSmartOverwriteParams(l,w);this.doSmartDDMVCPLocal(i,s,t,g,c)},this);o.show().center()}}},doSmartDDMVCPLocal:function(f,a,e,d,g){if("download"===a){var b=[];f.each(function(h){b.push(h.data||h)});this.onJavaDownload(e.action,d.destpath,b,d.overwrite)}else{if("copymove"===a){var c=AppletProgram.action(d);if(AppletProgram.checkResponse(c,this.webfm)){this.addLocalTask(e.action,{bkTaskCfg:{taskid:c.taskid},actionCfg:e},c.taskid)}}}},convertConflictFiles:function(a){var b=[];a.each(function(d){var c={};c.filename=d.name;c.path=d.path+"/"+d.name;c.filesize=d.additional.size;c.isdir=d.isdir;c.mt=d.additional.time.mtime;b.push(c)});return b},getConflictFiles:function(d,c,f){var b=0,a=0;var e=[];for(b=0;b<f.length;b++){a=c.indexOf(SYNO.API.EscapeStr(f[b].filename));e.push(d[a])}return e},getSmartOverwriteParams:function(e,b){var f=this.getDefaultSmartMVCPOption();var a=[];var d=0;for(d=0;d<e.length;d++){a[d]=f}for(d=0;d<b.length;d++){var c=e.indexOf(SYNO.API.EscapeStr(b[d].path));a[c]=b[d].blOverwrite}return a},getDefaultSmartMVCPOption:function(){return(true===SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","smartmvcpoverwrite"))},Paste:function(f,d,b,h){this.resetCTNode();var g=SYNO.FileStation.Clipboard.get();b=b||this.webfm.getCurrentSource();var i=SYNO.webfm.utils.isLocalSource(b);var k=SYNO.webfm.utils.isLocalSource(g.params.source);var l=g.recs;var j=h||g.action;var a=!f.get("isdir")?SYNO.webfm.utils.getParentDirArr(f.get("file_id"),i&&Ext.isWindows?"\\":"/")[0]:f.get("file_id");var c;if(!i&&k){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return false}if(!this.webfm.onCheckVFSAction("upload",f)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(j==="move"){this.owner.getMsgBox().confirm(_WFT("filetable","filetable_upload"),_WFT("upload","upload_move_confirm"),function(m){if("yes"==m){this.Paste.call(this,f,d,b,"copy")}return},this);return}var e=this.webfm.dirTree.getNodeById(SYNO.webfm.utils.remote+a);if(e&&!this.webfm.checkUploadRight(e)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return false}this.directlyUpload(a,l,d)}else{if(i&&!k){if(!this.webfm.onCheckVFSAction("download",l)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(!this.webfm.onCheckPrivilege("download",l,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}c=[];l.each(function(m){c.push(m.data)});this.onJavaDownload(j,a,c,d)}else{if(!this.webfm.onCheckVFSAction(g.action,g.recs,f)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(!this.onBeforeMVCPSubmit(g,f,i)){return}this.onMVCPSend(j,l,a,d,b)}}SYNO.FileStation.Clipboard.clean()},onJavaMVCP:function(d,a,b,c){var h=[];Ext.each(b,function(i){h.push(new Ext.data.Record(i))});var j=Ext.isWindows?"\\":"/";var g=(d=="copy")?_WFT("filetable","filetable_copy"):_WFT("filetable","filetable_move");for(var e=0;e<h.length;e++){var f=h[e].get("real_path");if(SYNO.webfm.utils.isConflictTargetPath(f,a,j)){this.owner.getMsgBox().alert(g,_WFT("error","error_select_conflict"));return}}this.onMVCPSend(d,h,a,c)},onMVCPSend:function(i,k,b,d,a){var m=[];var c;var f=a?SYNO.webfm.utils.isLocalSource(a):true;if("copy"!==i){m=SYNO.webfm.utils.getParentDirArr(k,f&&Ext.isWindows?"\\":"/")}var j={srcIdArr:m,pFiles:SYNO.webfm.utils.ParseArr(k,"file_id"),destId:b,action:i,source:a};c=SYNO.webfm.utils.ParseArr(k,"file_id").sort(function(o,n){return(o<n)});var l={};if(f){l={overwrite:d,action:i,destpath:b,files:c};var g=AppletProgram.action(l);if(AppletProgram.checkResponse(g,this.webfm)){this.addLocalTask(i,{bkTaskCfg:{taskid:g.taskid},actionCfg:j},g.taskid)}}else{var e=[];Ext.each(c,function(n){e.push(SYNO.API.EscapeStr(n))});var h=false;k.each(function(n){if(n.get("isdir")){h=true;return false}});l={overwrite:d,dest_folder_path:SYNO.API.EscapeStr(b),path:e.join(","),remove_src:"move"===i?true:false,accurate_progress:true};if(this.webfm.getCurrentSource()===SYNO.webfm.utils.source.remotes||this.webfm.cutSource===SYNO.webfm.utils.source.remotes||this.webfm.copySource===SYNO.webfm.utils.source.remotes){Ext.apply(l,{search_taskid:this.webfm.remoteSearchDS.search_taskid});this.webfm.cutSource="";this.webfm.copySource=""}SYNO.API.currentManager.requestAPI("SYNO.FileStation.CopyMove","start","1",l,function(r,q,o,n){this.onMVCPSendDone(r,q,Ext.apply(j,{bldir:h}),n)},this)}},onMVCPSendDone:function(h,e,g,b){var c=g.srcIdArr,d=g.destId,a=g.pFiles;if(!h||!e||!e.taskid){var f=(false===b.params.remove_src)?_WFT("filetable","filetable_copy"):_WFT("filetable","filetable_move");this.showMsg(f,SYNO.webfm.utils.getWebAPIErr(h,e,b));this.webfm.refreshTreeNode(c.concat(d),true)}else{this.addBkWebAPITask((false===b.params.remove_src)?"copy":"move",{bkTaskCfg:{taskid:e.taskid},actionCfg:{fileStr:SYNO.webfm.utils.ParseArrToFileName(a),srcIdArr:c,destId:d},extra:{bldir:g.bldir,search_taskid:b.params.search_taskid}})}},Create:function(a,c){if(!this.CrtFdrDialog||this.CrtFdrDialog.isDestroyed){this.CrtFdrDialog=new SYNO.FileStation.CrtFdrDialog({RELURL:this.RELURL,owner:this.owner});this.CrtFdrDialog.mon(this.CrtFdrDialog,"callback",function(){this.onCreateHide(c)},this)}var b=this.CrtFdrDialog;b.setCheckName(c||this.webfm.getCurrentSource());b.setParentDir(a);b.load()},onCreateHide:function(e){var c=this.CrtFdrDialog;var d=c.getFolderName();var b=c.getParentDir();e=e||this.webfm.getCurrentSource();if(!d||!b){return}var a=b+"/"+d;var g={fileid:a,srcIdArr:[b],source:e};if(!this.webfm.isViewMasked()){this.webfm.maskView(_WFT("common","loading"),"x-mask-loading")}if(SYNO.webfm.utils.isRemoteSource(e)){SYNO.API.currentManager.requestAPI("SYNO.FileStation.CreateFolder","create","1",{folder_path:SYNO.API.EscapeStr(b),name:SYNO.API.EscapeStr(d),force_parent:false},function(k,j,i,h){this.onCreateDone(h,k,j,g)},this)}else{var f=AppletProgram.action({files:d,dest:b,action:"createfolder"});this.onCreateDone(null,f.success,f.errno,g)}},onCreateDone:function(a,f,c,e){var g=e.fileid;var b=e.srcIdArr;if(this.webfm.isViewMasked()){this.webfm.unmaskView()}if(f){if(false!==e.refresh){this.fireEvent("refreshTreeNode",b,true,e.source)}this.fireEvent("setHighlightEntry",g)}else{var d;if(c&&c.section&&c.key){d=_WFT(c.section,c.key)}else{d=SYNO.webfm.utils.getWebAPIErr(f,c,a)}this.showMsg(_WFT("filetable","filetable_create_folder"),d)}},compressDialog:function(b,d,c){if(!this.CompressDialog||this.CompressDialog.isDestroyed){this.CompressDialog=new SYNO.FileStation.CompressDialog({owner:this.owner});this.CompressDialog.mon(this.CompressDialog,"callback",this.Compress,this)}var a=this.CompressDialog;a.load(b,d,c)},Compress:function(g,j,k,a,l,b,n,o){var m;if(!g||0===g.length){return}if(!SYNO.webfm.utils.checkFileLen(k)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_WFT("compress","compress_error_long_name"));return}m=j+"/"+k;var d=SYNO.webfm.utils.ParseArr(g,"file_id");var c=[];var h;for(h=0;h<d.length;h++){c.push(SYNO.API.EscapeStr(d[h]))}var f={path:c.join(","),dest_file_path:SYNO.API.EscapeStr(m),level:a,mode:l,format:n||"zip",password:b,codepage:o};var e={fileid:m,srcIdArr:[j],zipname:k};SYNO.API.currentManager.requestAPI("SYNO.FileStation.Compress","start","2",f,function(r,q,p,i){this.onCompressSendDone(r,q,i,e)},this)},onCompressSendDone:function(g,f,a,e){var b=e.srcIdArr,h=e.fileid;if(!g||!f||!f.taskid){var d=_WFT("filetable","filetable_compress");var c=SYNO.webfm.utils.getWebAPIErrStr(g,f,a);this.showMsg(d,c)}else{this.addBkWebAPITask("compress",{bkTaskCfg:{taskid:f.taskid},actionCfg:{fileStr:e.zipname,fileid:h,srcIdArr:b},webfm:this.webfm})}},onJavaDownload:function(f,d,b,h){if(f==="move"&&_S("demo_mode")){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_JSLIBSTR("uicommon","error_demo"));return}var j=this.webfm.getDownloadInstance();var k=1;var a=j.getAvailableTaskNumber(k);var c=k-a;if(0<c){var i=String.format(_WFT("filetable","filetable_download_select_max"),j.getMaxTaskNumber())+"<br>";if(1==c){i+=_WFT("filetable","filetable_download_unselect")}else{i+=String.format(_WFT("filetable","filetable_download_unselect_files",c))}this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),i)}if(a<=0){return}if(k!=a){b=b.slice(0,a)}var e={action:"downloadprogress",blcopy:f!=="move",dir:d,files:b,overwrite:h,blupload:false};var g=AppletProgram.action(e);AppletProgram.checkResponse(g)},DirectDownload:function(f,d,c){var a=f.get("filename");var b=f.get("file_id");this.downloadAction.DirectDownload(a,b,f,c)},Download:function(b,a){this.downloadAction.Download(b,a)},BrowserUpload:function(b,a,d){var c=new SYNO.FileStation.UploadDialog({webfm:this.webfm,owner:this.owner,UploadCGI:this.UploadCGI});c.setParameters(b);c.load(a)},directlyUpload:function(d,c,h){if(c instanceof Array){if(c[0] instanceof Object){c=SYNO.webfm.utils.ParseArr(c,"file_id")}}else{c=[c]}var f=this.webfm.getUploadInstance();var j=c.length;var a=f.getAvailableTaskNumber(j);var b=j-a;if(0<b){var i=_WFT("filetable","filetable_select_max");i=i.replace("_MAXNO_",f.getMaxTaskNumber())+"<br>";if(1==b){i+=_WFT("common","common_unselect_file")}else{i+=_WFT("common","common_unselect_files");i=i.replace("_NFILES_",b)}this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),i)}if(a<=0){return}if(j!=a){c=c.slice(0,a)}var e={action:"uploadprogress",remoteDir:d,localPaths:c,overwrite:h};var g=AppletProgram.action(e);AppletProgram.checkResponse(g)},onBeforeLocalUploadSubmit:function(a){var b=this.UploadTreeDialog;if(b){if(_S("is_admin")===true||_S("domainUser")=="true"){return true}if(!SYNO.webfm.utils.checkShareRight(a.shareRight,SYNO.webfm.utils.RW)){b.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return false}if(Ext.isDefined(a.folderRight)){var c={right:a.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Upload};if(!SYNO.webfm.utils.checkFileRight(c)){b.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return false}}return true}},onLocalUploadDialogHide:function(){var b=this.win;if(!b){return}var c=this.that;var a={};a=b.getParameters();if(!a.fdrName||!this.recs){return}c.directlyUpload(a.fdrName,this.recs,a.blOverWrite)},localUpload:function(e,b,d){if(!this.UploadTreeDialog||this.UploadTreeDialog.isDestroyed){this.UploadTreeDialog=new SYNO.FileStation.TreeDialog({RELURL:this.RELURL,blDynamicForm:true,blVFSFolder:true,owner:this.owner,webfm:this.webfm});this.UploadTreeDialog.mon(this.UploadTreeDialog,"beforesubmit",this.onBeforeLocalUploadSubmit,this)}var a=this.UploadTreeDialog;var c={uid:b,gid:d,that:this,win:a};a.mon(a,"callback",this.onLocalUploadDialogHide,{that:this,recs:e,scope:c,win:a},{single:true});a.load(_WFT("filetable","filetable_upload"),true,b,d)},Rename:function(e,b,d){d=d||this.webfm.getCurrentSource();if(!this.RenameDialog||this.RenameDialog.isDestroyed){this.RenameDialog=new SYNO.FileStation.RenameDialog({owner:this.owner})}var a=SYNO.webfm.utils.getPathSeparator(d);var c=this.RenameDialog;c.mon(c,"callback",this.onRenameHide,{that:this,srcIdArr:SYNO.webfm.utils.getParentDirArr(e,a),isdir:e[0].get("isdir"),win:c,source:d},{single:true});c.setIsDir(e[0].get("isdir"));c.setOldName(e[0].get("filename"));c.setCheckName(d);if(!b){b=SYNO.webfm.utils.getParentDirArr(e[0].get("path"),a)[0]}c.setCurrentDir(b);c.load()},resetCTNode:function(){this.webfm.currCTNode=null;this.webfm.currCTNodeTmp=null;this.webfm.currCTAction=null},onRenameHide:function(){var h=this.that;var c=this.isdir;var i=this.win;var b=i.getOldName();var j=i.getNewName();var d=i.getCurrentDir();if(!b||!j){h.resetCTNode();return}if(!h.webfm.isViewMasked()){h.webfm.maskView(_WFT("common","loading"),"x-mask-loading")}if(!SYNO.webfm.utils.isLocalSource(this.source)){var f=d+"/"+j;var e={fileid:f,srcIdArr:this.srcIdArr,isdir:c,source:h.webfm.getCurrentSource()};var l={path:SYNO.API.EscapeStr(d+"/"+b),name:SYNO.API.EscapeStr(j)};if(h.webfm.getCurrentSource()===SYNO.webfm.utils.source.remotes){Ext.apply(l,{search_taskid:h.webfm.remoteSearchDS.search_taskid})}SYNO.API.currentManager.requestAPI("SYNO.FileStation.Rename","rename","1",l,function(q,o,n,m){this.onRenameDone(m,q,o,e)},h)}else{var g=AppletProgram.action({oldname:b,newname:j,fileID:d,action:"rename"});var a=[];a[0]=d;var k={fileid:g.newName,srcIdArr:a,isdir:c,source:h.webfm.getCurrentSource()};h.onRenameDone(null,g.success,g.errno,k)}h.resetCTNode()},onRenameDone:function(a,f,c,e){var g=e.fileid;var b=e.srcIdArr;var d;if(this.webfm.isViewMasked()){this.webfm.unmaskView()}if(f){this.fireEvent("refreshTreeNode",b,true,e.source);this.fireEvent("setHighlightEntry",g);if(a&&Ext.isDefined(a.params.search_taskid)){this.webfm.refreshSearhGrid(a.params.search_taskid)}}else{if(c&&c.section&&c.key){d=_WFT(c.section,c.key)}else{d=SYNO.webfm.utils.getWebAPIErr(f,c,a)}this.showMsg(_WFT("filetable","filetable_rename"),d)}},ViewSnapshotHistory:function(c,a){var b=new SYNO.SDS.Snapshot.HistoryWindow({owner:a},c);b.show()},Delete:function(c,f,a){var e,h;a=a||this.webfm.getCurrentSource();if(!c||0===c.length){this.resetCTNode();return}var i=SYNO.webfm.utils.ParsePairArr(c,"path",f).sort(function(k,j){return(k.file<j.file)});var b=[];var d={pFiles:SYNO.webfm.utils.ParseArr(c,"file_id")};var g={};if(SYNO.webfm.utils.isLocalSource(a)){Ext.each(i,function(j){b.push(j.file)});e=AppletProgram.action({action:"delete",files:b});if(AppletProgram.checkResponse(e,this.webfm)){h=SYNO.webfm.utils.getPathSeparator(a);this.addLocalTask("delete",{bkTaskCfg:{taskid:e.taskid},actionCfg:{fileStr:SYNO.webfm.utils.ParseArrToFileName(SYNO.webfm.utils.ParseArr(c,"file_id"),h),srcIdArr:SYNO.webfm.utils.getParentDirArr(c,h),source:a}},e.taskid)}}else{Ext.apply(d,{srcIdArr:SYNO.webfm.utils.getParentDirArr(c)});b=[];Ext.each(i,function(j){b.push(SYNO.API.EscapeStr(j.file))});g={path:b.join(","),accurate_progress:true};if(this.webfm.getCurrentSource()===SYNO.webfm.utils.source.remotes){Ext.apply(g,{search_taskid:this.webfm.remoteSearchDS.search_taskid})}SYNO.API.currentManager.requestAPI("SYNO.FileStation.Delete","start","1",g,function(m,l,k,j){this.onDeleteSendDone(m,l,d,j)},this)}this.resetCTNode()},onDeleteSendDone:function(g,e,f,c){var d=f.srcIdArr,a=f.pFiles;var b=f.mountRemoteFailed?true:false;if(!g||!e||!e.taskid){this.showMsg(_WFT("filetable","filetable_delete"),SYNO.webfm.utils.getWebAPIErr(g,e,c));this.fireEvent("refreshTreeNode",d,true)}else{this.addBkWebAPITask("delete",{bkTaskCfg:{taskid:e.taskid,blMsgMinimized:b},actionCfg:{fileStr:SYNO.webfm.utils.ParseArrToFileName(a),srcIdArr:d},extra:{search_taskid:c.params.search_taskid}})}},MountList:function(){if(!this.MountListDialog||this.MountListDialog.isDestroyed){this.MountListDialog=new SYNO.FileStation.MountListDialog({RELURL:this.RELURL,owner:this.owner,webfm:this.webfm,module:this})}this.MountListDialog.show()},onSettings:function(){if(!this.SettingDialog||this.SettingDialog.isDestroyed){this.SettingDialog=new SYNO.FileStation.SettingDialog({RELURL:this.RELURL,owner:this.owner,webfm:this.webfm})}this.SettingDialog.mon(this.SettingDialog,"close",this.webfm.onSettingClose,this.webfm);this.SettingDialog.show()},Eject:function(d){var b=this.webfm.deviceObj.dev_id;var a=this.webfm.deviceObj.dev_type;if(b&&a){this.onEject(b,a,d)}else{this.showMsg(_T("tree","node_device"),_T("common","error_system"));var c=SYNO.webfm.utils.getParentDirArr(d);this.fireEvent("refreshTreeNode",c,true)}},onEject:function(c,d,f){var b=_T("tree","node_device");var e=SYNO.webfm.utils.getParentDirArr(f);var a;if(d=="usbDisk"||d=="sdCard"){b=(d=="usbDisk")?_T("tree","leaf_usbdisk"):_T("tree","leaf_sdcard");a=true}else{if(d=="eSataDisk"){b=_T("tree","leaf_esata");a=false}else{this.showMsg(_T("tree","node_device"),_T("common","error_system"));SYNO.SDS.StatusNotifier.fireEvent("externaldeviceactivity","ejectdevice");return}}this.owner.sendWebAPI({api:(a===true)?"SYNO.Core.ExternalDevice.Storage.USB":"SYNO.Core.ExternalDevice.Storage.eSATA",version:1,method:"eject",params:{dev_id:c},callback:function(g){if(g!==true){this.showMsg(b,_T("common","error_system"))}this.fireEvent("refreshTreeNode",e,true)},scope:this})},Umount:function(d,k){var m,h,e,j,f,a=[];if(!d||1!==d.length){this.resetCTNode();return}m=d[0].get("file_id");h=d[0].get("mountType");e=d[0].get("isMountPoint");var c={srcIdArr:SYNO.webfm.utils.getParentDirArr(d)};Ext.apply(c,{pFiles:SYNO.webfm.utils.ParseArr(d,"file_id")});for(f=0;f<d.length;f++){j=d[f].get("file_id");a.push(j.substr(0,j.lastIndexOf("/")))}var l=SYNO.webfm.utils.ParsePairArr(d,"path",a).sort(function(n,i){return(n.file<i.file)});var b=[];Ext.each(l,function(i){b.push(SYNO.API.EscapeStr(i.file))});var g=new SYNO.FileStation.FileTask({url:this.UmountCGI,params:{action:"umount",mountType:h,isMountPoint:e,mountPoint:m},callback:function(i,o,n){this.onUmountDone(i,o,n,c);if(o&&n.UseDefPath&&"yes"===n.UseDefPath){SYNO.API.currentManager.requestAPI("SYNO.FileStation.Delete","start","1",{path:b.join(","),accurate_progress:false,recursive:false},function(t,s,r,q){this.onDeleteSendDone(t,s,c,q)},this)}},scope:this});if(!this.webfm.el.isMasked()){this.webfm.el.mask(_WFT("common","loading"),"x-mask-loading")}g.send();this.resetCTNode()},onUmountDone:function(a,e,c,d){var b=d.srcIdArr;if(this.webfm.el.isMasked()){this.webfm.el.unmask()}if(!e){this.showMsg(_WFT("mount","umount"),_WFT(c.section,c.key))}else{if("yes"!==c.UseDefPath){this.fireEvent("refreshTreeNode",b,true)}this.fireEvent("refreshRTreeNode",b,b[0],true);this.fireEvent("refreshVTreeNode",b,b[0],true)}},RemoteConnect:function(a){if(!this.RemoteConnectionWizard||this.RemoteConnectionWizard.isDestroyed){this.RemoteConnectionWizard=new SYNO.FileStation.RemoteConnection.Wizard({owner:a,webfm:this.webfm})}this.RemoteConnectionWizard.setStatusBusy({text:_WFT("common","common_plz_wait")});this.RemoteConnectionWizard.load()},RemoteConnectServerList:function(a){if(!this.RemoteConnectionServerListDialog||this.RemoteConnectionServerListDialog.isDestroyed){this.RemoteConnectionServerListDialog=new SYNO.FileStation.RemoteConnection.ServerListDialog({owner:a,webfm:this.webfm})}this.RemoteConnectionServerListDialog.load()},RemoveProtocol:function(a){SYNO.FileStation.RemoteConnection.Utils.deleteServer([a],false,this.owner,function(f,b,e,d){this.fireEvent("refreshVFSTreeNode",Ext.emptyFn,this,SYNO.webfm.VFS.getSchemaFromPath(a));if(!f||b.has_fail){var c=SYNO.API.Util.GetFirstError(b);this.owner.getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,c))}},this)},DisconnectProtocol:function(a){SYNO.FileStation.RemoteConnection.Utils.deleteServer([a],true,this.owner,function(f,b,e,d){this.fireEvent("refreshTreeNode",[""],null,null,true);if(!f||b.has_fail){var c=SYNO.API.Util.GetFirstError(b);this.owner.getMsgBox().alert("",SYNO.webfm.utils.getWebAPIErr(false,c))}},this)},MountRemote:function(b,c){var a;if(!this.MountRemoteDialog||this.MountRemoteDialog.isDestroyed){this.MountRemoteDialog=new SYNO.FileStation.MountRemoteDialog({RELURL:this.RELURL,owner:this.owner,webfm:this.webfm});a=this.MountRemoteDialog;a.mon(a,"mountremote",function(){this.onMountRemote(a)},this)}else{a=this.MountRemoteDialog}a.load(b,c)},onMountRemote:function(g){var c,h,f,e,b,a;var i=g.getMntPointUserSet();if(!g){return}f=g.getMntPoint();h={action:"mount_remote",mountType:g.getMountType(),serverIP:g.getServerIP(),account:g.getAccount(),passwd:g.getPasswd(),mountPoint:f,userSet:i,autoMount:g.getAutoMnt(),advOpt:g.getAdvOpt()};a={srcIdArr:SYNO.webfm.utils.getParentDirArr(f),fileid:f,source:SYNO.webfm.utils.source.remote,refresh:false};c={srcIdArr:SYNO.webfm.utils.getParentDirArr(f),userSet:i,file_id:f};if(false===i){e=g.getSubDirName();b=this.webfm.getCurrentDir()}var d=new SYNO.FileStation.FileTask({url:this.MountCGI,params:h,callback:function(j,l,k){this.onMountRemoteDone(j,l,k,c)},scope:this});if(!g.el.isMasked()){g.el.mask(_WFT("common","loading"),"x-mask-loading")}if(false===i){SYNO.API.currentManager.requestAPI("SYNO.FileStation.CreateFolder","create","1",{folder_path:SYNO.API.EscapeStr(b),name:SYNO.API.EscapeStr(e),force_parent:false},function(m,l,k,j){this.onCreateDone(j,m,l,a);if(m){d.send()}else{SYNO.webfm.utils.getWebAPIErr(m,l,k);if(l&&Ext.isArray(l.errors)&&414===l.errors[0].code){this.webfm.getCurrDirSubFdr(g,g.getSubDirName())}}},this)}else{d.send()}this.resetCTNode()},onMountRemoteDone:function(a,l,h,e){var j=e.srcIdArr;var k,c=[],f,g,b={};if(this.MountRemoteDialog.el.isMasked()){this.MountRemoteDialog.el.unmask()}f=new Ext.data.Record({file_id:e.file_id,path:e.file_id,isdir:true});f=[f];Ext.apply(b,{pFiles:SYNO.webfm.utils.ParseArr(f,"file_id"),srcIdArr:j,mountRemoteFailed:true});for(g=0;g<f.length;g++){k=f[g].get("file_id");c.push(k.substr(0,k.lastIndexOf("/")))}var m=SYNO.webfm.utils.ParsePairArr(f,"path",c).sort(function(n,i){return(n.file<i.file)});var d=[];Ext.each(m,function(i){d.push(SYNO.API.EscapeStr(i.file))});if(l){if(""===j[0]){this.webfm.reloadTree()}else{this.fireEvent("refreshTreeNode",j,true);if(this.webfm.dirTree.getNodeById("fm_rf_root")){this.webfm.dirTree.getNodeById("fm_rf_root").reload()}}this.MountRemoteDialog.close()}else{if(!e.userSet){SYNO.API.currentManager.requestAPI("SYNO.FileStation.Delete","start","1",{path:d.join(","),accurate_progress:false,recursive:false},function(q,o,n,i){this.onDeleteSendDone(q,o,b,i)},this)}this.MountRemoteDialog.getMsgBox().alert(_WFT("filetable","filetable_mount_remote_volume"),_WFT(h.section,h.key))}},MountISO:function(g,d,e){var f="",a="",b="";var c;if(!this.MountISODialog||this.MountISODialog.isDestroyed){this.MountISODialog=new SYNO.FileStation.MountISODialog({RELURL:this.RELURL,owner:this.owner,webfm:this.webfm,rec:g});c=this.MountISODialog;c.mon(c,"mountiso",function(){this.onMountISO(c)},this)}else{c=this.MountISODialog}a=g[0].get("file_id");f=g[0].get("real_path");b=g[0].get("filename");c.load(a,f,b,d,e)},onMountISO:function(i){var d,f,b,a;var j,h,c,g;var k=i.getMntPointUserSet();if(!i){return}j=i.getSource();h=i.getMntPoint();c=i.getAutoMnt();g=i.getFileID();if(""===j||""===h||""===c||""===g){return}a={srcIdArr:SYNO.webfm.utils.getParentDirArr(h),fileid:h,source:SYNO.webfm.utils.source.remote,refresh:false};d={fileid:h,srcIdArr:SYNO.webfm.utils.getParentDirArr(h),userSet:k};if(false===k){f=i.getSubDirName();b=this.webfm.getCurrentDir();if(SYNO.webfm.utils.source.remotes===this.webfm.getCurrentSource()){b=SYNO.webfm.utils.getParentDirArr(h)[0]}}var e=new SYNO.FileStation.FileTask({url:this.MountCGI,params:{action:"mount_iso",source:j,mountPoint:h,autoMount:c,userSet:k},callback:function(l,n,m){this.onMountISODone(l,n,m,d)},scope:this});if(!i.el.isMasked()){i.el.mask(_WFT("common","loading"),"x-mask-loading")}if(false===k){SYNO.API.currentManager.requestAPI("SYNO.FileStation.CreateFolder","create","1",{folder_path:SYNO.API.EscapeStr(b),name:SYNO.API.EscapeStr(f),force_parent:false},function(o,n,m,l){this.onCreateDone(l,o,n,a);if(o){e.send()}},this)}else{e.send()}this.resetCTNode()},onMountISODone:function(a,m,j,g){var b=g.fileid;var k=g.srcIdArr,d={};var l,c=[],f,h;if(this.MountISODialog.el.isMasked()){this.MountISODialog.el.unmask()}f=new Ext.data.Record({file_id:b,path:b,isdir:true});f=[f];Ext.apply(d,{pFiles:SYNO.webfm.utils.ParseArr(f,"file_id"),srcIdArr:k,mountRemoteFailed:true});for(h=0;h<f.length;h++){l=f[h].get("file_id");c.push(l.substr(0,l.lastIndexOf("/")))}var n=SYNO.webfm.utils.ParsePairArr(f,"path",c).sort(function(o,i){return(o.file<i.file)});var e=[];Ext.each(n,function(i){e.push(SYNO.API.EscapeStr(i.file))});if(m){if(""===k[0]){this.webfm.reloadTree()}else{this.fireEvent("refreshTreeNode",k,true);if(this.webfm.dirTree.getNodeById("fm_vd_root")){this.webfm.dirTree.getNodeById("fm_vd_root").reload()}}this.fireEvent("setHighlightEntry",b);this.MountISODialog.close()}else{if(!g.userSet){SYNO.API.currentManager.requestAPI("SYNO.FileStation.Delete","start","1",{path:e.join(","),accurate_progress:false,recursive:false},function(r,q,o,i){this.onDeleteSendDone(r,q,d,i)},this)}this.MountISODialog.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT(j.section,j.key))}},Extract:function(g,d,f){var a="";var e=[],b=[];var c;if(!this.ExtractDialog||this.ExtractDialog.isDestroyed){this.ExtractDialog=new SYNO.FileStation.ExtractDialog({RELURL:this.RELURL,owner:this.owner,webfm:this.webfm});c=this.ExtractDialog;c.mon(c,"extract",function(){this.onStartExtract(c)},this)}else{c=this.ExtractDialog}a=g[0].get("file_id");b=SYNO.webfm.utils.ParseArr(g,"file_id");e=SYNO.webfm.utils.ParseArr(g,"file_id");if(e.length>1){c.SetMultiZipFile(e);c.SetPathFiles(b);c.load(a,null,d,f,true)}else{c.SetPathFiles(b);c.load(a,e[0],d,f,false)}},onStartExtract:function(c){var f;var e={};if(!c){return}e=c.getOptions();if(!e){return}var d=(e.all&&!e.zipPath);if(d){f=c.GetMultiZipFile()}var b={overwrite:(e.mode==="overwrite")?true:false,password:e.pass,file_path:d?f[0]:e.zipPath,keep_dir:(e.pathMode==="full")?true:false,dest_folder_path:e.dest,codepage:e.codepage};if(!e.all){b.item_id=e.files}var a={destId:e.dest,blMultiExtract:d,gZipArr:f,file_path:d?f[0]:b.file_path,dest:e.dest,pFiles:c.GetPathFiles(),owner:c};b.file_path=SYNO.API.EscapeStr(b.file_path);b.dest_folder_path=SYNO.API.EscapeStr(b.dest_folder_path);SYNO.API.currentManager.requestAPI("SYNO.FileStation.Extract","start","1",b,function(j,i,h,g){this.onExtractSendDone(j,i,g,a)},this)},onExtractSendDone:function(g,f,b,e){var a=e.pFiles;if(!g||!f||!f.taskid){var d=_WFT("filetable","filetable_extract");var c=SYNO.webfm.utils.getWebAPIErrStr(g,f,b);this.showMsg(d,c)}else{this.addBkWebAPITask("extract",{owner:e.owner,bkTaskCfg:{taskid:f.taskid},actionCfg:{fileStr:(a.length>1)?" ("+SYNO.webfm.utils.ParseArrToFileName(a)+")":"",ajaxParams:b.params,destId:e.destId,blMultiExtract:e.blMultiExtract,gZipArr:e.gZipArr,gDestArr:e.gDestArr,file_path:e.file_path}})}},ExtractNoDialog:function(d,a){var p="",k="",o="",e;var j=[],g=[],f;for(f=0;f<d.length;f++){p=d[f].get("file_id");k=d[f].get("file_id");if(!p||p.length<1||!k||k.length<1){return}j.push(p);e=o=d[f].get("file_id").substr(0,k.lastIndexOf("/"));if(a){o+="/"+SYNO.webfm.utils.getZipName(d[f].get("filename"));g.push(o)}}var h=j.length>0?j:[];var n=g.length>0?g:[];var b=SYNO.webfm.utils.ParseArr(d,"file_id");var m=false;if(j.length>1){m=true}var l={overwrite:false,file_path:h[0],dest_folder_path:n.length?n[0]:o,keep_dir:true,create_subfolder:a};l.file_path=SYNO.API.EscapeStr(l.file_path);l.dest_folder_path=SYNO.API.EscapeStr(l.dest_folder_path);var c={destId:e,blMultiExtract:m,gZipArr:h,gDestArr:n,file_path:l.file_path,pFiles:b};SYNO.API.currentManager.requestAPI("SYNO.FileStation.Extract","start","1",l,function(s,r,q,i){this.onExtractSendDone(s,r,i,c)},this)},Share:function(b){this.SharingDialog=new SYNO.FileStation.SharingDialog({owner:this.owner});var a=this.SharingDialog;a.setFiles(b);a.load()},Property:function(f,d,e){var a={};if(this.webfm.getCurrentSource()===SYNO.webfm.utils.source.remotes){Ext.apply(a,{search_taskid:this.webfm.remoteSearchDS.search_taskid})}var c=(-1!==f[0].data.real_path.indexOf("Gluster"));var b=new SYNO.FileStation.PropertyDialog({PropertyCGI:this.PropertyCGI,owner:this.owner,savePropertyExtParams:a,rec:f,userId:d,privilegeType:this.getFilesPrivilegeType(f,e),source:e||this.webfm.getCurrentSource(),hideAdvPermPanel:c});b.mon(b,"callback",this.onPropertySendDone,this,{single:true});b.load()},getFilesPrivilegeType:function(g,d){var b;var a=this.webfm;var c=SYNO.FileStation.PropertyDialogEnum.privilegeType;function f(j){var h=j;var k=h.indexOf("/",1);if(SYNO.webfm.VFS.isVFSPath(j)){return c.posix}if(k>0){h=h.substr(0,k)}var i=a.dirTree.getNodeById(SYNO.webfm.utils.source.remote+h);if(null===i){return c.none}else{if(i.attributes.isACLPrivilege){return c.acl}else{return c.posix}}return c.none}if(_S("diskless")||SYNO.webfm.utils.isLocalSource(d||this.webfm.getCurrentSource())){return c.none}var e=f(g[0].get("file_id"));if(e===c.acl){if(g.length>1){return c.none}else{return c.acl}}else{if(e===c.posix){if(this.webfm.getCurrentSource()===SYNO.webfm.utils.source.remote){return c.posix}for(b=0;b<g.length;++b){if(f(g[b].get("file_id"))!==c.posix){return c.none}}return c.posix}}return c.none},onPropertySendDone:function(b,h,d){var g,c;var f=_WFT("property","error_save_property");if(b.is_acl===true){if(!h){if(Ext.isDefined(d.code)){f=SYNO.API.getErrorString(d.code)}this.showMsg(_WFT("filetable","filetable_properties"),f)}else{if(Ext.isDefined(d.task_id)){g=Ext.apply({srcIdArr:b.nodeIdArr},b.params);var a=this.owner.pollReg({webapi:{api:"SYNO.Core.ACL",method:"status",version:1,params:{task_id:d.task_id}},interval:3,immediate:true,status_callback:function(k,j,i){if(!k||j.finished===true){this.owner.pollUnreg(a)}this.onPropertyDone(i,k,j,g)},scope:this});this.showWait(_WFT("filetable","filetable_properties"),_WFT("common","saving"),this.onPropertyCancelACL.createDelegate(this,[d,g,a]))}}return}if(!h){if(d){f=_WFT(d.section,d.key)}this.showMsg(_WFT("filetable","filetable_properties"),f)}else{if(d.running){g=Ext.apply({srcIdArr:b.nodeIdArr},b.params);var e=this.owner.addAjaxTask({id:d.taskid,interval:1000,autoJsonDecode:true,url:this.PropertyCGI,params:{action:"readProgress",taskid:d.taskid},callback:function(i,k,j){if(k&&j.finished===true){e.stop()}this.onPropertyDone(i,k,j,g)},scope:this});this.showWait(_WFT("filetable","filetable_properties"),_WFT("common","saving"),this.onPropertyCancel.createDelegate(this,[d,g,e]));e.start(false)}else{this.fireEvent("refreshTreeNode",c,true)}}},onPropertyCancelACL:function(c,a,b){this.owner.pollUnreg(b);this.owner.sendWebAPI({api:"SYNO.Core.ACL",version:1,method:"stop",params:{task_id:c.task_id},callback:function(f,e,d){this.onPropertyDone(d,f,e,a)},scope:this})},onPropertyCancel:function(c,a,b){b.stop();this.owner.addAjaxTask({single:true,autoJsonDecode:true,url:this.PropertyCGI,params:{action:"cancelProgress",taskid:c.taskid},callback:function(d,f,e){this.onPropertyDone(d,f,e,a)},scope:this}).start(true)},onPropertyDone:function(i,g,c,b){var e=b.srcIdArr;var d;var f;var a=58;var h;if(!g||(c&&c.data&&c.data.result&&c.data.result=="fail")){if(c.hasOwnProperty("code")){this.showMsg("",SYNO.API.Erros.core[c.code]||_T("error","error_error_system"))}else{if(c.data.errno||c.data.errItems){this.showErrItems(_WFT("filetable","filetable_properties"),c.data)}else{this.showMsg(_WFT("filetable","filetable_properties"),_WFT("property","error_save_property"))}}}else{if(c&&!c.finished){if(c.applyPath||c.applypath){f=c.applyPath||c.applypath;if(f.length>a){h=f.substr(f.lastIndexOf("/"),a-3);h="..."+h;if(h.length<=a){h=f.substr(0,a-h.length)+h}f=h}d=_WFT("common","saving")+"<br>"+f;this.updateWait(d)}}else{this.hideWait();this.fireEvent("refreshTreeNode",e,true);if(Ext.isDefined(b.search_taskid)){this.webfm.refreshSearhGrid(b.search_taskid)}}}},SaveFav:function(){var b=[],a=[];Ext.each(this.webfm.dirTree.getNodeById("fm_fav_root").childNodes,function(d){var c=d.attributes;a.push(SYNO.API.EscapeStr(c.name));b.push(SYNO.API.EscapeStr(c.path))},this);this.resetCTNode();this.showProgress(_WFT("favorite","my_favorite"),_WFT("common","saving"),null);this.owner.addWebAPITask({single:true,api:"SYNO.FileStation.Favorite",method:"replace_all",version:1,params:{path:b.join(","),name:a.join(",")},callback:function(f,c,e){var d;this.hideProgress();if(!f){d=SYNO.webfm.utils.getWebAPIErr(f,c,e);this.owner.getMsgBox().alert(_WFT("favorite","my_favorite"),d);this.webfm.refreshFavTreeNode()}},scope:this}).start(true)},AddFav:function(c,a){if(!c||c.length>1||!c[0].get("isdir")){return}var e=this.webfm.dirTree.getNodeById("fm_fav_root");if(e.childNodes&&e.childNodes.length>255){this.owner.getMsgBox().alert(_WFT("favorite","add_favorite"),_WFT("favorite","over_limit"));return}if(!this.FavDialog||this.FavDialog.isDestroyed){this.FavDialog=new SYNO.FileStation.FavDialog({owner:this.owner,RELURL:this.RELURL})}var b=this.FavDialog;b.mon(b,"hide",function(){this.resetCTNode()},this,{single:true});b.mon(b,"callback",function(){this.webfm.refreshFavTreeNode()},this,{single:true});var d=a||{};b.setName(c[0].get("filename"));b.setFavDir(c[0].get("file_id"));b.setParams(d);b.onAddFav()},RenameFav:function(c,a){if(!c||!a){return}if(!this.FavDialog||this.FavDialog.isDestroyed){this.FavDialog=new SYNO.FileStation.FavDialog({owner:this.owner,RELURL:this.RELURL})}var b=this.FavDialog;b.mon(b,"hide",function(){this.resetCTNode()},this,{single:true});b.mon(b,"callback",function(){this.webfm.refreshFavTreeNode()},this,{single:true});b.setName(a);b.setFavDir(c);b.onEditFav()},DelFav:function(b,a){this.resetCTNode();if(!b||!a){return}this.owner.getMsgBox().confirm(_WFT("favorite","del_favorite"),_WFT("favorite","del_favorite_confirm"),function(c){if("yes"==c){this.showProgress(_WFT("favorite","del_favorite"),_WFT("filetable","filetable_deleting"),null);this.owner.addWebAPITask({single:true,api:"SYNO.FileStation.Favorite",method:"delete",version:1,params:{path:SYNO.API.EscapeStr(b)},callback:function(g,d,f){this.hideProgress();if(!g){var e=SYNO.webfm.utils.getWebAPIErr(g,d,f);this.owner.getMsgBox().alert(_WFT("favorite","del_favorite"),e)}else{this.webfm.refreshFavTreeNode()}},scope:this}).start(true)}},this)},CleanFav:function(){this.resetCTNode();this.showProgress(_WFT("favorite","clean_favorite"),_WFT("favorite","cleaning"),null);this.owner.addWebAPITask({single:true,api:"SYNO.FileStation.Favorite",method:"clear_broken",version:1,callback:function(d,a,c){this.hideProgress();if(!d){var b=SYNO.webfm.utils.getWebAPIErr(d,a,c);this.owner.getMsgBox().alert(_WFT("favorite","clean_favorite"),b)}else{this.webfm.refreshFavTreeNode()}},scope:this}).start(true)},showWait:function(d,c,a){var b=null;if(a){b={ok:_WFT("common","common_cancel")}}this.owner.getMsgBox().show({title:d,msg:c,width:420,wait:true,closable:false,buttons:b,fn:(a?a:null),hideDlg:true,scope:this})},updateWait:function(a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().updateText(a)}},hideWait:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},showProgress:function(d,c,a){var b=null;if(a){b={ok:_WFT("common","common_cancel")}}this.owner.getMsgBox().show({title:d,msg:c,width:300,progress:true,closable:false,buttons:b,fn:(a?a:null),hideDlg:true,scope:this})},updateProgress:function(a,b){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().updateProgress(a,b)}},hideProgress:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},addLocalTask:function(d,c,e){var i,g,a=true,b=null,h;if(d==="copy"||d==="move"){b=_WFT("common","calculating");if(d==="copy"){i={section:"filetable",key:"filetable_copy"};g={section:"filetable",key:"filetable_copying"}}else{i={section:"filetable",key:"filetable_move"};g={section:"filetable",key:"filetable_moving"}}h="MVCP"}else{if(d==="delete"){i={section:"filetable",key:"filetable_delete"};g={section:"filetable",key:"filetable_deleting"};h="Delete"}}var f={owner:c.owner||false,msgCfg:{progress:a,msg:b},actionStr:i,actingStr:g,actionCfg:{action:d,starttime:new Date().getTime()/1000},webfm:this.webfm};Ext.apply(f.bkTaskCfg,c.bkTaskCfg||{});Ext.apply(f.msgCfg,c.msgCfg||{});Ext.apply(f.actionCfg,c.actionCfg||{});var j=Ext.getClassByName(String.format("SYNO.FileStation.LocalAction.{0}",h)),k;k=new j(f,e)},addBkWebAPITask:function(e,c,d){var g,h,k,i,a=true,b=null,j;if(e==="copy"||e==="move"){g="SYNO.FileStation.CopyMove";h="1";b=_T("background_task","task_waiting");if(e==="copy"){k={section:"filetable",key:"filetable_copy"};i={section:"filetable",key:"filetable_copying"}}else{k={section:"filetable",key:"filetable_move"};i={section:"filetable",key:"filetable_moving"}}j="MVCP"}else{if(e==="delete"){g="SYNO.FileStation.Delete";h="1";b=_WFT("common","calculating");k={section:"filetable",key:"filetable_delete"};i={section:"filetable",key:"filetable_deleting"};j="Delete"}else{if(e==="extract"){g="SYNO.FileStation.Extract";h="1";k={section:"filetable",key:"filetable_extract"};i={section:"extract",key:"extracting"};j="Extract"}else{if(e==="compress"){g="SYNO.FileStation.Compress";h="1";a=false;k={section:"filetable",key:"filetable_compress"};i={section:"filetable",key:"filetable_compressing"};j="Compress"}}}}var f={owner:c.owner||false,bkTaskCfg:{api:g,version:h},msgCfg:{progress:a,msg:b,blMsgMinimized:c.bkTaskCfg.blMsgMinimized},actionStr:k,actingStr:i,actionCfg:{action:e,starttime:new Date().getTime()/1000},webfm:this.webfm};Ext.apply(f.bkTaskCfg,c.bkTaskCfg||{});Ext.apply(f.msgCfg,c.msgCfg||{});Ext.apply(f.actionCfg,c.actionCfg||{});var l=Ext.getClassByName(String.format("SYNO.FileStation.Action.{0}",j)),m;m=new l(f,d,c.extra)},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(this.isOwnerDestroyed()||!this.owner.isVisible()){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",b,a)}else{if(this.MountRemoteDialog&&!this.MountRemoteDialog.isDestroyed){this.MountRemoteDialog.getMsgBox().alert(b,a)}else{if(this.MountISODialog&&!this.MountISODialog.isDestroyed){this.MountISODialog.getMsgBox().alert(b,a)}else{this.owner.getMsgBox().alert(b,a)}}}}});SYNO.FileStation.PasteConfirmDialog=Ext.extend(SYNO.SDS.ModalWindow,{constructor:function(d,c,b){this.callback=c.cb;var h;var g=c.filenames;var a=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false;if(g.length==1){var e=g[0];e=e.substring(e.lastIndexOf(((Ext.isWindows)?"\\":"/"))+1);h=String.format(_WFT("filetable","paste_one_file"),Ext.util.Format.ellipsis(Ext.util.Format.htmlEncode(e),50))}else{h=String.format(_WFT("filetable","paste_files"),g.length)}if(b&&b!==""){h+="<br>("+b+")"}var f={owner:d.owner,resizable:false,minimizable:false,maximizable:false,closable:true,stateful:false,buttonAlign:"center",width:500,height:(b&&b!=="")?250:210,footer:true,cls:"x-window-dlg",title:_WFT("filetable","filetable_paste"),items:[this.panel=new SYNO.ux.FormPanel({items:[{xtype:"syno_displayfield",value:h},{xtype:"syno_checkbox",itemId:"option",checked:a,boxLabel:_WFT("filetable","upload_copy_auto_overwrite")}]})],fbar:new Ext.Toolbar({defaultType:"syno_button",items:[{text:_WFT("filetable","filetable_overwrite"),scope:this,handler:function(){this.onAction(true)}},{text:_WFT("filetable","filetable_skip"),scope:this,handler:function(){this.onAction(false)}}],enableOverflow:false}),keys:[{key:[10,13],fn:function(){this.onAction(true)},scope:this},{key:27,fn:this.close,scope:this}],listeners:{afterlayout:{fn:this.center,scope:this,single:true}}};SYNO.FileStation.PasteConfirmDialog.superclass.constructor.call(this,f)},onAction:function(a){var b=this.panel.getComponent("option").getValue();SYNO.SDS.UserSettings.setProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite",b);this.action(a);this.close()},action:function(a){this.callback.fn.apply(this.callback.scope,[a])}});Ext.ns("SYNO.FileStation");SYNO.FileStation.MainPanel=function(a){var b={layout:"border",border:false,defaluts:{split:true,fit:true},viewConfig:{forceFit:true},listeners:{afterrender:{fn:function(){this.mon(this.dirTree,"flexcrollInitDone",this.registerScrollEl,this)}},afterlayout:{fn:function(c){this.saveInitPath();SYNO.webfm.SmartDDMVCPMgr.bindHotKey(this);if(this.blJava===true){AppletProgram.updateFileStation(this)}},scope:this,single:true},beforedestroy:{fn:this.unregisterScrollEl,scope:this}}};Ext.apply(b,a);this.addEvents({onNodeClick:true});SYNO.FileStation.MainPanel.superclass.constructor.call(this,b)};Ext.extend(SYNO.FileStation.MainPanel,Ext.Panel,{initDefVal:function(){this.historyPath=[];this.historyIndex=-1;this.historyCnt=0;this.showContent="all";this.displayNum=(!Ext.isIE||Ext.isModernIE)?1000:250;this.maxUploadTask=1000;this.timeStamp=0;this.blAfterLayout=false;this.currentSource="remote";this.ajaxCounter=0;this.dragDropDownloadURL=null},initJava:function(){if(this.blJava){AppletProgram.setJava(this.RELURL)}},updateLocalEnv:function(a){if(this.owner&&this.owner.isDestroyed){return}if(a===1){this.updateLocalEnvDefer()}else{this.blJava=false;this.updateUploader()}},registerOwner:function(a){this.owner=a;this.getUserGroups()},registerFileAction:function(){this.FileAction=new SYNOFileStationFileAction({RELURL:this.RELURL,owner:this.owner,webfm:this});this.mon(this.FileAction,"refreshTreeNode",this.refreshTreeNode,this);this.mon(this.FileAction,"setHighlightEntry",this.setHighlightEntry,this);this.mon(this.FileAction,"refreshVTreeNode",this.refreshVTreeNode,this);this.mon(this.FileAction,"refreshRTreeNode",this.refreshRTreeNode,this);this.mon(this.FileAction,"refreshVFSTreeNode",this.refreshVFSTreeNode,this);this.mon(SYNO.SDS.StatusNotifier,"filechanged",this.refreshTreeNode,this)},registerScrollEl:function(){var a=this.dirTree.body;a.ddScrollConfig={vthresh:50,hthresh:-1,frequency:100,increment:10};SYNO.FileStation.TreeScrollMgr.register(a)},unregisterScrollEl:function(){SYNO.FileStation.TreeScrollMgr.unregister(this.dirTree.body)},initButtons:function(){var a=SYNO.FileStation.Comp;this.btnUpBrowserAction=a.cUploadLocal(Ext.Action,true,this);this.btnUpSubMenuAction=a.cUploadRemote(Ext.Action,true,this);this.btnTreeUpBrowserAction=a.cUploadLocal(Ext.Action,true,this);this.btnTreeUpSubMenuAction=a.cUploadRemote(Ext.Action,true,this);this.btnTreeDownSubMenuAction=a.cDownloadMenu(Ext.Action,true,this);this.btnTreeMVCPToSubMenuAction=a.cMVCPToMenu(Ext.Action,true,this)},initNavArea:function(a){Ext.apply(a,{RELURL:this.RELURL,webfm:this});this.copymoveCtxMenu=new SYNO.FileStation.CopyMoveCtxMenu(a);this.treeCtxMenu=new SYNO.FileStation.TreeCtxMenu(a);this.gridCtxMenu=new SYNO.FileStation.GridCtxMenu(a);this.addManagedComponent(this.copymoveCtxMenu);this.addManagedComponent(this.treeCtxMenu);this.addManagedComponent(this.gridCtxMenu)},getCurrentSource:function(){return this.currentSource},setCurrentSource:function(a){this.currentSource=a},getCurrentDir:function(){return this.currentDir},setCurrentDir:function(a){this.currentDir=a},getCurrDirSubFdr:function(d,c,a){if(!c||""===c){return}var b=this.getCurrentDir();if(SYNO.webfm.utils.source.remotes===this.getCurrentSource()&&!Ext.isEmpty(a)){b=a}d.setStatusBusy(_T("common","loading"));SYNO.API.currentManager.requestAPI("SYNO.FileStation.List","list",1,{action:"list",offset:0,limit:1000,pattern:SYNO.API.EscapeStr(c),sort_by:"name",sort_direction:"ASC",filetype:"dir",folder_path:SYNO.API.EscapeStr(b)},function(e,f,h){var g;d.clearStatusBusy();if(!e||!f){g=_WFT("error","error_error_system")}else{if(undefined!==d.getCurrDirSubFdrCallBack){d.getCurrDirSubFdrCallBack(f.files)}}if(g){g=SYNO.webfm.utils.getWebAPIErr(e,f,h);d.getMsgBox().alert(d.title,g)}},this)},getUserGroups:function(){this.AjaxRequest({action:"getusergroup"},this.onGetUserGrpDone)},onGetUserGrpDone:function(b,d,a){this.ajaxCounter++;var c;if(d){if(a.responseText){c=Ext.util.JSON.decode(a.responseText);if(c.errno&&c.errno.section&&c.errno.key){this.showMsg(_T("tree","leaf_filebrowser"),_WFT(c.errno.section,c.errno.key))}else{this.userId=c.uid;this.userGroup=c.items;this.session=c.session;this.timeStamp=c.timestamp;this.mountConfig=c.mountconfig;this.sharingConfig=c.sharingconfig;this.supportVFS=c.support_vfs;if("false"===this.sharingConfig){this.onHideSharingBtns()}else{if(this.btnToolsMenu){this.btnToolsMenu.show()}}if(this.supportVFS&&this.btnToolsMenu){this.btnToolsMenu.show();this.btnToolsMenu.menu.showRemoteConnectItem()}if("yes"===_D("supportmount")&&this.mountConfig){if(this.mountConfig.enable_remote_mount||this.mountConfig.enable_iso_mount){if(this.btnToolsMenu){this.btnToolsMenu.show()}this.btnToolsMenu.menu.showMountItem();if(this.btnUmount){this.btnUmount.show()}}else{this.btnToolsMenu.menu.hideMountItem();if(this.btnUmount){this.btnUmount.hide()}if(this.gridCtxMenu.items.get("gc_umount")){this.gridCtxMenu.remove("gc_umount")}if(this.treeCtxMenu.items.get("gc_umount")){this.treeCtxMenu.remove("gc_umount")}}if(!this.mountConfig.enable_remote_mount){if(this.btnMountRemote){this.btnMountRemote.hide()}}else{if(!_S("is_admin")&&!this.dirTree.getNodeById("remote/home")){this.btnMountRemote.hide()}else{if(this.btnMountRemote){this.btnMountRemote.show()}}}if(!this.mountConfig.enable_iso_mount){if(this.btnMountISO){this.btnMountISO.hide()}if(this.gridCtxMenu.items.get("gc_mount_iso")){this.gridCtxMenu.remove("gc_mount_iso")}}else{if(this.btnMountISO){this.btnMountISO.show()}if(this.gridCtxMenu.items.get("gc_mount_iso")){this.gridCtxMenu.items.get("gc_mount_iso").show()}}SYNO.webfm.utils.ShowHideMenu(this.btnToolsMenu.menu.items)}}}}if(this.ajaxCounter==2){this.initJava()}},AjaxRequest:function(d,b){var c=this.AjaxRequestDone;if(d===null){return}if(b!==null){c=b}var a=Ext.Ajax.request({url:this.RELURL+"webUI/webfm.cgi",params:d,method:"POST",callback:function(){if(this.isDestroyed){return}c.apply(this,arguments)},scope:this});return a},AjaxRequestDone:function(b,e,a){var c;var d=_T("tree","leaf_filebrowser");if(e){if(a.responseText){c=Ext.util.JSON.decode(a.responseText);if(c.errno&&c.errno.section&&c.errno.key){this.showMsg(d,_WFT(c.errno.section,c.errno.key))}}}else{this.showMsg(d,_WFT("common","commfail"))}},getExtractFormat:function(){var a=((SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enable7zextract")===true)?true:false);return a?".7z":".zip"},getSuggestDLNameWithOne:function(b,a){var c=this.getExtractFormat();if(a){return b+c}else{return b}},getSuggestDLName:function(c){var d=this.getExtractFormat();if(c.length==1){return this.getSuggestDLNameWithOne(c[0].get("filename"),c[0].get("isdir"))}var b=c[0].get("file_id");b=b.substr(0,b.lastIndexOf("/"));var a=b.lastIndexOf("/");if(a!=-1){b=b.substr(a+1)}return b+d},getSuggestZipName:function(c){var d=this.getExtractFormat();var a,b;if(c.length==1){if(c[0].get("isdir")){return c[0].get("filename")+d}else{b=c[0].get("filename");a=b.lastIndexOf(".");if(a>0){b=b.substr(0,a)}return b+d}}b=this.getCurrentDir();a=b.lastIndexOf("/");if(a!=-1){b=b.substr(a+1)}return b+".zip"},onOpenWinAction:function(){var c=this.activeView.getSelectionModel();var j,g;var b=[];var m=[];if(_S("demo_mode")){this.owner.getMsgBox().alert(_JSLIBSTR("uicommon","error_demo"),_JSLIBSTR("uicommon","error_demo"));return}if(!c.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_openwin"),_WFT("filetable","filetable_select_one"));return}j=c.getSelections();var d,f;if(SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){for(g=0;g<j.length;g++){b[g]=j[g].id}d={files:b,action:"openfile"};f=AppletProgram.action(d);AppletProgram.checkResponse(f,this)}else{for(g=0;g<j.length;g++){if(!j[g].get("isdir")){m.push(j[g])}}if(!this.onCheckVFSAction("download",m)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_openwin"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("download",m,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_openwin"),_WFT("error","error_privilege_not_enough"));return}var a,l,e,h;for(g=0;g<m.length;g++){a=m[g].get("filename");l=m[g].get("file_id");if(SYNO.webfm.VFS.isGDrivePath(l)&&m[g].data.description&&m[g].data.description.alternateLink){h=m[g].data.description.alternateLink}else{if(SYNO.webfm.VFS.isOneDrivePath(l)&&m[g].data.description&&m[g].data.description.link){h=m[g].data.description.link}else{e=SYNO.webfm.utils.replaceDLNameSpecChars(a);var k="fbdownload";h=String.format("/"+k+"/{0}?sid={1}&mode=open&dlink={2}&stdhtml=true",encodeURIComponent(e),encodeURIComponent(SYNO.webfm.utils.GetSeesionID()),SYNO.webfm.utils.bin2hex(l));h=Ext.urlAppend(h);if(!m[g].get("isdir")&&("exe"===m[g].get("type").toLowerCase())){h+="&f=.exe"}}}window.open(h,"_blank")}}},checkFtpModifyRight:function(a){return this.checkNoFtpRight(a,[SYNO.webfm.utils.FTP_PRIV_DISABLE_LIST,SYNO.webfm.utils.FTP_PRIV_DISABLE_MODIFY])},checkFTPDownloadRight:function(a){return this.checkNoFtpRight(a,[SYNO.webfm.utils.FTP_PRIV_DISABLE_LIST,SYNO.webfm.utils.FTP_PRIV_DISABLE_DOWNLOAD])},checkNoFtpRight:function(b,c){var a=0;if(true===_S("is_admin")||!b||b.attributes.id=="fm_search_root"){return false}else{if(b.parentNode.id!="fm_root"){a=SYNO.webfm.utils.getShareFtpRight(this.dirTree,b)}else{a=b.attributes.ftpright}}if(!Ext.isArray(c)){c=[c]}return this.checkFtpRight(a,c)},checkFTPDownloadRightByPath:function(a){return this.checkNoFtpRightByPath(a,[SYNO.webfm.utils.FTP_PRIV_DISABLE_LIST,SYNO.webfm.utils.FTP_PRIV_DISABLE_DOWNLOAD])},checkNoFtpRightByPath:function(c,b){var a=0;if(true===_S("is_admin")){}else{a=SYNO.webfm.utils.getShareFtpRightByPath(this.dirTree,c)}if(!Ext.isArray(b)){b=[b]}return this.checkFtpRight(a,b)},checkFtpRight:function(b,c){var a=false;Ext.each(c,function(d){a|=(b&d);if(a){return false}});return a},checkUploadRight:function(e){if(!e||true===_S("is_admin")||"true"===_S("domainUser")){return true}var c=false;var a=null;var b={};var d=false;var f;if(e.parentNode.id!="fm_root"){b={folderRight:e.attributes.right,uid:e.attributes.uid,gid:e.attributes.gid};a=SYNO.webfm.utils.getShareRight(this.dirTree,e)}else{a=e.attributes.right;d=true}c=SYNO.webfm.utils.checkShareRight(a,SYNO.webfm.utils.RW);if(!c){return false}if(!d){f={right:b.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Upload};if(!SYNO.webfm.utils.checkFileRight(f)){return false}}return true},onCreateFolder:function(){if(!this.onCheckVFSAction("create",this.getCurrentDir())){this.owner.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("create",null,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_privilege_not_enough"));return}this.FileAction.Create(this.getCurrentDir())},onLocalUpload:function(){var b,a;b=this.activeView.getSelectionModel();if(!b.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("filetable","filetable_select_one"));return}a=b.getSelections();this.FileAction.localUpload(a,this.userId,this.userGroup)},getUploadPath:function(b){var d;var a=(b&&b.parentMenu)?(b.parentMenu.parentMenu?b.parentMenu.parentMenu.itemId:b.parentMenu.itemId):undefined;if(a==="rTreeCtx"){if(!this.currCTNodeTmp){return}this.currCTNode=this.currCTNodeTmp;this.currCTAction=b.itemId;d=this.currCTNode.attributes.path}else{if(a==="rGridCtx"){var e=this.activeView.getSelectionModel();if(!e.hasSelection()){d=this.getCurrentDir()}else{var c=e.getSelections();d=c[0].get("file_id");if(c.length>1||!c[0].get("isdir")){d=d.substr(0,d.lastIndexOf("/"))}}}else{d=this.getCurrentDir()}}return d},onDisableUpButton:function(a){this.btnRemoteUpload.setDisabled(a);this.btnLocalUpload.setDisabled(a);if(this.blUploadSubMenu){this.btnTreeUpSubMenuAction.setHidden(a);this.btnUpSubMenuAction.setHidden(a)}else{this.btnUpBrowserAction.setHidden(a);this.btnTreeUpBrowserAction.setHidden(a)}},onShowUpSubMenu:function(a){this.btnRemoteUpload.setVisible(a);this.btnUpSubMenuAction.setHidden(!a);this.btnLocalUpload.setVisible(!a);this.btnUpBrowserAction.setHidden(a);this.btnTreeUpBrowserAction.setHidden(a);this.btnTreeUpSubMenuAction.setHidden(!a);this.blUploadSubMenu=a},onShowDownSubMenu:function(b){this.btnDownload.setVisible(!b);this.btnDownloadMenu.setVisible(b);var a=this.gridCtxMenu.items;var d=a.get("gc_download");var c=a.get("gc_download_menu");d.setVisible(!b);c.setVisible(b);this.btnTreeDownSubMenuAction.setHidden(b);this.treeCtxMenu.items.get("gc_download").setVisible(!b)},onBrowserUploadAction:function(d,f){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return}if(this.getCurrentSource().substr(0,5)===SYNO.webfm.utils.source.local){this.onLocalUpload()}else{var c,b,a;if(!this.onCheckVFSAction("upload",null,this.getUploadPath(d))){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("upload",null,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return}c=this.dirTree.getSelectionModel();b=c.getSelectedNode();a=this.checkFtpModifyRight(b);this.FileAction.BrowserUpload(this.getUploadPath(d),a)}},onUploadItemClick:function(a,b){var d=false;var c=a.itemId;switch(c){case"upload_overwrite":d=true;break;case"upload_skip":break;default:return}this.onUploadAction(d,this.getUploadPath(a))},onUploadAction:function(b,a){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return}if(this.getCurrentSource().substr(0,6)===SYNO.webfm.utils.source.remote){if(!this.onCheckVFSAction("upload",null,a)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("upload",null,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return}if(AppletProgram.blJavaPermission==1){AppletProgram.showFileDialog(this,{action:"upload",path:a,overwrite:b})}}else{this.onLocalUpload()}},onBeforeDownloadAction:function(a){var c=this.activeView.getSelectionModel();var b;if(!c.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("filetable","filetable_select_one"));return}b=c.getSelections();if(!this.onCheckVFSAction("download",b)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(false!==a&&!this.onCheckPrivilege("download",b,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}return b},onDownloadAction:function(c,g){var a=(c&&c.parentMenu)?(c.parentMenu.parentMenu?c.parentMenu.parentMenu.itemId:c.parentMenu.itemId):undefined;var d=[],b,j=[],h;if(a==="rTreeCtx"){if(!this.currCTNodeTmp){return}d=this.getRecByTreeNode(c);var f=d[0].get("file_id");h=d[0].get("filename")+".zip";j.push(f);if(!this.onCheckVFSAction("download",d)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("download",d,false,true)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}}else{if(Ext.isEmpty(d=this.onBeforeDownloadAction())){return}if(1==d.length&&!d[0].get("isdir")){this.FileAction.DirectDownload(d[0],g);return}for(b=0;b<d.length;b++){j.push(d[b].get("file_id"))}h=this.getSuggestDLName(d)}this.FileAction.Download(j,h)},onJavaDownloadAction:function(d,b){var c=[],e=[];var a=(d&&d.parentMenu)?(d.parentMenu.parentMenu?d.parentMenu.parentMenu.itemId:d.parentMenu.itemId):undefined;if(a==="rTreeCtx"){if(!this.currCTNodeTmp){return}e=this.getRecByTreeNode(d);if(!this.onCheckVFSAction("download",e)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("download",e,false,true)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}}else{if(Ext.isEmpty(e=this.onBeforeDownloadAction())){return}}e.each(function(f){c.push(f.data)});AppletProgram.showFileDialog(this,{action:"download",files:c,overwrite:b})},getRecByTreeNode:function(a){this.currCTNode=this.currCTNodeTmp;this.currCTAction=a.itemId;return this.getRecByTreeNodeAttr(this.currCTNode.attributes)},getRecByTreeNodeAttr:function(d){var j=[];var a=d.type;var i=SYNO.webfm.utils.isLocalSource(a);var m=(i&&Ext.isWindows)?"\\":"/";var l=d.path||"";var h=d.real_path;var b=SYNO.webfm.utils.getBaseName(l,m);var g=d.uid;var f=d.gid;var k=d.right;var c=d.isMountPoint;var e=d.mountType;j[0]=new Ext.data.Record({uid:g,gid:f,isdir:true,fileprivilege:k,file_id:l,path:l,real_path:h,type:"",filename:b,isMountPoint:c,mountType:e});return j},onSelectAllRow:function(){if(this.activeDS.storetype===SYNO.webfm.utils.source.remotes){return}var b=this,a=b.viewPanel.getEl(),c=b.activeView.getStore();if(c.getTotalCount()!==c.getCount()){a.mask()}b.activeView.getSelectionModel().selectAllRow({callback:function(){b.isSelectAll=true;b.paging.doRefresh();a.unmask();b.isSelectAll=false},scope:b.paging})},onSelectAllRowAction:function(){if(Ext.isMac&&!this.cmdKeyDown){return}this.onSelectAllRow()},onRenameAction:function(){var b=this.activeView.getSelectionModel();if(!b.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("filetable","filetable_select_one"));return}if(1<b.getCount()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("filetable","filetable_select_only_one"));return}var a=b.getSelections();if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_JSLIBSTR("uicommon","error_demo"));return}if(!this.onCheckPrivilege("rename",a,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_privilege_not_enough"));return}if(!this.onCheckVFSAction("rename",a)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","not_support"));return}this.FileAction.Rename(a)},onViewHistoryAction:function(){var b=this.activeView.getSelectionModel();if(!b.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("filetable","filetable_select_one"));return}if(1<b.getCount()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("filetable","filetable_select_only_one"));return}var a=b.getSelections();this.FileAction.ViewSnapshotHistory(a[0],this.owner)},onDeleteAction:function(){var f=this.activeView.getSelectionModel();if(!f.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_WFT("filetable","filetable_select_one"));return}if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_JSLIBSTR("uicommon","error_demo"));return}var d=f.getSelections();var e,c=[];var b=_WFT("filetable","filetable_delete_confirm");var a=(SYNO.webfm.utils.isLocalSource(this.getCurrentSource()));if(a){b=_WFT("filetable","filetable_local_delete_confirm")}else{if(!this.onCheckVFSAction("delete",d)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("delete",d,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_WFT("error","error_privilege_not_enough"));return}}this.owner.getMsgBox().confirmDelete(_WFT("filetable","filetable_delete"),b,function(j){if("yes"==j){var h=SYNO.webfm.utils.getPathSeparator(this.getCurrentSource()),g;for(g=0;g<d.length;g++){e=d[g].get("file_id");c.push(e.substr(0,e.lastIndexOf(h)))}this.FileAction.Delete(d,c)}},this);return},getPasteRec:function(c){var a=(c&&c.parentMenu)?(c.parentMenu.parentMenu?c.parentMenu.parentMenu.itemId:c.parentMenu.itemId):undefined;var f=this.activeView.getSelectionModel(),d;if(c===SYNO.webfm.utils.hotKey||a==="rToolbarCtx"||this.gridCtxMenu.blContainerMenu||!f.hasSelection()||f.getSelections().length>1){var b=this.dirTree.getNodeById(this.getCurrentSource()+this.getCurrentDir());if(!b){return}var e=b.attributes;d=new Ext.data.Record({uid:e.uid,gid:e.gid,isdir:true,right:e.right,ftpright:e.ftpright,file_id:e.path,path:e.path,real_path:e.real_path})}else{d=f.getSelected()}return d},onPasteAction:function(d,c,a){var g=_WFT("filetable","filetable_paste");var f=this.getPasteRec(d),b;if(!f){this.owner.getMsgBox().alert(g,_WFT("filetable","filetable_select_one"));return}if(SYNO.FileStation.Clipboard.isEmpty()){return}b=SYNO.FileStation.Clipboard.get();if(!this.onCheckVFSAction(b.action,b.recs,f)){this.owner.getMsgBox().alert(g,_WFT("error","not_support"));return}if(a&&!c){var e=new SYNO.FileStation.PasteConfirmDialog({owner:this.owner},{filenames:SYNO.FileStation.Clipboard.getFilenames(),cb:{fn:function(h){this.FileAction.Paste(f,h)},scope:this}},"");e.show()}else{this.FileAction.Paste(f,c)}},onShortCutPasteAction:function(c,b,a){if(Ext.isMac&&!this.cmdKeyDown){return}this.onPasteAction(c,b,a)},onCutAction:function(a){this.copySource="";this.cutSource=this.currentSource;this.onMVCPAction(a,"move")},onShortCutCutAction:function(a){if(Ext.isMac&&!this.cmdKeyDown){return}this.copySource="";this.cutSource=this.currentSource;this.onMVCPAction(a,"move")},onCopyAction:function(a){this.cutSource="";this.copySource=this.currentSource;this.onMVCPAction(a,"copy")},onShortCutCopyAction:function(a){if(Ext.isMac&&!this.cmdKeyDown){return}this.cutSource="";this.copySource=this.currentSource;this.onMVCPAction(a,"copy")},onSharingManager:function(){this.SharingManagerWindow=new SYNO.FileStation.SharingManagerWindow({RELURL:this.RELURL,owner:this.owner});var a=this.SharingManagerWindow;a.load()},onMVCPAction:function(i,e){if("copy"!=e&&"move"!=e){return}var g=i.text,h,a,c;if(_S("demo_mode")===true){this.owner.getMsgBox().alert(g,_JSLIBSTR("uicommon","error_demo"));return}var d=(i&&i.parentMenu)?(i.parentMenu.parentMenu?i.parentMenu.parentMenu.itemId:i.parentMenu.itemId):undefined;if(d==="rTreeCtx"){if(!this.currCTNodeTmp){return}h=this.getRecByTreeNode(i);a=this.currCTNode.attributes.type}else{var b=this.activeView.getSelectionModel();if(!b.hasSelection()){this.owner.getMsgBox().alert(g,_WFT("filetable","filetable_select_one"));return}h=b.getSelections();a=this.getCurrentSource();b=this.dirTree.getSelectionModel();c=b.getSelectedNode()}var f=(SYNO.webfm.utils.isLocalSource(a));if(!this.onCheckVFSAction(e,h)){this.owner.getMsgBox().alert(g,_WFT("error","not_support"));return}if(!f&&(!this.onCheckPrivilege(e,h,false,false)||(this.checkFTPDownloadRight(c)||(e==="move"&&this.checkFtpModifyRight(c))))){this.owner.getMsgBox().alert(g,_WFT("error","error_privilege_not_enough"));return}switch(i.itemId){case"moveto_ovwr":case"copyto_ovwr":this.FileAction.MVCPTo(h,e,this.userId,this.userGroup,i,a,true);break;case"moveto_skip":case"copyto_skip":this.FileAction.MVCPTo(h,e,this.userId,this.userGroup,i,a,false);break;default:this.FileAction.MVCP(h,e,this.userId,this.userGroup);break}},setHighlightEntry:function(a){this.highlightId=a},refreshGrid:function(){if(!this.isSelectAll){this.grid.getSelectionModel().clearAllSelections();this.thumbnailView.getSelectionModel().clearAllSelections()}this.activeDS.removeAll();this.activeDS.reload();return this.activeDS.getTotalCount()},refreshGridByPath:function(a){if(SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())||SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){if(a===this.getCurrentDir()){return this.refreshGrid()}}},refreshTreeByPath:function(f,e){var c=SYNO.webfm.utils.source;var a=this.dirTree;if(SYNO.webfm.utils.isLocalSource(e)){this.refreshTreeByNode(a.getNodeById(c.local+f));this.refreshTreeByNode(a.getNodeById(c.localh+f))}else{this.refreshTreeByNode(a.getNodeById(c.remote+f));this.refreshTreeByNode(a.getNodeById(c.remoter+f))}var d=a.getNodeById("fm_fav_root");if(d){var b=false;Ext.each(d.childNodes,function(g){if(f===g.attributes.path.substr(0,f.length)){this.refreshTreeByNode(d);b=true;return false}},this);if(!b){Ext.each(d.childNodes,function(h){var g=a.getNodeById(c.remotefav+h.attributes.name+f);this.refreshTreeByNode(g)},this)}}},refreshTreeByNode:function(a){if(a&&a.isLoaded()){if(a.isExpanded()){this.expandedNodes=null;this.count=null;this.saveExpandStatus(a,1);a.reload(function(){this.resumeExpandStatus(1)},this)}else{a.attributes.loader.load(a)}}},saveExpandStatus:function(b,f){if(!this.expandedNodes){this.expandedNodes=[]}if(!this.expandedNodes[f]){this.expandedNodes[f]=[]}var a;var e=this.expandedNodes[f];var d=2,c=10;if(b.hasChildNodes()){for(a=0;a<b.childNodes.length;a++){if(b.childNodes[a].expanded){e[e.length]=b.childNodes[a].id;if(f<d){this.saveExpandStatus(b.childNodes[a],f+1)}}if(e.length==c){break}}if(0===this.expandedNodes[f].length){this.expandedNodes=this.expandedNodes.slice(0,-1)}}},resumeExpandStatus:function(e){var a,b;if(!this.expandedNodes){return}else{if(this.expandedNodes.length-1<e){var d=this.getCurrentDir();this.expandedNodes=null;this.count=null;while(!Ext.isEmpty(d)){b=this.dirTree.getNodeById(this.getCurrentSource()+d);if(b){this.dirTree.getSelectionModel().select(b);return}d=d.substr(0,d.lastIndexOf("/"))}this.reloadTree(true);return}}var c=this.expandedNodes[e].length;for(a=0;a<c;a++){b=this.dirTree.getNodeById(this.expandedNodes[e][a]);if(b){b.expand(false,false,function(){this.expandCounter(e)},this)}else{this.expandCounter(e)}}},expandCounter:function(a){if(!this.count){this.count=[]}if(!this.count[a]){this.count[a]=0}this.count[a]++;if(this.count[a]==this.expandedNodes[a].length){this.resumeExpandStatus(a+1)}},refreshTreeNode:function(b,a,d,e){var c;if(!b||!Ext.isArray(b)){return}for(c=0;c<b.length;c++){if(""===b[c]){this.reloadTree(e);return}if(a){this.refreshTreeByPath(b[c],d||SYNO.webfm.utils.source.remote);this.refreshGridByPath(b[c])}}},refreshVTreeNode:function(c,a){var b=this.dirTree.getNodeById("fm_vd_root");if(b){b.reload(c,a)}},refreshRTreeNode:function(c,a){var b=this.dirTree.getNodeById("fm_rf_root");if(b){b.reload(c,a)}},refreshVFSTreeNode:function(d,a,b){var c=this.dirTree.getNodeById(b);if(c){c.reload(d,a)}},refreshFavTreeNode:function(c,a){var b=this.dirTree.getNodeById("fm_fav_root");if(b){b.reload(c,a)}},refreshSearhGrid:function(a){if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes&&this.grid.getStore().search_taskid===a){this.grid.getStore().reload()}},updateFavBtn:function(){var g=this.toolbar.getComponent("topToolbar");var d=g.getComponent("addfav");var a=g.getComponent("delfav");var c=this.dirTree.getNodeById("fm_root");var e=SYNO.webfm.utils.isLocalSource(this.getCurrentSource());var b=(1>=c.childNodes.length)||e||(this.getCurrentSource()===SYNO.webfm.utils.source.remotes)||SYNO.webfm.VFS.isVFSPath(this.getCurrentDir());if(b){this.pathBar.tbPanel.el.addClass("with-right-border");d.hide();a.hide();g.syncSize();return}else{this.pathBar.tbPanel.el.removeClass("with-right-border")}var h=true;if(!b){var f=this.dirTree.getNodeById("fm_fav_root");if(f){f.childNodes.each(function(i){if(this.getCurrentDir()===i.attributes.path){h=false;return false}},this)}}d.setVisible(h);a.setVisible(!h);g.syncSize()},saveInitPath:function(){var c="";var d=0,a=0;var b=window.location.href;this.initPath=null;if((d=b.indexOf("?"))==-1){return false}c=b.substr(d+1);if((d=c.indexOf("target="))==-1){return false}d+=7;if(-1==(a=c.indexOf("&",d))){this.initPath=c.substr(d)}else{this.initPath=c.substr(d,a)}this.initPath=decodeURIComponent(this.initPath)},onRefreshTreeDone:function(a,b){this.onGoToPathWithDirBySource(true,a,undefined,b)},createRefreshTreeDoneCallback:function(a,b,c){if(b===c&&!SYNO.webfm.utils.isLocalSource(c)){return function(){this.onRefreshTreeDone(a,c)}}return Ext.emptyFn},reloadTree:function(g){this.blExpanded=false;var a=true===g?"":this.getCurrentDir(),f=true===g?"":this.getCurrentSource();if(true===g){this.dirTree.unselectCurrentNode()}var e=this.dirTree.getNodeById("fm_top_root"),b=e.childNodes;for(var c=0;c<b.length;c++){var d=b[c];switch(d.id){case"fm_local_root":if(AppletProgram.blJavaPermission==1&&this.dirLocalTree&&this.dirLocalTree.rendered){this.dirLocalTree.getNodeById("fm_local_root").reload()}break;case"fm_vd_root":this.refreshVTreeNode(this.createRefreshTreeDoneCallback(a,SYNO.webfm.utils.source.remotev,f),this);break;case"fm_rf_root":this.refreshRTreeNode(this.createRefreshTreeDoneCallback(a,SYNO.webfm.utils.source.remoter,f),this);break;case"fm_fav_root":this.refreshFavTreeNode(this.createRefreshTreeDoneCallback(a,SYNO.webfm.utils.isFavSource(f)?f:SYNO.webfm.utils.source.remotefav,f),this);break;case"fm_search_root":break;default:d.reload(this.createRefreshTreeDoneCallback(a,SYNO.webfm.utils.source.remote,f),this);break}}if(this.getCurrentSource()!==SYNO.webfm.utils.source.remote){this.switchSource(SYNO.webfm.utils.source.remote)}},initLocalDS:function(){this.localDS=new Ext.data.Store({storetype:SYNO.webfm.utils.source.local,proxy:new AppletProxy(this),reader:new Ext.data.JsonReader({root:"items",totalProperty:"total",id:"file_id"},["file_id","filename","filesize","mt","ct","at","privilege","fileprivilege","isacl","owner","group","icon","type","path","real_path","isdir","uid","gid","is_compressed","is_image","ppath","mountType","is_snapshot","is_btrfs_subvol","snapshot_desc","has_snapshot"]),remoteSort:true,paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},sortInfo:{field:"name",direction:"ASC"},baseParams:{action:"list",sort_by:"name"},pruneModifiedRecords:true,listeners:{beforeload:{scope:this.fileFilter,fn:this.fileFilter.onBeforeLoad},load:{fn:this.loadLocalDS,scope:this},exception:{fn:this.exceptionLocalDS,scope:this}}});this.addManagedComponent(this.localDS)},nodeContextMenu:function(a,b,c,d){d.preventDefault();if(!a.isSelected(c)){a.select(c,false)}this.gridCtxMenu.blContainerMenu=false;this.onUpdateBtnStatus(false,a.getSelectedRecords());this.gridCtxMenu.showAt(d.getXY());d.stopPropagation()},gridRowContextMenu:function(a,d,b){b.preventDefault();var c=a.getSelectionModel();if(!c.isSelected(d)){c.selectRow(d)}this.gridCtxMenu.blContainerMenu=false;this.onUpdateBtnStatus(false,c.getSelections());this.gridCtxMenu.showAt(b.getXY())},containerContextmenu:function(a,c,d){d.preventDefault();if(c.getStore().storetype===SYNO.webfm.utils.source.remotes){return}if(!SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){var b=this.dirTree.getNodeById("fm_root");if(1>=b.childNodes.length){return}}this.gridCtxMenu.blContainerMenu=true;this.onUpdateBtnStatus(true,a);this.gridCtxMenu.showAt(d.getXY())},dataViewContainerContextmenu:function(a,b){a.getSelectionModel().clearAllSelections();this.containerContextmenu(a.getSelectedRecords(),a,b);b.stopPropagation()},gridContainerContextmenu:function(a,b){a.getSelectionModel().clearAllSelections();this.containerContextmenu(a.getSelectionModel().getSelections(),a,b)},onFindAvailableNode:function(a,d){var c;if(!a){return null}var b;if(-1===a.indexOf("/")&&-1!==(b=a.indexOf("fm_"))){var e=a.substr(b);if(e==="fm_search_root"){c=this.dirTree.getNodeById(e)}}else{if(d){c=this.dirTree.getNodeById(d+a)}else{c=this.dirTree.getNodeById(this.getCurrentSource()+a)||this.dirTree.getNodeById(SYNO.webfm.utils.source.remote+a)}}if(!c){b=a.lastIndexOf("/");if(b==-1||b===0){return a}c=this.onFindAvailableNode(a.substr(0,b),d)}return c},onGoToPathWithFile:function(b){var a=b.substr(0,b.lastIndexOf("/"));this.onGoToPathWithDir(a,b)},onGoToPathWithDirBySource:function(e,b,d,c){var a=this.onFindAvailableNode(b,c);if(!a||!Ext.isObject(a)){if(!e){this.owner.getMsgBox().alert(_T("tree","leaf_filebrowser"),_WFT("error","error_dest_no_path"))}return}if(a.attributes.path===b){if(d){this.setHighlightEntry(d)}this.onChangeDir(b);this.dirTree.getSelectionModel().select(a)}else{this.goto_path=b;a.expand(false,false,function(f){this.onGoToPathCallBack(e,f,b,d,c)},this)}},onGoToPathWithDir:function(a,b){this.onGoToPathWithDirBySource(false,a,b)},expandChildNodes:function(e,b){if(e.childNodes.length>0){var d=e.childNodes;for(var c=0,a=d.length;c<a;c++){if(d[c].attributes.children&&SYNO.webfm.utils.isSubNotEqualPath(d[c].attributes.path,b,(SYNO.webfm.utils.isLocalSource(d[c].attributes.type)&&Ext.isWindows)?"\\":"/")){d[c].expand(false);this.expandChildNodes(d[c],b)}}}},onGoToPathCallBack:function(e,b,a,d,c){this.expandChildNodes(b,a);if(d){this.setHighlightEntry(d)}if(a){this.onChangeDir(a)}var f=this.dirTree.getNodeById((c||SYNO.webfm.utils.source.remote)+a);if(f){this.dirTree.getSelectionModel().select(f)}else{if(!e){this.owner.getMsgBox().alert(_T("tree","leaf_filebrowser"),_WFT("error","error_dest_no_path"))}}},onOpenContainingFolder:function(){if(this.getCurrentSource()!==SYNO.webfm.utils.source.remotes){return}var c=this.activeView.getSelectionModel();var b=c.getSelected();var a=b.get("file_id");this.onGoToPathWithFile(a)},nodedblclick:function(a,b,c,d){this.dblclick(a,b,c,d);this.enableHotKeyByFocusDataView(a)},gridCelldblclick:function(b,d,a,c){this.dblclick(b,d,a,c);this.enableHotKeyByFocusGrid(b)},dblclick:function(a,k,c,j){var i="";var d;var h=this.activeDS.getAt(k);var b=[];var f;var g;if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes){if(h.get("isdir")===true){this.onGoToPathWithDir(h.get("file_id"))}else{this.onGoToPathWithFile(h.get("file_id"))}}else{if(SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())){if(h.get("isdir")===false){if(true===this.onExternDbClick(h)){return}if(!this.onCheckVFSAction("download",h)){return}this.onDownloadAction(undefined,j);return}if(!this.onCheckVFSAction("navigate",h)){this.owner.getMsgBox().alert(_T("tree","leaf_filebrowser"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("navigate",h,false,false)){this.owner.getMsgBox().alert(_T("tree","leaf_filebrowser"),_WFT("error","error_privilege_not_enough"));return}i=h.get("file_id");d=this.dirTree.getNodeById(this.getCurrentSource()+i);if(d){this.dirTree.getSelectionModel().select(d)}}else{if(SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){b[0]=h.get("file_id");if(h.get("isdir")===false){f={files:b,action:"openfile"};g=AppletProgram.action(f);AppletProgram.checkResponse(g,this);return}i=h.get("file_id");d=this.dirLocalTree.getNodeById(this.getCurrentSource()+i);if(d){this.dirLocalTree.getSelectionModel().select(d)}}}}this.onChangeDir(i)},enableHotKeyByFocusGrid:function(a){a.getView().focusEl.focus()},enableHotKeyByFocusDataView:function(a){a.getEl().focus()},onSettingClose:function(){this.setDragToDesktop();this.onChangeDir(this.getCurrentDir())},beforeClose:function(){if(!this.tid){return}this.owner.sendWebAPI({api:"SYNO.FileStation.List",timeout:SYNO.webfm.Cfg.timeout,method:"list",version:1,params:{folder_path:this.getCurrentDir(),tid_delete:this.tid},callback:function(){},scope:this})},initDS:function(){this.remoteDS=new Ext.data.Store({storetype:SYNO.webfm.utils.source.remote,proxy:new SYNO.API.Proxy({timeout:SYNO.webfm.Cfg.timeout,api:"SYNO.FileStation.List",method:"list",version:1,listeners:{scope:this,beforeload:function(a,b){var c=a.activeRequest.read;if(c){Ext.Ajax.abort(c)}},load:function(b,d,a,c){if(d&&d.tid){this.tid=d.tid}}}}),reader:new Ext.data.JsonReader({root:"files",id:"path"},[{name:"file_id",mapping:"path"},{name:"path"},{name:"filename",mapping:"name"},{name:"filesize",mapping:"additional.size"},{name:"mt",mapping:"additional.time.mtime"},{name:"ct",mapping:"additional.time.crtime"},{name:"at",mapping:"additional.time.atime"},{name:"privilege",mapping:"additional.perm.posix"},{name:"fileprivilege",convert:function(c,a){var b=a.additional.perm.acl,d;if(b.append){d|=SYNO.webfm.utils.Mode_Append}if(b.del){d|=SYNO.webfm.utils.Mode_Del}if(b.exec){d|=SYNO.webfm.utils.Mode_Exec}if(b.read){d|=SYNO.webfm.utils.Mode_Read}if(b.write){d|=SYNO.webfm.utils.Mode_Write}return d}},{name:"isacl",mapping:"additional.perm.is_acl_mode"},{name:"icon"},{name:"type",mapping:"additional.type"},{name:"real_path",mapping:"additional.real_path"},{name:"isdir"},{name:"owner",mapping:"additional.owner.user"},{name:"group",mapping:"additional.owner.group"},{name:"uid",mapping:"additional.owner.uid"},{name:"gid",mapping:"additional.owner.gid"},{name:"ppath"},{name:"mountType",mapping:"additional.mount_point_type"},{name:"is_snapshot"},{name:"is_btrfs_subvol"},{name:"snapshot_desc"},{name:"has_snapshot"},{name:"description",mapping:"additional.description"}]),remoteSort:true,paramNames:{start:"offset",limit:"limit",sort:"sort_by",dir:"sort_direction"},sortInfo:{field:"name",direction:"ASC"},baseParams:{sort_by:"name",additional:"real_path,size,owner,time,perm,type,mount_point_type,description"},pruneModifiedRecords:true,listeners:{scope:this,beforeload:function(a,b){var f=b.params;var d=this;if(this.tidFunc){clearTimeout(this.tidFunc);this.tidFunc=undefined}this.tidFunc=setTimeout(function(){d.updateTid(d,f)},500);var e=a.fields.get(a.sortInfo.field);var c=e?(e.mapping||e.name):"name";c=c.split(".",3);f.sort_by=c[2]||c[1]||c[0];return f},load:this.loadRemoteDS,exception:this.exceptionRemoteDS}});this.addManagedComponent(this.remoteDS);this.activeDS=this.remoteDS},updateTid:function(a,b){if(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enable_cross_browser_dd")){if(a.tid){b.tid_old=a.tid}else{b.tid_old=Math.random()}}else{if(a.tid){b.tid_delete=a.tid;a.tid=undefined}}a.owner.sendWebAPI({api:"SYNO.FileStation.List",timeout:SYNO.webfm.Cfg.timeout,method:"list",version:1,params:b,callback:function(d,c){if(c&&c.tid){a.tid=c.tid}},scope:a})},setSortColumnModel:function(a){this.setSortCM(this.cmNoppath,a);this.setSortCM(this.cmWithppath,a)},setSortCM:function(a,c){var b=a.columns;if(b[0].sortable===c){return}Ext.each(b,function(d){d.sortable=c},this);a.setConfig(b,false)},onHeaderMouseDown:function(){if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes&&this.remoteSearchDS.blSearhDone){this.remoteSearchDS.blSearchSorted=true}},getExternIcon:function(b,c){var d,a;if(Ext.isEmpty(this.externCodeIcon)){return}Ext.each(this.externCodeIcon,function(e){if(!Ext.isString(e.data.getIconFn)){return}try{var g=Ext.getClassByName(e.data.getIconFn);if((a=g(e,b,c))){if(Ext.isEmpty(a)||false===a){return}if(Ext.isObject(a)){d={};d.url=a.url?(e.baseURL+"/"+(a.url)):"";d.css=a.css||""}else{if(Ext.isString(a)){d={};d.url=a;d.css=""}else{return}}return false}}catch(f){SYNO.Debug("Fail to render icon"+f)}},this);if(Ext.isEmpty(d)){return}return d},changeView:function(c){var b=this,a;b.viewPanel.getLayout().setActiveItem(c);if(c==="thumbnailView"){b.activeView=b.thumbnailsPanel;a=b.thumbnailsPagingtoolbar}else{b.activeView=b.grid;a=b.paging}if(_S("standalone")){this.appInstance.setUserSettings("activeViewItemId",c)}a.setButtonsVisible(a.getPageData().total>this.displayNum)},getCurrentViewItemId:function(){return this.activeView.itemId},getCurrentViewSize:function(){return this.activeViewSize},initPanel:function(b){var d=this;var a=[],c=new SYNO.FileStation.TypeAndSearchPlugin();if(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload()){var f=[],e=[];d.btnUpSubMenuAction.each(function(h){var g=h.menu.get("upload_skip");if(g){f.push(g)}g=h.menu.get("upload_overwrite");if(g){e.push(g)}});d.btnTreeUpSubMenuAction.each(function(h){var g=h.menu.get("upload_skip");if(g){f.push(g)}g=h.menu.get("upload_overwrite");if(g){e.push(g)}});f.push(this.btnRemoteUpload.menu.get("upload_skip"));e.push(this.btnRemoteUpload.menu.get("upload_overwrite"));d.html5UploadMgr=new SYNO.FileStation.Action.Uploader.HTML5UploaderMgr({owner:d,url:d.RELURL+"webUI/html5_upload.cgi",btncfg:{skipbtncfg:f,ovwrbtncfg:e}});a.push(d.html5UploadMgr)}a.push(c);d.viewPanel=d.viewPanel||new Ext.Container(Ext.apply({owner:d,layout:"card",deferredRender:true,items:[d.initFileGrid(),d.initThumbnailsView()],activeItem:0,plugins:a,searchAndFocus:d.searchAndFocus.createDelegate(d)},b));d.activeView=d.grid;d.addManagedComponent(c);return d.viewPanel},showLoading:function(){this.paging.showLoading();this.thumbnailsPagingtoolbar.showLoading()},hideLoading:function(){this.paging.hideLoading();this.thumbnailsPagingtoolbar.hideLoading()},createPagingToolbar:function(){var b=this.dirTree;var a=new SYNO.ux.PagingToolbar({store:this.activeDS,pageSize:this.displayNum,displayInfo:true,showRefreshBtn:true,hidden:false,listeners:{scope:this,beforechange:{fn:function(d,e){if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes){return this.remoteSearchDS.blSearhDone}if(d.cursor===e[d.getParams().offset]){var c=[];c.push(this.getCurrentDir());this.refreshTreeNode(c,true,this.getCurrentSource())}return true},scope:this},change:{fn:function(c,d){this.setPagingToolbar(d.total,c.ownerContainer,c)},scope:this}},hideLoading:function(){this.refresh.show();this.loading.hide();if(this.dirTree.searchNode.ui){this.dirTree.searchNode.ui.removeClass("search-loading")}},showLoading:function(){this.refresh.hide();this.loading.show();if(this.dirTree.searchNode.ui){this.dirTree.searchNode.ui.addClass("search-loading")}}});a.dirTree=b;return a},changeThumbSize:function(a){if(_S("standalone")){this.appInstance.setUserSettings("activeViewSize",a)}this.activeViewSize=a;this.thumbnailView.changeThumbSize(a)},initThumbnailsView:function(){var c=this,a=[];var b={store:c.activeDS,owner:c,RELURL:c.RELURL,ddGroup:"SDSShortCut",plugins:[SYNO.FileStation.FocusComponentPluginInstance],keys:this.getHotKeyMap(),ddText:_WFT("common","ddtext_files_selected"),getDragDropText:function(){var d=this.getSelectionCount?this.getSelectionCount():1;return String.format(this.ddText,d,d==1?"":"s")},listeners:{render:{fn:function(d){d.dragZone=new SYNO.webfm.utils.DataViewDragZone(d,{ddGroup:d.ddGroup,onGetShortCutRecs:this.onGetShortCutRecs.createDelegate(this),onBeforeDrag:function(f,g){SYNO.webfm.SmartDDMVCPMgr.initDragData(c,f.selections);return SYNO.webfm.utils.DataViewDragZone.prototype.onBeforeDrag.apply(this,arguments)}});d.dddrop=new SYNO.webfm.utils.DataViewDropTarget(d,{ddGroup:d.ddGroup,ddText:d.ddText},this)},scope:this},contextmenu:{fn:this.nodeContextMenu,scope:this},containercontextmenu:{fn:this.dataViewContainerContextmenu,scope:this},containerclick:{fn:function(d,f){if(true!==f.target.hasClassName("vscrollerbar")){d.getSelectionModel().clearAllSelections()}}},afterrender:{fn:function(d){d.getEl().on("keyup",function(g){var f=this.getCmdCode();if(Ext.isArray(f)){this.cmdKeyDown=this.cmdKeyDown&&(f.indexOf(g.getKey())===-1)}else{this.cmdKeyDown=this.cmdKeyDown&&(f!==g.getKey())}},this)},scope:this,single:true},dblclick:{fn:this.nodedblclick,scope:this}}};c.thumbnailsPagingtoolbar=c.thumbnailsPagingtoolbar||c.createPagingToolbar();c.thumbnailsPanel=new Ext.Panel({cls:"webfm-thumbnail-view-panel",itemId:"thumbnailView",layout:"fit",items:[this.thumbnailView=new SYNO.FileStation.ThumbnailsView(b)],bbar:c.thumbnailsPagingtoolbar,thumbnailView:c.thumbnailView,plugins:a,getViewEl:function(){return c.thumbnailView.getEl()},focusItem:function(d){c.thumbnailView.focusNode(d)},owner:this,getStore:function(){return c.thumbnailView.getStore()},getSelectionModel:function(){return c.thumbnailView.getSelectionModel()},listeners:{activate:{fn:function(){this.thumbnailsPanel.doLayout();this.thumbnailView.onUpdate();this.thumbnailView.updateScrollbar()},scope:this},afterrender:{fn:function(d){this.mon(d.getEl(),"contextmenu",function(f){this.dataViewContainerContextmenu(c.thumbnailView,f)},this)},scope:this}}});c.thumbnailsPagingtoolbar.ownerContainer=c.thumbnailsPanel;c.thumbnailView.setSearchStategy(SYNO.SDS.Utils.DataView.ConstantSearchStrategy.createDelegate(c.thumbnailView));c.thumbnailsPanel.mon(c.thumbnailView,"afterUpdateScrollbar",this.onAfterThumbUpdateScrollbar,this);return c.thumbnailsPanel},initFileGrid:function(f,h){var i=function(n,m,l){if(l.get("isdir")){return""}else{return Ext.util.Format.fileSize(n)}};var g=function(n,m,l){if(!n||(l.get("mountType")==="remotefail")){return""}return(new Date(n*1000)).toLocaleString()};var b=this.RELURL;var d=[{id:"filename",header:_WFT("common","common_filename"),dataIndex:"filename",width:160,renderer:(function(n,r,q,v,m,u){if(Ext.isEmpty(q.data.icon)){q.data.icon=SYNO.webfm.utils.getThumbName(q.data)}var t=Ext.util.Format.htmlEncode(n);if(!Ext.isIE||Ext.isModernIE){r.attr='ext:qtip="'+Ext.util.Format.htmlEncode(t)+'"'}var s=q.get("icon"),p;var o=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(b+"images/files_ext/"+s,"Desktop");var l='<div class="{0} webfm-file-type-icon" style="background:url({1}) no-repeat; background-size: 16px 16px;"/>&nbsp;{2}</div>';if(q.get("mountType")==="remotefail"){s="remotefailmountpoint.png"}else{if(SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())&&(p=this.getExternIcon(q))){return String.format(l,p.css,p.url||o,t)}}return String.format(l,"",SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(b+"images/files_ext/"+s,"Desktop"),t)}).createDelegate(this)},{header:_WFT("common","common_filesize"),dataIndex:"filesize",width:80,align:"right",renderer:i},{header:_WFT("filetable","filetable_title_file_type"),dataIndex:"type",width:100,align:"left",renderer:(function(q,o,l,n,p,m){if(true===l.get("isdir")){return _WFT("filetable","filetable_folder")}if(q){if((SYNO.webfm.utils.isLocalSource(this.getCurrentSource()))&&(q.toLowerCase()!==SYNO.webfm.utils.getExt(l.data.filename))){return Ext.util.Format.htmlEncode(q.toUpperCase())}return Ext.util.Format.htmlEncode(q.toUpperCase())+" "+_WFT("filetable","filetable_file")}return _WFT("filetable","filetable_file")}).createDelegate(this)},{header:_WFT("filetable","filetable_mtime"),dataIndex:"mt",width:150,align:"right",renderer:g},{header:_WFT("filetable","filetable_ctime"),dataIndex:"ct",width:150,align:"right",renderer:g,hidden:true},{header:_WFT("filetable","filetable_atime"),dataIndex:"at",width:150,align:"right",renderer:g,hidden:true},{header:_WFT("filetable","filetable_privilege"),dataIndex:"privilege",width:80,align:"right",hidden:true,renderer:(function(v,u,q,y,m,w){if(SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){return""}var r=q.data.privilege,n="",x="",s="";var l=0,p=0,t=0;var o=parseInt(r,10);if(o>=100){l=Math.floor(o/100);o-=l*100}if(o>=10){p=Math.floor(o/10);o-=p*10}t=o;n+=(l&4)?"r":"-";n+=(l&2)?"w":"-";n+=(l&1)?"x":"-";x+=(p&4)?"r":"-";x+=(p&2)?"w":"-";x+=(p&1)?"x":"-";s+=(t&4)?"r":"-";s+=(t&2)?"w":"-";s+=(t&1)?"x":"-";return n+x+s}).createDelegate(this)}];if(!_S("diskless")){d.push({header:_WFT("filetable","filetable_owner"),dataIndex:"owner",width:80,align:"right",hidden:true,renderer:(function(q,o,l,n,p,m){if(l.get("mountType")==="remotefail"){return""}if(q===""){return l.get("uid")}return q}).createDelegate(this)},{header:_WFT("filetable","filetable_group"),dataIndex:"group",width:80,align:"right",renderer:(function(q,o,l,n,p,m){if(l.get("mountType")==="remotefail"){return""}if(q===""){return l.get("gid")}return q}).createDelegate(this),hidden:true})}this.cmNoppath=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:d});var k=SYNO.Util.copy(d);k.push({header:_WFT("extract","file_path"),dataIndex:"ppath",width:80,renderer:function(r,p,l,o,q,m){r=SYNO.webfm.utils.getParentDirArr(l.data.path);var n=Ext.util.Format.htmlEncode(r);if(!Ext.isIE||Ext.isModernIE){p.attr='ext:qtip="'+Ext.util.Format.htmlEncode(n)+'"'}return n}});this.cmWithppath=new Ext.grid.ColumnModel({defaults:{sortable:true},columns:k});this.paging=this.paging||this.createPagingToolbar();var e=[];e.push(SYNO.FileStation.FocusGridPluginInstance);var j=this;var c=new SYNO.FileStation.SelectAllRowSelectionModel();var a=new SYNO.ux.GridPanel({itemId:"fileGrid",sm:c,owner:this,region:"center",cls:"webfm-listview-grid-panel",view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:26,borderHeight:1,cacheSize:30,scrollDelay:false,forceFit:true,disableTextSelect:true,focusItem:function(m){var l=this;l.focusRow(m)},onCreateDragZone:function(){var l=this.grid;this.dragZone=new Ext.grid.GridDragZone(l,{ddGroup:l.ddGroup,onBeforeDrag:function(m,n){SYNO.webfm.SmartDDMVCPMgr.initDragData(j,m.selections);return Ext.grid.GridDragZone.prototype.onBeforeDrag.apply(this,arguments)},getDragData:function(o){var m=Ext.lib.Event.getTarget(o);var q=this.view.findRowIndex(m),n;if(q!==false){var p=this.grid.selModel;if(!p.isSelected(q)||o.hasModifier()){p.handleMouseDown(this.grid,q,o)}n=p.getSelections();return{grid:this.grid,ddel:this.ddel,rowIndex:q,selections:n,SDSShortCut:j.onGetShortCutRecs(n),_fromFile:true,ddText:_T("desktop","add_shortcut")}}return false},validateTarget:function(s,t,m){var u=s.getEl();SYNO.webfm.SmartDDMVCPMgr.disableUpateDDText(true);if(Ext.fly(u).findParentNode("div.syno-sds-aceeditor-main-panel")||Ext.fly(u).findParentNode("div.sds-audioplayer-mini-player-window")||Ext.fly(u).findParentNode("div.syno-sds-filestation-available-drop-target")){return true}var n=t.getTarget("li.launch-icon");if(SYNO.SDS.Desktop.el.id===t.getTarget().id||(n&&Ext.fly(n).findParentNode(".sds-desktop-shortcut"))){var o=this.dragData,p;for(p=0;p<o.selections.length;p++){if(SYNO.webfm.VFS.isVFSPath(o.selections[p].id)){return false}}if(o&&o.grid&&SYNO.webfm.utils.isLocalSource(o.grid.getStore().storetype)){return false}return true}n=t.getTarget();var r,q;if((n&&(Ext.fly(n).is("div.syno-sds-fs-grid-scroller")||Ext.fly(n).is("div.syno-sds-fs-thumbnailsView")||(q=Ext.fly(n).findParentNode("div.syno-sds-fs-grid-scroller"))||(q=Ext.fly(n).findParentNode("div.syno-sds-fs-thumbnailsView"))||(q=Ext.fly(n).findParentNode("div.syno-sds-fs-tree",Number.MAX_VALUE))))){q=q||n;q=(Ext.fly(q).findParentNode("div.syno-sds-fs-win",Number.MAX_VALUE));r=SYNO.SDS.WindowMgr.get(q.id);if(r){r.toFront()}SYNO.webfm.SmartDDMVCPMgr.disableUpateDDText(false);return true}q=q||n;if(q&&(q=(Ext.fly(q).findParentNode("div.syno-sds-fs-win",Number.MAX_VALUE)))){r=SYNO.SDS.WindowMgr.get(q.id);if(r){r.toFront()}}return false}})}}),title:h?("&nbsp;"):null,ds:this.activeDS,cm:this.cmNoppath,loadMask:true,autoExpandMin:160,autoExpandColumn:"filename",monitorWindowResize:true,enableColumnMove:true,enableDragDrop:true,ddGroup:"SDSShortCut",ddText:_WFT("common","ddtext_files_selected"),enableColLock:false,columnLines:true,stripeRows:true,bbar:this.paging,tbar:f,stateful:true,stateEvents:["columnmove","columnresize","sortchange"],saveState:(function(){var l=this.grid.getState();this.appInstance.setUserSettings("gridstates",l)}).createDelegate(this),plugins:e,getViewEl:function(){return this.getView().scroller},focusItem:function(m){var l=this.getView();l.focusItem(m)},listeners:{scope:this,render:{fn:function(l){var m=l.getView().scroller.dom;l.dddrop=new SYNO.webfm.utils.GridDropTarget(m,{ddGroup:"SDSShortCut"},this);l.getView().scroller.addClass("syno-sds-fs-grid-scroller");this.grid.getGridEl().addClass("without-dirty-red-grid")},scope:this},beforerender:{fn:function(l){var m=this.appInstance.getUserSettings("gridstates");if(m){l.applyState(m)}},scope:this},celldblclick:{fn:this.gridCelldblclick,scope:this},rowcontextmenu:{fn:this.gridRowContextMenu,scope:this},containercontextmenu:{fn:this.gridContainerContextmenu,scope:this},rowclick:{fn:function(l,n,m){if(m&&n>=0&&!m.hasModifier()){l.getSelectionModel().selectRow(n)}}},containerclick:{fn:function(l,m){if(!m.target.hasClassName("vscrollerbar")){l.getSelectionModel().clearAllSelections()}}},afterrender:{fn:function(l){l.getEl().on("keyup",function(n){var m=this.getCmdCode();if(Ext.isArray(m)){this.cmdKeyDown=this.cmdKeyDown&&(m.indexOf(n.getKey())===-1)}else{this.cmdKeyDown=this.cmdKeyDown&&(m!==n.getKey())}},this)}},headermousedown:this.onHeaderMouseDown,activate:{fn:function(){this.grid.doLayout();if(this.grid.updateScrollbar){this.grid.updateScrollbar(this.grid.getView().scroller.dom)}if(this.grid.getView().update){this.grid.getView().update()}},scope:this}},keys:this.getHotKeyMap()});this.grid=a;this.paging.ownerContainer=this.grid;this.grid.mon(this.grid,"afterUpdateScrollbar",this.onAfterGridUpdateScrollbar,this);return a},getCmdCode:function(){return SYNO.webfm.utils.getCmdCode()},getHotKeyMap:function(){if(Ext.isMac){var a=this.getCmdCode();return[{key:a,fn:function(){this.cmdKeyDown=true},scope:this},{key:Ext.EventObject.DELETE,fn:this.onDeleteAction,scope:this},{key:Ext.EventObject.C,fn:this.onShortCutCopyAction,stopEvent:true,scope:this},{key:Ext.EventObject.X,fn:this.onShortCutCutAction,stopEvent:true,scope:this},{key:Ext.EventObject.V,fn:function(){this.onShortCutPasteAction(SYNO.webfm.utils.hotKey,(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false,true)},stopEvent:true,scope:this},{key:Ext.EventObject.F2,fn:this.onRenameAction,scope:this},{key:Ext.EventObject.A,fn:this.onSelectAllRowAction,stopEvent:true,scope:this}]}else{return[{key:Ext.EventObject.DELETE,fn:this.onDeleteAction,scope:this},{key:Ext.EventObject.C,ctrl:true,fn:this.onShortCutCopyAction,scope:this},{key:Ext.EventObject.X,ctrl:true,fn:this.onShortCutCutAction,scope:this},{key:Ext.EventObject.V,ctrl:true,fn:function(){this.onShortCutPasteAction(SYNO.webfm.utils.hotKey,(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false,true)},scope:this},{key:Ext.EventObject.F2,fn:this.onRenameAction,scope:this},{key:Ext.EventObject.A,ctrl:true,fn:this.onSelectAllRowAction,scope:this}]}},getViewEl:function(){return this.activeView.getViewEl()},searchAndFocus:function(g,d){var h=this,f=false,i=false,l="filename",j=h.activeView,k=j.getStore(),b=j.getSelectionModel(),c=b.getSelected(),a=0,e=-1;a=d?k.indexOf(c):k.indexOf(c)+1;if(a>(k.getCount()-1)){a=0}e=k.find(l,g,a,f,i);if(e<0){if(a!==0){e=k.find(l,g,0,f,i)}if(e<0){return false}}b.selectRow(e);j.focusItem(e);return true},highlightItem:function(b){var d,a;if(b.highlightId){var c=b.highlightId;d=this.activeView.getSelectionModel();if(!b){return}a=b.indexOfId(c);if(d&&-1!=a){d.selectRow(a);this.activeView.focusItem(a)}this.highlightId=null}},onAfterGridUpdateScrollbar:function(){this.highlightItem(this.grid.getStore())},onAfterThumbUpdateScrollbar:function(){this.highlightItem(this.thumbnailView.getStore())},loadDS:function(a,c,b){var d;a.highlightId=this.highlightId;this.unmaskView();d=this.dirTree.getSelectionModel();this.updateCutIcon()},exceptionDS:function(b,c){if(this.isViewMasked()){this.unmaskView()}var a=[2102,2107,2112,2115];if(b&&(-1!==a.indexOf(b.code))){SYNO.webfm.utils.handleRemoteConnectionException(b,{id:SYNO.webfm.VFS.getBaseURI(c.folder_path)},this.findWindow(),function(){this.remoteDS.reload()},function(){this.maskView(SYNO.webfm.utils.getWebAPIErrStr(false,b))},this)}else{this.maskView(SYNO.webfm.utils.getWebAPIErr(false,b,c))}},loadRemoteDS:function(a,c,b){this.loadDS(a,c,b);this.ajaxCounter++;if(this.ajaxCounter==2){this.initJava()}this.updateRemoteMountIcon();this.setDragToDesktop()},setPagingToolbar:function(b,a,c){c.setButtonsVisible(b>this.displayNum);if(b!==0&&b%this.displayNum===0&&c.store.getCount()===0){c.movePrevious()}a.doLayout()},exceptionRemoteDS:function(c,d,e,b,f,a){this.exceptionDS(f,b.params,b)},loadLocalDS:function(a,c,b){this.loadDS(a,c,b)},exceptionLocalDS:function(b,d,f,a,g){var e=this,c=e.viewPanel.getEl();if(c.isMasked()){c.unmask()}var h=_WFT("error","error_error_system");if(g.errno){h=_WFT(g.errno.section,g.errno.key)}c.mask(h)},onPropertyClick:function(){var b=this.activeView.getSelectionModel();if(!b.hasSelection()){return}var a=b.getSelections();this.FileAction.Property(a,this.userId)},onShareClick:function(){var b=this.activeView.getSelectionModel();if(!b.hasSelection()){return}var a=b.getSelections();this.FileAction.Share(a)},checkCompressPrivilege:function(a){if(!this.onCheckVFSAction("compress",a)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_WFT("error","not_support"));return false}if(!this.onCheckPrivilege("compress",a,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_WFT("error","error_privilege_not_enough"));return false}return true},onCompressItemsClick:function(){var a;var b=this.activeView.getSelectionModel();if(!b.hasSelection()){return null}if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_JSLIBSTR("uicommon","error_demo"));return}a=b.getSelections();if(!this.checkCompressPrivilege(a)){return}this.FileAction.Compress(a,this.getCurrentDir(),this.getSuggestZipName(a))},onCompressAdvItemsClick:function(){var a;var b=this.activeView.getSelectionModel();if(!b.hasSelection()){return null}if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_JSLIBSTR("uicommon","error_demo"));return}a=b.getSelections();if(!this.checkCompressPrivilege(a)){return}this.FileAction.compressDialog(a,this.getCurrentDir(),this.getSuggestZipName(a))},getExtractRec:function(b){var c=this.activeView.getSelectionModel();if(!c.hasSelection()){return null}var a=c.getSelections();if(!this.onCheckPrivilege("extract",a,b,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_extract"),_WFT("error","error_privilege_not_enough"));return null}return a},onMountList:function(){this.FileAction.MountList()},onSettings:function(){this.FileAction.onSettings()},onMountRemoteClick:function(){if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_remote_volume"),_JSLIBSTR("uicommon","error_demo"));return}this.FileAction.MountRemote(this.userId,this.userGroup)},onRemoteConnectClick:function(){this.FileAction.RemoteConnect(this.owner)},onRemoteConnectServerListClick:function(){if(_S("demo_mode")===true){this.owner.getMsgBox().alert("",_JSLIBSTR("uicommon","error_demo"));return}this.FileAction.RemoteConnectServerList(this.owner)},onMountISOClick:function(){var a;var b=this.activeView.getSelectionModel();if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_JSLIBSTR("uicommon","error_demo"));return}if(!b.hasSelection()){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("mount","err_virtual_no_selected"));return}a=b.getSelections();if(1!==a.length||(-1===SYNO.webfm.utils.image_type.indexOf(a[0].get("type").toLowerCase()))){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("mount","err_virtual_no_selected"));return}if(!this.onCheckVFSAction("mount",a)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("mount",a,false,false)){this.owner.getMsgBox().alert(_WFT("filetable","filetable_mount_iso"),_WFT("error","error_privilege_not_enough"));return}this.FileAction.MountISO(a,this.userId,this.userGroup)},onUmountClick:function(){var a,c;var b=this.activeView.getSelectionModel();if(_S("demo_mode")===true){this.owner.getMsgBox().alert(_WFT("mount","umount"),_JSLIBSTR("uicommon","error_demo"));return}if(!b.hasSelection()){return}a=b.getSelections();if(1!==a.length){return}c=a[0].get("file_id");if(!this.onCheckVFSAction("umount",a)){this.owner.getMsgBox().alert(_WFT("mount","umount"),_WFT("error","not_support"));return}if(!this.onCheckPrivilege("umount",a,false,false)){this.owner.getMsgBox().alert(_WFT("mount","umount"),_WFT("error","error_privilege_not_enough"));return}this.FileAction.Umount(a,[c])},onExtractClick:function(){if(_S("demo_mode")){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_JSLIBSTR("uicommon","error_demo"));return}var a=this.getExtractRec(0);if(!a){return}this.FileAction.Extract(a,this.userId,this.userGroup)},onExtractHereClick:function(){if(_S("demo_mode")){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_JSLIBSTR("uicommon","error_demo"));return}var a=this.getExtractRec(1);if(!a){return}this.FileAction.ExtractNoDialog(a,false)},onExtractFolderNameClick:function(){if(_S("demo_mode")){this.owner.getMsgBox().alert(_WFT("filetable","filetable_compress"),_JSLIBSTR("uicommon","error_demo"));return}var a=this.getExtractRec(2);if(!a){return}this.FileAction.ExtractNoDialog(a,true)},onAddFav:function(){var b=this.activeView.getSelectionModel();if(!b.hasSelection()){return null}var a=b.getSelections();this.FileAction.AddFav(a)},onChangeDisplayType:function(a){if(this.showContent!=a){this.showContent=a;this.activeDS.baseParams.filetype=this.showContent;this.activeDS.load({params:{offset:0,limit:this.displayNum}})}},isViewMasked:function(){return this.viewPanel.getEl().isMasked()},maskView:function(b,a){this.viewPanel.getEl().mask(b,a)},unmaskView:function(){this.viewPanel.getEl().unmask()},expandTreeToDir:function(c,a,b){if(a.length>1){this.enableDisableToolbarBtn(true);this.fileFilter.disableAdvancedSearch=false;var d=a[0];if(this.blExpanded||(!d&&!this.initPath)){return}this.blExpanded=true;if(b){this.unmaskView();this.onChangeDir(this.initPath?this.initPath:d.attributes.path)}}else{this.enableDisableToolbarBtn(false);this.fileFilter.disableAdvancedSearch=true;this.activeDS.removeAll();this.maskView(_WFT("error","error_no_shared_folder"))}this.onUpdateBtnStatus();if(a.length<=1&&!_S("diskless")&&true===_S("is_admin")){if(_S("standalone")){this.owner.getMsgBox().alert(_T("tree","leaf_filebrowser"),_WFT("error","alert_noshare"))}else{this.owner.getMsgBox().show({title:_T("tree","leaf_filebrowser"),msg:_T("filebrowser","prompt_noshare"),width:300,buttons:Ext.MessageBox.OKCANCEL,fn:function(e){if("ok"==e){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Share.Main",dlg:"create"})}}})}}},switchSource:function(c){var b;if((b=this.getCurrentSource())===c){return}this.setCurrentSource(c);if(c.substr(0,5)===SYNO.webfm.utils.source.local&&SYNO.webfm.utils.isLocalSource(b)){return}this.fileFilter.setValue("");var a=this.grid.getStore();this.setSortColumnModel(true);this.enableDisableFilterBtn(true);this.paging.hideLoading();this.paging.loading.hide();if(c.substr(0,6)===SYNO.webfm.utils.source.remote){var d;this.appWindow.getPanelInstance().btnViewMode.setDisabled(false);if(c===SYNO.webfm.utils.source.remotes){this.setSortColumnModel(this.remoteSearchDS.blSearhDone);d=this.remoteSearchDS;if(this.remoteSearchDS.blSearhDone){this.remoteSearchDS.reload()}else{this.paging.showLoading()}this.grid.reconfigure(d,this.cmWithppath)}else{d=this.remoteDS;this.grid.reconfigure(d,this.cmNoppath)}this.thumbnailView.bindStore(d);this.thumbnailsPagingtoolbar.unbind(a);this.thumbnailsPagingtoolbar.bind(d);this.paging.unbind(a);this.paging.bind(d);if(b.substr(0,5)===SYNO.webfm.utils.source.local){this.onShowUpSubMenu(true)}if(this.btnMountISO){this.btnMountISO.enable()}if(SYNO.webfm.utils.isRemoteSource(c)&&c!==SYNO.webfm.utils.source.remotev){this.btnNewFolder.enable();this.onDisableUpButton(false)}else{this.btnNewFolder.disable();this.onDisableUpButton(true);if(this.remoteSearchDS.blSearhDone){this.enableDisableFilterBtn(true)}else{this.enableDisableFilterBtn(false)}}this.activeDS=d}else{this.appWindow.getPanelInstance().btnViewMode.resetViewMode();this.appWindow.getPanelInstance().btnViewMode.setDisabled(true);this.grid.reconfigure(this.localDS,this.cmNoppath);this.paging.unbind(a);this.paging.bind(this.localDS);if(this.btnMountISO){this.btnMountISO.disable()}this.btnNewFolder.enable();this.onShowUpSubMenu(false);this.activeDS=this.localDS}this.gridCtxMenu.get("gc_sort").bindEvent(this.activeDS);this.btnSort.bindEvent(this.activeDS);this.fileFilter.store=this.activeDS},isPathEqualLastHistory:function(a){var b=this.historyIndex;if(b<0||this.historyCnt<b){return false}return(a===this.historyPath[b].directory)&&(this.historyPath[b].source===this.getCurrentSource())},historySet:function(a){if(this.isPathEqualLastHistory(a)){return}var b=++this.historyIndex;this.historyPath[b]={directory:a,source:this.getCurrentSource()};this.historyCnt=this.historyIndex;this.historyBtnCheck()},historyBtnCheck:function(){var b=this.historyIndex;var a=this.historyCnt;if(b===a){this.btnHisNext.disable()}else{this.btnHisNext.enable()}if(b===0){this.btnHisBack.disable()}else{this.btnHisBack.enable()}},onChangeDir:function(d,a){if(!d||d=="fm_root"||d=="fm_local_root"||d==="fm_vd_root"||d==="fm_rf_root"||d==="fm_fav_root"){return}this.activeView.getSelectionModel().clearAllSelections(true);if(a!==true){this.historySet(d)}var h=this.getCurrentDir();this.setCurrentDir(d);this.fileFilter.setValue("");var b;if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes){var e=[];e[0]=new this.pathButtonInfo(_WFT("search","search_results"),_WFT("search","search_results"),d);this.pathBar.addPathButtons(e);this.pathBar.tbPanel.el.addClass("with-right-border");b=this.dirTree.getNodeById("fm_search_root");if(b){this.dirTree.getSelectionModel().select(b)}return}this.activeDS.removeAll();this.activeDS.baseParams.filetype=this.showContent;this.activeDS.baseParams.folder_path=SYNO.API.EscapeStr(d);var g;if(!Ext.isWindows||SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())){if(SYNO.webfm.utils.isParentDir(h,d)){this.highlightId=h}this.updateCurrentPathLink(d);g=d.lastIndexOf("/")}else{if(SYNO.webfm.utils.isWinParentDir(h,d)){this.highlightId=h}this.updateWinCurrentPathLink(d);if(d.lastIndexOf("\\")==2){g=3}else{g=d.lastIndexOf("\\")}}this.activeDS.load({params:{offset:0,limit:this.displayNum}});var f,c;if(g!=-1){f=d.substr(0,g)}var i=(this.getCurrentSource().substr(0,6)===SYNO.webfm.utils.source.remote)?this.dirTree:this.dirLocalTree;c=i.getNodeById(this.getCurrentSource()+f);if(c){c.expand()}b=i.getNodeById(this.getCurrentSource()+d);if(b){i.getSelectionModel().select(b);this.changeToolbarMode(b);this.showHideCols(h,b)}else{if(c){c.reload((function(){b=i.getNodeById(this.getCurrentSource()+d);if(b){i.getSelectionModel().select(b);this.changeToolbarMode(b);this.showHideCols(h,b)}}).createDelegate(this))}}},showHideCols:function(b,a){if(this.activeView!==this.grid){return}if(!SYNO.webfm.utils.isSnapshotTopFolder(a.attributes.path,a.attributes.is_snapshot)){if(b&&SYNO.webfm.utils.isSnapshotTopFolder(b,true)){this.grid.removeClass("file-name-only")}return}this.grid.addClass("file-name-only")},changeToolbarMode:function(c){var a=true,b=true;if(!c||!c.attributes){return}if(!!c.attributes.is_snapshot){a=false;b=false}if(!this.onCheckVFSAction("create",c)){a=false}this.btnNewFolder.setDisabled(!a);if(!this.onCheckVFSAction("upload",c)){b=false}this.btnRemoteUpload.setDisabled(!b)},isDiffVolume:function(){if(this.currVolume===null){return true}var e=this.dirTree.getSelectionModel();var c=e.getSelectedNode();if(!c){return false}else{if(c.id=="fm_root"){return false}}var d=c.attributes.real_path;var a=d.indexOf("/",1);if(a==-1){return false}var b=d.substring(1,a);if(b!=this.currVolume){this.currVolume=b;return true}return false},onRemoveAllExternMenu:function(){this.onRemoveExternMenu(this.gridCtxMenu);this.onRemoveExternMenu(this.toolbarMenu)},setShowHide:function(b,a){b.setVisible(b.disabled?false:a)},onUpdateBtnStatus:function(N,F){F=F||this.activeView.getSelectionModel().getSelections();var A=this.gridCtxMenu.items;var C=SYNO.webfm.utils.isLocalSource(this.getCurrentSource());var n=(this.getCurrentSource()===SYNO.webfm.utils.source.remotes);var E,B,w,b=[],H=false,s=true,I=true,l=true,c=true;this.enableDisableActionBtn(false);this.enableDisableContextBtn(false);this.onLocalShowHideContextBtn(true);this.onLocalShowHideActionBtn(true);this.onSearchShowHideContextBtn(true);this.onSearchShowHideActionBtn(true);if(n){this.onSearchShowHideContextBtn(false);this.onSearchShowHideActionBtn(false)}else{if(C){this.onLocalShowHideContextBtn(false);this.onLocalShowHideActionBtn(false)}}var h=F.length;if((h===1&&F[0].get("mountType")==="remotefail")){this.enableDisableContextBtn(false);return}if(F&&F[0]){E=F[0].get("path")}else{E=this.getCurrentDir()}A.get("gc_createfolder").setDisabled(false);if(E&&SYNO.webfm.VFS.isVFSPath(E)){H=true;B=SYNO.webfm.VFS.getBaseURI(E);w=this.dirTree.getNodeById("remote"+B);if(w&&w.attributes.api){b=w.attributes.api}}if("false"===this.sharingConfig||H){this.onHideSharingBtns()}var y;var D=false,f=false,g=false,L;for(L=0;L<F.length;L++){if(F[L].get("is_snapshot")){f=true;break}}g=(F.length===1)&&SYNO.webfm.utils.isSnapshotTopFolder(F[0].get("path"),F[0].get("is_snapshot"));if(!C&&(SYNO.webfm.utils.source.remotes!==this.getCurrentSource())){if((!(D=(SYNO.webfm.utils.source.remotev===this.getCurrentSource())))){w=this.dirTree.getNodeById(this.getCurrentSource()+this.getCurrentDir());if(w){D=w.attributes.type===SYNO.webfm.utils.source.remotev||w.attributes.mountType==="iso"||f}}}var K=this.blUploadSubMenu?this.btnUpSubMenuAction:this.btnUpBrowserAction;if(!C){y=this.getCurrentDir();if(F.length===1&&F[0].get("isdir")){y=F[0].get("filename")}else{if(y){y=y.substr(y.lastIndexOf("/")+1)}}y=Ext.util.Format.htmlEncode(y);K.setText(String.format(_WFT("filetable","upload_ddtext")+" ",(Ext.util.Format.ellipsis(y,36))));this.btnOpenWin.setText(_WFT("filetable","filetable_openwin"));this.gridCtxMenu.items.get("gc_openwin").setText(_WFT("filetable","filetable_openwin"));K.show();K.setDisabled(D||(H&&!this.onCheckVFSAction("upload",E,null,b)))}else{this.btnUpBrowserAction.show();this.btnUpBrowserAction.setText(_WFT("filetable","filetable_upload"));this.btnUpBrowserAction.enable();this.btnOpenWin.setText(_WFT("filetable","openfile"));this.gridCtxMenu.items.get("gc_openwin").setText(_WFT("filetable","openfile"))}this.onRemoveAllExternMenu();var j=false;if(F.length>0){var v=true,M=true,e=true,d=true,p=true,O=true;var P=false,G=false;j=(h===1&&F[0].get("isdir")===true);Ext.each(F,function(i){if(i.get("isdir")===true){P=true;G=SYNO.webfm.utils.isRecycleBinFolder(i.get("path"))}if(P&&G){return false}});if(P||(H&&!this.onCheckVFSAction("download",E,null,b))){e=false}if(C||G||f||H){d=false}if(h>1||f||D||(H&&!this.onCheckVFSAction("rename",E,null,b))){M=false}this.btnRename.setDisabled(!M);A.get("gc_rename").setDisabled(!M);if(!C&&!j){K.hide()}this.btnOpenWin.setDisabled(!e);this.btnShare.setDisabled(!d);A.get("gc_openwin").setDisabled(!e);if(!e){A.get("gc_openwin").hide();this.btnOpenWin.hide()}else{A.get("gc_openwin").show();this.btnOpenWin.show()}if(A.get("gc_share")){A.get("gc_share").setDisabled(!d);if(!d){A.get("gc_share").hide();this.btnShare.hide()}else{if("false"!==this.sharingConfig){A.get("gc_share").show();this.btnShare.show()}}}if(!C){if(true!==N){this.onUpdateExternMenu(F,H)}for(L=0;L<h;L++){if(!SYNO.webfm.utils.isCompressFile(F[L].get("filename"),F[L].get("type"))){v=false;break}}if(H){v=false;p=false;O=false}if(1!==h||(-1===SYNO.webfm.utils.image_type.indexOf(F[0].get("type").toLowerCase()))){p=false}if(1!==h||("iso"!==F[0].get("mountType")&&"remote"!==F[0].get("mountType")&&"remotefail"!==F[0].get("mountType"))){O=false}var q=this.getSuggestZipName(F);if(40<q.length){q=q.slice(0,37)+" ... .zip"}var m=Ext.util.Format.htmlEncode(q);this.gridCtxMenu.items.get("gc_compress").setText(_WFT("filetable","filetable_compress_to")+" "+m);this.btnCompress.setText(_WFT("filetable","filetable_compress_to")+" "+m);if(v){var t=A.get("gc_extract_menu").menu.items;var o=this.btnExtractMenu.menu.items;if(h>1){o.get("gc_extract_folder").setText(_WFT("filetable","filetable_extract_separate_folder"));t.get("gc_extract_folder").setText(_WFT("filetable","filetable_extract_separate_folder"))}else{y=SYNO.webfm.utils.getZipName(F[0].get("filename"));if(40<y.length){y=q.slice(0,37)+" ... "}m=Ext.util.Format.htmlEncode(y);o.get("gc_extract_folder").setText(_WFT("filetable","filetable_extract_to")+" "+m+"/");t.get("gc_extract_folder").setText(_WFT("filetable","filetable_extract_to")+" "+m+"/")}}this.btnExtractMenu.setDisabled(!v);A.get("gc_extract_menu").setDisabled(!v);if(!v){this.btnExtractMenu.hide();A.get("gc_extract_menu").hide()}else{this.btnExtractMenu.show();A.get("gc_extract_menu").show()}if("yes"===_D("supportmount")){if(p){if(this.btnMountISO){this.btnMountISO.enable()}if(this.gridCtxMenu.items.get("gc_mount_iso")){this.gridCtxMenu.items.get("gc_mount_iso").show()}}else{if(this.btnMountISO){this.btnMountISO.disable()}if(this.gridCtxMenu.items.get("gc_mount_iso")){this.gridCtxMenu.items.get("gc_mount_iso").hide()}}if(O){if(this.btnUmount){this.btnUmount.enable()}if(this.gridCtxMenu.items.get("gc_umount")){this.gridCtxMenu.items.get("gc_umount").show()}}else{if(this.btnUmount){this.btnUmount.disable()}if(this.gridCtxMenu.items.get("gc_umount")){this.gridCtxMenu.items.get("gc_umount").hide()}}}var J=true;Ext.each(F,function(i){J=!this.checkFTPDownloadRightByPath(i.get("file_id"));return J},this);if(H&&!this.onCheckVFSAction("download",E,null,b)){J=false}if(J&&!g){this.btnDownloadMenu.enable();this.btnDownload.enable();A.get("gc_download").enable();A.get("gc_download_menu").enable()}if(!H&&!C){this.btnFavSubMenu.setVisible(j);this.btnDSMShortcut.setVisible(!j&&!_S("standalone"));this.btnFavSubMenu.menu.items.get("gc_dsmshortcut").setVisible(!_S("standalone"));this.sepFav.setVisible(!_S("standalone")||_S("standalone")&&j);A.get("gc_fav_menu").setVisible(j);A.get("gc_dsmshortcut").setVisible(!j&&!_S("standalone"));A.get("gc_fav_menu").menu.items.get("gc_dsmshortcut").setVisible(!_S("standalone"));A.get("gc_sep_fav").setVisible(!_S("standalone")||_S("standalone")&&j);this.btnCompressAdv.show();this.btnCompress.show();A.get("gc_compress_adv").show();A.get("gc_compress").show();if(!D){this.btnCompressAdv.enable();this.btnCompress.enable();A.get("gc_compress_adv").enable();A.get("gc_compress").enable()}}}this.btnProperty.enable();A.get("gc_property").enable();if(g||(H&&!this.onCheckVFSAction("move",E,null,b))){s=false}if(g||(H&&!this.onCheckVFSAction("copy",E,null,b))){I=false}this.btnMVCPToMenu.setDisabled(!s&&!I);A.get("mvcpto").setDisabled(!s&&!I);this.btnCopy.setDisabled(!I);A.get("gc_copy").setDisabled(!I);this.btnMVCPToMenu.setOvwrVisible(C);A.get("mvcpto").setOvwrVisible(C);this.btnMVCPToMenu.setMoveDisabled(D||!s);A.get("mvcpto").setMoveDisabled(D||!s);if(!D){if(H&&!this.onCheckVFSAction("move",E,null,b)){l=false}if(l){this.btnCut.enable();A.get("gc_cut").enable()}if(H&&!this.onCheckVFSAction("delete",E,null,b)){c=false}if(c){this.btnDelete.enable();A.get("gc_delete").enable()}}if(this.grid.getStore().storetype===SYNO.webfm.utils.source.remotes){this.onSearchShowHideContextBtn(false);this.onSearchShowHideActionBtn(false);if("yes"===_D("supportmount")){A.get("gc_sep_archive").setVisible(O||p)}if(!j){this.btnUpSubMenuAction.setHidden(true);this.btnUpBrowserAction.setHidden(true)}}}var z=!SYNO.FileStation.Clipboard.isEmpty();var x=SYNO.FileStation.Clipboard.get();if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes){z&=j}if(H&&x&&!this.onCheckVFSAction(x.action,x.recs,E,null,b)){z=false}var k=this.dirTree.getSelectionModel();w=k.getSelectedNode();var r=this.checkFtpModifyRight(w);var u;if(r){this.btnPasteOvwr.setText(_WFT("filetable","filetable_paste"));A.get("gc_paste_ovwr").setText(_WFT("filetable","filetable_paste"))}else{u=_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_overwrite");this.btnPasteOvwr.setText(u);A.get("gc_paste_ovwr").setText(u)}this.btnPasteOvwr.setVisible(z);this.btnPasteSkip.setVisible(z&&!r);A.get("gc_paste_ovwr").setVisible(z);A.get("gc_paste_skip").setVisible(z&&!r);this.btnPasteOvwr.setDisabled(D);this.btnPasteSkip.setDisabled(D);A.get("gc_paste_ovwr").setDisabled(D);A.get("gc_paste_skip").setDisabled(D);A.get("gc_sort").setVisible(F.length===0);A.get("gc_snapshot_history").setVisible(F.length===1&&F[0].get("has_snapshot"));var a=true;if(f||(H&&!this.onCheckVFSAction("create",this.getCurrentDir(),null,b))){a=false}A.get("gc_createfolder").setDisabled(!a)},enableDisableFilterBtn:function(a){if(a){this.fileFilter.enable();this.displayType.enable()}else{this.displayType.disable();this.fileFilter.disable();this.fileFilter.setValue("")}},enableDisableToolbarBtn:function(a){if(a){this.btntoolbarMenu.enable();this.onDisableUpButton(false);this.btnNewFolder.enable();if(this.btnMountRemote){this.btnMountRemote.enable()}}else{this.btntoolbarMenu.disable();this.onDisableUpButton(true);this.btnNewFolder.disable();if(this.btnMountRemote){this.btnMountRemote.disable()}}this.enableDisableFilterBtn(a)},enableDisableActionBtn:function(a){if(a){this.btnOpenWin.enable();this.btnShare.enable();this.btnDownload.enable();this.btnDownloadMenu.enable();this.btnExtractMenu.enable();this.btnCut.enable();this.btnCopy.enable();this.btnDelete.enable();this.btnRename.enable();this.btnProperty.enable();this.btnCompressAdv.enable();this.btnCompress.enable();if(this.btnUmount){this.btnUmount.enable()}}else{this.btnOpenWin.disable();this.btnShare.disable();this.btnDownload.disable();this.btnDownloadMenu.disable();this.btnExtractMenu.disable();this.btnCut.disable();this.btnCopy.disable();this.btnDelete.disable();this.btnRename.disable();this.btnProperty.disable();this.btnCompressAdv.disable();this.btnCompress.disable();if(this.btnUmount){this.btnUmount.disable()}}this.btnMVCPToMenu.setDisabled(!a);if(this.btnMountISO){this.btnMountISO.setDisabled(!a)}this.btnPasteOvwr.hide();this.btnPasteSkip.hide();this.btnFavSubMenu.setVisible(a);this.btnDSMShortcut.setVisible(a);this.sepFav.setVisible(a)},enableDisableContextBtn:function(m){var d=this.blUploadSubMenu?this.btnUpSubMenuAction:this.btnUpBrowserAction;d.setHidden(!m);var k=this.gridCtxMenu.items;var f=k.get("gc_download");var g=k.get("gc_download_menu");var p=k.get("gc_extract_menu");var b=k.get("gc_cut");var o=k.get("gc_copy");var e=k.get("gc_delete");var n=k.get("gc_rename");var c=k.get("gc_property");var q=k.get("gc_openwin");var j=k.get("gc_share");var i=k.get("gc_compress_adv");var l=k.get("gc_compress");var h=k.get("gc_mount_iso");var a=k.get("gc_umount");if(m){f.enable();g.enable();p.enable();b.enable();o.enable();e.enable();n.enable();c.enable();q.enable();if(j){j.enable()}i.enable();l.enable();if(h){h.show()}if(a){a.show()}}else{f.disable();g.disable();p.disable();b.disable();o.disable();e.disable();n.disable();c.disable();q.disable();if(j){j.disable()}i.disable();l.disable();if(h){h.hide()}if(a){a.hide()}}k.get("mvcpto").setDisabled(!m);k.get("gc_paste_ovwr").setVisible(false);k.get("gc_paste_skip").setVisible(false);k.get("gc_fav_menu").setVisible(m);k.get("gc_dsmshortcut").setVisible(m);k.get("gc_sep_fav").setVisible(m)},onCommonShowHideActionBtn:function(a){this.toolbarMenu.get("sep_extract").setVisible(a);this.setShowHide(this.btnExtractMenu,a);this.btnCompressAdv.setVisible(a);this.btnCompress.setVisible(a);this.toolbarMenu.get("sep_archive").setVisible(a)},onCommonShowHideContextBtn:function(a){var b=this.gridCtxMenu.items;this.setShowHide(b.get("gc_extract_menu"),a);b.get("gc_compress_adv").setVisible(a);b.get("gc_compress").setVisible(a);b.get("gc_sep_archive").setVisible(a)},onLocalShowHideActionBtn:function(a){this.onCommonShowHideActionBtn(a);if(1===AppletProgram.blJavaPermission){this.btnDownloadMenu.setVisible(a);this.btnDownload.hide()}else{this.btnDownload.setVisible(a);this.btnDownloadMenu.hide()}this.btnCompressAdv.setVisible(a);this.btnCompress.setVisible(a);this.setShowHide(this.btnShare,a)},onLocalShowHideContextBtn:function(a){this.onCommonShowHideContextBtn(a);var b=this.gridCtxMenu.items;if(1===AppletProgram.blJavaPermission){b.get("gc_download_menu").setVisible(a);b.get("gc_download").hide()}else{b.get("gc_download").setVisible(a);b.get("gc_download_menu").hide()}b.get("gc_compress_adv").setVisible(a);b.get("gc_compress").setVisible(a);if(b.get("gc_share")){this.setShowHide(b.get("gc_share"),a)}},onSearchShowHideActionBtn:function(a){this.onCommonShowHideActionBtn(a)},onSearchShowHideContextBtn:function(a){this.onCommonShowHideContextBtn(a);var b=this.gridCtxMenu.items;b.get("gc_open").setVisible(!a)},onHideSharingBtns:function(){if(this.gridCtxMenu.items.get("gc_share")){this.gridCtxMenu.remove("gc_share")}if(this.btnShare){this.btnShare.hide()}if(this.btnSharingManager){this.btnSharingManager.hide()}},onAddShortCut:function(){var b;var c=this.activeView.getSelectionModel();b=c.getSelections();if(0===b.length){return}var a=this.onGetShortCutRecs(b);SYNO.SDS.Desktop.addLaunchItems(a)},getDeskShortIcon:function(c){var b=SYNO.SDS.UserSettings.getProperty("Desktop","desktopStyle"),d=(b==="classical"),a=d?48:64;if(c.get("isdir")&&c.get("icon")!=="isomountpoint.png"&&c.get("icon")!=="remotefailmountpoint.png"&&c.get("icon")!=="remotemountpoint.png"){return String.format("webfm/images/files_ext_{0}/"+c.get("icon"),a)}else{if(c.get("isdir")){return String.format("webfm/images/files_ext_{0}/folder.png",a)}}return String.format("webfm/images/files_ext_{0}/"+c.get("icon"),a)},onGetShortCutRecs:function(c){var b=[],a,d;c.each(function(e){a=e.get("filename");d={isdir:e.get("isdir"),type:e.get("type").toLowerCase(),file_id:e.get("file_id"),filename:a};Ext.apply(d,(!e.get("isdir"))?{openfile:e.get("file_id")}:{opendir:e.get("file_id")});a=Ext.util.Format.htmlEncode(a);b.push({config:{className:"SYNO.SDS.App.FileStation3.Instance",title:a,desc:Ext.util.Format.htmlEncode(e.get("file_id")),icon:this.getDeskShortIcon(e),param:d,removable:true},pos:-1,skipRegister:false})},this);return b},onCheckSnapshotAction:function(d,a){var c,e=["rename","move","delete"],b=false;for(c=0;c<e.length;c++){if(d===e[c]){b=true;break}}if(b===false){return false}for(c=0;c<a.length;c++){if(a[c].get("is_snapshot")===true){return true}}return false},onCheckVFSAction:function(e,a,l,c,b){var i=this;var j={},f={};function h(n){var o,m;if(!SYNO.webfm.VFS.isVFSPath(n)){return null}o=SYNO.webfm.VFS.getBaseURI(n);m=i.dirTree.getNodeById(SYNO.webfm.utils.source.remote+o);if(m&&m.attributes&&m.attributes.api){return m.attributes.api}else{return null}}function d(n,m){if(!n||!n.blVFS||!n.api||!Ext.isArray(n.api)){return true}return -1!==n.api.indexOf(m)}function g(o,n){var m="";if(Ext.isFunction(o.get)){m=o.get("path")}else{if(o.attributes&&o.attributes.path){m=o.attributes.path}else{if(Ext.isString(o)){m=o}}}if(Ext.isEmpty(m)){return}if(Ext.isEmpty(n.api)){n.api=h(m)}if(SYNO.webfm.VFS.isVFSPath(m)){n.blVFS=true}if(SYNO.webfm.VFS.isRootFolder(m)){n.blServerRoot=true}if(SYNO.webfm.VFS.isGDriveRootPath(m)){n.blGDriveRoot=true}if(SYNO.webfm.VFS.isGDriveDefaultFolder(m)){n.blGDriveDefaultFolder=true}if(SYNO.webfm.VFS.isGDriveStarsPath(m)){n.blGDriveStarred=true}if(SYNO.webfm.VFS.isGDriveStarsFirstLevelPath(m)){n.blGDriveStarredFirstLevel=true}}function k(m,p,o){var n;Ext.apply(p,{api:Ext.isEmpty(o)?null:o,blVFS:false,blServerRoot:false,blGDriveRoot:false,blGDriveDefaultFolder:false,blGDriveStarred:false,blGDriveStarredFirstLevel:false});if(Ext.isEmpty(m)){return}if(!Ext.isArray(m)){g(m,p)}else{for(n=0;n<m.length;n++){g(m[n],p)}}}k(a,j,c);k(l,f,b);if(!j.blVFS&&!f.blVFS){return true}switch(e){case"create":if(j.blGDriveRoot||f.blGDriveRoot||j.blGDriveStarred||f.blGDriveStarred||!d(j,"SYNO.FileStation.CreateFolder")||!d(f,"SYNO.FileStation.CreateFolder")){return false}break;case"delete":if(j.blServerRoot||j.blGDriveDefaultFolder||f.blServerRoot||f.blGDriveDefaultFolder||!d(j,"SYNO.FileStation.Delete")||!d(f,"SYNO.FileStation.Delete")){return false}break;case"upload":if(j.blGDriveRoot||j.blGDriveStarred||f.blGDriveRoot||f.blGDriveStarred||!d(j,"SYNO.FileStation.Upload")||!d(f,"SYNO.FileStation.Upload")){return false}break;case"download":if(j.blServerRoot||f.blServerRoot||!d(j,"SYNO.FileStation.Download")||!d(f,"SYNO.FileStation.Download")){return false}break;case"copy":if(j.blServerRoot||f.blGDriveRoot||f.blGDriveStarred||!d(j,"SYNO.FileStation.CopyMove")||!d(f,"SYNO.FileStation.CopyMove")){return false}break;case"move":if(j.blServerRoot||j.blGDriveDefaultFolder||j.blGDriveStarredFirstLevel||f.blGDriveRoot||f.blGDriveStarred||!d(j,"SYNO.FileStation.CopyMove")||!d(f,"SYNO.FileStation.CopyMove")){return false}break;case"rename":if(j.blServerRoot||j.blGDriveDefaultFolder||j.blGDriveStarredFirstLevel||f.blServerRoot||f.blGDriveDefaultFolder||f.blGDriveStarredFirstLevel||!d(j,"SYNO.FileStation.Rename")||!d(f,"SYNO.FileStation.Rename")){return false}break;case"navigate":return true;case"extract":case"compress":case"mount":case"umount":return false;default:break}return true},onCheckAdminPrivilege:function(e,h,c,b){var j=false;var g=null;var f={};var i=false;var a,d;if(b){if(!this.currCTNode||!this.currCTNode.parentNode){return false}d=this.currCTNode.parentNode;if(!this.currCTNode.parentNode||this.currCTNode.parentNode.id==="fm_root"||this.currCTNode.parentNode.id==="fm_fav_root"||this.currCTNode.parentNode.id==="fm_vd_root"||this.currCTNode.parentNode.id==="fm_rf_root"){d=this.currCTNode}}else{a=this.dirTree.getSelectionModel();d=a.getSelectedNode()}if(!d){return true}if(d.parentNode.id!="fm_root"){f={folderRight:d.attributes.right,uid:d.attributes.uid,gid:d.attributes.gid};g=SYNO.webfm.utils.getShareRight(this.dirTree,d)}else{g=d.attributes.right;i=true}switch(e){case"move":case"rename":case"delete":case"create":case"upload":j=SYNO.webfm.utils.checkShareRight(g,SYNO.webfm.utils.RW);if(!j){return false}break;default:break}return true},onCheckPrivilege:function(h,o,c,b){var q=false;var k=null;var j={};var p=false;var d=[];var a,f,e;if(this.onCheckSnapshotAction(h,o)===true){return false}if("true"===_S("domainUser")){return true}if(this.getCurrentSource()===SYNO.webfm.utils.source.remotes||SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){return true}if(b){if(!this.currCTNode||!this.currCTNode.parentNode){return false}f=this.currCTNode.parentNode;if(!this.currCTNode.parentNode||this.currCTNode.parentNode.id==="fm_root"||this.currCTNode.parentNode.id==="fm_fav_root"||this.currCTNode.parentNode.id==="fm_vd_root"||this.currCTNode.parentNode.id==="fm_rf_root"){f=this.currCTNode}}else{a=this.dirTree.getSelectionModel();f=a.getSelectedNode()}if((f&&f.attributes&&f.attributes.path&&SYNO.webfm.VFS.isVFSPath(f.attributes.path))||((o&&o[0]&&SYNO.webfm.VFS.isVFSPath(o[0].get("path"))))){return true}if(true===_S("is_admin")){return this.onCheckAdminPrivilege(h,o,c,b)}if(!f){return true}if(f.parentNode.id!="fm_root"){j={folderRight:f.attributes.right,uid:f.attributes.uid,gid:f.attributes.gid};k=SYNO.webfm.utils.getShareRight(this.dirTree,f)}else{k=f.attributes.right;p=true}var n,m,g,l;switch(h){case"create":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(!p&&!b){m={right:j.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Create};if(!SYNO.webfm.utils.checkFileRight(m)){return false}}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.DestFolder.Create;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"mount":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.SrcFile.ISO;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){return false}}break;case"umount":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}break;case"delete":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.SrcFile.Delete;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"upload":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(!p){m={right:j.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Upload};if(!SYNO.webfm.utils.checkFileRight(m)){return false}}break;case"download":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RO|SYNO.webfm.utils.RW);if(!q){return false}if(this.checkFTPDownloadRight(f)){return false}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];m={right:g.get("fileprivilege"),needRight:g.get("isdir")?SYNO.webfm.utils.ReqPrivilege.SrcFolder.Download:SYNO.webfm.utils.ReqPrivilege.SrcFile.Download};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"navigate":if(o){m={right:o.get("fileprivilege"),needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Navigate};if(!SYNO.webfm.utils.checkFileRight(m)){return false}}break;case"extract":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RO|SYNO.webfm.utils.RW);if(!q){return false}if(!p&&(c!==0)){if(c==1){m={right:j.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Extract}}else{if(c==2){m={right:j.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.ExtractDir}}}if(!SYNO.webfm.utils.checkFileRight(m)){return false}}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];m={curUID:this.userId,curGID:this.userGroup,uid:g.get("uid"),gid:g.get("gid"),right:g.get("fileprivilege"),needRight:SYNO.webfm.utils.ReqPrivilege.SrcFile.Extract};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d);return false}}break;case"copy":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RO|SYNO.webfm.utils.RW);if(!q){return false}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.SrcFile.Copy;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"move":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.SrcFile.Move;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"rename":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RW);if(!q){return false}if(!p){n=SYNO.webfm.utils.ReqPrivilege.DestFolder.Move;if(o[0].get("isdir")===true){n=SYNO.webfm.utils.ReqPrivilege.DestFolder.MoveDir}m={right:j.folderRight,needRight:n};if(!SYNO.webfm.utils.checkFileRight(m)){return false}}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];n=SYNO.webfm.utils.ReqPrivilege.SrcFile.Move;m={right:g.get("fileprivilege"),needRight:n};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;case"compress":q=SYNO.webfm.utils.checkShareRight(k,SYNO.webfm.utils.RO|SYNO.webfm.utils.RW);if(!q){return false}if(!p){m={right:j.folderRight,needRight:SYNO.webfm.utils.ReqPrivilege.DestFolder.Compress};if(!SYNO.webfm.utils.checkFileRight(m)){return false}}if(o){d=[];for(l=0;l<o.length;l++){g=o[l];m={right:g.get("fileprivilege"),needRight:g.get("isdir")?SYNO.webfm.utils.ReqPrivilege.SrcFolder.Compress:SYNO.webfm.utils.ReqPrivilege.SrcFile.Compress};if(SYNO.webfm.utils.checkFileRight(m)){d.push(g)}}if(d.length!=o.length){if(!b){e=this.activeView.getSelectionModel();e.clearSelections();e.selectRecords(d)}return false}}break;default:break}return true},initUploader:function(){this.updateUploader()},updateUploader:function(){if(SYNO.FileStation.FlashUploader.blFlash||1===AppletProgram.blJavaPermission||(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload())){this.onShowUpSubMenu(true)}else{this.onShowUpSubMenu(false)}if(1===AppletProgram.blJavaPermission){this.onShowDownSubMenu(true)}else{this.onShowDownSubMenu(false)}this.updateUploaderDefer()},updateUploaderDefer:function(){if(this.isDestroyed){return}var b=this.getUploadInstance();if(b&&this.rendered){this.onShowDownSubMenu(false);var a=SYNO.FileStation.FlashUploader.blFlash,d=(1===AppletProgram.blJavaPermission),c=(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload());if(d){b.setJavaUploader();b.setMaxTaskNumber(this.maxUploadTask);this.onShowUpSubMenu(true);if(c){this.html5UploadMgr.onRemoveBtnClick(this.viewPanel);if(!Ext.isMac){this.html5UploadMgr.onAddJavaDropPanel(this.viewPanel,this)}}this.onShowDownSubMenu(true)}else{if(c){b.setHTML5Uploader();b.setMaxTaskNumber(this.maxUploadTask);this.onShowUpSubMenu(true);this.html5UploadMgr.onAddBtnClick(this.viewPanel)}else{if(a){b.setFlashUploader();b.setMaxTaskNumber(this.maxUploadTask);this.onShowUpSubMenu(true)}else{if(!SYNO.FileStation.FormUploader){SYNO.FileStation.FormUploader=new SYNO.FileStation.Action.FormUpload({params:{url:this.RELURL+"webUI/file_upload.cgi",monitorGrid:b}})}b.setFormUploader();b.setMaxTaskNumber(20);this.onShowUpSubMenu(false)}}}}else{this.updateUploaderDefer.createDelegate(this,[]).defer(80)}},isOwnerDestroyed:function(){return(!this.owner||this.owner.isDestroyed)?true:false},showMsg:function(b,a){if(this.isOwnerDestroyed()){SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",b,a)}else{this.owner.getMsgBox().alert(b,a)}},isExternalDevice:function(g){var a=false;var d;var b;var f=this.deviceObj.ExternalDeviceList;var e,c;if(!g||!f||-1!==g.indexOf("/",1)){return false}d=g.lastIndexOf("/");b=g.substring(d+1);for(e=0;e<f.length;e++){if(!f[e].partitions){continue}for(c=0;c<f[e].partitions.length;c++){if(f[e].partitions[c].share_name==b){this.deviceObj.dev_id=f[e].dev_id;this.deviceObj.dev_type=f[e].dev_type;a=true;break}}if(a){break}}if(!a){this.deviceObj.device_name=null;this.deviceObj.device_type=null}return a},updateRemoteMountIcon:function(){if(SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){return}var b=SYNO.webfm.utils.source,a,c;if(!this.isViewMasked()&&(this.getCurrentSource()===b.remoter||this.getCurrentSource()===b.remote)){a=this.dirTree;c=this.getCurrentDir();SYNO.webfm.utils.updateRemoteMountIconByNode(a.getNodeById(b.remote+c));SYNO.webfm.utils.updateRemoteMountIconByNode(a.getNodeById(b.remoter+c))}},getAbsoluteUrl:function(){if(this.absoluteUrl){return this.absoluteUrl}var b=document.createElement("a");b.href="./";this.absoluteUrl=b.href;b=null;return this.absoluteUrl},setGridDragToDesktop:function(){var c=0,a=this.grid.getEl().select("div.x-grid3-row"),b=a?a.elements:[],e=b.length,d=null;for(c=0;c<e;c++){d=Ext.fly(b[c]);d.set({draggable:true})}},setDataViewDragToDesktop:function(){var c=0,a=this.thumbnailView.getEl().select(this.thumbnailView.itemSelector),b=a?a.elements:[],e=b.length,d=null;for(c=0;c<e;c++){d=Ext.fly(b[c]);d.set({draggable:true})}},setDragToDesktop:function(){var a=Ext.isIE||Ext.isIEQuirks||Ext.isIE6||Ext.isIE7||Ext.isIE8||Ext.isIE9||Ext.isIE9m||Ext.isIE9p||Ext.isIE10||Ext.isIE10p||Ext.isIE10Touch||Ext.isIE11||Ext.isIE12;if(a){return}if(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enable_cross_browser_dd")){if(!this.isEnableDragToDesktop()){SYNO.SDS.DragToDesktop.init()}}else{if(this.isEnableDragToDesktop()){SYNO.SDS.DragToDesktop.destroy()}}if(!this.viewPanel.getEl().dragEnable){this.viewPanel.getEl().on("dragstart",this.onStartDrag,this);this.viewPanel.getEl().on("dragenter",this.onDragEnter,this);this.viewPanel.getEl().on("dragover",this.onDragOver,this);this.viewPanel.getEl().on("dragend",this.onEndDrag,this);this.viewPanel.getEl().on("drop",this.onDrop,this);this.viewPanel.getEl().dragEnable=true}this.setDataViewDragToDesktop();this.setGridDragToDesktop()},isEnableDragToDesktop:function(){return(Ext.isObject(SYNO.SDS.DragToDesktop)&&SYNO.SDS.DragToDesktop.isEnable())},onDragEnter:function(a){a.browserEvent.dataTransfer.dropEffect="copy";a.browserEvent.preventDefault()},onDragOver:function(a){a.browserEvent.dataTransfer.dropEffect="copy";a.browserEvent.preventDefault()},onStartDrag:function(c){var f=c.browserEvent,b=this.getDownloadURL(),a="{0}:{1}:{2}:{3}";if(!b){return}if(!this.tid){return}var d=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance");Ext.each(d,function(g){if(g.window&&g.window.panelObj&&g.window.panelObj.viewPanel){var e=g.window.panelObj;e.viewPanel.getEl().un("drop",e.onDrop,e)}});this.dragDropDownloadURL=b.url;SYNO.FileStation.dragIcon=document.createElement("img");SYNO.FileStation.dragIcon.src="/webman/modules/FileBrowser/webfm/images/files_ext/txt.png";if(typeof f.dataTransfer.setDragImage!=="undefined"){f.dataTransfer.setDragImage(SYNO.FileStation.dragIcon,-10,20)}f.effectAllowed="all";f.dataTransfer.setData("url",encodeURI(b.url));f.dataTransfer.setData("text",String.format(a,b.metaType,encodeURIComponent(b.filename),this.tid,encodeURIComponent(b.url)))},onDrop:function(h){h.browserEvent.preventDefault();if(SYNO.webfm.utils.isLocalSource(this.getCurrentSource())){return}var i=h.browserEvent.dataTransfer.getData("text"),l=h.browserEvent.dataTransfer.getData("url"),f,j="application/octet-stream",a="",c="";try{h.browserEvent.dataTransfer.clearData("url");h.browserEvent.dataTransfer.clearData("text")}catch(d){}if(!i){return}f=i.split(":");if(f.length<4){return}j=f[0];a=decodeURIComponent(f[1]);c=f[2];if(l){l=decodeURI(l)}else{l=decodeURIComponent(f[3])}l+="&tid="+c;if(l.substring(0,4)==="http"&&window.location.protocol==="https:"){this.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("upload","upload_error_cross_protocol"));return}var b=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enableautooverwrite")===true)?true:false;if(this.activeView&&this.activeView.getStore()){if(0<=this.activeView.getStore().findExact("filename",a)&&b===false){var k="";var g=new SYNO.FileStation.DropConfirmDialog({owner:this.owner},{cb:{fn:function(e,m){g.close();if(m.overwrite){this.onTransferFile(l,j,a,m.overwrite)}},scope:this,files:[a]},filenames:[a]},k);g.show();return}}this.onTransferFile(l,j,a,b)},onTransferFile:function(f,d,a,b){var e=this;e.total=1000000;e.loaded=0;e.curr=0;e.counter=0;var i=new XMLHttpRequest();var g=f.split("?");i.open("POST",g[0],true);if(Ext.isGecko||Ext.isGecko2||Ext.isGecko3){i.responseType="arraybuffer"}else{i.responseType="blob"}var c=function(l,j,k){if(!i){return}var m=_WFT("upload","upload_error_data");SYNO.Debug("call terminateXhr");setTimeout(function(){SYNO.Debug("call xhr.abort()");if(!i){return}i.onprogress=undefined;i.abort();if(Ext.isGecko||Ext.isGecko2||Ext.isGecko3){if(i.response){i.response=null}if(i.responseText){i.responseText=null}if(i.responseXML){i.responseXML=null}if(i.mozResponseArrayBuffer){i.mozResponseArrayBuffer=null}}i=null},1000);if(i.synoTerminate){return}i.synoTerminate=true;e.owner.getMsgBox().hide();if(l){return}if(j){m=_WFT("upload","upload_error_big_file")}else{if(k){m+="("+k+")"}}e.owner.getMsgBox().alert(m,m)};i.onprogress=function(j){try{if(j&&j.lengthComputable){if(Ext.isSafari&&j.total>1073741824){c(false,true);return}e.owner.getMsgBox().updateProgress(j.loaded/j.total)}else{if(e.curr>=0&&e.curr<0.4){e.loaded+=5000}else{if(e.curr>=0.4&&e.curr<0.7){e.loaded+=2000}else{if(e.curr>=0.7&&e.curr<0.8){e.loaded+=1000}else{if(e.curr>=0.8&&e.curr<0.9){e.loaded+=500}else{if(e.curr>=0.9&&e.curr<0.95){e.loaded+=100}else{if(e.curr>=0.95&&e.curr<0.97){e.loaded+=1}else{if(e.curr>=0.97){}}}}}}}e.curr=e.loaded/e.total;e.owner.getMsgBox().updateProgress(e.curr);SYNO.Debug("eb.lengthComputable is unknow");if(Ext.isSafari&&j.position&&j.position>1073741824){c(false,true)}return}}catch(k){c();SYNO.Debug("eb.lengthComputable is unknow");return}};i.onerror=function(j){c();SYNO.Debug("progress onerror");return};i.ontimeout=function(){c();SYNO.Debug("progress ontimeout");return};i.onload=function(o){var k=[];var l={},j={};if(i.readyState!=4||i.status!=200){SYNO.Debug("response error, state="+i.readyState+",status="+i.status);c(false,false,i.status);return}e.owner.getMsgBox().updateProgress(1);try{j.blob=new Blob([i.response],{type:d})}catch(m){SYNO.Debug("new blob error");c(false,true);return}setTimeout(c,1000,true,false);l.name=a;l.filename=a;l.params={};l.status="NOT_STARTED";l.file=j.blob;l.size=j.blob.size;k.push(l);e.blForceHtmlUpload=true;if(Ext.isGecko||Ext.isGecko2||Ext.isGecko3){e.html5UploadMgr.uploader.html5uploader.opts.chunkmode=true}var n=function(){SYNO.Debug("call synoOnAllComplete");e.html5UploadMgr.uploader.html5uploader.mun(e.html5UploadMgr.uploader.html5uploader,"onAllComplete",n);k=[];if(l&&l.file){l.file=null}l=null;if(j&&j.blob){j.blob=null}j=null};e.html5UploadMgr.uploader.html5uploader.mon(e.html5UploadMgr.uploader.html5uploader,"onAllComplete",n);e.html5UploadMgr.uploader.html5uploader.addFiles.call(e.html5UploadMgr.uploader.html5uploader,k,true,false,{overwrite:b},undefined,false,e.blForceHtmlUpload)};e.owner.getMsgBox().show({msg:_WFT("download","downloading"),width:300,progress:true,closable:false,buttons:Ext.MessageBox.CANCEL,fn:function h(){c(true)},scope:this});i.setRequestHeader("Content-type","application/x-www-form-urlencoded");i.send(g[1])},onEndDrag:function(c){var d=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance");Ext.each(d,function(f){if(f.window&&f.window.panelObj&&f.window.panelObj.viewPanel){var e=f.window.panelObj;e.viewPanel.getEl().un("drop",e.onDrop,e);e.viewPanel.getEl().on("drop",e.onDrop,e)}});var b=c.browserEvent.clientX;var a=c.browserEvent.clientY;if(!this.isEnableDragToDesktop()||Ext.isEmpty(this.dragDropDownloadURL)||((b>=0&&b<=window.outerWidth)&&(a>=0&&a<=window.outerHeight))){return}Ext.Ajax.request({url:this.dragDropDownloadURL,method:"GET",headers:{"X-TEST-URL":true},skipSynoToken:true,callback:function(f,g,e){if(414==e.status||413==e.status){this.showMsg(_T("download","download_failed"),_WFT("error","error_too_many_files"))}this.dragDropDownloadURL=null},scope:this})},getDownloadURL:function(){var g={api:"SYNO.FileStation.Download",version:1,method:"download",mode:"download"};var a="../webapi/FileStation/file_download.cgi";var d=[],f=[],b,c=[],e,h;if(Ext.isEmpty(d=this.onBeforeDownloadAction(false))){return null}for(b=0;b<d.length;b++){c.push(d[b].get("filename"));h=d[b].get("file_id");f.push(h)}e=this.getSuggestDLName(d);Ext.applyIf(g,{dlname:e,path:f.join(","),stdhtml:true});return{url:this.getAbsoluteUrl()+Ext.urlAppend((a+"/"+e),Ext.urlEncode(g)),metaType:"application/octet-stream",filename:e}}});Ext.ns("SYNO.FileStation");SYNO.FileStation.WindowPanel=function(a){this.initDefVal();Ext.apply(this,a||{});this.scanExternMenu();this.initButtons();this.initDS();this.toolbar=SYNO.FileStation.Comp.WinToolbar(this);var b={cls:"syno-webfm",items:this.initLayout()};this.initUploader();SYNO.FileStation.WindowPanel.superclass.constructor.call(this,b);this.mon(this.btnRefreshTree,"click",function(){var c=this.searchPanel;c.shareStore.reload();c.groupStore.reload();c.userStore.reload()},this);this.showJavaMsg();this.mon(SYNO.SDS.StatusNotifier,"sharefolderchanged",function(c){switch(c){case"create":case"move":case"delete":case"encchanged":case"permission":case"setacl":this.reloadTree();break;default:break}},this);this.mon(SYNO.SDS.StatusNotifier,"externaldeviceactivity",function(c){if(c==="ejectdevice"||c==="injectdevice"){this.reloadTree()}},this,{buffer:100});this.mon(SYNO.FileStation.Clipboard,"set",this.updateCutIcon,this);this.mon(SYNO.SDS.StatusNotifier,"servicechanged",this.scanExternMenu,this);this.mon(SYNO.SDS.StatusNotifier,"appprivilegechanged",this.scanExternMenu,this);this.mon(SYNO.SDS.StatusNotifier,"jsconfigLoaded",this.scanExternMenu,this)};Ext.extend(SYNO.FileStation.WindowPanel,SYNO.FileStation.MainPanel,{uploadGird:null,blShown:false,localuserpath:null,blJava:(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")===true)?AppletProgram.checkJava():((SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")!==false)&&(_S("gpo_enable_java")==="yes"))?AppletProgram.checkJava():false,getToolbar:function(){return this.toolbar},initJavaFunc:function(){SYNO.FileStation.instance=function(){return{getUploadInstance:function(){if(!this.uploadGird){if(_S("standalone")){var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance")[0];this.uploadGird=b.window.panelObj.monitorPanel.getUploadGrid()}else{var a=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0];this.uploadGird=a?a.getUploadGrid():null}}return this.uploadGird},getFileTaskInstance:function(){if(!this.localGird){if(_S("standalone")){var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance")[0];this.localGird=b.window.panelObj.monitorPanel.getLocalGrid()}else{var a=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0];this.localGird=a?a.getLocalGrid():null}}return this.localGird},getDownloadInstance:function(){if(!this.downloadGird){if(_S("standalone")){var b=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance")[0];this.downloadGird=b.window.panelObj.monitorPanel.getDownloadGrid()}else{var a=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0];this.downloadGird=a?a.getDownloadGrid():null}}return this.downloadGird}}}},updateLocalEnvDefer:function(){if(this.owner&&this.blShown===true){if(this.owner.isDestroyed){return}this.initJavaFunc();this.initLocalDS();this.updateUploader();this.dirTree.updateLocalRoot();this.dirLocalTree=this.dirTree}else{this.updateLocalEnvDefer.createDelegate(this).defer(100)}},initLayout:function(){var c=this.initNavArea();var b=this.initPanel({region:"center"});var d;if(_S("standalone")){var a=new SYNO.SDS.App.FileTaskMonitorTabPanel({jsConfig:this.appWindow.jsConfig,appInstance:this.appInstance},this);d=[c,b,a];this.monitorPanel=a}else{d=[c,b]}return d},initNavArea:function(){var a={RELURL:this.RELURL,webfm:this,plugins:[SYNO.FileStation.FocusPanelPluginInstance]};this.dirTree=new SYNO.FileStation.MixedTreePanel(a);var b=new Ext.Panel({region:"west",bodyStyle:"background-color: transparent;",split:true,width:200,minWidth:150,maxWidth:500,layout:"fit",items:[this.dirTree]});this.navLayout=b;SYNO.FileStation.WindowPanel.superclass.initNavArea.call(this,{});return b},pathButtonInfo:function(c,a,b){this.text=c;this.path=b;this.tooltip=a},updateCurrentPathLink:function(m){var p,a=false,c,o,b;if(m.substr(0,1)=="/"){p=m.substr(1).split("/")}else{var l=m.indexOf(":"),s;if(!l){return}s=m.substr(l+3);if(!s){p=[m]}else{p=s.split("/");p[0]=m.substr(0,l+3)+p[0];c=this.dirTree.getNodeById(SYNO.webfm.utils.source.remote+p[0]);if(c){o=c.attributes.real_path}}if(!o){o=p[0]}a=true}var h,e,d,g,q,f="",r=0;var n=[];if(p.length<=1){if(a){g=Ext.util.Format.htmlEncode(o)}else{g=Ext.util.Format.htmlEncode(m.substr(1))}if(SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())){n[0]=new this.pathButtonInfo(g,g,m)}else{if(m==="/"){n[0]=new this.pathButtonInfo("/","/",f)}else{n[0]=new this.pathButtonInfo("/","/","/");n[1]=new this.pathButtonInfo(g,g,m)}}}else{this.upDirPath="";if(this.getCurrentSource()==="localh"){this.localuserpath=this.localuserpath?this.localuserpath:AppletProgram.getUserPath({action:"getuserpath"},this);r=this.localuserpath.substr(1).split("/").length-1;h=r}else{h=0}for(d=0;h<p.length;h++,d++){if(a&&0===d){b=o}else{b=p[h]}g=Ext.util.Format.htmlEncode(b);q=g;if(p[h].length>50){f=p[h].substr(0,47)+"...";q=Ext.util.Format.htmlEncode(f)}f="";if(h!==(p.length-1)){for(e=0;h>0&&e<h;e++){if(!(e===0&&a)){f+="/"}f+=p[e]}if(!(h===0&&a)){f+="/"}f+=p[h]}n[d]=new this.pathButtonInfo(q,g,f)}if(!SYNO.webfm.utils.isRemoteSource(this.getCurrentSource())&&this.getCurrentSource()!=="localh"){n.splice(0,0,new this.pathButtonInfo("/","/","/"))}}this.pathBar.addPathButtons(n)},updateWinCurrentPathLink:function(f){if(f.substr(1,2)!=":\\"){return}var l,c,b,a,d,m,e="",n=0;var g=[];if(f.length==3){f=Ext.util.Format.htmlEncode(f);var h=f.substr(0,2);g[0]=new this.pathButtonInfo(h,h,e)}else{if(f.substr(f.length-1)=="\\"){l=f.substr(0,f.length-1).split("\\")}else{l=f.split("\\")}this.upDirPath="";if(this.getCurrentSource()==="localh"){this.localuserpath=this.localuserpath?this.localuserpath:AppletProgram.getUserPath({action:"getuserpath"},this);n=this.localuserpath.split("\\").length-1;c=n}else{c=0}for(a=0;c<l.length;c++,a++){d=Ext.util.Format.htmlEncode(l[c]);m=d;if(l[c].length>50){e=l[c].substr(0,47)+"...";m=Ext.util.Format.htmlEncode(e)}e="";if(c!==(l.length-1)){for(b=0;c>0&&b<c;b++){e+=l[b];e+="\\"}e+=l[c];if(c===0){e+="\\"}}g[a]=new this.pathButtonInfo(m,d,e)}}this.pathBar.addPathButtons(g)},callFileBrowsers:function(b,a){var c=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileStation3.Instance");Ext.each(c,function(e){var d=e.window.getPanelInstance();var f=Ext.getClassByName("SYNO.FileStation.WindowPanel.superclass."+b);f.apply(d,a)})},setHighlightEntry:function(){this.callFileBrowsers("setHighlightEntry",arguments)},refreshTreeNode:function(){this.callFileBrowsers("refreshTreeNode",arguments)},refreshVTreeNode:function(){this.callFileBrowsers("refreshVTreeNode",arguments)},refreshRTreeNode:function(){this.callFileBrowsers("refreshRTreeNode",arguments)},refreshVFSTreeNode:function(){this.callFileBrowsers("refreshVFSTreeNode",arguments)},refreshFavTreeNode:function(){this.callFileBrowsers("refreshFavTreeNode",arguments)},updateRemoteMountIcon:function(){this.callFileBrowsers("updateRemoteMountIcon",arguments)},getUploadInstance:function(){if(!this.uploadGird){if(_S("standalone")){this.uploadGird=this.monitorPanel.getUploadGrid()}else{var a=SYNO.SDS.AppMgr.getByAppName("SYNO.SDS.App.FileTaskMonitor.Instance")[0];this.uploadGird=a?a.getUploadGrid():null}}return this.uploadGird},getDownloadInstance:function(){return SYNO.FileStation.instance().getDownloadInstance()},onChangeDisplayTypeMenu:function(a){if(this.showContent!=a){this.displayType.menu.items.each(function(b){if(b.itemId===a){b.setIconClass("syno-sds-fs-tbar-sel-display")}else{b.setIconClass(undefined)}})}},onChangeDisplayType:function(a){if(this.showContent!=a){this.onChangeDisplayTypeMenu(a);SYNO.FileStation.WindowPanel.superclass.onChangeDisplayType.call(this,a)}},scanExternMenu:function(){var a,c,b;this.externFileMenu=[];this.externDirMenu=[];this.externCodeMenu=[];this.externCodeIcon=[];this.externExtMenu={};for(a in SYNO.SDS.Config.FnMap){if(SYNO.SDS.Config.FnMap.hasOwnProperty(a)){c=SYNO.SDS.Config.FnMap[a];if((!Ext.isArray(c.config.fb_extern))){continue}Ext.each(c.config.fb_extern,function(e){b={baseURL:c.config.jsBaseURL,className:a,data:e};if("SYNO.SDS.AudioStation.Application"===a&&"video_player:menu_play"===e.text){return}if("app"!==c.config.type&&!Ext.isString(e.launchFn)){return}if(true===e.dir){if(!this.externExtMenu.directory){this.externExtMenu.directory=[]}this.externExtMenu.directory.push(b)}if(true===e.file){this.externFileMenu.push(b)}else{if(Ext.isArray(e.file)){Ext.each(e.file,function(f){if(!this.externExtMenu[f]){this.externExtMenu[f]=[]}this.externExtMenu[f].push(b)},this)}else{if(Ext.isString(e.checkFn)){SYNO.SDS.JSLoad(e.checkFn);this.externCodeMenu.push(b)}else{if(Ext.isArray(e.items)){var d=false;Ext.each(e.items,function(f){if(Ext.isString(f.checkFn)){d=true;SYNO.SDS.JSLoad(f.checkFn)}});if(d){this.externCodeMenu.push(b)}}}}}if(Ext.isString(e.getIconFn)){SYNO.SDS.JSLoad(e.getIconFn);this.externCodeIcon.push(b)}if(Ext.isString(e.launchFn)){SYNO.SDS.JSLoad(e.launchFn)}},this)}}},onInsertExternMenu:function(k,a){var b=new Hash(),c=[];var h,f,d=function(i,m){g=false;Ext.each(i,function(n){if(n===m){g=true;return false}});return g};for(f=0;f<k.length;f++){h=k[f].get("type").toLowerCase();if(!b.get(h)){b.set(h,{type:(k[f].get("isdir")===true)?"directory":h,dir:k[f].get("isdir")})}}var l=0,j,e=false,g=false;b.each((function(i){var m=i.value.type;Ext.each(this.externExtMenu[m],function(q){if(k.length>1&&true!==q.data.multiple){return}if(d(c,q.data)){return}if(a&&!q.data.vfs){return}j=q.data.multiple?k.length:1;e=true;for(var n=0;n<j;n++){var p=false,t=false;if(m==="directory"&&q.data.dir===true){if(k[n].get("isdir")===true){p=true}}if(-1!==q.data.file.indexOf(k[n].get("type").toLowerCase())){t=true}e=t||p;if(!e){break}}if(e){c.push(q.data);try{var o;if(!Ext.isString(q.data.launchFn)){o=this.onClickExternMenu.createDelegate(this,[q,k])}else{var s=Ext.getClassByName(q.data.launchFn);o=s.createDelegate(this,[k])}this.onInsertExternMenuItem(l,q,k,o);l++}catch(r){SYNO.Debug("Fail to insert menu"+r)}}},this)}).createDelegate(this));Ext.each(this.externCodeMenu,function(o){if(a&&!o.data.vfs){return}if(k.length>1&&true!==o.data.multiple){return}try{var n,i,m=false;if(Ext.isString(o.data.checkFn)){i=Ext.getClassByName(o.data.checkFn);m=i(o,k)}else{if(Ext.isArray(o.data.items)){Ext.each(o.data.items,function(r){if(Ext.isString(r.checkFn)){i=Ext.getClassByName(r.checkFn);if((m=i(o,k))){return false}}})}}if(!m){return}if(Ext.isString(o.data.launchFn)){var q=Ext.getClassByName(o.data.launchFn);n=q.createDelegate(this,[k])}else{n=this.onClickExternMenu.createDelegate(this,[o,k])}this.onInsertExternMenuItem(l,o,k,n);l++}catch(p){SYNO.Debug("Fail to insert menu"+p)}},this);if(l>0){this.gridCtxMenu.insert(l,new Ext.menu.Separator({}));this.toolbarMenu.insert(l,new Ext.menu.Separator({}))}},onInsertExternMenuItem:function(i,b,h,f){var j=b.data.iconCls,g=b.data.icon;if(Ext.isString(j)){g=null}else{if(Ext.isString(g)&&!j){j="legacy-webfm-icon";g=b.baseURL+"/"+g}}var e={ignoreParentClicks:true,iconCls:j,icon:g,text:this.localizeMsg(b.data.text,b.className)};if(Ext.isArray(b.data.items)){var d,c=[],a;Ext.each(b.data.items,function(k){d=undefined;if(Ext.isString(k.checkFn)){a=Ext.getClassByName(k.checkFn);if(!a(b,h,k.data)){return}}if(Ext.isString(k.launchFn)){var l=Ext.getClassByName(k.launchFn);d=l.createDelegate(this,[h,k.data])}c.push({icon:k.icon||g,iconCls:k.iconCls||j,text:this.localizeMsg(k.text,b.className),handler:d||f,useBuffer:false})},this);Ext.apply(e,{menu:new SYNO.ux.Menu({useBuffer:false,cls:"syno-webfm",items:c})})}else{Ext.apply(e,{handler:f,useBuffer:false})}this.gridCtxMenu.insert(i,e);this.toolbarMenu.insert(i,e)},localizeMsg:function(c,b){var a=c.split(":");if(a.length<2){return c}a[1]=SYNO.SDS.Utils.GetLocalizedString(a[0]+":"+a[1],b);a.shift();return String.format.apply(String,a)},onRemoveExternMenu:function(b){var a;while("gc_extern_last"!==(a=b.get(0)).getItemId()){b.remove(a,true)}},onUpdateExternMenu:function(a,b){this.onRemoveExternMenu(this.gridCtxMenu);this.onRemoveExternMenu(this.toolbarMenu);if(a){this.onInsertExternMenu(a,b)}},onClickExternMenu:function(a,b){SYNO.SDS.AppLaunch(a.className,{fb_recs:b,fb_param:a.data.param||{}})},onExternDbClick:function(d){if(d.get("isdir")===true){return false}var b=d.get("type").toLowerCase();var a=false,c=SYNO.webfm.VFS.isVFSPath(d.get("path"));Ext.each(this.externExtMenu[b],function(e){if(c&&!e.data.vfs){return}if(e.data.dbclick===true){this.onClickExternMenu(e,[d]);a=true;return false}},this);if(a){return true}Ext.each(this.externCodeMenu,function(g){try{if((c&&!g.data.vfs)||g.data.dbclick!==true){return}var f,e;e=Ext.getClassByName(g.data.checkFn);if(!Ext.isString(g.data.launchFn)){f=this.onClickExternMenu.createDelegate(this,[g,[d]])}else{var i=Ext.getClassByName(g.data.launchFn);f=i.createDelegate(this,[[d]])}if(e(g,[d])){f();a=true;return false}}catch(h){SYNO.Debug("Fail to click "+h)}},this);return a},showJavaMsg:function(a){var e;var k=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")===true)||((SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","enablejava")!==false)&&(_S("gpo_enable_java")==="yes"));var l=(this.appInstance.getUserSettings("blShowNorMsg")===true)?true:false,j="";if(a&&!Ext.isEmpty(Ext.util.Cookies.get("not_show_java_version"))){var c=deployJava.getJREs();if(!Ext.isEmpty(c)){j=c[0];if(Ext.util.Cookies.get("not_show_java_version")===j){a=false}}}if(a||(!(Ext.isOpera||(Ext.isSafari&&Ext.isWindows)||l)&&!this.blJava&&k)){var g=Ext.id();var b=Ext.id();e=_WFT("java","java_installation").replace("{@}",'<a href="'+deployJava.getJavaURL+'" target="_blank">Java</a>');e+="<br><a id = '"+b+'\' class="pathlink"">';e+="<br><span>";e+=_WFT("java","java_help");e+="</span></a><br>";e+="<input type='checkbox' id='"+g+"' autocomplete='off' class=' x-form-checkbox x-form-field'>";e+="<label class='x-form-cb-label' style='top: -2px;'>"+_WFT("java","java_not_remind")+"</label>";var h=SYNO.SDS.SystemTray.notifyMsg("SYNO.SDS.App.FileStation3.Instance",_T("tree","leaf_filebrowser"),e,0);var m=Ext.get(b);var i=function(){this.owner.onClickHelp()};m.on("click",i,this);var d=Ext.get(g);var f=function(){if(!a){this.appInstance.setUserSettings("blShowNorMsg",d.dom.checked)}else{Ext.util.Cookies.set("not_show_java_version",(d.dom.checked?j:""))}};d.on("click",f,this);h.mon(h,"destory",function(){m.un("click",i,this);d.un("click",f,this)},this)}},onGoToFolder:function(a){var c=this.dirTree.getSelectionModel();var b=c.getSelectedNode();if(!b){this.mon(this.remoteDS,"load",function(){this.onGoToPathWithDir(a)},this,{single:true})}else{this.onGoToPathWithDir(a)}},onGoToFile:function(a){var c=this.dirTree.getSelectionModel();var b=c.getSelectedNode();if(!b){this.mon(this.remoteDS,"load",function(){this.onGoToPathWithFile(a)},this,{single:true})}else{this.onGoToPathWithFile(a)}},onCreateShareFolder:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",{fn:"SYNO.SDS.AdminCenter.Share.Main",dlg:"create"})},updateCutIcon:function(c,d){var b=SYNO.FileStation.Clipboard.get();if(!b||b.action!=="move"){return}var a=b.params.source;var h=this.grid.getStore(),e,f;var g=b.recs;var i=this.dirTree;Ext.each(g,function(m){e=h.indexOfId(m.get("file_id"));f=this.thumbnailView.getNode(e);if(e>=0){this.grid.getView().addRowClass(e,"syno-sds-fs-file-cut");if(f){Ext.fly(f).addClass("syno-sds-fs-file-cut")}var l=function(){e=h.indexOfId(m.get("file_id"));f=this.thumbnailView.getNode(e);if(e>=0){this.grid.getView().removeRowClass(e,"syno-sds-fs-file-cut");if(f){Ext.fly(f).removeClass("syno-sds-fs-file-cut")}}this.mun(SYNO.FileStation.Clipboard,"beforeset",l,this);this.mun(SYNO.FileStation.Clipboard,"clean",l,this)};this.mon(SYNO.FileStation.Clipboard,"beforeset",l,this,{single:true});this.mon(SYNO.FileStation.Clipboard,"clean",l,this,{single:true})}if(!m.get("isdir")){return}var j=i.getNodeById(a+m.get("file_id"));if(j&&j.ui){j.ui.addClass("syno-sds-fs-file-cut");var k=function(){j=i.getNodeById(a+m.get("file_id"));if(j&&j.ui){j.ui.removeClass("syno-sds-fs-file-cut")}this.mun(SYNO.FileStation.Clipboard,"beforeset",k,this);this.mun(SYNO.FileStation.Clipboard,"clean",k,this)};this.mon(SYNO.FileStation.Clipboard,"beforeset",k,this,{single:true});this.mon(SYNO.FileStation.Clipboard,"clean",k,this,{single:true})}},this)}});Ext.ns("SYNO.FileStation");SYNO.FileStation.CopyMoveCtxMenu=Ext.extend(SYNO.ux.Menu,{constructor:function(a){Ext.apply(this,a||{});var b=new Ext.menu.Item({activeClass:"",style:"cursor:default;",itemId:"text",text:""});SYNO.FileStation.CopyMoveCtxMenu.superclass.constructor.call(this,Ext.apply(a,{cls:"syno-webfm",items:[b,{itemId:"copy_overwrite",iconCls:"webfm-copy-icon",text:_WFT("filetable","filetable_copy")+" - "+_WFT("filetable","filetable_overwrite"),handler:this.onMVCPItemClick,scope:this},{itemId:"copy_skip",iconCls:"webfm-copy-icon",text:_WFT("filetable","filetable_copy")+" - "+_WFT("filetable","filetable_skip"),handler:this.onMVCPItemClick,scope:this},{itemId:"move_overwrite",iconCls:"webfm-copymove-to-icon",text:_WFT("filetable","filetable_move")+" - "+_WFT("filetable","filetable_overwrite"),handler:this.onMVCPItemClick,scope:this},{itemId:"move_skip",iconCls:"webfm-copymove-to-icon",text:_WFT("filetable","filetable_move")+" - "+_WFT("filetable","filetable_skip"),handler:this.onMVCPItemClick,scope:this},"-",{itemId:"cancel",iconCls:"webfm-cancel-icon",text:_WFT("common","cancel"),handler:this.hide,scope:this}]}))},onMVCPItemClick:function(p,j){var k="copy";var h=false;var f=p.itemId;var i=this.webfm;switch(f){case"copy_overwrite":case"copy_skip":k="copy";if(f=="copy_overwrite"){h=true}break;case"move_overwrite":case"move_skip":k="move";if(f=="move_overwrite"){h=true}break;default:return}if(this.action==="upload"){if(_S("demo_mode")){i.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return}i.FileAction.directlyUpload(i.ddParams.target,i.ddParams.src,h)}else{if(this.action==="download"){var o=[];var d=[];var c=i.ddParams.src;if(!Ext.isArray(c)){var g=i.ddParams.srcnode.attributes;var b=g.type;var m=SYNO.webfm.utils.isLocalSource(b);var r=(m&&Ext.isWindows)?"\\":"/";var q=g.path||"";var l=g.real_path;var a=SYNO.webfm.utils.getBaseName(q,r);o[0]=new Ext.data.Record({isdir:true,file_id:q,path:q,real_path:l,filename:a,size:0})}else{o=i.ddParams.src}o.each(function(e){d.push(e.data)});i.FileAction.onJavaDownload(k,i.ddParams.target,d,h)}else{var n;if(_S("demo_mode")){n=(k=="copy")?_WFT("filetable","filetable_copy"):_WFT("filetable","filetable_move");i.owner.getMsgBox().alert(n,_JSLIBSTR("uicommon","error_demo"));return}i.FileAction.onDDMVCP(i.ddParams.src,k,h,i.ddParams.target,i.ddParams)}}}});SYNO.FileStation.TreeCtxMenu=Ext.extend(SYNO.ux.Menu,{ignoreParentClicks:true,itemId:"rTreeCtx",constructor:function(a){Ext.apply(this,a||{});var b=new Ext.menu.Item({activeClass:"",style:"cursor:default;",itemId:"text",text:""});SYNO.FileStation.TreeCtxMenu.superclass.constructor.call(this,Ext.apply(a,{cls:"syno-webfm",items:[b,{itemId:"gc_cleanfav",iconCls:"webfm-clear-icon",text:_WFT("favorite","clean_favorite"),hidden:true,handler:this.onTreeCTClick,scope:this},{itemId:"gc_renamefav",iconCls:"webfm-rename-icon",text:_WFT("favorite","rename_favorite"),hidden:true,handler:this.onTreeCTClick,scope:this},{itemId:"gc_delfav",iconCls:"webfm-fav-delete-icon",text:_WFT("favorite","del_favorite"),hidden:true,handler:this.onTreeCTClick,scope:this},new Ext.menu.Separator({itemId:"gc_sep_createfolder"}),{itemId:"gc_createfolder",iconCls:"webfm-createfolder-icon",text:_WFT("filetable","filetable_create_folder"),handler:this.onTreeCTClick,hidden:_S("demo_mode"),scope:this},new Ext.menu.Separator(),{itemId:"gc_umount",iconCls:"webfm-umount-eject-icon",text:_WFT("mount","umount"),handler:this.onTreeCTClick,scope:this,hidden:true},{itemId:"gc_eject",iconCls:"webfm-umount-eject-icon",text:_T("usb","usb_eject"),handler:this.onTreeCTClick,scope:this,hidden:true},{itemId:"gc_disconnect_vfs",iconCls:"webfm-umount-eject-icon",text:_WFT("vfs","disconnect"),handler:this.onTreeCTClick,scope:this,hidden:true},{itemId:"gc_remove_vfs",iconCls:"webfm-delete-icon",text:_WFT("vfs","remove_profile"),handler:this.onTreeCTClick,scope:this,hidden:true},new Ext.menu.Separator({itemId:"gc_sep_upload"}),this.webfm.btnTreeUpSubMenuAction,this.webfm.btnTreeUpBrowserAction,{itemId:"gc_local_upload",iconCls:"webfm-upload-icon",text:_WFT("filetable","filetable_upload"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_download",iconCls:"webfm-download-icon",text:_WFT("filetable","filetable_download"),handler:this.onTreeCTClick,scope:this},this.webfm.btnTreeDownSubMenuAction,new Ext.menu.Separator({itemId:"gc_sep_cutcopy"}),this.webfm.btnTreeMVCPToSubMenuAction,{itemId:"gc_cut",iconCls:"webfm-cut-icon",text:_WFT("filetable","filetable_cut"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_copy",iconCls:"webfm-copy-icon",text:_WFT("filetable","filetable_copy"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_paste_ovwr",iconCls:"webfm-paste-icon",text:_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_overwrite"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_paste_skip",iconCls:"webfm-paste-icon",text:_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_skip"),handler:this.onTreeCTClick,scope:this},new Ext.menu.Separator({itemId:"gc_sep_del"}),{itemId:"gc_delete",iconCls:"webfm-delete-icon",text:_WFT("filetable","filetable_delete"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_rename",iconCls:"webfm-rename-icon",text:_WFT("filetable","filetable_rename"),handler:this.onTreeCTClick,scope:this},new Ext.menu.Separator({itemId:"gc_sep_property"}),{itemId:"gc_snapshot_history",iconCls:"webfm-snapshot-icon",text:_T("disk_info","disk_view_history"),handler:this.onTreeCTClick,scope:this},{itemId:"gc_property",iconCls:"webfm-property-icon",text:_WFT("filetable","filetable_properties"),handler:this.onTreeCTClick,scope:this}]}));if("yes"!==_D("supportmount")){this.remove("gc_umount")}},onTreeCTClick:function(v,u){var h=this.webfm;var q=v.itemId;var b=[];if(!h.currCTNodeTmp){return}h.currCTNode=h.currCTNodeTmp;h.currCTAction=q;var r=h.currCTNode.attributes;var p=h.currCTNode.attributes.type;var t=SYNO.webfm.utils.isLocalSource(p);var n=(t&&Ext.isWindows)?"\\":"/";var o=h.currCTNode.attributes.path||"";var x=h.currCTNode.attributes.real_path;var k=h.currCTNode.attributes.text;var s=SYNO.webfm.utils.getBaseName(o,n);var g=h.currCTNode.attributes.uid;var m=h.currCTNode.attributes.gid;var w=h.currCTNode.attributes.right;var l=h.currCTNode.attributes.ftpright;var a=o.substr(0,o.lastIndexOf(n));var i=h.currCTNode.attributes.isMountPoint;var f=h.currCTNode.attributes.mountType;switch(q){case"gc_createfolder":b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x});if(!t&&!h.onCheckVFSAction("create",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","not_support"));return}if(!t&&!h.onCheckPrivilege("create",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.Create(o,p);break;case"gc_disconnect_vfs":if(!SYNO.webfm.VFS.isRootFolder(o)){return}h.FileAction.DisconnectProtocol(r.path);break;case"gc_remove_vfs":if(!SYNO.webfm.VFS.isRootFolder(o)){return}h.FileAction.RemoveProtocol(r.path);break;case"gc_umount":if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("mount","umount"),_JSLIBSTR("uicommon","error_demo"));return}b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x,isMountPoint:i,mountType:f});if(!h.onCheckVFSAction("umount",b)){h.owner.getMsgBox().alert(_WFT("mount","umount"),_WFT("error","not_support"));return}if(!h.onCheckPrivilege("umount",b,false,true)){h.owner.getMsgBox().alert(_WFT("mount","umount"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.Umount(b,[a]);break;case"gc_eject":b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,file_id:o,path:o,real_path:x});h.FileAction.Eject(b);break;case"gc_snapshot_history":b[0]=new Ext.data.Record({path:o});h.FileAction.ViewSnapshotHistory(b[0],this.webfm.owner);break;case"gc_download":var d=[];var j=s+".zip";d[0]=s;b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w});if(!h.onCheckVFSAction("download",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","not_support"));return}if(!h.onCheckPrivilege("download",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.Download([o],j);break;case"gc_copy":if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("filetable","filetable_copy"),_JSLIBSTR("uicommon","error_demo"));return}b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x,filename:s,size:0});if(!t&&!h.onCheckVFSAction("copy",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_copy"),_WFT("error","not_support"));return}if(!t&&!h.onCheckPrivilege("copy",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_copy"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.MVCP(b,"copy",h.userId,h.userGroup,p);break;case"gc_cut":if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("filetable","filetable_cut"),_JSLIBSTR("uicommon","error_demo"));return}b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x,filename:s,size:0});if(!t&&!h.onCheckVFSAction("move",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_cut"),_WFT("error","not_support"));return}if(!t&&!h.onCheckPrivilege("move",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_cut"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.MVCP(b,"move",h.userId,h.userGroup,p);break;case"gc_paste_ovwr":case"gc_paste_skip":if(_S("demo_mode")){h.owner.getMsgBox().alert(_WFT("filetable","filetable_paste"),_JSLIBSTR("uicommon","error_demo"));return}b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,right:w,ftpright:l,file_id:o,path:o,real_path:x});h.FileAction.Paste(b[0],q==="gc_paste_ovwr",p);break;case"gc_delete":if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_JSLIBSTR("uicommon","error_demo"));return}b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x});var c=_WFT("filetable","filetable_delete_confirm");if(t){c=_WFT("filetable","filetable_local_delete_confirm")}if(!t&&!h.onCheckVFSAction("delete",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_WFT("error","not_support"));return}if(!t&&!h.onCheckPrivilege("delete",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_delete"),_WFT("error","error_privilege_not_enough"));return}h.owner.getMsgBox().confirmDelete(_WFT("filetable","filetable_delete"),c,function(e){if("yes"==e){h.FileAction.Delete(b,[a],p)}},h);break;case"gc_rename":b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x,filename:s});if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_JSLIBSTR("uicommon","error_demo"));return}if(!t&&!h.onCheckVFSAction("rename",b)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","not_support"));return}if(!t&&!h.onCheckPrivilege("rename",b,false,true)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_rename"),_WFT("error","error_privilege_not_enough"));return}h.FileAction.Rename(b,a,p);break;case"gc_renamefav":h.FileAction.RenameFav(o,k);break;case"gc_delfav":h.FileAction.DelFav(o,k);break;case"gc_cleanfav":h.FileAction.CleanFav();break;case"gc_local_upload":b[0]=new Ext.data.Record({uid:g,gid:m,isdir:true,fileprivilege:w,file_id:o,path:o,real_path:x,filename:s});h.FileAction.localUpload(b,h.userId,h.userGroup);break;case"gc_property":b[0]=new Ext.data.Record({uid:g,gid:m,owner:h.currCTNode.attributes.owner,group:h.currCTNode.attributes.group,privilege:h.currCTNode.attributes.privilege,mt:h.currCTNode.attributes.mt,fileprivilege:w,isdir:true,isshare:SYNO.webfm.utils.isShareByPath(o),file_id:o,path:o,real_path:x,filename:s,filesize:0,is_sync_share:r.is_sync_share,name:r.name,readonly:r.readonly,is_disable_list:r.is_disable_list,is_disable_modify:r.is_disable_modify,is_disable_download:r.is_disable_download,is_snapshot:r.is_snapshot,is_btrfs_subvol:r.is_btrfs_subvol,has_snapshot:r.has_snapshot});h.FileAction.Property(b,h.userId,p);break;default:break}}});SYNO.FileStation.GridCtxMenu=Ext.extend(SYNO.ux.Menu,{ignoreParentClicks:true,itemId:"rGridCtx",constructor:function(b){Ext.apply(this,b||{});var c=this.webfm;var a=SYNO.FileStation.Comp;SYNO.FileStation.GridCtxMenu.superclass.constructor.call(this,Ext.apply(b,{cls:"syno-webfm",items:[{itemId:"gc_extern_last",hidden:true},{itemId:"gc_open",iconCls:"webfm-open-contain-folder-icon",text:_WFT("filetable","open_folder"),hidden:true,useBuffer:false,handler:c.onOpenContainingFolder,scope:c},c.btnUpSubMenuAction,c.btnUpBrowserAction,{itemId:"gc_download",iconCls:"webfm-download-icon",text:_WFT("filetable","filetable_download"),handler:c.onDownloadAction,useBuffer:false,scope:c},a.cDownloadMenu(Ext.menu.Item,true,c),new Ext.menu.Separator({itemId:"gc_sep_download"}),{itemId:"gc_openwin",iconCls:"webfm-open-newwin-icon",text:_WFT("filetable","filetable_openwin"),handler:c.onOpenWinAction,useBuffer:false,scope:c},new Ext.menu.Separator({itemId:"gc_sep_createfolder"}),{itemId:"gc_createfolder",iconCls:"webfm-createfolder-icon",text:_WFT("filetable","filetable_create_folder"),handler:c.onCreateFolder,hidden:_S("demo_mode"),scope:c},a.cSort(Ext.menu.Item,c,{iconCls:"webfm-sort-icon",itemId:"gc_sort",type_group:"gc_sort_type",dir_group:"gc_sort_dir"}),"-",{itemId:"gc_mount_iso",iconCls:"webfm-mount-iso-icon",text:_WFT("filetable","filetable_mount_iso"),handler:c.onMountISOClick,useBuffer:false,scope:c},{itemId:"gc_umount",iconCls:"webfm-umount-eject-icon",text:_WFT("mount","umount"),handler:c.onUmountClick,useBuffer:false,scope:c,hidden:true},a.cExtractMenuBtn(Ext.menu.Item,true,c),{itemId:"gc_compress_adv",iconCls:"webfm-compress-icon",text:_WFT("filetable","filetable_add_archive"),handler:c.onCompressAdvItemsClick,useBuffer:false,scope:c},{itemId:"gc_compress",iconCls:"webfm-compress-icon",text:_WFT("filetable","filetable_compress_to"),handler:c.onCompressItemsClick,useBuffer:false,scope:c},new Ext.menu.Separator({itemId:"gc_sep_archive"}),a.cMVCPToMenu(Ext.menu.Item,true,c),{itemId:"gc_cut",iconCls:"webfm-cut-icon",text:_WFT("filetable","filetable_cut"),handler:c.onCutAction,scope:c},{itemId:"gc_copy",iconCls:"webfm-copy-icon",text:_WFT("filetable","filetable_copy"),handler:c.onCopyAction,scope:c},{itemId:"gc_paste_ovwr",iconCls:"webfm-paste-icon",text:_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_overwrite"),handler:function(d){this.onPasteAction(d,true)},scope:c},{itemId:"gc_paste_skip",iconCls:"webfm-paste-icon",text:_WFT("filetable","filetable_paste")+" - "+_WFT("filetable","filetable_skip"),handler:function(d){this.onPasteAction(d,false)},scope:c},{itemId:"gc_delete",iconCls:"webfm-delete-icon",text:_WFT("filetable","filetable_delete"),handler:c.onDeleteAction,scope:c},{itemId:"gc_rename",iconCls:"webfm-rename-icon",text:_WFT("filetable","filetable_rename"),handler:c.onRenameAction,scope:c},"-",a.cAddFavMenuBtn(Ext.menu.Item,true,c),a.cDSMDeskShortcutBtn(Ext.menu.Item,true,c,_WFT("shortcut","make_to_dsm_dekstop")),new Ext.menu.Separator({itemId:"gc_sep_fav"}),a.cSnapshotHistory(Ext.menu.Item,c),{itemId:"gc_property",iconCls:"webfm-property-icon",text:_WFT("filetable","filetable_properties"),handler:c.onPropertyClick,scope:c},{itemId:"gc_share",iconCls:"webfm-share-link-icon",text:_WFT("common","share"),handler:c.onShareClick,scope:c}]}));if("yes"!==_D("supportmount")){this.remove("gc_mount_iso");this.remove("gc_umount")}},showAt:function(b,a){SYNO.webfm.utils.ShowHideMenu(this.items);SYNO.FileStation.GridCtxMenu.superclass.showAt.call(this,b,a)}});Ext.ns("SYNO.FileStation");SYNO.FileStation.BasicTreePanel=Ext.extend(SYNO.ux.TreePanel,{cls:"syno-sds-fs-tree",initEvents:function(){var a=this;this.dropZone=new SYNO.webfm.utils.TreeDropZone(this,this.dropConfig||{ddGroup:this.ddGroup||"SDSShortCut",appendOnly:this.ddAppendOnly===true});this.dragZone=new Ext.tree.TreeDragZone(this,this.dragConfig||{ddGroup:this.ddGroup||"SDSShortCut",scroll:this.ddScroll,onBeforeDrag:function(d,f){var b=a.webfm;var c=b.getRecByTreeNodeAttr(d.node.attributes);SYNO.webfm.SmartDDMVCPMgr.initDragData(b,c);return Ext.tree.TreeDragZone.prototype.onBeforeDrag.apply(this,arguments)},onDragOver:function(b,c){delete this.cachedTarget;Ext.tree.TreeDragZone.prototype.onDragOver.apply(this,arguments)},validateTarget:function(f,d,i){var h=d.getTarget("li.launch-icon");if(SYNO.SDS.Desktop.el.id===d.getTarget().id||(h&&Ext.fly(h).findParentNode(".sds-desktop-shortcut"))){var b=this.dragData;if(b&&b.node&&(SYNO.webfm.utils.isLocalSource(b.node.attributes.type)||SYNO.webfm.VFS.isVFSPath(b.node.attributes.path))){return false}return true}h=d.getTarget();var c,g;if((h&&(Ext.fly(h).is("div.syno-sds-fs-grid-scroller")||(g=Ext.fly(h).findParentNode("div.syno-sds-fs-grid-scroller"))||(g=Ext.fly(h).findParentNode("div.syno-sds-fs-tree",Number.MAX_VALUE))))){g=g||h;g=(Ext.fly(g).findParentNode("div.syno-sds-fs-win",Number.MAX_VALUE));c=SYNO.SDS.WindowMgr.get(g.id);if(c){c.toFront()}return true}g=g||h;if(g&&(g=(Ext.fly(g).findParentNode("div.syno-sds-fs-win",Number.MAX_VALUE)))){c=SYNO.SDS.WindowMgr.get(g.id);if(c){c.toFront()}}return false}});SYNO.FileStation.BasicTreePanel.superclass.initEvents.apply(this,arguments)},constructor:function(a){SYNO.FileStation.BasicTreePanel.superclass.constructor.call(this,Ext.apply(a,{useArrows:true,animate:false,border:false,enableDD:true}));if(Ext.isIE&&!Ext.isModernIE){this.mon(this,"beforeappend",function(b,c,d){delete d.attributes.qtip;return true})}},onNodeClick:function(a,b){if(!b){return}var c=false;if(this.webfm.getCurrentSource()!==b.attributes.type){this.webfm.switchSource(b.attributes.type);c=true}if(b.id){if(c||b.attributes.path!=this.webfm.getCurrentDir()){this.webfm.onChangeDir(b.attributes.path)}this.webfm.fireEvent("onNodeClick",b)}},nodeDragOver:function(u){var v=u.source;var d=v.getProxy().getGhost();var j=this.webfm;var h=u.target;var i=u.data.node;var o=u.data.grid||u.data.from;var c=i?i.attributes.type:(o?o.getStore().storetype:null);if(SYNO.webfm.SmartDDMVCPMgr.isEnable()){SYNO.webfm.SmartDDMVCPMgr.focus(j,u.data);SYNO.webfm.SmartDDMVCPMgr.disableUpateDDText(true);SYNO.webfm.SmartDDMVCPMgr.onDragOver(u.rawEvent)}if(!h||!c){return false}var b;if(u.point==="above"||u.point==="below"||(u.point==="append"&&(h.id==="fm_fav_root"))){if((h.id==="fm_fav_root")||(h.parentNode&&h.parentNode.id==="fm_fav_root")){if(i&&SYNO.webfm.VFS.isVFSPath(i.attributes.path)){return false}if(SYNO.webfm.utils.isLocalSource(c)){return false}if(o){b=o.getSelectionModel().getSelections();if(Ext.isEmpty(b)||1<b.length||!b[0].get("isdir")){d.update(_WFT("favorite","insert_invalid_favorite"));return false}else{if(SYNO.webfm.VFS.isVFSPath(b[0].get("path"))){return false}}}else{if(i&&(i.attributes.status==="broken"||(i.parentNode.id==="fm_fav_root"&&j!==i.ownerTree.webfm))){return false}}d.update(SYNO.webfm.utils.isFavSource(c)?_WFT("favorite","insert_favorite"):_WFT("favorite","add_favorite"));if(h.id==="fm_fav_root"&&SYNO.webfm.utils.isFavSource(c)){return false}return(h.id==="fm_fav_root")||(h.parentNode.id==="fm_fav_root")}return false}if((i&&(i.parentNode.id==="fm_fav_root"||i.attributes.status==="broken"))||(h&&h.attributes.status==="broken")){d.update(_WFT("favorite","insert_invalid_favorite"));return false}if(h){var f=h.attributes.type;if(!f){return false}if(f===SYNO.webfm.utils.source.remotev){d.update(_WFT("error","error_fs_ro"));return false}}var r=(u.target)?Ext.util.Format.ellipsis(u.target.text,36):"";var m=h?SYNO.webfm.utils.isLocalSource(h.attributes.type):false;var q=SYNO.webfm.utils.isLocalSource(c);var w=true,n;var g=!!h.attributes.is_snapshot;var k=false,t=false,p=h.attributes.path,l;if(p&&SYNO.webfm.VFS.isVFSPath(p)){k=true}if(o){b=o.getSelectionModel().getSelections();Ext.each(b,function(e){p=e.get("path");if(p&&SYNO.webfm.VFS.isVFSPath(p)){t=true;return false}})}else{if(i){p=i.attributes.path;if(p&&SYNO.webfm.VFS.isVFSPath(p)){t=true}}}if(!m&&q){if(!j.onCheckVFSAction("upload",h)||g){return false}n=String.format(_WFT("filetable","upload_ddtext"),r);l="upload"}else{if(m&&!q){if(o){b=o.getSelectionModel().getSelections();Ext.each(b,function(e){w=!j.checkFTPDownloadRightByPath(e.get("file_id"));return w})}else{if(i){if(j.checkFTPDownloadRight(i)){w=false}}}if(!j.onCheckVFSAction("download",b||i)){return false}n=w?String.format(_WFT("download","download_to"),r):_WFT("error","error_privilege_not_enough");l="download"}else{if((!SYNO.webfm.SmartDDMVCPMgr.isEnable()&&!j.onCheckVFSAction("copy",b||i,h)&&!j.onCheckVFSAction("move",i||b,h))||(SYNO.webfm.SmartDDMVCPMgr.isEnable()&&!j.onCheckVFSAction(SYNO.webfm.SmartDDMVCPMgr.getAction(),i||b,h))||g){return false}n=String.format(_WFT("filetable","mvcp_ddtext"),r);l="mvcp"}}var s=(SYNO.SDS.UserSettings.getProperty("SYNO.SDS.App.PersonalSettings.Instance","isfirstdd")===false)?false:true;if(SYNO.webfm.SmartDDMVCPMgr.isEnable()||s){var a=(k)?SYNO.webfm.utils.source.remotevfs:SYNO.webfm.SmartDDMVCPMgr.getSourceTypeByPath(this.webfm,h.attributes.path,h.attributes.type);SYNO.webfm.SmartDDMVCPMgr.setDragDropData(r,l,v.getProxy());SYNO.webfm.SmartDDMVCPMgr.disableUpateDDText(false);SYNO.webfm.SmartDDMVCPMgr.updateDefaultAction(a,t,k);if(!s){n=String.format(SYNO.webfm.SmartDDMVCPMgr.getDDText(),r)}}d.update(n);return w},getTargetAndSource:function(b){var c;if(b.data.node){if(b.target==b.data.node.parentNode){return null}c={src:b.data.node.attributes.path,target:b.target.attributes.path,srcsource:b.data.node.attributes.type,srcnode:b.data.node}}else{if(b.data.selections){var a=b.data.grid||b.data.from;c={src:b.data.selections,target:b.target.attributes.path,srcsource:(a&&a.getStore())?a.getStore().storetype:""};if(a&&a.getStore().storetype===SYNO.webfm.utils.source.remotes){Ext.apply(c,{search_taskid:a.getStore().search_taskid})}}else{c=null}}return c},beforeNodeDrop:function(u){u.cancel=true;var h=this.webfm;var t=u.rawEvent.getTarget();if(t&&(t=(Ext.fly(t).findParentNode("div.syno-sds-fs-win")))){if(t!==h.owner.el.dom){return false}}var d=u.target;var g=u.data.node;var l=u.data.grid||u.data.from;if(g&&(g.attributes.draggable===false)){return}var b=g?g.attributes.type:(l?l.getStore().storetype:null);var k=d?SYNO.webfm.utils.isLocalSource(d.attributes.type):false;var o=SYNO.webfm.utils.isLocalSource(b);var a=[],f=0,m;if(u.point==="above"||u.point==="below"||(u.point==="append"&&(d.id==="fm_fav_root"))){if(d.parentNode.id==="fm_fav_root"||(d.id==="fm_fav_root")){u.cancel=false;if(g||l){var x=u.target;m=x.attributes.path;x.parentNode.childNodes.each(function(e){if(e.attributes.path===m){return false}f++});if("below"===u.point){f++}}if(g){if(g.parentNode.id!=="fm_fav_root"){m=g.attributes.path;a[0]=new Ext.data.Record({isdir:true,file_id:m,filename:SYNO.webfm.utils.getBaseName(m)});h.FileAction.AddFav(a,{index:f})}}else{if(l){a=l.getSelectionModel().getSelections();h.FileAction.AddFav(a,{index:f})}}return}return}var y=_T("tree","leaf_filebrowser");if((h.ddParams=this.getTargetAndSource(u))===null){h.owner.getMsgBox().alert(y,_WFT("error","error_select_conflict"));return}u.cancel=false;var c=u.target.attributes.real_path;var n=k&&Ext.isWindows?"\\":"/";if(k===o){if(u.data.node){if(SYNO.webfm.utils.isConflictTargetPath(u.data.node.attributes.real_path,c,n)){h.owner.getMsgBox().alert(y,_WFT("error","error_select_conflict"));return}}else{if(u.data.grid||u.data.from){var p;for(var s=0;s<u.data.selections.length;s++){p=u.data.selections[s].get("real_path");if(SYNO.webfm.utils.isConflictTargetPath(p,c,n)){h.owner.getMsgBox().alert(y,_WFT("error","error_select_conflict"));return}}}}}var v=h.copymoveCtxMenu;var w=v.items;w.each(function(e){e.enable();e.show()});var r=(u.target)?"<b>["+Ext.util.Format.ellipsis(u.target.text,36)+"]</b>":"";var q,j;if(l){a=l.getSelectionModel().getSelections()}if(!k&&o){if(u.target){if(_S("demo_mode")===true){h.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_JSLIBSTR("uicommon","error_demo"));return}if(!h.checkUploadRight(u.target)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","error_privilege_not_enough"));return}if(!h.onCheckVFSAction("upload",d)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return}j=h.checkFtpModifyRight(u.target);if(j){w.get("copy_overwrite").disable()}w.get("move_skip").hide();w.get("move_overwrite").hide();w.get("text").setText(String.format("<b>"+_WFT("filetable","upload_ddtext")+"&nbsp</b>",r));q="upload"}}else{if(k&&!o){if(h.checkFTPDownloadRight(u.target)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_download"),_WFT("error","error_privilege_not_enough"));return}if(!h.onCheckVFSAction("download",g||a)){h.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return}j=h.checkFtpModifyRight(u.target);if(j||(this.isSrcReadOnly(u.data))){w.get("move_overwrite").disable();w.get("move_skip").disable()}w.get("text").setText(String.format("<b>"+_WFT("download","download_to")+"&nbsp</b>",r));q="download"}else{if((!SYNO.webfm.SmartDDMVCPMgr.isEnable()&&!h.onCheckVFSAction("move",g||a,d)&&!h.onCheckVFSAction("copy",g||a,d))||(SYNO.webfm.SmartDDMVCPMgr.isEnable()&&!h.onCheckVFSAction(SYNO.webfm.SmartDDMVCPMgr.getAction(),g||a,d))){h.owner.getMsgBox().alert(_WFT("filetable","filetable_upload"),_WFT("error","not_support"));return}if(this.isSrcReadOnly(u.data)){w.get("move_overwrite").disable();w.get("move_skip").disable()}w.get("text").setText(r);q="copymove"}}v.action=q;SYNO.webfm.SmartDDMVCPMgr.onAction(v,h,u.rawEvent)},isSrcReadOnly:function(b){var a=((b.node&&b.node.attributes&&((b.node.attributes.is_snapshot)||(b.node.attributes.type===SYNO.webfm.utils.source.remotev||b.node.attributes.isMountPoint)))||(b.grid&&SYNO.webfm.utils.doesIncludeMountPoint(b.grid.getSelectionModel().getSelections()))||(b.grid&&b.grid.owner&&SYNO.webfm.utils.source.remotev===b.grid.owner.getCurrentSource())||(b.datview&&SYNO.webfm.utils.doesIncludeMountPoint(b.datview.getSelectionModel().getSelections()))||(b.datview&&b.datview.owner&&SYNO.webfm.utils.source.remotev===b.datview.owner.getCurrentSource()));if(!a){if(b.grid||b.from){b.selections.each(function(d){var c=d.data.mountType;if(d.data.is_snapshot){a=true}if(c==="iso"||c==="remotefail"||c==="remote"){a=true;return false}},this)}}return a}});Ext.ns("SYNO.FileStation");SYNO.FileStation.MixedTreeLoader=Ext.extend(SYNO.API.TreeLoader,{timeout:SYNO.webfm.Cfg.timeout,clearOnLoad:true,processResponse:function(d,c,m,p){var q=d.responseText;try{var a=d.responseData||Ext.decode(q);var g;if(c.id==="fm_fav_root"){g=["data","favorites"]}else{if(c.id==="fm_root"){g=["data","shares"];this.parseVolumeName(a.data.shares)}else{if(c.parentNode.id==="fm_top_root"){g=["data","folders"]}else{g=["data","files"]}}}if(g){if(!Ext.isArray(g)){g=g.split(",")}for(var l in g){if(g.hasOwnProperty(l)){a=a[g[l]]}}}c.beginUpdate();for(var f=0,h=a.length;f<h;f++){var b=this.createNode(a[f],c);if(b){var k=c.appendChild(b);this.doNodeload(k)}}c.endUpdate();this.runCallback(m,p||c,[c])}catch(j){SYNO.Debug("exception: "+j+", response: "+d);this.handleFailure(d)}},doNodeload:function(d){if(d.attributes.children){if(d.childNodes.length<1){var c=d.attributes.children;d.beginUpdate();for(var b=0,a=c.length;b<a;b++){var e=d.appendChild(this.createNode(c[b],d));this.doNodeload(e)}d.endUpdate()}return true}return false},parseVolumeName:function(e){var c=0,b=0,a;for(c=0;c<e.length;c++){if(!e[c].additional){continue}a=e[c].additional.real_path;if(this.isUSBShareFolder(e[c])){e[c].additional.volume=e[c].name;var d=a.substr(0,a.indexOf("@sharebin")-1);for(b=0;b<e.length;b++){if(d===e[b].additional.real_path){e[c].additional.volume=e[b].name}}}else{e[c].additional.volume=a.substr(1,a.indexOf("/",1)-1)}}},isUSBShareFolder:function(a){return a.additional.real_path.match(/^\/volumeUSB/)!==null}});SYNO.FileStation.MixedTreeNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{recycleBinCls:"recycle",constructor:function(a){SYNO.FileStation.MixedTreeNodeUI.superclass.constructor.call(this,a)},initEvents:function(){this.node.on("move",this.onMove,this);if(this.node.disabled){this.onDisableChange(this.node,true)}if(this.node.hidden){this.hide()}var d=this.node.getOwnerTree();var a=d.enableDD||d.enableDrag||d.enableDrop;if(a&&(!this.node.isRoot||d.rootVisible)){var c=this.node.attributes;var f=c.path;var b=SYNO.webfm.utils.getBaseName(f);var h=!c.isMountPoint&&SYNO.webfm.utils.isRecycleBinFolder(c.path);var e="webfm/images/files_ext_64/"+(h?"recycle_bin.png":"folder.png");var g={isdir:true,file_id:c.path,opendir:c.path,filename:b};b=Ext.util.Format.htmlEncode(b);Ext.dd.Registry.register(this.elNode,{node:this.node,handles:this.getDDHandles(),isHandle:false,SDSShortCut:[{config:{className:"SYNO.SDS.App.FileStation3.Instance",title:b,desc:Ext.util.Format.htmlEncode(c.path),icon:e,param:g,removable:true},pos:-1,skipRegister:false}],_fromFile:true,ddText:_T("desktop","add_shortcut")});if(h){Ext.fly(this.getIconEl()).addClass(this.recycleBinCls)}}}});SYNO.FileStation.MixedTreePanel=Ext.extend(SYNO.FileStation.BasicTreePanel,{autoFlexcroll:false,checkNodeIsSelected:function(){var b=this.webfm.dirTree.getSelectionModel();if(Ext.isEmpty(b.getSelectedNode())){var a=this.webfm.dirTree.getNodeById("fm_root");if(a.childNodes&&0<a.childNodes.length){b.select(a.childNodes[0])}}},initRemoteLoader:function(){var a=this.webfm;var b=new SYNO.FileStation.MixedTreeLoader({api:"SYNO.FileStation.List",method:"list_share",version:1,dataroot:["data","shares"],baseParams:{filetype:"dir",sort_by:"name",additional:"real_path,owner,time,perm,mount_point_type,sync_share,volume_status"},listeners:{scope:this,beforeload:function(d,c){if(this.webfm.goto_path){d.baseParams.goto_path=this.webfm.goto_path;delete this.webfm.goto_path}else{delete d.baseParams.goto_path}this.bltreeloaded=false;(function(){if(!this.bltreeloadedmask&&!this.bltreeloaded&&this.webfm.owner&&!this.webfm.owner.el.isMasked()){this.bltreeloadedmask=true;this.webfm.owner.mask(0,_WFT("common","loading"),"x-mask-loading")}}).createDelegate(this).defer(1000);SYNO.webfm.utils.getRemoteTreeParams(d,c)},load:function(f,e,c){this.bltreeloaded=true;if(this.bltreeloadedmask){this.webfm.owner.unmask()}if(e.id==="fm_fav_root"){var d=e.ui;if(!d){return}if(!e.childNodes||0>=e.childNodes.length){d.hide();this.checkNodeIsSelected()}else{d.show()}}this.webfm.updateCutIcon()},loadexception:function(f,d,c){this.bltreeloaded=true;if(this.bltreeloadedmask){this.webfm.owner.unmask()}if(d.id==="fm_fav_root"){var e=this.webfm.dirTree.getNodeById("fm_fav_root");if(e&&e.ui){e.ui.hide();this.checkNodeIsSelected()}}}},createNode:function(d,f){SYNO.webfm.utils.parseRemoteTreeNode(d,f);var c,e=false;if(d.isMountPoint){if("iso"==d.mountType||"remote"==d.mountType||"remotefail"==d.mountType){e=true}}d.uiProvider=SYNO.FileStation.MixedTreeNodeUI;if(!e&&!Ext.isEmpty(a.externCodeIcon)&&SYNO.webfm.utils.isRemoteSource(d.type)){var g=a.getRecByTreeNodeAttr(d);if((c=a.getExternIcon(g[0]))){if(!Ext.isEmpty(c.url)){d.icon=c.url;d.cls="node_no_background"}d.iconCls=(d.iconCls||"")+(" "+c.css)}}return SYNO.FileStation.MixedTreeLoader.prototype.createNode.call(this,d)}});return b},initRemoteRoot:function(a){this.webfm.deviceObj={};var b=new Ext.tree.AsyncTreeNode({cls:"root_node",text:_S("hostname"),draggable:false,expanded:true,id:"fm_root",allowDrop:false,loader:a,listeners:{scope:this,expand:function(c){var d=this.webfm.dirTree.getSelectionModel();this.webfm.expandTreeToDir(c,c.childNodes,Ext.isEmpty(d.getSelectedNode()))},beforeload:function(){if(this.searchNode){this.blHideSearchNode=this.searchNode.hidden}this.initExtDeviceInfo()},load:function(c){if("fm_root"===c.id&&!this.getNodeById("fm_search_root")){b.appendChild(this.createSearchNode(this.blHideSearchNode))}}}});b.expand();this.treeroot=b;return b},initRemoteFolderRoot:function(b){var a=new SYNO.FileStation.MixedTreeLoader({api:"SYNO.FileStation.VirtualFolder",method:"list",version:1,dataroot:["data","folders"],baseParams:{filetype:"dir",type:"cifs",sort_by:"name",additional:"real_path,owner,time,perm,mount_point_type,volume_status"},listeners:{scope:this,beforeload:function(e,d){if(this.webfm.goto_path){e.baseParams.goto_path=this.webfm.goto_path;delete this.webfm.goto_path}else{delete e.baseParams.goto_path}SYNO.webfm.utils.getRemoteTreeParams(e,d)},load:function(f,e,d){if(!e.ui){return}if(!e.childNodes||0>=e.childNodes.length){e.ui.hide();this.checkNodeIsSelected()}else{e.ui.show()}this.updateScrollbar(this.getTreeEl().dom)},loadexception:function(f,e,d){if(e&&e.id==="fm_rf_root"&&e.ui){e.ui.hide();this.checkNodeIsSelected()}}},createNode:function(d,e){d.loader=b;SYNO.webfm.utils.parseRemoteTreeNode(d,e);return SYNO.FileStation.MixedTreeLoader.prototype.createNode.call(this,d)}});var c=new Ext.tree.AsyncTreeNode({cls:"root_node",text:_WFT("mount","remote_volume"),draggable:false,expanded:true,id:"fm_rf_root",allowDrop:false,hidden:true,loader:a});c.expand();return c},initVirtualDeviceRoot:function(a){var c=new SYNO.FileStation.MixedTreeLoader({api:"SYNO.FileStation.VirtualFolder",method:"list",version:1,dataroot:["data","folders"],baseParams:{type:"iso",sort_by:"name",additional:"real_path,owner,time,perm,mount_point_type,volume_status"},listeners:{scope:this,beforeload:function(e,d){if(this.webfm.goto_path){e.baseParams.goto_path=this.webfm.goto_path;delete this.webfm.goto_path}else{delete e.baseParams.goto_path}SYNO.webfm.utils.getRemoteTreeParams(e,d)},load:function(f,e,d){if(!e.ui){return}if(!e.childNodes||0>=e.childNodes.length){e.ui.hide();this.checkNodeIsSelected()}else{e.ui.show()}this.updateScrollbar(this.getTreeEl().dom)},loadexception:function(f,e,d){if(e&&e.id==="fm_rf_root"&&e.ui){e.ui.hide();this.checkNodeIsSelected()}}},createNode:function(d,e){d.loader=a;SYNO.webfm.utils.parseRemoteTreeNode(d,e);return SYNO.FileStation.MixedTreeLoader.prototype.createNode.call(this,d)}});var b=new Ext.tree.AsyncTreeNode({cls:"root_node",text:_WFT("mount","virtual_folder"),draggable:false,expanded:true,id:"fm_vd_root",allowDrop:false,hidden:true,loader:c});b.expand();return b},initFavoriteNode:function(a){var b=new Ext.tree.AsyncTreeNode({type:SYNO.webfm.utils.source.remotefav,cls:"root_node",text:_WFT("favorite","my_favorite"),draggable:false,expanded:true,id:"fm_fav_root",allowDrop:true,hidden:true,loader:a,listeners:{scope:this.webfm,load:function(c){if(c.id==="fm_fav_root"){this.updateFavBtn()}}}});b.expand();return b},initExtDeviceInfo:function(){if(!_S("is_admin")||(_S("demo_mode")===true)){return}this.sendWebAPI({api:"SYNO.Entry.Request",version:1,method:"request",params:{compound:[{api:"SYNO.Core.ExternalDevice.Storage.USB",version:1,method:"list",additional:["dev_type","product","status","partitions"]},{api:"SYNO.Core.ExternalDevice.Storage.eSATA",version:1,method:"list",additional:["dev_type","status","partitions"]}]},callback:this.loadData,scope:this})},createVFSRoot:function(a,d,b){var c=new SYNO.FileStation.MixedTreeLoader({api:"SYNO.FileStation.VirtualFolder",method:"list",version:1,dataroot:["data","folders"],baseParams:{type:d,sort_by:"name",additional:"real_path,owner,time,perm,mount_point_type"},listeners:{scope:this,beforeload:function(g,f){SYNO.webfm.utils.getRemoteTreeParams(g,f,d)},load:function(h,g,f){if(!g.ui){return}if(!g.childNodes||0>=g.childNodes.length){g.ui.hide();this.checkNodeIsSelected()}else{g.ui.show()}this.updateScrollbar(this.getTreeEl().dom)},loadexception:function(h,g,f){if(g&&g.parentNode&&g.parentNode.id==="fm_top_root"&&g.ui){g.ui.hide();this.checkNodeIsSelected()}}},createNode:function(f,g){var h=f.path;f.name=f.name+" ("+h.substring(h.indexOf("://")+3)+")";f.loader=a;SYNO.webfm.utils.parseRemoteTreeNode(f,g);return SYNO.FileStation.MixedTreeLoader.prototype.createNode.call(this,f)}});var e=new Ext.tree.AsyncTreeNode({cls:"root_node",text:b,draggable:false,expanded:true,id:d,allowDrop:false,hidden:true,loader:c});e.expand();return e},loadData:function(h,e,g,b){var a=e.result,f=[],c={data:{deviceList:[]}},d=c.data.deviceList;a.each(function(i){if(i.error&&i.error.code){f.push(SYNO.API.getErrorString(i.error.code))}else{d=d.concat(i.data.devices)}});if(f.length!==0){this.getMsgBox.alert(_T("common","error"),f.join("<br>"))}if(d.length!==0){this.webfm.deviceObj.ExternalDeviceList=d}},createSearchNode:function(b){var a=new Ext.tree.AsyncTreeNode({text:_WFT("search","search_results"),id:"fm_search_root",cls:"search_node",allowDrag:false,allowDrop:false,allowChildren:false,expandable:false,isTarget:false,hidden:b===false?false:true});a.attributes.type=SYNO.webfm.utils.source.remotes;a.attributes.path=SYNO.webfm.utils.source.remotes+"fm_search_root";this.searchNode=a;return a},updateLocalRoot:function(){var a=this.initLocalRoot();if(!this.isDestroyed){this.root.appendChild(a)}},initLocalRoot:function(){var a=new AppletTreeLoader({action:"getdirectories"},this.webfm);var b=new Ext.tree.AsyncTreeNode({cls:"root_node",text:Ext.isMac?_WFT("filetable","mac_local_computer"):_WFT("filetable","local_computer"),draggable:false,expanded:true,id:"fm_local_root",allowDrop:false,loader:a});if(Ext.isIE&&!Ext.isModernIE){this.mon(b,"beforeappend",function(c,d,e){delete e.attributes.qtip;return true})}b.expand();return b},constructor:function(c){Ext.apply(this,c||{});var b={ddGroup:"SDSShortCut",rootVisible:false,autoFlexcroll:true,updateScrollBarEventNames:["append","insert","remove","expandnode","collapsenode","resize"],selModel:new Ext.tree.DefaultSelectionModel({listeners:{selectionchange:{fn:this.onNodeClick,scope:this},beforeselect:{fn:function(f,d,e){if(d.id==="fm_root"||d.id==="fm_local_root"||d.id==="fm_vd_root"||d.id==="fm_rf_root"||d.id==="fm_fav_root"||(d.parentNode&&d.parentNode.id==="fm_top_root")){return false}return true},scope:this}}}),listeners:{contextmenu:{fn:function(x,G){if(x.id==="fm_search_root"){return}var A=false;var f=this.webfm.treeCtxMenu;var r=x.attributes&&x.attributes.isMountPoint&&("iso"===x.attributes.mountType||"remote"===x.attributes.mountType||"remotefail"===x.attributes.mountType);var u=f.items;this.webfm.currCTNode=null;this.webfm.currCTNodeTmp=null;G.cancel=true;if(x.id=="fm_root"||x.id=="fm_local_root"||x.id==="fm_vd_root"||x.id==="fm_rf_root"||!x.parentNode||x.parentNode.id=="fm_local_root"||(x.parentNode.id==="fm_top_root"&&x.id!=="fm_fav_root")){return}var I=false;var o=(_S("is_admin")&&this.webfm.isExternalDevice(x.attributes.path));var D=(x.parentNode&&x.parentNode.id==="fm_fav_root");var n=!!x.attributes.is_snapshot;var J=SYNO.webfm.utils.isSnapshotTopFolder(x.attributes.path,n);var E=!!x.attributes.has_snapshot&&!n;var v,w,t=[],j=false,g=false,p=true,s=true,K=true,z=true,d=true,y=true,k=true,l=true,C=true;if(x.id==="fm_fav_root"||(D&&x.attributes.status==="broken")){Ext.each(f.items.items,function(e){e.hide()});u.get("gc_cleanfav").show()}else{var F=SYNO.webfm.utils.isLocalSource(x.attributes.type,n);var m=x.attributes.type===SYNO.webfm.utils.source.remotev||x.attributes.mountType==="iso";var H=m||(x.parentNode&&x.parentNode.id==="fm_rf_root");v=x.attributes.path;if(v&&SYNO.webfm.VFS.isVFSPath(v)){j=true;g=SYNO.webfm.VFS.isRootFolder(v);w=SYNO.webfm.VFS.getBaseURI(v);var B=this.webfm.dirTree.getNodeById("remote"+w);if(B&&B.attributes.api){t=B.attributes.api}}Ext.each(f.items.items,function(e){e.show()});f.items.get("mvcpto").setOvwrVisible(F);u.get("gc_renamefav").setVisible(D);u.get("gc_delfav").setVisible(D);var h=!F&&x.parentNode&&x.parentNode.id=="fm_fav_root";var q=!(this.webfm.checkFTPDownloadRight(x));if(h||F||J||(j&&!this.webfm.onCheckVFSAction("download",v,null,t))){l=false}u.get("gc_download_menu").setDisabled(!q);u.get("gc_download").setDisabled(!q);if(l&&1===AppletProgram.blJavaPermission){u.get("gc_download_menu").setVisible(!h&&!F);u.get("gc_download").hide()}else{u.get("gc_download").setVisible(l);u.get("gc_download_menu").hide()}if(n||_S("demo_mode")||(j&&!this.webfm.onCheckVFSAction("create",v,null,t))){d=false}u.get("gc_createfolder").setVisible(d);u.get("gc_createfolder").setDisabled(m);if(h||n||(j&&!this.webfm.onCheckVFSAction("move",v,null,t))){p=false}if(h||n||(j&&!this.webfm.onCheckVFSAction("copy",v,null,t))){s=false}u.get("gc_copy").setVisible(s);u.get("mvcpto").setVisible(p||s);u.get("mvcpto").setMoveDisabled(H||!p);if(h||n||(j&&!this.webfm.onCheckVFSAction("move",v,null,t))){K=false}u.get("gc_cut").setVisible(K);u.get("gc_cut").setDisabled(H||!K);if(h||n||(j&&!this.webfm.onCheckVFSAction("delete",v,null,t))){z=false}u.get("gc_delete").setVisible(z);u.get("gc_delete").setDisabled(H);if(h||n||(j&&!this.webfm.onCheckVFSAction("rename",v,null,t))){k=false}u.get("gc_rename").setVisible(k);u.get("gc_rename").setDisabled(H);u.get("gc_cleanfav").hide();u.get("gc_local_upload").setVisible(F);u.get("gc_eject").setVisible(o);if(F||n||(j&&!this.webfm.onCheckVFSAction("upload",v,null,t))){this.webfm.btnTreeUpBrowserAction.setHidden(true);this.webfm.btnTreeUpSubMenuAction.setHidden(true);C=false}else{if((SYNO.FileStation.FlashUploader.blFlash||1===AppletProgram.blJavaPermission||(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload()))){this.webfm.onShowUpSubMenu(true)}else{this.webfm.onShowUpSubMenu(false)}}y=!SYNO.FileStation.Clipboard.isEmpty();var i=SYNO.FileStation.Clipboard.get();if(j&&i&&!this.webfm.onCheckVFSAction(i.action,i.recs,v,null,t)){y=false}u.get("gc_paste_ovwr").setVisible(y);u.get("gc_paste_skip").setVisible(y);u.get("gc_paste_ovwr").setDisabled(m);u.get("gc_paste_skip").setDisabled(m);I=(-1===x.attributes.path.indexOf("/",1));if(!F&&I){Ext.each(f.items.items,function(e){e.hide()});if(x.attributes.name&&SYNO.SDS.ControlPanel.Share.usedBySurveillance(x.attributes.name)){return}if(o){u.get("gc_eject").show()}if(D){u.get("gc_renamefav").show();u.get("gc_delfav").show()}if(d){u.get("gc_createfolder").show()}if(C){if((SYNO.FileStation.FlashUploader.blFlash||1===AppletProgram.blJavaPermission||(SYNO.SDS.App.Uploader.Utils.isSupportHTML5Upload()))){this.webfm.onShowUpSubMenu(true)}else{this.webfm.onShowUpSubMenu(false)}}if(y){u.get("gc_paste_ovwr").setVisible(y);u.get("gc_paste_skip").setVisible(y)}}if("yes"===_D("supportmount")){if(!j&&r){if("remotefail"===x.attributes.mountType){Ext.each(f.items.items,function(e){e.hide()})}if(f.items.get("gc_umount")){f.items.get("gc_umount").show()}}else{if(f.items.get("gc_umount")){f.items.get("gc_umount").hide()}}}u.get("gc_disconnect_vfs").setVisible(g&&"remotefail"!==x.attributes.mountType);u.get("gc_remove_vfs").setVisible(g);u.get("gc_snapshot_history").setVisible(E);if(!_S("is_admin")||F||D||g||(x.attributes.path==="/home")||x.parentNode&&((x.parentNode.id=="fm_vd_root")||((x.parentNode.id=="fm_rf_root")))){f.items.get("gc_property").hide()}else{f.items.get("gc_property").show()}Ext.each(f.items.items,function(e){if(false===e.hidden){A=true;return false}});if(!A){return}}if(x.parentNode&&x.parentNode.id!=="fm_top_root"){f.items.get("text").show();f.items.get("text").setText("<b>["+Ext.util.Format.ellipsis(x.text,36)+"]</b>")}SYNO.webfm.utils.ShowHideMenu(f.items);f.showAt(G.getXY());this.webfm.currCTNodeTmp=x},scope:this},expandnode:{fn:function(g){if(g===this.root){return}var h=this.webfm.getCurrentDir();var e=this.webfm.getCurrentSource();var f=this.getNodeById(e+h);if(f&&f!==this.getSelectionModel().getSelectedNode()){this.getSelectionModel().select(f)}else{if(g){g.ensureVisible()}}},scope:this},beforenodedrop:{fn:this.beforeNodeDrop,scope:this},movenode:{fn:function(d,h,f,g,e){if(f.id==="fm_fav_root"){d.webfm.FileAction.SaveFav()}},scope:this},beforemovenode:{fn:function(e,d,h,f,g){return d.parentNode&&d.parentNode.id==="fm_fav_root"&&d.attributes.favstatus!=="fail"&&f&&f.id==="fm_fav_root"},scope:this},nodedragover:{fn:this.nodeDragOver,scope:this},afterrender:{scope:this,fn:function(d){if(!Ext.isMac){return}d.getTreeEl().on("keyup",function(g){var f=this.getCmdCode();if(Ext.isArray(f)){this.cmdKeyDown=this.cmdKeyDown&&(f.indexOf(g.getKey())===-1)}else{this.cmdKeyDown=this.cmdKeyDown&&(f!==g.getKey())}},this)},single:true}},root:new Ext.tree.TreeNode({id:"fm_top_root",text:"none",allowDrag:false,allowDrop:false}),keys:this.getHotKeyMap()};SYNO.FileStation.MixedTreePanel.superclass.constructor.call(this,Ext.apply(c,b));var a=this.initRemoteLoader();this.root.appendChild(this.initFavoriteNode(a));this.root.appendChild(this.initRemoteRoot(a));this.setVFSRemoteProtocol(a);if("yes"===_D("supportmount")){this.root.appendChild(this.initVirtualDeviceRoot(a));this.root.appendChild(this.initRemoteFolderRoot(a))}},setVFSRemoteProtocol:function(a){var b=this.getBaseURL({api:"SYNO.FileStation.VFS.Protocol",method:"list",version:1});b=Ext.urlAppend(b,Ext.urlEncode({v:_S("fullversion")}));Ext.Ajax.request({url:b,method:"GET",scope:this,disableCaching:false,callback:function(e,j,d){if(!d||!d.responseText){return}var h=JSON.parse(d.responseText).data;if(j){if(this.isDestroyed||!this.root){return}var f=0,g=h.protocols;for(f=0;f<g.length;f++){var c=g[f];this.root.appendChild(this.createVFSRoot(a,c.protocol,c.name))}this.updateScrollbar(this.getTreeEl().dom)}}})},getCmdCode:function(){return SYNO.webfm.utils.getCmdCode()},getHotKeyMap:function(){if(Ext.isMac){var a=this.getCmdCode();return[{key:a,fn:function(){this.cmdKeyDown=true},scope:this},{key:Ext.EventObject.DELETE,fn:this.onDelete,scope:this},{key:Ext.EventObject.C,fn:this.onCopy,stopEvent:true,scope:this},{key:Ext.EventObject.X,fn:this.onCut,stopEvent:true,scope:this},{key:Ext.EventObject.V,fn:this.onPaste,stopEvent:true,scope:this},{key:Ext.EventObject.F2,fn:this.onRename,scope:this}]}else{return[{key:Ext.EventObject.DELETE,fn:this.onDelete,scope:this},{key:Ext.EventObject.C,ctrl:true,fn:this.onCopy,scope:this},{key:Ext.EventObject.X,ctrl:true,fn:this.onCut,scope:this},{key:Ext.EventObject.V,ctrl:true,fn:this.onPaste,scope:this},{key:Ext.EventObject.F2,fn:this.onRename,scope:this}]}},onCopy:function(){var a=this.getSelectionModel().getSelectedNode();if(!a||!SYNO.webfm.utils.NodeActionEnable.isEnableCopy(a)){return}if(Ext.isMac&&!this.cmdKeyDown){return}this.onAction("gc_copy")},onCut:function(){var a=this.getSelectionModel().getSelectedNode();if(!a||!SYNO.webfm.utils.NodeActionEnable.isEnableCut(a)){return}if(Ext.isMac&&!this.cmdKeyDown){return}this.onAction("gc_cut")},onPaste:function(){var a=this.getSelectionModel().getSelectedNode();if(!a||!SYNO.webfm.utils.NodeActionEnable.isEnablePaste(a)){return}if(Ext.isMac&&!this.cmdKeyDown){return}if(SYNO.FileStation.Clipboard.isEmpty()){return}this.onAction("gc_paste_skip")},onRename:function(){var a=this.getSelectionModel().getSelectedNode();if(!a||!SYNO.webfm.utils.NodeActionEnable.isEnableRename(a)){return}this.onAction("gc_rename")},onDelete:function(){var a=this.getSelectionModel().getSelectedNode();if(!a||!SYNO.webfm.utils.NodeActionEnable.isEnableDelete(a)){return}this.onAction("gc_delete")},onAction:function(b){var a=this.webfm.treeCtxMenu.items.get(b);if(!a){return}this.webfm.currCTNodeTmp=this.getSelectionModel().getSelectedNode();this.webfm.treeCtxMenu.onTreeCTClick(a)},selectSearchNode:function(){this.getSelectionModel().select(this.searchNode);this.searchNode.ui.show();this.searchNode.ensureVisible();this.updateScrollbar(this.getTreeEl().dom)},unselectSearchNode:function(a){if(a){var b=this.treeroot.firstChild||this.treeroot;this.getSelectionModel().select(b);b.ensureVisible()}this.searchNode.ui.hide();this.updateScrollbar(this.getTreeEl().dom)},unselectCurrentNode:function(a){var b=this.getSelectionModel();b.unselect(b.getSelectedNode(),a?a:true)}});Ext.ns("SYNO.FileStation");SYNO.FileStation.PathBar=Ext.extend(Ext.util.Observable,{constructor:function(a){this.init(a.webfm);SYNO.FileStation.PathBar.superclass.constructor.apply(this,arguments);this.addEvents("updatepath")},init:function(a){this.webfm=a;this.tbPanel=new SYNO.FileStation.PathButtonsPanel({cls:"ux-pathtoolbar",webfm:this.webfm});return this},addPathButton:function(f,e,b,c,d,a){return this.tbPanel.addButton(f,e,b,c,d,a,this.webfm)},updatePathButton:function(e,d,b,c,a){return this.tbPanel.updateButton(e,d,b,c,a)},addPathButtons:function(c){var b=Math.max(this.tbPanel.items.length,c.length);var d=c.length-1;for(var a=0;a<b;a++){if(a<this.tbPanel.items.length&&a<c.length){this.updatePathButton(a,c[a].text,c[a].tooltip,c[a].path,a===d)}else{if(a<c.length){this.addPathButton(this.tbPanel.items.length,c[a].text,c[a].tooltip,c[a].path,a===0,a===d)}else{this.removePathButtons(a,b);break}}}this.tbPanel.setActiveButton(this.tbPanel.items[this.tbPanel.items.length-1]);this.fireEvent("updatepath",this)},removePathButtons:function(b,a){this.tbPanel.removeButtons(b,a)},setWidth:function(a){this.tbPanel.setWidth(a)}});SYNO.FileStation.PathButtonsPanel=Ext.extend(Ext.BoxComponent,{activeButton:null,enableScroll:true,scrollRepeatInterval:400,scrollDuration:0.35,buttonWidthSet:false,allowDomMove:false,onRender:function(){SYNO.FileStation.PathButtonsPanel.superclass.onRender.call(this,arguments);this.mon(this,"resize",this.delegateUpdates);this.items=[];this.selMenu=new SYNO.ux.Menu({items:[],listeners:{click:{fn:function(b,a){if(a.path){this.webfm.onGoToPathWithDir(a.path)}},scope:this}}});this.stripWrap=Ext.get(this.el).createChild({cls:"ux-pathbuttons-strip-wrap",cn:{tag:"ul",cls:"ux-pathbuttons-strip"}});this.stripSpacer=Ext.get(this.el).createChild({cls:"ux-pathbuttons-strip-spacer"});this.strip=new Ext.Element(this.stripWrap.dom.firstChild);this.edge=this.strip.createChild({tag:"li",cls:"ux-pathbuttons-edge"});this.strip.createChild({cls:"x-clear"})},addButton:function(d,f,i,h,c,g,b){var e=this.strip.createChild({tag:"li"},this.edge);var a=new SYNO.FileStation.PathBar.PathButton(e,d,f,i,h,c,g,b);this.items.push(a);if(!this.buttonWidthSet){this.lastButtonWidth=a.container.getWidth()}this.addManagedComponent(a);return a},updateButton:function(f,e,c,d,b){var a=this.items[f];a.updateButton(e,c,d,b)},removeButtons:function(f,e){var a;var c;for(var b=f;b<e;b++){c=this.items[b];a=document.getElementById(c.container.id);this.removeManagedComponent(c);c.destroy();a.parentNode.removeChild(a)}var d=[];for(b=0;b<f;b++){d.push(this.items[b])}this.items=d;this.delegateUpdates()},setActiveButton:function(a){this.activeButton=a;this.delegateUpdates()},delegateUpdates:function(){if(this.enableScroll&&this.rendered){this.autoScroll()}},autoScroll:function(){var f=this.items.length;var c=this.el.dom.clientWidth;var d=this.stripWrap;var b=d.dom.offsetWidth;var g=this.getScrollPos();var a=this.edge.getOffsetsTo(this.stripWrap)[0]+g;if(!this.enableScroll||f<1||b<20){return}d.setWidth(c);var e=(this.items.length==1);if(a<=c||e){d.dom.scrollLeft=0;if(this.showSelBtn){this.showSelBtn=false;this.el.removeClass("x-pathbuttons-selection-btn-displayed");this.menuBtn.hide()}}else{if(!this.showSelBtn){this.el.addClass("x-pathbuttons-selection-btn-displayed")}c-=d.getMargins("lr");d.setWidth(c>20?c:20);if(!this.showSelBtn){if(!this.menuBtn){this.createMenuBtn()}else{this.menuBtn.show()}}this.showSelBtn=true;this.updateScrollandSelMenu()}},createMenuBtn:function(){var b=this.el.dom.offsetHeight;var a=this.el.insertFirst({cls:"ux-pathbuttons-selection-btn"});a.setHeight(b);a.addClassOnOver("ux-pathbuttons-selection-btn-over");a.addClassOnClick("ux-pathbuttons-selection-btn-click");this.leftRepeater=new Ext.util.ClickRepeater(a,{interval:this.scrollRepeatInterval,handler:this.onShowMenu,scope:this});this.menuBtn=a},onShowMenu:function(){var c=this.menuBtn.getXY();var a=-5,b=28;if(this.selMenu.isVisible()){this.selMenu.hide()}else{this.selMenu.showAt([c[0]+a,c[1]+b])}},getScrollPos:function(){return parseInt(this.stripWrap.dom.scrollLeft,10)||0},updateScrollandSelMenu:function(){var c=6+8;var l=this.items.length;var a=l-1;var d=0;var m=this.stripWrap.getWidth();var b;for(var f=a;f>=0;f--){b=this.items[f].el.child(".ux-pathbutton-center");d+=b.getWidth()+c;if(d>m){break}}if(f==a){f-=1}this.selMenu.removeAll();for(var e=0;e<=f;e++){this.selMenu.addItem({path:this.items[e].path,text:this.items[e].text})}var k=this.items[f+1];var g=this.stripWrap.dom.scrollLeft;var h=k.el.getOffsetsTo(this.stripWrap)[0]+g;this.stripWrap.scrollTo("left",h-c)}});SYNO.FileStation.PathBar.PathButton=function(a,e,f,j,i,d,g,c){this.webfm=c;var b=d?this.firstBtnCls:"";var h=g?this.lastBtnCls:"";SYNO.FileStation.PathBar.PathButton.superclass.constructor.call(this,{text:f,itemId:e,renderTo:a,tooltip:j,clickEvent:"mousedown",listeners:{click:{fn:function(){var k=this.getPath();if(k){this.webfm.onGoToPathWithDir(k)}},scope:this}},template:new Ext.Template('<table cellspacing="0" class="x-btn '+b+" "+h+' {3}"><tbody><tr>','<td class="ux-pathbutton-left"></td>','<td class="ux-pathbutton-center"><em class="{5} unselectable="on">','<button class="x-btn-text {2}" type="{1}" style="height:18px;">{0}</button>',"</em></td>",'<td class="ux-pathbutton-right"></td>',"</tr></tbody></table>")});this.setPath(i)};Ext.extend(SYNO.FileStation.PathBar.PathButton,Ext.Button,{firstBtnCls:"x-first-btn",lastBtnCls:"x-last-btn",setPath:function(a){this.path=a},getPath:function(){return this.path},updateButton:function(d,b,c,a){this.setPath(c);this.setText(d);this.setTooltip(b);if(a){this.addClass(this.lastBtnCls)}else{this.removeClass(this.lastBtnCls)}}});Ext.ns("SYNO.FileStation");SYNO.FileStation.CrtFdrDialog=function(b){this.checkName=true;this.updateDsmStyle(b);Ext.apply(this,b||{});var a=this.init();var c={owner:this.owner,width:450,height:180,shadow:true,minWidth:500,minHeight:150,collapsible:false,autoScroll:false,constrainHeader:true,plain:true,title:_WFT("filetable","filetable_create_folder"),layout:"fit",items:[a],buttons:[{btnStyle:"blue",text:_WFT("common","common_submit"),scope:this,handler:this.saveFolderName},{text:_WFT("common","common_cancel"),scope:this,handler:this.closeHandler}],keys:[{key:[10,13],fn:this.saveFolderName,scope:this},{key:27,fn:this.closeHandler,scope:this}],listeners:{afterlayout:{fn:function(){this.focusEl=this.crtFdrForm.get("name");this.center()},scope:this,single:true}}};this.addEvents({callback:true});SYNO.FileStation.CrtFdrDialog.superclass.constructor.call(this,c)};Ext.extend(SYNO.FileStation.CrtFdrDialog,SYNO.SDS.ModalWindow,{init:function(){var a={labelWidth:75,labelAlign:"top",trackResetOnLoad:true,waitMsgTarget:true,border:false,bodyStyle:this.isV5Style()?"":"padding: 20px",items:[{xtype:this.isV5Style()?"syno_textfield":"textfield",itemId:"name",fieldLabel:_WFT("filetable","filetable_fill_name"),name:"name",width:400,maxlength:255}],listeners:{actionfailed:{fn:this.closeHandler,scope:this}}};var b=new Ext.form.FormPanel(a);this.crtFdrForm=b;return b},callbackHandler:function(){this.hide();this.fireEvent("callback")},closeHandler:function(){this.callbackHandler()},saveFolderName:function(){var a="";if(!this.crtFdrForm||!this.crtFdrForm.form.findField("name")){this.closeHandler();return}a=this.crtFdrForm.form.findField("name").getValue();a=Ext.util.Format.trim(a);if(!a){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_empty_name"));return}if(this.checkName){if(!SYNO.webfm.utils.checkFileLen(a)){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_long_path"));return}if(SYNO.webfm.utils.isNameReserved(a)){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_reserved_name"));return}if(SYNO.webfm.utils.isNameCharIllegal(a)){this.getMsgBox().alert(_WFT("filetable","filetable_create_folder"),_WFT("error","error_reserved_name"));return}}this.fdrName=a;this.callbackHandler()},resetDialogForm:function(){if(this.crtFdrForm){this.crtFdrForm.form.reset()}},getFolderName:function(){return this.fdrName},resetFolderName:function(){this.fdrName=null},setParentDir:function(a){this.parentDir=a},setCheckName:function(a){if(SYNO.webfm.utils.isLocalSource(a)){this.checkName=false}else{this.checkName=true}},getParentDir:function(){return this.parentDir},load:function(){this.resetDialogForm();this.resetFolderName();this.show()}});Ext.ns("SYNO.FileStation");SYNO.FileStation.SelectAllRowSelectionModel=Ext.extend(Ext.grid.RowSelectionModel,{constructor:function(a){SYNO.FileStation.SelectAllRowSelectionModel.superclass.constructor.call(this,a);this.pageSelections=new Ext.util.MixedCollection(false,function(b){return b.id})},onRefresh:function(){var f=this.grid.store,d=this.getSelections(),c=0,a=d.length,b,e;this.silent=this.silentMode&&true;this.clearSelections(true);for(;c<a;c++){e=d[c];if((b=f.indexOfId(e.id))!=-1){this.selectRow(b,true)}}if(d.length!=this.pageSelections.getCount()){this.fireEvent("selectionchange",this)}this.silent=false},maskGrid:function(a){if(a.loadMask){a.loadMask.show()}},unmaskGrid:function(a){if(a.loadMask){a.loadMask.hide()}},selectAllRow:function(a){if(this.isLocked()){return}var c=this.grid,e=this.grid.store,d=this.grid.store.getCount();this.maskGrid(c);this.selections.clear();for(var b=0;b<d;b++){this.selectRow(b,true)}if(e.getTotalCount()===e.getCount()){this.unmaskGrid(c);return}e.suspendEvents();e.load({params:{offset:0,limit:e.getTotalCount()},callback:function(){this.pageSelections.clear();this.pageSelections.addAll(e.data.items);e.resumeEvents();this.unmaskGrid(c);if(a.callback){a.callback.call(a.scope||this)}},scope:this})},clearSelections:function(a){if(this.isLocked()){return}if(a!==true){var c=this.grid.store,b=this.selections;b.each(function(d){this.deselectRow(c.indexOfId(d.id))},this);b.clear()}else{this.selections.clear()}this.last=false},clearAllSelections:function(a){if(this.isLocked()){return}if(a!==true){var c=this.grid.store,b=this.pageSelections;b.each(function(d){this.deselectRow(c.indexOfId(d.id))},this);b.clear()}else{this.pageSelections.clear()}},selectRow:function(b,d,a){if(this.isLocked()||(b<0||b>=this.grid.store.getCount())||(d&&this.isSelected(b))){return}var c=this.grid.store.getAt(b);if(c&&this.fireEvent("beforerowselect",this,b,d,c)!==false){if(!d||this.singleSelect){this.clearSelections();this.clearAllSelections()}this.selections.add(c);this.pageSelections.add(c);this.last=this.lastActive=b;if(!a){this.grid.getView().onRowSelect(b)}if(!this.silent){this.fireEvent("rowselect",this,b,c);this.fireEvent("selectionchange",this)}}},selectRows:function(c,d){if(!d){this.clearSelections();this.clearAllSelections()}for(var b=0,a=c.length;b<a;b++){this.selectRow(c[b],true)}},selectRange:function(b,a,d){var c;if(this.isLocked()){return}if(!d){this.clearSelections();this.clearAllSelections()}if(b<=a){for(c=b;c<=a;c++){this.selectRow(c,true)}}else{for(c=b;c>=a;c--){this.selectRow(c,true)}}},deselectRow:function(b,a){if(this.isLocked()){return}if(this.last==b){this.last=false}if(this.lastActive==b){this.lastActive=false}var c=this.grid.store.getAt(b);if(c){this.selections.remove(c);this.pageSelections.remove(c);if(!a){this.grid.getView().onRowDeselect(b)}this.fireEvent("rowdeselect",this,b,c);this.fireEvent("selectionchange",this)}},getSelections:function(){return[].concat(this.pageSelections.items)}});Ext.define("SYNO.FileStation.TypeAndSearchPlugin",{extend:"Ext.Component",delayTime:50,delayClearTime:720,init:function(a){var b=this;b.keyword="";b.view=a;a.mon(a,"afterlayout",function(){this.mon(a.getEl(),"keypress",this.onDetectKeyPress,this)},b,{single:true})},runSearchTask:function(){var a=this;a.runTask("searchTask",a.search,(Ext.isNumber(a.delayTime)?a.delayTime:50))},runClearKeywordTask:function(){var a=this;a.runTask("clearKeywordTask",a.clearKeyword,(Ext.isNumber(a.delayClearTime)?a.delayClearTime:720))},clearKeyword:function(){this.keyword=""},search:function(){var c=this,a=c.view,b=c.keyword;if(a&&Ext.isFunction(a.searchAndFocus)){a.searchAndFocus(b,b.length>1)}},onDetectKeyPress:function(b){var a=this;a.keyword=Ext.isString(a.keyword)?a.keyword:"";a.keyword+=String.fromCharCode(b.getCharCode());a.runSearchTask();a.runClearKeywordTask()},destroy:function(){var b=this,a=["searchTask","clearKeywordTask"];Ext.each(a,function(e,c,d){this.removeDelayedTask(e)},b);b.callParent(arguments)}});Ext.preg("typeandsearchplugin",SYNO.FileStation.TypeAndSearchPlugin);Ext.ns("SYNO.FileStation");SYNO.FileStation.FocusGridPlugin=Ext.extend(Ext.Component,{init:function(a){a.mon(a,"click",function(b){if(document.activeElement.id===this.getView().focusEl.id){return}if(Ext.isGecko){this.getView().focusEl.focus()}else{this.getView().focusEl.focus.defer(1,this.getView().focusEl)}},a)}});SYNO.FileStation.FocusGridPluginInstance=new SYNO.FileStation.FocusGridPlugin();Ext.preg("focusgridplugin",SYNO.FileStation.FocusGridPlugin);Ext.ns("SYNO.FileStation");SYNO.FileStation.FocusPanelPlugin=Ext.extend(Ext.Component,{init:function(a){a.mon(a,"click",function(c){var b=this.body.tabindex;if(!b){this.body.set({tabindex:-1})}if(document.activeElement.id===this.body.id){return}if(Ext.isGecko){this.body.focus()}else{this.body.focus.defer(1,this.body)}},a)}});SYNO.FileStation.FocusPanelPluginInstance=new SYNO.FileStation.FocusPanelPlugin();Ext.preg("focuspanelplugin",SYNO.FileStation.FocusPanelPlugin);Ext.ns("SYNO.FileStation");SYNO.FileStation.GridPanelFlexcrollPlugin=Ext.extend(Ext.Component,{init:function(b){var a=this;Ext.apply(b,{updateScrollbar:a.updateScrollbar});b.mon(b,"beforerender",function(){b.cls=b.cls?b.cls+" syno-webfm-scroll":"syno-webfm-scroll";b.overCls=b.overCls?b.overCls+" syno-webfm-scroll-over":"syno-webfm-scroll-over"},this);b.mon(b,"afterrender",function(d){var c=d.getView().scroller;d.updateScrollbar(c.dom);d.mon(d,"resize",function(){this.updateScrollbar(c.dom)},d,{buffer:500});d.mon(d.getView(),"refresh",function(){this.updateScrollbar(c.dom)},d,{buffer:500});d.mon(d.getStore(),"load",function(){this.updateScrollbar(c.dom,true);this.fireEvent("afterUpdateScrollbar",this)},d,{buffer:500});d.mon(d.getStore(),"clear",function(){this.updateScrollbar(c.dom,true)},d,{buffer:500});d.mon(d.getStore(),"datachanged",function(){this.updateScrollbar(c.dom)},d,{buffer:500});d.mon(d.getStore(),"update",function(){this.updateScrollbar(c.dom)},d,{buffer:500})},this)},updateScrollbar:function(b,a){if(b&&b.fleXcroll){if(a){b.fleXcroll.setScrollPos(false,0)}b.fleXcroll.updateScrollBars();if(!a){b.fleXcroll.setScrollPos(0,0,true)}}else{if(b){fleXenv.fleXcrollMain(b);b.onfleXcroll=(function(){if(this.isVisible()&&this.getView().update){this.getView().update()}}).createDelegate(this)}}}});SYNO.FileStation.GridPanelFlexcrollPluginInstance=new SYNO.FileStation.GridPanelFlexcrollPlugin();Ext.preg("gridpanelflexcrollplugin",SYNO.FileStation.GridPanelFlexcrollPlugin);SYNO.FileStation.BufferViewFlexcrollPlugin=Ext.extend(Ext.Component,{init:function(b){var a=this;Ext.apply(b.getView(),{initTemplates:a.initTemplates,getVscrollerbarBase:a.getVscrollerbarBase,getContentwrapper:a.getContentwrapper,getVisibleRowCount:a.getVisibleRowCount,getVisibleRows:a.getVisibleRows})},initTemplates:function(){Ext.ux.grid.BufferView.prototype.initTemplates.apply(this,arguments);var a=this.templates;a.hcell=new Ext.Template('<td class="x-grid3-hd x-grid3-cell x-grid3-td-{id} {css}" style="{style}"><div class="x-grid3-hd-row-split"></div><div {tooltip} {attr} class="x-grid3-hd-inner webfm-x-grid3-hd x-grid3-hd-{id}" unselectable="on" style="{istyle}">',this.grid.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"","{value}",'<img alt="" class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div>","</td>");a.hcell.disableFormats=true;a.hcell.compile()},getVscrollerbarBase:function(){if(this.scrollerbarbase){return this.scrollerbarbase}return(this.scrollerbarbase=Ext.get(this.el.child("div.scrollerbarbase")))},getContentwrapper:function(){if(this.vscrollerbar){return this.vscrollerbar}return(this.vscrollerbar=Ext.get(this.el.child("div.contentwrapper")))},getVisibleRowCount:function(){var b=this.getCalculatedRowHeight(),a=!Ext.isEmpty(this.getVscrollerbarBase())?this.getVscrollerbarBase().getHeight():this.scroller.dom.clientHeight;return(a<1)?0:Math.ceil(a/b)},getVisibleRows:function(){var a=this.getVisibleRowCount(),b=!Ext.isEmpty(this.getContentwrapper())?(-1*this.getContentwrapper().getTop(true)+1):this.scroller.dom.scrollTop,c=(b===0?0:Math.floor(b/this.getCalculatedRowHeight())-1);return{first:Math.max(c,0),last:Math.min(c+a+3,this.ds.getCount()-1)}}});SYNO.FileStation.BufferViewFlexcrollPluginInstance=new SYNO.FileStation.BufferViewFlexcrollPlugin();Ext.preg("bufferviewflexcrollplugin",SYNO.FileStation.BufferViewFlexcrollPlugin);Ext.ns("SYNO.FileStation");SYNO.FileStation.FocusComponentPlugin=Ext.extend(Ext.Component,{init:function(a){a.mon(a,"afterrender",function(){this.onAfterRender(a)},this)},onAfterRender:function(a){a.getEl().on("click",function(c){var b=this.getEl().tabindex;if(!b){this.getEl().set({tabindex:-1})}if(Ext.isGecko){this.getEl().focus()}else{this.getEl().focus.defer(1,this.getEl())}},a)}});SYNO.FileStation.FocusComponentPluginInstance=new SYNO.FileStation.FocusComponentPlugin();Ext.preg("focuscomponentplugin",SYNO.FileStation.FocusComponentPlugin);SYNO.FileStation.DataViewSelectionModel=function(d){var e=d;var g=function(){return e.getSelectionCount()>0};var f=function(){return e.getSelectedRecords()};var i=function(){return f()[0]};var a=function(){return e.getSelectionCount()};var j=function(l){e.selectAllRow(l)};var k=function(l){e.clearAllSelections(l)};var h=function(l){e.clearSelections(l)};var c=function(l){e.select(l)};var b=function(m,n){var l=0;if(Ext.isEmpty(m)){return}if(!n){this.clearSelections()}for(l=0;l<m.length;l++){this.selectRow(e.store.indexOf(m[l]))}};return{dataView:e,getSelected:i,getCount:a,hasSelection:g,getSelections:f,selectAllRow:j,clearAllSelections:k,clearSelections:h,selectRow:c,selectRecords:b}};SYNO.FileStation.SelectAllDataView=Ext.extend(SYNO.SDS.Utils.DataView.LazyDataView,{constructor:function(a){SYNO.FileStation.SelectAllDataView.superclass.constructor.call(this,a);this.selectAll=new Ext.util.MixedCollection(false,function(b){return b.id})},getSelectionModel:function(){return this.selectionModel||(this.selectionModel=new SYNO.FileStation.DataViewSelectionModel(this))},getSelectionCount:function(){return this.selectAll.items.length},getSelectedNodes:function(){return[].concat(this.selectAll.items)},getSelectedRecords:function(){return[].concat(this.selectAll.items)},onContainerClick:function(a){this.clearAllSelections()},clearAllSelections:function(a,b){if((this.multiSelect||this.singleSelect)&&this.selectAll.getCount()>0){if(!b){this.selected.removeClass(this.selectedClass)}this.selected.clear();this.selectAll.clear();this.last=false;if(!a){this.fireEvent("selectionchange",this,this.selected.elements)}}},selectAllRow:function(a){var d=this,e=d.getStore(),c=e.getCount();d.getEl().mask(d.loadingText||"","x-mask-loading");d.clearAllSelections();for(var b=0;b<c;b++){d.select(b,true,true)}if(e.getTotalCount()===e.getCount()){d.getEl().unmask();return}e.suspendEvents();e.load({params:{offset:0,limit:e.getTotalCount()},callback:function(){if(d.isDestroy){return}this.selectAll.addAll(e.data.items);e.resumeEvents();d.getEl().unmask();if(a.callback){a.callback.call(a.scope||this)}},scope:this})},selectRange:function(c,a,b){if(!b){this.clearAllSelections(true)}this.select(this.getNodes(c,a),true)},isSelected:function(a){return this.selectAll.contains(this.getRecord(this.getNode(a)))},deselect:function(a){if(this.isSelected(a)){a=this.getNode(a);this.selected.removeElement(a);this.selectAll.remove(this.getRecord(this.getNode(a)));if(this.last==a.viewIndex){this.last=false}Ext.fly(a).removeClass(this.selectedClass);this.fireEvent("selectionchange",this,this.selected.elements)}},select:function(d,f,b){if(Ext.isArray(d)){if(!f){this.clearAllSelections(true)}for(var c=0,a=d.length;c<a;c++){this.select(d[c],true,true)}if(!b){this.fireEvent("selectionchange",this,this.selected.elements)}}else{var e=this.getNode(d);if(!f){this.clearAllSelections(true)}if(e&&!this.isSelected(e)){if(this.fireEvent("beforeselect",this,e,this.selected.elements)!==false){Ext.fly(e).addClass(this.selectedClass);this.selected.add(e);this.selectAll.add(this.getRecord(this.getNode(e)));this.last=e.viewIndex;if(!b){this.fireEvent("selectionchange",this,this.selected.elements)}}}}},refresh:function(){SYNO.FileStation.SelectAllDataView.superclass.refresh.call(this);var f=this,d=f.getSelectedRecords(),c=0,g=f.getStore(),a=d.length,b;for(;c<a;c++){var e=d[c];if((b=g.indexOfId(e.id))!=-1){this.select(b,true,true)}}}});SYNO.FileStation.ThumbnailSizeManager=Ext.extend(Object,{constructor:function(a){var b=this;a=a||{};b.largeThumbCls="syno-sds-fs-large-thumb";b.smallThumbCls="syno-sds-fs-small-thumb";b.thumbSize=SYNO.webfm.utils.ThumbSize.MEDIUM;Ext.apply(b,a)},resizeThumb:function(b){var c=b.getWidth(),a=b.getHeight();b.removeClass("syno-sds-fs-large-thumb-width");b.removeClass("syno-sds-fs-large-thumb-height");if(c>=a){b.addClass("syno-sds-fs-large-thumb-width")}else{b.addClass("syno-sds-fs-large-thumb-height")}},getThumbSize:function(){return this.thumbSize},changeThumbSize:function(b,a){var c=this;b.removeClass(c.largeThumbCls);b.removeClass(c.smallThumbCls);switch(a){case SYNO.webfm.utils.ThumbSize.SMALL:b.addClass(c.smallThumbCls);c.thumbSize=SYNO.webfm.utils.ThumbSize.SMALL;break;case SYNO.webfm.utils.ThumbSize.MEDIUM:c.thumbSize=SYNO.webfm.utils.ThumbSize.MEDIUM;break;case SYNO.webfm.utils.ThumbSize.LARGE:b.addClass(c.largeThumbCls);c.thumbSize=SYNO.webfm.utils.ThumbSize.LARGE;break;default:c.thumbSize=SYNO.webfm.utils.ThumbSize.MEDIUM;break}}});Ext.define("SYNO.FileStation.ImageLoader",{extend:"Ext.Component",maxImageRequest:24,constructor:function(){this.imageQueue=[];this.imageToDoQueue=[];this.callParent(arguments)},getTask:function(){this.actionTask=this.actionTask||this.addTask({id:"task_set_image",interval:17,run:this.setImage,scope:this});return this.actionTask},addImage:function(a){this.innerAddImage(a)},innerAddImage:function(d){var c=this,a=c.imageToDoQueue,b=c.getTask();if((a.indexOf(d)!==-1)||c.imageQueue.indexOf(d)!==-1){return}a.push(d);if(b.running===false){b.stop();b.start(true)}},removeImage:function(c){var b=this,a=b.imageQueue;if((a.length===0)||(a.indexOf(c)===-1)){return}a.remove(c);if(a.length===0){b.getTask().stop()}},removeAll:function(){var a=this;a.imageQueue=[];a.imageToDoQueue=[];a.getTask().stop()},setImage:function(){var d=this,b=0,a=d.imageToDoQueue.concat(d.imageQueue),c=Math.min(d.maxImageRequest,a.length),f,e=[];d.imageToDoQueue=[];for(b=0;b<c;b++){f=a[b];if(d.fireEvent("setimage",f)===false){e.push(f)}}a.splice(0,c);a=a.concat(e);d.imageQueue=a;if(a.length===0){d.getTask().stop()}},stop:function(){var b=this,a=b.getTask();a.stop()},destroy:function(){var a=this;a.imageQueue=null;a.imageToDoQueue=null;if(a.actionTask){a.actionTask=null}a.callParent(arguments)}});SYNO.FileStation.ThumbnailsView=Ext.extend(SYNO.FileStation.SelectAllDataView,{ieMaxURLLength:2048,shadowCls:"syno-sds-fs-thumb-shadow",defaultSupportExt:["jpg","jpeg","jpe","bmp","png","tif","tiff","gif","arw","srf","sr2","dcr","k25","kdc","cr2","crw","nef","mrw","ptx","pef","raf","3fr","erf","mef","mos","orf","rw2","dng","x3f","raw"],defaultSupportVideoExt:["3gp","3g2","asf","dat","divx","dvr-ms","m2t","m2ts","m4v","mkv","mp4","mts","mov","qt","tp","trp","ts","vob","wmv","xvid","ac3","amr","rm","rmvb","ifo","mpeg","mpg","mpe","m1v","m2v","mpeg1","mpeg2","mpeg4","ogv","webm","flv","f4v","avi","swf","vdr","iso"],supportExt:Ext.isObject(SYNO.SDS.Config)?SYNO.SDS.Config.FnMap["SYNO.SDS.PhotoViewer.Application"].config.fb_extern[0].file||this.defaultSupportExt:this.defaultSupportExt,constructor:function(a){a=a||{};a=Ext.apply({loadingText:_WFT("common","loading"),cls:"syno-sds-fs-thumbnailsView",region:"center",multiSelect:true,autoScroll:true,itemMarginWidth:12,itemSelector:"div.thumb-wrap",disableTextSelect:true,itemCls:".syno-sds-fs-thumbnailsView .thumb-wrap",tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{[this.htmlEncode(values.file_id)]}">','<div ext:qtip="{[this.getTooltip(values)]}" class="thumb"><div class="thumb-hover thumb-loading" externalcss="{[this.getExternalCSS(values)]}"><img defaulticon="{icon}" draggable="false" class="{[this.hasThumbnail(values)]}" thumbnails="{[this.getThumbnailURL(values)]}" src="{[this.getDefaultSrc()]}" isvideo="{[this.getVideoType(values)]}"></div>',"<span>{[this.htmlEncode(values.filename)]}</span></div></div>","</tpl>",'<div class="x-clear"></div>',{compiled:true,disableFormats:true,getThumbnailURL:this.getThumbnailURL.createDelegate(this),hasThumbnail:this.hasThumbnail.createDelegate(this),getVideoType:this.getVideoType.createDelegate(this),getDefaultSrc:this.getDefaultSrc.createDelegate(this),getExternalCSS:this.getExternalCSS.createDelegate(this),getTooltip:this.getTooltip.createDelegate(this),htmlEncode:Ext.util.Format.htmlEncode}),prepareData:(function(b){if(Ext.isEmpty(b.icon)){b.icon=SYNO.webfm.utils.getThumbName(b)}return b}).createDelegate(this)},a);this.thumbSizeManager=new SYNO.FileStation.ThumbnailSizeManager();this.imageLoader=new SYNO.FileStation.ImageLoader();SYNO.FileStation.ThumbnailsView.superclass.constructor.call(this,a);this.mon(this.imageLoader,"setimage",this.setImgURL,this)},convertFileName:function(d,c){var a=d.is_snapshot&&d.is_btrfs_subvol,b=Ext.util.Format.htmlEncode(d.filename);if(!a){return b}b=b.replace(/-/g," ");b=b.substr(0,14).replace(/\./g,"-")+b.substr(14,b.length).replace(/\./g,":");if(c&&d.snapshot_desc!==""){b+=Ext.util.Format.htmlEncode(" - "+d.snapshot_desc)}return b},getThumbnailSize:function(b){var a="small";switch(b){case SYNO.webfm.utils.ThumbSize.SMALL:break;case SYNO.webfm.utils.ThumbSize.MEDIUM:break;case SYNO.webfm.utils.ThumbSize.LARGE:a="medium";break;default:a="small";break}return a},getSizeNumber:function(b){var a=128;switch(b){case SYNO.webfm.utils.ThumbSize.SMALL:a=64;break;case SYNO.webfm.utils.ThumbSize.MEDIUM:a=128;break;case SYNO.webfm.utils.ThumbSize.LARGE:a=256;break;default:a=128;break}return a},resizeThumb:function(a){},changeThumbSize:function(a){this.thumbSizeManager.changeThumbSize(this.getEl(),a);this.onResize()},getTooltip:function(c){var b="{0}<br>{1}<br>{2}",a="{0}<br>{1}";b=c.isdir?String.format(a,_WFT("common","common_filename")+_T("common","colon")+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c.filename)),Ext.util.Format.htmlEncode(_WFT("filetable","filetable_mtime")+_T("common","colon")+(new Date(c.mt*1000)).toLocaleString())):String.format(b,_WFT("common","common_filename")+_T("common","colon")+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c.filename)),Ext.util.Format.htmlEncode(_WFT("common","common_filesize")+_T("common","colon")+Ext.util.Format.fileSize(c.filesize)),Ext.util.Format.htmlEncode(_WFT("filetable","filetable_mtime")+_T("common","colon")+(new Date(c.mt*1000)).toLocaleString()));return b},afterRender:function(){SYNO.FileStation.ThumbnailsView.superclass.afterRender.call(this);if(this.keys){this.keymap=new Ext.KeyMap(this.getEl(),this.keys)}},getDefaultSrc:function(){this.defaultSrc=this.RELURL+"../../../../scripts/ext-3/resources/images/default/s.gif";return this.defaultSrc},isSupportExt:function(b){var a=false;Ext.each(this.supportExt,function(c){if(b===c){a=true}},this);return a},isSupportVideoExt:function(b){var a=false;Ext.each(this.defaultSupportVideoExt,function(c){if(b===c){a=true}},this);return a},getExternalCSS:function(d){var a,c=this.getStore().getById(d.file_id),b=this.thumbSizeManager.getThumbSize();if(SYNO.webfm.utils.isRemoteSource(this.owner.getCurrentSource())&&(a=this.owner.getExternIcon(c,this.getSizeNumber(b)))){d.iconObj=a;return a.css?a.css:""}return""},hasThumbnail:function(a){if(a.mountType==="remotefail"){return""}return this.isSupportExt(a.type.toLowerCase())||this.isSupportVideoExt(a.type.toLowerCase())?this.shadowCls:""},getVideoType:function(a){return this.isSupportVideoExt(a.type.toLowerCase())},getThumbnailURL:function(f){var d=f.icon,a=f.mt,e=this.RELURL,c=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(e+"images/files_ext_256/"+d,"FileType"),g=this.isSupportVideoExt(f.type.toLowerCase());if(f.mountType==="remotefail"){d="remotefailmountpoint.png";return SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(e+"images/files_ext_256/"+d,"FileType")}else{if(SYNO.webfm.utils.isRemoteSource(this.owner.getCurrentSource())&&f.iconObj&&f.iconObj.url){return f.iconObj.url}}var b=this.isSupportExt(f.type.toLowerCase())||g?Ext.urlAppend(SYNO.API.currentManager.getBaseURL("SYNO.FileStation.Thumb","get",1),Ext.urlEncode({path:SYNO.API.EscapeStr(f.path),mt:a})):c;if(SYNO.webfm.VFS.isVFSPath(this.owner.getCurrentDir())||b.length>this.ieMaxURLLength){return c}return b},removeListeners:function(a){var b=Ext.get(a);b.removeAllListeners()},onImageLoad:function(c,a,b){var d=Ext.get(a);d.parent().removeClass("thumb-loading");d.parent().addClass(Ext.fly(a).parent().getAttribute("externalcss"));this.resizeThumb(d);d.addClass("fadein")},onImageError:function(a){var c=a.getAttribute("defaulticon"),d=this.RELURL,b=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(d+"images/files_ext_256/"+c,"FileType"),e=Ext.get(a);e.removeClass(this.shadowCls);e.on("error",this.setDefaultIcon,this);a.src=b;a.loaded=undefined},onImageLoadEvent:function(a){Ext.get(a).on("load",this.onImageLoad,this)},setDefaultIcon:function(e,b,d){var f=this.RELURL,c=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(f+"images/files_ext_256/misc.png","FileType"),a=Ext.get(b);a.removeClass(this.shadowCls);this.onImageLoadEvent(b);b.src=c;a.un("error",this.setDefaultIcon,this)},errorHandler:function(c,a,b){this.onImageError(a)},setImgURL:function(d){var a=this.thumbSizeManager.getThumbSize();var e,c,b;this.all.each(function(f){if(f.id===d){e=f;c=e.select("img");return false}},this);if(c&&c.elements.length>0){b=c.elements[0];this.onImageLoadEvent(b);Ext.fly(b).on("error",this.errorHandler,this);if(b.getAttribute("isvideo")=="true"){a=SYNO.webfm.utils.ThumbSize.LARGE}b.src=Ext.urlAppend(b.getAttribute("thumbnails"),"size="+this.getThumbnailSize(a));b.loaded=a}},onLoadItem:function(d){var c=d.select("img"),b,a=this.thumbSizeManager.getThumbSize();if(c.elements.length>0){b=c.elements[0];if(b.loaded!==a&&b.loaded!==SYNO.webfm.utils.ThumbSize.LARGE){this.imageLoader.addImage(d.id)}else{this.resizeThumb(Ext.fly(b))}}},onUnLoadItem:function(a){this.imageLoader.removeImage(a.id)},removeEvents:function(){var c=this.getTemplateTarget();if(!c){return}var a=Ext.query(".thumb-hover img",c.dom);for(var b=0;b<a.length;b++){this.removeListeners(a[b])}},refresh:function(){this.removeEvents();this.imageLoader.removeAll();SYNO.FileStation.ThumbnailsView.superclass.refresh.apply(this,arguments)},destroy:function(){this.removeEvents();this.imageLoader.destroy();SYNO.FileStation.ThumbnailsView.superclass.destroy.apply(this,arguments)}});SYNO.FileStation.FolderSharingThumbnailsView=Ext.extend(SYNO.FileStation.SelectAllDataView,{ieMaxURLLength:2048,shadowCls:"syno-sds-fs-thumb-shadow",defaultSupportExt:["jpg","jpeg","jpe","bmp","png","tif","tiff","gif","arw","srf","sr2","dcr","k25","kdc","cr2","crw","nef","mrw","ptx","pef","raf","3fr","erf","mef","mos","orf","rw2","dng","x3f","raw"],defaultSupportVideoExt:["3gp","3g2","asf","dat","divx","dvr-ms","m2t","m2ts","m4v","mkv","mp4","mts","mov","qt","tp","trp","ts","vob","wmv","xvid","ac3","amr","rm","rmvb","ifo","mpeg","mpg","mpe","m1v","m2v","mpeg1","mpeg2","mpeg4","ogv","webm","flv","f4v","avi","swf","vdr","iso"],supportExt:Ext.isObject(SYNO.SDS.Config)?SYNO.SDS.Config.FnMap["SYNO.SDS.PhotoViewer.Application"].config.fb_extern[0].file||this.defaultSupportExt:this.defaultSupportExt,constructor:function(a){a=a||{};a=Ext.apply({loadingText:_WFT("common","loading"),cls:"syno-sds-fs-thumbnailsView",region:"center",multiSelect:true,autoScroll:true,itemMarginWidth:12,itemSelector:"div.thumb-wrap",itemCls:".syno-sds-fs-thumbnailsView .thumb-wrap",tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{[this.htmlEncode(values.file_id)]}">','<div ext:qtip="{[this.getTooltip(values)]}" class="thumb"><div class="thumb-hover thumb-loading"><img draggable="false" defaulticon="{icon}" class="{[this.hasThumbnail(values)]}" thumbnails="{[this.getThumbnailURL(values)]}" src="{[this.getDefaultSrc()]}" isvideo="{[this.getVideoType(values)]}"></div>',"<span>{[this.htmlEncode(values.filename)]}</span></div></div>","</tpl>",'<div class="x-clear"></div>',{compiled:true,disableFormats:true,getThumbnailURL:this.getThumbnailURL.createDelegate(this),getVideoType:this.getVideoType.createDelegate(this),hasThumbnail:this.hasThumbnail.createDelegate(this),getDefaultSrc:this.getDefaultSrc.createDelegate(this),getTooltip:this.getTooltip.createDelegate(this),htmlEncode:Ext.util.Format.htmlEncode}),prepareData:(function(b){if(Ext.isEmpty(b.icon)){b.icon=SYNO.webfm.utils.getThumbName(b)}return b}).createDelegate(this)},a);this.thumbSizeManager=new SYNO.FileStation.ThumbnailSizeManager();SYNO.FileStation.FolderSharingThumbnailsView.superclass.constructor.call(this,a);this.supportExt=this.supportExt||this.defaultSupportExt},getThumbnailSize:function(b){var a="small";switch(b){case SYNO.webfm.utils.ThumbSize.SMALL:break;case SYNO.webfm.utils.ThumbSize.MEDIUM:break;case SYNO.webfm.utils.ThumbSize.LARGE:a="medium";break;default:a="small";break}return a},getSizeNumber:function(b){var a=128;switch(b){case SYNO.webfm.utils.ThumbSize.SMALL:a=64;break;case SYNO.webfm.utils.ThumbSize.MEDIUM:a=128;break;case SYNO.webfm.utils.ThumbSize.LARGE:a=256;break;default:a=128;break}return a},resizeThumb:function(a){},changeThumbSize:function(a){this.thumbSizeManager.changeThumbSize(this.getEl(),a);this.onResize()},getTooltip:function(c){var b="{0}<br>{1}<br>{2}",a="{0}<br>{1}";b=c.isdir?String.format(a,_WFT("common","common_filename")+_T("common","colon")+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c.filename)),Ext.util.Format.htmlEncode(_WFT("filetable","filetable_mtime")+_T("common","colon")+(new Date(c.mt*1000)).toLocaleString())):String.format(b,_WFT("common","common_filename")+_T("common","colon")+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c.filename)),Ext.util.Format.htmlEncode(_WFT("common","common_filesize")+_T("common","colon")+Ext.util.Format.fileSize(c.filesize)),Ext.util.Format.htmlEncode(_WFT("filetable","filetable_mtime")+_T("common","colon")+(new Date(c.mt*1000)).toLocaleString()));return b},afterRender:function(){SYNO.FileStation.FolderSharingThumbnailsView.superclass.afterRender.call(this);if(this.keys){this.keymap=new Ext.KeyMap(this.getEl(),this.keys)}},getDefaultSrc:function(){this.defaultSrc=this.RELURL+"../../../../scripts/ext-3/resources/images/default/s.gif";return this.defaultSrc},isSupportExt:function(b){var a=false;Ext.each(this.supportExt,function(c){if(b===c){a=true}},this);return a},isSupportVideoExt:function(b){var a=false;Ext.each(this.defaultSupportVideoExt,function(c){if(b===c){a=true}},this);return a},hasThumbnail:function(a){if(a.mountType==="remotefail"){return""}return this.isSupportExt(a.type.toLowerCase())||this.isSupportVideoExt(a.type.toLowerCase())?this.shadowCls:""},getVideoType:function(a){return this.isSupportVideoExt(a.type.toLowerCase())},getThumbnailURL:function(f){var d=f.icon,a=f.mt,e=this.RELURL,c=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(e+"images/files_ext_256/"+d,"FileType"),g=this.isSupportVideoExt(f.type.toLowerCase());if(f.mountType==="remotefail"){d="remotefailmountpoint.png";return SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(e+"images/files_ext_256/"+d,"FileType")}else{if(f.iconObj&&f.iconObj.url){return f.iconObj.url}}var b=this.isSupportExt(f.type.toLowerCase())||g?Ext.urlAppend(SYNO.API.currentManager.getBaseURL("SYNO.FolderSharing.Thumb","get",1),Ext.urlEncode({path:SYNO.API.EscapeStr(f.path),mt:a,FOLDER_SHARING:this.folderSharingURL})):c;if(b.length>this.ieMaxURLLength){return c}return b},removeListeners:function(a){var b=Ext.get(a);b.removeAllListeners()},onImageLoad:function(c,a,b){var d=Ext.get(a);d.parent().removeClass("thumb-loading");d.parent().addClass(Ext.fly(a).parent().getAttribute("externalcss"));this.resizeThumb(d);d.addClass("fadein")},onImageError:function(a){var c=a.getAttribute("defaulticon"),d=this.RELURL,b=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(d+"images/files_ext_256/"+c,"FileType"),e=Ext.get(a);e.removeClass(this.shadowCls);e.on("error",this.setDefaultIcon,this);a.src=b;a.loaded=undefined},onImageLoadEvent:function(a){Ext.get(a).on("load",this.onImageLoad,this)},setDefaultIcon:function(e,b,d){var f=this.RELURL,c=SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(f+"images/files_ext_256/misc.png","FileType"),a=Ext.get(b);a.removeClass(this.shadowCls);this.onImageLoadEvent(b);b.src=c;a.un("error",this.setDefaultIcon,this)},errorHandler:function(c,a,b){this.onImageError(a)},setImgURL:function(b){var a=this.thumbSizeManager.getThumbSize();this.onImageLoadEvent(b);Ext.fly(b).on("error",this.errorHandler,this);if(b.getAttribute("isvideo")=="true"){a=SYNO.webfm.utils.ThumbSize.LARGE}b.src=Ext.urlAppend(b.getAttribute("thumbnails"),"size="+this.getThumbnailSize(a));b.loaded=a},onLoadItem:function(d){var c=d.select("img"),b,a=this.thumbSizeManager.getThumbSize();if(c.elements.length>0){b=c.elements[0];if(b.loaded!==a&&b.loaded!==SYNO.webfm.utils.ThumbSize.LARGE){this.setImgURL(b)}else{this.resizeThumb(Ext.fly(b))}}},onUnLoadItem:function(a){},removeEvents:function(){var c=this.getTemplateTarget();if(!c){return}var a=Ext.query(".thumb-hover img",c.dom);for(var b=0;b<a.length;b++){this.removeListeners(a[b])}},refresh:function(){this.removeEvents();SYNO.FileStation.FolderSharingThumbnailsView.superclass.refresh.apply(this,arguments)},onDestroy:function(){this.removeEvents();SYNO.FileStation.FolderSharingThumbnailsView.superclass.onDestroy.apply(this,arguments)}});Ext.ns("SYNO.SDS.App.FileStation3");SYNO.SDS.App.FileStation3=Ext.extend(SYNO.SDS.AppWindow,{notifyArr:[],constructor:function(b){var c=480;var a=360;SYNO.SDS.App.FileStation3.superclass.constructor.call(this,Ext.apply({monitorResize:true,showHelp:true,width:920,height:560,minWidth:c,minHeight:a,boxMinHeight:a,boxMinWidth:c,closable:true,minimizable:true,maximizable:true,resizable:true,autoScroll:false,layout:"fit",dsmStyle:"v5",cls:"syno-sds-fs-win",tbar:[],listeners:{show:{fn:function(){this.onAfterShow()},scope:this},beforeclose:{fn:function(){this.panelObj.beforeClose()},scope:this},close:{fn:function(){this.appInstance.setUserSettings("activeViewItemId",this.panelObj.getCurrentViewItemId());this.appInstance.setUserSettings("activeViewSize",this.panelObj.getCurrentViewSize());this.sendFileTaskNotify(true)},scope:this}}},b));this.shouldCreatePanel=true},initPanel:function(){this.createPanels();this.add(this.panelObj);this.doLayout();this.getEl().unmask();var a=new SYNO.FileStation.SearchFormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,jsConfig:this.jsConfig,RELURL:this.jsConfig.jsBaseURL+"/webfm/",webfm:this.panelObj,hidden:true,owner:this});this.panelObj.searchPanel=a;this.bindEvents(a);this.bindClickEvents();this.panelObj.blShown=true;this.fireEvent("onContentReady")},bindClickEvents:function(){var a=this.panelObj;a.viewPanel.el.on("click",function(b){if(a.activeView.itemId==="fileGrid"){if(b.target.hasClassName("webfm-listview-grid-panel")){a.grid.getSelectionModel().clearAllSelections()}}})},onGetPortalURLDone:function(a,b){if(a===true){this.curPortalUrl=b}},getPortalUrlTask:function(){SYNO.SDS.QuickConnect.Utils.getPortalUrl(SYNO.SDS.QuickConnect.Utils.TYPES.DIRECT,this.onGetPortalURLDone,this)},onAfterShow:function(){if(this.shouldCreatePanel){this.getEl().mask(_WFT("common","loading"),"x-mask-loading");this.initPanel.defer(100,this);this.shouldCreatePanel=false}if(this.panelObj){this.panelObj.blShown=true}this.getPortalUrlTask()},createPanels:function(){var a=new SYNO.FileStation.WindowPanel({region:"center",appInstance:this.initialConfig.appInstance,appWindow:this,jsConfig:this.jsConfig,RELURL:this.jsConfig.jsBaseURL+"/webfm/",owner:this});this.topToolbar=this.createToolbar(a.getToolbar());if(this.tbar&&this.topToolbar){this.topToolbar.ownerCt=this;this.topToolbar.render(this.tbar)}a.registerOwner(this);a.registerFileAction();this.panelObj=a},bindEvents:function(b){var d=0,c=["beforeclose","maximize","minimize"],a=function(){b.hide()};Ext.EventManager.on(window,"unload",function(){this.sendFileTaskNotify(false);b.onCleanSearch(false)},this);SYNO.SDS.StatusNotifier.on("logout",function(){this.sendFileTaskNotify(false);b.onCleanSearch(false)},this);for(d=0;d<c.length;d++){b.mon(this,c[d],a,b)}},sendFileTaskNotify:function(b,a){var c;c=new Ajax.Request(this.jsConfig.jsBaseURL+"/webfm/webUI/notify.cgi",{asynchronous:b,requestTimeout:b?30:10,method:"POST",parameters:{action:(b&&Ext.isDefined(a))?"one":"all",taskid:a}})},FileTaskNotify:function(b,a){var c;c=new Ajax.Request(this.jsConfig.jsBaseURL+"/webfm/webUI/notify.cgi",{asynchronous:b,requestTimeout:b?30:10,method:"POST",parameters:{action:b?"one":"all",taskid:a}})},getPanelInstance:function(){return this.panelObj},onOpen:function(a){SYNO.SDS.App.FileStation3.superclass.onOpen.apply(this,arguments);this.onOpenDir(a)},onRequest:function(a){SYNO.SDS.App.FileStation3.superclass.onRequest.apply(this,arguments);this.onOpenDir(a)},onOpenDir:function(a){if(a&&a.opendir){if(!this.panelObj){this.mon(this,"onContentReady",function(){this.panelObj.onGoToFolder(a.opendir)},this,{single:true})}else{this.panelObj.onGoToFolder(a.opendir)}}else{if(a&&a.openfile){if(!this.panelObj){this.mon(this,"onContentReady",function(){this.panelObj.onGoToFile(a.openfile)},this,{single:true})}else{this.panelObj.onGoToFile(a.openfile)}}}if(a&&a.windowState){if(!this.panelObj){this.mon(this,"onContentReady",function(){this.restoreViewMode(a.windowState)})}else{this.restoreViewMode(a.windowState)}}else{var b={activeViewItemId:this.appInstance.getUserSettings("activeViewItemId"),activeViewSize:this.appInstance.getUserSettings("activeViewSize")};if(!this.panelObj){this.mon(this,"onContentReady",function(){this.restoreViewMode(b)})}else{this.restoreViewMode(b)}}},restoreViewMode:function(d){var b=d.activeViewItemId,e=d.activeViewSize,a,c;if(b==="thumbnailView"){b+=e}a=this.panelObj.btnViewMode;c=a.menu.getComponent(b);if(!c){return}c.fireEvent("click")},getStateParam:function(){var a=SYNO.SDS.App.FileStation3.superclass.getStateParam.apply(this,arguments);Ext.apply(a,{activeViewItemId:this.panelObj.getCurrentViewItemId(),activeViewSize:this.panelObj.getCurrentViewSize()});return a},getGrid:function(){return this.panelObj.grid},getThumbnailView:function(){return this.panelObj.thumbnailView},onDestroy:function(){SYNO.SDS.App.FileStation3.superclass.onDestroy.apply(this,arguments);this.getGrid().dddrop.removeFromGroup(this.getGrid().ddGroup);this.getThumbnailView().dddrop.removeFromGroup(this.getThumbnailView().ddGroup)}});SYNO.SDS.App.FileStation3.Instance=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.App.FileStation3"});Ext.define("SYNO.SDS.Snapshot.HistoryWindow",{extend:"SYNO.SDS.ModalWindow",SNAPSHOT_TOP_FOLDER:"#snapshot",constructor:function(a,c){this.grid=this.initGrid(c);this.goBtn=new SYNO.ux.Button({text:_T("filebrowser","snapshot_go"),scope:this,disabled:true,btnStyle:"blue",handler:function(){var e=this.grid.selModel.getSelections();if(e.length!==1){return}var g=this.owner,f=e[0].get("stime"),i=c.data.path,d=i.substring(1,i.length).split("/"),h;d.splice(1,0,this.SNAPSHOT_TOP_FOLDER,f);h="/"+d.join("/");g.panelObj.onGoToFile(h);this.close()}});var b={owner:a.owner,width:420,title:_T("filebrowser","view_snapshot_history"),closable:true,layout:"fit",items:this.grid,buttons:[this.goBtn]};this.callParent([b]);this.mon(this.grid,"viewready",function(){this.grid.view.updateScroller()},this)},initGrid:function(b){var a=new SYNO.SDS.Snapshot.HistoryGrid({path:b.data.path});return a}});Ext.define("SYNO.SDS.Snapshot.HistoryGrid",{extend:"SYNO.ux.GridPanel",constructor:function(c){this.createStore(c);this.recPath=c.path;var e=function(h,f){var g=(new Date(h)).toLocaleString();f.attr='ext:qtip="'+g+'"';return g};var d=function(g,f){var h=Ext.util.Format.htmlEncode(SYNO.webfm.utils.snapshotTimeRenderer(g));f.attr='ext:qtip="'+Ext.util.Format.htmlEncode(h)+'"';return h};var b=[{header:_T("filebrowser","snapshot"),dataIndex:"stime",width:180,renderer:d},{header:_WFT("filetable","filetable_mtime"),dataIndex:"mtime",id:"mtime",width:220,renderer:e}];var a=Ext.apply({title:_T("filebrowser","snapshot"),layout:"fit",store:this.store,width:400,autoExpandColumn:"mtime",colModel:new Ext.grid.ColumnModel({defaults:{align:"left"},columns:b}),selModel:new Ext.grid.RowSelectionModel({singleSelect:true}),listeners:{cellclick:{fn:function(f,g){f.ownerCt.goBtn.enable()}}},view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:26,borderHeight:1,cacheSize:100,forceFit:true})},c);this.callParent([a]);this.store.load({path:a.path,callback:this.onLoad,scope:this})},onLoad:function(c,b,a){if(c.length===0){this.mask(_T("filebrowser","snapshot_no_history"))}},createStore:function(a){this.store=new Ext.data.Store({proxy:new SYNO.API.Proxy({api:"SYNO.FileStation.Snapshot",method:"history",version:1}),reader:new Ext.data.JsonReader({root:"items",id:"mtime"},[{name:"mtime"},{name:"stime"}]),baseParams:{path:a.path}})}});