/* All rights reserved. */

Ext.define("SYNO.SDS.HA.HABindWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",hostname:null,binding_progress_desc:null,binding_progress:null,PollTask:null,groupInfo:null,PanelWelcome:null,PanelNodeSetup:null,PanelSummary:null,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_TT("SYNO.SDS.HA.Instance","wizard","welcome_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc"),itemId:"welcome",nextId:"nodesetup",owner:this,getNext:function(){var d={};this.owner.setStatusBusy();d.action="wizard_first_check";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(d),success:function(e,f){var g=Ext.decode(e.responseText);this.owner.clearStatusBusy();if(g.success){this.owner.goNext(this.nextId)}else{var h="";if(g.errinfo.app){h=_TT("SYNO.SDS.HA.Instance",g.errinfo.sec,g.errinfo.key);if("service_not_supported_active"===g.errinfo.key){h+="<br>"+_T("network","proxy_enabled")}}else{h=_T(g.errinfo.sec,g.errinfo.key)}this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),h);return false}},failure:function(e,f){this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","error_unknown"));SYNO.Debug("Ajax load failure "+e.responseText);return false},scope:this});return false}});this.PanelNodeSetup=new a.NodeSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_desc"),itemId:"nodesetup",nextId:"summary",header:false,owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({autoScroll:true,headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote"),function(d){if("yes"===d){this.owner.applySetting();return false}return false},this);return false},owner:this});var b=[this.PanelWelcome,this.PanelNodeSetup,this.PanelSummary];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:600,height:490,steps:b},c)])},genApplyParams:function(){var a={};a.action="activate_ha";a.mode="bind_remote";a.is_hybrid=this.groupInfo.is_hybrid;a.group_name=this.groupInfo.group_name;a.model0=this.groupInfo.model0;a.model1=this.groupInfo.model1;a.lan_num=this.groupInfo.lan_num;a.remote_address=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());return Ext.util.JSON.encode(a)},updateBindingProgress:function(b,a){var c=Ext.decode(b.responseText);this.el.unmask();if(c.success){this.binding_progress_desc=c.binding_progress_desc;this.binding_progress=c.binding_progress}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},bindRemoteDone:function(b,r,p){this.el.unmask();if(r){var j=Ext.decode(p.responseText);var f="";var q;var g="";var o=0;var l=0;var e=0;var h=0;if(j.disk_validation){q=j.disk_validation;if(q.error_size){o=q.error_size.length}if(q.error_type){l=q.error_type.length}if(q.error_log_sect_size){e=q.error_log_sect_size.length}}if(null!==j&&true===j.success){this.PollTask=this.addAjaxTask({preventHalt:true,interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_binding_progress"},success:this.updateBindingProgress,failure:function(i,s){SYNO.Debug("Ajax load failure "+i.responseText)},scope:this});this.PollTask.start(true);this.waitForBinding({times:1800000/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_response")})}else{if(j.errinfo){if(j.errinfo.sec==="wizard"&&j.errinfo.key==="error_volume_number"){var n=_D("max_ha_spacecount");var k=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_volume_number"),n);this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),k)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",j.errinfo.sec,j.errinfo.key))}}else{if(0<o||0<l||0<e){for(h=0;h<o;h++){if(h===0){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_size"))+"<br>";f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_size[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_size[h])}}if(""!==f&&0<l){f=f+"<br>"}for(h=0;h<l;h++){if(h===0){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_type"))+"<br>"}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_type"))+"<br>"}f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_type[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_type[h])}}if(""!==f&&0<e){f=f+"<br>"}for(h=0;h<e;h++){if(h===0){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_log_sect_size"))+"<br>"}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_log_sect_size"))+"<br>"}f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_log_sect_size[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_size[h])}}if(""!==f){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),f)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}else{if(!j.link_aggr_valid&&(0<j.link_aggr_conflict_if.length)){if(""!==f){f+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","error_link_aggr_conflict")+"<br>"}else{f+=_TT("SYNO.SDS.HA.Instance","wizard","error_link_aggr_conflict")+"<br>"}for(h=0;h<j.link_aggr_conflict_if.length;h++){if(h===0){f+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.link_aggr_conflict_if[h]])}else{f+=", "+SYNO.SDS.Utils.Network.idToString.apply(this,[j.link_aggr_conflict_if[h]])}}}if(!j.vlan_valid&&(0<j.vlan_conflict_if.length)){if(""!==f){f+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","error_vlan_conflict")+"<br>"}else{f+=_TT("SYNO.SDS.HA.Instance","wizard","error_vlan_conflict")+"<br>"}for(h=0;h<j.vlan_conflict_if.length;h++){if(h===0){f+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.vlan_conflict_if[h]])}else{f+=", "+SYNO.SDS.Utils.Network.idToString.apply(this,[j.vlan_conflict_if[h]])}}}if(!j.swap_valid){if(""!==f){f+="<br>"}f+=_TT("SYNO.SDS.HA.Instance","wizard","error_swap_setting")}if(0<j.passive_disabled_if.length){if(""!==f){f+="<br>"}var c="";for(h=0;h<j.passive_disabled_if.length;h++){c+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_disabled_if[h]])}f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_if_disabled"),c)}var d=false;var m=false;if(j.active_node&&j.active_node.drbdip_conflict){d=true}if(j.passive_node&&j.passive_node.drbdip_conflict){m=true}if(d||m){var a="";if(""!==f){f+="<br>"}if(d){for(h=0;h<j.active_node.conflict_ip.size();h++){if(""!==a){a+=", "}a+=j.active_node.conflict_ip[h]}}if(m){for(h=0;h<j.passive_node.conflict_ip.size();h++){if(""!==a){a+=", "}a+=j.passive_node.conflict_ip[h]}}f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_drbdip_conflict"),a)}if(j.active_dhcp){if(""!==f){f+="<br>"}if(j.active_dhcp_haif){f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_dhcp_haif]))}if(""!==f){f+="<br>"}if(j.active_dhcp_drbdif){f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_dhcp_drbdif]))}}if(j.passive_dhcp){if(j.passive_dhcp_haif){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_dhcp_haif]))}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_dhcp_haif]))}}}if(!j.passive_directconnect){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_direct_connect"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_directconnect_if]))}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_direct_connect"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_directconnect_if]))}}if(j.passive_node.shr_enable){if(""!==f){f+="<br>"}f+=_TT("SYNO.SDS.HA.Instance","overview","desc_shr_not_supported_passive")}if(j.active_firewall_err){g="";for(h=0;h<j.active_firewall_err_ifs.size();h++){g+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_firewall_err_ifs[h]])+" "}if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_firewall"),g)}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_firewall"),g)}}if(j.passive_firewall_err){g="";for(h=0;h<j.passive_firewall_err_ifs.size();h++){g+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_firewall_err_ifs[h]])+" "}if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_firewall"),g)}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_firewall"),g)}}if(j.active_node){for(h=0;h<j.active_node.none_supported_services.length;h++){if(h===0){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_active")}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_active")}f=f+_TT("SYNO.SDS.HA.Instance","overview",j.active_node.none_supported_services[h])}else{f=f+", "+_TT("SYNO.SDS.HA.Instance","overview",j.active_node.none_supported_services[h])}}}if(j.passive_node){for(h=0;h<j.passive_node.none_supported_services.length;h++){if(h===0){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_passive")}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_passive")}f=f+_TT("SYNO.SDS.HA.Instance","overview",j.passive_node.none_supported_services[h])}else{f=f+", "+_TT("SYNO.SDS.HA.Instance","overview",j.passive_node.none_supported_services[h])}}}if(""!==f){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),f)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}}}}else{if(-1===p.status){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("download","download_task_timeout"))}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}},waitForBinding:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if("stage_binding_done"===this.binding_progress_desc){this.PollTask.stop();this.scope.PollTask.start(true);window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close();return}else{if("stage_binding_failed"===this.binding_progress_desc){this.PollTask.stop();this.scope.PollTask.start(true);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}}if(0===a){this.PollTask.stop();this.scope.PollTask.start(true);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}var f=_TT("SYNO.SDS.HA.Instance","wizard",this.binding_progress_desc)||d.msg;SYNO.SDS.Desktop.getMsgBox().updateProgress((1-a/e)/2+this.binding_progress/200,f,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));c.defer(b,this)};c.defer(b,this)},CheckHeartbeatLinkDone:function(c,e,b){if(e&&b.responseText){var a=Ext.util.JSON.decode(b.responseText);var d="";if(!a.success){if(""!==a.errinfo.key){d=_TT(a.errinfo.app,a.errinfo.sec,a.errinfo.key);this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}this.el.unmask();return}this.sendRequest()}},CheckHeartbeatLink:function(){var a={};a.action="check_heartbeat_link";a["interface"]="";a.remote_addr=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());this.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode(a),method:"POST",callback:this.CheckHeartbeatLinkDone,scope:this},this)},sendRequest:function(){var a=this.genApplyParams();SYNO.SDS.StatusNotifier.fireEvent("halt");Ext.Ajax.request({timeout:300000,url:SYNO.SDS.HA.CONF_CGI_PATH,params:a,callback:this.bindRemoteDone,scope:this})},applySetting:function(){this.CheckHeartbeatLink()},Show:function(a){this.open()}});Ext.define("SYNO.SDS.HA.Instance",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.HA.HAMainWindow"});Ext.define("SYNO.SDS.HA.HAMainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.HA.HAPanelOverview",skipDirtyCheck:false,funcToHelp:{general:"HAManager/overview.html","SYNO.SDS.HA.HAPanelOverview":"HAManager/overview.html","SYNO.SDS.HA.HAPanelConfig":"HAManager/network.html","SYNO.SDS.HA.HAPanelService":"HAManager/service.html","SYNO.SDS.HA.HAPanelSpaceStatus":"HAManager/storage.html","SYNO.SDS.HA.HAPanelDiskStatus":"HAManager/disk.html","SYNO.SDS.HA.HAPanelLogView":"HAManager/overview.html"},constructor:function(a){this.callParent([this.fillConfig(a)])},fillConfig:function(a){var b={width:SYNO.SDS.HA.CONF_DEFAULT_WIDTH,height:SYNO.SDS.HA.CONF_DEFAULT_HEIGHT,minWidth:SYNO.SDS.HA.CONF_DEFAULT_WIDTH,minHeight:SYNO.SDS.HA.CONF_DEFAULT_HEIGHT,listItems:[{text:_TT("SYNO.SDS.HA.Instance","ui","overview"),iconCls:"syno-ha-list-overview",fn:"SYNO.SDS.HA.HAPanelOverview"},{text:_TT("SYNO.SDS.HA.Instance","ui","network_setting"),iconCls:"syno-ha-list-networkConfig",fn:"SYNO.SDS.HA.HAPanelConfig"},{text:_TT("SYNO.SDS.HA.Instance","ui","service_monitor"),iconCls:"syno-ha-list-monitoring",fn:"SYNO.SDS.HA.HAPanelService"},{text:_TT("SYNO.SDS.HA.Instance","ui","storage_status"),iconCls:"syno-ha-list-space",fn:"SYNO.SDS.HA.HAPanelSpaceStatus"},{text:_TT("SYNO.SDS.HA.Instance","ui","disk_status"),iconCls:"syno-ha-list-disk",fn:"SYNO.SDS.HA.HAPanelDiskStatus"},{text:_TT("SYNO.SDS.HA.Instance","ui","log_view"),iconCls:"syno-ha-list-log",fn:"SYNO.SDS.HA.HAPanelLogView"}]};Ext.apply(b,a);return b},onBeforeSelect:function(b,c,d){if("SYNO.SDS.HA.HAPanelOverview"!==c.id&&true!==SYNO.SDS.HA.HAEnabled){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_ha_not_enabled"));return false}if(!this.skipDirtyCheck){if(d&&d.leaf){var a=this.pageCt.getComponent(d.attributes.fn);if(a&&Ext.isFunction(a.isDirty)&&a.isDirty()){this.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","confirm_lostchange"),function(e){if("yes"===e){this.skipDirtyCheck=true;this.selectPage(c.attributes.fn);this.skipDirtyCheck=false}},this);return false}}}return this.callParent(arguments)},getHelpParam:function(){var a=this.activePage.itemId;var b=this.funcToHelp[a]||this.funcToHelp.general;return b}});Ext.define("SYNO.SDS.HA.ManageMenuPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_title"),name:"mode",inputValue:0,disabled:!b.canShutdownHA&&!b.canShutdownActive&&!b.canShutdownPassive},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_content")},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_title"),name:"mode",inputValue:1},{xtype:"syno_displayfield",indent:1,value:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_content")}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if("mode"===d.name&&!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getNext:function(){if(!this.getForm().isValid()){return false}var a=this.getForm().getValues().mode;return this.nextId[a]}});Ext.define("SYNO.SDS.HA.ManageHWPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","move_both_servers"),name:"mode",inputValue:0,disabled:!b.canShutdownHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_ram_nic"),name:"mode",inputValue:1,disabled:!b.canShutdownHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","replace_active_component"),name:"mode",inputValue:2,disabled:!b.canShutdownActive},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","replace_passive_component"),name:"mode",inputValue:3,disabled:!b.canShutdownPassive}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if(!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},saveSettings:function(){this.owner.opCode=this.getForm().getValues().mode},getNext:function(){if(!this.getForm().getValues().mode){return false}this.saveSettings();return this.nextId}});Ext.define("SYNO.SDS.HA.ManageClusterPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","switch_server_desc"),name:"mode",inputValue:0,disabled:!b.canSwitchOver},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_dsm_desc"),name:"mode",inputValue:1,disabled:!b.canUpgradeDSM},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_desc"),name:"mode",inputValue:2,disabled:!b.canRemoveHA},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","bind_passive_desc"),name:"mode",inputValue:3,disabled:!b.canBindPassive},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","unbind_passive_desc"),name:"mode",inputValue:4,disabled:!b.canUnbindPassive},{xtype:"syno_radio",disabled:!_S("ha_safemode"),boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","handle_splitbrain_desc"),name:"mode",inputValue:5}]}]};var e=a.items[0].items.length;for(var c=0;c<e;++c){var d=a.items[0].items[c];if(!d.disabled){d.checked=true;break}}SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},saveSettings:function(){this.owner.opCode=100+this.getForm().getValues().mode},getNext:function(){if(!this.getForm().getValues().mode){return false}this.saveSettings();return this.nextId}});Ext.define("SYNO.SDS.HA.SplitBrainHandlerPanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a={padding:"0px",items:[{columns:1,hideLabel:true,itemId:"option",border:false,items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync")+'<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync_warn")+"</font>"},{xtype:"syno_radio",disabled:!b.canSetSBRole,boxLabel:String.format(_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync_login"),b.loginSN,b.loginHostname),name:"mode",inputValue:0,indent:1},{xtype:"syno_radio",disabled:!b.canSetSBRole,boxLabel:String.format(_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync_remote"),b.remoteSN,b.remoteHostname),name:"mode",inputValue:1,indent:1},{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync")+'<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync_warn")+"</font>"},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync_unbind_remote"),name:"mode",inputValue:2,indent:1},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync_unbind_local"),name:"mode",inputValue:3,indent:1},{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_deactivate")},{xtype:"syno_radio",boxLabel:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_deactivate"),name:"mode",inputValue:4,indent:1}]}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},saveSettings:function(){this.owner.opCode=1000+this.getForm().getValues().mode},getNext:function(){if(!this.getForm().getValues().mode){return false}this.saveSettings();return this.nextId}});Ext.define("SYNO.SDS.HA.ApplyPanel",{extend:"SYNO.ux.FormPanel",action:"",actionList:{0:"shutdown_ha",1:"shutdown_ha",2:"shutdown_active",3:"shutdown_passive",1000:"switchover",1001:"upgrade",1002:"disable_ha",1003:"bind_passive",1004:"unbind_passive",10000:"sb_local_active",10001:"sb_local_passive",10002:"unbind_remote",10003:"unbind_local",10004:"disable_ha"},descList:{0:_TT("SYNO.SDS.HA.Instance","wizard","move_server_steps"),1:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_ram_nic_steps"),2:_TT("SYNO.SDS.HA.Instance","wizard","replace_active_component_steps"),3:_TT("SYNO.SDS.HA.Instance","wizard","replace_passive_component_steps"),1000:_TT("SYNO.SDS.HA.Instance","wizard","switch_server_steps"),1001:_TT("SYNO.SDS.HA.Instance","wizard","upgrade_dsm_steps"),1002:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_steps"),1003:_TT("SYNO.SDS.HA.Instance","wizard","bind_passive_steps"),1004:_TT("SYNO.SDS.HA.Instance","wizard","unbind_passive_steps"),10000:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync_steps"),10001:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_diffsync_steps"),10002:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync_steps"),10003:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_fullsync_steps"),10004:_TT("SYNO.SDS.HA.Instance","wizard","remove_cluster_steps")},btnTextList:{0:_TT("SYNO.SDS.HA.Instance","button","shut_down"),1:_TT("SYNO.SDS.HA.Instance","button","shut_down"),2:_TT("SYNO.SDS.HA.Instance","button","shut_down"),3:_TT("SYNO.SDS.HA.Instance","button","shut_down"),1000:_TT("SYNO.SDS.HA.Instance","ui","switch_server"),1001:_TT("SYNO.SDS.HA.Instance","button","go"),1002:_TT("SYNO.SDS.HA.Instance","button","remove"),1003:_TT("SYNO.SDS.HA.Instance","button","go"),1004:_TT("SYNO.SDS.HA.Instance","button","unbind"),10000:_TT("SYNO.SDS.HA.Instance","button","sync"),10001:_TT("SYNO.SDS.HA.Instance","button","sync"),10002:_TT("SYNO.SDS.HA.Instance","button","go"),10003:_TT("SYNO.SDS.HA.Instance","button","go"),10004:_TT("SYNO.SDS.HA.Instance","button","remove")},constructor:function(b){var a={cls:"syno-ha-wizard-panel",items:[{xtype:"syno_displayfield",id:this.applyPanelTextID=Ext.id(),value:""}]};this.descList[10000]=String.format(this.descList[10000],b.loginSN,b.loginHostname,b.remoteSN,b.remoteHostname);this.descList[10001]=String.format(this.descList[10001],b.remoteSN,b.remoteHostname,b.loginSN,b.loginHostname);this.descList[10002]=String.format(this.descList[10002],b.loginSN,b.loginHostname,b.remoteSN,b.remoteHostname);this.descList[10003]=String.format(this.descList[10003],b.remoteSN,b.remoteHostname,b.loginSN,b.loginHostname);SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){var a=this.owner.opCode;var b=this.descList[a];Ext.getCmp(this.applyPanelTextID).setValue(b);this.action=this.actionList[a]},checkState:function(){var a=this.owner.opCode;SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);this.owner.getButton("next").setText(this.btnTextList[a])},getNext:function(){if(!this.getForm().isValid()){return false}if("switchover"===this.action){this.scope.switchOver()}else{if("upgrade"===this.action){this.scope.doUpgrade()}else{if("disable_ha"===this.action){this.scope.changeHAStatus()}else{if("bind_passive"===this.action){this.scope.maintainRemote()}else{if("unbind_passive"===this.action){this.scope.maintainRemote()}else{if("shutdown_ha"===this.action){this.scope.shutdownHA()}else{if("shutdown_active"===this.action){this.scope.shutdownActive()}else{if("shutdown_passive"===this.action){this.scope.shutdownPassive()}else{if("sb_local_active"===this.action){this.scope.SBSetLocalRole("active")}else{if("sb_local_passive"===this.action){this.scope.SBSetLocalRole("passive")}else{if("unbind_remote"===this.action){this.scope.SBunbind("remote")}else{if("unbind_local"===this.action){this.scope.SBunbind("local")}}}}}}}}}}}}this.owner.close();return false}});Ext.define("SYNO.SDS.HA.HAManageWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",PanelManageMenu:null,PanelManageHW:null,PanelManageCluster:null,PanelApply:null,opCode:0,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelManageMenu=new a.ManageMenuPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_menu_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_menu_desc"),itemId:"managemenu",nextId:["managehw","managecluster"],header:false,canShutdownHA:c.canShutdownHA,canShutdownActive:c.canShutdownActive,canShutdownPassive:c.canShutdownPassive,owner:this});this.PanelManageHW=new a.ManageHWPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_hardware_desc"),itemId:"managehw",nextId:"apply",header:false,canShutdownHA:c.canShutdownHA,canShutdownActive:c.canShutdownActive,canShutdownPassive:c.canShutdownPassive,canBeepOffPassive:c.canBeepOffPassive,owner:this});this.PanelManageCluster=new a.ManageClusterPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_desc"),itemId:"managecluster",nextId:_S("ha_safemode")?"splitbrainhandler":"apply",header:false,canSwitchOver:c.canSwitchOver,canUpgradeDSM:c.canUpgradeDSM,canRemoveHA:c.canRemoveHA,canBindPassive:c.canBindPassive,canUnbindPassive:c.canUnbindPassive,owner:this});this.PanelSplitBrainHandler=new a.SplitBrainHandlerPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","manage_cluster_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","split_brain_handler_desc"),itemId:"splitbrainhandler",nextId:"apply",header:false,loginSN:c.loginSN,loginHostname:c.loginHostname,remoteSN:c.remoteSN,remoteHostname:c.remoteHostname,canSetSBRole:c.canSetSBRole,owner:this});this.PanelApply=new a.ApplyPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","apply_setting_title"),itemId:"apply",nextId:null,header:false,scope:c.scope,loginSN:c.loginSN,loginHostname:c.loginHostname,remoteSN:c.remoteSN,remoteHostname:c.remoteHostname,owner:this});var b=[this.PanelManageMenu,this.PanelManageHW,this.PanelManageCluster,this.PanelSplitBrainHandler,this.PanelApply];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:600,height:490,steps:b},c)])},Show:function(){this.open()}});Ext.define("SYNO.SDS.HA.HAPanelConfig",{extend:"SYNO.ux.FormPanel",mainPanel:null,PollTask:null,constructor:function(a){this.mainPanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:_TT("SYNO.SDS.HA.Instance","config","general"),mode:"general"});this.leftNodePanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:"     ",mode:"left_node"});this.rightNodePanel=new SYNO.SDS.HA.HAIPListPanel({appWin:a.appWin,owner:this,title:"     ",mode:"right_node"});this.appWin=a.appWin;this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:[this.mainPanel,this.leftNodePanel,this.rightNodePanel]});var b={border:false,itemId:"networkConfig",layout:"fit",style:"padding: 0;",cls:"syno-ha-config-detail",items:[this.tabpanel]};this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},onPageActivate:function(){this.tabpanel.setActiveTab(0);this.loadNetConfig(true);if(!this.PollTask){this.PollTask=this.addAjaxTask({interval:15000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"load_network",reload:false}),success:this.loadNetConfigDone,failure:function(a,b){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}this.PollTask.start(false)},onPageDeactivate:function(){this.PollTask.stop();this.mainPanel.getSelectionModel().clearSelections();this.leftNodePanel.getSelectionModel().clearSelections();this.rightNodePanel.getSelectionModel().clearSelections()},loadNetConfigDone:function(c,a){var f=Ext.decode(c.responseText);var d=Ext.decode(a.params);var b=0;var h=[];var e=null;var g=0;var j=0;this.appWin.clearStatusBusy();if(f.success){b=f.general.interface_num;h.items=[];var k=[];for(g=0;g<SYNO.SDS.HA.CONF_MAX_HA_IF_NUM;g++){if(""!==f.general.ha_networks[g].bond_if&&f.general.drbd_if!==f.general.ha_networks[g].bond_if){k[j]={};k[j]["if"]=f.general.ha_networks[g].bond_if;k[j].ip=f.general.ha_networks[g].bond_ip;k[j].mask=f.general.ha_networks[g].bond_mask;k[j].enabled=f.general.ha_networks[g].bond_enabled;k[j].connection=f.general.ha_networks[g].bond_connection;k[j].data_id=f.general.ha_networks[g].bond_if.replace(/(\w+)(\.\d+|)/g,"$1");h.items.push(k[j]);j++}}for(g=0;g<b;g++){if(!f.general.eth_is_slave_device[g]&&!f.general.eth_is_masked[g]&&f.general.drbd_if!==f.general.ha_networks[g]["if"]){k[j]={};k[j]["if"]=f.general.ha_networks[g]["if"];k[j].ip=f.general.ha_networks[g].ip;k[j].mask=f.general.ha_networks[g].mask;k[j].enabled=f.general.ha_networks[g].enabled;k[j].connection=f.general.ha_networks[g].connection;k[j].data_id=f.general.ha_networks[g]["if"].replace(/(\w+)(\.\d+|)/g,"$1");h.items.push(k[j]);j++}}if(this.mainPanel.IPListStore.getCount()!==h.items.length||true===d.reload){this.mainPanel.IPListStore.loadData(h,false)}else{for(g=0;g<h.items.length;g++){e=null;e=this.mainPanel.IPListStore.getById(h.items[g].data_id);if(e){e.set("if",h.items[g]["if"]);e.set("connection",h.items[g].connection);e.set("enabled",h.items[g].enabled);e.set("ip",h.items[g].ip);e.set("mask",h.items[g].mask)}else{this.mainPanel.IPListStore.loadData(h,false);break}}}this.mainPanel.HAHostname=f.general.ha_hostname;this.mainPanel.defaultGateway=f.general.default_gateway;this.mainPanel.DNS=f.general.dns;this.mainPanel.DNS2=f.general.dns2;this.mainPanel.isStaticDNS=f.general.is_static_dns;this.mainPanel.HAMainInterface=f.general.ha_if_main;this.mainPanel.HADrbdInterface=f.general.drbd_if;this.leftNodePanel.columnModel.setHidden(4,true);this.rightNodePanel.columnModel.setHidden(4,true);if(""!==f.general.lnode_name&&f.general.lnode_online){this.leftNodePanel.setTitle(f.general.lnode_name);this.leftNodePanel.enable()}else{if(!f.general.lnode_online){this.leftNodePanel.setTitle(f.general.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}if(""!==f.general.rnode_name&&f.general.rnode_online){this.rightNodePanel.setTitle(f.general.rnode_name);this.rightNodePanel.enable()}else{if(!f.general.rnode_online){this.rightNodePanel.setTitle(f.general.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}h.items=f.lnode;if(this.leftNodePanel.IPListStore.getCount()!==h.items.length||!this.leftNodePanel.getSelectionModel().getSelected()){this.leftNodePanel.IPListStore.loadData(h,false);this.leftNodePanel.IPListStore.commitChanges()}h.items=f.rnode;if(this.rightNodePanel.IPListStore.getCount()!==h.items.length||!this.rightNodePanel.getSelectionModel().getSelected()){this.rightNodePanel.IPListStore.loadData(h,false);this.rightNodePanel.IPListStore.commitChanges()}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},locationGet:function(){var b=window.location.toString();var a=b.indexOf("#");if(-1===a||a===b.length-1){return""}else{return b.substr(a+1)}},locationCheck:function(b,a){var d=this.locationGet();var c=document.createElement("iframe");if(""!==d){window.location=a;return true}else{if(50>this.tryAddrCount){this.tryAddrCount++;c.width="0px";c.height="0px";c.src=b+"info.cgi?host="+window.location.href;document.getElementsByTagName("body")[0].appendChild(c);this.locationCheck.defer(5000,this,[b,a]);return}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","ui","timeout"));return false},redirect:function(a,d){var c=d||20000;var b=0;if(!Ext.isString(a)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var e=function(){location.assign(a)};e.defer(c,this);for(b=0;b<3;b++){c+=10000;e.defer(c,this)}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:c/1000,msg:_T("tcpip","connect_new_ip")})},waitingBox:function(e){var f=e.times||10;var b=f;var a=Ext.isDefined(e.no_close)?e.no_close:true;var c=e.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,width:e.width||240,progress:true,closable:false});var d=function(){b--;if(0===b&&!a){if(Ext.isFunction(e.callback)){e.callback.call(e.scope||this)}SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===b){b=f}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-b/f,_T("tcpip","connect_new_ip"));d.defer(c,this)};d.defer(c,this)},loadNetConfig:function(a){this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode({action:"load_network",reload:a}),method:"POST",success:this.loadNetConfigDone,failure:function(c,b){this.appWin.clearStatusBusy()},scope:this},this)},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.HA.HAIPListPanel",{extend:"SYNO.ux.EditorGridPanel",IPListStore:null,columnModel:null,toolbar:null,HAMainInterface:null,constructor:function(a){this.initForm(a);var b={title:a.title,owner:a.owner,store:this.IPListStore,tbar:this.toolbar,border:false,cls:"syno-ha-config-ip-list-detail",colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true,moveEditorOnEnter:false}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b])},initForm:function(c){var e;if("general"===c.mode){e="data_id"}else{e="node_if"}var d=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:e},["if","enabled","ip","connection","type","mask","desc","data_id"]),sortInfo:{field:"if",direction:"ASC"},remoteSort:false});this.IPListStore=d;if("general"===c.mode){var b=[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","config","change_cluster_setting"),handler:this.onChangeClusterSetting,disabled:_S("ha_safemode"),scope:this}];this.toolbar=b}var a;if("general"===c.mode){a=this.createEnumHAIPColumn()}else{a=this.createColumn()}this.columnModel=a},createEnumHAIPColumn:function(){var b=this;var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),dataIndex:"if",width:0.15,align:"left",renderer:function(e){var c=e.replace(/\w+(\.\d+|)/g,"$1");var d=SYNO.SDS.Utils.Network.idToString.apply(b,[e]);if(""!==c){d=d+" "+String.format(_TT("SYNO.SDS.HA.Instance","config","vlan_id"),c.replace(".",""))}return d}},{header:_TT("SYNO.SDS.HA.Instance","config","connection"),dataIndex:"connection",id:"connection",width:0.15,align:"left",renderer:function(c){if("connected"===c){return _TT("SYNO.SDS.HA.Instance","config","connected")}else{return _TT("SYNO.SDS.HA.Instance","config","disconnected")}}},{header:_TT("SYNO.SDS.HA.Instance","ui","ha_ip"),dataIndex:"ip",id:"ip_address",width:0.15,align:"left",renderer:function(c){if(""===c){return"-"}else{return c}}},{header:_TT("SYNO.SDS.HA.Instance","ui","ha_ip_mask"),dataIndex:"mask",id:"subnet_mask",width:0.15,align:"left",renderer:function(c){if(""===c){return"-"}else{return c}}},{dataIndex:"data_id",id:"data_id",hidden:true},{header:_TT("SYNO.SDS.HA.Instance","ui","use_ha_ip"),dataIndex:"enabled",id:"enabled",sortable:false,width:0.15,align:"left",renderer:function(c){if(true===c){return _T("common","yes")}return _T("common","no")}}],defaults:{sortable:false,menuDisabled:true}});return a},createColumn:function(){var b=this;var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),dataIndex:"if",width:0.12,align:"left",renderer:function(e){var c=e.replace(/\w+(\.\d+|)/g,"$1");var d=SYNO.SDS.Utils.Network.idToString.apply(b,[e]);if(""!==c){d=d+" "+String.format(_TT("SYNO.SDS.HA.Instance","config","vlan_id"),c.replace(".",""))}return d}},{header:_TT("SYNO.SDS.HA.Instance","ui","ip_address"),dataIndex:"ip",id:"ip_address",width:0.12,align:"left"},{header:_TT("SYNO.SDS.HA.Instance","config","subnet_mask"),dataIndex:"mask",id:"subnet_mask",width:0.12,align:"left"},{header:_TT("SYNO.SDS.HA.Instance","space","desc"),dataIndex:"desc",id:"desc",width:0.25,align:"left",renderer:function(c){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(_TT("SYNO.SDS.HA.Instance","ui",c))+'">'+_TT("SYNO.SDS.HA.Instance","ui",c)+"</div>"}},{header:_TT("SYNO.SDS.HA.Instance","config","enabled"),id:"enabled"}],defaults:{sortable:false,menuDisabled:true}});return a},onChangeClusterSetting:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply({fn:"SYNO.SDS.AdminCenter.Network.Main"},this.appWin.findAppWindow().openConfig))}});Ext.define("SYNO.SDS.HA.ChangeHASettingDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){var a={width:500,height:360,minWidth:450,minHeight:200,layout:"fit",closable:true,items:[this.formPanel=new SYNO.SDS.HA.ClusterNetworkPanel({appWin:b.appWin,owner:this})],buttons:[{text:_T("common","apply"),btnStyle:"blue",itemId:"apply",handler:this.onOk,disabled:_S("ha_safemode"),scope:this},{text:_T("common","cancel"),itemId:"cancel",handler:this.onCancel,scope:this}]};Ext.apply(a,b);this.callParent([a])},load:function(a){this.setTitle(_TT("SYNO.SDS.HA.Instance","config","change_cluster_setting"));this.formPanel.getForm().setValues(a);this.formPanel.checkHandler();this.open()},checkSetting:function(){var g=SYNO.SDS.Utils.Network.GatewayMatchIP;var d=this.formPanel.getForm().findField("default_gateway").getValue();var c=this.panel.IPListStore;var f=c.getCount();var a=false;var b=0;if(!this.formPanel.getForm().isValid()){return false}if(""===d){this.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","error_nogate"),function(h){if("yes"===h){this.ApplySetting()}return false},this)}else{for(b=0;b<f;b++){var e=c.getAt(b);if(!e||false===e.get("enabled")){continue}if(g(d,e.get("ip"),e.get("mask"))){a=true}}if(true===a){this.ApplySetting()}else{this.formPanel.getForm().findField("default_gateway").markInvalid(_T("common","error_notmatch"))}}},ApplySetting:function(){var a={};a.action="apply_cluster_setting";a.ha_hostname=Ext.getCmp(this.formPanel.HAHostnameID).getValue();a.default_gateway=Ext.getCmp(this.formPanel.defaultGatewayID).getValue();a.dns=Ext.getCmp(this.formPanel.DNSID).getValue();a.dns2=Ext.getCmp(this.formPanel.DNS2ID).getValue();a.is_static_dns=Ext.getCmp(this.formPanel.staticDNSCheckID).getValue();this.setStatusBusy({text:_TT("SYNO.SDS.HA.Instance","ui","infor_update")});Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(a),success:function(b,d){this.clearStatusBusy();var f=Ext.decode(b.responseText);if(!f.success){var g="";if(f.errinfo&&f.errinfo.app){g=_TT(f.errinfo.app,f.errinfo.sec,f.errinfo.key)}else{if(f.errinfo){g=_T(f.errinfo.sec,f.errinfo.key)}else{g=_T("common","commfail")}}this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),g);return}var c=this.formPanel.getForm();var e={default_gateway:c.findField("default_gateway").getValue(),dns:c.findField("dns").getValue(),dns2:c.findField("dns2").getValue(),ha_hostname:c.findField("ha_hostname").getValue(),is_static_dns:c.findField("is_static_dns").getValue()};this.formPanel.getForm().setValues(e);this.close()},failure:function(b,c){this.clearStatusBusy();this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})},onOk:function(){if(!this.checkSetting()){return}this.ApplySetting()},onCancel:function(){this.close()},onClose:function(){return true}});Ext.define("SYNO.SDS.HA.ClusterNetworkPanel",{extend:"SYNO.SDS.Utils.FormPanel",networkStore:null,constructor:function(b){var a={border:false,trackResetOnLoad:true,items:[{xtype:"syno_displayfield",height:50,value:_TT("SYNO.SDS.HA.Instance","config","cluster_setting_desc")},{xtype:"syno_textfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),id:this.HAHostnameID=Ext.id(),name:"ha_hostname",allowBlank:false,maxlength:15,labelWidth:200,width:180,vtype:"username_ext"},{xtype:"syno_textfield",fieldLabel:_T("status","status_gateway"),id:this.defaultGatewayID=Ext.id(),name:"default_gateway",allowBlank:true,maxlength:15,labelWidth:200,width:180,vtype:"v4ip"},{xtype:"syno_textfield",fieldLabel:_T("tcpip","primary_dns"),id:this.DNSID=Ext.id(),name:"dns",allowBlank:false,maxlength:15,labelWidth:200,width:180,vtype:("yes"===_D("ipv4only"))?"v4ip":"ip"},{xtype:"syno_textfield",fieldLabel:_T("tcpip","secondary_dns"),id:this.DNS2ID=Ext.id(),name:"dns2",maxlength:15,labelWidth:200,width:180,vtype:("yes"===_D("ipv4only"))?"v4ip":"ip"},{xtype:"syno_checkbox",id:this.staticDNSCheckID=Ext.id(),name:"is_static_dns",boxLabel:_T("network","enable_static_dns")}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a]);this.mon(Ext.getCmp(this.staticDNSCheckID),"check",this.checkHandler,this)},checkHandler:function(){if(Ext.getCmp(this.staticDNSCheckID).getValue()){Ext.getCmp(this.DNSID).enable();Ext.getCmp(this.DNS2ID).enable()}else{Ext.getCmp(this.DNSID).disable();Ext.getCmp(this.DNS2ID).disable()}}});Ext.define("SYNO.SDS.HA.HAPanelDiskStatus",{extend:"Ext.Panel",leftNodePanel:null,rightNodePanel:null,PollTask:null,constructor:function(a){this.appWin=a.appWin;this.leftNodePanel=new SYNO.SDS.HA.HADiskListPanel({appWin:a.appWin,owner:this,title:"",role:"left_node"});this.rightNodePanel=new SYNO.SDS.HA.HADiskListPanel({appWin:a.appWin,owner:this,title:"",role:"right_node"});var c=[this.leftNodePanel,this.rightNodePanel];this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:c});var b={border:false,itemId:"disk",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.tabpanel]};this.callParent([b])},onPageActivate:function(){this.tabpanel.setActiveTab(0);this.updateDiskWithMask();if(!this.PollTask){this.PollTask=this.addAjaxTask({interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_disk"},success:this.updateDiskWithMaskDone,failure:function(a,b){SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}this.PollTask.start(false)},onPageDeactivate:function(){this.PollTask.stop()},updateDiskWithMaskDone:function(c,e){this.appWin.clearStatusBusy();var g=Ext.decode(c.responseText);if(g.success){var f={};var a={};var d=0;f.items=g.lnode_disk;a.items=g.rnode_disk;if(""!==g.lnode_name&&g.lnode_online){this.leftNodePanel.setTitle(g.lnode_name);this.leftNodePanel.enable()}else{if(!g.lnode_online){this.leftNodePanel.setTitle(g.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}}if(""!==g.rnode_name&&g.rnode_online){this.rightNodePanel.setTitle(g.rnode_name);this.rightNodePanel.enable()}else{if(!g.rnode_online){this.rightNodePanel.setTitle(g.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}if(this.leftNodePanel.diskStore.getCount()!==g.lnode_disk.length){this.leftNodePanel.diskStore.loadData(f,false)}else{for(d=0;d<g.lnode_disk.length;d++){var h=this.leftNodePanel.diskStore.getById(g.lnode_disk[d].index);if(h){h.set("name",g.lnode_disk[d].name);h.set("eunit",g.lnode_disk[d].eunit);h.set("size",g.lnode_disk[d].size);h.set("temperature",g.lnode_disk[d].temperature);h.set("smart",g.lnode_disk[d].smart);h.set("status",g.lnode_disk[d].status)}else{this.leftNodePanel.diskStore.loadData(f,false);break}}}this.leftNodePanel.diskStore.commitChanges();if(this.rightNodePanel.diskStore.getCount()!==g.rnode_disk.length){this.rightNodePanel.diskStore.loadData(a,false)}else{for(d=0;d<g.rnode_disk.length;d++){var b=this.rightNodePanel.diskStore.getById(g.rnode_disk[d].index);if(b){b.set("name",g.rnode_disk[d].name);b.set("eunit",g.rnode_disk[d].eunit);b.set("size",g.rnode_disk[d].size);b.set("temperature",g.rnode_disk[d].temperature);b.set("smart",g.rnode_disk[d].smart);b.set("status",g.rnode_disk[d].status)}else{this.rightNodePanel.diskStore.loadData(a,false);break}}}this.rightNodePanel.diskStore.commitChanges()}else{SYNO.Debug("Ajax load failure "+c.responseText)}},updateDiskWithMask:function(){this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_disk"},success:this.updateDiskWithMaskDone,failure:function(a,b){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}});Ext.define("SYNO.SDS.HA.HADiskListPanel",{extend:"SYNO.ux.EditorGridPanel",diskStore:null,columnModel:null,PollTask:null,constructor:function(a){this.initForm();var b={title:a.title,role:a.role,store:this.diskStore,border:false,colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){},this);this.getSelectionModel().on("rowdeselect",function(d,c){},this);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},initForm:function(){var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"index"},["location","order","index","eunit","name","size","temperature","smart","status"]),remoteSort:false,hasMultiSort:true});b.sort([{field:"location",direction:"AES"},{field:"order",direction:"AES"}],"AES");this.diskStore=b;var a=new Ext.grid.ColumnModel({columns:[{id:"eunit",header:_T("volume","volume_disk_source_ebox"),dataIndex:"eunit",width:0.15,align:"left",renderer:function(h,e,g){var f=g.get("index").indexOf("-");var d=g.get("index").substr(0,f);var c=h.indexOf("EUnit");if(0!==d&&-1!==c){return h.replace("EUnit",_T("volume","volume_expansion"))}else{return h}}},{id:"name",header:_T("volume","volume_disk_number"),dataIndex:"name",width:0.12,align:"left",renderer:function(c){return c.replace("Disk",_T("volume","volume_disk"))}},{header:_T("volume","volume_diskcapacity"),dataIndex:"size",width:0.1,align:"left",renderer:this.diskSizeRender},{header:_T("status","temperature"),dataIndex:"temperature",width:0.15,align:"left",renderer:function(c,d,e){if("no"===_D("showdisktemperature","yes")||-1===c){return"-"}return String.format("{0} {1} / {2} {3}",c,_T("status","celsius"),(c*9/5+32).toFixed(0),_T("status","fahrenheit"))}},{header:_T("smart","smart_status"),dataIndex:"smart",width:0.15,align:"left",renderer:function(c){var d;if("yes"!==_D("supportsmart","no")){return"-"}if(!c){d=_T("common","loading")}else{if(c==="safe"){d='<font class="syno-ha-service-status-health">'+_T("volume","volume_status_normal")+"</font>"}else{if(c==="damage"){d='<font class="syno-ha-service-status-error">'+_T("smart","smart_status_abnormal")+"</font>"}else{if(c==="danger"){d='<font class="syno-ha-service-status-error">'+_T("smart","smart_status_abnormal")+"</font>"}else{d=_T("smart","smart_test_remain")+": "+c}}}}return d}},{header:_T("volume","volume_diskstatus"),dataIndex:"status",width:0.13,align:"left",renderer:this.DiskStatusRender}],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},getStatus:function(a,b){this.appWin.clearStatusBusy()},DiskStatusRender:function(a){if(0===a.indexOf("all_partition_normal")){if(a.indexOf(":spare")>0){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_spare_disk")+"</span>"}else{return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}}else{if(0===a.indexOf("sys_partition_bad")){if(a.indexOf(":spare")>0){return String.format("<span class='syno-ha-service-status-health'>{0}</span><span class='syno-ha-service-status-error'>({1})</span>",_T("volume","volume_spare_disk"),_T("volume","volume_diskfailedsys"))}else{return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailedsys")+"</span>"}}else{if("sys_partition_normal"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_disksysuse")+"</span>"}else{if("data_partition_bad"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailed")+"</span>"}else{if("not_use"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_disknotuse")+"</span>"}else{if("no_disk"==a||"not_install"==a){return'<span class="normal-font">'+_T("volume","volume_disknotset")+"</span>"}else{if("normal"==a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}else{if("crashed"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailed")+"</span>"}else{if("system_crashed"==a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_diskfailedsys")+"</span>"}else{return""}}}}}}}}}},diskSizeRender:function(b){var a=SYNO.SDS.Utils.StorageUtils;return a.GetSizeGB(b)+" GB"}});Ext.define("SYNO.SDS.HA.HAPanelLogView",{extend:"Ext.Panel",constructor:function(a){this.leftNodePanel=new SYNO.SDS.HA.HALogListPanel({appWin:a.appWin,owner:this,title:"     ",node:"lnode"});this.rightNodePanel=new SYNO.SDS.HA.HALogListPanel({appWin:a.appWin,owner:this,title:"     ",node:"rnode"});this.appWin=a.appWin;this.tabpanel=new SYNO.SDS.HA.TabPanel({appWin:a.appWin,owner:this,tabPanels:[this.leftNodePanel,this.rightNodePanel]});var b={border:false,itemId:"log",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.tabpanel]};this.callParent([b])},onPageActivate:function(){this.tabpanel.setActiveTab(0);this.loadLogView()},onPageDeactivate:function(){},loadLogViewDone:function(c,a){var b=Ext.decode(c.responseText);this.appWin.clearStatusBusy();if(b.success){if(""!==b.lnode_name&&b.lnode_online){this.leftNodePanel.setTitle(b.lnode_name);this.leftNodePanel.enable()}else{if(!b.lnode_online){this.leftNodePanel.setTitle(b.lnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}else{this.leftNodePanel.setTitle("N/A");this.leftNodePanel.disable();if(this.leftNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(1)}}}if(""!==b.rnode_name&&b.rnode_online){this.rightNodePanel.setTitle(b.rnode_name);this.rightNodePanel.enable()}else{if(!b.rnode_online){this.rightNodePanel.setTitle(b.rnode_name+" ("+_T("usbbackup","usbbkp_offline")+")");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}else{this.rightNodePanel.setTitle("N/A");this.rightNodePanel.disable();if(this.rightNodePanel===this.tabpanel.getActiveTab()){this.tabpanel.setActiveTab(0)}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","error_system"))}},loadLogView:function(){this.appWin.setStatusBusy(_T("common","loading"));Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode({action:"load_loginfo"}),method:"POST",success:this.loadLogViewDone,failure:function(b,a){this.appWin.clearStatusBusy()},scope:this},this)}});Ext.define("SYNO.SDS.HA.HALogListPanel",{extend:"SYNO.ux.EditorGridPanel",logListStore:null,storeParam:null,columnModel:null,toolbar:null,pagingToolbar:null,displayNum:20,constructor:function(a){this.initForm(a);var c=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[60,60],[80,80],[100,100],[150,150],[200,200],[300,300],[400,400]]});var d=new SYNO.ux.ComboBox({store:c,displayField:"display",valueField:"value",triggerAction:"all",value:this.displayNum,editable:false,width:62,mode:"local",listeners:{select:{fn:this.itemPerPageChangedHandler,scope:this}}});var b={title:a.title,owner:a.owner,store:this.logListStore,tbar:this.toolbar,border:false,cls:"syno-ha-logview-log-list-detail",colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true,bbar:this.pagingToolbar=new SYNO.ux.PagingToolbar({store:this.logListStore,pageSize:this.displayNum,items:[new Ext.Toolbar.TextItem(_T("common","items_perpage")),d],displayInfo:true})};Ext.apply(b,a);this.callParent([b])},initForm:function(b){var c=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST"}),reader:new Ext.data.JsonReader({root:"items",totalProperty:"logCount"},["level","type","date","user","event"]),baseParams:this.storeParam={action:"load_log",mode:b.node,start:0,limit:this.displayNum},autoLoad:true,autoDestroy:false});this.logListStore=c;var a=[{xtype:"syno_button",text:_T("common","clean"),handler:this.onClean,disabled:_S("ha_safemode"),scope:this},{xtype:"syno_button",text:_T("common","refresh"),handler:this.onRefresh,scope:this}];this.toolbar=a;this.columnModel=this.createColumn()},createColumn:function(){var a=new Ext.grid.ColumnModel({columns:[{header:" ",dataIndex:"level",width:0.06,align:"center",renderer:function(c){var b='<div class="{0}" ext:qtip="{1}">&nbsp;</div>';if(c=="info"){return String.format(b,"synoha-log-info",_T("log","info_level"))}else{if(c=="warn"){return String.format(b,"synoha-log-warn",_T("log","warn_level"))}else{return String.format(b,"synoha-log-err",_T("log","error_level"))}}}},{header:_T("tree","leaf_log"),dataIndex:"type",width:0.1,align:"left",renderer:function(c){var b="";switch(c){case"syslog":b=_T("log","log_link_system");break;case"connlog":b=_T("log","log_link_connection");break;default:b=_T("log","log_link_system")}return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_time"),dataIndex:"date",width:0.17,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_account"),dataIndex:"user",width:0.12,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}},{header:_T("log","log_action"),dataIndex:"event",id:"event",width:0.38,align:"left",renderer:function(b){return'<div ext:qtip="'+Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(b))+'">'+Ext.util.Format.htmlEncode(b)+"</div>"}}],defaults:{sortable:false,menuDisabled:true}});return a},itemPerPageChangedHandler:function(a){if(this.displayNum!=a.getValue()){this.displayNum=a.getValue();this.pagingToolbar.pageSize=this.displayNum;this.storeParam.limit=this.displayNum;this.logListStore.load()}},onClean:function(){this.appWin.setStatusBusy(_T("common","loading"));Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode({action:"clear_log"}),method:"POST",success:function(d,a){this.appWin.clearStatusBusy();var b=Ext.decode(d.responseText);var c="";if(!b.success){if(b.errinfo&&b.errinfo.app){c=_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key)}else{if(b.errinfo){c=_T(b.errinfo.sec,b.errinfo.key)}else{c=_T("common","error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),c);return}this.logListStore.load();this.owner.loadLogView()},failure:function(b,a){this.appWin.clearStatusBusy()},scope:this},this)},onRefresh:function(){this.logListStore.load()}});Ext.define("SYNO.SDS.HA.HAPanelOverview",{extend:"Ext.Panel",statusIconCSSClass:["syno-ha-overview-icon-healthy","syno-ha-overview-icon-danger","syno-ha-overview-icon-standalone","syno-ha-overview-icon-warning","syno-ha-overview-icon-configuring","syno-ha-overview-icon-empty_passive","syno-ha-overview-icon-preparing","syno-ha-overview-icon-loading"],statusTitleCSSClass:["syno-ha-overview-titleText-healthy","syno-ha-overview-titleText-danger","syno-ha-overview-titleText-standalone","syno-ha-overview-titleText-warning","syno-ha-overview-titleText-configuring","syno-ha-overview-titleText-empty_passive","syno-ha-overview-titleText-preparing","syno-ha-overview-titleText-loading"],sysStatusIndex:["healthy","error","standalone","warning","configuring","empty_passive","preparing","loading"],DSIconCSSClass:["syno-ha-overview-connectionFigure-normal","syno-ha-overview-connectionFigure-warning","syno-ha-overview-connectionFigure-configuring","syno-ha-overview-connectionFigure-offline","syno-ha-overview-connectionFigure-error","syno-ha-overview-connectionFigure-standalone","syno-ha-overview-connectionFigure-none"],DSStatus:["normal","warning","configuring","offline","error","standalone","none"],syncDirectionIconCSSClass:["syno-ha-overview-connectionFigure-syncLeft","syno-ha-overview-connectionFigure-syncRight","syno-ha-overview-connectionFigure-syncNone"],syncDirectionStatus:["left","right","none"],contentRefresher:null,sysStatus:null,passiveOnline:null,remoteOnline:null,PollTask:null,progressFinished:false,tryAddrCount:null,hideMenuFlag:null,triggerMenuFlag:null,activePollingTask:null,activeServerDown:null,passivePollingTask:null,pollingCount:0,activeServer:"",activeStatus:null,activeFailedServ:[],activeFailedNet:[],passiveServer:"",passiveStatus:null,passiveFailedServ:[],currentDescList:[],currentDescIndex:0,dataSyncProgress:"",haStatusKey:"",passiveDataUnsync:false,passiveSN:"",localSN:"",remoteSN:"",actionMenuOn:false,lnodeNameID:null,rnodeNameID:null,lnodeRoleID:null,rnodeRoleID:null,lnodeModelID:null,rnodeModelID:null,lnodeSNID:null,rnodeSNID:null,lnodeServerFanID:null,rnodeServerFanID:null,lnodeThermalID:null,rnodeThermalID:null,lnodePowerUnitID:null,rnodePowerUnitID:null,lnodeMemoryID:null,rnodeMemoryID:null,SBLocalRole:"",constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this);this.mon(Ext.getCmp(this.manageHABtnID),"menuhide",this.onMenuhide,this);this.mon(Ext.getCmp(this.manageHABtnID),"menutriggerout",this.onMenutriggerout,this)},fillConfig:function(a){var b={border:false,itemId:"overview",layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},items:[this.createBriefOverviewBox(),this.createDividerPanel(12),this.createConnectionOverviewBox()],style:"padding: 0;",cls:"syno-ha-overview-panel",listeners:{activate:{fn:function(){this.updateHAStatus();if(!this.PollTask){this.PollTask=this.addAjaxTask({interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_overview"},success:this.updateHAStatusDone,failure:function(c,d){SYNO.Debug("Ajax load failure "+c.responseText)},scope:this})}this.PollTask.start(false)},scope:this},deactivate:{fn:function(){this.PollTask.stop()},scope:this}}};return SYNO.LayoutConfig.fill(b)},createBriefOverviewPanel:function(){return{xtype:"panel",hideLabel:true,id:this.BriefOverviewPanelID=Ext.id(),layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},width:720,height:200,border:false,items:[this.createStatusIconBox(),this.createStatusMessageBox()]}},createBriefOverviewBox:function(){return{xtype:"panel",hideLabel:true,layout:"vbox",layoutConfig:{align:"center"},height:200,border:false,items:[this.createBriefOverviewPanel()]}},createStatusIconBox:function(){return{xtype:"panel",layout:"hbox",layoutConfig:{align:"middle"},hideLabel:true,width:258,border:false,cls:"syno-ha-overview-icon",items:[this.createStatusIconPanel()]}},createStatusIconPanel:function(){return{xtype:"panel",hideLabel:true,id:this.statusIconPanelID=Ext.id(),width:128,height:128,border:false,cls:"syno-ha-overview-icon-default"}},createStatusMessageBox:function(){return{xtype:"panel",hideLabel:true,border:false,id:this.StatusMessageBoxID=Ext.id(),layout:"hbox",layoutConfig:{align:"middle"},items:[this.createStatusMessagePanel()]}},createStatusMessagePanel:function(){return{xtype:"panel",hideLabel:true,width:439,border:false,items:[{xtype:"syno_displayfield",style:"margin-bottom: 8px;",id:this.statusTitleID=Ext.id(),value:"",cls:"syno-ha-overview-titleText-healthy"},{xtype:"panel",hideLabel:true,layout:"hbox",border:false,style:"margin-bottom: 8px;",items:[{xtype:"syno_displayfield",id:this.statusDescriptionID=Ext.id(),width:398,value:"",style:"padding: 0px;"},{xtype:"button",id:this.prevDescBtnID=Ext.id(),handler:this.onPrevDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-ha-overview-prevDescButton"},{xtype:"button",id:this.nextDescBtnID=Ext.id(),handler:this.onNextDesc,disabled:_S("demo_mode"),scope:this,hidden:true,cls:"syno-ha-overview-nextDescButton"}]},this.createClusterInformationPanel(),this.createOperationButtonPanel()]}},createDividerPanel:function(a){return{xtype:"panel",hideLabel:true,layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},height:a,border:false,items:[{xtype:"panel",hideLabel:true,height:a,border:false}]}},createClusterInformationPanel:function(){return{xtype:"panel",layout:"form",labelWidth:190,border:false,style:"margin-bottom: 8px;",id:this.HAClusterInfoPanelID=Ext.id(),items:[{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),hideLabel:false,value:"",hidden:true,id:this.HAHostNameID=Ext.id()},{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_ip"),hideLabel:false,value:"",hidden:true,id:this.HAHostIPID=Ext.id()},{xtype:"syno_displayfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","overview","built_time"),hideLabel:false,value:"",hidden:true,id:this.HAEnabledTimeID=Ext.id()},{xtype:"syno_displayfield",hideLabel:true,value:"",hidden:true,id:this.HAClusterDescID=Ext.id()}]}},createOperationButtonPanel:function(){return{xtype:"panel",hideLabel:true,layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","ui","enable_ha"),id:this.enableHABtnID=Ext.id(),handler:this.changeHAStatus,disabled:_S("demo_mode"),scope:this,hidden:false,cls:"syno-ha-overview-squareButton"},new SYNO.ux.SplitButton({id:this.manageHABtnID=Ext.id(),text:_TT("SYNO.SDS.HA.Instance","overview","manage_cluster"),scope:this,handler:this.onSplitButton,disabled:_S("demo_mode"),hidden:true,menu:new Ext.menu.Menu({items:[{text:_TT("SYNO.SDS.HA.Instance","overview","launch_manage_wizard"),scope:this,id:this.manageWizardBtnID=Ext.id(),handler:this.doManageHA},{xtype:"menuseparator",scope:this},{text:_TT("SYNO.SDS.HA.Instance","ui","switch_server"),scope:this,id:this.switchBtnID=Ext.id(),handler:this.switchOver},{text:_TT("SYNO.SDS.HA.Instance","button","update_dsm"),scope:this,id:this.upgradeBtnID=Ext.id(),handler:this.doUpgrade},{text:_TT("SYNO.SDS.HA.Instance","ui","disable_ha"),scope:this,id:this.disableHABtnID=Ext.id(),handler:this.changeHAStatus},{text:_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"),scope:this,id:this.maintainPassiveBtnID=Ext.id(),handler:this.maintainRemote},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_cluster"),scope:this,id:this.shutdownClusterBtnID=Ext.id(),handler:this.shutdownHA},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_active"),scope:this,id:this.shutdownActiveBtnID=Ext.id(),handler:this.shutdownActive},{text:_TT("SYNO.SDS.HA.Instance","overview","reboot_active"),scope:this,id:this.rebootActiveBtnID=Ext.id(),handler:this.rebootActive},{text:_TT("SYNO.SDS.HA.Instance","overview","shutdown_passive"),scope:this,id:this.shutdownPassiveBtnID=Ext.id(),handler:this.shutdownPassive},{text:_TT("SYNO.SDS.HA.Instance","overview","reboot_passive"),scope:this,id:this.rebootPassiveBtnID=Ext.id(),handler:this.rebootPassive},{text:_TT("SYNO.SDS.HA.Instance","overview","shut_beep_remote"),scope:this,id:this.beepOffPassiveBtnID=Ext.id(),handler:this.shutbeepRemote}]})})]}},descRenderer:function(e){var d="";var c="";var b="";var a=0;if("desc_data_mirroring"===e){d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_data_mirroring"),this.dataSyncProgress)}else{if("active_has_failed_service"===e){for(a=0;a<this.activeFailedServ.size();a++){if(""!==c){c=c+", "}c=c+SYNO.SDS.HA.ServiceRenderer(this.activeFailedServ[a])}d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_service_active"),c)}else{if("passive_has_failed_service"===e){for(a=0;a<this.passiveFailedServ.size();a++){if(""!==c){c=c+", "}c=c+SYNO.SDS.HA.ServiceRenderer(this.passiveFailedServ[a])}d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_service_passive"),c)}else{if("active_has_failed_net"===e){for(a=0;a<this.activeFailedNet.size();a++){if(""!==b){b=b+", "}b=b+SYNO.SDS.Utils.Network.idToString.apply(this,[this.activeFailedNet[a],"lan"])}d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_active"),b)}else{if("passive_has_failed_net"===e){for(a=0;a<this.passiveFailedNet.size();a++){if(""!==b){b=b+", "}b=b+SYNO.SDS.Utils.Network.idToString.apply(this,[this.passiveFailedNet[a],"lan"])}d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_failed_net_passive"),b)}else{if("mismatch_ssd_cache"===e){d=String.format(_TT("SYNO.SDS.HA.Instance","overview","desc_mismatch_ssd_cache"),this.ha.passive_has_mismatch_ssd_cache)}else{if("memsize_not_identical"===e){d=_TT("SYNO.SDS.HA.Instance","overview","desc_memsize_not_identical_when_cache_exist")}else{d=_TT("SYNO.SDS.HA.Instance","overview",e)}}}}}}}Ext.getCmp(this.statusDescriptionID).setValue(d);Ext.getCmp(this.StatusMessageBoxID).doLayout();Ext.getCmp(this.BriefOverviewPanelID).doLayout()},onNextDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(b.size()>a+1){this.descRenderer(b[a+1]);this.haStatusKey=b[a+1];this.currentDescIndex++;a=this.currentDescIndex}if(b.size()===a+1){Ext.getCmp(this.nextDescBtnID).disable()}if(0<a){Ext.getCmp(this.prevDescBtnID).enable()}},onPrevDesc:function(){var b=this.currentDescList;var a=this.currentDescIndex;if(0>=b.size()){return}if(0<a){this.descRenderer(b[a-1]);this.haStatusKey=b[a-1];this.currentDescIndex--;a=this.currentDescIndex}if(0===a){Ext.getCmp(this.prevDescBtnID).disable()}if(b.size()>a+1){Ext.getCmp(this.nextDescBtnID).enable()}},onMenuhide:function(){this.hideMenuFlag=1},onMenutriggerout:function(){this.triggerMenuFlag=1},onSplitButton:function(a){if(1===this.hideMenuFlag&&0===this.triggerMenuFlag){a.hideMenu()}else{a.showMenu()}this.hideMenuFlag=0;this.triggerMenuFlag=0},createConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:722,height:368,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createConnectionOverviewPanelContent()]}},createConnectionOverviewBox:function(){return{xtype:"panel",hideLabel:true,height:368,layout:"vbox",layoutConfig:{align:"center"},border:false,items:[this.createConnectionOverviewPanel()]}},createConnectionOverviewPanelContent:function(){return{xtype:"panel",hideLabel:true,flex:1,width:722,layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[this.createUpperConnectionOverviewPanel(),this.createGraphicalConnectionFigurePanel(),this.createDividerPanel(5),this.createBottomConnectionOverviewPanel()]}},createUpperConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:612,height:28,layout:"hbox",layoutConfig:{align:"middle"},cls:"syno-ha-overview-connection-nodeLabel",border:false,items:[{xtype:"syno_displayfield",value:"",flex:1,id:this.lnodeRoleID=Ext.id()},{xtype:"syno_displayfield",value:"",flex:1,id:this.rnodeRoleID=Ext.id()}]}},createGraphicalConnectionFigurePanel:function(){return{xtype:"panel",hideLabel:true,height:80,layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},border:false,items:[{xtype:"panel",id:this.leftNodeDSIconID=Ext.id(),cls:"syno-ha-overview-connectionFigure-default",border:false,width:361},{xtype:"panel",id:this.rightNodeDSIconID=Ext.id(),cls:"syno-ha-overview-connectionFigure-default",border:false,width:361},{xtype:"panel",id:this.syncDirectionIconID=Ext.id(),border:false,width:720}]}},createBottomConnectionOverviewPanel:function(){return{xtype:"panel",hideLabel:true,width:722,layout:"hbox",border:false,items:[this.createLeftConnectionDetailBox(),this.createRightConnectionDetailBox()]}},createLeftConnectionDetailBox:function(){return{xtype:"panel",hideLabel:false,flex:1,padding:"0px 25px 0px 20px",border:false,items:[this.createLeftConnectionDetailPanel()]}},createLeftConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",labelSeparator:"",labelWidth:148,cls:"syno-ha-overview-server-detail",border:false,items:[this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_name"),id:this.lnodeNameID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_model"),id:this.lnodeModelID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_sn"),id:this.lnodeSNID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_fan"),id:this.lnodeServerFanID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_thermal"),id:this.lnodeThermalID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_power"),id:this.lnodePowerUnitID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.lnodeMemoryID=Ext.id(),value:""},this.createServerDetailSeperator()]}},createServerDetailSeperator:function(){return{xtype:"panel",hideLabel:true,width:316,height:0,border:false,cls:"syno-ha-overview-connectionFigure-serverDetailSeperator"}},createRightConnectionDetailBox:function(){return{xtype:"panel",hideLabel:false,flex:1,padding:"0px 20px 0px 25px",border:false,items:[this.createRightConnectionDetailPanel()]}},createRightConnectionDetailPanel:function(){return{xtype:"panel",hideLabel:false,layout:"form",labelSeparator:"",labelWidth:148,cls:"syno-ha-overview-server-detail",border:false,items:[this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_name"),id:this.rnodeNameID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_model"),id:this.rnodeModelID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_sn"),id:this.rnodeSNID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_fan"),id:this.rnodeServerFanID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_thermal"),id:this.rnodeThermalID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","server_power"),id:this.rnodePowerUnitID=Ext.id(),value:""},this.createServerDetailSeperator(),{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("rsrcmonitor","physical_memory"),id:this.rnodeMemoryID=Ext.id(),value:""},this.createServerDetailSeperator()]}},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},doUpgrade:function(){SYNO.SDS.AppLaunch("SYNO.SDS.AdminCenter.Application",Ext.apply({fn:"SYNO.SDS.AdminCenter.Update_Reset.Main"},this.appWin.findAppWindow().openConfig))},switchOver:function(){this.PollTask.stop();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_switchover"),function(a){if("yes"===a){var b={};b.action="switchover";b.mode="switch_over";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(b),success:function(d,e){var f=Ext.decode(d.responseText);this.appWin.clearStatusBusy();this.PollTask.start();if(f.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");var c=f.redirect_url.replace("__WEBMAN_ADDR__",f.ip_list[0]);this.tryAddrCount=0;this.locationCheck.defer(30000,this,[f.ping_url,c,"switch_over"]);this.redirect(f.redirect_url,f.ip_list,1800000,"switch_over")}else{var g="";if(f.errinfo&&f.errinfo.app){g=_TT(f.errinfo.app,f.errinfo.sec,f.errinfo.key)}else{if(f.errinfo){g=_T(f.errinfo.sec,f.errinfo.key)}else{g=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),g)}},failure:function(c,d){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+c.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)},redirect:function(a,c,e,g){var d=e||20000;var b=0;if(!Ext.isString(a)||!Ext.isArray(c)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var h=function(j){SYNO.Debug("try "+c[j%c.length]);location.assign(a.replace("__WEBMAN_ADDR__",c[j%c.length]))};h.defer(d,this,[0]);for(b=0;b<3;b++){d+=10000;h.defer(d,this,[0])}for(b=1;b<=c.length;b++){d+=10000;h.defer(d,this,[b])}var f="";if("disable_ha"===g){f=_TT("SYNO.SDS.HA.Instance","ui","disabling_ha")}else{if("reboot_active"===g){f=_TT("SYNO.SDS.HA.Instance","ui","rebooting_active")}else{f=_T("tcpip","connect_new_ip")}}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:d/1000,msg:f})},waitingBox:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if((0===a)||(this.progressFinished)){if(Ext.isFunction(d.callback)){d.callback.call(d.scope||this)}this.progressFinished=false;SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===a){a=e}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-a/e,d.msg);c.defer(b,this)};c.defer(b,this)},waitPassiveStatus:function(b){this.passivePollingTask=this.addAjaxTask({preventHalt:true,interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,params:{action:"polling_passive_server"},success:function(c,d){var f=false;var e=Ext.decode(c.responseText);if(!e.success){this.pollingCount++;return}if("unbind"===b&&"none"===e.passive_status){f=true}else{if(("shutdown_passive"===b||"reboot_passive"===b)&&("offline"===e.passive_status||"wanring_offline"===e.passive_status)){f=true}}if(f){this.passivePollingTask.stop();this.passivePollingTask=null;this.appWin.clearStatusBusy();this.PollTask.start();this.progressFinished=true}else{if(120<=this.pollingCount){this.passivePollingTask.stop();this.passivePollingTask=null;this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"));this.appWin.clearStatusBusy();this.PollTask.start()}}this.pollingCount++},failure:function(c,d){this.passivePollingTask.stop();this.passivePollingTask=null;this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"));this.appWin.clearStatusBusy();this.PollTask.start();this.progressFinished=true},scope:this});this.pollingCount=0;this.progressFinished=false;this.passivePollingTask.start();var a="";if("shutdown_passive"===b||"reboot_passive"===b){a=_TT("SYNO.SDS.HA.Instance","ui","shutting_down_passive_desc")}else{if("unbind"===b){a=_TT("SYNO.SDS.HA.Instance","ui","unbinding_passive_desc")}}this.waitingBox({title:_TT("SYNO.SDS.HA.Instance","app","app_name"),times:600000/1000,msg:a,width:400})},powerOptPassiveDone:function(a,b){var c=Ext.decode(a.responseText);if(c.success){this.waitPassiveStatus(b.params.action)}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("error","error_error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},doPowerOptPassive:function(a){var b="";this.PollTask.stop();this.appWin.setStatusBusy();if("shutdown_passive"===a){b=_TT("SYNO.SDS.HA.Instance","overview","warning_turnoff_remote")}else{b=_TT("SYNO.SDS.HA.Instance","overview","warning_reboot_passive")}this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(c){if("yes"===c){Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:a},success:this.powerOptPassiveDone,failure:function(d,e){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+d.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)},shutbeepRemoteDone:function(a,b){var c=Ext.decode(a.responseText);this.appWin.clearStatusBusy();this.PollTask.start();if(c.success){}else{var d="";if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("error","error_error_system")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},shutbeepRemote:function(){this.PollTask.stop();this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"shut_beep_remote"},success:this.shutbeepRemoteDone,failure:function(a,b){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+a.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})},shutdownPassive:function(){if(true===this.passiveOnline){this.doPowerOptPassive("shutdown_passive")}},rebootPassive:function(){if(true===this.passiveOnline){this.doPowerOptPassive("reboot_passive")}},unbindRemoteDone:function(a,b){var c=Ext.decode(a.responseText);if(c.success){this.waitPassiveStatus("unbind")}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},SBunbindRemoteDone:function(a,b){var c=Ext.decode(a.responseText);if(c.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");this.tryAddrCount=0;this.locationCheck.defer(30000,this,[c.ping_url,c.ping_url,"sb_unbind_remote"]);this.redirect(c.redirect_url,c.ip_list,1800000,"sb_unbind_remote")}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},unbindRemote:function(a){Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"unbind_remote",safemode:a}),success:("true"===a)?this.SBunbindRemoteDone:this.unbindRemoteDone,failure:function(b,c){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+b.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})},SBunbindLocalDone:function(a,b){var c=Ext.decode(a.responseText);if(c.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");this.tryAddrCount=0;this.locationCheck.defer(30000,this,[c.ping_url,c.ping_url,"sb_unbind_local"]);this.redirect(c.redirect_url,c.ip_list,1800000,"sb_unbind_local")}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},unbindLocal:function(a){Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"unbind_local",safemode:a}),success:this.SBunbindLocalDone,failure:function(b,c){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+b.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})},bindRemoteDone:function(a,b){var c=Ext.decode(a.responseText);this.appWin.clearStatusBusy();if(c.success){}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",c.e,"error_error_system"))}},bindRemote:function(){this.appWin.clearStatusBusy();var a=new SYNO.SDS.HA.HABindWizard({owner:this.appWin,scope:this});a.on("hide",function(){},this);a.Show()},maintainRemote:function(){this.PollTask.stop();this.appWin.setStatusBusy();if("empty_passive"===this.sysStatus){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote"),function(b){if("yes"===b){this.bindRemote()}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}else{var a="";a=_TT("SYNO.SDS.HA.Instance","overview","warning_unbind_remote");if(true===this.passiveDataUnsync){a+='<br><br><font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","ui","warning_unsynced_passive_unbinding")+"</font>"}this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),a,function(b){if("yes"===b){this.unbindRemote("false")}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}},changeHAStatus:function(){if(null===SYNO.SDS.HA.HAEnabled){return}if(SYNO.SDS.HA.HAEnabled){var a="";this.PollTask.stop();this.appWin.setStatusBusy();a=_TT("SYNO.SDS.HA.Instance","overview","warning_deactivate_ha");if(true===this.passiveDataUnsync){a+='<br><br><font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","ui","warning_unsynced_passive_unbinding")+"</font>"}this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),a,function(b){if("yes"===b){this.appWin.clearStatusBusy();this.doDisableHA()}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}else{this.doEnableHA()}},SBunbind:function(a){if(null===a||""===a){return}if(_S("ha_safemode")){var b=_TT("SYNO.SDS.HA.Instance","overview","warning_SB_unbind");this.PollTask.stop();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),b,function(c){if("yes"===c){this.appWin.clearStatusBusy();if("local"===a){this.unbindLocal("true")}if("remote"===a){this.unbindRemote("true")}}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}},SBSetLocalRoleDone:function(a,b){var c=Ext.decode(a.responseText);if(c.success){this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");this.tryAddrCount=0;this.locationCheck.defer(30000,this,[c.ping_url,c.ping_url,"sb_set_role"]);this.redirect(c.redirect_url,c.ip_list,1800000,"sb_set_role")}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},SBSetLocalRole:function(b){if(null===b||""===b){return}if(_S("ha_safemode")){var a=_TT("SYNO.SDS.HA.Instance","overview","warning_SB_activate");this.PollTask.stop();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),a,function(c){if("yes"===c&&("active"===b||"passive"===b)){this.SBLocalRole=b;this.appWin.clearStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"sb_local_"+b,safemode:true}),success:this.SBSetLocalRoleDone,failure:function(d,e){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+d.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))},scope:this})}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}},doEnableHA:function(){this.PollTask.stop();var a=new SYNO.SDS.HA.HASetupWizard({owner:this.appWin,scope:this});a.on("hide",function(){},this);a.Show()},doManageHA:function(){var c="";var a="";if("lnode"===this.ha.login_node){c=this.lnode;a=this.rnode}else{c=this.rnode;a=this.lnode}this.PollTask.stop();var b=new SYNO.SDS.HA.HAManageWizard({owner:this.appWin,canSwitchOver:("enabled"===this.buttons.switchover),canUpgradeDSM:("enabled"===this.buttons.upgrade_dsm),canRemoveHA:("enabled"===this.buttons.remove_cluster),canBindPassive:("enabled"===this.buttons.bind_passive),canUnbindPassive:("enabled"===this.buttons.unbind_passive),canShutdownHA:("enabled"===this.buttons.shutdown_cluster),canShutdownActive:("enabled"===this.buttons.shutdown_active),canShutdownPassive:("enabled"===this.buttons.shutdown_passive),canBeepOffPassive:("enabled"===this.buttons.passive_beep_off),canSetSBRole:(true===this.remoteOnline),loginSN:c.sn,loginHostname:c.hostname,remoteSN:a.sn,remoteHostname:a.hostname,scope:this});b.on("hide",function(){},this);b.Show()},startPollingActive:function(){this.activePollingTask=this.addAjaxTask({preventHalt:true,interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,params:{action:"polling_active_server"},success:function(a,b){},failure:function(a,b){this.activePollingTask.stop();this.activePollingTask=null;this.activeServerDown=true},scope:this});this.activeServerDown=false;this.activePollingTask.start()},doDisableHAFinished:function(a,b){var c=Ext.decode(a.responseText);this.appWin.clearStatusBusy();this.PollTask.start();if(c.success){this.startPollingActive();this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");this.tryAddrCount=0;this.locationCheck.defer(60000,this,[c.ping_url,c.ping_url,"disable_ha"]);this.redirect(c.redirect_url,c.ip_list,1800000,"disable_ha")}else{var d="";this.appWin.clearStatusBusy();this.PollTask.start();if(c.errinfo&&c.errinfo.app){d=_TT(c.errinfo.app,c.errinfo.sec,c.errinfo.key)}else{if(c.errinfo){d=_T(c.errinfo.sec,c.errinfo.key)}else{d=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}},locationGet:function(){var b=window.location.toString();var a=b.indexOf("#");if(-1===a||a===b.length-1){return""}else{return b.substr(a+1)}},locationCheck:function(g,a,f){var e=this.locationGet();var d=document.createElement("iframe");var c="";var h="";var b="";if(false===this.activeServerDown){this.locationCheck.defer(5000,this,[g,a]);return}if(""!==e){c=e.search("sn=");if(-1!==c){h=e.substr(c+3)}if("sb_set_role"===f){if("active"===this.SBLocalRole){b=this.localSN}else{b=this.remoteSN}}if(("switch_over"!==f&&"sb_unbind_remote"!==f&&"sb_unbind_local"!==f&&"sb_set_role"!==f)||("switch_over"===f&&""!==h&&this.passiveSN===h)||("sb_unbind_remote"===f&&""!==h&&this.localSN===h)||("sb_unbind_local"===f&&""!==h&&this.remoteSN===h)||("sb_set_role"===f&&""!==h&&b===h)){window.location=a;this.progressFinished=true;return true}}if(300>this.tryAddrCount){this.tryAddrCount++;d.width="0px";d.height="0px";d.src=g+"info.cgi?host="+window.location.href;document.getElementsByTagName("body")[0].appendChild(d);this.locationCheck.defer(5000,this,[g,a,f]);return}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","ui","timeout"));return false},doDisableHA:function(){var a={};a.action="deactivate_ha";a.mode="deactivate_ha";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(a),success:this.doDisableHAFinished,failure:function(b,c){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+b.responseText)},scope:this})},getSysMsgBox:function(a){if(!this.msgBox||this.msgBox.isDestroyed){this.msgBox=new SYNO.SDS.MessageBoxV5({modal:true,draggable:false,renderTo:document.body})}return this.msgBox.getWrapper()},doShutdown:function(a){var b={};b.action=a;Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(b),success:function(c,e){var f=Ext.decode(c.responseText);this.appWin.clearStatusBusy();this.PollTask.start();if(f.success){SYNO.SDS.StatusNotifier.fireEvent("halt");var d=Ext.getCmp(this.syncDirectionIconID);d.removeClass("syno-ha-overview-connectionFigure-syncLeft");d.removeClass("syno-ha-overview-connectionFigure-syncRight");d.addClass("syno-ha-overview-connectionFigure-syncNone");this.getSysMsgBox().show({closable:false,maxWidth:300,title:_D("product"),msg:_T("system","shutdown_desc2")})}else{if(f.errinfo.app){this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",f.errinfo.sec,f.errinfo.key))}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(f.errinfo.sec,f.errinfo.key))}}},failure:function(c,d){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+c.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))},scope:this})},shutdownHA:function(){this.PollTask.stop();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_cluster"),function(a){if("yes"===a){this.doShutdown("shutdown_ha")}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)},shutdownActive:function(){this.PollTask.stop();this.appWin.setStatusBusy();this.updateHAStatusImmediately();if("enabled"===this.buttons.switchover||"disabled"===this.buttons.shutdown_passive){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_shutdown_active"),function(a){if("yes"===a){this.doShutdown("shutdown_active")}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}else{this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_not_only_shutdown_active"),function(a){if("yes"===a){this.doShutdown("shutdown_ha")}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)}},doRebootActive:function(){var a={};a.action="reboot_active";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(a),success:function(b,d){var e=Ext.decode(b.responseText);this.appWin.clearStatusBusy();this.PollTask.start();if(e.success){this.startPollingActive();var c=window.location.toString();c=c.replace("index.cgi","");this.progressFinished=false;SYNO.SDS.StatusNotifier.fireEvent("halt");this.tryAddrCount=0;this.locationCheck.defer(60000,this,[c,c,"reboot_active"]);this.redirect(c,[c],1800000,"reboot_active")}else{if(e.errinfo.app){this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",e.errinfo.sec,e.errinfo.key))}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(e.errinfo.sec,e.errinfo.key))}}},failure:function(b,c){this.appWin.clearStatusBusy();this.PollTask.start();SYNO.Debug("Ajax load failure "+b.responseText);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))},scope:this})},rebootActive:function(){this.PollTask.stop();this.appWin.setStatusBusy();this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","overview","warning_reboot_active"),function(a){if("yes"===a){this.doRebootActive()}else{this.appWin.clearStatusBusy();this.PollTask.start()}},this)},onPageActivate:function(){this.doLayout()},onPageDeactivate:function(){if(null!==this.contentRefresher){this.contentRefresher.stop()}},renderFanStatus:function(a,b){if(""===a||"offline"===b||"none"===b){a="N/A"}else{if("status_normal"===a){a='<font class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","overview","status_normal")+"</font>"}else{a='<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","overview","fail")+"</font>"}}return a},renderPowerStatus:function(a,b){if(""===a||"offline"===b||"none"===b){a="N/A"}else{if("status_normal"===a){a='<font class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","overview","status_normal")+"</font>"}else{a='<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","overview","fail")+"</font>"}}return a},renderMemorySize:function(a,b){if(""===a||"offline"===b||"none"===b){a="N/A"}else{a=a+" "+_T("common","size_mb")}return a},renderThermalStatus:function(a,b){if("yes"!==_D("supportsystemperature")||""===a||"offline"===b||"none"===b){return"N/A"}return String.format("{0} {1} / {2} {3}",a,_T("status","celsius"),(a*9/5+32).toFixed(0),_T("status","fahrenheit"))},renderServerDetails:function(a,b){if(""===a){a="N/A"}return a},renderNodeRole:function(a){if(""!==a){a=_TT("SYNO.SDS.HA.Instance","ui",a)}return a},setButtonStatus:function(d,e){this.buttons=d;if("enabled"===d.switchover){Ext.getCmp(this.switchBtnID).enable()}else{Ext.getCmp(this.switchBtnID).disable()}if("enabled"===d.upgrade_dsm){Ext.getCmp(this.upgradeBtnID).enable()}else{Ext.getCmp(this.upgradeBtnID).disable()}if("enabled"===d.create_cluster){Ext.getCmp(this.enableHABtnID).show();Ext.getCmp(this.enableHABtnID).enable()}else{if("disabled"===d.create_cluster){Ext.getCmp(this.enableHABtnID).show();Ext.getCmp(this.enableHABtnID).disable()}else{Ext.getCmp(this.enableHABtnID).hide()}}if(_S("demo_mode")){Ext.getCmp(this.enableHABtnID).disable()}if("enabled"===d.manager_cluster){Ext.getCmp(this.manageHABtnID).show();Ext.getCmp(this.manageHABtnID).enable()}else{if("disabled"===d.manager_cluster){Ext.getCmp(this.manageHABtnID).show();Ext.getCmp(this.manageHABtnID).disable()}else{Ext.getCmp(this.manageHABtnID).hide()}}if("enabled"===d.shutdown_cluster){Ext.getCmp(this.shutdownClusterBtnID).enable()}else{Ext.getCmp(this.shutdownClusterBtnID).disable()}if("enabled"===d.shutdown_active){Ext.getCmp(this.shutdownActiveBtnID).enable();Ext.getCmp(this.rebootActiveBtnID).enable()}else{Ext.getCmp(this.shutdownActiveBtnID).disable();Ext.getCmp(this.rebootActiveBtnID).disable()}if("enabled"===d.remove_cluster){Ext.getCmp(this.disableHABtnID).enable()}else{Ext.getCmp(this.disableHABtnID).disable()}var c=Ext.getCmp(this.beepOffPassiveBtnID);var b=Ext.getCmp(this.shutdownPassiveBtnID);var f=Ext.getCmp(this.rebootPassiveBtnID);var a=Ext.getCmp(this.maintainPassiveBtnID);if("lnode"===e||"rnode"===e){if("enabled"===d.passive_beep_off){c.enable()}else{c.disable()}if("enabled"===d.shutdown_passive){b.enable();f.enable()}else{b.disable();f.disable()}if("enabled"===d.unbind_passive){a.enable();a.setText(_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"))}else{if("disabled"===d.unbind_passive){a.disable();a.setText(_TT("SYNO.SDS.HA.Instance","overview","unbind_remote"))}else{if(!_S("demo_mode")){a.enable()}else{a.disable()}a.setText(_TT("SYNO.SDS.HA.Instance","overview","bind_remote"))}}}},parseServList:function(a){var b=a.split(",");return b},parseNetList:function(b){var a=b.split(",");return a},updateHAStatusDone:function(a,b){var c=Ext.decode(a.responseText);this.appWin.clearStatusBusy();if(c.success){this.ha=c.ha;this.lnode=c.lnode;this.rnode=c.rnode;if("standalone"===c.ha.status){SYNO.SDS.HA.HAEnabled=false;this.passiveOnline=null;Ext.getCmp(this.HAClusterInfoPanelID).el.removeClass("syno-ha-overview-clusterInfo");Ext.getCmp(this.HAClusterInfoPanelID).el.addClass("syno-ha-overview-clusterInfo-standalone");Ext.getCmp(this.HAHostNameID).hide();Ext.getCmp(this.HAHostIPID).hide();Ext.getCmp(this.HAEnabledTimeID).hide();Ext.getCmp(this.HAClusterDescID).setValue(_TT("SYNO.SDS.HA.Instance","overview","standalone_desc"));Ext.getCmp(this.HAClusterDescID).show()}else{SYNO.SDS.HA.HAEnabled=true;Ext.getCmp(this.HAClusterInfoPanelID).el.removeClass("syno-ha-overview-clusterInfo-standalone");Ext.getCmp(this.HAClusterInfoPanelID).el.addClass("syno-ha-overview-clusterInfo");Ext.getCmp(this.HAHostNameID).setValue(c.ha.host);Ext.getCmp(this.HAHostIPID).setValue(c.ha.ha_ip_main);Ext.getCmp(this.HAEnabledTimeID).setValue(c.ha.uptime);Ext.getCmp(this.HAHostNameID).show();Ext.getCmp(this.HAHostIPID).show();Ext.getCmp(this.HAEnabledTimeID).show();Ext.getCmp(this.HAClusterDescID).hide()}Ext.getCmp(this.lnodeNameID).setValue(this.renderServerDetails(c.lnode.hostname,c.lnode.status));Ext.getCmp(this.rnodeNameID).setValue(this.renderServerDetails(c.rnode.hostname,c.rnode.status));Ext.getCmp(this.lnodeRoleID).setValue(this.renderNodeRole(c.lnode.role));Ext.getCmp(this.rnodeRoleID).setValue(this.renderNodeRole(c.rnode.role));Ext.getCmp(this.lnodeModelID).setValue(this.renderServerDetails(c.lnode.model,c.lnode.status));Ext.getCmp(this.rnodeModelID).setValue(this.renderServerDetails(c.rnode.model,c.rnode.status));Ext.getCmp(this.lnodeSNID).setValue(this.renderServerDetails(c.lnode.sn,c.lnode.status));Ext.getCmp(this.rnodeSNID).setValue(this.renderServerDetails(c.rnode.sn,c.rnode.status));Ext.getCmp(this.lnodeServerFanID).setValue(this.renderFanStatus(c.lnode.fan_status,c.lnode.status));Ext.getCmp(this.rnodeServerFanID).setValue(this.renderFanStatus(c.rnode.fan_status,c.rnode.status));Ext.getCmp(this.lnodeThermalID).setValue(this.renderThermalStatus(c.lnode.thermal_status,c.lnode.status));Ext.getCmp(this.rnodeThermalID).setValue(this.renderThermalStatus(c.rnode.thermal_status,c.rnode.status));Ext.getCmp(this.lnodePowerUnitID).setValue(this.renderPowerStatus(c.lnode.power_status,c.lnode.status));Ext.getCmp(this.rnodePowerUnitID).setValue(this.renderPowerStatus(c.rnode.power_status,c.rnode.status));Ext.getCmp(this.lnodeMemoryID).setValue(this.renderMemorySize(c.lnode.memory_size,c.lnode.status));Ext.getCmp(this.rnodeMemoryID).setValue(this.renderMemorySize(c.rnode.memory_size,c.rnode.status));if("active"===c.lnode.role){this.setButtonStatus(c.buttons,"lnode");this.activeServer=c.lnode.hostname;this.activeStatus=c.lnode.status;this.passiveServer=c.rnode.hostname;this.passiveStatus=c.rnode.status;if("offline"===c.rnode.status){this.passiveOnline=false}else{this.passiveOnline=true}this.passiveSN=c.rnode.sn}else{if("active"===c.rnode.role){this.setButtonStatus(c.buttons,"rnode");this.activeServer=c.rnode.hostname;this.activeStatus=c.rnode.status;this.passiveServer=c.lnode.hostname;this.passiveStatus=c.lnode.status;if("offline"===c.lnode.status){this.passiveOnline=false}else{this.passiveOnline=true}this.passiveSN=c.lnode.sn}else{this.setButtonStatus(c.buttons,"none")}}if(_S("ha_safemode")){this.remoteOnline=true;if("lnode"===this.ha.login_node){this.localSN=c.lnode.sn;this.remoteSN=c.rnode.sn;this.remoteOnline=("offline"!==c.rnode.status)}else{this.localSN=c.rnode.sn;this.remoteSN=c.lnode.sn;this.remoteOnline=("offline"!==c.lnode.status)}}this.activeFailedServ=this.parseServList(c.ha.active_failed_service);this.passiveFailedServ=this.parseServList(c.ha.passive_failed_service);this.activeFailedNet=this.parseNetList(c.ha.active_failed_net);this.passiveFailedNet=this.parseNetList(c.ha.passive_failed_net);if("empty_passive"===c.ha.status){this.passiveOnline=null}this.passiveDataUnsync=c.ha.passive_data_unsynced;this.refreshInformation(c)}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},updateHAStatusImmediately:function(){this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_overview_refresh"},success:this.updateHAStatusDone,failure:function(a,b){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})},updateHAStatus:function(){this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_overview"},success:this.updateHAStatusDone,failure:function(a,b){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})},refreshInformation:function(a){var b=0;this.sysStatus=a.ha.status;if("loading"!==a.ha.status){this.setObjectClassBySysStatus(Ext.getCmp(this.statusIconPanelID),a.ha.status,this.statusIconCSSClass)}this.setObjectValueBySysStatus(Ext.getCmp(this.statusTitleID),a.ha.status);var c=false;for(b=0;b<a.ha.description.size();b++){if(this.haStatusKey===a.ha.description[b]){this.currentDescIndex=b;c=true;break}}if(!c&&""!==a.ha.description[0]){this.haStatusKey=a.ha.description[0];this.currentDescIndex=0}this.dataSyncProgress=a.ha.sync_progress+"%";this.descRenderer(this.haStatusKey);this.currentDescList=a.ha.description;if(1<this.currentDescList.size()){Ext.getCmp(this.prevDescBtnID).show();Ext.getCmp(this.nextDescBtnID).show()}else{Ext.getCmp(this.prevDescBtnID).hide();Ext.getCmp(this.nextDescBtnID).hide()}if(this.currentDescList.size()>this.currentDescIndex+1){Ext.getCmp(this.nextDescBtnID).enable()}else{Ext.getCmp(this.nextDescBtnID).disable()}if(0<this.currentDescIndex){Ext.getCmp(this.prevDescBtnID).enable()}else{Ext.getCmp(this.prevDescBtnID).disable()}this.setObjectClassBySysStatus(Ext.getCmp(this.statusTitleID),a.ha.status,this.statusTitleCSSClass);switch(a.ha.status){case"healthy":SYNO.Debug("system is healthy");break;case"danger":SYNO.Debug("system is danger");break;case"standalone":SYNO.Debug("system is standalone");break;case"warning":SYNO.Debug("system is warning");break;case"configuring":SYNO.Debug("system is configuring space");break;case"empty_passive":SYNO.Debug("system has no passive node");break;case"preparing":SYNO.Debug("system is preparing");break;case"loading":SYNO.Debug("system is loading the status");break;default:SYNO.Debug("undefined system status");break}this.setObjectClassByDSStatus(Ext.getCmp(this.leftNodeDSIconID),a.lnode.status,this.DSIconCSSClass);this.setObjectClassByDSStatus(Ext.getCmp(this.rightNodeDSIconID),a.rnode.status,this.DSIconCSSClass);this.setObjectClassBySyncStatus(Ext.getCmp(this.syncDirectionIconID),a.ha.sync_direction,this.syncDirectionIconCSSClass);this.doLayout()},setObjectValueBySysStatus:function(b,a){b.setValue(_TT("SYNO.SDS.HA.Instance","status",a))},setObjectClassBySyncStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.syncDirectionStatus)},setObjectClassByDSStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.DSStatus)},setObjectClassBySysStatus:function(c,b,a){this.setObjectClassByStatus(c,b,a,this.sysStatusIndex)},setObjectClassByStatus:function(e,c,b,a){var d=0;for(d=0;d<a.length;d++){if(a[d]!=c){e.removeClass(b[d])}else{e.addClass(b[d])}}}});Ext.define("SYNO.SDS.HA.HAPanelService",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.appWin=a.appWin;var b={border:false,cls:"syno-ha-service-detail",itemId:"monitoring",layout:"fit",style:"padding: 0;",items:[this.mainPanel=new SYNO.SDS.HA.HAServiceListPanel({appWin:a.appWin,owner:this})],fbar:{xtype:"statusbar",hideMode:"visibility",defaultText:"&nbsp;",statusAlign:"left",buttonAlign:"left",items:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","commit"),itemId:"apply",scope:this,disabled:_S("ha_safemode"),handler:this.doCommitSetting},{xtype:"syno_button",text:_T("common","alt_cancel"),itemId:"reset",scope:this,handler:this.onCancel}]}};this.callParent([b])},isDirty:function(){var a=0;var b=this.mainPanel.serviceStore.getCount();for(a=0;a<b;a++){var c=this.mainPanel.serviceStore.getAt(a);if(c&&c.modified){if("monitoring" in c.modified){return true}}}return false},onPageActivate:function(){this.updateServiceWithMask(true);if(!this.PollTask){this.PollTask=this.addAjaxTask({interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"load_monitoring",reload:false}),success:this.updateServiceWithMaskDone,failure:function(a,b){SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}this.PollTask.start(false)},onPageDeactivate:function(){this.PollTask.stop()},doCommitSetting:function(){var d={};var a=0;var c="";var b;if(!this.isDirty()){this.setStatusError({text:_T("error","nochange_subject"),clear:true});return}d.action="apply_monitoring";for(a=0;a<this.mainPanel.serviceStore.getCount();a++){b=this.mainPanel.serviceStore.getAt(a);c=String.format("ha_mon{0}",a);d[c]=b.get("monitoring")}this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(d),success:function(e,f){this.appWin.clearStatusBusy();var g=Ext.decode(e.responseText);if(!g.success){var h="";if(g.errinfo&&g.errinfo.app){h=_TT(g.errinfo.app,g.errinfo.sec,g.errinfo.key)}else{if(g.errinfo){h=_T(g.errinfo.sec,g.errinfo.key)}else{h=_T("common","commfail")}}this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),h);return}this.updateServiceWithMask(true);this.setStatusOK({text:_T("common","setting_applied"),clear:true})},failure:function(e,f){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+e.responseText)},scope:this})},onCancel:function(){if(this.isDirty()){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","confirm_refresh"),function(a){if("yes"===a){this.updateServiceWithMask(true)}},this)}},updateServiceWithMaskDone:function(a,c){var e=Ext.decode(a.responseText);var g=Ext.decode(c.params);this.appWin.clearStatusBusy();if(e.success){var d={};d.items=e.service;if(this.mainPanel.serviceStore.getCount()!==d.items.length||true===g.reload){this.mainPanel.serviceStore.loadData(d,false);this.mainPanel.serviceStore.commitChanges()}else{for(var b=0;b<d.items.length;b++){var f=this.mainPanel.serviceStore.getById(d.items[b].name);if(f){f.set("status",d.items[b].status);if(f.modified&&"monitoring" in f.modified){continue}if(f.get("monitoring")===d.items[b].monitoring){continue}f.set("monitoring",d.items[b].monitoring);f.commit()}else{this.mainPanel.serviceStore.loadData(d,false);this.mainPanel.serviceStore.commitChanges();break}}}}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},updateServiceWithMask:function(a){this.appWin.setStatusBusy(_T("common","loading"));Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode({action:"load_monitoring",reload:a}),success:this.updateServiceWithMaskDone,failure:function(b,c){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+b.responseText)},scope:this})},setStatusError:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","error_system"),iconCls:"syno-ux-statusbar-error",clear:true});this.getFooterToolbar().setStatus(b)},setStatusOK:function(b){b=b||{};Ext.applyIf(b,{text:_T("common","setting_applied"),iconCls:"syno-ux-statusbar-success"});this.getFooterToolbar().setStatus(b)}});Ext.define("SYNO.SDS.HA.HAServiceListPanel",{extend:"SYNO.ux.EditorGridPanel",serviceStore:null,toolbar:null,columnModel:null,enableColumn:null,PollTask:null,constructor:function(a){this.enableColumn=new SYNO.ux.EnableColumn({header:_TT("SYNO.SDS.HA.Instance","ui","monitoring"),dataIndex:"monitoring",menuDisabled:true,sortable:false,width:0.15,align:"left"});this.initForm();var b={border:false,store:this.serviceStore,plugins:[this.enableColumn],colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:false}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){},this);this.getSelectionModel().on("rowdeselect",function(d,c){},this);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},initForm:function(){var b=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"name"},["name","status","monitoring","type"]),remoteSort:false});this.serviceStore=b;var a=new Ext.grid.ColumnModel({columns:[{header:_TT("SYNO.SDS.HA.Instance","service","subject"),dataIndex:"name",width:0.25,align:"left",renderer:SYNO.SDS.HA.ServiceRenderer},{header:_TT("SYNO.SDS.HA.Instance","service","status"),dataIndex:"status",width:0.1,align:"left",renderer:this.statusRenderer},this.enableColumn],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},StopAjaxRequest:function(a){if(this.PollTask){this.PollTask.stop()}},statusRenderer:function(a){return _TT("SYNO.SDS.HA.Instance","service",a)}});Ext.define("SYNO.SDS.HA.HAPanelSpaceStatus",{extend:"Ext.Panel",PollTask:null,constructor:function(a){this.appWin=a.appWin;var b=this.fillConfig(a);this.callParent([b]);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"logout",this.StopAjaxRequest,this);this.mon(SYNO.SDS.StatusNotifier,"halt",this.StopAjaxRequest,this)},fillConfig:function(a){var b={border:false,itemId:"space",layout:"fit",style:"padding: 0px 0px 10px 0px;",items:[this.mainPanel=new SYNO.SDS.HA.HASpaceListPanel({appWin:this.appWin,owner:this})]};return b},StopAjaxRequest:function(){if(this.PollTask){this.PollTask.stop()}},onPageActivate:function(){this.updateSpaceWithMask();if(!this.PollTask){this.PollTask=this.addAjaxTask({interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_space"},success:this.updateSpaceWithMaskDone,failure:function(a,b){SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}this.PollTask.start(false)},onPageDeactivate:function(){this.PollTask.stop()},updateSpaceWithMaskDone:function(a,c){this.appWin.clearStatusBusy();var e=Ext.decode(a.responseText);if(e.success){var d={};d.items=e.spaces;if(this.mainPanel.spaceStore.getCount()!==e.spaces.length){this.mainPanel.spaceStore.loadData(d,false)}else{for(var b=0;b<e.spaces.length;b++){var f=this.mainPanel.spaceStore.getById(e.spaces[b].name);if(f){f.set("name",e.spaces[b].name);f.set("free_size",e.spaces[b].free_size);f.set("total_size",e.spaces[b].total_size);f.set("status",e.spaces[b].status);f.set("description",e.spaces[b].description);f.set("enable_repair",e.spaces[b].enable_repair)}else{this.mainPanel.spaceStore.loadData(d,false);break}}}this.mainPanel.spaceStore.commitChanges()}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}this.mainPanel.changeButtonStatus(this.mainPanel.getSelectionModel())},updateSpaceWithMask:function(){this.appWin.setStatusBusy();Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_space"},success:this.updateSpaceWithMaskDone,failure:function(a,b){this.appWin.clearStatusBusy();SYNO.Debug("Ajax load failure "+a.responseText)},scope:this})}});Ext.define("SYNO.SDS.HA.HASpaceListPanel",{extend:"SYNO.ux.EditorGridPanel",spaceStore:null,columnModel:null,toolbar:null,constructor:function(a){this.appWin=a.appWin;this.owner=a.owner;this.initForm();var b={store:this.spaceStore,border:false,cls:"syno-ha-space-space-list-detail",tbar:this.toolbar,height:533,colModel:this.columnModel,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,stripeRows:true};Ext.apply(b,a);this.callParent([b]);this.getSelectionModel().on("rowselect",function(d,c,e){this.changeButtonStatus(d)},this);this.getSelectionModel().on("rowdeselect",function(d,c){this.changeButtonStatus(d)},this)},initForm:function(){var b=[{xtype:"syno_button",text:_TT("SYNO.SDS.HA.Instance","space","repair"),id:this.repairBtnID=Ext.id(),handler:this.onRepair,disabled:true,scope:this,hidden:false}];this.toolbar=b;var c=new Ext.data.Store({proxy:new Ext.data.MemoryProxy([]),reader:new Ext.data.JsonReader({root:"items",id:"name"},[{name:"name",sortType:function(d){var f;var e;if(-1!==d.indexOf("iscsilun_LUN")){f=d.split("-");if(1<f.length){e=parseInt(f[1],10);if(!isNaN(e)){return e}}}else{if(-1!==d.indexOf("volume")){f=d.split("_");if(1<f.length){e=parseInt(f[1],10);if(!isNaN(e)){return e*1000}}}}return d}},"free_size","total_size","status","description","enable_repair"]),sortInfo:{field:"name",direction:"ASC"},remoteSort:false});this.spaceStore=c;var a=new Ext.grid.ColumnModel({columns:[{id:"name",header:_TT("SYNO.SDS.HA.Instance","space","space_name"),dataIndex:"name",width:0.15,align:"left",renderer:function(d,e){return SYNO.SDS.Utils.StorageUtils.SpaceIDParser(d).str}},{id:"size_in_percentage",header:_T("volume","volume_usedsize")+" (%)",dataIndex:"free_size",width:0.2,align:"left",renderer:function(d,f,g){var e=((g.get("total_size")-g.get("free_size"))*100/g.get("total_size")).toFixed(1);if(isNaN(e)||""===g.get("free_size")||""===g.get("total_size")){return"-"}else{return String.format('<div id="syno-ha-progress"><div style="width: {0}%;"></div></div><span style="display: inline;">{1}%</span>',e,e)}}},{header:_T("usb","usb_size"),dataIndex:"total_size",width:0.15,align:"left",renderer:function(d,g,h){var e=((h.get("total_size")-h.get("free_size"))/1073741824).toFixed(2);var f=(h.get("total_size")/1073741824).toFixed(2);if(isNaN(f)||""===h.get("total_size")){return"-"}if(isNaN(e)||""===h.get("free_size")){return f+"GB"}else{return e+" / "+f+"GB"}}},{header:_T("common","status"),dataIndex:"status",width:0.1,align:"left",renderer:this.SpaceStatusRender},{header:_TT("SYNO.SDS.HA.Instance","space","desc"),dataIndex:"description",width:0.25,align:"left",renderer:function(f){var e="";var d=0;if(0!==f.length){for(d=0;d<f.length;d++){if(-1!==f[d].indexOf("syncing")){e+=f[d].replace("syncing",_TT("SYNO.SDS.HA.Instance","space","syncing"))+" "}else{if(-1!==f[d].indexOf("local_raid_expanding")){e+=f[d].replace("local_raid_expanding",_TT("SYNO.SDS.HA.Instance","space","local_raid_expanding"))+" "}else{if(-1!==f[d].indexOf("local_raid_rebuilding")){e+=f[d].replace("local_raid_rebuilding",_TT("SYNO.SDS.HA.Instance","space","local_raid_rebuilding"))+" "}else{if(-1!==f[d].indexOf("local_ssd_raid_rebuilding")){e+=f[d].replace("local_ssd_raid_rebuilding",_TT("SYNO.SDS.HA.Instance","space","local_ssd_raid_rebuilding"))+" "}else{if(-1!==f[d].indexOf("remote_raid_expanding")){e+=f[d].replace("remote_raid_expanding",_TT("SYNO.SDS.HA.Instance","space","remote_raid_expanding"))+" "}else{if(-1!==f[d].indexOf("remote_raid_rebuilding")){e+=f[d].replace("remote_raid_rebuilding",_TT("SYNO.SDS.HA.Instance","space","remote_raid_rebuilding"))+" "}else{if(-1!==f[d].indexOf("remote_ssd_raid_rebuilding")){e+=f[d].replace("remote_ssd_raid_rebuilding",_TT("SYNO.SDS.HA.Instance","space","remote_ssd_raid_rebuilding"))+" "}else{if(-1!==f[d].indexOf("desc_passive_offline")){e+=f[d].replace("desc_passive_offline",_TT("SYNO.SDS.HA.Instance","space","desc_passive_offline"))+" "}else{if(-1!==f[d].indexOf("desc_no_passive")){e+=f[d].replace("desc_no_passive",_TT("SYNO.SDS.HA.Instance","space","desc_no_passive"))+" "}else{if(-1!==f[d].indexOf("preparing")){e+=f[d].replace("preparing",_T("volume","volume_status_waiting"))+" "}else{if(""!==f[d]){e+=_TT("SYNO.SDS.HA.Instance","space",f[d])+" "}}}}}}}}}}}}}else{e=_T("volume","volume_status_waiting")}if(""===e){e=_TT("SYNO.SDS.HA.Instance","space","space_status_normal")}return'<div ext:qtip="'+Ext.util.Format.htmlEncode(e)+'">'+e+"</div>"}}],defaults:{sortable:false,menuDisabled:true}});this.columnModel=a},handleDiskRender:function(b){var d;var c=b.split(" ");var a="";if(0<c.length){for(d=0;d<c.length;d++){if(""===a){a=SYNO.SDS.HA.HADiskIndexRenderer(c[d])}else{a+=" , "+SYNO.SDS.HA.HADiskIndexRenderer(c[d])}}}return a},onRepairDone:function(a,b){var c=Ext.decode(a.responseText);var d="";this.appWin.clearStatusBusy();if(c&&c.success){this.owner.PollTask.start(true);this.owner.updateSpaceWithMask()}else{if("none"!==c.hdd_missing){d=String.format(_TT("SYNO.SDS.HA.Instance","space","error_hdd_missing"))+"<br>";d+=this.handleDiskRender(c.hdd_missing);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d,function(e){if("ok"===e){this.owner.PollTask.start(true)}},this)}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_unknown"),function(e){if("ok"===e){this.owner.PollTask.start(true)}},this)}}},onRepair:function(){var a=this.getSelectionModel().getSelected();var b={};if(-1!==a.get("description").indexOf("local_raid_degraded")||-1!==a.get("description").indexOf("local_raid_crashed")){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","space","repair_local_desc"),function(c){if("yes"===c){if("SYNO.SDS.CMS.Application"!==this.appWin.findAppWindow().getOpenConfig("className")){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}}},this);return}if(-1!==a.get("description").indexOf("local_ssd_raid_degraded")||-1!==a.get("description").indexOf("local_ssd_raid_crashed")){this.appWin.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","space","repair_local_fcache_desc"),function(c){if("yes"===c){if("SYNO.SDS.CMS.Application"!==this.appWin.findAppWindow().getOpenConfig("className")){SYNO.SDS.AppLaunch("SYNO.SDS.StorageManager.Instance")}}},this);return}if(-1!==a.get("description").indexOf("remote_ssd_raid_crashed")||-1!==a.get("description").indexOf("remote_ssd_raid_degraded")){b.action="repair_flashcache"}else{b.action="repair_space"}b.target=a.get("name");this.owner.PollTask.stop();this.appWin.setStatusBusy({text:_T("pkgmgr","repairing")});Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",timeout:300000,params:Ext.util.JSON.encode(b),success:this.onRepairDone,failure:function(c,d){this.appWin.clearStatusBusy();this.owner.PollTask.start(true);SYNO.Debug("Ajax load failure "+c.responseText)},scope:this})},changeButtonStatus:function(a){var c=Ext.getCmp(this.repairBtnID);var b=a.getSelected();if(!b||_S("ha_safemode")){c.disable();return}if(b.get("enable_repair")){c.enable()}else{c.disable()}},getStatus:function(a,b){this.appWin.clearStatusBusy()},SpaceStatusRender:function(a){if("normal"===a){return'<span class="syno-ha-service-status-health">'+_T("volume","volume_diskinuse")+"</span>"}else{if("operating"===a){return'<span class="syno-ha-service-status-health">'+_TT("SYNO.SDS.HA.Instance","space","operating")+"</span>"}else{if("error"===a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_status_crashed")+"</span>"}else{if("warning"===a){return'<span class="syno-ha-service-status-error">'+_T("volume","volume_status_degrade")+"</span>"}else{if("cannot_replicate"===a){return'<span class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","space","status_not_replicating")+"</span>"}else{if("no_replication"===a){return'<span class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","space","status_no_replication")+"</span>"}else{return"undefine"}}}}}}}});Ext.ns("SYNO.SDS.HA");Ext.define("SYNO.SDS.HA.NodeSetupPanel",{extend:"SYNO.ux.FormPanel",ServerStore:null,constructor:function(b){this.ServerList=[];this.ServerStore=new Ext.data.SimpleStore({fields:["value","display"],data:this.ServerList});var a={padding:"20px 0px 0px 0px",style:"text-align: center;",items:[{xtype:"syno_textfield",hideLabel:true,name:"server",allowBlank:false,emptyText:_T("common","ip_addr"),editable:true,width:410,validator:function(h){var e="";var c="";var g=new RegExp(e,"gi");if(h===c||h==="127.0.0.1"||(h.match(g)&&h.length===e.length)){return _T("netbackup","netbkp_sync_self")}var f=c.split(",");for(var d=0;d<f.length;d++){if(h===f[d]){return _T("netbackup","netbkp_sync_self")}}return true}},{xtype:"syno_textfield",hideLabel:true,name:"account",allowBlank:false,emptyText:_T("netbackup","netbkp_account"),width:410,vtype:"username_ext"},{xtype:"syno_textfield",hideLabel:true,name:"password",allowBlank:false,emptyText:_T("common","password"),inputType:"password",width:410},{xtype:"syno_textfield",hideLabel:true,name:"otp_code",emptyText:_T("login","enter_otp_desc"),hidden:true,disabled:true,width:410,validator:function(e){var d=/[0-9]{6}/;var c=/[0-9]{8}/;if(d.exec(e)||c.exec(e)){return true}return false}}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){},getBack:function(){var a=this.getForm();if(true===a.findField("otp_code").disabled){return"welcome"}else{a.findField("server").show();a.findField("account").show();a.findField("password").show();a.findField("otp_code").hide();a.findField("otp_code").setValue("");a.findField("otp_code").disable();return false}},saveSettings:function(){var a=this.getForm().findField("server").getRawValue();this.owner.passiveIP=SYNO.SDS.HA.GetServerIP(a);this.owner.account=this.getForm().findField("account").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.testConnections("next");return false},summary:function(e){var d=this.getForm();var b=d.findField("server").getRawValue();var a=SYNO.SDS.HA.GetServerName(b);var c=SYNO.SDS.HA.GetServerIP(b);var f;if(a!==""){f=a;if(c!==""){f+="("+c+")"}}else{f=c}e.append(_TT("SYNO.SDS.HA.Instance","wizard","hapassive_node"),f);e.append(_T("common","username"),d.findField("account").getValue())},remoteVerifyDone:function(c,e,b){var a;this.owner.el.unmask();if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.owner.groupInfo=a.group_info;if(true===a.group_info.is_hybrid||true===a.group_info.mem_size_unmatched){var d=_TT("SYNO.SDS.HA.Instance","wizard","warning_different_infor")+"<br>";if(true===a.group_info.is_hybrid){d+=_T("common","ds_model")+"<br>"}if(true===a.group_info.mem_size_unmatched){d+=_T("status","ramsize")+"<br>"}d+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","warning_performance_degraded");this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d,function(f){if("ok"===f){this.owner.goNext(this.nextId)}},this)}else{this.owner.goNext(this.nextId)}}else{if(a.errinfo.app){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT(a.errinfo.app,a.errinfo.sec,a.errinfo.key))}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(a.errinfo.sec,a.errinfo.key))}}}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_unknown"))}},remoteVerify:function(){var a={};a.action="verify_remote";a=this.getParamsVal(a);if(a){this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:a,callback:this.remoteVerifyDone,scope:this},this)}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"))}},testConnectionWhenGoNext:function(d,e,b){var a;this.owner.el.unmask();if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.remoteVerify()}else{if(true===a.request_otp){var c=this.getForm();c.findField("otp_code").enable();c.findField("otp_code").show();c.findField("server").hide();c.findField("account").hide();c.findField("password").hide()}else{if(a.errinfo.app){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT(a.errinfo.app,a.errinfo.sec,a.errinfo.key))}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(a.errinfo.sec,a.errinfo.key))}}}}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","error_system"))}},testConnections:function(b){var a={};a.action="login_remote";a=this.getParamsVal(a);if(a){this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:a,callback:this.testConnectionWhenGoNext,scope:this},this)}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"))}},getParamsVal:function(e){var d=this.getForm();var a=SYNO.SDS.HA.GetServerName(d.findField("server").getRawValue());var c=SYNO.SDS.HA.GetServerIP(d.findField("server").getRawValue());var f=d.findField("account").getValue();var b=d.findField("password").getValue();if(a===""&&c===""){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("netbackup","netbkp_err_host_str"));return false}e.server=a;e.address=c;e.username=f;e.passwd=b;if(false===d.findField("otp_code").disabled){e.otp_code=d.findField("otp_code").getValue()}return Ext.util.JSON.encode(e)}});Ext.define("SYNO.SDS.HA.ChannelSetupPanel",{extend:"SYNO.ux.FormPanel",LANStore:null,loginIf:"",constructor:function(b){this.filteredLANList=[];this.allLANList=[];this.LANStore=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:this.filteredLANList});var a={padding:"0px",cls:"syno-ha-wizard-channel-setup-panel",items:[{xtype:"syno_displayfield",value:_TT("SYNO.SDS.HA.Instance","wizard","drbd_channel")},{xtype:"syno_combobox",synotype:"indent",hideLabel:true,name:"lanport",allowBlank:false,editable:false,store:this.LANStore,displayField:"display",valueField:"value",triggerAction:"all",width:SYNO.SDS.HA.CONF_CONTD_WIDTH,mode:"local",owner:this},{xtype:"panel",hideLabel:true,id:this.connectionFigID=Ext.id(),padding:"8px 0px 8px 0px",width:560,height:160,border:false,cls:"syno-ha-wizard-channel-setup-figure"},{xtype:"syno_displayfield",value:'<font class="syno-ha-service-status-error">'+_TT("SYNO.SDS.HA.Instance","wizard","desc_heartbeat_constraint")+"</font>"}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a]);this.mon(this.getForm().findField("lanport"),"select",this.refreshPicture,this)},activate:function(){this.filteredLANList.length=0;this.allLANList.length=0;this.LANListEnum()},refreshPicture:function(){var a=this.getForm().findField("lanport").getValue();this.applyLANImage(Ext.getCmp(this.connectionFigID),a)},saveSettings:function(){this.owner.dataRepChannel=this.getForm().findField("lanport").getValue();this.owner.activeLoginIf=this.loginIf},checkLANDone:function(c,e,b){this.owner.el.unmask();if(e&&b.responseText){var a=Ext.util.JSON.decode(b.responseText);var d="";if(!a.success){if("error_active_direct_connect"===a.errinfo.key){d=String.format(_TT(a.errinfo.app,a.errinfo.sec,a.errinfo.key),SYNO.SDS.Utils.Network.idToString.apply(this,[this.owner.dataRepChannel]));this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(a.errinfo.sec,a.errinfo.key))}return}this.CheckHeartbeatLink()}},CheckHeartbeatLinkDone:function(c,e,b){this.owner.el.unmask();if(e&&b.responseText){var a=Ext.util.JSON.decode(b.responseText);var d="";if(!a.success){if(""!==a.errinfo.key){d=_TT(a.errinfo.app,a.errinfo.sec,a.errinfo.key);if(""===d){d=_T(a.errinfo.sec,a.errinfo.key)}this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),d)}return}this.owner.goNext(this.nextId)}},checkLAN:function(){var a={};a.action="check_directconnect";a["interface"]=this.getForm().findField("lanport").getValue();this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode(a),method:"POST",callback:this.checkLANDone,scope:this},this)},CheckHeartbeatLink:function(){var a={};a.action="check_heartbeat_link";a["interface"]=this.getForm().findField("lanport").getValue();a.remote_addr=this.owner.passiveIP;this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode(a),method:"POST",callback:this.CheckHeartbeatLinkDone,scope:this},this)},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.checkLAN();return false},summary:function(a){a.append(_TT("SYNO.SDS.HA.Instance","wizard","drbd_channel"),SYNO.SDS.Utils.Network.idToString.apply(this,[this.owner.dataRepChannel]))},LANListEnumDone:function(e,f,c){this.owner.el.unmask();if(f&&c.responseText){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(a.errinfo.sec,a.errinfo.key));this.owner.getButton("next").disable();return}this.loginIf=a.loginIf;for(var b=0;b<a.lanlist.length;b++){if("On"!==a.lanlist[b].status){continue}if(-1===a.lanlist[b].id.indexOf("eth")&&-1===a.lanlist[b].id.indexOf("bond")){continue}var d=SYNO.SDS.Utils.Network.idToString.apply(this,[a.lanlist[b].id])+((10000>a.lanlist[b].speed)?"":" ("+a.lanlist[b].speed/1000+"Gbps)");if(1!==a.lanlist.length||-1===d.indexOf("1")){this.allLANList.push([a.lanlist[b].id,d])}else{this.allLANList.push([a.lanlist[b].id,_T("helptoc","lan")])}if(a.loginIf===a.lanlist[b].id){continue}if(a.has10GEthernet&&10000>a.lanlist[b].speed){continue}if(1!==a.lanlist.length||-1===d.indexOf("1")){this.filteredLANList.push([a.lanlist[b].id,d])}else{this.filteredLANList.push([a.lanlist[b].id,_T("helptoc","lan")])}}this.LANStore.loadData(this.filteredLANList,false);if(0<this.filteredLANList.length){this.getForm().findField("lanport").setValue(this.filteredLANList[0][0]);this.applyLANImage(Ext.getCmp(this.connectionFigID),this.filteredLANList[0][0])}else{this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","error_system"));this.owner.getButton("next").disable()}},applyLANImage:function(b,c){for(var a=0;a<SYNO.SDS.HA.CONF_MAX_HA_IF_NUM;a++){b.removeClass("syno-ha-wizard-channel-eth"+a)}b.addClass("syno-ha-wizard-channel-"+c)},LANListEnum:function(){var a={};a.action="enum_lanlist";this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:a,method:"POST",callback:this.LANListEnumDone,scope:this},this)}});Ext.define("SYNO.SDS.HA.NetSetupPanel",{extend:"SYNO.ux.FormPanel",LANStore:null,constructor:function(b){this.owner=b.owner;this.LANList=[];this.LANStore=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:this.LANList});var a={padding:"0px",items:[{xtype:"syno_textfield",fieldLabel:_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),name:"hostname",vtype:"netbiosName",maxlength:15,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH},{xtype:"syno_displayfield",indent:0,value:_TT("SYNO.SDS.HA.Instance","wizard","virtual_ip_interface")},{xtype:"syno_combobox",indent:2,synotype:"indent",fieldLabel:_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),name:"lanport",allowBlank:false,editable:false,store:this.LANStore,displayField:"display",valueField:"value",triggerAction:"all",labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH,mode:"local",owner:this},{xtype:"syno_textfield",indent:2,fieldLabel:_T("common","ip_addr"),name:"ip_addr",vtype:"ip",maxlength:64,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH},{xtype:"syno_textfield",indent:2,fieldLabel:_T("pppoe","pppoe_mask"),name:"net_mask",vtype:"netmask",maxlength:64,allowBlank:false,labelWidth:SYNO.SDS.HA.CONF_LABEL_WIDTH,width:SYNO.SDS.HA.CONF_CONTD_WIDTH}]};SYNO.LayoutConfig.fill(a);Ext.apply(a,b);this.callParent([a])},activate:function(){this.LANList.length=0;this.updateLANList()},saveSettings:function(){var a=this.getForm();this.owner.hostname=a.findField("hostname").getValue();this.owner.netInterface=a.findField("lanport").getValue();this.owner.netIP=a.findField("ip_addr").getValue();this.owner.netMask=a.findField("net_mask").getValue()},networkCheckDone:function(c,a){var b=Ext.decode(c.responseText);this.owner.el.unmask();if(!b.success){if(b.errinfo.app){this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT(b.errinfo.app,b.errinfo.sec,b.errinfo.key))}else{this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T(b.errinfo.sec,b.errinfo.key))}return}this.owner.goNext(this.nextId)},checkSetting:function(){var b={};var a=this.getForm();b.action="network_check";b.hostname=a.findField("hostname").getValue();b.net_interface=a.findField("lanport").getValue();b.net_ip=a.findField("ip_addr").getValue();b.net_mask=a.findField("net_mask").getValue();this.owner.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,params:Ext.util.JSON.encode(b),success:this.networkCheckDone,failure:function(d,c){this.owner.el.unmask();SYNO.Debug("Ajax load failure "+d.responseText);this.owner.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))},scope:this},this)},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.checkSetting();return false},summary:function(c){var b=this.getForm();var a=b.findField("lanport").getValue();c.append(_TT("SYNO.SDS.HA.Instance","ui","virtual_server"),b.findField("hostname").getValue());c.append(_TT("SYNO.SDS.HA.Instance","wizard","network_interface"),SYNO.SDS.Utils.Network.idToString.apply(this,[a]));c.append(_T("common","ip_addr"),b.findField("ip_addr").getValue());c.append(_T("pppoe","pppoe_mask"),b.findField("net_mask").getValue())},updateLANList:function(){var c=this.owner.PanelChannelSetup.allLANList;var a=0;for(var b=0;b<c.length;b++){if(this.owner.dataRepChannel!==c[b][0]){this.LANList.push([c[b][0],c[b][1]]);if(this.owner.activeLoginIf===c[b][0]){a=this.LANList.length-1}}}this.LANStore.loadData(this.LANList,false);if(0<this.LANList.length){this.getForm().findField("lanport").setValue(this.LANList[a][0])}else{this.owner.getButton("next").disable()}}});Ext.define("SYNO.SDS.HA.HASetupWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",selfIPs:null,selfHostName:null,groupInfo:null,passiveIP:null,account:null,dataRepChannel:null,activeLoginIf:null,hostname:null,netInterface:null,netIP:null,netMask:null,binding_progress_desc:null,binding_progress:null,PollTask:null,PanelWelcome:null,PanelNodeSetup:null,PanelChannelSetup:null,PanelNetSetup:null,PanelSummary:null,constructor:function(c){var a=SYNO.SDS.HA;this.appWin=c.owner;this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_TT("SYNO.SDS.HA.Instance","wizard","welcome_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","welcome_desc"),itemId:"welcome",nextId:"nodesetup",owner:this,getNext:function(){var d={};this.owner.setStatusBusy();d.action="wizard_first_check";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(d),success:function(e,f){var g=Ext.decode(e.responseText);this.owner.clearStatusBusy();if(g.success){this.owner.goNext(this.nextId)}else{var h="";if(g.errinfo.app){h=_TT("SYNO.SDS.HA.Instance",g.errinfo.sec,g.errinfo.key);if("service_not_supported_active"===g.errinfo.key){h+="<br>"+_T("network","proxy_enabled")}}else{h=_T(g.errinfo.sec,g.errinfo.key)}this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),h);return false}},failure:function(e,f){this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","error_unknown"));SYNO.Debug("Ajax load failure "+e.responseText);return false},scope:this});return false}});this.PanelNodeSetup=new a.NodeSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","nodesetup_desc"),itemId:"nodesetup",nextId:"channelsetup",header:false,owner:this});this.PanelChannelSetup=new a.ChannelSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","channel_setup_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","channel_setup_desc"),itemId:"channelsetup",nextId:"netsetup",header:false,owner:this});this.PanelNetSetup=new a.NetSetupPanel({headline:_TT("SYNO.SDS.HA.Instance","wizard","virtual_network_title"),description:_TT("SYNO.SDS.HA.Instance","wizard","virtual_network_desc"),itemId:"netsetup",nextId:"summary",header:false,owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({autoScroll:true,headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.getMsgBox().confirm(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","warning_binding_remote_stop_service"),function(d){if("yes"===d){this.owner.applySetting();return false}return false},this);return false},owner:this});var b=[this.PanelWelcome,this.PanelNodeSetup,this.PanelChannelSetup,this.PanelNetSetup,this.PanelSummary];this.callParent([Ext.apply({title:_TT("SYNO.SDS.HA.Instance","wizard","wizard_title"),width:600,height:525,steps:b},c)])},genApplyParams:function(){var a={};a.action="activate_ha";a.mode="activate";a.remote_address=SYNO.SDS.HA.GetServerIP(this.PanelNodeSetup.getForm().findField("server").getRawValue());a.is_hybrid=this.groupInfo.is_hybrid;a.model_group=this.groupInfo.model_group;a.model0=this.groupInfo.model0;a.model1=this.groupInfo.model1;a.lan_num=this.groupInfo.lan_num;a.drbd_if=this.dataRepChannel;a.ha_hostname=this.hostname;a.ha_if=this.netInterface;a.ha_ip=this.netIP;a.ha_netmask=this.netMask;return Ext.util.JSON.encode(a)},updateBindingProgress:function(b,a){var c=Ext.decode(b.responseText);this.el.unmask();if(c.success){this.binding_progress_desc=c.binding_progress_desc;this.binding_progress=c.binding_progress}else{this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("error","error_error_system"))}},bindRemoteDone:function(b,r,p){this.el.unmask();if(r){var j=Ext.decode(p.responseText);var f="";var q;var g="";var o=0;var l=0;var e=0;var h=0;if(j.disk_validation){q=j.disk_validation;if(q.error_size){o=q.error_size.length}if(q.error_type){l=q.error_type.length}if(q.error_log_sect_size){e=q.error_log_sect_size.length}}if(null!==j&&true===j.success){SYNO.SDS.StatusNotifier.fireEvent("halt");this.PollTask=this.addAjaxTask({preventHalt:true,interval:5000,url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:{action:"load_binding_progress"},success:this.updateBindingProgress,failure:function(i,s){SYNO.Debug("Ajax load failure "+i.responseText)},scope:this});this.PollTask.start(true);this.waitForBinding({times:1800000/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_response")})}else{if(j.errinfo){if("wizard"===j.errinfo.sec&&"error_volume_number"===j.errinfo.key){var n=_D("max_ha_spacecount");var k=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_volume_number"),n);this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),k)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance",j.errinfo.sec,j.errinfo.key))}}else{if(0<o||0<l||0<e){for(h=0;h<o;h++){if(h===0){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_size"))+"<br>";f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_size[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_size[h])}}if(""!==f&&0<l){f=f+"<br>"}for(h=0;h<l;h++){if(h===0){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_type"))+"<br>"}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_type"))+"<br>"}f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_type[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_type[h])}}if(""!==f&&0<e){f=f+"<br>"}for(h=0;h<e;h++){if(h===0){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_log_sect_size"))+"<br>"}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_disk_log_sect_size"))+"<br>"}f=f+SYNO.SDS.HA.HADiskIndexRenderer(q.error_log_sect_size[h])}else{if((h%10)===0){f=f+"<br>"}f=f+", "+SYNO.SDS.HA.HADiskIndexRenderer(q.error_log_sect_size[h])}}if(""!==f){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),f)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}else{if(!j.link_aggr_valid&&(0<j.link_aggr_conflict_if.length)){if(""!==f){f+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","error_link_aggr_conflict")+"<br>"}else{f+=_TT("SYNO.SDS.HA.Instance","wizard","error_link_aggr_conflict")+"<br>"}for(h=0;h<j.link_aggr_conflict_if.length;h++){if(h===0){f+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.link_aggr_conflict_if[h]])}else{f+=", "+SYNO.SDS.Utils.Network.idToString.apply(this,[j.link_aggr_conflict_if[h]])}}}if(!j.vlan_valid&&(0<j.vlan_conflict_if.length)){if(""!==f){f+="<br>"+_TT("SYNO.SDS.HA.Instance","wizard","error_vlan_conflict")+"<br>"}else{f+=_TT("SYNO.SDS.HA.Instance","wizard","error_vlan_conflict")+"<br>"}for(h=0;h<j.vlan_conflict_if.length;h++){if(h===0){f+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.vlan_conflict_if[h]])}else{f+=", "+SYNO.SDS.Utils.Network.idToString.apply(this,[j.vlan_conflict_if[h]])}}}if(!j.swap_valid){if(""!==f){f+="<br>"}f+=_TT("SYNO.SDS.HA.Instance","wizard","error_swap_setting")}if(0<j.passive_disabled_if.length){if(""!==f){f+="<br>"}var c="";for(h=0;h<j.passive_disabled_if.length;h++){c+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_disabled_if[h]])}f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_if_disabled"),c)}var d=false;var m=false;if(j.active_node&&j.active_node.drbdip_conflict){d=true}if(j.passive_node&&j.passive_node.drbdip_conflict){m=true}if(d||m){var a="";if(""!==f){f+="<br>"}if(d){for(h=0;h<j.active_node.conflict_ip.size();h++){if(""!==a){a+=", "}a+=j.active_node.conflict_ip[h]}}if(m){for(h=0;h<j.passive_node.conflict_ip.size();h++){if(""!==a){a+=", "}a+=j.passive_node.conflict_ip[h]}}f+=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_drbdip_conflict"),a)}if(j.active_dhcp){if(j.active_dhcp_haif){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_dhcp_haif]))}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_dhcp_haif]))}}}if(j.passive_dhcp){if(j.passive_dhcp_haif){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_dhcp_haif]))}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_is_dhcp"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_dhcp_haif]))}}}if(!j.passive_directconnect){if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_direct_connect"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_directconnect_if]))}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_direct_connect"),SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_directconnect_if]))}}if(j.active_firewall_err){g="";for(h=0;h<j.active_firewall_err_ifs.size();h++){g+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.active_firewall_err_ifs[h]])+" "}if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_firewall"),g)}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_active_firewall"),g)}}if(j.passive_firewall_err){g="";for(h=0;h<j.passive_firewall_err_ifs.size();h++){g+=SYNO.SDS.Utils.Network.idToString.apply(this,[j.passive_firewall_err_ifs[h]])+" "}if(""===f){f=String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_firewall"),g)}else{f=f+"<br>"+String.format(_TT("SYNO.SDS.HA.Instance","wizard","error_passive_firewall"),g)}}if(j.active_node){if(j.active_node.shr_enable){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","desc_shr_not_supported_active")}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","desc_shr_not_supported_active")}}for(h=0;h<j.active_node.none_supported_services.length;h++){if(h===0){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_active")+"<br>"}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_active")+"<br>"}f=f+_TT("SYNO.SDS.HA.Instance","overview",j.active_node.none_supported_services[h])}else{f=f+", "+_TT("SYNO.SDS.HA.Instance","overview",j.active_node.none_supported_services[h])}}}if(j.passive_node){if(j.passive_node.shr_enable){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","desc_shr_not_supported_passive")}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","desc_shr_not_supported_passive")}}for(h=0;h<j.passive_node.none_supported_services.length;h++){if(h===0){if(""===f){f=_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_passive")+"<br>"}else{f=f+"<br>"+_TT("SYNO.SDS.HA.Instance","overview","service_not_supported_passive")+"<br>"}f=f+_TT("SYNO.SDS.HA.Instance","overview",j.passive_node.none_supported_services[h])}else{f=f+", "+_TT("SYNO.SDS.HA.Instance","overview",j.passive_node.none_supported_services[h])}}}if(""!==f){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),f)}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}}}}else{if(-1===p.status){this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("download","download_task_timeout"))}else{this.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_T("common","commfail"))}}},redirect:function(a,c,e){var d=e||20000;var b=0;if(!Ext.isString(a)||!Ext.isArray(c)){return}SYNO.SDS.StatusNotifier.fireEvent("redirect");window.onbeforeunload=null;var f=function(g){SYNO.Debug("try "+c[g%c.length]);location.assign(a.replace("__WEBMAN_ADDR__",c[g%c.length]))};f.defer(d,this,[0]);for(b=0;b<3;b++){d+=10000;f.defer(d,this,[0])}for(b=1;b<=c.length;b++){d+=10000;f.defer(d,this,[b])}this.waitForNewIP({times:d/1000,msg:_TT("SYNO.SDS.HA.Instance","wizard","wait_for_newIP")})},waitForNewIP:function(e){var f=e.times||10;var b=f;var c=e.interval||1000;var a=Ext.isDefined(e.no_close)?e.no_close:true;SYNO.SDS.Desktop.getMsgBox().show({title:e.title||this.title,width:e.width||240,progress:true,closable:false});var d=function(){b--;if(0===b&&!a){if(Ext.isFunction(e.callback)){e.callback.call(e.scope||this)}SYNO.SDS.Desktop.getMsgBox().hide();return}if(0===b){b=f}SYNO.SDS.Desktop.getMsgBox().updateProgress(1-b/f,_TT("SYNO.SDS.HA.Instance","wizard","wait_for_newIP"));d.defer(c,this)};d.defer(c,this)},sendRedirectReq:function(){var a={};this.owner.el.mask(_T("common","loading"),"x-mask-loading");a.action="redirect_ip";a.mode="activate_ha";Ext.Ajax.request({url:SYNO.SDS.HA.CONF_CGI_PATH,method:"POST",params:Ext.util.JSON.encode(a),success:function(b,c){var d=Ext.decode(b.responseText);this.owner.el.unmask();if(d.success){this.redirect(d.redirect_url,d.ip_list)}},failure:function(b,c){this.owner.el.unmask();SYNO.Debug("Ajax load failure "+b.responseText)},scope:this})},waitForBinding:function(d){var e=d.times||10;var a=e;var b=d.interval||1000;SYNO.SDS.Desktop.getMsgBox().show({title:d.title||this.title,width:d.width||240,progress:true,closable:false});var c=function(){a--;if("stage_binding_done"===this.binding_progress_desc){this.PollTask.stop();this.scope.PollTask.start(true);SYNO.SDS.Desktop.getMsgBox().hide();this.sendRedirectReq();return}else{if("stage_binding_failed"===this.binding_progress_desc){this.PollTask.stop();this.scope.PollTask.start(true);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}}if(0===a){this.PollTask.stop();this.scope.PollTask.start(true);this.appWin.getMsgBox().alert(_TT("SYNO.SDS.HA.Instance","app","app_name"),_TT("SYNO.SDS.HA.Instance","wizard","stage_binding_failed"),function(g){if("ok"===g){window.location="/";SYNO.SDS.Desktop.getMsgBox().hide();this.close()}},this);return}var f=_TT("SYNO.SDS.HA.Instance","wizard",this.binding_progress_desc)||d.msg;SYNO.SDS.Desktop.getMsgBox().updateProgress((1-a/e)+this.binding_progress/200,f,_TT("SYNO.SDS.HA.Instance","ui","do_not_turnoff"));c.defer(b,this)};c.defer(b,this)},sendRequest:function(){var a=this.genApplyParams();this.el.mask(_T("common","loading"),"x-mask-loading");Ext.Ajax.request({timeout:300000,url:SYNO.SDS.HA.CONF_CGI_PATH,params:a,callback:this.bindRemoteDone,scope:this})},applySetting:function(){this.sendRequest()},Show:function(){this.open()}});Ext.ns("SYNO.SDS.HA");SYNO.SDS.HA.CONF_CGI_PATH="modules/HAManager/ha.cgi";SYNO.SDS.HA.CONF_PIC_PREFIX="modules/HAManager/images/";SYNO.SDS.HA.CONF_DEFAULT_WIDTH=990;SYNO.SDS.HA.CONF_DEFAULT_HEIGHT=580;SYNO.SDS.HA.CONF_LABEL_WIDTH=230;SYNO.SDS.HA.CONF_CONTD_WIDTH=200;SYNO.SDS.HA.CONF_MAX_HA_IF_NUM=12;SYNO.SDS.HA.HAPlainTextRenderer=function(a){return Ext.util.Format.htmlEncode(a)};SYNO.SDS.HA.DiskStatusDescRender=function(a){return a};SYNO.SDS.HA.HAGetPageStore=function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[20,20],[40,40],[60,60],[80,80],[100,100],[150,150],[200,200],[300,300],[400,400]]});return a};SYNO.SDS.HA.GetServerName=function(c){var b=c;var a=c.indexOf("(");if(a>0){b=c.substring(0,a)}if(Ext.form.VTypes.netbiosName(b)||(Ext.form.VTypes.hostname(b)&&!Ext.form.VTypes.looseip(b))){return b}return""};SYNO.SDS.HA.GetServerIP=function(b){var c=b;var a=b.indexOf("(");var d=b.indexOf(")");if(a>0&&a<d&&d==(b.length-1)){c=b.substring(a+1,d)}if(Ext.form.VTypes.looseip(c)){return c}return""};SYNO.SDS.HA.HADiskIndexRenderer=function(b){var c=b.split("-");var d=parseInt(c[0],10);var a=parseInt(c[1],10);if(0!==d){return _T("volume","volume_expansion")+" "+d+" "+_T("volume","volume_disk")+" "+a}else{return _T("volume","volume_disk")+" "+a}};SYNO.SDS.HA.ServiceRenderer=function(d){var a=["samba","iscsitrg","ftpd","atalk","nfsd","SyslogServer","DirectoryServer","networking","unknown"];var c=[_T("network","wnds_file_service"),_T("helptoc","iscsitrg_manager"),_T("tree","leaf_ftp"),_T("network","apple_subject"),_T("nfs","nfs_title"),_TT("SYNO.SDS.HA.Instance","service","syslog_server"),_TT("SYNO.SDS.HA.Instance","service","directory_server"),_TT("SYNO.SDS.HA.Instance","service","networking"),_TT("SYNO.SDS.HA.Instance","service","unknown")];var b=0;for(b=0;b<a.length;b++){if(a[b]==d){return c[b]}}};Ext.define("SYNO.SDS.HA.TabPanel",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var b;b=Ext.apply({activeTab:0,items:a.tabPanels},a);this.callParent([b])}});