/* All rights reserved. */

Ext.ns("SYNO.SDS.PkgManApp.Utils");SYNO.SDS.PkgManApp.Config={};Ext.apply(SYNO.SDS.PkgManApp.Config,{RECOMMEND_LIST_BIG_NUMBER:4,LIST_PKG_CELL_WIDTH:152,DEFICON_72:"images/package_center_72.png",DEFICON_256:"images/package_center_256.png",myDSRemindPassURL:"https://myds.synology.com/support/register_password_remind.php",myDSRegister:"https://myds.synology.com/support/register_form.php",termofservice:"termofservice",termofservice_4_2:"termofservice_4_2"});SYNO.SDS.PkgManApp.SERVICE={};Ext.apply(SYNO.SDS.PkgManApp.SERVICE,{PKG_SERVICES_APACHE_USER:1,PKG_SERVICES_PHP_DISABLE_SAFE_EXEC:4,PKG_SERVICES_SSH:8,PKG_SERVICES_PGSQL:16});SYNO.SDS.PkgManApp.TOFURL="http://www.synology.com/company/term_packagecenter.php";Ext.ns("SYNO.SDS.PkgManApp");SYNO.SDS.PkgManApp.CustMyDSDialog=Ext.extend(SYNO.SDS.ModalWindow,{dsmStyle:"v5",_SYNOMyDSParams:{},constructor:function(a){a=a||{};this._SYNOMyDSObj={_blSetTransparent:false,_blInitMydsWrong:false,timeoutDuration:60000,type:0,appId:a.appId,params:{},blBuyItem:false};var c=SYNO.SDS.Config.FnMap["SYNO.SDS.PkgManApp.MyDSDialog"];if(!c){return}var f=c.config.jsBaseURL;this._SYNOMyDSObj._iframeMyDSId=Ext.id();var d=function(g){try{Ext.EventManager.removeAll(g);Ext.destroy(g);g=undefined}catch(h){}};var e;var b=function(){var h=function(l,j){var m="";if(l&&l.errinfo&&l.errinfo.sec&&l.errinfo.key&&l.errinfo.key==="myds_register"){this.close();var k=new SYNO.SDS.MyDSCenter.RegisterDialog({owner:this.owner});k.show()}else{if(l&&Ext.isObject(l.result)&&!Ext.isEmpty(l.result.msg)&&l.result.code!=="badauth"&&l.result.code!=="good"){this.getMsgBox().alert(this.title,l.result.msg,function(){this.close()},this)}else{if(l&&Ext.isObject(l.result)&&l.result.code){switch(l.result.code){case"good":if(l.info&&0===l.info.way){this.close.defer(100,this);return}var i=(function(n){this.fireEvent("payevent",this,n);this.close()}).createDelegate(this);if(l.result&&!Ext.isEmpty(l.result.msg)){this.getMsgBox().alert(this.title,l.result.msg,function(n){if("ok"===n){i(l)}else{this.close()}},this)}else{i.defer(100,this,[l])}if(2===this._SYNOMyDSObj.type&&this._SYNOMyDSObj.appId){this.addAjaxTask({single:true,autoJsonDecode:true,url:f+"/myds.cgi",params:{action:"apply",operation:"savepurcharse",appId:this._SYNOMyDSObj.appId},method:"POST"}).start(true)}return;case"account_unverified":m=_T("pkgmgr","myds_error_activate");break;case"badconn":case"badsys":m=_T("pkgmgr","fail_connect_server");break;default:m=_T("pkgmgr","myds_error_illegal");SYNO.Debug(l);break}this.getMsgBox().alert(this.title,m,function(){this.close()},this)}else{if(l&&l.errinfo&&l.errinfo.sec&&l.errinfo.key){m=_T(l.errinfo.sec,l.errinfo.key)}this.getMsgBox().alert(this.title,m||_T("error","error_error_system"),function(){this.close()},this)}}}};var g=function(j){if(!j){this.setTitle(" ");this.layout.setActiveItem(this.get("syno-myds-connect"));this.setStatusBusy()}if(!this._SYNOMyDSObj._blMyDSIframeLoad){g.defer(100,this,[true]);return}var k=this._SYNOMyDSObj.iframeDom?this._SYNOMyDSObj.iframeDom:Ext.get(this._SYNOMyDSObj._iframeMyDSId).dom;var m=Ext.isIE?k.contentWindow.document:(k.contentDocument||window.frames[k.id].document);if(!m.blready){this.clearStatusBusy();this.getMsgBox().alert(this.title,_T("error","error_error_system"),function(){this.close()},this);return}var l=function(r,p){try{if(window.postMessage){r.postMessage(Ext.encode(p),SYNO.SDS.PkgManApp.Config.myPayBaseURL)}else{r.location.hash="#"+(new Date().getTime())+"&"+Ext.encode(p)}}catch(q){if(window.console){console.log(q)}}};var i=function(q,p){if(window.postMessage){Ext.EventManager.on(q,"message",function(r){if(r.browserEvent.origin!==SYNO.SDS.PkgManApp.Config.myPayBaseURL){this.getMsgBox().alert(this.title,_T("error","error_error_system"),function(){this.close()},this);return}if(Ext.isString(r.browserEvent.data)){h.call(this,Ext.decode(r.browserEvent.data),true)}else{h.call(this,r.browserEvent.data,true)}},this)}else{if(!this._SYNOMyDSObj.msgTask||this._SYNOMyDSObj.msgTask.removed){this._SYNOMyDSObj.msgTask=this.addTask({interval:500,run:function(){if(this.isDestroyed){this._SYNOMyDSObj.msgTask.stop();return}var s=p.location.hash,r=/^#?\d+&/;if(s!==this._SYNOMyDSObj.last_hash&&r.test(s)){this._SYNOMyDSObj.last_hash=s;h.call(this,Ext.decode(decodeURIComponent(s.replace(r,""))),true);p.location.hash=""}},scope:this});this.mon(this,"beforeclose",function(){if(this._SYNOMyDSObj._blMyDSIframeLoad&&this._SYNOMyDSObj.msgTask){this._SYNOMyDSObj.msgTask.remove()}},this)}this._SYNOMyDSObj.msgTask.start(true)}};var o=function(s,t,r){var p=s.getElementById(t);var q=p||s.createElement("iframe");q.setAttribute("id",t);q.setAttribute("name",t);q.setAttribute("src",r);q.setAttribute("frameBorder","0");q.setAttribute("style","background-color: transparent;border: 0px none; width: 100%; height: 100%;");if(Ext.isIE8){q.setAttribute("allowTransparency","true")}if(q.style.setAttribute){q.style.setAttribute("cssText","background-color: transparent;border: 0px none; width: 100%; height: 100%;")}if(!p){s.body.appendChild(q)}return q};e=o(m,"myds_iframe",SYNO.SDS.PkgManApp.Config.myDSURL+"?d="+new Date().getTime());var n=setTimeout((function(){d.call(this,e);if(this.isDestroyed){return}this.clearStatusBusy();var p=_T("pkgmgr","fail_connect_to_buy");if(0===this._SYNOMyDSObj.type){this.getMsgBox().confirm(this.title,p,function(q){if("yes"===q&&0===this._SYNOMyDSObj.type){}this.close()},this)}else{this.getMsgBox().alert(this.title,p,function(q){this.close()},this)}}).createDelegate(this),this._SYNOMyDSObj.timeoutDuration);Ext.EventManager.on(e,"load",function(){if(n){clearTimeout(n);n=null}else{return}if(this.isDestroyed){d.call(this,e);return}this.clearStatusBusy();Ext.EventManager.on(window,"unload",function(){d.call(this,e)},this);this.mon(this,"beforeclose",function(){d.call(this,e)},this);(function(){if(this.isDestroyed){return}if(this.layout.activeItem!==this.get("syno-myds-login")){this.maximize();this.layout.setActiveItem(this.get("syno-myds-iframe"))}}).defer(1000,this);if(!this._SYNOMyDSObj.blInitMsg){this._SYNOMyDSObj.blInitMsg=true;i.call(this,k.contentWindow,m)}this._SYNOMyDSParams=this._SYNOMyDSParams||{};var p=SYNO.Util.copy(this._SYNOMyDSParams);l.call(this,e.contentWindow,Ext.apply(Ext.apply(p,this.get("syno-myds-login").form.getValues()),this._SYNOMyDSObj.params))},this,{single:true});Ext.EventManager.on(e,"error",function(){if(n){clearTimeout(n);n=null}else{return}if(this.isDestroyed){d.call(this,e);return}this.clearStatusBusy();Ext.EventManager.on(window,"unload",function(){d.call(this,e)},this);this.mon(this,"beforeclose",function(){d.call(this,e)},this);this.getMsgBox().alert(this.title,_T("pkgmgr","fail_connect_server"),function(){this.close()},this)},this,{single:true})};this.get("syno-myds-login").form.setValues(this._SYNOMyDSParams);if(!Ext.isEmpty(this._SYNOMyDSObj._MyDSIdField.getValue())){g.call(this)}else{this.setStatusBusy();this.addAjaxTask({single:true,autoJsonDecode:true,url:f+"/myds.cgi",method:"POST",params:{action:"load",operation:"readmyds",appId:a.appId||""},callback:function(i,m,k){if(this.isDestroyed){return}this.clearStatusBusy();if(k&&k.success&&k.data){Ext.apply(SYNO.SDS.PkgManApp.Config,k.data);Ext.apply(SYNO.SDS.PkgManApp.Config,{myPayBaseURL:k.data.myPayBaseURL});Ext.apply(SYNO.SDS.PkgManApp.Config,{myDSURL:SYNO.SDS.PkgManApp.Config.myPayBaseURL+"/api/purchase5_1.html"});delete k.data.ds_sn;this.get("syno-myds-login").form.setValues(k.data);g.call(this)}else{if(k&&k.errinfo&&k.errinfo.sec&&k.errinfo.key&&k.errinfo.key==="myds_register"){this.close();var j=new SYNO.SDS.MyDSCenter.RegisterDialog({owner:this.owner});j.show()}else{var l=_T("common","error_system");if(k&&k.errinfo&&k.errinfo.sec&&k.errinfo.key){l=_T(k.errinfo.sec,k.errinfo.key)}this.getMsgBox().alert(this.title,l,function(){this.close()},this)}}},scope:this}).start(true)}};a.tools=a.tools||[];a.tools.push({id:"close",handler:this.close,scope:this});a.items=a.items||[];a.items.push.apply(a.items,[{itemId:"syno-myds-connect",trackResetOnLoad:true,xtype:"syno_formpanel",border:false,items:[{xtype:"container",width:450,height:260,style:"display:table;height:300px;text-align:center;",html:'<div class=\'syno-pkg-connect-text\' style=\'display:table-cell;vertical-align:middle;\'><table cellspacing="0" style="width: auto;margin: auto;"><tbody><tr><td><div class="syno-pkg-connect-icon"></div></td><td>&nbsp;'+_T("pkgmgr","myds_connecting")+"</td></tr></tbody></table></div>"}]},{itemId:"syno-myds-iframe",xtype:"container",html:String.format('<iframe id="{0}" src="{1}" frameborder="0" allowTransparency="true" style="background-color: transparent;border: 0px none; width: 100%; height: 100%;"></iframe>',this._SYNOMyDSObj._iframeMyDSId,Ext.urlAppend(f+"/fakeIFrame.cgi")),listeners:{scope:this,single:true,afterlayout:function(g){var h=this._SYNOMyDSObj.iframeDom?this._SYNOMyDSObj.iframeDom:Ext.get(this._SYNOMyDSObj._iframeMyDSId).dom;Ext.EventManager.on(h,"load",function(){if(this.isDestroyed){d.call(this,e);return}Ext.EventManager.on(window,"unload",function(){d.call(this,h)},this);this.mon(this,"beforeclose",function(){d.call(this,h)},this);this._SYNOMyDSObj._blMyDSIframeLoad=true},this);Ext.EventManager.on(h,"error",function(){if(this.isDestroyed){d.call(this,e);return}Ext.EventManager.on(window,"unload",function(){d.call(this,h)},this);this.mon(this,"beforeclose",function(){d.call(this,h)},this);this._SYNOMyDSObj._blMyDSIframeLoad=true},this)}}},{hidden:true,itemId:"syno-myds-login",trackResetOnLoad:true,xtype:"syno_formpanel",border:false,items:[{xtype:"hidden",name:"serial"},{xtype:"hidden",name:"language",value:_S("lang")},{xtype:"hidden",name:"ds_timezone"},{xtype:"hidden",name:"ds_unique"},{xtype:"hidden",name:"ds_major"},{xtype:"hidden",name:"ds_minor"},{xtype:"hidden",name:"ds_build"},this._SYNOMyDSObj._MyDSIdField=new Ext.form.Hidden({xtype:"hidden",name:"myds_id"}),{xtype:"hidden",name:"auth_key"}],listeners:{scope:this,activate:function(){if(this._SYNOMyDSObj.blBuyItem){b.call(this)}}}}]);Ext.each(a.items,function(g){g.tools=[{id:"close",handler:this.close,scope:this}]},this);SYNO.SDS.PkgManApp.CustMyDSDialog.superclass.constructor.call(this,Ext.apply(a,{title:a.title||this.title||_T("pkgmgr","myds_title"),cls:"syno-pkg-myds-dailog "+(a.cls||""),layout:"card",resizable:false,useStatusBar:false,modal:true,constrain:true,constrainHeader:true,renderTo:document.body}));Ext.EventManager.onWindowResize(this.center,this);this.mon(this,"beforeshow",function(){if(Ext.isIE6||Ext.isIE7){window.alert(_T("pkgmgr","upgrade_ie_browser"));return false}return true},this);this.mon(this,"afterlayout",this.center,this);this.mon(this,"beforeclose",function(){Ext.EventManager.removeResizeListener(this.center,this)},this);this.mon(this,"show",function(){this.maskEl.addClass("syno-pkg-myds-mask")},this,{single:true});Ext.apply(this._SYNOMyDSObj,{type:a.type||0});Ext.apply(this._SYNOMyDSObj,{timeoutDuration:(0===this._SYNOMyDSObj.type)?60000:60000});if(a.myds_params){Ext.apply(this._SYNOMyDSParams,a.myds_params||{});this.get("syno-myds-login").form.setValues(a.myds_params);b.call(this)}if(Ext.isEmpty(this._SYNOMyDSObj._MyDSIdField.getValue())){this.mon(this,"beforeshow",function(){this.setStatusBusy();this.addAjaxTask({single:true,autoJsonDecode:true,url:f+"/myds.cgi",method:"POST",params:{action:"load",operation:"readmyds",appId:a.appId||""},callback:function(g,k,i){if(this.isDestroyed){return}this.clearStatusBusy();if(i&&i.success&&i.data){Ext.apply(SYNO.SDS.PkgManApp.Config,i.data);Ext.apply(SYNO.SDS.PkgManApp.Config,{myPayBaseURL:i.data.myPayBaseURL});Ext.apply(SYNO.SDS.PkgManApp.Config,{myDSURL:SYNO.SDS.PkgManApp.Config.myPayBaseURL+"/api/purchase5_1.html"});delete i.data.ds_sn;this.get("syno-myds-login").form.setValues(i.data);if(this.layout.activeItem===this.get("syno-myds-login")){b.call(this)}}else{if(i&&i.errinfo&&i.errinfo.sec&&i.errinfo.key&&i.errinfo.key==="myds_register"){this.close();var h=new SYNO.SDS.MyDSCenter.RegisterDialog({owner:this.owner});h.show()}else{var j=_T("common","error_system");if(i&&i.errinfo&&i.errinfo.sec&&i.errinfo.key){j=_T(i.errinfo.sec,i.errinfo.key)}this.getMsgBox().alert(this.title,j,function(){this.close()},this)}}},scope:this}).start(true)})}},_onGoMyDS:function(b){b=b||{};if(b&&b.appId){this._SYNOMyDSObj.appId=b.appId}if(!this._SYNOMyDSObj.appId){SYNO.Debug("Can't get appId");return}if(Ext.isEmpty(this._SYNOMyDSObj._MyDSIdField.getValue())){this.close();var a=new SYNO.SDS.MyDSCenter.RegisterDialog({owner:this.owner});a.show();return}this._SYNOMyDSObj.type=2;this._SYNOMyDSObj.blBuyItem=true;this._SYNOMyDSObj.timeoutDuration=60000;Ext.apply(this._SYNOMyDSObj.params,b||{});this.layout.setActiveItem(this.get("syno-myds-login"))},center:function(){var a=this.el.getAlignToXY(Ext.getBody(),"c-c");this.setPagePosition(a[0],a[1]);return this}});SYNO.SDS.PkgManApp.MyDSDialog=Ext.extend(SYNO.SDS.PkgManApp.CustMyDSDialog,{constructor:function(a){Ext.apply(this,a);SYNO.SDS.PkgManApp.MyDSDialog.superclass.constructor.call(this,Ext.apply(a,{dsmStyle:"v5",resizable:false,width:480,height:330,border:false,activeItem:0,layout:"card"}))}});