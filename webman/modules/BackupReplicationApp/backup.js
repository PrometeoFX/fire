/* Copyright (c) 2015 Synology Inc. All rights reserved. */

try{Ext.form.VTypes.backup_destinationText=_T("vtype","bad_backup_destination");Ext.form.VTypes.backup_destinationMask=/[^\\\{\}\|\^\[\]\?\=\:\+\/\*\(\)\$\!"#%&',;<>@`~]/;Ext.form.VTypes.backup_destinationNotValid=/[\\\{\}\|\^\[\]\?\=\:\+\/\*\(\)\$\!"#%&',;<>@`~]/;Ext.form.VTypes.backup_destinationVal=/^[^\-\s\.]/;Ext.form.VTypes.backup_destinationEnd=/\S$/;Ext.form.VTypes.backup_destination=function(a){return(a.search(Ext.form.VTypes.backup_destinationNotValid)==-1)&&Ext.form.VTypes.backup_destinationVal.test(a)&&Ext.form.VTypes.backup_destinationEnd.test(a)};Ext.form.VTypes.backup_targetText=_T("vtype","bad_backup_target");Ext.form.VTypes.backup_targetMask=/[^\\\{\}\|\^\[\]\?\=\:\+\/\*\(\)\$\!"#%&',;<>@`~]/;Ext.form.VTypes.backup_targetNotValid=/[\\\{\}\|\^\[\]\?\=\:\+\/\*\(\)\$\!"#%&',;<>@`~]/;Ext.form.VTypes.backup_targetVal=/^[^\-\s\.]/;Ext.form.VTypes.backup_targetEnd=/\S$/;Ext.form.VTypes.backup_target=function(a){return(a.search(Ext.form.VTypes.backup_targetNotValid)==-1)&&Ext.form.VTypes.backup_targetVal.test(a)&&Ext.form.VTypes.backup_targetEnd.test(a)}}catch(error){}Ext.define("SYNO.SDS.Backup.OverviewPage",{extend:"SYNO.ux.Panel",border:false,constructor:function(a){Ext.apply(this,a);var b=this.fillConfig(a);this.callParent([b])},initEvents:function(){this.callParent(arguments);this.appWin.addListener("resize",function(b,c,a){this.view.setWidth(c-290);this.view.setHeight(a-300)},this)},createStatus:function(){this.healthStore=new Ext.data.JsonStore({autoDestroy:true,fields:["status","text","desc"]});return new Ext.DataView({tpl:new Ext.XTemplate('<tpl for=".">','<div style="height:180px;padding-bottom:8px;">','<div class="backup-overview-health-icon backup-overview-health-icon-{status}"></div>','<div class="backup-overview-text">','<div class="backup-overview-health-text backup-overview-health-text-{status}">{text}</div>','<div class="backup-overview-health-desc">{desc}</div>',"</div>","</div>","</tpl>"),store:this.healthStore})},createTask:function(){var a={store:this.taskStore=new Ext.ux.data.PagingJsonStore({autoDestroy:true,fields:["month","date","taskname","status","statusIcon"]}),height:this.appWin.getHeight()-300};this.view=new SYNO.SDS.Backup.Overview.DataView(a);return new SYNO.ux.FieldSet({title:_T("service","backup_task"),collapsible:false,items:[this.view]})},fillConfig:function(a){this.status=this.createStatus();this.task=this.createTask();var b={border:false,autoFlexcroll:true,items:[this.status,this.task]};Ext.apply(b,a);return b},getRunningEntry:function(b){var a={};var c=new Date();a.month=this.getLitMonth(c.format("m"));a.date=c.format("d");a.taskname=b.name;a.status=_T("backup","overview_task_syncing");a.statusIcon="syncing";return a},getFinishedEntry:function(b){var a={};var c=this.getFormateDate(b.last_bkp_end_time);a.month=c.Month;a.date=c.Date;a.taskname=b.name;if("success"===b.last_bkp_result||"done"===b.last_bkp_result){a.status=String.format(_T("backup","overview_task_finished"),c.Time);a.statusIcon="success"}else{if("cancel"===b.last_bkp_result){a.status=String.format(_T("backup","overview_task_cancel"),c.Time);a.statusIcon="fail"}else{if("partial"===b.last_bkp_result){a.status=String.format(_T("backup","overview_task_partial"),c.Time);a.statusIcon="partial"}else{a.status=String.format(_T("backup","overview_task_failed"),c.Time);a.statusIcon="fail"}}}a.rawTime=b.last_bkp_end_time;return a},getScheduledEntry:function(c,a){var b={};var d=this.getFormateDate(a);b.month=d.Month;b.date=d.Date;b.taskname=c.name;b.status=_T("backup","overview_task_scheduled")+" "+d.Time;b.statusIcon="schedule";b.rawTime=a;return b},prepareStatusData:function(f){var b,a=4,d=false,e=false;var c=[{status:"normal",text:_T("backup","overview_status_normal"),desc:_T("backup","overview_status_normal_desc")},{status:"syncing",text:_T("backup","overview_status_syncing"),desc:_T("backup","overview_status_syncing_desc")},{status:"stopped",text:_T("backup","overview_status_no_task"),desc:_T("backup","overview_status_no_task_desc")},{status:"error",text:_T("usbbackup","usbbkp_error"),desc:_T("usbbackup","usbbkp_err_error")},{status:"stopped",text:_T("backup","overview_status_not_start"),desc:_T("backup","overview_status_not_start_desc")},{status:"partial",text:_T("backup","overview_status_normal")+" - "+_T("backup","attention_required"),desc:_T("backup","overview_status_partial_desc")}];for(b=0;b<f.length;b++){if("syncing"===f[b].status||"backup"===f[b].status||"waiting"===f[b].status||"canceling"===f[b].status){a=1;break}else{if("success"===f[b].last_bkp_result||"done"===f[b].last_bkp_result){a=0}else{if("partial"===f[b].last_bkp_result){e=true}else{if("failed"===f[b].last_bkp_result){d=true}}}}}if(d&&a!==1){a=3}if(!d&&e&&a!==1){a=5}if(0===f.length){a=2}this.healthStore.loadData([c[a]],false)},prepareTaskData:function(h){var e=0,d=0;var c=[],b=[],g=[],a=[];var f=5;for(e=0;e<h.length;e++){if("syncing"===h[e].status||"backup"===h[e].status||"waiting"===h[e].status||"canceling"===h[e].status){b.push(this.getRunningEntry(h[e]))}if(h[e].schedule&&""!==h[e].next_bkp_time&&"N/A"!==h[e].next_bkp_time&&h[e].more_next_bkp_time){for(d=0;d<h[e].more_next_bkp_time.length;d++){a.push(this.getScheduledEntry(h[e],h[e].more_next_bkp_time[d]))}}if("success"===h[e].last_bkp_result||"done"===h[e].last_bkp_result||"cancel"===h[e].last_bkp_result||"failed"===h[e].last_bkp_result||"partial"===h[e].last_bkp_result){g.push(this.getFinishedEntry(h[e]))}}a.sort(function(j,i){return j.rawTime>i.rawTime?1:-1});g.sort(function(j,i){return j.rawTime<i.rawTime?1:-1});if(g.length>0){f--;c.push(g[0])}if(b.length>0){f--;c.push(b[0])}if(f>a.length){f=a.length}for(e=0;e<f;e++){c.push(a[e])}this.taskStore.loadData(c,false)},ProcessBackupStatus:function(a){this.prepareStatusData(a);this.prepareTaskData(a);this.doLayout()},getLitMonth:function(a){var b;switch(parseInt(a,10)){case 1:b="Jan";break;case 2:b="Feb";break;case 3:b="Mar";break;case 4:b="Apr";break;case 5:b="May";break;case 6:b="Jun";break;case 7:b="Jul";break;case 8:b="Aug";break;case 9:b="Sep";break;case 10:b="Oct";break;case 11:b="Nov";break;case 12:b="Dec";break}return b},getFormateDate:function(d){var c={};var a,b;if(!d){return{Month:"",Date:"",Time:""}}a=d.split(" ");b=a[0].split("-");c.Month=this.getLitMonth(b[1]);c.Date=b[2];c.Time=a[1];return c},onStatusLoadDone:function(d,b,c,a){if(d){this.ProcessBackupStatus(b.task_list)}},onStartPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Task",version:1,method:"list",params:{additional:["schedule","next_bkp_time","last_bkp_time","last_bkp_result","more_next_bkp_time"]}},interval:10,immediate:true,scope:this,status_callback:this.onStatusLoadDone})},onStopPolling:function(){this.pollUnreg(this.pollingID)},onPageActivate:function(){this.onStartPolling()},onPageDeactivate:function(){this.onStopPolling()}});Ext.define("SYNO.SDS.Backup.Overview.DataView",{extend:"SYNO.ux.ExpandableListView",constructor:function(a){var c=this,b;c.expandedItemId={};c.selectedItemId={};c.appWin=a.appWin;c.owner=a.owner;b={tpl:this.createTpl()};this.callParent([Ext.apply(b,a)]);this.mon(this,"resize",function(e,d,f){this.tuneWidth(d)},this)},tuneWidth:function(a){if(!Ext.isNumber(a)){return true}this.all.each(function(d){var c=Ext.fly(d.child("tr").dom.childNodes[3]);var b=a-84-4-300-50-20*2;c.setWidth(b);c.child(".backup-overview-status").setWidth(b);c.child(".backup-overview-desc").setWidth(b);return false})},createTpl:function(){var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap backup-overview'," <tpl if=\"statusIcon == 'syncing'\">item-selected</tpl>",' ">','<div class="item-summary">','<table style="border-spacing: 0px !important; width: 100%;">',"<tr>",'<td style="width: 84px">','<div class="backup-overview-calendar">','<div class="backup-overview-calender-month">{month}</div>','<div class="backup-overview-calender-date">{date}</div>',"</div>","</td>",'<td style="width: 4px">','<div class="backup-overview-white">',"</div>","</td>",'<td style="width: 300px">','<div class="backup-overview-task">','<div class="backup-overview-title" style="padding-top:16px">'+_T("service","backup_task")+"</div>",'<div class="backup-overview-desc">{taskname:htmlEncode}</div>',"</div>","</td>",'<td style="width: auto">','<div class="backup-overview-status">','<div class="backup-overview-title" style="padding-top:16px">'+_T("common","status")+"</div>",'<div class="backup-overview-desc" ext:qtip="{status:htmlEncode}">{status}</div>',"</div>","</td>",'<td style="width: 50px">','<div class="backup-overview-statusCol">','<div style="padding-top:22px"></div>','<div class="backup-overview-statusIcon backup-overview-statusIcon-{statusIcon}"></div>',"</div>","</td>","</tr>","</table>","</div>","</div>","</tpl>",'<div class="x-clear"></div>');return a},onClick:function(c,b,a){return},onStoreLoad:function(a){this.updateFleXcroll([false]);this.tuneWidth(this.getWidth())},updateFleXcroll:function(a){this.callParent(a)},getSelectedItemIds:function(){var a,b,c=[];a=this.getSelectedRecords();for(b=0;b<a.length;++b){if(!a[b]){continue}c.push(a[b].get("id"))}return c},getSelectedItems:function(){var c=this,a=c.getSelectedItemIds(),d=c.appWin[c.dataType].data,b=[];Ext.each(a,function(e){if(e in d){if(d[e]){b.push(d[e])}}});return b},getSelectedItem:function(){var a;a=this.getSelectedItems();if(0===a.lenght){return}return a[0]}});Ext.define("SYNO.SDS.Backup.ExpandableListView",{extend:"SYNO.ux.ExpandableListView",trackResetOnLoad:false,constructor:function(a){a.innerTpl=a.innerTpl||new Ext.XTemplate("{detail_html}");this.callParent(arguments)},initComponent:function(){this.callParent(arguments);this.addEvents("beforetoggle","toggle")},needToggleEvent:true,toggleDetail:function(a,b){if(!this.innerTpl||!a){return}if(this.needToggleEvent&&this.fireEvent("beforetoggle",this,a)===false){return}this.callParent(arguments);if(this.needToggleEvent){this.fireEvent("toggle",this,a)}},restoreUIState:function(){this.needToggleEvent=false;this.callParent(arguments);this.needToggleEvent=true},selectAndExpandById:function(a){var d=this.store.getById(a),c,b;if(!d){return}this.select(d);c=this.getNode(d);b=Ext.get(c);this.fleXcrollTo(b);if(!b.child(".item-toggle-expanded")){this.toggleDetail(b,true)}},collapseAll:function(){var a=this.getToggledItemIds();Ext.each(a,function(g,c,b){var e,d;var f=this.getStore().getById(g);if(f){e=this.getNode(f);d=Ext.fly(e);if(d&&d.child(".item-toggle-expanded")){this.toggleDetail(d,false)}}},this)}});Ext.define("SYNO.SDS.Backup.BackupTaskExpandView",{extend:"SYNO.SDS.Backup.ExpandableListView",WINDOW_SIZE:5,constructor:function(a){a.innerTpl=a.innerTpl||this.getInnerTpl();this.transSizeBuf=[];this.callParent(arguments);this.addClass("syno-backup-backup-listview");this.mon(this,"toggle",this.onToggleClick,this)},createTpl:function(){var b='<div class="syno-backup-usage {step}"><tpl if="size_title != \'\'"><tpl if="data_type != \'lun\'"><div style="float:left;text-align:left;"><span <tpl if="tran_speed != \'\'">ext:qtip="{tran_speed}/s"</tpl>>{size_title}: {display_transmitted_size}</span></div></tpl></tpl><div class="syno-backup-percentage-bar-bg"><div class="syno-backup-percentage-bar" style="width:{progress* 2.2}px"></div></div></div>';var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap">','<div class="item-summary">','<div class="item-icon {icon_cls}"></div>','<div class="syno-backup-status-icon {status_cls}"></div>',"<div>",'<span class="item-title">{name:htmlEncode}</span>',"<tpl if=\"(status == 'restore') || (data_type == 'data' && status == 'none') || (data_type == 'lun' && (status != 'syncing' && status != 'waiting'))\">",'<div class="item-status syno-backup-last-bkp {status}">{last_bkp_result_str}</div>',"</tpl>","<tpl if=\"status == 'backup' || status == 'syncing' || status == 'waiting'\"><div class=\"item-status\">{step_str} <span class=\"syno-backup-step {step}\">"+_T("common","colon")+" {progress}&#37</div></span>","</tpl>","<tpl if=\"status == 'canceling'\">",'<div class="item-status syno-backup-last-bkp {status}">'+_T("backup","backup_do_cancel")+"</div>","</tpl>","</div>","<tpl if=\"(data_type == 'data' && status == 'backup') || (data_type == 'lun' && (status == 'syncing' || status == 'waiting'))\">",b,"</tpl>",(this.innerTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"","</div>",'<div class="item-detail" style="display:none">',(this.innerTpl)?this.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>',{hasValues:function(c){if(!c){return false}return 0<c.length}});return a},getInnerTpl:function(){var d='<tr><td class="syno-backup-tpl-key">{0}</td><td class="syno-backup-tpl-value">{1}</td></tr>';var c='<tpl if="type == \'share:local\'">ext:qtip="{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.share)]}&nbsp/&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.target_id)]}"</tpl><tpl if="type == \'image:image_local\'">ext:qtip="{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.volume)]}"</tpl><tpl if="type == \'image:image_remote\'">ext:qtip="{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.dest)]}&nbsp'+_T("common","colon")+'&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.volume)]}"</tpl><tpl if="target_type == \'cloud\'">ext:qtip="{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.addon_name)]}&nbsp'+_T("common","colon")+"&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.bucket)]}&nbsp/&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.target_id)]}\"</tpl><tpl if=\"type == 'share:rsync_ds' || type == 'share:rsync'\">ext:qtip=\"{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.dest)]}&nbsp"+_T("common","colon")+'&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.share)]}&nbsp/&nbsp{[SYNO.SDS.Backup.Util.htmlEncodeTip(values.target_id)]}"</tpl>';var b=String.format(d,_T("usbbackup","usbbkp_backup_shares"),"{bkp_shares:htmlEncode}")+String.format(d,_T("backup","backup_app"),"{bkp_apps:htmlEncode}")+'<tpl if="this.hasValues(values.deststatus)">'+String.format(d,_T("localbkp","localbkp_dest"),"<a "+c+' class="repo_links link-font" href="#">{bkp_dest:htmlEncode}</a>')+'</tpl><tpl if="!this.hasValues(values.deststatus)">'+String.format(d,_T("localbkp","localbkp_dest"),_T("common","loading"))+"</tpl>";var e=String.format(d,_T("lunbkp","lun_source"),"{bkp_shares:htmlEncode}")+"<tpl if=\"type == 'netlunbkp' \">"+String.format(d,_T("backup","backup_server_name"),"{server:htmlEncode}")+"</tpl>"+String.format(d,_T("localbkp","localbkp_dest"),'<span class="link-font" href="#">{bkp_dest:htmlEncode}</span>&nbsp(&nbsp{deststatus_str}&nbsp)');var a=new Ext.XTemplate('<div">','<table style="width: 100%;">',"<tpl if=\"data_type != 'lun'\">",b,"</tpl>","<tpl if=\"data_type == 'lun'\">",e,"</tpl>",String.format(d,_T("netbackup","netbkp_schedule"),"{bkp_schedule}"),String.format(d,_T("usbbackup","usbbkp_lasttime"),"{last_bkp_time}"),String.format(d,_T("backup","next_bkp_time"),"{next_bkp_time}"),"</table>","</div>");return a},calTranSpeed:function(e,b){if(!this.transSizeBuf[e.toString()]){this.transSizeBuf[e.toString()]=[]}var d=this.transSizeBuf[e.toString()];var c=parseInt(b.get("transmitted_size"),10);if(d.size()>0&&d[0].tran_size>c){d.length=0}d.unshift({tran_size:c,tran_time:new Date().getTime()});if(d.size()>this.WINDOW_SIZE){d.pop()}if(d.size()>1){var a=(d[0].tran_size-d[d.size()-1].tran_size)*1000;if(a>=0){var f=a/(d[0].tran_time-d[d.size()-1].tran_time);b.data.tran_speed=SYNO.SDS.Backup.ConverSize(f,2)}else{b.data.tran_speed=""}}else{b.data.tran_speed=""}},getSizeTitle:function(a,b){if("share:local"===a||"image:image_local"===a){return _T("backup","written_size")}else{if("share:rsync_ds"===a||"share:rsync"===a||"image:image_remote"===a||"cloud"===b){return _T("backup","transmitted_size")}}return""},prepareData:function(d,c,a){var e={loclunbkp:"syno-backup-task-local-lun",netlunbkp:"syno-backup-task-remote-lun","share:local":"syno-backup-task-local-single","image:image_local":"syno-backup-task-local-multi","share:rsync_ds":"syno-backup-task-remote-single","share:rsync":"syno-backup-task-remote-rsync","image:image_remote":"syno-backup-task-remote-multi"};if(d.type in e){d.icon_cls=e[d.type]}else{if(d.target_type==="cloud"){d.icon_cls="syno-backup-task-cloud-"+d.transfer_type;d.addon_name=SYNO.SDS.Backup.Addon.GetStr(d.transfer_type,"addon","name")}else{d.icon_cls="syno-backup-task-local-single"}}a.data.size_title=this.getSizeTitle(d.type,d.target_type);if(""!==a.data.size_title){this.calTranSpeed(a.get("task_id"),a);var b=SYNO.SDS.Backup.ConverSize(a.get("transmitted_size"),2);a.data.display_transmitted_size=b}return d},onToggleClick:function(a,b){var c=this.getSelectedRecords();if(0>=c.length||!b.child(".item-toggle-expanded")){return}if("lun"===c[0].get("data_type")){this.loadLunTaskDetail(c)}else{this.loadTaskDetail(c)}},onClick:function(d,c,b){this.callParent(arguments);var a=Ext.fly(c);if(a&&(a.hasClass("repo_links"))){var f=this.getSelectedRecords();if(f[0]){this.owner.appWin.selectPage("SYNO.SDS.Backup.Repository.MainPage");this.owner.appWin.getActivePage().needSelectRepo=true;this.owner.appWin.getActivePage().selectRepoId=f[0].get("repo_id")}}if(a&&(a.hasClass("help_link"))){this.owner.appWin.selectPage("SYNO.SDS.Backup.LogsPage")}},loadTaskDetail:function(a){this.owner.appWin.setStatusBusy();this.sendWebAPI({scope:this,compound:{stopwhenerror:true,params:[{api:"SYNO.Backup.Task.Data",version:1,method:"get",params:{task_id:a[0].id,additional:["progress","schedule","last_bkp_time","last_bkp_result","next_bkp_time"]}},{api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:a[0].get("repo_id"),additional:["skip_status"]}}]},callback:this.updateDetail})},updateDetail:function(e,b,d){this.owner.appWin.clearStatusBusy();if(!e){this.owner.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var c=SYNO.SDS.Backup.TaskDisplayFormat(b.result[0].data);var a=b.result[1].data;if(c.deststatus==="target broken"){this.owner.appWin.getMsgBox().alert(_T("leaf","backup"),String.format(_T("backup","err_broken_task"),c.name))}c.bkp_dest=a.name;c.dest=a.dest;c.volume=a.volume;c.share=a.share;c.bucket=a.bucket;this.getStore().loadData({task_list:[c]},true)},loadLunTaskDetail:function(){var b=this.getSelectedRecords();var a=b[0].get("name");this.owner.appWin.setStatusBusy();Ext.Ajax.request({url:this.owner.appWin.getURL("lunbackup.cgi"),params:{action:"load_lun_dest_status",taskName:a},callback:this.onGetDestStatusDone,scope:this})},onGetDestStatusDone:function(c,f,a){this.owner.appWin.clearStatusBusy();if(!f||!a||!a.responseText){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));return}var e=Ext.util.JSON.decode(a.responseText);if(!e.success){this.appwin.getMsgBox().alert(_T("tree","leaf_backup"),_T(e.errinfo.sec,e.errinfo.key));return}var d,b=this.getStore().findExact("name",e.taskName);if(-1!==b){d=this.getStore().getAt(b);d.set("deststatus",e.deststatus);d.set("deststatus_str",SYNO.SDS.Backup.GetDestStatusStr(e.deststatus))}}});Ext.define("SYNO.SDS.Backup.TriTreeNodeUI",{extend:"Ext.tree.TreeNodeUI",renderElements:function(g,p,o,q){this.indentMarkup=g.parentNode?g.parentNode.ui.getChildIndent():"";var i='<img alt="" src="'+this.emptyIcon+'" class="syno-backup-tree-node-share-overwrite" ext:qtip="'+_T("confbackup","confbkp_share_overwrite")+'"/>';var k='<img alt="" src="'+this.emptyIcon+'" class="syno-backup-tree-node-share-rename" ext:qtip="'+_T("confbackup","confbkp_share_rename")+'"/>';var f='<img alt="" src="'+this.emptyIcon+'" class="syno-backup-tree-node-same-volume" ext:qtip="'+_T("backup","warn_backup_same_volume")+'"/>';var j=Ext.isBoolean(p.checked)||p.checked==="gray",h=Ext.util.Format.htmlEncode,e=p.input,c,b=this.getHref(p.href),d=['<li class="x-tree-node syno-backup-tri-tree-node"><div ext:tree-node-id="',h(g.id),'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',p.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img alt="" src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />',j?('<img alt="" src="'+this.emptyIcon+'" class="syno-backup-tri-tree-node-cb syno-ux-checkbox-icon" />'):"",'<img alt="" src="',p.icon||this.emptyIcon,'" class="x-tree-node-icon',(p.icon?" x-tree-node-inline-icon":""),(p.iconCls?" "+p.iconCls:""),'" unselectable="on" ',((p.icon||p.iconCls)?"":'style="display: none;"')+"/>",'<a hidefocus="on" class="x-tree-node-anchor" href="',b,'" tabIndex="1" ',p.hrefTarget?' target="'+p.hrefTarget+'"':"",'><span unselectable="on">',g.text,"</span></a>","rename"===p.shareConflict?k:"","overwrite"===p.shareConflict?i:"",f,"</div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");if(q!==true&&g.nextSibling&&(c=g.nextSibling.ui.getEl())){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",c,d)}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",o,d)}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];var m=this.elNode.childNodes;var l=0;this.indentNode=m[l++];this.ecNode=m[l++];if(j){this.checkbox=m[l++]}this.iconNode=m[l++];this.anchor=m[l++];this.textNode=this.anchor.firstChild;if("rename"===p.shareConflict){this.renameNode=m[l++]}if("overwrite"===p.shareConflict){this.overwriteNode=m[l++]}this.volumeWarnNode=m[l++];if(e){this.createInputField(e,p,this.elNode);l++}if(j){this.syncCheckCssClass()}g.on("disabledchange",this.onDisabled,this)},onIdChange:function(b){var a=Ext.util.Format.htmlEncode;if(this.rendered){this.elNode.setAttribute("ext:tree-node-id",a(b))}},createInputField:function(b,a,c){var d=b;if(Ext.isObject(b)){this.inputConfig=Ext.apply({},b);d=b.xtype||"textfield";delete b.xtype}else{this.inputConfig={}}if(Ext.isDefined(a.value)){this.inputConfig.value=a.value}this.inputConfig.renderTo=c;switch(d){case"textfield":this.input=new SYNO.ux.TextField(this.inputConfig);break;case"numberfield":this.input=new SYNO.ux.NumberField(this.inputConfig);break}},initEvent:function(){var a=this.callParent(arguments);if(this.checkbox){this.initCheckEvent()}return a},isChecked:function(){return this.getCheckValue()},isDisabled:function(){var a=this.node;return(true===a.disabled)},toggleCheck:function(){var a=this.checkbox;if(true===this.node.disabled){return}if(a){this.setCheckValue(!this.getCheckValue())}},onClick:function(a){if(a.getTarget(".x-form-field")){return}if(a.getTarget(".syno-backup-tri-tree-node-cb")){this.toggleCheck()}return this.callParent(arguments)},onDblClick:function(a){a.preventDefault();if(this.disabled){return}if(this.fireEvent("beforedblclick",this.node,a)!==false){if(!this.animating&&this.node.isExpandable()){this.node.toggle()}this.fireEvent("dblclick",this.node,a)}},onDisabled:function(b,a){if(this.input){if(a){this.input.disable()}else{this.input.enable()}}if(this.checkbox){if(a){this.checkbox.addClassName("syno-ux-cb-disabled")}else{this.checkbox.removeClassName("syno-ux-cb-disabled")}}},onCheckChange:function(){this.syncCheckCssClass();this.fireEvent("checkchange",this.node,this.getCheckValue())},isValid:function(){if(this.node.disabled){return true}if(this.input&&!this.input.isValid()){return false}return true},getInputValue:function(){if(!this.input||this.disabled){return undefined}return this.input.getValue()},setInputValue:function(a){if(!this.input){return}this.input.setValue(a)},getCheckValue:function(){return this.node.attributes.checked},setCheckValue:function(a){if(this.node.disabled){return}if(a===this.getCheckValue()){return}if(a==="false"||a==="off"||a==="0"){a=false}else{if(a==="gray"){a="gray"}else{a=(a?true:false)}}this.node.attributes.checked=a;this.onCheckChange()},syncCheckCssClass:function(){var b=this.getCheckValue();var a=this.checkbox;if(!a){return}Ext.each(["checked","grayed","disabled"],function(c){this.checkbox.removeClassName("syno-ux-cb-"+c)},this);if(this.volumeWarnNode){this.volumeWarnNode.removeClassName("syno-ux-cb-selected")}if(b===true){this.checkbox.addClassName("syno-ux-cb-checked");if(this.volumeWarnNode){this.volumeWarnNode.addClassName("syno-ux-cb-selected")}}else{if(b==="gray"){this.checkbox.addClassName("syno-ux-cb-grayed");if(this.volumeWarnNode){this.volumeWarnNode.addClassName("syno-ux-cb-selected")}}}if(this.node.disabled){this.checkbox.addClassName("syno-ux-cb-disabled")}},initCheckEvent:function(){this.checkbox.addListener("mouseover",this.onCheckMouseover,this);this.checkbox.addListener("mouseout",this.onCheckMouseout,this);this.checkbox.addListener("focus",this.onCheckIconfocus,this);this.checkbox.addListener("blur",this.onCheckIconblur,this)},onCheckMouseover:function(){this.checkbox.addClassName("syno-ux-cb-hover")},onCheckMouseout:function(){this.checkbox.removeClassName("syno-ux-cb-hover")},onCheckIconfocus:function(){this.checkbox.addClassName("syno-ux-cb-focus")},onCheckIconblur:function(){this.checkbox.removeClassName("syno-ux-cb-focus")}});Ext.define("SYNO.SDS.Backup.TriTreeDisableCheckNodeUI",{extend:"SYNO.SDS.Backup.TriTreeNodeUI",checkShareNode:function(b,c,a){if(!b.dependAppRows||0===b.dependAppRows.length){return}Ext.each(b.dependAppRows,function(d){if(d.get("checked")){if(-1===c.indexOf(b.id.substr(1))){c.push(b.id.substr(1))}if(-1===a.indexOf(d.get("name"))){a.push(d.get("name"));this.node.appRowsToBeUnselected.push(d)}this.node.appGrid=b.dependGrid}},this)},setCheckValue:function(e){if(true!==e&&!this.node.clickConfirmed){this.node.appRowsToBeUnselected=[];var d=[];var a=[];var f;if("fm_root"===this.node.id){Ext.each(this.node.childNodes,function(g){this.checkShareNode(g,d,a)},this)}else{var c=this.node.id.substr(1).split("/",1)[0];var b=this.node.getOwnerTree().getNodeById("/"+c);this.checkShareNode(b,d,a)}if(0<a.length&&0<d.length){if(d[0].isBackup){f=_T("backup","unselect_share_alert_bkp")}else{f=_T("backup","unselect_share_alert_restore")}f=String.format(f,d.join(", "),a.join(", "));this.node.getOwnerTree().owner.getMsgBox().confirm("",f,function(g){if("yes"===g){this.node.clickConfirmed=true;this.setCheckValue(false)}},this);return false}}this.node.clickConfirmed=false;Ext.each(this.node.appRowsToBeUnselected,function(g){g.set("checked",false)});this.node.appRowsToBeUnselected=[];if(this.node.appGrid){this.node.appGrid.syncCheckedStatus();delete this.node.appGrid}if(!e&&this.node.disabled){this.node.disabled=false;this.callParent(arguments);this.node.disabled=true;this.syncCheckCssClass()}else{this.callParent(arguments)}}});Ext.define("SYNO.SDS.Backup.TreeLoader",{extend:"Ext.tree.TreeLoader",sendWebAPI:undefined,webapi:undefined,constructor:function(){var a=arguments[0];if(a&&a.webapi){this.dataUrl="dummy"}return this.callParent(arguments)},requestData:function(c,e,b){if(this.fireEvent("beforeload",this,c,e)!==false){if(this.directFn){var a=this.getParams(c);a.push(this.processDirectResponse.createDelegate(this,[{callback:e,node:c,scope:b}],true));this.directFn.apply(window,a)}else{if(this.nodeData&&-1!==this.owner.fm_root_nodes.indexOf(c.id)){this.handleNodeData(c,this.nodeData,e,b)}else{if(Ext.isFunction(this.sendWebAPI)){var d=Ext.apply({},{params:this.getParams(c),argument:{callback:e,node:c,scope:b},callback:this.handleWebAPIResponse,scope:this},this.webapi);this.transId=this.sendWebAPI(d)}else{this.transId=Ext.Ajax.request({method:this.requestMethod,url:this.dataUrl||this.url,success:this.handleResponse,failure:this.handleFailure,scope:this,argument:{callback:e,node:c,scope:b},params:this.getParams(c)})}}}}else{this.runCallback(e,b||c,[])}},handleNodeData:function(e,b,g,d){if(Ext.isFunction(this.parseWebApiResponse)){b=this.parseWebApiResponse.call(this,e,b)}e.beginUpdate();for(var c=0,a=b.length;c<a;c++){var f=this.createNode(b[c]);if(f){e.appendChild(f)}}e.endUpdate();this.runCallback(g,d||e,[e]);this.fireEvent("load",this,e,b)},handleWebAPIResponse:function(l,b,f,m){var k=m.argument,d=k.node;this.transId=false;if(l){try{if(Ext.isFunction(this.parseWebApiResponse)){b=this.parseWebApiResponse.call(this,d,b)}d.beginUpdate();for(var g=0,h=b.length;g<h;g++){if(b[g].recycle){continue}var c=this.createNode(b[g]);if(c){d.appendChild(c)}}d.endUpdate();this.runCallback(k.callback,k.scope||d,[d])}catch(j){SYNO.Debug("tree loadexception");this.fireEvent("loadexception",this,d,b);this.runCallback(k.callback,k.scope||d,[d]);return}this.fireEvent("load",this,d,b)}else{this.fireEvent("loadexception",this,d,b);this.runCallback(k.callback,k.scope||d,[d])}},createNode:function(a){var b;a.uiProvider="SYNO.SDS.Backup.TriTreeNodeUI";a.draggable=false;if(Ext.isFunction(this.createNodeFn)){b=this.createNodeFn.call(this.createNodeScope||this,a);if(b===false){return}}var c=this.callParent(arguments);return c}});Ext.define("SYNO.SDS.Backup.BasicTreePanel",{extend:"SYNO.ux.TreePanel",constructor:function(a){var b=Ext.apply({useArrows:true,autoScroll:true,containerScroll:true,bodyStyle:"overflow-x: hidden;overflow-y:auto; padding-right: 12px;",enableDD:false},a);return this.callParent([b])},initEvents:function(){var a=this.callParent(arguments);this.mon(this,"checkchange",this.onCheckChange,this);this.mon(this,"expandnode",this.onExpandNode,this);return a},getCheckedSubTreeRoot:function(b){var a=[];var c=function(d){d.eachChild(function(f){var e=f.getUI()||{};if(!Ext.isFunction(e.getCheckValue)){return}if(true===e.getCheckValue()){a.push(f)}else{if("gray"===e.getCheckValue()){c(f)}}})};c(b||this.root);return a},onCheckChange:function(a,e){var d,c,g,f=function(k){var j=0,i=0,h=0;k.eachChild(function(m){var l=m.getUI()||{};if(l.checkbox&&Ext.isFunction(l.getCheckValue)&&(!Ext.isFunction(l.isDisabled)||!l.isDisabled())){if(true===l.getCheckValue()){i+=1}else{if(false===l.getCheckValue()){h+=1}}j+=1}});if(0===j){return k.getUI().getCheckValue()}else{if(i===j){return true}else{if(h===j){return false}else{return"gray"}}}},b=function(h){var i=Ext.apply({},h.attributes.depend);return Ext.applyIf(i,{parent:false,children:true})};g=b(a);if(true===g.children){if(true===e){a.eachChild(function(i){var h=i.getUI();if(h&&Ext.isFunction(h.setCheckValue)&&(!Ext.isFunction(h.isDisabled)||!h.isDisabled())){h.setCheckValue(true)}},this)}else{if(false===e){a.eachChild(function(i){var h=i.getUI();if(h&&Ext.isFunction(h.setCheckValue)&&(!Ext.isFunction(h.isDisabled)||!h.isDisabled())){h.setCheckValue(false)}},this)}}}d=a.parentNode;while(d){c=d.getUI();if(!c||!Ext.isFunction(c.getCheckValue)){g=b(d);d=d.parentNode;continue}if(true===g.parent){d.attributes.checked=f(d)}else{if(true===e&&false===d.attributes.checked){d.attributes.checked="gray"}else{if(false===e){d.attributes.checked=f(d)}}}c.syncCheckCssClass();g=b(d);d=d.parentNode}},onExpandNode:function(a){var b=a.getUI(),c=Ext.apply({},a.attributes.depend);Ext.applyIf(c,{parent:false,children:true});if(!b||!Ext.isFunction(b.getCheckValue)){return}if(true===c.children&&true===b.getCheckValue()){a.eachChild(function(d){b=d.getUI();if(b&&Ext.isFunction(b.isDisabled)&&!b.isDisabled()&&Ext.isFunction(b.setCheckValue)){b.setCheckValue(true)}},this)}}});Ext.define("SYNO.SDS.Backup.EnableColumn",{extend:"SYNO.ux.EnableColumn",constructor:function(a){this.callParent(arguments);if(Ext.isObject(this.afterCheck)&&Ext.isFunction(this.afterCheck.handler)){this.afterCheck.scope=this.afterCheck.scope||this;this.afterCheck=Ext.createDelegate(this.afterCheck.handler,this.afterCheck.scope)}},isIgnore:function(b,a){if(a.get("disabled")){return true}return false},toggleRec:function(a){this.callParent(arguments);if(Ext.isFunction(this.afterCheck)){this.afterCheck(a)}},renderer:function(c,b,a){if(a.get("disabled")){return'<div class="syno-ux-grid-enable-column-disabled">&nbsp;</div>'}else{return String.format('<div class="syno-ux-grid-enable-column-{0}">&nbsp;</div>',("gray"===c?"grayed":c?"checked":"unchecked"))}}});Ext.define("SYNO.SDS.Backup.AppGridPanel",{extend:"SYNO.ux.GridPanel",createColumnSelect:function(){this.enableColumn=new SYNO.SDS.Backup.EnableColumn({sortable:false,dataIndex:"checked",width:43,align:"center",afterCheck:{handler:function(a){this.clickShareNode(a);this.loadSelectStatus()},scope:this}});return this.enableColumn},createColumnAppInfo:function(){return new Ext.grid.Column({header:_T("backup","application"),width:260,dataIndex:"name",renderer:function(f,b,a,g,e,c){var d=new Ext.XTemplate('<table><tbody><tr><td><div class="syno-backup-cell-app-icon" style="background-image: url('+SYNO.SDS.Backup.AppIconPath+');"></div></td><td class="syno-backup-cell-app-title"><span class="syno-backup-cell-app-name">{name:htmlEncode}</span><tpl if="is_beta"><span class="syno-backup-cell-app-beta">&nbsp;Beta</span></tpl><div class="normal-font">{version:htmlEncode}</div></div></tr></tbody></table>');d.compile();return d.apply({name:a.get("name"),id:a.get("id"),version:a.get("version"),is_beta:a.get("is_beta")})}})},syncCheckedStatus:function(){this.enableColumn.checkSelectAll(this.getStore());this.loadSelectStatus()},clickShareNode:function(a){if(!a.get("depend")||!a.get("depend").share_list){return}var c=a.get("depend").share_list;var b=a.get("checked");if(b){Ext.each(c,function(e){var d=SYNO.SDS.Backup.getTreeNodeByCaseId(this.getFileTree(),"/"+e);d.getUI().setCheckValue(true)},this)}},loadSelectStatus:function(){var d=Ext.getCmp("selectStatus");var b=this.getStore().data.items.size();var a=this.getAppList().size();var c=String.format(_T("backup","app_select_count"),"<span class='blue-status'>"+a.toString()+"</span>","<span class='blue-status'>"+(b-a).toString()+"</span>");d.setText(c)},getAppList:function(){var a=[];Ext.each(this.getStore().data.items,function(b){if(true===b.get("checked")&&true!==b.get("disabled")){a.push(b.get("id"))}});return a}});Ext.define("SYNO.SDS.Backup.Restore.AppStep",{extend:"SYNO.SDS.Backup.AppGridPanel",AppSummary:{},isSupportInstall:false,constructor:function(b){Ext.copyTo(this,b,"owner");var e=this.createColumnSelect();var a=this.createColumnAppInfo();var d=new Ext.grid.Column({width:455,header:_T("common","status"),dataIndex:"depend",renderer:function(k,g,h,j,m,l){var f=h.get("depend");var n=[];var p="";var o=function(r,q){return String.format(_T("backup","app_restore_action_also_"+r),q)};if(h.get("error_code")){n.push({cls:'class="red-status"',status:SYNO.SDS.Backup.convertAppError(h.get("error_code"))})}if(f&&f.share_list&&0!==f.share_list.length){p=String.format(_T("backup","app_depend_share_restore"),h.get("name"),f.share_list.join(", "));n.push({cls:'class="red-status"',status:p})}if("skip"!==h.get("behavior")){n.push({status:o(h.get("behavior"),h.get("name"))})}if(f){Ext.each(f.app_list,function(q){if("skip"!==q.behavior){n.push({status:o(q.behavior,q.name)})}})}var i=new Ext.XTemplate('<div class="syno-backup-cell-app-status"><tpl for="."><span {cls}>{status:htmlEncode}</span><br/></tpl></div>');i.compile();return i.apply(n)}});var c=Ext.apply({height:420,cls:"syno-backup-app-grid-panel",store:this.createStore(),enableHdMenu:false,header:true,title:_T("backup","reswizard_app_title"),bwrapStyle:{paddingTop:"6px"},bbar:[new Ext.ux.StatusBar({id:"selectStatus",cls:"normal-font"})],colModel:new Ext.grid.ColumnModel({columns:[e,a,d]}),viewConfig:{getRowClass:function(f,i,g,h){if(f.get("disabled")){return"syno-backup-app-grid-disabled-row"}}},listeners:{rowmousedown:function(g,i,h){var f=g.getStore().getAt(i);if(f.get("disabled")){return false}}},plugins:[e]},b);this.callParent([c])},createStore:function(){return new Ext.data.JsonStore({proxy:new SYNO.API.Proxy({api:"SYNO.Backup.App.Restore",method:"list",timeout:300000,version:2}),listeners:{exception:{scope:this,fn:this.onStoreException},beforeload:{scope:this,fn:this.onBeforeLoad},load:{scope:this,fn:this.onLoad}},root:"app_list",idProperty:"id",sortInfo:{field:"name",direction:"ASC"},fields:["id","name","version","depend","disabled","behavior","error_code","is_beta"]})},isMaskError:function(a){return SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_APP_VOLUME===a||SYNO.SDS.Backup.ERR_APP_NO_SPACE===a},onStoreException:function(d,e,f,c,b,a){this.owner.clearStatusBusy();if(this.isMaskError(b.code)){this.loadErrorCode=b.code;return}this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(b.code),function(g){this.owner.close()},this)},onBeforeLoad:function(a,b){delete this.loadErrorCode;this.owner.setStatusBusy()},onLoad:function(b,a,c){SYNO.SDS.Backup.setAppGridDependency(this,this.getFileTree(),false);this.loadSelectStatus();this.owner.clearStatusBusy()},getFileTree:function(){return this.owner.getStep("share").getFileSourcePanel()},getVersionAppParams:function(){return this.owner.getBaseParams("share")},isReloadNeeded:function(){var a=Ext.encode(this.getVersionAppParams());if(this.lastQuery===a){return false}this.lastQuery=a;return true},activate:function(){if(this.isMaskError(this.loadErrorCode)){this.body.mask(SYNO.SDS.Backup.GetErrorString(this.loadErrorCode),"syno-ux-mask-info")}else{this.body.unmask()}if(!this.isReloadNeeded()){return}this.getStore().load({params:this.getVersionAppParams()})},summary:function(b){var d=[];var c={install:{title:_T("backup","app_install_list"),list:[]},reinstall:{title:_T("backup","app_reinstall_list"),list:[]},upgrade:{title:_T("backup","app_upgrade_list"),list:[]}};Ext.iterate(this.AppSummary,function(e,f){if(!f.isDepended){d.push(f.name)}if(f.behavior==="install"||f.behavior==="upgrade"){c[f.behavior].list.push(f.name+" ("+f.version+")")}else{if(f.behavior==="reinstall"){c[f.behavior].list.push(f.name)}}});if(0===d.length){b.append(_T("backup","app_restore_list"),_T("system","none_opt"))}else{b.append(_T("backup","app_restore_list"),d.join(", "))}for(var a in c){if(0<c[a].list.length){b.append(c[a].title,c[a].list.join(", "))}}},getNext:function(){if(0===this.owner.getStep("share").getFolderList().length&&0===this.getAppList().length&&!this.owner.getStep("config").isRestoreConfig()){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("backup","backup_data_empty"));return false}this.AppSummary={};if(0<this.getAppList().length){this.owner.getMsgBox().confirm("",_T("backup","restore_stop_app_alert"),function(a){if("yes"!==a){return}this.owner.setStatusBusy();var b=this.owner.getBaseParams();b.app_list=this.getAppList();this.sendWebAPI({api:"SYNO.Backup.App.Restore",version:1,method:"list_install",params:b,scope:this,callback:function(e,c,d){this.owner.clearStatusBusy();if(!e){this.owner.getMsgBox().alert(_T("leaf","backup"),_T("common","error_system"));return}Ext.each(c.app_list,function(i,g,h){var f=(-1===b.app_list.indexOf(i.id));if(f&&i.behavior==="skip"){return true}this.AppSummary[i.id]=[];this.AppSummary[i.id].name=i.name;this.AppSummary[i.id].behavior=i.behavior;this.AppSummary[i.id].version=i.version;this.AppSummary[i.id].isDepended=f},this);this.owner.goNext(this.nextId)}})},this);return false}return this.nextId},getParams:function(){return{app_list:this.getAppList()}}});Ext.define("SYNO.SDS.Backup.AppParamsPanel",{extend:"SYNO.SDS.Backup.AppGridPanel",checkedList:[],constructor:function(a){Ext.copyTo(this,a,"owner");var f=this.createColumnSelect();var d=this.createColumnAppInfo();var b=new Ext.grid.Column({header:SYNO.SDS.Backup.Util.widthEllipsis(_T("backup","share_depend"),110)+this.getTip(_T("backup","share_depend_qtip")),dataIndex:"depend",width:150,renderer:function(k,h,g,l,j,i){if(true===g.get("disabled")){return'<span class="red-status" ext:qtip="'+_T("backup","err_mapped_shared_folder_restore")+'">'+k.share_list.join(", ")+"</span>"}else{return(0<k.share_list.length?k.share_list.join(", "):"--")}}});var e=new Ext.grid.Column({header:SYNO.SDS.Backup.Util.widthEllipsis(_T("backup","disable_in_backup"),110)+this.getTip(_T("backup","disable_in_backup_qtip")),dataIndex:"disable",width:150,renderer:function(k,h,g,l,j,i){return(k?_T("common","no"):_T("common","yes"))}});var c=Ext.apply({height:450,cls:"syno-backup-app-grid-panel",store:this.createStore(),enableHdMenu:false,bwrapStyle:{paddingTop:"6px"},header:true,title:a.subTitle,bbar:[new Ext.ux.StatusBar({id:"selectStatus",cls:"normal-font"})],colModel:new Ext.grid.ColumnModel({columns:[f,d,b,e]}),viewConfig:{getRowClass:function(g,j,h,i){if(g.get("disabled")){return"syno-backup-app-grid-disabled-row"}}},listeners:{rowmousedown:function(h,j,i){var g=h.getStore().getAt(j);if(g.get("disabled")){return false}}},plugins:[f]},a);this.callParent([c])},getTip:function(e){var d=document.createElement("a");var a=document.createElement("img");var c="position: relative;";var b=SYNO.SDS.ThemeProvider.getPath("/webman/resources/images/components/icon_information_mini.png");a.setAttribute("src",SYNO.SDS.UIFeatures.IconSizeManager.getIconPath(b,""));a.setAttribute("width","24px");a.setAttribute("height","24px");a.setAttribute("style",c);a.setAttribute("ext:qtip",e);d.appendChild(a);return d.outerHTML},createStore:function(){return new Ext.data.JsonStore({id:"id",sortInfo:{field:"name",direction:"ASC"},fields:["id","name","version","checked","depend","disable","is_beta"]})},getFileTree:function(){return this.owner.getSourceSelector()},loadStore:function(){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.App.Backup",method:"list",version:2,scope:this,callback:function(c,a,b){if(!c){this.owner.clearStatusBusy();if(SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_APP_VOLUME===a.code){this.loadErrorCode=a.code}else{this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code),function(d){this.owner.close()},this)}}Ext.each(a,function(d){if(-1<this.checkedList.indexOf(d.id)){d.checked=true}else{d.checked=false}},this);this.getStore().loadData(a);this.owner.doIfAppShareReady("app_loaded");this.loadSelectStatus();this.owner.clearStatusBusy()}})},needHide:function(){if(this.loadErrorCode){return false}return(0===this.getStore().data.items.length)},activate:function(){if(this.loadErrorCode){this.bwrap.mask(SYNO.SDS.Backup.GetErrorString(this.loadErrorCode),"syno-ux-mask-info")}},afterRender:function(){this.callParent(arguments);if(!this.owner.app_loaded){this.loadStore()}this.getView().refresh();if(this.owner.app_loaded){if(this.loadErrorCode){this.bwrap.mask(SYNO.SDS.Backup.GetErrorString(this.loadErrorCode),"syno-ux-mask-info")}else{if(Ext.isEmpty(this.getStore().data.items)){this.bwrap.mask(_T("backup","no_application"),"syno-ux-mask-info")}}}},setAppList:function(a){this.checkedList=a;this.loadStore()},getParams:function(){return this.getAppList()},getNext:function(){var g=this.owner.getParams();var f=this.owner.getStep("source_repo").getSourceSelector();var e=g.transfer_type;var a=[];var d;var c;if(!f.isValid()){this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});return false}if("share"===g.target_type&&"local"===g.transfer_type){d=g.share;c=f.getNodeById("/"+d);if(c&&false!==c.getUI().getCheckValue()){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("localbkp","localbkp_dest_conflict_bkpshare"));return false}}var b=function(i,j){var k=j.target_type;if(k!=="share"&&k!=="cloud"){return}var l={};l.api="SYNO.Backup.Target";l.version=1;l.method="get_candidate_dir";l.params={};Ext.apply(l.params,j);i.push(l);return};b(a,g);var h={};Ext.apply(h,g);Ext.apply(h,{additional:["support_auto_unmount"]});a.push({api:"SYNO.Backup.Repository",version:1,method:"get",params:h});if(0<a.length){this.appWin.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:true,params:a},timeout:240000,scope:this,callback:function(l,i,j){var k=true;this.appWin.clearStatusBusy();if(!l){this.appWin.getMsgBox().alert(_T("leaf","backup"),_T("common","error_system"));return}Ext.each(i.result,function(m){if(!m.success){k=false;this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(m.error.code));return false}if(m.method==="get_candidate_dir"){this.appWin.setDestFolderName(m.data.candidate_dir,g.target_type,g.transfer_type);this.appWin.setRsyncTransEncrypt(m.data.deststatus,g.target_type,g.transfer_type)}if(m.api==="SYNO.Backup.Repository"&&m.method==="get"){var n=this.appWin.getStep(this.nextId[e]).getForm();if(n&&n.findField("dest_auto_unmount")){if(m.data.support_auto_unmount){n.findField("dest_auto_unmount").show()}else{n.findField("dest_auto_unmount").hide()}}}},this);if(k){this.appWin.goNext(this.nextId[e])}}});return false}else{return this.nextId[e]}}});Ext.define("SYNO.SDS.Backup.TaskSourceSelector",{extend:"SYNO.SDS.Backup.BasicTreePanel",border:false,dest:undefined,folderLoadCount:0,_mysql_pwd:undefined,pre_load_folder_done:false,constructor:function(a){this.fm_root_nodes=[];this.pre_load_folder_done=a.pre_load_folder_done;var b=Ext.apply({rootVisible:false,loader:new SYNO.SDS.Backup.TreeLoader(),root:(new Ext.tree.AsyncTreeNode({draggable:false,id:"root",title:_T("backup","select_share_app_title")}))},a);return this.callParent([b])},initEvents:function(){var a=this.callParent(arguments);this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Source.Folder",version:1,method:"list",params:{node:"fm_root"},callback:function(d,b,c){this.owner.clearStatusBusy();if(!d){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}this.allFolders=b;if(this.pre_load_folder_done){this.createVolumeNodes()}else{this.pre_load_folder_done=true}},scope:this});return a},createVolumeNodes:function(){var c={};Ext.each(this.allFolders,function(e){if(!c[e.volume]){c[e.volume]=[e]}else{c[e.volume].push(e)}},this);var d=function(g,f,e){if(-1!==this.fm_root_nodes.indexOf(f.id)){if(0===f.childNodes.size()){f.disable()}this.folderLoadCount++;if(this.folderLoadCount===this.volumeCount){this.owner.doIfAppShareReady("folder_loaded")}}};var b;if(this._folder_list){b=this._folder_list.slice(0)}else{b=[]}var a=Object.keys(c);a.sort();this.volumeCount=a.length;if(0>=this.volumeCount){this.owner.doIfAppShareReady("folder_loaded");this.owner.doIfAppShareReady("folder_initialed");this.bwrap.mask(_T("backup","repo_no_share"),"syno-ux-mask-info")}Ext.each(a,function(f){if(c.hasOwnProperty(f)){var e=this.createTreeLoader("SYNO.Backup.Source.Folder",this.onCreateFolderNode,c[f]);e.on("load",d,this);var h="fm_root"+this.fm_root_nodes.size();this.fm_root_nodes.push(h);this.root.appendChild({id:h,expanded:true,leaf:false,text:this.getVolName(f,c[f][0].display_vol_name),iconCls:"syno-backup-volume",loader:e,uiProvider:SYNO.SDS.Backup.TriTreeNodeUI,checked:"none"});var g=this.getNodeById(h);g.volume=f}},this);Ext.each(this.fm_root_nodes,function(f){var e=this.getNodeById(f);e.attributes.checked=this.getCheckState(f,b);e.getUI().syncCheckCssClass()},this);this.setConflictVolume()},setConflictVolume:function(){var a=null;if(Ext.isFunction(this.owner.getLocalRepoVolume)){a=this.owner.getLocalRepoVolume()}Ext.each(this.fm_root_nodes,function(c){var b=this.getNodeById(c);if(b&&a&&b.volume===a){b.getUI().getEl().addClassName("syno-backup-tri-conflict-volume")}else{if(b){b.getUI().getEl().removeClassName("syno-backup-tri-conflict-volume")}}},this)},getVolName:function(b,d){var e;var a="";var c=b.replace("/volume","");if(-1!==b.indexOf("usb")){return d}if(!isNaN(c)){e=parseInt(c,10)}else{e=c}a=String.format("{0} {1}",_T("volume","volume"),e);return a},createTreeLoader:function(g,f,d,c,b,h,a){var e=new SYNO.SDS.Backup.TreeLoader({sendWebAPI:this.sendWebAPI.createDelegate(this),webapi:{api:g,method:h||"list",version:a||1},createNodeFn:f,createNodeScope:this,owner:this,nodeData:d});return e},convertLanguage:function(a,b){var c=SYNO.SDS.Backup.converLanString(a[b]);if(c){if((b+"_param") in a){c=String.format(c,a[b+"_param"])}a[b]=c}},onCreateFolderNode:function(a){a.uiProvider="SYNO.SDS.Backup.TriTreeDisableCheckNodeUI";this.convertLanguage(a,"text");this.convertLanguage(a,"qtip");if("remote"==a.fileSystemType){a.disabled=true;a.qtip=_T("backup","source_not_remote_folder")}else{if("image"==a.fileSystemType){a.disabled=true;a.qtip=_T("backup","source_not_virtual_drive")}}if(true===a.encryptedShare){if(true===a.dataEncrypted){a.iconCls="syno-backup-share-encrypted";a.leaf=true}else{a.iconCls="syno-backup-share-decrypted"}}if(true===a.disabled){a.leaf=true}if(Ext.isBoolean(a.checked)||a.checked==="gray"){a.checked=this.getCheckState(a.id,this._folder_list)}if(a.checked===false&&a.recycle===true){a.hidden=true;a.disabled=true}},onCheckChange:function(d,e){var b=this.callParent(arguments);var f=d.attributes.id;var a,c;if(!f){return b}if(this._folder_list){a=[];Ext.each(this._folder_list,function(h,g){if(h===f){a.push(g);return false}else{if(h.indexOf(f+"/")===0){a.push(g)}}},this);for(c=a.length-1;c>=0;c--){this._folder_list.splice(a[c],1)}}if(this._app_list){a=[];Ext.each(this._app_list,function(h,g){if(h===f){a.push(g);return false}else{if(h.indexOf(f+"/")===0){a.push(g)}}},this);for(c=a.length-1;c>=0;c--){this._app_list.splice(a[c],1)}}return b},getCheckState:function(c,b){var a=false;if(!b){return false}if(-1!==this.fm_root_nodes.indexOf(c)){Ext.each(b,function(f){var d=f.indexOf("/",1);if(-1!==d){f=f.substring(0,d)}var e=this.getNodeById(f);if(null!==e&&e.parentNode.id===c){a="gray";return false}},this);return a}else{Ext.each(b,function(e,d){if(c===e){b.splice(d,1);a=true;return false}else{if(e.indexOf(c+"/")===0){a="gray";return false}}});return a}},setFolderList:function(c){this._folder_list=[];var b=[];var g=[];var f=[];var d=[];var a=false;var e="";Ext.each(c,function(h){if(h.isValidSource){this._folder_list.push(h.folderPath)}else{if("remote"==h.fileSystemType){b.push(SYNO.SDS.Backup.Util.lengthEllipsis(h.folderPath.substring(1),20))}else{if("image"==h.fileSystemType){g.push(SYNO.SDS.Backup.Util.lengthEllipsis(h.folderPath.substring(1),20))}else{if(h.missing){d.push(SYNO.SDS.Backup.Util.lengthEllipsis(h.folderPath.substring(1),20))}else{f.push(SYNO.SDS.Backup.Util.lengthEllipsis(h.folderPath.substring(1),20))}}}}},this);if(0<b.length){e+=(_T("backup","remote_folder")+": "+b.join(", ")+"<br/>");a=true}if(0<g.length){e+=(_T("backup","virtual_drive")+": "+g.join(", ")+"<br/>");a=true}if(0<d.length){e+=(_T("backup","missing_folder")+": "+d.join(", ")+"<br/>");a=true}if(0<f.length){e+=(_T("backup","not_support_filesystem")+": "+f.join(", ")+"<br/>");a=true}if(a){this.owner.invalidList+=e}if(this.pre_load_folder_done){this.createVolumeNodes()}else{this.pre_load_folder_done=true}},getFolderList:function(){var a=[];Ext.each(this.fm_root_nodes,function(b){Ext.each(this.getCheckedSubTreeRoot(this.getNodeById(b)),function(c){a.push(c.id)})},this);Ext.each(this._folder_list,function(b){a.push(b)});return a},enableEncryptionShare:function(){Ext.each(this.fm_root_nodes,function(e){var a;var c=this.getNodeById(e);var d=c.childNodes.size();for(a=0;a<d;a++){var b=c.childNodes[a];if(true===b.attributes.encryptedShare){if(false===b.attributes.disabled){b.enable();this.setExpandable(b,true);b.setTooltip(b.text)}else{b.setTooltip(_T("backup","source_not_unmount_encrypted_share"))}}}},this)},disableEncryptionShare:function(){var a=false;Ext.each(this.fm_root_nodes,function(f){var b;var d=this.getNodeById(f);var e=d.childNodes.size();for(b=0;b<e;b++){var c=d.childNodes[b];if(true===c.attributes.encryptedShare){if(true===this.hasCheckedNode(c)){a=true}c.getUI().setCheckValue(false);c.disable();this.setExpandable(c,false);c.setTooltip(_T("backup","multi_version_not_support_encrypted_share"))}}},this);return a},hasCheckedNode:function(b){if(b.getUI().isChecked()){return true}var c=b.childNodes.size();var a;for(a=0;a<c;a++){if(true===this.hasCheckedNode(b.childNodes[a])){return true}}return false},setExpandable:function(a,b){a.collapse(false,false);a.leaf=!b;a.getUI().updateExpandIcon()},disableNode:function(a){a.getUI().setCheckValue(false);this.setExpandable(a,false);a.disable()},enableNode:function(a){a.enable();this.setExpandable(a,true)},setDestination:function(a){var b=this.getNodeById(a);if(undefined!==this.dest){this.clearDestination()}if(b!==undefined){this.disableNode(b);b.attributes.disabled=true;b.setTooltip(_T("backup","source_share_conflict_destination"));this.dest=a}},clearDestination:function(){var a=this.getNodeById(this.dest);if(a){this.enableNode(a);a.setTooltip(a.text);a.attributes.disabled=false;this.dest=undefined}},isValid:function(){return true},onBeforeLoad:function(c,a,b){if(true===a.disabled){return false}}});Ext.define("SYNO.SDS.Backup.Repository.PrivilegePanel",{extend:"SYNO.ux.GridPanel",constructor:function(a){this.owner=a.owner;this.repoId=a.repoId;this.apiURL=a.apiURL;this.repoPermAutoAdd=a.repoPermAutoAdd;this.userChooserDialog=null;this.domainUserHomeEnabled=a.domainUserHomeEnabled;this.ldapUserHomeEnabled=a.ldapUserHomeEnabled;this.repoName=a.repoName;this.pagingSize=20;if(a.targetId){this.targetId=a.targetId}if(a.pagingSize){this.pagingSize=a.pagingSize}this.userStore=this.createUserStore();var b={cls:"syno-backup-repository-privilege-grid-panel",store:this.userStore,header:false,height:a.height?a.height:450,autoExpandColumn:"descr",layout:"fit",tbar:{style:{border:"none"},items:[{xtype:"syno_button",text:_T("common","add"),itemId:"addBtn",handler:this.onAddBtnClick,scope:this},{xtype:"syno_button",text:_T("common","remove"),itemId:"delBtn",handler:this.onDelBtnClick,disabled:true,scope:this}]},colModel:new Ext.grid.ColumnModel({columns:[{id:"name",header:_T("user","user_account"),dataIndex:"name",width:150,renderer:function(g,e,f){var c="";var d="";if(!f.get("removable")){c="syno-backup-privilege-default-group";d='ext:qtip="'+_T("common","default")+'"'}if("group"===f.get("group")){return String.format('<div class="acl-combo-item-group {0}" style="left:0px"><span style="padding-left:25px" {2}>{1}</span></div>',c,g.substring(1),d)}else{if("user"===f.get("group")){return String.format('<div class="acl-combo-item-user {0}"><span style="padding-left:25px" {2}>{1}</span></div>',c,g,d)}}}},{id:"descr",header:_T("user","user_fullname"),dataIndex:"descr",width:150,renderer:function(e,c,d){if(!d.get("removable")){return String.format('<div class="syno-backup-privilege-default-group" {1}>{0}</div>',e,'ext:qtip="'+_T("common","default")+'"')}return e}}]}),selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:{fn:this.onSelectionChange,buffer:50,scope:this},beforerowselect:{fn:this.onBeforeRowSelect,scope:this}}}),bbar:new SYNO.ux.PagingToolbar({store:this.userStore,pageSize:this.pagingSize,displayInfo:true})};Ext.apply(b,a);SYNO.LayoutConfig.fill(b);this.callParent([b])},onBeforeRowSelect:function(a,d,b,c){if(!c.get("removable")){return false}return true},setRepoId:function(a){this.repoId=a;this.userStore.baseParams.repo_id=a},onShow:function(){this.userStore.load({params:{offset:0,limit:this.pagingSize}})},onSelectionChange:function(){var a=this.getTopToolbar();var b=this.getSelectionModel().getCount();a.getComponent("delBtn").setDisabled(0>=b)},createUserStore:function(){var a=new SYNO.API.JsonStore({api:this.apiURL,method:"list",version:1,fields:["uid","group","name","descr","removable"],appWindow:this.findAppWindow()||false,idProperty:"name",defaultSortable:false,totalProperty:"total",root:"user",autoDestroy:true,baseParams:{repo_id:this.repoId,target_id:this.targetId,type:"all",privileged_user:true}});return a},onDelBtnClick:function(){this.owner.getMsgBox().confirmDelete(_T("backup","repo_choose_white_list"),_T("backup","cfrm_remove_user"),function(a){if("yes"==a){this.doDelete()}},this)},doDelete:function(){var b=[];var c=this.getSelectionModel().getSelections();for(var a=0;a<c.length;a++){b.push([c[a].get("uid"),c[a].get("group")])}this.owner.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:this.apiURL,method:"delete",version:1,scope:this,params:{repo_id:this.repoId,target_id:this.targetId,user_list:b},callback:function(f,e,d){this.owner.clearStatusBusy();if(f){this.deleteDone()}else{this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(e.code));return}}})},deleteDone:function(){this.userStore.reload()},onAddBtnClick:function(){var a=this.repoId;var c=this.targetId;var b=this.apiURL;this.userChooserDialog=new SYNO.SDS.UserChooser({owner:this.owner,domainForceIgnore:!this.domainUserHomeEnabled,ldapForceIgnore:!this.ldapUserHomeEnabled,pagingSize:10,scope:this,setStoreConfig:function(){return{api:b,method:"list",version:1,fields:["uid","group","name","descr","enable"],idProperty:"name",defaultSortable:false,totalProperty:"total",root:"user",autoDestroy:true,baseParams:{repo_id:a,target_id:c,type:"local_user",privileged_user:false,offset:0,limit:this.pagingSize}}},setApiParams:function(){return{type:"all"}},setStoreField:function(){return["id","name","descr"]},setColModel:function(){return[{id:"name",header:_T("user","user_account"),dataIndex:"name",width:150,renderer:function(g,e,f){if("@"===g.charAt(0)){g=g.substring(1)}if(!f.get("enable")){var d=String.format(_T("backup","user_in_allow_list"),g);return String.format('<div class="syno-backup-privilege-default-group" {1}>{0}</div>',g,'ext:qtip="'+d+'"')}return g}},{id:"descr",header:_T("user","user_fullname"),dataIndex:"descr",width:150,renderer:function(g,e,f){if(!f.get("enable")){var d=String.format(_T("backup","user_in_allow_list"),f.get("name"));return String.format('<div class="syno-backup-privilege-default-group" {1}>{0}</div>',g,'ext:qtip="'+d+'"')}return g}}]},setTextFilterConfig:function(){return{queryAction:"list",queryParam:"substr"}},setGridPanelConfig:function(){return{autoExpandColumn:"descr",selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:{scope:this,fn:this.onSelectionChange},beforerowselect:{fn:function(d,g,e,f){if(!f.get("enable")){return false}return true},scope:this}}})}},LOCAL_ROLES:[["local_user",_T("share","share_local_user")],["local_group",_T("share","share_local_group")]],DOMAIN_ROLES:[["domain_user",_T("share","share_domain_user")],["domain_group",_T("share","share_domain_group")]],LDAP_ROLES:[["ldap_user",_T("share","ldap_user")],["ldap_group",_T("share","ldap_group")]],roleFilterDefVal:"local_user",singleSelect:false,localOnly:false});this.mon(this.userChooserDialog,"beforeclose",this.onBeforeCloseUserChooser,this);this.userChooserDialog.chooseUsers()},onBeforeCloseUserChooser:function(b){this.addItems=[];var c=b.getRecords();if(0===c.length){return true}for(var a=0;a<c.length;a++){this.addItems.push([c[a].get("uid"),c[a].get("group"),c[a].get("name")])}b.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:this.apiURL,method:"add",params:{repo_id:this.repoId,target_id:this.targetId,user_id:this.addItems},version:1,scope:this,callback:function(f,e,d){if(f){this.userStore.reload();this.mun(this.userChooserDialog,"beforeclose",this.onBeforeCloseUserChooser,this);if(this.repoPermAutoAdd){this.checkRepoPermission()}else{this.userChooserDialog.clearStatusBusy();this.userChooserDialog.close()}}else{this.userChooserDialog.clearStatusBusy();this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(e.code));return}}});return false},checkRepoPermission:function(){var a=[];if(this.addItems.length===0){this.userChooserDialog.clearStatusBusy();this.userChooserDialog.close();return}this.autoAddList=[];this.autoAddNames="";this.addUsers=[];this.addGroups=[];Ext.each(this.addItems,function(b){if("user"===b[1]){this.addUsers.push({uid:b[0],name:b[2]})}else{this.addGroups.push({uid:b[0],name:b[2]})}},this);if(this.addUsers.length>0){a.push({api:"SYNO.Backup.Repository",version:1,method:"check_permission",params:{repo_id:this.repoId,user_id:this.addUsers,repo_action:"restore"}})}if(this.addGroups.length>0){a.push({api:"SYNO.Backup.Repository.PrivilegedUser",method:"list",version:1,params:{repo_id:this.repoId,type:"all",privileged_user:true}})}this.sendWebAPI({scope:this,compound:{stopwhenerror:true,params:a},callback:this.confirmAutoAdd})},listDenyUsers:function(a){Ext.each(a,function(b){if(!b.allow){this.autoAddList.push([b.uid,"user"]);if(this.autoAddNames.length>0){this.autoAddNames+=", "}this.autoAddNames+=b.name}},this)},listDenyGroups:function(a){Ext.each(this.addGroups,function(b){var c=false;Ext.each(a.user,function(d){if(b.uid===d.uid&&"group"===d.group){c=true;return false}},this);if(!c){if(this.autoAddNames.length>0){this.autoAddNames+=", "}this.autoAddNames+=b.name.substring(1);this.autoAddList.push([b.uid,"group"])}},this)},confirmAutoAdd:function(c,a,b){this.userChooserDialog.clearStatusBusy();if(!c){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));this.userChooserDialog.close();return}Ext.each(a.result,function(d){if(d.api==="SYNO.Backup.Repository"&&d.method==="check_permission"){this.listDenyUsers(d.data)}if(d.api==="SYNO.Backup.Repository.PrivilegedUser"&&d.method==="list"){this.listDenyGroups(d.data)}},this);if(0===this.autoAddList.length){this.userChooserDialog.close();return}this.userChooserDialog.close();this.owner.getMsgBox().confirm(_T("backup","repo_choose_white_list"),String.format(_T("backup","target_auto_add_white_list_confirm")+"<br>"+this.autoAddNames,this.repoName),function(d){if("yes"===d){this.owner.setStatusBusy({text:_T("common","loading")});this.sendWebAPI({api:"SYNO.Backup.Repository.PrivilegedUser",method:"add",version:1,params:{repo_id:this.repoId,user_id:this.autoAddList},scope:this,callback:function(g,e,f){this.owner.clearStatusBusy();if(!g){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(e.code));return}}})}},this)}});Ext.define("SYNO.SDS.Backup.Repository.PrivilegeDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){this.owner=a.owner;this.panel=new SYNO.SDS.Backup.Repository.PrivilegePanel({owner:this,domainUserHomeEnabled:a.domainUserHomeEnabled,ldapUserHomeEnabled:a.ldapUserHomeEnabled,repoId:a.repoId,targetId:a.targetId,apiURL:a.apiURL,repoPermAutoAdd:a.repoPermAutoAdd,repoName:a.repoName});var b=Ext.apply({dsmStyle:"v5",title:a.title,autoDestroy:true,width:670,height:500,autoHeight:true,layout:"fit",items:[this.panel],buttons:[{text:_T("common","alt_finish"),scope:this,handler:this.close}]},a);this.callParent([b]);this.mon(this,"show",this.panel.onShow,this.panel)}});(function(){var a="Local Archiving Storage",b="Local Share Storage";Ext.define("SYNO.SDS.Backup.Repository.LocalCreateStep",{extend:"SYNO.ux.FormPanel",constructor:function(c){Ext.copyTo(this,c,"owner");var d=Ext.apply({items:[{xtype:"syno_fieldset",title:_T("backup","repo_create_local_headline"),collapsible:false,defaults:{labelWidth:300},items:[]}]},c);if(!this.owner._D("usbstation")){this.addVersionBackupFields(d)}this.addLocalBackupFields(d);this.callParent([d])},addVersionBackupFields:function(c){c.items[0].items.push({xtype:"syno_radio",boxLabel:_T("backup","version_backup"),name:"target_type",itemId:"version_backup",inputValue:"image"},{xtype:"syno_displayfield",value:_T("backup","version_backup_desc"),indent:1},{xtype:"syno_textfield",name:"version_backup_name",indent:1,allowBlank:false,fieldLabel:_T("backup","repo_name"),value:a,maxLength:32,maxlength:32,vtype:"backup_destination"},{xtype:"syno_combobox",indent:1,name:"volume",fieldLabel:_T("volume","volume"),store:this.getVolumeStore(),displayField:"volume",valueField:"volume",allowBlank:false,forceSelection:true,listeners:{beforeselect:function(e,d,f){if(d.get("status")!==0){return false}}},tpl:'<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(values.status === 1 ? String.format(_T("backup", "repo_already_exist") + " [" + Ext.util.Format.htmlEncode(values.conflict_repo) + "]") : Ext.util.Format.htmlEncode(values.volume))]}" class="x-combo-list-item {[values.status === 0 ? "syno-backup-enabled-list-item" : "syno-backup-disabled-list-item"]}">{volume:htmlEncode}</div></tpl>'})},addLocalBackupFields:function(d){var c=this.owner._D("usbstation")?0:1;d.items[0].items.push({xtype:"syno_radio",boxLabel:_T("backup","local_backup"),name:"target_type",itemId:"local_backup",hidden:this.owner._D("usbstation")?true:false,inputValue:"share"},{xtype:"syno_displayfield",value:_T("backup","local_backup_desc"),indent:c},{xtype:"syno_textfield",indent:c,name:"local_backup_name",allowBlank:false,fieldLabel:_T("backup","repo_name"),value:b,maxLength:32,maxlength:32,vtype:"backup_destination"},{xtype:"syno_combobox",indent:c,name:"share",allowBlank:false,fieldLabel:_T("tree","leaf_sharefolder"),forceSelection:true,store:this.getShareStore(),displayField:"share",valueField:"share",listeners:{beforeselect:function(f,e,g){if(e.get("status")!==0){return false}},select:function(f,e,g){this.shareVolume=e.get("volume")},scope:this},tpl:'<tpl for="."><tpl if="values.status === 0"><div ext:qtip="{[Ext.util.Format.htmlEncode(values.share)]}" class="x-combo-list-item syno-backup-enabled-list-item">{share:htmlEncode}</div></tpl><tpl if="values.status === 1"><div ext:qtip="{[Ext.util.Format.htmlEncode(String.format(_T("backup", "repo_already_exist") + " [" + Ext.util.Format.htmlEncode(values.conflict_repo) + "]"))]}" class="x-combo-list-item syno-backup-disabled-list-item">{share:htmlEncode}</div></tpl><tpl if="values.status === 2"><div ext:qtip="{[Ext.util.Format.htmlEncode(_T("backup", "hfsplus_readonly_not_support"))]}" class="x-combo-list-item syno-backup-disabled-list-item">{share:htmlEncode}</div></tpl></tpl>'})},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){var c;c=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"target_type",{image:["version_backup_name","volume"],share:["local_backup_name","share"]})},this,{single:true})},getVolumeStore:function(){if(!this.volumeStore){this.volumeStore=new Ext.data.ArrayStore({autoDestroy:true,autoLoad:false,fields:["volume","status","conflict_repo"]})}return this.volumeStore},getShareStore:function(){if(!this.shareStore){this.shareStore=new Ext.data.ArrayStore({autoDestroy:true,autoLoad:false,fields:["share","status","conflict_repo","volume"]})}return this.shareStore},getParams:function(){var d={};var c=this.getForm().findField("target_type").getGroupValue();d=this.getForm().getFieldValues();d.target_type=c;if(c==="image"){d.transfer_type="image_local";d.repo_name=d.version_backup_name;delete d.version_backup_name}else{if(c==="share"){d.transfer_type="local";d.repo_name=d.local_backup_name;delete d.local_backup_name}}delete d["undefined"];return d},getLocalRepoVolume:function(){if(this.getForm().getFieldValues().volume){return this.getForm().getFieldValues().volume}return this.shareVolume},activate:function(){if(!this.loaded){SYNO.Debug("no data loaded")}},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},loadData:function(f){var k=this,j,h={};var l=SYNO.ux.Utils.getRadioGroup(k.getForm(),"target_type");Ext.each(f.result,function(i){if(i.api==="SYNO.Backup.Storage.Volume.Local"){k.getVolumeStore().loadData(i.data.volume_list)}else{if(i.api==="SYNO.Backup.Storage.Share.Local"){k.getShareStore().loadData(i.data.share_list)}}},k);if(!this.owner._D("usbstation")){var d=l[0].getEl();if(this.volume_tip_pos===Ext.getDom(d).parentNode.childNodes.length){Ext.getDom(d).parentNode.lastChild.remove(true)}j=k.getVolumeStore().findExact("status",0);if(j!==-1){h.target_type="image";h.volume=k.getVolumeStore().getAt(j).get("volume");k.getComponent(0).getComponent("version_backup").enable();this.volume_tip_pos=0}else{var e;k.getForm().findField("volume").setValue(_T("netbackup","err_no_volume"));k.getComponent(0).getComponent("version_backup").disable();if(f.result[0].success){e=_T("backup","all_volumes_in_repo_list")}else{e=SYNO.SDS.Backup.GetErrorString(f.result[0].error)}SYNO.SDS.Utils.AddTip(d,e);this.volume_tip_pos=Ext.getDom(d).parentNode.childNodes.length}h.version_backup_name=k.owner.createRepoDefaultName(a)}var c=l[l.size()-1].getEl();if(this.share_tip_pos===Ext.getDom(c).parentNode.childNodes.length){Ext.getDom(c).parentNode.lastChild.remove(true)}j=k.getShareStore().findExact("status",0);if(j!==-1){h.target_type=h.target_type||"share";h.share=k.getShareStore().getAt(j).get("share");this.shareVolume=k.getShareStore().getAt(j).get("volume");k.getComponent(0).getComponent("local_backup").enable();this.share_tip_pos=0}else{var g;k.getForm().findField("share").setValue(_T("netbackup","err_no_share"));k.getComponent(0).getComponent("local_backup").disable();if(f.result[1].success){if(0===k.getShareStore().getCount()){g=_T("netbackup","err_no_share")}else{g=_T("backup","all_shares_in_repo_list")}}else{g=SYNO.SDS.Backup.GetErrorString(f.result[1].error)}SYNO.SDS.Utils.AddTip(c,g);this.share_tip_pos=Ext.getDom(c).parentNode.childNodes.length}h.local_backup_name=k.owner.createRepoDefaultName(b);k.getForm().setValues(h);k.loaded=true;if(!Ext.isDefined(h.volume)&&!Ext.isDefined(h.share)){return false}else{return true}}})})();(function(){Ext.define("SYNO.SDS.Backup.Repository.PrivilegeCreateStep",{extend:"SYNO.ux.FormPanel",constructor:function(a){Ext.copyTo(this,a,"owner");this.panel=new SYNO.SDS.Backup.Repository.PrivilegePanel({owner:this.owner,domainUserHomeEnabled:true,ldapUserHomeEnabled:true,height:360,repoId:null,apiURL:"SYNO.Backup.Repository.PrivilegedUser",title:_T("backup","repo_choose_white_list")});var b=Ext.apply({dsmStyle:"v5",autoDestroy:true,layout:"fit",autoHeight:true,items:[{xtype:"syno_fieldset",title:_T("backup","repo_create_privilege_headline"),collapsible:false,defaults:{labelWidth:250},items:[this.panel]}]},a);this.callParent([b]);this.mon(this,"show",this.panel.onShow,this.panel)},checkState:function(){this.owner.getButton("back").hide();this.owner.getButton("next").hide();this.owner.getButton("cancel").setText(_T("common","alt_finish"))},setRepoId:function(a){this.repoId=a;this.panel.setRepoId(a)}})})();(function(){var c="Remote Archiving Storage",b="Remote Share Storage",a="Rsync Compatible Storage";Ext.define("SYNO.SDS.Backup.Repository.NetworkAuthStep",{extend:"SYNO.ux.FormPanel",constructor:function(d){Ext.copyTo(this,d,"owner");this.fieldLabelWidth=300;this.server_type=0;this.callParent([this.fillConfig(d)]);this.mon(this,"activate",function(){var e=this.getForm().findField("sshportcheck");if(this.isSynologyServer()&&e&&e.getEl()&&3===Ext.getDom(e.getEl()).parentNode.childNodes.length){SYNO.SDS.Utils.AddTip(e.getEl(),_T("netbackup","netbkp_ssh_port_info"))}},this,{single:true})},fillConfig:function(d){return Ext.apply({trackResetOnLoad:true,defaults:{labelWidth:this.fieldLabelWidth},items:[{xtype:"syno_fieldset",title:_T("backup","repo_create_net_auth_headline"),collapsible:false,items:[{xtype:"syno_combobox",name:"network_type",fieldLabel:_T("netbackup","netbkp_slct_server"),allowBlank:false,store:new Ext.data.ArrayStore({fields:["type_name"],data:[[String.format(_T("netbackup","synology_server"),_D("company_title"))],[_T("netbackup","rsync_compatible_server")]]}),displayField:"type_name",valueField:"type_name",editable:false,value:String.format(_T("netbackup","synology_server"),_D("company_title")),listeners:{scope:this,select:function(f,e,g){f.setValue(e.get("type_name"));this.server_type=g;this.changeView()}}},new SYNO.SDS.Backup.HostCombobox({name:"dest",owner:this.owner}),{xtype:"syno_textfield",name:"account",allowBlank:false,fieldLabel:_T("netbackup","netbkp_account")},{xtype:"syno_textfield",name:"pwd",allowBlank:true,fieldLabel:_T("common","password"),inputType:"password"},{xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_checkbox",name:"sshportcheck",boxLabel:_T("netbackup","netbkp_enable_ssh_port"),width:this.fieldLabelWidth,scope:this,handler:function(f,e){if(e){this.getForm().findField("enc_port").enable()}else{this.getForm().findField("enc_port").disable()}}},{xtype:"syno_numberfield",maxlength:5,vtype:"port",disabled:true,name:"enc_port",width:200,allowBlank:false}]},{xtype:"syno_displayfield",value:""},{xtype:"syno_textfield",name:"rsync_backup_name",allowBlank:false,fieldLabel:_T("backup","repo_name"),value:a,maxLength:32,maxlength:32,hidden:true,disabled:true,vtype:"backup_destination"},{xtype:"syno_combobox",name:"module",fieldLabel:_T("netbackup","netbkp_module"),allowBlank:false,store:this.getModuleStore(),displayField:"share",valueField:"share",editable:true,hidden:true,disabled:true,onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadModule()){this.scope.loadModuleStore()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},scope:this,listeners:{beforeselect:function(f,e,g){if(e.get("status")!==0){return false}}},tpl:'<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(values.status === 1 ? String.format(_T("backup", "repo_already_exist") + " [" + Ext.util.Format.htmlEncode(values.conflict_repo) + "]") : Ext.util.Format.htmlEncode(values.share))]}" class="x-combo-list-item {[values.status === 0 ? "syno-backup-enabled-list-item" : "syno-backup-disabled-list-item"]}">{share:htmlEncode}</div></tpl>'}]}]},d)},isSynologyServer:function(){if(0===this.server_type){return true}return false},getNext:function(){var d=this.getForm();if(!d.isValid()){return false}if(this.isSynologyServer()){this.loadOptions();return false}else{var e=this.getParams();this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:e,scope:this,callback:function(h,f,g){this.owner.clearStatusBusy();if(!h){this.owner.reportError(f);return false}if("offline"===f.deststatus){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(f.desterror));return false}if(this.nextId===this.skipId){this.owner.goNext(this.nextId)}else{this.owner.goNext(this.owner.getStep(this.nextId).nextId)}}});return false}},getParams:function(){var d=this.getForm(),f=function(g){return d.findField(g).getValue()};var e={dest:f("dest"),account:f("account"),pwd:f("pwd"),enc_port:f("sshportcheck")?f("enc_port"):0};if(!this.isSynologyServer()){e.target_type="share";e.transfer_type="rsync";e.repo_name=f("rsync_backup_name");e.module=f("module");if("/"===e.module.charAt(0)){e.remoteshell=true}}return e},activate:function(){var d={rsync_backup_name:this.owner.createRepoDefaultName(a)};this.getForm().setValues(d)},changeView:function(){var d=this.getForm().findField("sshportcheck");if(this.isSynologyServer()){this.getForm().findField("rsync_backup_name").setVisible(false);this.getForm().findField("rsync_backup_name").setDisabled(true);this.getForm().findField("module").setVisible(false);this.getForm().findField("module").setDisabled(true);if(d&&d.getEl()&&3===Ext.getDom(d.getEl()).parentNode.childNodes.length){SYNO.SDS.Utils.AddTip(d.getEl(),_T("netbackup","netbkp_ssh_port_info"))}if(this.nextId===this.skipId){this.nextId=this.continueId}this.owner.getButton("next").setText(_T("common","next"))}else{this.getForm().findField("rsync_backup_name").setVisible(true);this.getForm().findField("rsync_backup_name").setDisabled(false);this.getForm().findField("module").setVisible(true);this.getForm().findField("module").setDisabled(false);if(d&&d.getEl()&&4===Ext.getDom(d.getEl()).parentNode.childNodes.length){Ext.getDom(d.getEl()).parentNode.lastChild.remove(true)}if(this.nextId===this.continueId&&null!==this.nextId&&null===this.owner.getStep(this.nextId).nextId){this.nextId=this.skipId;this.owner.getButton("next").setText(_T("common","commit"))}}},loadOptions:function(){var d=this.getParams();d=Ext.apply({connect_list:[{target_type:"share",transfer_type:"rsync_ds",enc_port:d.enc_port},{target_type:"image",transfer_type:"image_remote"}]},d);delete d.enc_port;this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Storage.Connect.Network",version:1,method:"list",params:d,callback:this.onLoadOptions,scope:this})},onLoadOptions:function(g,d,e){var f=this;f.owner.clearStatusBusy();if(!g){f.owner.reportError(d);return false}if(f.owner.getStep(f.nextId).loadData(d)!==false){f.owner.goNext(f.nextId)}},getModuleStore:function(){if(!this.moduleStore){this.moduleStore=new Ext.data.ArrayStore({fields:["share","status","conflict_repo"]})}return this.moduleStore},getModuleParams:function(){var d=this.getParams();d=Ext.apply({connect_list:[{target_type:d.target_type,transfer_type:d.transfer_type,enc_port:d.enc_port}]},d);delete d.enc_port;delete d.transfer_type;delete d.target_type;delete d.repo_name;delete d.module;return d},needReloadModule:function(){var d=this.getModuleParams();return this.lastQuery!==Ext.encode(d)},loadModuleStore:function(){var d=this.getModuleParams();if(Ext.isEmpty(d.dest,false)||Ext.isEmpty(d.account,false)||Ext.isEmpty(d.connect_list[0].enc_port,false)){return}this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Storage.Connect.Network",version:1,method:"list",params:d,scope:this,callback:function(h,e,f){var g=this.getForm().findField("module");this.owner.clearStatusBusy();if(!h){this.owner.reportError(e);return}this.lastQuery=Ext.encode(d);this.getModuleStore().loadData(e.connect_list[0].list);g.el.focus();g.expand();g.restrictHeight()}})}});Ext.define("SYNO.SDS.Backup.Repository.NetworkCreateStep",{extend:"SYNO.ux.FormPanel",volumeDestChanged:true,shareDestChanged:true,constructor:function(d){var e=Ext.apply({items:[{xtype:"syno_fieldset",title:_T("backup","repo_create_network_headline"),collapsible:false,defaults:{labelWidth:300},items:[]}]},d);this.addVersionBackupFields(e);this.addNetworkBackupFields(e);return this.callParent([e])},addVersionBackupFields:function(d){d.items[0].items.push({xtype:"syno_radio",boxLabel:_T("backup","version_backup"),name:"target_type",itemId:"version_backup",inputValue:"image"},{xtype:"syno_displayfield",value:_T("backup","version_backup_desc"),indent:1},{xtype:"syno_textfield",name:"version_backup_name",indent:1,allowBlank:false,fieldLabel:_T("backup","repo_name"),value:c,maxLength:32,maxlength:32,vtype:"backup_destination"},{xtype:"syno_combobox",indent:1,name:"volume",fieldLabel:_T("volume","volume"),store:this.getVolumeStore(),displayField:"volume",valueField:"volume",allowBlank:false,forceSelection:true,listeners:{beforeselect:function(f,e,g){if(e.get("status")!==0){return false}}},tpl:'<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(values.status === 1 ? String.format(_T("backup", "repo_already_exist") + " [" + Ext.util.Format.htmlEncode(values.conflict_repo) + "]") : Ext.util.Format.htmlEncode(values.volume))]}" class="x-combo-list-item {[values.status === 0 ? "syno-backup-enabled-list-item" : "syno-backup-disabled-list-item"]}">{volume:htmlEncode}</div></tpl>'},{xtype:"syno_displayfield",name:"version_backup_error_message",value:"",style:{color:"red"},hidden:true,indent:1})},addNetworkBackupFields:function(d){d.items[0].items.push({xtype:"syno_radio",boxLabel:_T("backup","network_backup"),name:"target_type",itemId:"network_backup",inputValue:"share"},{xtype:"syno_displayfield",value:_T("backup","network_backup_desc"),indent:1},{xtype:"syno_textfield",indent:1,name:"network_backup_name",allowBlank:false,fieldLabel:_T("backup","repo_name"),value:b,maxLength:32,maxlength:32,vtype:"backup_destination"},{xtype:"syno_combobox",indent:1,name:"share",allowBlank:false,fieldLabel:_T("tree","leaf_sharefolder"),forceSelection:true,store:this.getShareStore(),displayField:"share",valueField:"share",listeners:{beforeselect:function(f,e,g){if(e.get("status")!==0){return false}}},tpl:'<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(values.status === 1 ? String.format(_T("backup", "repo_already_exist") + " [" + Ext.util.Format.htmlEncode(values.conflict_repo) + "]") : Ext.util.Format.htmlEncode(values.share))]}" class="x-combo-list-item {[values.status === 0 ? "syno-backup-enabled-list-item" : "syno-backup-disabled-list-item"]}">{share:htmlEncode}</div></tpl>'},{xtype:"syno_displayfield",name:"network_backup_error_message",value:"",style:{color:"red"},hidden:true,indent:1})},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){var d;d=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"target_type",{image:["version_backup_name","volume"],share:["network_backup_name","share"]})},this,{single:true})},getVolumeStore:function(){if(!this.volumeStore){this.volumeStore=new Ext.data.ArrayStore({fields:["volume","status","conflict_repo"]})}return this.volumeStore},getShareStore:function(){if(!this.shareStore){this.shareStore=new Ext.data.ArrayStore({fields:["share","status","conflict_repo"]})}return this.shareStore},getParams:function(){var f={};var d=this.getForm().findField("target_type").getGroupValue();f=this.getForm().getFieldValues();var e=this.owner.getStep("network_auth").getParams();if("image"===d){f.transfer_type="image_remote";f.target_type="image";f.repo_name=f.version_backup_name;if(Ext.isDefined(this.verify_cert)){f.verify_cert=this.verify_cert}delete f.version_backup_name}else{if("share"===d){f.transfer_type="rsync_ds";f.target_type="share";f.repo_name=f.network_backup_name;delete f.network_backup_name;f.enc_port=e.enc_port}}f.dest=e.dest;f.account=e.account;f.pwd=e.pwd;return f},activate:function(){if(!this.loaded){SYNO.Debug("no available resource")}if(this.getComponent(0).getComponent("version_backup").disabled){this.getForm().findField("version_backup_name").setVisible(false);this.getForm().findField("volume").setVisible(false);this.getForm().findField("version_backup_error_message").setVisible(true)}else{this.getForm().findField("version_backup_name").setVisible(true);this.getForm().findField("volume").setVisible(true);this.getForm().findField("version_backup_error_message").setVisible(false)}if(this.getComponent(0).getComponent("network_backup").disabled){this.getForm().findField("network_backup_name").setVisible(false);this.getForm().findField("share").setVisible(false);this.getForm().findField("network_backup_error_message").setVisible(true)}else{this.getForm().findField("network_backup_name").setVisible(true);this.getForm().findField("share").setVisible(true);this.getForm().findField("network_backup_error_message").setVisible(false)}},getNext:function(){if(!this.getForm().isValid()){return false}var d=this.getForm().findField("target_type").getGroupValue();if(("image"===d&&!this.getComponent(0).getComponent("version_backup").disabled)||("share"===d&&!this.getComponent(0).getComponent("network_backup").disabled)){return this.nextId}this.owner.reportError(_T("backup","repo_network_no_resource"));return false},loadData:function(d){var h=this,f,j={};var e=0;var k=0;var g;h.loaded=true;h.getVolumeStore().removeAll();h.getShareStore().removeAll();if(0===d.connect_list[1].error){h.getVolumeStore().loadData(d.connect_list[1].list);this.verify_cert=d.connect_list[1].verify_cert;this.owner.support_ssl=d.connect_list[1].support_ssl;this.owner.support_rotate=d.connect_list[1].support_rotate}else{e=d.connect_list[1].error}if(0===d.connect_list[0].error){h.getShareStore().loadData(d.connect_list[0].list)}else{k=d.connect_list[0].error}f=h.getVolumeStore().findExact("status",0);if(f!==-1){j.target_type="image";j.volume=h.getVolumeStore().getAt(f).get("volume");h.getComponent(0).getComponent("version_backup").enable()}else{if(e===4440){g=_T("backup","imgbkp_service_no_run")}else{if(e===4441){h.getForm().findField("volume").setValue(_T("service","service_ddns_status_auth_failed"));g=SYNO.SDS.Backup.GetErrorString(e)}else{h.getForm().findField("volume").setValue(_T("netbackup","err_no_volume"));if(0===e){g=String.format(_T("netbackup","err_no_volume")+"<br>"+_T("backup","no_image_volume_reason"))}else{g=SYNO.SDS.Backup.GetErrorString(e)}}}h.getComponent(0).getComponent("version_backup").disable();h.getForm().findField("version_backup_error_message").setValue(g)}f=h.getShareStore().findExact("status",0,false,false);if(f!==-1){j.target_type=j.target_type||"share";j.share=h.getShareStore().getAt(f).get("share");h.getComponent(0).getComponent("network_backup").enable()}else{if(k===4452||k===4480){g=_T("netbackup","netbkp_service_no_run")}else{if(k===4482){h.getForm().findField("share").setValue(_T("service","service_ddns_status_auth_failed"));g=SYNO.SDS.Backup.GetErrorString(k)}else{h.getForm().findField("share").setValue(_T("netbackup","err_no_share"));if(0===k){if(0===h.getShareStore().getCount()){g=_T("netbackup","err_no_share")}else{g=_T("backup","all_shares_in_repo_list")}}else{g=SYNO.SDS.Backup.GetErrorString(k)}}}h.getComponent(0).getComponent("network_backup").disable();h.getForm().findField("network_backup_error_message").setValue(g)}j.version_backup_name=h.owner.createRepoDefaultName(c);j.network_backup_name=h.owner.createRepoDefaultName(b);h.getForm().setValues(j);return true}})}());Ext.ns("SYNO.SDS.Backup");SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH=250;SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH=230;SYNO.SDS.Backup.PartSizeList=[["8",8],["16",16],["32",32],["64",64],["128",128],["256",256],["512",512]];SYNO.SDS.Backup.PollingIntervalMs=3000;SYNO.SDS.Backup.BKPTASK_LOCLUN="loclunbkp";SYNO.SDS.Backup.BKPTASK_NETLUN="netlunbkp";SYNO.SDS.Backup.BKP_DEST_TYPE_LOCLUN="locallun";SYNO.SDS.Backup.BKP_DEST_TYPE_NETLUN="netlun";SYNO.SDS.Backup.LUNBKP_SYNO_SERVER="lunbkp_synology";SYNO.SDS.Backup.BKPSET_MAX_LEN=32;SYNO.SDS.Backup.SYNO_SCHEDULE_SUN="0";SYNO.SDS.Backup.SYNO_SCHEDULE_MON="1";SYNO.SDS.Backup.SYNO_SCHEDULE_TUE="2";SYNO.SDS.Backup.SYNO_SCHEDULE_WED="3";SYNO.SDS.Backup.SYNO_SCHEDULE_THU="4";SYNO.SDS.Backup.SYNO_SCHEDULE_FRI="5";SYNO.SDS.Backup.SYNO_SCHEDULE_SAT="6";SYNO.SDS.Backup.SYNO_SCHEDULE_EVERYDAY="0,1,2,3,4,5,6";SYNO.SDS.Backup.WeekArray=[[SYNO.SDS.Backup.SYNO_SCHEDULE_SUN,_T("schedule","schedule_sun")],[SYNO.SDS.Backup.SYNO_SCHEDULE_MON,_T("schedule","schedule_mon")],[SYNO.SDS.Backup.SYNO_SCHEDULE_TUE,_T("schedule","schedule_tue")],[SYNO.SDS.Backup.SYNO_SCHEDULE_WED,_T("schedule","schedule_wed")],[SYNO.SDS.Backup.SYNO_SCHEDULE_THU,_T("schedule","schedule_thu")],[SYNO.SDS.Backup.SYNO_SCHEDULE_FRI,_T("schedule","schedule_fri")],[SYNO.SDS.Backup.SYNO_SCHEDULE_SAT,_T("schedule","schedule_sat")],[SYNO.SDS.Backup.SYNO_SCHEDULE_EVERYDAY,_T("schedule","schedule_daily")]];SYNO.SDS.Backup.AppIconPath="'/webapi/entry.cgi?api=SYNO.Backup.App&amp;method=get_icon&amp;version=1&amp;app_name=&quot;{id:htmlEncode}&quot;&amp;app_version=&quot;{version:htmlEncode}&quot;'";SYNO.SDS.Backup.GenWeekString=function(c){var a=true;var d="";var b;for(b=0;b<SYNO.SDS.Backup.WeekArray.length;b++){if(0<=c.search(SYNO.SDS.Backup.WeekArray[b][0])){if(false===a){d+=","}else{a=false}d+=SYNO.SDS.Backup.WeekArray[b][1]}}return d};SYNO.SDS.Backup.DateScheduleToString=function(d){var b="";var c=d.week_name;b+=_T("schedule","schedule_date")+": ";if(0===d.date_type){if(c){if("0,1,2,3,4,5,6"===c){b+=_T("schedule","schedule_daily")}else{if("1,2,3,4,5"===c){b+=_T("schedule","schedule_weekdays")}else{if("0,6"===c){b+=_T("schedule","schedule_weekend")}else{b+=SYNO.SDS.Backup.GenWeekString(c)}}}}}else{if(d.date.getMonth){b+=d.date.format("Y/m/d")}else{if(d.date.search("-")!==-1){var a=d.date.replace("-","/");b+=a.replace("-","/").slice(0,10)}else{b+=d.date}}b+=" ";if(1===d.repeat){b+=_T("schedule","repeat_monthly")}else{if(2===d.repeat){b+=_T("schedule","repeat_yearly")}else{b+=_T("schedule","no_repeat")}}}return b};SYNO.SDS.Backup.TimeScheduleToString=function(b){var a="";a+=_T("schedule","schedule_time")+": ";if(0===b.repeat_hour){a+=String.leftPad(String(b.hour),2,"0")+":"+String.leftPad(String(b.min),2,"0")}else{a+=String.leftPad(String(b.hour),2,"0")+":"+String.leftPad(String(b.min),2,"0")+" ~ "+String.leftPad(String(b.last_work_hour),2,"0")+":"+String.leftPad(String(b.min),2,"0");a+=" "+_T("schedule","schedule_every_each")+" "+b.repeat_hour+" "+_T("schedule","schedule_hour")}return a};SYNO.SDS.Backup.RenderDestStatus=function(c,b){var a;switch(c){case"int_ok":a=_T("usbbackup","usbbkp_online");break;case"normal":a=_T("usbbackup","usbbkp_online");break;case"formatting":a='<font class="blue-status">'+_T("usbbackup","usbbkp_format")+"</font>";break;case"int_fail":a='<font class="red-status">'+_T("system","none_opt")+"</font>";break;case"ext_fail":a='<font class="red-status">'+_T("usbbackup","usbbkp_offline")+"</font>";break;case"usbcopy":a=_T("usb","usb_st_backingup");break;case"hddfail":a='<font class="red-status">'+_T("usb","usb_st_fail")+"</font>";break;case"connected":a=_T("netbackup","netbkp_connect");break;case"disconnected":a='<font class="red-status">'+_T("netbackup","netbkp_disconnect")+"</font>";break;case"permission_denied":a='<font class="red-status">'+_T("backup","backup_dest_status")+"</font>";break;case"syncing":a='<font class="blue-status">'+_T("netbackup","netbkp_backuping")+"</font>";break;case"waiting":a=_T("netbackup","netbkp_wait_sync");break;case"unknow":a=_T("backup","getting_dest_status");break;case"rcvrsys":a=_T("backup","backup_sys_rcvr");break;case"init":a=_T("usbbackup","usbbkp_init");break;default:a='<font class="red-status">'+_T("usbbackup","usbbkp_offline")+"</font>";break}if(null!==b){b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"'}return a};SYNO.SDS.Backup.RenderBkpStatus=function(c,b){var a;switch(c){case"checksize":a=_T("localbkp","localbkp_check_dest_size");break;case"fullbkp":a='<font class="blue-status">'+_T("localbkp","localbkp_full_bkp")+"</font>";break;case"incrbkp":a='<font class="blue-status">'+_T("localbkp","localbkp_incr_bkp")+"</font>";break;case"syncbkp":a='<font class="blue-status">'+_T("backup","backup_sync_bkp")+"</font>";break;case"init":a=_T("usbbackup","usbbkp_init");break;case"waiting":a=_T("localbkp","localbkp_wait_sync");break;case"syncing":a='<font class="blue-status">'+_T("netbackup","netbkp_backuping")+"</font>";break;case"localerr":a='<font class="red-status">'+_T("usbbackup","usbbkp_err_error")+"</font>";break;case"success":a=_T("usbbackup","usbbkp_succeed");break;case"cancel":a='<font class="red-status">'+_T("usbbackup","usbbkp_err_cancel")+"</font>";break;case"none":a=_T("localbkp","localbkp_not_bkp");break;case"neterr":a='<font class="red-status">'+_T("netbackup","netbkp_status_fail")+"</font>";break;case"do_cancel":a='<font class="blue-status">'+_T("backup","backup_do_cancel")+"</font>";break;case"app":a='<font class="blue-status">'+_T("backup","bkpstatus_app")+"</font>";break;case"config":a='<font class="blue-status">'+_T("backup","bkpstatus_sys")+"</font>";break;default:if(0===c.indexOf("fullbkp")){a=c.replace("fullbkp",'<font class="blue-status">'+_T("localbkp","localbkp_full_bkp")+"</font>")}else{if(0===c.indexOf("incrbkp")){a=c.replace("incrbkp",'<font class="blue-status">'+_T("localbkp","localbkp_incr_bkp")+"</font>")}else{if(0===c.indexOf("syncbkp")){a=c.replace("syncbkp",'<font class="blue-status">'+_T("backup","backup_sync_bkp")+"</font>")}else{if(0===c.indexOf("syncing")){a=c.replace("syncing",'<font class="blue-status">'+_T("netbackup","netbkp_backuping")+"</font>")}else{if(0===c.indexOf("metadata")){a=c.replace("metadata",'<font class="blue-status">'+_T("backup","backup_metadata_bkp")+"</font>")}else{a=c}}}}}break}if(null!==b){b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"'}return a};SYNO.SDS.Backup.createTimeItemStore=function(e){var a=[];var c={hour:24,min:60,sec:60};if(e in c){for(var d=0;d<c[e];d++){a.push([d,String.leftPad(String(d),2,"0")])}var b=new Ext.data.SimpleStore({id:0,fields:["value","display"],data:a});return b}return null};SYNO.SDS.Backup.getLocalDestType=function(a){var b;if(0===a.indexOf("USB Disk")||0===a.indexOf("usbshare")){b="usb"}else{if(0===a.indexOf("usbbackup")){b="usbbkp"}else{if(0===a.indexOf("External SATA Disk")||0===a.indexOf("satashare")){b="esata"}else{if(0===a.indexOf("satabackup")){b="esatabkp"}else{b="internal"}}}}return b};SYNO.SDS.Backup.getFakePass=function(){var a;var b="";for(a=0;a<8;a++){b+=String.fromCharCode(65283)}return b};SYNO.SDS.Backup.GetServerName=function(c){var b=c;var a=c.indexOf("(");if(a>0){b=c.substring(0,a)}if(Ext.form.VTypes.netbiosName(b)||(Ext.form.VTypes.hostname(b)&&!Ext.form.VTypes.looseip(b))){return b}return""};SYNO.SDS.Backup.GetServerIP=function(b){var c=b;var a=b.indexOf("(");var d=b.indexOf(")");if(a>0&&a<d&&d===(b.length-1)){c=b.substring(a+1,d)}if(Ext.form.VTypes.looseip(c)){return c}return""};SYNO.SDS.Backup.convertAppError=function(b,a){if(-1===b){return a}switch(b){case 7:return _T("backup","app_err_install");case 9:return _T("pkgmgr","pkgmgr_pkg_stop_failed");case 10:return _T("pkgmgr","pkgmgr_pkg_start_failed");case 12:return _T("backup","err_connect");case 13:return _T("common","commfail");case 15:return _T("backup","err_server_name");case 16:return _T("backup","imgbkp_account_pass_fail");case 17:return _T("netbackup","err_share_perm_denied");case 18:return _T("netbackup","err_ip_denied");case 19:return _T("backup","err_serivce_disable");case 20:return _T("backup","local_no_space");case 21:return _T("backup","app_err_no_volume");case 25:return _T("backup","app_err_no_version_found");case 26:return _T("usbbackup","usbbkp_cancel");case 27:return _T("pkgmgr","broken_desc");default:return _T("backup","restore_fail")}};SYNO.SDS.Backup.getTreeNodeByCaseId=function(a,d){var b=d.toUpperCase();for(var c in a.nodeHash){if(c.toUpperCase()===b){return a.nodeHash[c]}}};SYNO.SDS.Backup.setAppGridDependency=function(b,c,a){Ext.each(b.getStore().data.items,function(e){if(a){e.set("disabled",false)}if(!e.get("depend")||!e.get("depend").share_list){return}var d=false;Ext.each(e.get("depend").share_list,function(g){var f=SYNO.SDS.Backup.getTreeNodeByCaseId(c,"/"+g);if(!f||!(f.attributes)||(f.attributes.disabled)||(f.attributes.shareConflict&&f.attributes.shareConflict.startsWith("err_"))){d=true;return false}if(undefined===f.dependAppRows){f.dependAppRows=[]}f.isBackup=a;f.dependGrid=b;f.dependAppRows.push(e)});if(d){e.set("disabled",true);e.set("checked",false)}})};SYNO.SDS.Backup.setAppDependency=function(c){var d=function(f,e){if(!e){Ext.each(f.attributes.appNodes,function(g){g.getUI().setCheckValue(false)});if(true===f.attributes.is_app){Ext.each(f.attributes.dataNodes,function(g){if(g.getUI().isDisabled()){g.disabled=false;g.getUI().setCheckValue(false);g.disabled=true;g.getUI().syncCheckCssClass()}})}}else{if(true===f.attributes.is_app){Ext.each(f.attributes.dataNodes,function(g){if(g.getUI().isDisabled()){g.disabled=false;g.getUI().setCheckValue(true);g.disabled=true;g.getUI().syncCheckCssClass()}else{g.getUI().setCheckValue(true)}})}}if(true===f.attributes.is_app){f.expand(true)}};var a=function(e,g,i,f){var h=g.getUI()||{};if(!Ext.isFunction(h.getCheckValue)||!(h.checkbox)||undefined===i.attributes.checked){return}if(true===g.attributes.is_app){if(true===g.disabled){i.disable()}if(false===h.getCheckValue()&&undefined!==i.attributes.checked){i.attributes.checked=false}SYNO.SDS.Backup.setAppDependency.call(this,i)}else{i.attributes.appNodes=g.attributes.appNodes}i.attributes.dataNodes=g.attributes.dataNodes;i.on("checkchange",d);i.on("append",a)};if(c.attributes.depend){var b=[];Ext.each(c.attributes.depend.shares,function(e){b.push("/"+e)});Ext.each(c.attributes.depend.nodes,function(e){b.push(e)});Ext.each(b,function(e){var f=this.getNodeById(e);if(undefined===f){return true}if(undefined===f.attributes.appNodes){f.attributes.appNodes=[]}f.attributes.appNodes.push(c);f.on("checkchange",d,this);f.on("append",a,this);if(undefined===c.attributes.dataNodes){c.attributes.dataNodes=[]}c.attributes.dataNodes.push(f)},this);c.on("checkChange",d,this);c.on("append",a,this)}};SYNO.SDS.Backup.onLoadSynologyServer=function(c,a,b){b.setStatusBusy({text:_T("netbackup","netbkp_wait_server")});Ext.Ajax.request({url:SYNO.SDS.Backup.CGI_LUNBACKUP,params:{action:"netbkphost"},callback:function(g,h,f){b.clearStatusBusy();if(h&&f.responseText){var d=Ext.util.JSON.decode(f.responseText);for(var e=0;e<d.total;e++){a.push([d.items[e].ip,d.items[e].host])}if(!c.isExpanded()){c.el.focus()}c.getStore().loadData(a,false)}}})};SYNO.SDS.Backup.onTestSvrConnection=function(c,b,a){b.owner.setStatusBusy({text:_T("netbackup","netbkp_connection_testing")});Ext.Ajax.request({url:SYNO.SDS.Backup.CGI_LUNBACKUP,params:Ext.util.JSON.encode(c),callback:function(g,h,f){var e=c.title?c.title:_T("tree","leaf_backup");if(a){a.call(b,g,h,f)}else{b.owner.clearStatusBusy();if(h&&f.responseText!==null){var d=Ext.util.JSON.decode(f.responseText);if(d.success){b.owner.getMsgBox().alert(e,_T("netbackup","netbkp_connection_testing_success"));return}else{b.owner.getMsgBox().alert(e,_T(d.errinfo.sec,d.errinfo.key))}}else{b.owner.getMsgBox().alert(e,_T("netbackup","netbkp_connection_testing_fail"))}}}})};SYNO.SDS.Backup.PartSizeList=[["8",8],["16",16],["32",32],["64",64],["128",128],["256",256],["512",512]];SYNO.SDS.Backup.STORAGE_SYNOBKP="synobkp";SYNO.SDS.Backup.STORAGE_IMAGEBKP="imagebkp";SYNO.SDS.Backup.STORAGE_S3BKP="amazon_s3";SYNO.SDS.Backup.STORAGE_GOOGLE="google_cloud_storage";SYNO.SDS.Backup.LOCATION_LOCAL="local";SYNO.SDS.Backup.LOCATION_REMOTE_DS="remote_ds";SYNO.SDS.Backup.LOCATION_REMOTE_RSYNC="remote_rsync";SYNO.SDS.Backup.LOCATION_AMAZON_S3="amazon_s3";SYNO.SDS.Backup.LOCATION_GOOGLE_CLOUD_STORAGE="google_cloud_storage";SYNO.SDS.Backup.ConverSize=function(d,c){d=d?d:0;c=c?c:0;var f=1024;var a=f*1024;var e=a*1024;var g=e*1024;var b=parseFloat(d);if(isNaN(b)){return d}d=b;if((d>=0)&&(d<f)){return d.toFixed(c)+" B"}else{if((d>=f)&&(d<a)){return(d/f).toFixed(c)+" KB"}else{if((d>=a)&&(d<e)){return(d/a).toFixed(c)+" MB"}else{if((d>=e)&&(d<g)){return(d/e).toFixed(c)+" GB"}else{return(d/g).toFixed(c)+" TB"}}}}};SYNO.SDS.Backup.TASK_TYPE_SYNOBKP_LOCAL=1;SYNO.SDS.Backup.TASK_TYPE_SYNOBKP_NETWORK=2;SYNO.SDS.Backup.TASK_TYPE_SYNOBKP_RSYNC=3;SYNO.SDS.Backup.TASK_TYPE_SYNOBKP_AMAZON_S3=4;SYNO.SDS.Backup.TASK_TYPE_IMAGE_LOCAL=5;SYNO.SDS.Backup.TASK_TYPE_IMAGE_NETWORK=6;SYNO.SDS.Backup.TASK_TYPE_MULTIVERSION_AMAZON_S3=7;SYNO.SDS.Backup.TASK_TYPE_MULTIVERSION_GOOGLE=8;SYNO.SDS.Backup.GetBkpFolders=function(c,a){var b=c.firstChild;do{switch(b.getUI().getCheckValue()){case"gray":if(b.firstChild){SYNO.SDS.Backup.GetBkpFolders(b,a)}break;case true:a.push(b.id);break;default:}b=b.nextSibling}while(b)};Ext.define("SYNO.SDS.Backup.PathBar",{extend:"Ext.util.Observable",constructor:function(a){this.init(a.webfm);this.callParent(arguments);this.addEvents("updatepath")},init:function(a){this.webfm=a;this.tbPanel=new SYNO.SDS.Backup.PathButtonsPanel({cls:"ux-pathtoolbar",webfm:this.webfm});return this},addPathButton:function(f,e,b,c,d,a){return this.tbPanel.addButton(f,e,b,c,d,a,this.webfm)},updatePathButton:function(e,d,b,c,a){return this.tbPanel.updateButton(e,d,b,c,a)},addPathButtons:function(c){var b=Math.max(this.tbPanel.items.length,c.length);var d=c.length-1;for(var a=0;a<b;a++){if(a<this.tbPanel.items.length&&a<c.length){this.updatePathButton(a,c[a].text,c[a].tooltip,c[a].path,a===d)}else{if(a<c.length){this.addPathButton(this.tbPanel.items.length,c[a].text,c[a].tooltip,c[a].path,a===0,a===d)}else{this.removePathButtons(a,b);break}}}this.tbPanel.setActiveButton(this.tbPanel.items[this.tbPanel.items.length-1]);this.fireEvent("updatepath",this)},removePathButtons:function(b,a){this.tbPanel.removeButtons(b,a)},setWidth:function(a){this.tbPanel.setWidth(a)}});Ext.define("SYNO.SDS.Backup.PathButtonsPanel",{extend:"Ext.BoxComponent",activeButton:null,enableScroll:true,scrollRepeatInterval:400,scrollDuration:0.35,buttonWidthSet:false,allowDomMove:false,onRender:function(){this.callParent(arguments);this.mon(this,"resize",this.delegateUpdates);this.items=[];this.selMenu=new SYNO.ux.Menu({items:[],listeners:{click:{fn:function(b,a){if(a.path){}},scope:this}}});this.stripWrap=Ext.get(this.el).createChild({cls:"ux-pathbuttons-strip-wrap",cn:{tag:"ul",cls:"ux-pathbuttons-strip"}});this.stripSpacer=Ext.get(this.el).createChild({cls:"ux-pathbuttons-strip-spacer"});this.strip=new Ext.Element(this.stripWrap.dom.firstChild);this.edge=this.strip.createChild({tag:"li",cls:"ux-pathbuttons-edge"});this.strip.createChild({cls:"x-clear"})},addButton:function(d,f,i,h,c,g,b){var e=this.strip.createChild({tag:"li"},this.edge);var a=new SYNO.SDS.Backup.PathBar.PathButton(e,d,f,i,h,c,g,b);this.items.push(a);if(!this.buttonWidthSet){this.lastButtonWidth=a.container.getWidth()}this.addManagedComponent(a);return a},updateButton:function(f,e,c,d,b){var a=this.items[f];a.updateButton(e,c,d,b)},removeButtons:function(f,e){var a;var c;for(var b=f;b<e;b++){c=this.items[b];a=document.getElementById(c.container.id);this.removeManagedComponent(c);c.destroy();a.parentNode.removeChild(a)}var d=[];for(b=0;b<f;b++){d.push(this.items[b])}this.items=d;this.delegateUpdates()},setActiveButton:function(a){this.activeButton=a;this.delegateUpdates()},delegateUpdates:function(){if(this.enableScroll&&this.rendered){this.autoScroll()}},autoScroll:function(){var f=this.items.length;var c=this.el.dom.clientWidth;var d=this.stripWrap;var b=d.dom.offsetWidth;var g=this.getScrollPos();var a=this.edge.getOffsetsTo(this.stripWrap)[0]+g;if(!this.enableScroll||f<1||b<20){return}d.setWidth(c);var e=(this.items.length===1);if(a<=c||e){d.dom.scrollLeft=0;if(this.showSelBtn){this.showSelBtn=false;this.el.removeClass("x-pathbuttons-selection-btn-displayed");this.menuBtn.hide()}}else{if(!this.showSelBtn){this.el.addClass("x-pathbuttons-selection-btn-displayed")}c-=d.getMargins("lr");d.setWidth(c>20?c:20);if(!this.showSelBtn){if(!this.menuBtn){this.createMenuBtn()}else{this.menuBtn.show()}}this.showSelBtn=true;this.updateScrollandSelMenu()}},createMenuBtn:function(){var b=this.el.dom.offsetHeight;var a=this.el.insertFirst({cls:"ux-pathbuttons-selection-btn"});a.setHeight(b);a.addClassOnOver("ux-pathbuttons-selection-btn-over");a.addClassOnClick("ux-pathbuttons-selection-btn-click");this.leftRepeater=new Ext.util.ClickRepeater(a,{interval:this.scrollRepeatInterval,handler:this.onShowMenu,scope:this});this.menuBtn=a},onShowMenu:function(){var c=this.menuBtn.getXY();var a=-5,b=28;if(this.selMenu.isVisible()){this.selMenu.hide()}else{this.selMenu.showAt([c[0]+a,c[1]+b])}},getScrollPos:function(){return parseInt(this.stripWrap.dom.scrollLeft,10)||0},updateScrollandSelMenu:function(){var c=6+8;var l=this.items.length;var a=l-1;var d=0;var m=this.stripWrap.getWidth();var b;for(var f=a;f>=0;f--){b=this.items[f].el.child(".ux-pathbutton-center");d+=b.getWidth()+c;if(d>m){break}}if(f===a){f-=1}this.selMenu.removeAll();for(var e=0;e<=f;e++){this.selMenu.addItem({path:this.items[e].path,text:this.items[e].text})}var k=this.items[f+1];var g=this.stripWrap.dom.scrollLeft;var h=k.el.getOffsetsTo(this.stripWrap)[0]+g;this.stripWrap.scrollTo("left",h-c)}});SYNO.SDS.Backup.PathBar.PathButton=function(a,e,f,j,i,d,g,c){this.webfm=c;var b=d?this.firstBtnCls:"";var h=g?this.lastBtnCls:"";SYNO.SDS.Backup.PathBar.PathButton.superclass.constructor.call(this,{text:f,itemId:e,renderTo:a,tooltip:j,clickEvent:"mousedown",listeners:{click:{fn:function(){var k=this.getPath();if(k){}},scope:this}},template:new Ext.Template('<table cellspacing="0" class="x-btn '+b+" "+h+' {3}"><tbody><tr>','<td class="ux-pathbutton-left"></td>','<td class="ux-pathbutton-center"><em class="{5} unselectable="on">','<button class="x-btn-text {2}" type="{1}" style="height:18px;">{0}</button>',"</em></td>",'<td class="ux-pathbutton-right"></td>',"</tr></tbody></table>")});this.setPath(i)};Ext.extend(SYNO.SDS.Backup.PathBar.PathButton,Ext.Button,{extend:"Ext.Button",firstBtnCls:"x-first-btn",lastBtnCls:"x-last-btn",setPath:function(a){this.path=a},getPath:function(){return this.path},updateButton:function(d,b,c,a){this.setPath(c);this.setText(d);this.setTooltip(b);if(a){this.addClass(this.lastBtnCls)}else{this.removeClass(this.lastBtnCls)}}});Ext.define("SYNO.SDS.Backup.HostCombobox",{extend:"SYNO.ux.ComboBox",constructor:function(a){Ext.copyTo(this,a,"appWindow,owner");if(!this.appWindow&&this.owner){this.appWindow=this.owner.findAppWindow()}this.callParent([Ext.apply({allowBlank:false,fieldLabel:_T("netbackup","netbkp_set_ip"),emptyText:_T("netbackup","netbkp_input_addr"),editable:true,store:new SYNO.API.Store({api:"SYNO.Backup.Server",version:1,method:"list",appWindow:this.appWindow||false,autoLoad:false,autoDestroy:true,reader:new Ext.data.JsonReader({idProperty:"ip",root:"host_list",fields:["host","ip"]}),listeners:{beforeload:this.onStoreBeforeLoad,load:this.onStoreLoad,exception:this.onStoreLoadException,clear:this.onStoreClear,scope:this}}),validator:function(b){return this.isHostnameValid(b)},valueField:"ip",displayField:"host",triggerAction:"all",mode:"local",tpl:'<tpl for="."><div ext:qtip="{host:htmlEncode}" class="x-combo-list-item">{host:htmlEncode}</div></tpl>'},a)]);this.requestSelfNetInfo()},onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.isStoreLoaded!==true){this.getStore().load()}else{this.callParent(arguments)}},onStoreBeforeLoad:function(){if(this.owner){this.owner.setStatusBusy()}},onStoreLoad:function(){if(this.owner){this.owner.clearStatusBusy()}this.isStoreLoaded=true;this.el.focus();this.expand();this.restrictHeight()},onStoreLoadException:function(c,d,e,a,f,b){if(this.owner){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(f.code),function(){this.owner.close()},this)}else{alert(SYNO.SDS.Backup.GetErrorString(f.code))}delete this.isStoreLoaded},onStoreClear:function(b,a){delete this.isStoreLoaded},getHostName:function(){var c=this.getRawValue();var b=c;var a=c.indexOf("(");if(a>0){b=c.substring(0,a)}if(Ext.form.VTypes.netbiosName(b)||(Ext.form.VTypes.hostname(b)&&!Ext.form.VTypes.looseip(b))){return b}return""},getHostIp:function(){var b=this.getRawValue();var c=b;var a=b.indexOf("(");var d=b.indexOf(")");if(a>0&&a<d&&d===(b.length-1)){c=b.substring(a+1,d)}if(Ext.form.VTypes.looseip(c)){return c}return""},requestSelfNetInfo:function(){this.owner.sendWebAPI({api:"SYNO.Core.System",method:"info",version:1,params:{type:"network"},callback:this.onQueryHostnameDone,scope:this})},onQueryHostnameDone:function(d,c,b){var a=[];if(!d||c===undefined||!Ext.isArray(c.nif)){return}this.selfHostName=c.hostname.toLowerCase();Ext.each(c.nif,function(e){a.push(e.addr);if(Ext.isArray(e.ipv6)){Ext.each(e.ipv6,function(f){a.push(f.addr)})}});this.selfIPs=a},isHostnameValid:function(c){var b=c.toLowerCase();var d=/^(localhost|127\.0\.0\.1|::1|0:0:0:0:0:0:0:1)$/;var a=this.selfIPs;if(b.match(d)||(b===this.selfHostName)||(a&&-1!==a.indexOf(b))){return _T("netbackup","netbkp_sync_self")}return true}});SYNO.SDS.Backup.converLanString=(function(){var a=/^[.a-zA-Z0-9_-]+(:[a-zA-Z0-9_-]+){1,2}$/;return function(c){var b;if(a.test(c)){b=c.split(":");if(b.length===2){return _T(b[0],b[1])}else{return _TT(b[0],b[1],b[2])}}else{return""}}})();Ext.namespace("SYNO.SDS.Backup.Util");SYNO.SDS.Backup.Util.htmlEncodeTip=function(a){var c=Ext.util.Format.htmlEncode(a);var b=Ext.util.Format.htmlEncode(c);return b};SYNO.SDS.Backup.Util.lengthEllipsis=function(b,a,c){return'<span ext:qtip="'+SYNO.SDS.Backup.Util.htmlEncodeTip(b)+'">'+Ext.util.Format.ellipsis(Ext.util.Format.htmlEncode(b),a,c)+"</span>"};SYNO.SDS.Backup.Util.widthEllipsis=function(b,a){return'<span ext:qtip="'+SYNO.SDS.Backup.Util.htmlEncodeTip(b)+'" style="overflow: hidden; text-overflow: ellipsis; display: inline-block; white-space: nowrap; width: '+a+'px">'+Ext.util.Format.htmlEncode(b)+"</span>"};SYNO.SDS.Backup.Util.isRecycleBinFolder=function(a){if(!a){return false}var b=a.split("/",7);return(b.length===3&&b[2]==="#recycle")||(b.length===4&&b[1]==="homes"&&b[3]==="#recycle")||(b.length===6&&b[1]==="homes"&&b[5]==="#recycle")};SYNO.SDS.Backup.Util.parseImgTaskDisplay=function(d){var b={host_name:"",task_name:""};var c=d.split(": ");if(c[1]){var a=c[1].split("@");b.task_name=a[0];b.host_name=a[1]}return b};SYNO.SDS.Backup.Util.createImgTaskDisplay=function(a){Ext.each(a,function(b){if(b.task_name&&b.host_name){b.display=b.target_id+": "+b.task_name+"@"+b.host_name}else{b.display=b.target_id}})};SYNO.SDS.Backup.Util.comboboxLoadData=function(e,c,a,d){var b=[];Ext.each(c,function(f){if(Ext.isDefined(a)&&Ext.isDefined(d)){b.push([f[a],f[d]])}else{if(Ext.isDefined(a)){b.push([f[a]])}else{b.push([f])}}});e.getStore().loadData(b,false);if(b.length>0){e.setValue(b[0][0]);return true}else{e.setValue("");return false}};Ext.ns("SYNO.SDS.Backup.Addon");SYNO.SDS.Backup.Addon.getList=function(){return[{id:"aws_s3"},{id:"azure_blob"},{id:"hicloud_s3"},{id:"sfr_s3"}]};SYNO.SDS.Backup.Addon.GetSymbol=function(b,a){if(!SYNO.SDS.Backup.Addon[b]){return undefined}if(!SYNO.SDS.Backup.Addon[b].Factory){return undefined}return SYNO.SDS.Backup.Addon[b].Factory(a)};SYNO.SDS.Backup.Addon.GetStr=function(b,c,a){var d;if(!SYNO.SDS.Backup.Addon[b]){return""}if(!SYNO.SDS.Backup.Addon[b].GetStr){return""}d=SYNO.SDS.Backup.Addon[b].GetStr(c,a);if(!d||d===""){return""}return d};SYNO.SDS.Backup.Repository.CreateSteps=function(b,g,e){var f=[];var d={};var a=[];var h=function(n,k){var m=n+"_repo";var l=SYNO.SDS.Backup.Addon.GetSymbol(n,"Repository.CreateStep");if(!l){return undefined}return new l({owner:k,itemId:m,nextId:"backup_task"===g?e:null})};var c=function(k,l,m){k.push({xtype:"syno_radio",boxLabel:SYNO.SDS.Backup.Addon.GetStr(l,"addon","repo_wizard_name"),name:"mode",inputValue:l,checked:m});k.push({xtype:"syno_displayfield",indent:1,value:SYNO.SDS.Backup.Addon.GetStr(l,"addon","repo_wizard_desc")})};var j=function(l,m,k){var o=true;var n=SYNO.SDS.Backup.Addon.getList();Ext.each(n,function(q){var p=h(q.id,b);if(p){l.push(p);m[q.id]=q.id+"_repo";c(k,q.id,o);o=false}})};j(f,d,a);var i=[new SYNO.SDS.Backup.RepoTypePanel({owner:b,itemId:"repo_type",nextId:{local:"local_repo",network:"network_auth",cloud:"repo_cloud_type",existing:"source_repo"}}),new SYNO.SDS.Backup.RepoCloudTypePanel({itemId:"repo_cloud_type",nextId:d,addon_fields:a}),new SYNO.SDS.Backup.Repository.LocalCreateStep({owner:b,itemId:"local_repo",nextId:"backup_task"===g?e:null}),new SYNO.SDS.Backup.Repository.NetworkAuthStep({owner:b,itemId:"network_auth",nextId:"network_repo",continueId:"network_repo",skipId:null}),new SYNO.SDS.Backup.Repository.NetworkCreateStep({owner:b,itemId:"network_repo",nextId:"backup_task"===g?e:null})];if("backup_dest"===g){i.push(new SYNO.SDS.Backup.Repository.PrivilegeCreateStep({owner:b,itemId:"repo_privilege",nextId:null}))}i=i.concat(f);return i};SYNO.SDS.Backup.Repository.CreateRepo=function(b,d,a){if(!b.isRepoNameValid(d.repo_name)){b.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","repo_name_duplicate"));return false}var c={};Ext.apply(c,d);c.name=d.repo_name;b.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"create",params:c,callback:a,scope:b})};Ext.define("SYNO.SDS.Backup.FormPanel",{extend:"SYNO.ux.FormPanel",initEvents:function(){this.callParent(arguments);this.initFieldGroup()},initFieldGroup:function(){var a={},b={};this.getForm().items.each(function(c){if(c instanceof SYNO.ux.Radio&&Ext.isArray(c.groupFields)){a[c.name]=a[c.name]||{};a[c.name][c.inputValue]=c.groupFields}if(c instanceof SYNO.ux.Checkbox&&Ext.isObject(c.groupFields)){b[c.name]=[];b[c.name][0]=c.groupFields.enable;b[c.name][1]=c.groupFields.disable}});this.mon(this,"afterlayout",function(){var c;Ext.iterate(a,function(e,d){c=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),e,d)},this);Ext.iterate(b,function(d,e){c=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),d,e[0],e[1])},this)},this,{single:true})}});Ext.define("SYNO.SDS.Backup.Rotation.Previewer",{extend:"SYNO.ux.Panel",initComponent:function(){this.callParent(arguments);this.add(new Ext.Container({html:_T("backup","rotate_retention_description"),cls:"hint"}));this.doLayout()},updatePreviewer:function(b,d){this.removeAll();this.unmask();var r;var p=this.getWidth();if(!d.enable_rotate||!b.schedule_enable||1>d.rotate_condition[1]||(0===b.repeat&&!b.week_name)){var c=new Ext.Container({cls:"timeline-background",width:640});for(r=0;r<62;++r){c.add(new Ext.Container({cls:"block"}))}this.add(c);this.doLayout();if(!d.enable_rotate||1>d.rotate_condition[1]){this.mask(_T("backup","not_available"))}else{if(!b.schedule_enable||(0===b.repeat&&!b.week_name)){this.mask(_T("backup","rotate_retention_no_schedule"))}}return false}var t=this.getPreviewArray(b,d);var q=t[0];var g=t[1];var v=0;var e=-1;var l=null;for(r=0;r<62;++r){if(0<g[r]){e=r}}v=e+1;var n=(p-2*15)/(v+2-3);if(1===v){n=2*p}var m=n*(v+2);var u=new Ext.Container({cls:"timeline-background",width:m,x:(-1.5)*n+15});var j=new Ext.Container({cls:"timeline-wrapper",width:m,x:(-1.5)*n+15});var h=new Ext.Container({cls:"timeline-weekline",width:m,x:(-1.5)*n+15});var a="";if(0===q){a=_T("backup","nearest_backup")}else{if(28>=q){a=String.format(_T("backup","time_before"),q,_T("common","time_days"))}else{if(6*28>=q){a=String.format(_T("backup","time_before"),Math.floor(q/7),_T("common","time_weeks"))}else{a=String.format(_T("backup","time_before"),Math.floor(q/28),_T("backup","time_months"))}}}u.add(new Ext.Container({cls:"block"}));j.add(new Ext.Container({cls:"block"}));h.add(new Ext.Container({cls:"block"}));for(r=0;r<=e;++r){u.add(new Ext.Container({cls:"block"}));if(0===r){l=new Ext.Container({cls:"block pin"})}else{if(-1===g[e-r]){l=new Ext.Container({cls:"block pass"})}else{l=new Ext.Container({cls:"block"})}}if(0===(e-r)%14){var f=(e-r)/7;var o="";if(0<f){o=String.format('<div class="text">'+_T("backup","time_before")+"</div>",f,_T("common","time_weeks"))}h.add(new Ext.Container({cls:"weekline",html:o}))}else{h.add(new Ext.Container({cls:"block"}))}if(0<g[e-r]){var s=String.format("{0} {1}",g[e-r],_T("backup","version_nums"));var k="";if(0===(e-r)){k=_T("backup","nearest_backup")}else{if(0===r){k=a}else{k=String.format(_T("backup","time_before"),e-r,_T("common","time_days"))}}l.add(new Ext.BoxComponent({cls:"cycle",autoEl:{"ext:qtip":s+", "+k}}))}j.add(l)}u.add(new Ext.Container({cls:"block"}));j.add(new Ext.Container({cls:"block"}));h.add(new Ext.Container({cls:"block"}));this.add(h);this.add(u);this.add(j);this.add(new Ext.Container({html:a,cls:"oldest"}));this.add(new Ext.Container({html:_T("backup","rotate_retention_description"),cls:"hint"}));this.doLayout()},getPreviewArray:function(c,o){if(!c.schedule_enable||!o.enable_rotate){return[0,[]]}var k=Array.apply(null,new Array(62)).map(Number.prototype.valueOf,0);var h=Array.apply(null,new Array(62)).map(Number.prototype.valueOf,0);var m=Array.apply(null,new Array(62)).map(Number.prototype.valueOf,0);var e=Array.apply(null,new Array(62)).map(Number.prototype.valueOf,0);var l=o.rotate_condition[1];var f=0;var a=0;var g=-1;var n=1;if(0!==c.repeat_hour){n=(c.last_work_hour-c.hour)/c.repeat_hour+1}if(c.week_name){var b=c.week_name.split(",").map(function(i){return 6-parseInt(i,10)}).sort();var d=b[0];b=b.map(function(i){return i-d});h[0]=1;for(f=0;f<62;++f){if(0<=b.indexOf(f%7)){m[f]=1}}for(f=0;f<62;++f){if(0===f%7){e[f]=1}}}else{if(1===c.repeat){h[0]=1;m[0]=1;m[27]=1;m[55]=1;e[0]=1;e[27]=1;e[55]=1}else{if(2===c.repeat){h[0]=1;m[0]=1;e[0]=1}}}if(0<o.rotate_action.length){for(f=0;f<1;++f){if(0>=l){break}if(1===h[f]&&n>k[f]){a=Math.min(l,n-k[f]);l-=a;k[f]+=a}}for(f=0;f<28;++f){if(0>=l){break}if(1===m[f]&&1>k[f]){a=Math.min(l,1-k[f]);l-=a;k[f]+=a}}for(f=0;f<62;++f){if(0>=l){break}if(1===e[f]&&1>k[f]){a=Math.min(l,1-k[f]);l-=a;k[f]+=a}}}else{for(f=0;f<62;++f){if(0>=l){break}if(1===m[f]&&n>k[f]){a=Math.min(l,n-k[f]);l-=a;k[f]+=a}}}if(0<l){var j=0;for(f=49;f<56;++f){j+=k[f]}for(f=57;f<62;++f){l+=k[f]}g=56+(l/Math.max(j,1))*7;if(0<o.rotate_action.length){k[61]=1}else{if(0===l%n){k[61]=n}else{k[61]=l%n}}k[60]=0;k[59]=-1}else{for(f=61;f>=0;--f){if(k[f]>0){g=f;break}}}return[g,k]},mask:function(a){this.el.mask(a,"syno-ux-grid-mask-info")},unmask:function(){this.el.unmask()}});Ext.define("SYNO.SDS.Backup.TaskParamPanel",{extend:"SYNO.SDS.Backup.FormPanel",schedGroup:false,constructor:function(a){if(a.owner.configWizard){this.configCreateModeSchedule(a.items[0].items)}var b=this.callParent([a]);this.choocedType="";this.mon(this,"activate",function(){var g=this.getForm().findField("backup_meta");var f=this.getForm().findField("backup_thumb");var i=this.getForm().findField("incrbkp_enable");var e=this.getForm().findField("dest_auto_unmount");var d=this.getForm().findField("backup_rotation");var c=this.getForm().items.filter("name","backup_rotation_action").get(1);if(g&&g.getEl()){SYNO.SDS.Utils.AddTip(g.getEl(),_T("backup","backup_metadata_info"))}if(f&&f.getEl()){SYNO.SDS.Utils.AddTip(f.getEl(),_T("backup","backup_synoea_info"))}if(i&&i.getEl()){SYNO.SDS.Utils.AddTip(i.getEl(),_T("backup","incrbkp_desc"))}if(e&&e.getEl()){SYNO.SDS.Utils.AddTip(e.getEl(),_T("backup","support_auto_unmount_dest_tip"))}if(d&&d.getEl()){SYNO.SDS.Utils.AddTip(d.getEl(),_T("backup","rotate_enable_hint"))}if(c&&c.getEl()){var h=_T("backup","rotate_action_smart_recycle_description")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_hourly")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_hourly_hint")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_daily")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_daily_hint")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_weekly")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_weekly_hint")+"<br/>";SYNO.SDS.Utils.AddTip(c.getEl(),h)}},this,{single:true});return b},activate:function(){if(!this.schedGroup){var a;a=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"schedule_enable",["basic_weekday","hour","minute"]);this.setSchedDefault();this.schedGroup=true}this.setDefaultTaskName()},setDefaultTaskName:function(){var c=this.owner.getRepoInfo();var e={"share:local":"Local Backup Set","image:image_local":"Archiving Backup Set","share:rsync_ds":"Network Backup Set","share:rsync":"Rsync Backup Set","image:image_remote":"Remote Archiving Backup Set","cloud:aws_s3":"S3 Backup Set","cloud:mv_aws_s3":"Multi-Version S3 Backup Set"};var b=c.target_type+":"+c.transfer_type;if(this.getForm().getValues().task_name&&this.choosedType===b){return}this.choosedType=b;var d="My Backup Set ";if(c.target_type==="cloud"){var a=SYNO.SDS.Backup.Addon.GetStr(c.transfer_type,"addon","task_name_prefix");if(a){d=a}}else{if(b in e){d=e[b]}}this.getForm().setValues({task_name:this.owner.createTaskDefaultName(d)})},configCreateModeSchedule:function(a){a.push({xtype:"syno_checkbox",boxLabel:_T("netbackup","netbkp_set_schedule"),name:"schedule_enable"},{xtype:"syno_schedulefield",indent:1,fieldLabel:_T("schedule","run_on_days"),name:"basic_weekday",allowBlank:false,editable:false,width:151},{xtype:"syno_compositefield",fieldLabel:_T("schedule","run_time_first"),indent:1,items:[{xtype:"syno_combobox",store:SYNO.SDS.Backup.createTimeItemStore("hour"),displayField:"display",name:"hour",valueField:"value",triggerAction:"all",mode:"local",width:70,editable:false},{xtype:"syno_displayfield",value:":",width:2},{xtype:"syno_combobox",store:SYNO.SDS.Backup.createTimeItemStore("min"),displayField:"display",name:"minute",valueField:"value",triggerAction:"all",width:70,mode:"local",editable:false}]})},setSchedDefault:function(){var a={};a.schedule_type="basic";a.basic_weekday="1";a.hour=0;a.minute=0;this.getForm().loadRecord({data:a})},getScheduleParams:function(){var a=this.getForm(),b=function(c){return a.findField(c).getValue()};if(this.owner.configWizard){return{schedule_enable:b("schedule_enable"),hour:b("hour"),min:b("minute"),date_type:0,repeat:0,repeat_hour:0,last_work_hour:b("hour"),week_name:String(b("basic_weekday"))}}else{return{schedule_enable:b("schedule_enable")}}},getNext:function(){if(!this.getForm().isValid()){return false}var a=this.getParams();if(!this.owner.isTaskNameValid(a.task_name)){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("localbkp","localbkp_bkpset_exist"));return false}return this.nextId},getParams:function(){var f={};var a=this.getForm().getFieldValues();var e=this.getForm().findField("bandwidthcheck");var b=this.getForm().findField("part_size");var c=this.getForm().findField("version_mode");f.task_name=a.task_name;delete a.task_name;f.schedule=this.getScheduleParams();delete a.schedule_enable;delete a.basic_weekday;a.delete_on_target=!a.incrbkp_enable;delete a.incrbkp_enable;delete a.incrbkp_desc;if(undefined===a.trans_encrypt){var d=this.getForm().findField("trans_encrypt");if(d){a.trans_encrypt=d.getValue()}}if(e&&true===e.getValue()){a.bw_limit=this.getForm().findField("bw_limit").getValue()}if(b){a.part_size=this.getForm().findField("part_size").getValue()}if(c){var g=this.getForm().items.filter("name","version_mode");if(g.itemAt(0).getValue()===false){a.multi_version_enable=true}}delete a.version_mode;f.backup_params=a;return f},getEditParams:function(){var f={};var a=this.getForm().getFieldValues();var d=this.getForm().findField("bandwidthcheck");var c=this.getForm().findField("part_size");f.name=a.task_name;delete a.task_name;delete a.schedule_enable;a.delete_on_target=!a.incrbkp_enable;delete a.incrbkp_enable;delete a.incrbkp_desc;if(d){if(true===d.getValue()){a.bw_limit=this.getForm().findField("bw_limit").getValue()}else{a.bw_limit=0}}if(c){a.part_size=this.getForm().findField("part_size").getValue()}f.backup_params=a;var b=this.getForm().findField("backup_rotation");var e=this.getForm().items.filter("name","backup_rotation_action").get(0);var g=this.getForm().findField("backup_rotation_condition_max_version");f.rotate_params={};if(b){f.rotate_params.enable_rotate=b.getValue();if(b.getValue()&&e){if(e.getValue()){f.rotate_params.rotate_action=[]}else{f.rotate_params.rotate_action=[[24*60*60,60*60,1],[30*24*60*60,24*60*60,1],[0,7*24*60*60,1]]}}if(b.getValue()&&g){f.rotate_params.rotate_condition=[1,g.getValue()]}}return f}});Ext.define("SYNO.SDS.Backup.SynolocalParamsPanel",{extend:"SYNO.SDS.Backup.TaskParamPanel",constructor:function(a){var b=Ext.apply({labelWidth:300,items:[{xtype:"syno_fieldset",title:a.subTitle,collapsible:false,bwrapStyle:"padding: 8px 8px 0 8px;",items:this.configLocalFields(a)}]},a);return this.callParent([b])},configLocalFields:function(b){var a=[{xtype:"syno_fieldset",labelWidth:150,style:"margin: 0;",bwrapStyle:"padding: 0;",items:[{xtype:"syno_textfield",name:"task_name",fieldLabel:_T("localbkp","localbkp_bkpset_name"),width:270,maxLength:32,value:b.defaultName,allowBlank:false,vtype:"taskname"},{xtype:"syno_textfield",name:"task_dir",fieldLabel:_T("backup","backup_dest_directory"),width:270,maxLength:32,allowBlank:false,vtype:"backup_target"}]},{xtype:"syno_checkbox",name:"incrbkp_enable",boxLabel:_T("backup","incrbkp_enable")},{xtype:"syno_checkbox",name:"backup_meta",boxLabel:_T("backup","backup_metadata_option"),checked:true},{xtype:"syno_checkbox",name:"backup_thumb",boxLabel:_T("backup","backup_synoea_option"),checked:true},{xtype:"syno_checkbox",checked:true,disabled:true,boxLabel:_T("backup","backup_config_option")},{xtype:"syno_numberfield",name:"max_dss_version",indent:"1",fieldLabel:_T("backup","max_version"),allowBlank:false,minValue:1,maxValue:30,value:1,width:50}];if(!_D("usbstation")){a.push({xtype:"syno_checkbox",name:"dest_auto_unmount",boxLabel:_T("backup","support_auto_unmount_dest")||"auto unmount",checked:false})}return a}});Ext.define("SYNO.SDS.Backup.SynonetParamsPanel",{extend:"SYNO.SDS.Backup.TaskParamPanel",constructor:function(a){var b=Ext.apply({labelWidth:300,items:[{xtype:"syno_fieldset",title:a.subTitle,collapsible:false,bwrapStyle:"padding: 8px 8px 0 8px;",items:this.configNetFields(a)}]},a);return this.callParent([b])},configNetFields:function(a){return[{xtype:"syno_fieldset",labelWidth:150,style:"margin: 0;",bwrapStyle:"padding: 0;",items:[{xtype:"syno_textfield",name:"task_name",fieldLabel:_T("localbkp","localbkp_bkpset_name"),width:270,value:a.defaultName,maxLength:32,allowBlank:false,vtype:"taskname"},{xtype:"syno_textfield",name:"task_dir",fieldLabel:_T("backup","backup_dest_directory"),width:270,maxLength:32,allowBlank:false,vtype:"backup_target"}]},{xtype:"syno_checkbox",boxLabel:_T("netbackup","encryption_enable"),name:"trans_encrypt"},{xtype:"syno_checkbox",boxLabel:_T("netbackup","compression_enable"),name:"trans_compress"},{xtype:"syno_checkbox",boxLabel:_T("backup","blockbkp_enable"),name:"trans_delta"},{xtype:"syno_checkbox",boxLabel:_T("backup","incrbkp_enable"),name:"incrbkp_enable"},{xtype:"syno_checkbox",name:"backup_meta",boxLabel:_T("backup","backup_metadata_option"),checked:true},{xtype:"syno_checkbox",name:"backup_thumb",boxLabel:_T("backup","backup_synoea_option"),checked:true},{xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_checkbox",name:"bandwidthcheck",boxLabel:_T("backup","limit_the_bandwidth"),scope:this,handler:function(c,b){if(b){this.getForm().findField("bw_limit").enable()}else{this.getForm().findField("bw_limit").disable()}}},{xtype:"syno_numberfield",disabled:true,name:"bw_limit",allowBlank:false,width:100,minValue:1,maxValue:2147483647},{xtype:"syno_displayfield",value:"KB/s"}]},{xtype:"syno_checkbox",checked:true,disabled:true,boxLabel:_T("backup","backup_config_option")},{xtype:"syno_numberfield",name:"max_dss_version",indent:"1",fieldLabel:_T("backup","max_version"),allowBlank:false,minValue:1,maxValue:30,value:1,width:50}]},getParams:function(){var a=this.getForm(),b=function(d){return a.findField(d).getValue()};var c=this.callParent(arguments);if(b("bandwidthcheck")){c.backup_params.bw_limit=b("bw_limit")}return c},activate:function(){this.callParent(arguments);var a=this.owner.getRepoInfo();if(a.remoteshell){this.getForm().findField("trans_encrypt").setValue(true);this.getForm().findField("trans_encrypt").setDisabled(true)}}});Ext.define("SYNO.SDS.Backup.ImageParamsPanel",{extend:"SYNO.SDS.Backup.TaskParamPanel",constructor:function(a){var c=[];c=c.concat(this.configImageFields(a));if(a.enableRotate){c=c.concat(this.configRotationFields(a))}var b=[{xtype:"syno_fieldset",title:a.subTitle,collapsible:false,bwrapStyle:"padding: 8px 8px 0 8px;",items:c}];if(a.enableRotate&&!Ext.isIE8){this.previewer=new SYNO.SDS.Backup.Rotation.Previewer({cls:"syno-sds-backup-rotationPreviewer"});b.push(this.previewer)}var d=Ext.apply({labelWidth:300,items:b},a);this.activated=false;return this.callParent([d])},initEvents:function(){this.callParent(arguments);if(this.previewer){this.mon(this,"activate",this.onActivate,this)}},configImageFields:function(a){var b=[{xtype:"syno_fieldset",labelWidth:150,style:"margin: 0;",bwrapStyle:"padding: 0;",items:[{xtype:"syno_textfield",name:"task_name",value:a.defaultName,fieldLabel:_T("localbkp","localbkp_bkpset_name"),labelWidth:150,width:270,allowBlank:false,maxLength:32,vtype:"taskname"}]},{xtype:"syno_checkbox",name:"backup_thumb",boxLabel:_T("backup","backup_synoea_option"),checked:true},{xtype:"syno_checkbox",checked:true,disabled:true,boxLabel:_T("backup","backup_config_option")}];return b},configRotationFields:function(a){var b=[{xtype:"syno_checkbox",name:"backup_rotation",groupFields:{enable:["backup_rotation_action","backup_rotation_condition_max_version"]},boxLabel:_T("backup","enable_backup_rotation"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,value:_T("backup","rotate_action_description")},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",inputValue:"rotate_earliest",checked:true,boxLabel:_T("backup","rotate_action_earliest"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",inputValue:"rotate_smart_recycle",boxLabel:_T("backup","rotate_action_smart_recycle"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,value:_T("backup","rotate_condition_description")},{xtype:"syno_numberfield",indent:2,name:"backup_rotation_condition_max_version",fieldLabel:_T("backup","rotate_condition_max_version"),allowBlank:false,width:60,value:256,minValue:1,maxValue:65535,enableKeyEvents:true,listeners:{keyup:this.updatePreviewer,scope:this}}];return b},onActivate:function(){this.activated=true;this.updatePreviewer()},updatePreviewer:function(){if(this.activated&&this.previewer){var a=this.owner.getBkpSchedule();var b=this.getEditParams().rotate_params;this.previewer.updatePreviewer(a,b)}}});Ext.define("SYNO.SDS.Backup.ImageRemoteParamsPanel",{extend:"SYNO.SDS.Backup.TaskParamPanel",constructor:function(a){var c=[];c=c.concat(this.configImageFields(a));if(a.enableRotate){c=c.concat(this.configRotationFields(a))}var b=[{xtype:"syno_fieldset",itemId:"fieldset",title:a.subTitle,collapsible:false,bwrapStyle:"padding: 8px 8px 0 8px;",items:c}];if(a.enableRotate&&!Ext.isIE8){this.previewer=new SYNO.SDS.Backup.Rotation.Previewer({cls:"syno-sds-backup-rotationPreviewer",hidden:true,itemId:"rotate_previewer"});b.push(this.previewer)}var d=Ext.apply({labelWidth:300,items:b},a);this.activated=false;return this.callParent([d])},initEvents:function(){this.callParent(arguments);this.mon(this,"activate",this.onActivate,this);this.mon(this,"show",this.updateEncryptOption,this);this.mon(this,"show",this.updateRotateOption,this)},configImageFields:function(a){var b=[{xtype:"syno_fieldset",labelWidth:150,style:"margin: 0;",bwrapStyle:"padding: 0;",items:[{xtype:"syno_textfield",name:"task_name",value:a.defaultName,fieldLabel:_T("localbkp","localbkp_bkpset_name"),labelWidth:150,width:270,allowBlank:false,maxLength:32,vtype:"taskname"}]},{xtype:"syno_checkbox",name:"backup_thumb",boxLabel:_T("backup","backup_synoea_option"),checked:true},{xtype:"syno_checkbox",checked:true,disabled:true,boxLabel:_T("backup","backup_config_option")},{xtype:"syno_checkbox",name:"trans_encrypt",hidden:true,boxLabel:_T("backup","enable_encrypted_transmission")}];return b},configRotationFields:function(a){var b=[{xtype:"syno_checkbox",name:"backup_rotation",groupFields:{enable:["backup_rotation_action","backup_rotation_condition_max_version"]},boxLabel:_T("backup","enable_backup_rotation"),itemId:"enable_rotate",hidden:true,listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,hidden:true,itemId:"rotate_action_desc",value:_T("backup","rotate_action_description")},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",itemId:"rotate_action_earliest",inputValue:"rotate_earliest",checked:true,hidden:true,boxLabel:_T("backup","rotate_action_earliest"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",itemId:"rotate_action_smart",inputValue:"rotate_smart_recycle",hidden:true,boxLabel:_T("backup","rotate_action_smart_recycle"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,hidden:true,itemId:"rotate_condition_desc",value:_T("backup","rotate_condition_description")},{xtype:"syno_numberfield",indent:2,name:"backup_rotation_condition_max_version",itemId:"rotate_condition_version",fieldLabel:_T("backup","rotate_condition_max_version"),allowBlank:false,width:60,value:256,minValue:1,maxValue:65535,enableKeyEvents:true,hidden:true,listeners:{keyup:this.updatePreviewer,scope:this}}];return b},onActivate:function(){this.activated=true;this.updateEncryptOption();this.updateRotateOption();if(this.previewer){this.updatePreviewer()}},updateEncryptOption:function(){var a=this.getForm().findField("trans_encrypt");if(a){if(this.owner.support_ssl){a.show()}else{a.hide()}}},updateRotateOption:function(){if(!this.owner.support_rotate){this.nextId=null}this.updateFieldsetItem("enable_rotate",this.owner.support_rotate);this.updateFieldsetItem("rotate_action_desc",this.owner.support_rotate);this.updateFieldsetItem("rotate_action_earliest",this.owner.support_rotate);this.updateFieldsetItem("rotate_action_smart",this.owner.support_rotate);this.updateFieldsetItem("rotate_condition_desc",this.owner.support_rotate);this.updateFieldsetItem("rotate_condition_version",this.owner.support_rotate);if(this.previewer){if(this.owner.support_rotate){this.previewer.show()}else{this.previewer.hide()}}},updateFieldsetItem:function(c,a){var b=this.getComponent("fieldset").getComponent(c);if(b){if(a){b.show()}else{b.hide()}}},updatePreviewer:function(){if(this.activated&&this.previewer){var a=this.owner.getBkpSchedule();var b=this.getEditParams().rotate_params;this.previewer.updatePreviewer(a,b)}}});Ext.define("SYNO.SDS.Backup.RotationParamsPanel",{extend:"SYNO.SDS.Backup.FormPanel",constructor:function(a){var b=[{xtype:"syno_fieldset",title:a.subTitle,labelWidth:300,collapsible:false,items:this.configRotationFields(a)}];if(!Ext.isIE8){this.previewer=new SYNO.SDS.Backup.Rotation.Previewer({cls:"syno-sds-backup-rotationPreviewer"});b.push(this.previewer)}var c=Ext.apply({items:[b]},a);return this.callParent([c])},initEvents:function(){this.callParent(arguments);this.mon(this,"activate",function(){var b=this.getForm().findField("backup_rotation");var a=this.getForm().items.filter("name","backup_rotation_action").get(1);if(b&&b.getEl()){SYNO.SDS.Utils.AddTip(b.getEl(),_T("backup","rotate_enable_hint"))}if(a&&a.getEl()){var c=_T("backup","rotate_action_smart_recycle_description")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_hourly")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_hourly_hint")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_daily")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_daily_hint")+"<br/><br/><b>"+_T("backup","rotate_action_smart_recycle_weekly")+"</b><br/>"+_T("backup","rotate_action_smart_recycle_weekly_hint")+"<br/>";SYNO.SDS.Utils.AddTip(a.getEl(),c)}},this,{single:true});if(this.previewer){this.mon(this,"show",this.updatePreviewer,this)}},configRotationFields:function(a){var b=[{xtype:"syno_checkbox",name:"backup_rotation",groupFields:{enable:["backup_rotation_action","backup_rotation_condition_max_version"]},boxLabel:_T("backup","enable_backup_rotation"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,value:_T("backup","rotate_action_description")},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",inputValue:"rotate_earliest",checked:true,boxLabel:_T("backup","rotate_action_earliest"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_radio",indent:2,name:"backup_rotation_action",inputValue:"rotate_smart_recycle",boxLabel:_T("backup","rotate_action_smart_recycle"),listeners:{check:this.updatePreviewer,scope:this}},{xtype:"syno_displayfield",indent:1,value:_T("backup","rotate_condition_description")},{xtype:"syno_numberfield",indent:2,name:"backup_rotation_condition_max_version",fieldLabel:_T("backup","rotate_condition_max_version"),allowBlank:false,width:60,value:256,minValue:1,maxValue:65535,enableKeyEvents:true,listeners:{keyup:this.updatePreviewer,scope:this}}];return b},getParams:function(){var a=this.getForm().findField("backup_rotation");var b=this.getForm().findField("backup_rotation_action");var d=this.getForm().findField("backup_rotation_condition_max_version");var c={};c.rotate_params={};c.rotate_params.enable_rotate=a.getValue();if(c.rotate_params.enable_rotate){if("rotate_earliest"===b.getGroupValue()){c.rotate_params.rotate_action=[]}else{if("rotate_smart_recycle"===b.getGroupValue()){c.rotate_params.rotate_action=[[24*60*60,60*60,1],[30*24*60*60,24*60*60,1],[0,7*24*60*60,1]]}}c.rotate_params.rotate_condition=[1,d.getValue()]}return c},updatePreviewer:function(){if(this.previewer){var a=this.owner.getParams().schedule;var b=this.getParams().rotate_params;this.previewer.updatePreviewer(a,b)}}});Ext.define("SYNO.SDS.Backup.TaskSourceContainer",{extend:"Ext.Container",constructor:function(a){var c=Ext.apply({border:false,layout:"vbox",style:{padding:"12px 20px 8px 20px"},layoutConfig:{align:"stretch",pack:"start"},items:[{xtype:"syno_fieldset",title:_T("backup","wizard_bkpfolder_title"),layout:"fit",flex:1,items:[new SYNO.SDS.Backup.TaskSourceSelector({itemId:"source",owner:a.owner,firstLevelExpanded:true,pre_load_folder_done:true})]}]},a);var b=this.callParent([c]);return b},activate:function(){var a=this.getSourceSelector();if(Ext.isEmpty(a.allFolders)){a.bwrap.mask(_T("backup","repo_no_share"),"syno-ux-mask-info")}},onShow:function(){this.callParent(arguments);var e=this.owner.getParams();var d=this.getSourceSelector();var c,b,a;if(e.target_type==="image"||("cloud"===e.target_type&&"hicloud_s3"===e.transfer_type)){if(d.disableEncryptionShare()){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),String.format(_T("backup","multi_version_not_support_encrypted_share")+"&nbsp;"+_T("backup","deselect_all_encrypted_share")))}}else{d.enableEncryptionShare()}if("share"===e.target_type&&"local"===e.transfer_type){c=e.share;b=d.getNodeById("/"+c);if(b){a=d.hasCheckedNode(b);d.setDestination("/"+c);if(true===a){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),String.format(_T("localbkp","localbkp_dest_conflict_bkpshare")+"&nbsp;"+_T("localbkp","deselect_conflict_source_share")+"&nbsp;["+c+"]"))}}}else{d.clearDestination()}d.setConflictVolume();this.owner.doIfAppShareReady("folder_initialed")},getSourceSelector:function(){return this.getComponent(0).getComponent("source")},getNext:function(){if(this.owner.getStep("app").needHide()){this.owner.goNext(this.owner.getStep("app").getNext());return false}return this.nextId},getParams:function(){var a=this.getSourceSelector();var b={source:{file_list:a.getFolderList()}};return b}});Ext.define("SYNO.SDS.Backup.TaskCreateWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(b){Ext.copyTo(this,b,"owner");this.lastStepId=null;var g=SYNO.SDS.Backup.Addon.getList();var f=function(){var h={image_local:"image",image_remote:"image_remote",local:"local",rsync:"network",rsync_ds:"network"};Ext.each(g,function(k){var j=k.id;h[j]=j+"_task_repo"});return h};var a=function(k,h){var i=k+"_task_repo";var j=SYNO.SDS.Backup.Addon.GetSymbol(k,"Backup.ParamsPanel");return new j({appWin:h,owner:h,itemId:i,nextId:null,subTitle:_T("backup","backup_settings")})};var d=function(h){var i=[];Ext.each(g,function(k){var j=a(k.id,h);i.push(j)});return i};var c=[new SYNO.SDS.Backup.TaskSourceContainer({owner:this,appWin:this,itemId:"source_repo",nextId:"app"}),new SYNO.SDS.Backup.AppParamsPanel({appWin:this,owner:this,itemId:"app",subTitle:_T("backup","wizard_bkpapp_title"),nextId:f()}),new SYNO.SDS.Backup.ImageParamsPanel({appWin:this,owner:this,itemId:"image",subTitle:_T("backup","backup_settings"),nextId:"rotate"}),new SYNO.SDS.Backup.ImageRemoteParamsPanel({appWin:this,owner:this,itemId:"image_remote",subTitle:_T("backup","backup_settings"),nextId:"rotate"}),new SYNO.SDS.Backup.SynolocalParamsPanel({appWin:this,owner:this,itemId:"local",subTitle:_T("backup","backup_settings"),nextId:null}),new SYNO.SDS.Backup.SynonetParamsPanel({appWin:this,owner:this,itemId:"network",subTitle:_T("backup","backup_settings"),nextId:null}),new SYNO.SDS.Backup.RotationParamsPanel({appWin:this,owner:this,itemId:"rotate",subTitle:_T("backup","backup_rotation_settings"),nextId:null})];c=c.concat(d(this));c=SYNO.SDS.Backup.Repository.CreateSteps(this,"backup_task","source_repo").concat(c);var e=Ext.apply({title:_T("bkpwizard","wizard_title"),banner:false,width:680,height:510,steps:c},b);this.callParent([e])},initEvents:function(){this.callParent(arguments);this.setStatusBusy()},createRepoTask:function(){var a=this.getActiveStep();if(!a||(Ext.isFunction(a.isValid)&&!a.isValid())){return false}var b=this.getParams();this.setStatusBusy();if(!b.repo_id){if("image_remote"===b.transfer_type){delete b.enc_port}SYNO.SDS.Backup.Repository.CreateRepo(this,b,this.onCreateRepoDone)}else{this.createTask(b)}},onCreateRepoDone:function(d,a,b){if(!d||a.has_fail){this.reportError(a);this.clearStatusBusy();return}var c=this.getParams();Ext.apply(c,{repo_id:a.repo_id});this.createTask(c)},goNext:function(a,b){this.lastStepId=this.getActiveStep().getItemId();if(null===a){this.createRepoTask();return}this.callParent(arguments);this.lastStepId=null},getRepoInfo:function(){return this.getParams()},getSourceSelector:function(){return this.getStep("source_repo").getSourceSelector()},getAppPanel:function(){return this.getStep("app")},doIfAppShareReady:function(a){this[a]=true;if(this.app_loaded&&this.folder_loaded&&this.folder_initialed){SYNO.SDS.Backup.setAppGridDependency(this.getAppPanel(),this.getSourceSelector(),true)}},createTask:function(b){var c=Ext.apply({},b);var a=this.getStep("source_repo").getParams();var d=this.getStep("app").getParams();a.source.app_list=d;Ext.apply(c.backup_params,a.backup_params);delete a.backup_params;Ext.apply(c,a);c.name=c.task_name;this.sendWebAPI({api:"SYNO.Backup.Task.Data",version:1,method:"create",params:c,callback:this.onCreateTaskDone,scope:this})},onCreateTaskDone:function(c,a,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}if(this.callbacks&&this.callbacks.apply){this.callbacks.apply.call(this.callbacks.scope||window,a,b)}this.close()},createTaskDefaultName:function(b){var a=1;while(true){if(-1===this.taskList.findExact("name",b+" "+a)){break}a++}return b+" "+a},isTaskNameValid:function(a){return -1===this.taskList.findExact("name",a)},createRepoDefaultName:function(c){var a,b=1;while(true){a=String.format("{0} {1}",c,b);if(-1===this.repoList.findExact("name",a)){break}b++}return a},isRepoNameValid:function(a){return -1===this.repoList.findExact("name",a)},setDestFolderName:function(b,e,a){var d;if(e!=="share"&&e!=="cloud"){return}if(a==="local"){d=this.getStep("local").getForm()}else{if(a==="rsync"||a==="rsync_ds"){d=this.getStep("network").getForm()}else{if(e==="cloud"){d=this.getStep(a+"_task_repo").getForm()}else{return}}}var c=e+":"+a;if(d.getValues().task_dir&&this.choosedType===c){return}this.choosedType=c;d.findField("task_dir").setValue(b);return},setRsyncTransEncrypt:function(a,d,b){var c;if(d==="share"&&(b==="rsync"||b==="rsync_ds")){c=this.getStep("network").getForm();if(4===Ext.getDom(c.findField("trans_encrypt").getEl()).parentNode.childNodes.length){Ext.getDom(c.findField("trans_encrypt").getEl()).parentNode.lastChild.remove(true)}if(4===a){c.findField("trans_encrypt").setValue(false);c.findField("trans_encrypt").setDisabled(true);SYNO.SDS.Utils.AddTip(c.findField("trans_encrypt").getEl(),_T("netbackup","backup_destination_no_encryption_only"))}else{if(5===a){c.findField("trans_encrypt").setValue(true);c.findField("trans_encrypt").setDisabled(true);SYNO.SDS.Utils.AddTip(c.findField("trans_encrypt").getEl(),_T("netbackup","backup_destination_encryption_only"))}else{c.findField("trans_encrypt").setValue(false);c.findField("trans_encrypt").setDisabled(false)}}}return},getParams:function(){var b={};var a;if(this.lastStepId){a=this.stepStack.concat([this.lastStepId])}else{a=this.stepStack}Ext.each(a,function(d){var c=this.getStep(d);if(Ext.isFunction(c.getParams)){Ext.apply(b,this.getStep(d).getParams())}},this);return b},getLocalRepoVolume:function(){var a;if(this.lastStepId){a=this.stepStack.concat([this.lastStepId])}else{a=this.stepStack}var b=null;Ext.each(a,function(d){var c=this.getStep(d);if(Ext.isFunction(c.getLocalRepoVolume)){b=this.getStep(d).getLocalRepoVolume();if(b){return false}}},this);return b},reportError:function(a,b){b=b||{};if(!this.reporter){this.reporter=new SYNO.SDS.Backup.ApiHelper({owner:this})}this.reporter.alert(a,b.callback,b.scope)}});Ext.define("SYNO.SDS.Backup.EditSchedulePanel",{extend:"SYNO.SDS.TaskScheduler2.EditSchedulePanel",initComponent:function(){this.items[0].title="";this.items[0].items.unshift({xtype:"syno_radio",id:this.disable_id=Ext.id(),boxLabel:_T("backup","schedule_disabled"),name:"date",inputValue:-1});this.callParent(arguments)},initEvents:function(){this.callParent(arguments);this.mon(Ext.getCmp(this.disable_id),"check",this.onDisableChecked,this);delete Ext.getCmp(this.per_week_id).handler;this.mon(Ext.getCmp(this.per_week_id),"check",this.onWeekChecked,this);this.mon(Ext.getCmp(this.by_date_id),"check",this.onDateChecked,this)},setData:function(a){this.callParent(arguments);if(a.schedule_enable){if(0===a.date_type){Ext.getCmp(this.disable_id).setValue(false)}else{Ext.getCmp(this.disable_id).setValue(false)}}else{Ext.getCmp(this.disable_id).setValue(true);Ext.getCmp(this.by_date_id).setValue(false);Ext.getCmp(this.per_week_id).setValue(false);Ext.getCmp(this.week_name_id).setDisabled(true);Ext.getCmp(this.date_id).setDisabled(true);Ext.getCmp(this.repeat_id).setDisabled(true);Ext.getCmp(this.hour_id).setDisabled(true);Ext.getCmp(this.min_id).setDisabled(true);Ext.getCmp(this.repeat_hour_id).setDisabled(true);Ext.getCmp(this.last_work_hour_id).setDisabled(true)}},onDisableChecked:function(b,a){if(a){Ext.getCmp(this.week_name_id).setDisabled(true);Ext.getCmp(this.date_id).setDisabled(true);Ext.getCmp(this.repeat_id).setDisabled(true);Ext.getCmp(this.hour_id).setDisabled(true);Ext.getCmp(this.min_id).setDisabled(true);Ext.getCmp(this.repeat_hour_id).setDisabled(true);Ext.getCmp(this.last_work_hour_id).setDisabled(true)}},onWeekChecked:function(b,a){if(a){Ext.getCmp(this.week_name_id).setDisabled(false);Ext.getCmp(this.date_id).setDisabled(true);Ext.getCmp(this.repeat_id).setDisabled(true);Ext.getCmp(this.hour_id).setDisabled(false);Ext.getCmp(this.min_id).setDisabled(false);Ext.getCmp(this.repeat_hour_id).setDisabled(false);Ext.getCmp(this.last_work_hour_id).setDisabled(false)}},onDateChecked:function(b,a){if(a){Ext.getCmp(this.week_name_id).setDisabled(true);Ext.getCmp(this.date_id).setDisabled(false);Ext.getCmp(this.repeat_id).setDisabled(false);Ext.getCmp(this.hour_id).setDisabled(false);Ext.getCmp(this.min_id).setDisabled(false);Ext.getCmp(this.repeat_hour_id).setDisabled(false);Ext.getCmp(this.last_work_hour_id).setDisabled(false)}}});Ext.define("SYNO.SDS.Backup.TaskEditDialog",{extend:"SYNO.SDS.ModalWindow",dsmStyle:"v5",invalidList:"",constructor:function(b){this.invalidAlerted=false;this.expandedRoot=0;var d=680,a=580;var c=Ext.apply({width:d,height:a,resizable:false,items:[{xtype:"syno_tabpanel",itemId:"edit_tab_panel",activeTab:0,items:[new SYNO.SDS.Backup.TaskSourceSelector({title:_T("backup","folder_title"),itemId:"source_selector",owner:this,height:a-130,pre_load_folder_done:false}),new SYNO.SDS.Backup.AppParamsPanel({title:_T("backup","application"),itemId:"app_panel",owner:this}),this.createParamsPanelByType(b.transferType,b.targetType,{title:_T("schedule","task_settings"),itemId:"params_panel",owner:this,height:a-130}),new SYNO.SDS.Backup.EditSchedulePanel({title:_T("common","schedule"),itemId:"sched_panel",owner:this})]}],buttons:[{text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.onApplyClick},{text:_T("common","cancel"),scope:this,handler:function(){this.close()}}]},b);this.callParent([c])},initEvents:function(){this.callParent(arguments);var a=this.getSourceSelector();this.mon(a,"beforeexpandnode",this.onExpandFmRoot,this);this.mon(this.getParamsPanel(),"activate",this.onActiveParams,this,{single:true})},createParamsPanelByType:function(a,e,b){var d;var c=Ext.apply({},b);if(e==="cloud"){d=SYNO.SDS.Backup.Addon.GetSymbol(a,"Backup.ParamsPanel");return new d(c)}switch(a){case"image_local":c.enableRotate=true;return new SYNO.SDS.Backup.ImageParamsPanel(c);case"image_remote":c.enableRotate=true;return new SYNO.SDS.Backup.ImageRemoteParamsPanel(c);case"local":return new SYNO.SDS.Backup.SynolocalParamsPanel(c);case"rsync":case"rsync_ds":return new SYNO.SDS.Backup.SynonetParamsPanel(c);default:SYNO.Debug("wrong transfer type: "+a)}},disableNode:function(a){a.getUI().setCheckValue(false);a.leaf=true;a.expandable=false;a.disable()},disableEncShare:function(c){if("image"===this.targetType||("cloud"===this.targetType&&"hicloud_s3"===this.transferType)){var d=c.childNodes.size();for(var a=0;a<d;a++){var b=c.childNodes[a];if(true===b.attributes.encryptedShare){this.disableNode(b);b.setTooltip(_T("backup","multi_version_not_support_encrypted_share"))}}}},destShareCheck:function(c){if(this.destShare){var a=this.getSourceSelector();var b=a.getNodeById("/"+this.destShare);if(b){this.disableNode(b);b.attributes.disabled=true;b.setTooltip(_T("backup","source_share_conflict_destination"))}}},onExpandFmRoot:function(a){if(-1!==this.getSourceSelector().fm_root_nodes.indexOf(a.id)){this.disableEncShare(a);this.destShareCheck(a);this.expandedRoot+=1;if(this.getSourceSelector().volumeCount===this.expandedRoot){this.doIfAppShareReady("folder_initialed")}}return true},onActiveParams:function(){var a=this.getParamsPanel().getForm();if(a.findField("trans_encrypt")){if("online rsync"===this.dest_status_text){SYNO.SDS.Utils.AddTip(a.findField("trans_encrypt").getEl(),_T("netbackup","backup_destination_no_encryption_only"))}else{if("online ssh"===this.dest_status_text){SYNO.SDS.Utils.AddTip(a.findField("trans_encrypt").getEl(),_T("netbackup","backup_destination_encryption_only"))}}}return},onOpen:function(){this.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:true,params:[{api:"SYNO.Backup.Task.Data",version:1,method:"get",scope:this,params:{task_id:this.taskId,additional:["backup_params","rotate_params","schedule","version_count"]}},{api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:this.repoId,additional:["support_auto_unmount","local_volume","support_ssl","support_rotate"]}}]},scope:this,callback:this.onOpenDone});return this.callParent(arguments)},onOpenDone:function(e,b,d){this.clearStatusBusy();if(!e){this.getMsgBox().alert(_T("leaf","backup"),_T("common","error_system"),function(){this.close()},this);return}if(!b.result[0].success){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.result[0].error.code),function(){this.close()},this);return}if(!b.result[1].success){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.result[1].error.code),function(){this.close()},this);return}var c=b.result[0].data;var a=b.result[1].data;this.repoVolume=a.local_volume;if("share"===a.target_type&&"local"===a.transfer_type){this.destShare=a.share}this.support_ssl=a.support_ssl;this.support_rotate=a.support_rotate;this.version_count=c.version_count;this.loadBackupSource(c,a);this.loadBackupParams(c,a);this.loadAppParams(c,a);this.loadSched(c)},alertInvalidList:function(){this.invalidAlerted=true;var b=this.getAppPanel().checkedList.slice(0);Ext.each(this.getAppPanel().getAppList(),function(c){b.remove(c)});var a="";if(0<this.invalidList.length){a+=this.invalidList}if(0<b.length){a+=_T("backup","application")+": "+b.join(", ")}if(0<a.length){this.getMsgBox().alert(_T("leaf","backup"),_T("backup","unselect_invalid_source")+"<br/>"+a,this.clearStatusBusy,this)}},getLocalRepoVolume:function(){return this.repoVolume},loadAppParams:function(a,b){this.getAppPanel().setAppList(a.source.app_list)},loadBackupSource:function(b,c){var a=this.getSourceSelector();if(!b||!b.source){return}a.setFolderList(b.source.folder_list)},loadSched:function(a){var b={week_name:"1",hour:0,min:0,date:new Date().format("Y/m/d"),date_type:0,repeat:0,repeat_hour:0,last_work_hour:0,schedule_enable:false};if(a.schedule){b=a.schedule.schedule;b.schedule_enable=a.schedule.schedule_enable}b.repeat_date=b.repeat;b.minute=b.min;b.week_day=b.week_name;delete b.repeat;delete b.min;delete b.week_name;this.getSchedPanel().setData(b)},loadBackupParams:function(a,b){this.getParamsPanel().getForm().setValues(Ext.apply({task_name:a.name,task_dir:a.target_id,incrbkp_enable:!a.backup_params.delete_on_target,bandwidthcheck:(a.backup_params.bw_limit&&a.backup_params.bw_limit>0),backup_rotation:a.rotate_params.enable_rotate},a.backup_params));var d=this.getParamsPanel().getForm().items.filter("name","version_mode");if(d&&d.length>=2){d.itemAt(0).disable();d.itemAt(1).disable();if(true===a.backup_params.multi_version_enable){this.getParamsPanel().getForm().findField("incrbkp_enable").disable();d.itemAt(0).setValue(false);d.itemAt(1).setValue(true)}else{d.itemAt(0).setValue(true);d.itemAt(1).setValue(false)}}d=this.getParamsPanel().getForm().items.filter("name","backup_rotation_action");if(Ext.isArray(a.rotate_params.rotate_action)){if(0<a.rotate_params.rotate_action.length){d.itemAt(0).setValue(false);d.itemAt(1).setValue(true)}else{d.itemAt(0).setValue(true);d.itemAt(1).setValue(false)}}var c=this.getParamsPanel().getForm().findField("backup_rotation_condition_max_version");if(c){if(Ext.isArray(a.rotate_params.rotate_condition)){c.setValue(a.rotate_params.rotate_condition[1])}else{c.setValue(256)}}this.orgName=a.name;this.dest_status_text=b.deststatus;if("share"===b.target_type&&"rsync"===b.transfer_type){if(b.remoteshell){this.getParamsPanel().getForm().findField("trans_encrypt").setDisabled(true)}}if(this.getParamsPanel().getForm().findField("dest_auto_unmount")){if(b.support_auto_unmount){this.getParamsPanel().getForm().findField("dest_auto_unmount").show()}else{this.getParamsPanel().getForm().findField("dest_auto_unmount").hide()}}},getSourceSelector:function(){return this.getComponent("edit_tab_panel").getComponent("source_selector")},getAppPanel:function(){return this.getComponent("edit_tab_panel").getComponent("app_panel")},doIfAppShareReady:function(a){this[a]=true;if(this.app_loaded&&this.folder_loaded&&this.folder_initialed){SYNO.SDS.Backup.setAppGridDependency(this.getAppPanel(),this.getSourceSelector(),true);this.alertInvalidList()}},getSchedPanel:function(){return this.getComponent("edit_tab_panel").getComponent("sched_panel")},getParamsPanel:function(){return this.getComponent("edit_tab_panel").getComponent("params_panel")},onApplyClick:function(){if(!this.getParamsPanel().getForm().isValid()){this.getComponent("edit_tab_panel").setActiveTab("params_panel");this.setStatusError({text:_T("common","forminvalid"),clear:true});return false}var c=this.getParamsPanel().getForm();var d=c.findField("backup_rotation");var a=c.findField("backup_rotation_action");var e=c.findField("backup_rotation_condition_max_version");if(d&&d.getValue()&&((d&&d.isDirty())||(a&&a.isDirty())||(e&&e.isDirty()))){var b;if(e&&this.version_count&&e.getValue()<this.version_count){this.getComponent("edit_tab_panel").setActiveTab("params_panel");b=String.format(_T("backup","rotate_delete_hint"),this.version_count,e.getValue())+"<br/><br/>"+_T("backup","rotate_delete_note");b+="<br/><br/>"+_T("backup","rotate_delete_confirm");this.getMsgBox().confirmDelete("",b,function(f){if("yes"===f){this.applyEdit()}else{return false}},this,{yes:{text:_T("backup","rotate"),btnStyle:"red"},no:{text:Ext.MessageBox.buttonText.no}})}else{this.getComponent("edit_tab_panel").setActiveTab("params_panel");b=String.format(_T("backup","rotate_delete_hint_under"),this.version_count,e.getValue());b+="<br/><br/>"+_T("backup","rotate_delete_confirm");this.getMsgBox().confirm("",b,function(f){if("yes"===f){this.applyEdit()}else{return false}},this)}}else{this.applyEdit()}},applyEdit:function(){var c;var h={};var a={};var g=Ext.apply({task_id:this.taskId,repo_id:this.repoId,source:{file_list:this.getSourceSelector().getFolderList(),app_list:this.getAppPanel().getAppList()},schedule:this.getBkpSchedule()},this.getParamsPanel().getEditParams());if(!this.getSourceSelector().isValid()){this.getComponent("edit_tab_panel").setActiveTab("source_selector");this.setStatusError({text:_T("common","forminvalid"),clear:true});return false}if(!this.isNameValid(g.name)){this.getComponent("edit_tab_panel").setActiveTab("params_panel");this.getMsgBox().alert(_T("tree","leaf_backup"),_T("localbkp","localbkp_bkpset_exist"));return false}c=[];h.api="SYNO.Backup.Task.Data";h.version=1;h.method="set";h.params=g;c.push(h);var d=this.getParamsPanel().getForm();var e=d.findField("backup_rotation");var b=d.findField("backup_rotation_action");var f=d.findField("backup_rotation_condition_max_version");if(e&&e.getValue()&&((e&&e.isDirty())||(b&&b.isDirty())||(f&&f.isDirty()))){a.api="SYNO.Backup.Version";a.version=1;a.method="rotate";a.params=g;c.push(a)}this.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:true,params:c},scope:this,callback:function(l,i,j){var k=true;this.clearStatusBusy();if(!l){this.owner.getMsgBox().alert(_T("leaf","backup"),_T("common","error_system"));return}Ext.each(i.result,function(m){if(!m.success){k=false;this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(m.error.code));return false}},this);if(k){this.close()}}});return false},isNameValid:function(a){return this.orgName===a||-1===this.taskList.findExact("name",a)},getBkpSchedule:function(){var a={};Ext.apply(a,this.getSchedPanel().getData());a.repeat=a.repeat_date;a.min=a.minute;a.week_name=a.week_day;a.schedule_enable=this.getScheduleEnable();delete a.repeat_date;delete a.minute;delete a.week_day;return a},getBkpParams:function(){return this.getParamsPanel().getBkpParams()},getScheduleEnable:function(){return(false===Ext.getCmp(this.getSchedPanel().disable_id).getValue())}});Ext.define("SYNO.SDS.Backup.TaskNamePanel",{extend:"SYNO.ux.FormPanel",oriTaskName:"",grid:null,sourceType:"",constructor:function(b){this.grid=b.grid;var a={title:_T("localbkp","localbkp_dest"),padding:"20px",items:[{xtype:"syno_textfield",fieldLabel:_T("localbkp","localbkp_bkpset_name"),name:"bkpset",maxlength:SYNO.SDS.Backup.BKPSET_MAX_LEN,vtype:"username",width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,allowBlank:false}]};this.sourceType=b.sourceType;Ext.apply(a,b);this.callParent([a])},UpateMyBackupSet:function(a,j,g){this.owner.clearStatusBusy();if(j&&g.responseText!==null){var b=Ext.util.JSON.decode(g.responseText);var h="My Backup Set ";var d;if(!b.success){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(b.errinfo.sec,b.errinfo.key))}else{var f=b.data.total;var c=1;for(d=0;d<f;d++){var e=h+c;if(b.data.items[d].bkpset===e){c++;d=-1}}h+=c;this.getForm().findField("bkpset").setRawValue(h)}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));this.owner.getButton("next").disable()}},getDefaultName:function(){var f;if("LUN"!==this.sourceType){f="My Backup Set "}else{f="My LUN Backup Set "}if(null!==this.grid){var d=this.grid;var e=d.getCount();var c=1,b,g,a;for(b=0;b<e;b++){g=d.getAt(b);a=f+c;if(g.data.name===a){c++;b=-1}}f+=c}else{if("LUN"!==this.sourceType){f="My Backup Set"}else{f="My LUN Backup Set"}Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"load"},callback:this.UpateMyBackupSet,scope:this})}return f},activate:function(){var a=this.getForm().findField("bkpset");if(""===a.getValue()){a.setValue(this.getDefaultName())}this.getForm().findField("bkpset").focus(true)},bkpsetConflictDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var b=Ext.util.JSON.decode(c.responseText);if(b.conflict){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("localbkp","localbkp_bkpset_exist"),function(){this.getForm().findField("bkpset").focus(true)},this)}else{var a=this.getForm().findField("bkpset").getValue();this.oriTaskName=a;this.owner.taskName=a;this.owner.goNext(this.nextId)}}},getNext:function(){var b=this.getForm().findField("bkpset");var a;if(!this.getForm().isValid()){this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});return false}a=Ext.util.Format.trim(b.getValue());b.setValue(a);if(this.oriTaskName!==a){this.owner.setStatusBusy({text:_T("common","loading")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"bkpsetconflict",bkpset:a},callback:this.bkpsetConflictDone,scope:this});return false}else{return this.nextId}},summary:function(a){a.append(_T("localbkp","localbkp_bkpset_name"),this.getForm().findField("bkpset").getValue());return},getBkpSet:function(){return this.getForm().findField("bkpset").getValue()}});Ext.define("SYNO.SDS.Backup.LUNSourcePanel",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,constructor:function(b){var c=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:b.owner.lunSourceList});b.owner.lunSourceStore=c;var a={title:Ext.util.Format.ellipsis(_T("lunbkp","lun_source"),15),padding:"20px",items:[{xtype:"syno_combobox",fieldLabel:_T("lunbkp","lun_source"),hiddenName:"lunsource",name:"lunsource",forceSelection:true,allowBlank:false,editable:false,store:c,displayField:"display",valueField:"value",triggerAction:"all",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,mode:"local",scope:this}]};Ext.apply(a,b);this.callParent([a]);this.registerEvent()},registerEvent:function(){this.getForm().findField("lunsource").on("select",function(c,b,a){this.getForm().findField("lunsource").el.dom.qtip=this.owner.lunSourceList[a][1];this.owner.blBkpLUNChanged=true},this)},activate:function(){if(!this.isActivatedBefore){this.isActivatedBefore=true;this.lunSourceRequest()}},saveSettings:function(){this.owner.lunSource=this.getForm().findField("lunsource").getValue().name;this.owner.lunSourceSize=this.getForm().findField("lunsource").getValue().size},checkLUNDone:function(c,d,b){this.owner.clearStatusBusy();if(d&&b.responseText){var a=Ext.util.JSON.decode(b.responseText);if(("passed"===a.name_check)&&("passed"===a.space_check)){this.owner.goNext(this.nextId)}else{if("failed"===a.name_check){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("smsnotify","provider_name_repetition"))}else{if("failed"===a.space_check){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("share","share_space_not_enough"))}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}}}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));this.owner.getButton("next").disable()}},checkLUN:function(){var a={};a.action="checklun";a.tasktype=this.owner.taskType;a.lunname=this.owner.lunSource;a.lunsize=this.owner.lunSourceSize;if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.owner.taskType){a.share=this.owner.PanelDestLocal.getForm().findField("localDest").getValue()}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===this.owner.taskType){a.servertype="synology";a.share=this.owner.PanelDestShare.getForm().findField("remoteShare").getValue();a=this.owner.PanelDestNet.getParamsVal(a)}}this.owner.setStatusBusy({text:_T("bkpwizard","msg_waiting")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.checkLUNDone,scope:this},this)},getNext:function(){if(!this.getForm().isValid()){return false}this.owner.getMsgBox().confirm(_T("tree","leaf_backup"),_T("lunbkp","lun_is_vaai_or_block"),function(a){if("yes"===a){this.saveSettings();this.checkLUN()}},this);return false},summary:function(a){a.append(_T("lunbkp","lun_source"),this.owner.lunSource);return},lunSourceDone:function(d,e,c){var b=0;this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key));return}for(b=0;b<a.data.total;b++){this.owner.lunSourceList.push([{name:a.data.items[b].name,size:a.data.items[b].size,type:a.data.items[b].type},a.data.items[b].name])}this.owner.lunSourceStore.loadData(this.owner.lunSourceList,false);if("edit"!==this.mode){if(0<this.owner.lunSourceList.length){this.owner.blBkpLUNChanged=true;this.getForm().findField("lunsource").setValue(this.owner.lunSourceList[0][0]);this.getForm().findField("lunsource").el.dom.qtip=this.owner.lunSourceList[0][1];this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("lunbkp","err_no_available_lun"))}}else{if(0<this.owner.lunSourceList.length){for(b=0;b<this.owner.lunSourceList.length;b++){if(this.owner.lunSource===this.owner.lunSourceList[b][0].name){this.getForm().findField("lunsource").setValue(this.owner.lunSourceList[b][0]);this.owner.lunSourceSize=this.owner.lunSourceList[b][0].size}}}}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));this.owner.getButton("next").disable()}},lunSourceRequest:function(){var a={};this.owner.lunSourceList.length=0;a.action="enumlun";a.mode=this.mode;if("edit"===this.mode){a.lunname=this.owner.lunSource}else{a.lunname=""}this.owner.setStatusBusy({text:_T("lunbkp","search_lun_source")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.lunSourceDone,scope:this},this)}});Ext.define("SYNO.SDS.Backup.LUNDestTypePanel",{extend:"SYNO.ux.FormPanel",constructor:function(b){if(!b.nextId||2!==b.nextId.length){throw"invalid config"}var a={padding:"20px",items:[{xtype:"radiogroup",columns:1,hideLabel:true,itemId:"option",items:[{xtype:"syno_radio",boxLabel:_T("lunbkp","local_lunbkp"),name:"mode",inputValue:0,checked:true},{xtype:"syno_displayfield",indent:1,value:_T("lunbkp","local_lunbkp_desc")},{xtype:"syno_radio",boxLabel:_T("lunbkp","net_lunbkp")+" ("+String.format(_T("netbackup","synology_server"),_D("company_title"))+")",name:"mode",inputValue:1},{xtype:"syno_displayfield",indent:1,value:String.format(_T("lunbkp","net_lunbkp_desc"),_D("company_title"))}]}]};Ext.apply(a,b);this.callParent([a])},activate:function(){},SaveSettings:function(){this.owner.taskType=this.getBkpType()},getNext:function(){this.SaveSettings();var a=this.getForm().getValues().mode;return this.nextId[a]},summary:function(a){return},getBkpType:function(){var a=this.getForm().getValues().mode;var b="";switch(a){case"0":b=SYNO.SDS.Backup.BKPTASK_LOCLUN;break;case"1":b=SYNO.SDS.Backup.BKPTASK_NETLUN;break;default:break}return b}});Ext.define("SYNO.SDS.Backup.LUNDestLocalPanel",{extend:"SYNO.ux.FormPanel",blLoaded:false,userInputDirectoryFlag:false,destStore:null,destList:[],constructor:function(c){var a=new Ext.data.ArrayStore({id:"value",fields:["value","display"],data:this.destList});this.destStore=a;var b={padding:"20px",items:[{xtype:"syno_combobox",fieldLabel:_T("localbkp","localbkp_dest"),name:"localDest",store:a,allowBlank:false,displayField:"display",valueField:"value",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,listeners:{scope:this,select:this.defaultDirectoryUpdate}},{xtype:"syno_textfield",fieldLabel:_T("backup","backup_dest_directory"),itemId:"destDirectory",allowBlank:false,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,vtype:"sharename",listeners:{scope:this,change:this.userInputDirectory}}]};Ext.apply(b,c);this.callParent([b])},localbkpDestDone:function(e,f,c){this.owner.clearStatusBusy();if(f&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key));return}this.allDest=a.items;this.destList=[];for(var b=0;b<a.total;b++){this.destList.push([this.allDest[b].destValue,this.allDest[b].dest])}if(null===this){return}var d=this.getForm().findField("localDest");d.store.loadData(this.destList,false);if(0<this.destList.length){d.setValue(this.destList[0][0]);this.defaultDirectoryUpdate();this.owner.getButton("next").enable()}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("share","error_noneshare"));this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));this.owner.getButton("next").disable()}},load:function(){this.destList.length=0;this.owner.setStatusBusy({text:_T("localbkp","localbkp_wait_dest")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"locallunbkpdest"},callback:this.localbkpDestDone,scope:this})},registerEvent:function(){this.getForm().findField("localDest").on("select",function(c,b,a){this.owner.blDestChanged=true},this)},activate:function(){if(!this.blLoaded){this.registerEvent();this.load();this.blLoaded=true}},checkDirDone:function(b,d,c){var a;this.owner.clearStatusBusy();if(d&&c.responseText){a=Ext.util.JSON.decode(c.responseText);if(a.success){this.owner.goNext(this.nextId)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}},checkDir:function(){var a={};a.action="lunbkpcheckdir";a.bkptype=SYNO.SDS.Backup.BKPTASK_LOCLUN;a.bkpset=this.owner.taskName;a.share=this.getForm().findField("localDest").getValue();a.directory=this.getForm().findField("destDirectory").getValue();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),callback:this.checkDirDone,scope:this})},getNext:function(){if(this.owner.taskDest!==this.getForm().findField("localDest").getValue()){this.owner.blDestChanged=true}if(!this.getForm().isValid()){return false}this.owner.taskDest=this.getForm().findField("localDest").getValue()+"/"+this.getForm().findField("destDirectory").getValue();this.checkDir();return false},summary:function(a){a.append(_T("backup","backup_type"),_T("lunbkp","local_lunbkp"));a.append(_T("localbkp","localbkp_dest"),this.owner.taskDest);return},userInputDirectory:function(){this.userInputDirectoryFlag=true},defaultDirectoryUpdate:function(){if(this.userInputDirectoryFlag){return}var b=this.getForm().findField("destDirectory");var a=this.owner;var c={};c.action="getlocaldestdirectory";c.bkpShare=this.getForm().findField("localDest").getValue();this.owner.setStatusBusy({text:_T("localbkp","localbkp_wait_dest")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:c,callback:function(f,g,e){a.clearStatusBusy();var d;if(g&&e.responseText){d=Ext.util.JSON.decode(e.responseText);if(!d.success){a.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}else{b.setValue(d.defaultDirectory)}}else{a.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}}})},getBkpDest:function(){return this.getForm().findField("localDest").getValue()}});Ext.define("SYNO.SDS.Backup.LUNDestNetPanel",{extend:"SYNO.ux.FormPanel",blSynoServerLoad:false,ServerStore:null,constructor:function(b){this.ServerList=[];this.ServerStore=new Ext.data.SimpleStore({fields:["value","display"],data:this.ServerList});var a={padding:"20px",items:[{xtype:"syno_combobox",fieldLabel:_T("netbackup","netbkp_set_ip"),name:"server",allowBlank:false,emptyText:_T("netbackup","netbkp_input_addr"),editable:true,store:this.ServerStore,displayField:"display",valueField:"value",triggerAction:"all",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,mode:"local",validator:function(h){var e=b.owner.selfHostName;var c=b.owner.selfIPs;var g=new RegExp(e,"gi");if(h===c||h==="127.0.0.1"||(h.match(g)&&h.length===e.length)){return _T("netbackup","netbkp_sync_self")}var f=c.split(",");for(var d=0;d<f.length;d++){if(h===f[d]){return _T("netbackup","netbkp_sync_self")}}return true},onTriggerClick:function(){if(0!==this.getStore().getCount()){if(this.isExpanded()){this.collapse();this.el.focus()}else{this.onFocus({});this.expand();this.el.focus()}}else{this.owner.serverListLoaded=true;this.el.focus();SYNO.SDS.Backup.onLoadSynologyServer(this,this.owner.ServerList,this.owner.owner)}},owner:this},{xtype:"syno_textfield",fieldLabel:_T("netbackup","netbkp_account"),name:"account",allowBlank:false,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,vtype:"username_ext"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),name:"password",inputType:"password",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH}]};Ext.apply(a,b);this.callParent([a]);this.mon(this,"afterlayout",function(c,d){this.getForm().findField("account").setValue("admin")},this,{single:true})},activate:function(){this.serverListLoaded=false},getNext:function(){if(!this.getForm().isValid()){return false}this.onTestConnectionButton("next");return false},summary:function(e){var d=this.getForm();e.append(_T("backup","backup_type"),_T("lunbkp","net_lunbkp"));e.append(_T("netbackup","netbkp_slct_server"),String.format(_T("netbackup","synology_server"),_D("company_title")));var b=d.findField("server").getRawValue();var a=SYNO.SDS.Backup.GetServerName(b);var c=SYNO.SDS.Backup.GetServerIP(b);var f;if(a!==""){f=a;if(c!==""){f+="("+c+")"}}else{f=c}e.append(_T("netbackup","netbkp_server"),f);e.append(_T("netbackup","netbkp_auth_user"),d.findField("account").getValue())},TestServerVersionDone:function(c,d,b){var a;this.owner.clearStatusBusy();if(d&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.owner.goNext(this.nextId)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},TestConnectionWhenGoNext:function(c,e,b){var a;if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){var d={};d.action="remoteversioncheck";d.servertype="synology";d.share="share";d=this.getParamsVal(d);Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(d),callback:this.TestServerVersionDone,scope:this},this)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},onTestConnectionButton:function(b){var a={};a.action="testconnections";a.servertype=SYNO.SDS.Backup.LUNBKP_SYNO_SERVER;a=this.getParamsVal(a);if(a){var c=b==="next"?this.TestConnectionWhenGoNext:null;SYNO.SDS.Backup.onTestSvrConnection(a,this,c)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_err_host_str"))}},getParamsVal:function(g){var e=this.getForm();var b=SYNO.SDS.Backup.GetServerName(e.findField("server").getRawValue());var c=SYNO.SDS.Backup.GetServerIP(e.findField("server").getRawValue());var f=e.findField("account").getValue();var d=e.findField("password").getValue();if(b===""&&c===""){this.owner.getMsgBox().alert(_T("tree","node_backup"),_T("netbackup","netbkp_err_host_str"));return false}g.server=b;g.ip=c;g.account=f;g.password=d;var a=e.findField("module");if(a){g.module=a.getRawValue()}else{g.module=""}return g}});Ext.define("SYNO.SDS.Backup.LUNDestSharePanel",{extend:"SYNO.ux.FormPanel",initialized:false,owner:null,userInputDirectoryFlag:false,constructor:function(d){var c;var b;var a=new Ext.data.SimpleStore({id:"dsRemoteShare",fields:["value","display"],data:d.owner.remoteShareList});d.owner.remoteShareStore=a;b=_T("lunbkp","dest_shared_folder");c={padding:"20px",items:[{xtype:"syno_displayfield",itemId:"serverInfo",fieldLabel:_T("netbackup","netbkp_server"),labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:300},{xtype:"syno_combobox",fieldLabel:b,name:"remoteShare",store:d.owner.remoteShareStore,allowBlank:false,displayField:"display",valueField:"value",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,listeners:{scope:this,select:this.defaultDirectoryUpdate}},{xtype:"syno_textfield",fieldLabel:_T("backup","backup_dest_directory"),itemId:"destDirectory",allowBlank:false,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,vtype:"sharename",listeners:{scope:this,change:this.userInputDirectory}}]};Ext.apply(c,d);this.callParent([c])},activate:function(){if(!this.initialized){this.remoteShareEnum();this.serverNameSet()}},checkDirDone:function(b,d,c){var a;this.owner.clearStatusBusy();if(d&&c.responseText){a=Ext.util.JSON.decode(c.responseText);if(a.success){this.owner.goNext(this.nextId)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}},checkDir:function(){var b={};var a=this.owner.PanelDestNet.getForm().findField("server").getRawValue();b.action="lunbkpcheckdir";b.bkptype=SYNO.SDS.Backup.BKPTASK_NETLUN;b.bkpset=this.owner.taskName;b.share=this.getForm().findField("remoteShare").getValue();b.directory=this.getForm().findField("destDirectory").getValue();b.user=this.owner.PanelDestNet.getForm().findField("account").getRawValue();b.password=this.owner.PanelDestNet.getForm().findField("password").getRawValue();b.server=SYNO.SDS.Backup.GetServerName(a);b.ip=SYNO.SDS.Backup.GetServerIP(a);Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(b),callback:this.checkDirDone,scope:this})},saveSetting:function(){this.owner.directory=this.getForm().findField("destDirectory").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.checkDir();this.saveSetting();return false},summary:function(a){a.append(_T("lunbkp","dest_shared_folder"),this.getForm().findField("remoteShare").getValue()+"/"+this.owner.directory)},remoteShareEnumDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key));return}for(var b=0;b<a.items.length;b++){this.owner.remoteShareList.push([a.items[b].share,a.items[b].share])}this.owner.remoteShareStore.loadData(this.owner.remoteShareList,false);if(0<this.owner.remoteShareList.length){this.getForm().findField("remoteShare").setValue(this.owner.remoteShareList[0][0]);this.defaultDirectoryUpdate();this.owner.getButton("next").enable()}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("ftp","ftp_no_share"));this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));this.owner.getButton("next").disable()}},remoteShareEnum:function(){var b;this.owner.remoteShareList.length=0;var a=this.owner.PanelDestNet.getForm().findField("server").getRawValue();b={};b.action="lunenumremoteshare";b.user=this.owner.PanelDestNet.getForm().findField("account").getRawValue();b.password=this.owner.PanelDestNet.getForm().findField("password").getRawValue();b.server=SYNO.SDS.Backup.GetServerName(a);b.ip=SYNO.SDS.Backup.GetServerIP(a);b.type="lunbkp";this.owner.setStatusBusy({text:_T("netbackup","netbkp_search_folder")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(b),method:"POST",callback:this.remoteShareEnumDone,scope:this},this)},serverNameSet:function(){var b=this.owner.PanelDestNet.getForm().findField("server").getRawValue();var c=SYNO.SDS.Backup.GetServerName(b);var a=SYNO.SDS.Backup.GetServerIP(b);var d="";if(c.length){d=c}else{if(a.length){d=a}}this.getForm().findField("serverInfo").setValue(d)},userInputDirectory:function(){this.userInputDirectoryFlag=true},defaultDirectoryUpdate:function(){var d;var c;var a=this.owner.PanelDestNet.getForm().findField("server").getRawValue();if(this.userInputDirectoryFlag){return}d={};d.action="getremotedestdirectory";d.user=this.owner.PanelDestNet.getForm().findField("account").getRawValue();d.password=this.owner.PanelDestNet.getForm().findField("password").getRawValue();d.ssh_enable="0";d.servertype="synology";d.server=SYNO.SDS.Backup.GetServerName(a);d.ip=SYNO.SDS.Backup.GetServerIP(a);d.share=this.getForm().findField("remoteShare").getRawValue();c=this.getForm().findField("destDirectory");var b=this.owner;b.setStatusBusy({text:_T("netbackup","netbkp_wait_server")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:d,callback:function(g,h,f){b.clearStatusBusy();var e;if(h&&f.responseText){e=Ext.util.JSON.decode(f.responseText);if(!e.success){b.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}else{c.setValue(e.defaultDirectory)}}else{b.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}}})}});Ext.define("SYNO.SDS.Backup.SchedulePanel",{extend:"SYNO.ux.FormPanel",isLoaded:false,advanceScheduleDialog:null,weekArray:null,oldAdvanceSchedule:null,constructor:function(b){var e=false;var d=Ext.getCmp("btnTaskRestore");if("edit"===b.mode||(d&&d.disabled)){e=true}this.weekArray=SYNO.SDS.Backup.WeekArray;var c=new Ext.data.SimpleStore({fields:["value","display"],data:this.weekArray});var a={title:Ext.util.Format.ellipsis(_T("usbbackup","usbbkp_schedule"),15),tabTip:_T("usbbackup","usbbkp_schedule"),padding:"20px",items:[{xtype:"syno_checkbox",boxLabel:_T("netbackup","netbkp_set_schedule"),name:"schedule_enable"},{xtype:"syno_radio",name:"schedule_type",inputValue:"basic",boxLabel:_T("schedule","schedule_basic"),checked:true,indent:1},{xtype:"syno_compositefield",hideLabel:true,fieldLabel:"composite field",name:"basic_time",indent:2,items:[{xtype:"syno_displayfield",value:_T("time","time_day")},{xtype:"syno_combobox",name:"basic_weekday",store:c,displayField:"display",valueField:"value",width:90},{border:false,width:50},{xtype:"syno_displayfield",value:_T("time","time_hour")},{xtype:"syno_combobox",name:"hour",displayField:"display",valueField:"value",store:SYNO.SDS.Backup.createTimeItemStore("hour"),width:70},{border:false,width:10},{xtype:"syno_displayfield",value:_T("time","time_minute")},{xtype:"syno_combobox",name:"minute",displayField:"display",valueField:"value",store:SYNO.SDS.Backup.createTimeItemStore("min"),width:70}]},{xtype:"syno_radio",name:"schedule_type",inputValue:"advance",boxLabel:_T("schedule","schedule_advance"),checked:false,indent:1},{xtype:"syno_button",id:"btn_schedule",name:"btn_schedule",text:_T("schedule","schedule_title"),handler:this.launchScheduleDialog,scope:this,indent:2},{xtype:"syno_displayfield",name:"txtadvscheduletime",labelSeparator:"",value:"",style:"margin-left: 80px"},{xtype:"syno_displayfield",name:"txtadvscheduleday",labelSeparator:"",value:"",style:"margin-left: 80px"},{xtype:"syno_checkbox",name:"bkpnow",hidden:e,boxLabel:_T("localbkpwizard","wizard_start_backup")}]};Ext.apply(a,b);this.callParent([a]);this.mon(this,"afterlayout",function(f,g){var h;h=new SYNO.ux.Utils.EnableCheckGroup(f.getForm(),"schedule_enable",["schedule_type","basic_weekday","hour","minute","btn_schedule"]);h=new SYNO.ux.Utils.EnableRadioGroup(f.getForm(),"schedule_type",{basic:["basic_weekday","hour","minute"],advance:["btn_schedule"]});this.getForm().findField("schedule_type").on("check",function(i,j){if("basic"===i.getGroupValue()){this.getForm().findField("txtadvscheduletime").setValue("");this.getForm().findField("txtadvscheduleday").setValue("")}},this)},this,{single:true})},advSchedulePrint:function(b){var a=this.getForm().findField("txtadvscheduletime");var c=this.getForm().findField("txtadvscheduleday");a.setValue(this.timeScheduleToString(b));c.setValue(this.dateScheduleToString(b))},setOldAdvanceSchedule:function(a){this.oldAdvanceSchedule=a},afterScheduleDialog:function(){if(this.owner.schedule){this.owner.schedule=this.deConstructJson(this.owner.schedule);this.oldAdvanceSchedule=this.owner.schedule;this.advSchedulePrint(this.owner.schedule)}},launchScheduleDialogDone:function(b,d,c){this.advanceScheduleDialog=new SYNO.SDS.TaskScheduler2.ScheduleDialog({title:_T("schedule","schedule_advance"),owner:this.owner});this.advanceScheduleDialog.mon(this.advanceScheduleDialog,"hide",this.afterScheduleDialog,this);var a=Ext.util.JSON.decode(c.responseText);if(d&&c.responseText){this.owner.clearStatusBusy();if(a.success){this.advanceScheduleDialog.onOpen(this.reConstructJson(a.task.schedule))}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}},launchScheduleDialog:function(){var b;if(this.oldAdvanceSchedule){b=new SYNO.SDS.TaskScheduler2.ScheduleDialog({title:_T("schedule","schedule_advance"),owner:this.owner});b.mon(b,"hide",this.afterScheduleDialog,this);b.open(this.reConstructJson(this.oldAdvanceSchedule))}else{var a={};a.action="loadDefaultAdvSchedule";this.owner.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:a,callback:this.launchScheduleDialogDone,scope:this},this)}},loadForm:function(b){if(b){this.getForm().loadRecord(b);if(false===b.data.schedule_enable){var a=Ext.getCmp("btn_schedule");a.disable();this.getForm().findField("basic_weekday").disable();this.getForm().findField("hour").disable();this.getForm().findField("minute").disable()}else{if("advance"===b.data.schedule_type&&this.oldAdvanceSchedule){this.advSchedulePrint(this.oldAdvanceSchedule)}}}},activate:function(){if(false===this.isLoaded){var a={};var b={};a.schedule_enable=false;a.schedule_type="basic";a.basic_weekday="1";a.hour=0;a.minute=0;b.data=a;this.loadForm(b);this.getForm().findField("basic_weekday").disable();this.getForm().findField("hour").disable();this.getForm().findField("minute").disable();this.isLoaded=true}},getNext:function(){var b;var a;a=this.getForm().findField("schedule_type").getGroupValue()==="basic"?true:false;if(a){b=this.getScheduleData();this.owner.schedule=b.schedule;this.owner.enableschedule=b.enableschedule}else{this.owner.enableschedule=this.getForm().findField("schedule_enable").getValue()}return this.nextId},summary:function(a){var b;var c=this.owner.schedule;if(!this.getForm().findField("schedule_enable").getValue()){a.append(_T("netbackup","netbkp_schedule"),_T("netbackup","netbkp_no_schedule"))}else{b=this.timeScheduleToString(c)+" "+this.dateScheduleToString(c);a.append(_T("netbackup","netbkp_schedule"),b)}},getScheduleData:function(){var f=[];var d;var e=this.getForm();var c;f.enableschedule=e.findField("schedule_enable").getValue();c=e.findField("schedule_type").getGroupValue()==="basic"?true:false;if(c){var b=e.findField("basic_weekday").getValue();var a=e.findField("hour").getValue();var g=e.findField("minute").getValue();d={};d.date_type=0;d.repeat=0;d.hour=a;d.min=g;d.repeat_hour=0;d.last_work_hour=a;d.week_name=String(b)}else{if(this.oldAdvanceSchedule){d=this.deConstructJson(this.oldAdvanceSchedule)}else{d={};d.date_type=0;d.repeat=0;d.hour=0;d.min=0;d.repeat_hour=0;d.last_work_hour=0;d.week_name="0,1,2,3,4,5,6"}}f.schedule=d;return f},reConstructJson:function(b){var a=b;if(a.minute===undefined){a.minute=a.min}if(a.week_day===undefined){a.week_day=a.week_name}if(a.repeat_date===undefined){a.repeat_date=a.repeat}return a},deConstructJson:function(b){var a=b;if(a.min===undefined){a.min=a.minute}if(a.week_name===undefined){a.week_name=a.week_day}if(a.repeat===undefined){a.repeat=a.repeat_date}return a},dateScheduleToString:function(a){return SYNO.SDS.Backup.DateScheduleToString(a)},timeScheduleToString:function(a){return SYNO.SDS.Backup.TimeScheduleToString(a)}});Ext.define("SYNO.SDS.Backup.LUNBackupWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",rcvr_step:null,selfIPs:null,selfHostName:null,PanelWelcome:null,PanelTaskName:null,PanelDestType:null,PanelDestLocal:null,PanelDestNet:null,PanelDestShare:null,PanelLUNSource:null,PanelSchedule:null,PanelSummary:null,taskName:null,taskType:null,taskDest:null,schedule:null,bkpNow:false,remoteShareStore:null,remoteShare:null,lunSourceStore:null,lunSource:null,lunSourceSize:null,bkpDir:null,blDestChanged:true,blBkpLUNChanged:false,excuteConfirm:1,constructor:function(b){var c=SYNO.SDS.Backup;this.remoteShareList=[];this.lunSourceList=[];this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_T("lunbkp","backup_welcome_title"),description:_T("backup","welcome"),itemId:"welcome",nextId:"taskname",leftTitle:"LUN Backup Wizard",owner:this});this.PanelTaskName=new c.TaskNamePanel({headline:_T("localbkpwizard","backup_set_title"),description:_T("localbkpwizard","backup_set_desc"),itemId:"taskname",nextId:"desttype",header:false,grid:b.grid,sourceType:"LUN",owner:this});this.PanelDestType=new c.LUNDestTypePanel({headline:_T("backup","wizard_desttype_title"),description:_T("backup","bkpwizard_type_title"),itemId:"desttype",nextId:["destlocal","destnet"],header:false,mode:"wizard",owner:this});this.PanelDestLocal=new c.LUNDestLocalPanel({headline:_T("localbkpwizard","select_dest_title"),description:_T("localbkpwizard","select_dest_desc"),itemId:"destlocal",nextId:"lunsource",header:false,mode:"wizard",owner:this});this.PanelDestNet=new c.LUNDestNetPanel({headline:_T("netbackup","netbkp_serverset_title"),description:_T("netbackup","netbkp_serverset1_desc"),itemId:"destnet",nextId:"destshare",header:false,mode:"wizard",owner:this});this.PanelDestShare=new c.LUNDestSharePanel({headline:_T("netbackup","dest_share_title"),description:_T("netbackup","dest_share_desc"),itemId:"destshare",nextId:"lunsource",header:false,mode:"wizard",owner:this});this.PanelLUNSource=new c.LUNSourcePanel({headline:_T("lunbkp","select_lun_title"),description:_T("lunbkp","select_lun_desc"),itemId:"lunsource",nextId:"schedule",header:false,owner:this,mode:"wizard"});this.PanelSchedule=new c.SchedulePanel({headline:_T("usbbackup","usbbkp_schedule_desc1"),description:_T("backup","bkpwizard_sche_title"),itemId:"schedule",nextId:"summary",header:false,mode:"wizard",owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({autoScroll:true,headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.applySetting();return false},owner:this});var a=[this.PanelWelcome,this.PanelTaskName,this.PanelDestType,this.PanelDestLocal,this.PanelDestNet,this.PanelDestShare,this.PanelLUNSource,this.PanelSchedule,this.PanelSummary];b=Ext.apply({title:_T("lunbkp","bkpwizard_title"),width:600,height:490,steps:a},b);this.callParent([b]);this.setActiveStep("welcome")},genApplyParams:function(){var a={};a.action="applylun";a.mode="create";a.oldbkpset="";a.newbkpset=this.taskName;a.bkptype=this.taskType;a.lunsource=this.lunSource;a.lunsize=this.lunSourceSize;a.scheduleEnable=this.enableschedule;a.schedule=this.schedule;a.bkpnow=this.PanelSchedule.getForm().findField("bkpnow").getValue();if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.taskType){a.dest=this.taskDest;a.desttype=SYNO.SDS.Backup.BKP_DEST_TYPE_LOCLUN}else{a.servertype=SYNO.SDS.Backup.BKP_DEST_TYPE_SYNO;a=this.PanelDestNet.getParamsVal(a,"create");a.dest=this.PanelDestShare.getForm().findField("remoteShare").getValue()+"/"+this.directory;this.PanelDestNet.getParamsVal(a)}return Ext.util.JSON.encode(a)},applyDone:function(b,d,a){this.clearStatusBusy();if(d){var c=Ext.decode(a.responseText);if(null!==c&&true===c.success){this.close()}else{if(c.errinfo){if("dir_in_used"===c.err_type){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","backup_dest_directory_not_available"))}else{this.getMsgBox().alert(_T("tree","leaf_backup"),_T(c.errinfo.sec,c.errinfo.key))}}}}else{this.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","commfail"))}},sendRequest:function(){var a=this.genApplyParams();this.setStatusBusy({text:_T("common","saving")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:a,callback:this.applyDone,scope:this})},applySetting:function(){this.sendRequest()},Show:function(a){this.rcvr_step=a;Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"selfhost"},callback:function(d,e,c){if(e&&c.responseText){var b=Ext.util.JSON.decode(c.responseText);this.selfIPs=b.selfIPs;this.selfHostName=b.selfHostName}},scope:this},this);this.open()},getURL:function(a){return this.owner.getURL(a)}});SYNO.SDS.Backup.ERR_INVALID_PARAM=4400;SYNO.SDS.Backup.ERR_INTERNAL_ERROR=4401;SYNO.SDS.Backup.ERR_SNAPSHOT_RESTORING=4407;SYNO.SDS.Backup.ERR_RESTORING=4408;SYNO.SDS.Backup.ERR_BACKING_UP_RESTORING=4409;SYNO.SDS.Backup.ERR_SERVICCE_PORT_CONFLICT=4410;SYNO.SDS.Backup.ERR_TARGET_ID_NOT_VALID=4411;SYNO.SDS.Backup.ERR_APP_VERSION_INVALID=4412;SYNO.SDS.Backup.ERR_SHARE_LIST_FAIL=4413;SYNO.SDS.Backup.ERR_APP_MYSQL_PWD=4415;SYNO.SDS.Backup.ERR_CONFIG_OPERATE_ADMIN=4416;SYNO.SDS.Backup.ERR_APP_SURVEILLANCE_ENABLE=4417;SYNO.SDS.Backup.ERR_TARGET_BUSY_ROLLBACK=4418;SYNO.SDS.Backup.ERR_TARGET_NEED_ROLLBACK=4419;SYNO.SDS.Backup.ERR_TARGET_BUSY_BACKUP=4420;SYNO.SDS.Backup.ERR_TARGET_BUSY_RESTORE=4421;SYNO.SDS.Backup.ERR_TARGET_BUSY_VERSION_DEL=4422;SYNO.SDS.Backup.ERR_TARGET_BUSY_TARGET_DEL=4423;SYNO.SDS.Backup.ERR_TARGET_BUSY_REPO_DEL=4424;SYNO.SDS.Backup.ERR_TARGET_BUSY=4425;SYNO.SDS.Backup.ERR_APP_MYSQL_ENABLE=4426;SYNO.SDS.Backup.ERR_APP_MYSQL_VOLUME_CRASH=4427;SYNO.SDS.Backup.ERR_CONFIG_VERSION_WRONG=4428;SYNO.SDS.Backup.ERR_CONFIG_VERSION_FUTURE=4429;SYNO.SDS.Backup.ERR_NO_AVAILABLE_VERSION=4430;SYNO.SDS.Backup.ERR_RESTORE_VOLUME_BUILDING=4431;SYNO.SDS.Backup.ERR_RESTORE_VOLUME_NONE=4432;SYNO.SDS.Backup.ERR_REPOSITORY_NOT_EXIST=4433;SYNO.SDS.Backup.ERR_REPOSITORY_NO_SPACE=4434;SYNO.SDS.Backup.ERR_CONFIG_RESTORING=4435;SYNO.SDS.Backup.ERR_CONFIG_NO_SPACE=4436;SYNO.SDS.Backup.ERR_CONFIG_WRONG_FORMAT=4437;SYNO.SDS.Backup.ERR_CONFIG_PORT_CONFLICT=4438;SYNO.SDS.Backup.ERR_CONFIG_SERVICE_FAIL=4439;SYNO.SDS.Backup.ERR_IMGBKP_CONNECT_FAIL=4440;SYNO.SDS.Backup.ERR_IMGBKP_AUTH_FAIL=4441;SYNO.SDS.Backup.ERR_IMGBKP_CLIENT_VERSION_TOO_OLD=4442;SYNO.SDS.Backup.ERR_IMGBKP_SERVER_VERSION_TOO_OLD=4443;SYNO.SDS.Backup.ERR_IMGBKP_IP_DENIED=4444;SYNO.SDS.Backup.ERR_IMGBKP_AUTH_NOT_ALLOW=4445;SYNO.SDS.Backup.ERR_BACKUP_TARGET_CHECKING=4446;SYNO.SDS.Backup.ERR_BACKUP_TARGET_BROKEN=4447;SYNO.SDS.Backup.ERR_RESTORE_TARGET_CHECKING=4448;SYNO.SDS.Backup.ERR_RESTORE_TARGET_BROKEN=4449;SYNO.SDS.Backup.ERR_SERVER_NO_VOLUME=4450;SYNO.SDS.Backup.ERR_SERVER_NO_SHARE=4451;SYNO.SDS.Backup.ERR_RSYNC_SERVER_OFFLINE=4452;SYNO.SDS.Backup.ERR_SERVER_NAME_ERROR=4453;SYNO.SDS.Backup.ERR_GENERAL_SERVER_OFFLINE=4455;SYNO.SDS.Backup.ERR_SHARE_NOT_FOUND=4456;SYNO.SDS.Backup.ERR_SERVER_NO_RESPONSE=4457;SYNO.SDS.Backup.ERR_GERNALE_SERVER_CONNECT_FAIL=4458;SYNO.SDS.Backup.ERR_INVALID_ARGUMENT=4460;SYNO.SDS.Backup.ERR_WRONG_ACCESS_KEY=4461;SYNO.SDS.Backup.ERR_INSTANCE_PROFILE_CREDENTIAL=4462;SYNO.SDS.Backup.ERR_WRONG_SECRET_KEY=4463;SYNO.SDS.Backup.ERR_ACCESS_DENIED=4464;SYNO.SDS.Backup.ERR_BUCKET_EXISTED=4465;SYNO.SDS.Backup.ERR_BUCKET_IP_TYPE=4466;SYNO.SDS.Backup.ERR_BUCKET_NAME_FIRST_CHAR=4467;SYNO.SDS.Backup.ERR_BUCKET_NAME_INVALID_CHAR=4468;SYNO.SDS.Backup.ERR_TIME_SKEWED=4469;SYNO.SDS.Backup.ERR_NAME_LOOKUP=4470;SYNO.SDS.Backup.ERR_S3_NO_BUCKET=4471;SYNO.SDS.Backup.ERR_BUCKET_TOO_MANY=4472;SYNO.SDS.Backup.ERR_SSL_VERIFY_FAIL=4476;SYNO.SDS.Backup.ERR_VERSION_LOCKED=4477;SYNO.SDS.Backup.ERR_USER_EXCEED_MAX=4478;SYNO.SDS.Backup.ERR_GROUP_EXCEED_MAX=4479;SYNO.SDS.Backup.ERR_RSYNC_DISCONNECT=4480;SYNO.SDS.Backup.ERR_RSYNC_UNSTABLE_NETWORK=4481;SYNO.SDS.Backup.ERR_RSYNC_AUTH_FAIL=4482;SYNO.SDS.Backup.ERR_RSYNC_SSH_FAIL=4483;SYNO.SDS.Backup.ERR_RSYNC_PERM_DENIED=4484;SYNO.SDS.Backup.ERR_RSYNC_IP_DENIED=4485;SYNO.SDS.Backup.ERR_RSYNC_NETBKP_DISABLE=4486;SYNO.SDS.Backup.ERR_RSYNC_SSH_DISABLE=4487;SYNO.SDS.Backup.ERR_RSYNC_BAD_MODULE=4488;SYNO.SDS.Backup.ERR_RSYNC_BAD_OPTION=4489;SYNO.SDS.Backup.ERR_RSYNC_PARTIAL=4490;SYNO.SDS.Backup.ERR_NO_TARGET_PERMISSION=4454;SYNO.SDS.Backup.ERR_NO_REPO_PERMISSION=4459;SYNO.SDS.Backup.ERR_NOT_OWNER=4491;SYNO.SDS.Backup.ERR_IMGBKP_NO_APP_PERMISSION=4492;SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_NETWORK=4493;SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_APP_VOLUME=4494;SYNO.SDS.Backup.ERR_REPOSITORY_EXIST=4495;SYNO.SDS.Backup.ERR_APP_OCCUPIED=4496;SYNO.SDS.Backup.ERR_APP_NO_SPACE=4497;SYNO.SDS.Backup.ERR_NO_VOLUME_TO_VOUME=4498;SYNO.SDS.Backup.ERR_NOT_SUP_RESTORE_ENC=4499;SYNO.SDS.Backup.ERR_DISALLOW_DEMOSITE=116;SYNO.SDS.Backup.GetErrorString=function(a){switch(a){case SYNO.SDS.Backup.ERR_INVALID_PARAM:return _T("common","error_system");case SYNO.SDS.Backup.ERR_RESTORING:return _T("backup","is_restoring");case SYNO.SDS.Backup.ERR_BACKING_UP_RESTORING:return _T("backup","is_backing_up_restoring");case SYNO.SDS.Backup.ERR_SNAPSHOT_RESTORING:return _T("share","share_snapshot_restore_running");case SYNO.SDS.Backup.ERR_SERVICCE_PORT_CONFLICT:return _T("error","error_port_conflict");case SYNO.SDS.Backup.ERR_WRONG_ACCESS_KEY:return _T("backup","cloud_auth_fail_time_skew");case SYNO.SDS.Backup.ERR_INVALID_ARGUMENT:case SYNO.SDS.Backup.ERR_INSTANCE_PROFILE_CREDENTIAL:return _T("netbackup","s3_access_key_err");case SYNO.SDS.Backup.ERR_WRONG_SECRET_KEY:return _T("netbackup","s3_secret_key_err");case SYNO.SDS.Backup.ERR_ACCESS_DENIED:return _T("backup","permission_denied");case SYNO.SDS.Backup.ERR_BUCKET_EXISTED:return _T("netbackup","s3_bucket_existed");case SYNO.SDS.Backup.ERR_BUCKET_IP_TYPE:case SYNO.SDS.Backup.ERR_BUCKET_NAME_FIRST_CHAR:case SYNO.SDS.Backup.ERR_BUCKET_NAME_INVALID_CHAR:return _T("netbackup","s3_bucket_name_invalid");case SYNO.SDS.Backup.ERR_TIME_SKEWED:return _T("netbackup","s3_time_skewed_err");case SYNO.SDS.Backup.ERR_NAME_LOOKUP:return _T("netbackup","s3_name_look_up_err");case SYNO.SDS.Backup.ERR_S3_NO_BUCKET:return _T("netbackup","s3_bucket_not_exist");case SYNO.SDS.Backup.ERR_BUCKET_TOO_MANY:return _T("backup","s3_bucket_number_limit");case SYNO.SDS.Backup.ERR_SHARE_LIST_FAIL:return _T("netbackup","netbkp_connection_testing_fail");case SYNO.SDS.Backup.ERR_CONFIG_OPERATE_ADMIN:return _T("confbackup","confbkp_operating_user");case SYNO.SDS.Backup.ERR_CONFIG_VERSION_WRONG:return _T("confbackup","confbkp_failed_get_conf_file");case SYNO.SDS.Backup.ERR_CONFIG_VERSION_FUTURE:return _T("confbackup","confbkp_error_version");case SYNO.SDS.Backup.ERR_CONFIG_RESTORING:return _T("confbackup","bkp_is_processing");case SYNO.SDS.Backup.ERR_CONFIG_NO_SPACE:return _T("confbackup","upload_err_no_space");case SYNO.SDS.Backup.ERR_CONFIG_WRONG_FORMAT:return _T("confbackup","upload_err_format");case SYNO.SDS.Backup.ERR_CONFIG_PORT_CONFLICT:return _T("confbackup","confbkp_port_conflict");case SYNO.SDS.Backup.ERR_CONFIG_SERVICE_FAIL:return _T("confbackup","import_fail");case SYNO.SDS.Backup.ERR_APP_MYSQL_PWD:return _T("backup","error_bad_maria_db_pass");case SYNO.SDS.Backup.ERR_APP_MYSQL_ENABLE:return _T("backup","maria_db_no_enable");case SYNO.SDS.Backup.ERR_APP_MYSQL_VOLUME_CRASH:return _T("backup","maria_db_volume_crash");case SYNO.SDS.Backup.ERR_APP_SURVEILLANCE_ENABLE:return _T("backup","stop_surveillance_first");case SYNO.SDS.Backup.ERR_APP_VERSION_INVALID:return _T("backup","app_version_invalid");case SYNO.SDS.Backup.ERR_APP_OCCUPIED:return _T("pkgmgr","error_occupied");case SYNO.SDS.Backup.ERR_APP_NO_SPACE:return _T("backup","local_no_space");case SYNO.SDS.Backup.ERR_SERVER_NO_VOLUME:return _T("share","error_volume_not_found");case SYNO.SDS.Backup.ERR_SERVER_NO_SHARE:return _T("netbackup","err_create_service_share");case SYNO.SDS.Backup.ERR_RSYNC_SERVER_OFFLINE:return _T("netbackup","netbkp_e_disconnect");case SYNO.SDS.Backup.ERR_SERVER_NAME_ERROR:return _T("backup","err_server_name");case SYNO.SDS.Backup.ERR_NO_TARGET_PERMISSION:return _T("backup","no_target_permission_action");case SYNO.SDS.Backup.ERR_NO_REPO_PERMISSION:return _T("backup","no_repo_permission_action");case SYNO.SDS.Backup.ERR_GENERAL_SERVER_OFFLINE:return _T("backup","general_backup_destination_disconnect");case SYNO.SDS.Backup.ERR_SERVER_NO_RESPONSE:return _T("backup","general_backup_destination_no_response");case SYNO.SDS.Backup.ERR_GERNALE_SERVER_CONNECT_FAIL:return _T("backup","general_backup_destination_connect_fail");case SYNO.SDS.Backup.ERR_RSYNC_DISCONNECT:return _T("netbackup","netbkp_network_disconnect");case SYNO.SDS.Backup.ERR_RSYNC_UNSTABLE_NETWORK:return _T("netbackup","netbkp_e_network_unstable");case SYNO.SDS.Backup.ERR_IMGBKP_AUTH_FAIL:return _T("backup","imgbkp_account_pass_fail");case SYNO.SDS.Backup.ERR_IMGBKP_AUTH_NOT_ALLOW:return _T("backup","imgbkp_account_not_allowed");case SYNO.SDS.Backup.ERR_BACKUP_TARGET_CHECKING:return _T("backup","err_backup_checking_task");case SYNO.SDS.Backup.ERR_BACKUP_TARGET_BROKEN:return _T("backup","err_backup_broken_task");case SYNO.SDS.Backup.ERR_RESTORE_TARGET_CHECKING:return _T("backup","err_ver_browse_checking_task");case SYNO.SDS.Backup.ERR_RESTORE_TARGET_BROKEN:return _T("backup","err_ver_browse_broken_task");case SYNO.SDS.Backup.ERR_RSYNC_AUTH_FAIL:return _T("netbackup","netbkp_account_pass_fail");case SYNO.SDS.Backup.ERR_RSYNC_SSH_FAIL:return _T("netbackup","netbkp_e_ssh_disconnected");case SYNO.SDS.Backup.ERR_RSYNC_PERM_DENIED:return _T("netbackup","err_share_perm_denied");case SYNO.SDS.Backup.ERR_IMGBKP_IP_DENIED:case SYNO.SDS.Backup.ERR_RSYNC_IP_DENIED:return _T("netbackup","err_ip_denied");case SYNO.SDS.Backup.ERR_RSYNC_NETBKP_DISABLE:return _T("netbackup","err_privilege_not_granted");case SYNO.SDS.Backup.ERR_RSYNC_SSH_DISABLE:return _T("netbackup","netbkp_e_no_service2");case SYNO.SDS.Backup.ERR_RSYNC_BAD_MODULE:return _T("netbackup","netbkp_e_rsync_bad_module");case SYNO.SDS.Backup.ERR_RSYNC_BAD_OPTION:return _T("netbackup","netbkp_e_rsync_bad_option");case SYNO.SDS.Backup.ERR_RSYNC_PARTIAL:return _T("netbackup","err_share_perm_denied");case SYNO.SDS.Backup.ERR_TARGET_BUSY:return _T("backup","target_busy");case SYNO.SDS.Backup.ERR_TARGET_BUSY_ROLLBACK:return _T("backup","target_busy_rollback");case SYNO.SDS.Backup.ERR_TARGET_NEED_ROLLBACK:return _T("backup","target_busy_protect_rollback");case SYNO.SDS.Backup.ERR_TARGET_BUSY_BACKUP:return _T("backup","target_busy_backup");case SYNO.SDS.Backup.ERR_TARGET_BUSY_RESTORE:return _T("backup","target_busy_restore");case SYNO.SDS.Backup.ERR_TARGET_BUSY_VERSION_DEL:return _T("backup","target_busy_version_delete");case SYNO.SDS.Backup.ERR_TARGET_BUSY_TARGET_DEL:return _T("backup","target_process_delete");case SYNO.SDS.Backup.ERR_TARGET_BUSY_REPO_DEL:return _T("backup","target_process_repo_delete");case SYNO.SDS.Backup.ERR_IMGBKP_CONNECT_FAIL:return _T("backup","imgbkp_connect_fail");case SYNO.SDS.Backup.ERR_NO_AVAILABLE_VERSION:return _T("backup","no_avail_version");case SYNO.SDS.Backup.ERR_RESTORE_VOLUME_BUILDING:return _T("common","err_creating_volume");case SYNO.SDS.Backup.ERR_RESTORE_VOLUME_NONE:return _T("share","error_volume_not_found");case SYNO.SDS.Backup.ERR_REPOSITORY_NOT_EXIST:return _T("backup","repo_not_exist");case SYNO.SDS.Backup.ERR_REPOSITORY_EXIST:return _T("backup","repo_exist");case SYNO.SDS.Backup.ERR_REPOSITORY_NO_SPACE:return _T("backup","repo_no_space");case SYNO.SDS.Backup.ERR_SHARE_NOT_FOUND:return _T("share","no_such_share");case SYNO.SDS.Backup.ERR_TARGET_ID_NOT_VALID:return _T("backup","backup_dest_directory_not_available");case SYNO.SDS.Backup.ERR_IMGBKP_CLIENT_VERSION_TOO_OLD:return _T("backup","img_client_ver_old");case SYNO.SDS.Backup.ERR_IMGBKP_SERVER_VERSION_TOO_OLD:return _T("backup","img_server_ver_old");case SYNO.SDS.Backup.ERR_DISALLOW_DEMOSITE:return _T("common","error_demo");case SYNO.SDS.Backup.ERR_NOT_OWNER:return _T("backup","error_not_owner_backup");case SYNO.SDS.Backup.ERR_IMGBKP_NO_APP_PERMISSION:return _T("backup","imgbkp_no_app_privilege");case SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_NETWORK:return _T("common","commfail");case SYNO.SDS.Backup.ERR_WEBAPI_BACKUP_ERR_APP_VOLUME:return String.format(_T("backup","app_no_volume"),"EXT3/EXT4");case SYNO.SDS.Backup.ERR_NO_VOLUME_TO_VOUME:return String.format(_T("backup","img_no_volume"),"EXT3/EXT4");case SYNO.SDS.Backup.ERR_VERSION_LOCKED:return _T("backup","version_lock_delete_fail");case SYNO.SDS.Backup.ERR_USER_EXCEED_MAX:return _T("confbackup","confbkp_user_exceed_max");case SYNO.SDS.Backup.ERR_GROUP_EXCEED_MAX:return _T("confbackup","confbkp_group_exceed_max");case SYNO.SDS.Backup.ERR_NOT_SUP_RESTORE_ENC:return _T("backup","not_support_restore_to_encrypted_share");default:return _T("common","error_system")}};Ext.define("SYNO.SDS.Backup.LUNDestEditPanel",{extend:"SYNO.ux.FormPanel",destStore:null,btnTestId:null,ServerStore:null,RemoteStore:null,RsyncModuleStore:null,RegionStore:null,BucketStore:null,BucketKeyed:false,constructor:function(b){this.ServerList=[];this.destList=[];this.RegionList=[];this.BucketList=[];var a=this.initLayout(b);Ext.apply(a,b);this.callParent([a])},initLayout:function(b){var a;if(SYNO.SDS.Backup.BKPTASK_LOCLUN===b.type){a=this.initDestLocal()}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===b.type){a=this.initDestNet(b)}else{SYNO.Debug("Invalid type")}}return a},onLoadLocalDest:function(){this.destList.length=0;var b,a;this.owner.setStatusBusy({text:_T("localbkp","localbkp_wait_dest")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"locallunbkpdest"},scope:this,callback:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){a=Ext.util.JSON.decode(c.responseText);for(b=0;b<a.total;b++){this.destList.push([a.items[b].destValue,a.items[b].dest])}this.destStore.loadData(this.destList,false)}}})},TestServerVersionDone:function(c,d,b){var a;this.owner.clearStatusBusy();if(d&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_success"))}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},TestServerVersion:function(c,e,b){var a;if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){var d={};d.action="remoteversioncheck";d.servertype="synology";d.share="share";d.mode="edit";d=this.getTestconParams(d,true);d.ip=a.ip;Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(d),callback:this.TestServerVersionDone,scope:this},this)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},onTestConnectionButton:function(){var a={};a.action="testconnections";a=this.getTestconParams(a,true);if(a){SYNO.SDS.Backup.onTestSvrConnection(a,this,this.TestServerVersion)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_err_host_str"))}},getTestconParams:function(d,a){var b=this.getForm();var c;var e;if(!b.findField("comboServer").isValid()){return}else{e=b.findField("comboServer");c=e.getRawValue();d.account=b.findField("textAccount").getValue();if(a){d.module=b.findField("remoteShare").getValue()}else{d.module=""}}d.servertype=SYNO.SDS.Backup.LUNBKP_SYNO_SERVER;d.server=SYNO.SDS.Backup.GetServerName(e.getRawValue());d.ip=SYNO.SDS.Backup.GetServerIP(e.getRawValue());if(d.server===""&&d.ip===""){this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_err_host_str"));return}d.password=b.findField("password").getValue();d.ssh_enable=false;d.bkpset=this.owner.taskNameOrig;return d},remoteShareEnumDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("share","share_remote_volume"),_T(a.errinfo.sec,a.errinfo.key));return}for(var b=0;b<a.items.length;b++){this.RemoteList.push([a.items[b].share,a.items[b].share])}this.RemoteStore.loadData(this.RemoteList,false);if((0<this.RemoteList.length)){if(""===this.getForm().findField("remoteShare").getValue()){this.getForm().findField("remoteShare").setValue(this.RemoteList[0][0])}}else{this.owner.getMsgBox().alert(_T("share","share_remote_volume"),_T("common","error_system"))}}else{this.owner.getMsgBox().alert(_T("share","share_remote_volume"),_T("common","error_system"))}},remoteShareEnum:function(a){this.RemoteList.length=0;this.owner.setStatusBusy({text:_T("netbackup","netbkp_search_folder")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.remoteShareEnumDone,scope:this},this)},initDestLocal:function(){var b;var a;a=new Ext.data.ArrayStore({id:"value",fields:["value","display"],data:this.destList});this.destStore=a;b={title:Ext.util.Format.ellipsis(_T("localbkp","localbkp_detail_info"),15),tabTip:_T("localbkp","localbkp_detail_info"),items:[{xtype:"syno_textfield",fieldLabel:_T("localbkp","localbkp_bkpset_name"),name:"bkpset",maxlength:SYNO.SDS.Backup.BKPSET_MAX_LEN,vtype:"username",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,allowBlank:false},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("backup","backup_type"),hiddenName:"bkptype_localbkp",name:"bkptype_localbkp",value:_T("lunbkp","local_lunbkp"),labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("backup","backup_restore_source"),name:"lunSource",value:"",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH},{xtype:"syno_combobox",fieldLabel:_T("localbkp","localbkp_dest"),hiddenName:"localDest",name:"localDest",editable:false,store:a,forceSelection:true,allowBlank:false,displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH},{xtype:"syno_textfield",fieldLabel:_T("backup","backup_dest_directory"),name:"destDirectory",allowBlank:false,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,vtype:"sharename"}]};return b},netbkpValidator:function(f){var c=this.owner.selfHostName;var a=this.owner.selfIPs;var d=a.split(",");var e=new RegExp(c,"gi");if(f===a||f==="127.0.0.1"||(f.match(e)&&f.length===c.length)){return _T("netbackup","netbkp_sync_self")}for(var b=0;b<d.length;b++){if(f===d[b]){return _T("netbackup","netbkp_sync_self")}}return true},initDestNet:function(b){var a;this.ServerStore=new Ext.data.SimpleStore({fields:["value","display"],data:this.ServerList});this.RemoteList=[];this.RemoteStore=new Ext.data.SimpleStore({id:"dsRemoteShare",fields:["value","display"],data:this.RemoteList});this.RsyncModuleStore=new Ext.data.SimpleStore({fields:["module"],data:[]});a={title:Ext.util.Format.ellipsis(_T("localbkp","localbkp_detail_info"),15),tabTip:_T("localbkp","localbkp_detail_info"),items:[{xtype:"syno_textfield",fieldLabel:_T("localbkp","localbkp_bkpset_name"),name:"bkpset",maxlength:SYNO.SDS.Backup.BKPSET_MAX_LEN,vtype:"username",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,allowBlank:false},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("backup","backup_type"),hiddenName:"bkptype_localbkp",name:"bkptype_localbkp",value:_T("lunbkp","net_lunbkp"),labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH},{xtype:"syno_combobox",fieldLabel:_T("netbackup","netbkp_set_ip"),hiddenName:"comboServer",name:"comboServer",forceSelection:false,allowBlank:false,emptyText:_T("netbackup","netbkp_input_addr"),editable:true,store:this.ServerStore,displayField:"display",valueField:"value",triggerAction:"all",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,validateOnBlur:true,validationEvent:"blur",mode:"local",onTriggerClick:function(){if(0!==this.getStore().getCount()){if(this.isExpanded()){this.collapse();this.el.focus()}else{this.onFocus({});this.expand();this.el.focus()}}else{this.scope.serverListLoaded=true;this.el.focus();SYNO.SDS.Backup.onLoadSynologyServer(this,this.scope.ServerList,this.scope.owner)}},scope:this},{xtype:"syno_textfield",fieldLabel:_T("netbackup","netbkp_account"),name:"textAccount",emptyText:_T("netbackup","netbkp_input"),labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,validateOnBlur:true,validationEvent:"blur",allowBlank:false,vtype:"username_ext",scope:this,listeners:{change:function(){this.scope.owner.blUserChanged=true}}},{xtype:"syno_textfield",fieldLabel:_T("common","password"),name:"password",inputType:"password",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,scope:this,listeners:{change:function(){this.scope.owner.blUserChanged=true}}},{xtype:"syno_displayfield",hideLabel:false,fieldLabel:_T("backup","backup_restore_source"),name:"lunSource",value:"",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH},{xtype:"syno_combobox",fieldLabel:_T("netbackup","dest_share_folder"),name:"remoteShare",store:this.RemoteStore,allowBlank:false,displayField:"display",valueField:"value",labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,triggerAction:"all",onTriggerClick:function(){var c=function(h,k,g){this.owner.clearStatusBusy();if(k&&g.responseText!==null){var f=Ext.util.JSON.decode(g.responseText);if(f.success){var j={};var e=this.getForm().findField("comboServer").getValue();j.action="lunenumremoteshare";j.task=this.owner.taskNameOrig;j.user=this.getForm().findField("textAccount").getValue();j.password=this.getForm().findField("password").getValue();j.server=SYNO.SDS.Backup.GetServerName(e);j.ip=SYNO.SDS.Backup.GetServerIP(e);j.type="lunbkp";var i=this.getForm().findField("remoteShare");if(i.isExpanded()){i.collapse();i.el.focus()}else{i.onFocus({});i.expand();i.el.focus()}this.remoteShareEnum(j)}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(f.errinfo.sec,f.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}};var d={};d.action="testconnections";d=this.scope.getTestconParams(d,false);if(d){SYNO.SDS.Backup.onTestSvrConnection(d,this.scope,c)}else{this.scope.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_err_host_str"))}},scope:this},{xtype:"syno_textfield",fieldLabel:_T("backup","backup_dest_directory"),itemId:"destDirectory",allowBlank:false,labelWidth:SYNO.SDS.Backup.BKP_DEST_LABEL_WIDTH,width:SYNO.SDS.Backup.BKP_DEST_CONTD_WIDTH,vtype:"sharename"},{xtype:"syno_button",id:this.btnTestId=Ext.id(),labelSeparator:"",name:"testconbtn",hiddenName:"testconbtn",text:_T("netbackup","netbkp_test_connection"),handler:this.onTestConnectionButton,scope:this}]};return a},switchNetLayout:function(a){var b=this.getForm();SYNO.SDS.Utils.DisplayField(b,"comboServer",true);SYNO.SDS.Utils.DisplayField(b,"remoteShare",true)}});Ext.define("SYNO.SDS.Backup.LUNEditDialog",{extend:"SYNO.SDS.ModalWindow",dsShare:null,blSrcChanged:false,blDestChanged:false,blTaskChanged:false,blUserChanged:false,taskNameOrig:null,serverOrg:null,IPOrg:null,taskDestOrg:null,destDirectoryOrg:null,taskName:null,taskType:null,taskDest:null,taskDestType:null,taskShareStr:null,destDirectory:null,lunSource:null,blScheduleLoad:false,blBkpLUNChanged:false,PanelDest:null,PanelSchedule:null,schedule:null,oldSchedule:null,oldScheduleType:null,oldScheduleEnable:null,constructor:function(c){var d=SYNO.SDS.Backup;this.shareList=[];this.PanelDest=new d.LUNDestEditPanel({owner:this,mode:"edit",type:c.type});this.PanelSchedule=new d.SchedulePanel({owner:this,mode:"edit"});var b=new SYNO.ux.TabPanel({activeTab:0,plain:true,items:[this.PanelDest,this.PanelSchedule]});var a={width:600,height:480,minWidth:300,minHeight:250,layout:"fit",closable:true,items:[b],buttons:[{text:_T("common","apply"),itemId:"apply",handler:this.onOk,scope:this},{text:_T("common","cancel"),itemId:"cancel",handler:this.onCancel,scope:this}]};Ext.apply(a,c);this.callParent([a]);this.PanelSchedule.on("activate",function(){this.activateSchedulePanel()},this)},activateSchedulePanel:function(){var a={};var b={};this.blScheduleLoad=true;if("basic"===this.oldScheduleType){a.basic_weekday=this.oldSchedule.week_name;a.hour=this.oldSchedule.hour;a.minute=this.oldSchedule.min}else{if("advance"===this.oldScheduleType){this.PanelSchedule.setOldAdvanceSchedule(this.oldSchedule);a.basic_weekday="1";a.hour=0;a.minute=0}else{a.basic_weekday="1";a.hour=0;a.minute=0}}a.schedule_enable=this.oldScheduleEnable;a.schedule_type=this.oldScheduleType;b.data=a;this.PanelSchedule.loadForm(b)},initDestPanel:function(){if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.taskType){var b=this.PanelDest.getForm();this.taskDestOrg=this.taskDest;this.destDirectoryOrg=this.destDirectory;var a={};a={bkpset:this.taskName,localDest:this.taskDest,destDirectory:this.destDirectory,lunSource:this.lunSource};b.setValues(a);this.taskDestOrg=this.taskDest;this.destDirectoryOrg=this.destDirectory;this.PanelDest.onLoadLocalDest()}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===this.type){this.PanelDest.switchNetLayout(this.type);this.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode({action:"loadlunbkpconf",taskname:this.taskName}),callback:function(h,i,g){this.clearStatusBusy();if(i&&g.responseText!==null){var c=Ext.util.JSON.decode(g.responseText);this.selfIPs=c.selfIPs;this.selfHostName=c.selfHostName;var f={};var e=[];var d="";d=c.items[0].dest;e=d.split("/");f={bkpset:this.taskName,comboServer:c.items[0].ip,textAccount:c.items[0].user,remoteShare:e[0],password:SYNO.SDS.Backup.getFakePass(),destDirectory:e[1],lunSource:this.lunSource};this.PanelDest.getForm().setValues(f);this.serverOrg=SYNO.SDS.Backup.GetServerName(c.items[0].ip);this.IPOrg=SYNO.SDS.Backup.GetServerIP(c.items[0].ip);this.taskDestOrg=e[0];this.destDirectoryOrg=e[1]}},scope:this},this)}else{return false}}this.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"scheduleload",bkpset:this.taskName,bkptype:this.taskType},callback:function(d,f,c){this.clearStatusBusy();if(f&&c.responseText){var e=Ext.util.JSON.decode(c.responseText);this.oldScheduleEnable=e.schedule_enable;this.oldScheduleType=e.schedule_type;if("basic"===e.schedule_type||"advance"===e.schedule_type){this.oldSchedule=e.task.schedule;if(1===this.oldSchedule.date_type){this.oldSchedule.date=this.oldSchedule.date}}else{return}}else{this.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}},scope:this})},load:function(a){this.taskNameOrig=a.get("name");this.taskName=a.get("name");this.taskType=a.get("type");this.lunSource=a.get("bkpdata");if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.taskType){this.taskDest=a.get("dest");this.destDirectory=a.get("destDirectory")}this.setTitle(this.taskName);this.initDestPanel();this.open()},RequestDone:function(b,d,a){this.clearStatusBusy();if(d){if(a.responseText){var c=Ext.util.JSON.decode(a.responseText);if(c.errinfo){this.getMsgBox().alert(_T("tree","leaf_backup"),_T(c.errinfo.sec,c.errinfo.key))}else{this.close()}}}else{this.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","commfail"))}},SendRequest:function(a){this.setStatusBusy(_T("common","saving"));Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:a,callback:this.RequestDone,scope:this})},CheckSetting:function(){var b=this.PanelDest.getForm();var a=this.PanelSchedule.getForm();if(!b.isValid()){return}if(a.findField("schedule_enable").getValue()){if(a.findField("schedule_type").getGroupValue()==="basic"&&(""===a.findField("basic_weekday").getValue()||""===a.findField("hour").getValue()||""===a.findField("minute").getValue())){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("schedule","schedule_warn_nodaysel"));return false}}this.ApplySetting()},CheckChanges:function(){var b=this.PanelDest.getForm();if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.taskType){this.taskDest=b.findField("localDest").getValue();this.destDirectory=b.findField("destDirectory").getValue();if(this.taskDest!==this.taskDestOrg||this.destDirectory!==this.destDirectoryOrg){this.blDestChanged=true}else{this.blDestChanged=false}}else{this.taskDest=b.findField("remoteShare").getValue();this.destDirectory=b.findField("destDirectory").getValue();var d=b.findField("comboServer");var a=SYNO.SDS.Backup.GetServerName(d.getRawValue());var c=SYNO.SDS.Backup.GetServerIP(d.getRawValue());if(this.taskDest!==this.taskDestOrg||this.destDirectory!==this.destDirectoryOrg||(c!==this.IPOrg&&""===this.serverOrg)||((a!==this.serverOrg)&&""!==this.serverOrg)){this.blDestChanged=true}else{this.blDestChanged=false}}},ApplySetting:function(){var e={};e.action="applylun";e.mode="edit";e.oldbkpset=this.taskNameOrig;e.newbkpset=this.PanelDest.getForm().findField("bkpset").getValue();e.srcchanged=this.blSrcChanged;e.destchanged=this.blDestChanged;e.bkptype=this.taskType;e.lunsource=this.lunSource;if(this.blScheduleLoad){if(this.schedule){e.schedule=this.schedule;e.scheduleEnable=this.PanelSchedule.getForm().findField("schedule_enable").getValue()}else{var d=this.PanelSchedule.getScheduleData();e.schedule=d.schedule;e.scheduleEnable=d.enableschedule}}else{e.schedule=this.oldSchedule;e.scheduleEnable=this.oldScheduleEnable}e.bkpnow=this.PanelSchedule.getForm().findField("bkpnow").getValue();var b=this.PanelDest.getForm();if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.taskType){var c=b.findField("localDest");var a=c.getValue();e.dest=a+"/"+b.findField("destDirectory").getValue()}else{var f;e.servertype=this.taskType;e.dest=b.findField("remoteShare").getValue()+"/"+b.findField("destDirectory").getValue()+"/";f=b.findField("comboServer");e.server=SYNO.SDS.Backup.GetServerName(f.getRawValue());e.ip=SYNO.SDS.Backup.GetServerIP(f.getRawValue());e.account=b.findField("textAccount").getValue();e.password=b.findField("password").getValue();e.module=b.findField("remoteShare").getValue()}e=Ext.util.JSON.encode(e);this.SendRequest(e)},TestServerVersionDone:function(c,d,b){var a;this.owner.clearStatusBusy();if(d&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.owner.CheckSetting()}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},onTestConnectionDone:function(c,e,b){if(e&&b.responseText!==null){var a=Ext.util.JSON.decode(b.responseText);if(a.success){var d={};d.action="remoteversioncheck";d.servertype="synology";d.share="share";d.mode="edit";d=this.owner.PanelDest.getTestconParams(d,false);Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(d),callback:this.owner.TestServerVersionDone,scope:this},this)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_connection_testing_fail"))}},onTestConnection:function(){var a={};a.action="testconnections";a=this.PanelDest.getTestconParams(a,false);if(a){SYNO.SDS.Backup.onTestSvrConnection(a,this.PanelDest,this.onTestConnectionDone)}else{this.scope.owner.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","netbkp_err_host_str"))}},onOk:function(){this.CheckChanges();if(SYNO.SDS.Backup.BKPTASK_NETLUN===this.taskType&&(true===this.blDestChanged||true===this.blSrcChanged||true===this.blUserChanged)){this.onTestConnection()}else{this.CheckSetting()}},onCancel:function(){this.close()},getURL:function(a){return this.owner.getURL(a)}});Ext.define("SYNO.SDS.Backup.BackupTaskPage",{extend:"SYNO.ux.Panel",isRestoring:false,constructor:function(a){Ext.copyTo(this,a,"appWin");a=this.fillConfig(a);this.callParent([a]);this.isSnapshotRestoring=false;this.isDownloading=false},fillConfig:function(a){return Ext.apply({border:false,layout:"fit",tbar:this.getToolBar(),items:[this.getView()]},a)},initEvents:function(){this.callParent(arguments);this.mon(this,"resize",this.getView().refresh,this.getView())},getToolBar:function(){if(this.toolbar){return this.toolbar}var a=[{text:_T("lunbkp","data_bkp_task"),useBuffer:true,listeners:{scope:this,click:function(){var b=new SYNO.SDS.Backup.TaskCreateWizard({owner:this.appWin,taskList:this.getStore(),callbacks:{scope:this,apply:function(){this.isLoaded=false;this.isMasked=true;this.appWin.setStatusBusy()}}});this.doDialogOpen(b)}}}];if(this.appWin._D("support_iscsi_lunbkp","no")==="yes"){a.push({text:_T("lunbkp","lun_bkp_task"),useBuffer:true,listeners:{scope:this,click:this.onCreateLUNBackup}})}this.toolbar=new SYNO.ux.Toolbar({items:[{xtype:"syno_button",text:_T("common","create"),menu:{xtype:"syno_menu",items:a}},{xtype:"syno_button",itemId:"btn_edit",text:_T("common","alt_edit"),disabled:true,scope:this,handler:this.onEditBackupTask},{xtype:"syno_button",itemId:"btn_delete",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",text:_T("common","delete"),disabled:true,scope:this,handler:this.onDeleteBackupTask},{xtype:"syno_button",itemId:"btn_cancel",text:_T("common","cancel"),disabled:true,scope:this,handler:this.onBackupCancel},{xtype:"syno_button",itemId:"btn_backup",text:_T("localbkp","localbkp_immediate"),disabled:true,scope:this,handler:this.onBackupNow}]});return this.toolbar},onPageActivate:function(){if(!this.isLoaded){this.appWin.setStatusBusy();this.isMasked=true}this.onStartPolling()},onPageDeactivate:function(){this.onStopPolling()},doDialogOpen:function(a){if(!a){return}this.onStopPolling();this.mon(a,"close",this.onStartPolling,this);a.open()},onStartPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Task",version:1,method:"list",params:{offset:0,limit:-1,additional:["schedule","progress","next_bkp_time","last_bkp_time","last_bkp_result","detail"]}},interval:3,immediate:true,scope:this,status_callback:this.onPollingDone})},onStopPolling:function(){this.pollUnreg(this.pollingID)},onPollingDone:function(d,a,c,b){if(!d){return}this.isRestoring=a.is_restoring;this.isSnapshotRestoring=a.is_snapshot_restoring;this.isDownloading=a.is_downloading;this.isLoaded=true;this.loadTaskList(a);this.setBtnStatus();if(this.isMasked){this.appWin.clearStatusBusy();this.isMasked=false}},getSelectedTask:function(){var a=this.getView().getSelectedRecords();return a[0]},onBackupCancel:function(){var b=this.getSelectedTask();var a=b.get("data_type");this.appWin.getMsgBox().confirm(_T("tree","leaf_backup"),_T("backup","backup_confirm_cancel_task"),function(c){if(c!=="yes"){return}if("lun"===a){this.doLunAction([b],"cancel",true)}else{this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Task",version:1,method:"cancel",params:{task_id:b.get("task_id")},scope:this,callback:function(f,d,e){this.appWin.clearStatusBusy();if(!f){this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(d.code));return}b.set("status","canceling");this.getToolBar().getComponent("btn_cancel").disable();this.getToolBar().getComponent("btn_backup").disable()}})}},this)},onDeleteBackupTask:function(){var a=[];var d=[];var b=this.getView().getSelectedRecords();var c="";Ext.each(b,function(g,e,f){if("lun"===g.get("data_type")){a.push(g)}else{d.push(g)}if(c===""){c+=g.get("name")}else{c+=", ";c+=g.get("name")}},this);this.appWin.getMsgBox().confirmDelete(_T("tree","leaf_backup"),String.format(_T("backup","backup_confirm_delete_task")+"<br />"+Ext.util.Format.htmlEncode(c)),function(e){if(e!=="yes"){return}if(0!==a.length){this.doLunAction(a,"delete")}if(0!==d.length){this.doDeleteBackupTask(d)}},this)},doDeleteBackupTask:function(b){var a=[];Ext.each(b,function(e,c,d){a.push(e.id)},this);this.onStopPolling();this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Task",version:1,method:"delete",params:{task_id_list:a},callback:function(e,c,d){this.appWin.clearStatusBusy();this.onStartPolling();if(!e){this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(c.code));return}},scope:this})},onBackupNow:function(){var b=this.getSelectedTask();var a=b.get("data_type");this.getTopToolbar().getComponent("btn_backup").disable();this.getTopToolbar().getComponent("btn_edit").disable();this.getTopToolbar().getComponent("btn_delete").disable();if("lun"===a){this.doLunAction([b],"bkpnow",true)}else{this.doBackup(b)}},doBackup:function(a){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Task",version:1,method:"backup",params:{task_id:a.get("task_id")},scope:this,callback:this.onBackupDone})},onBackupDone:function(d,b,c){this.appWin.clearStatusBusy();if(!d){this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var a=this.getSelectedTask();a.beginEdit();a.set("status","backup");a.set("step","prebackup");a.set("step_str",SYNO.SDS.Backup.GetBackupStepStr("prebackup"));a.set("status_cls","status-backup");this.getTopToolbar().getComponent("btn_backup").disable();a.endEdit()},onCreateLUNBackup:function(){var a=new SYNO.SDS.Backup.LUNBackupWizard({owner:this.appWin,grid:this.lunStore});this.onStopPolling();this.mon(a,"close",this.onStartPolling,this);a.Show()},doLunAction:function(g,d,e){var c=[];var b=[];var a=[];var f=[];Ext.each(g,function(h){var i=h.get("name");if(SYNO.SDS.Backup.BKPTASK_LOCLUN===h.get("type")){c.push(h.get("name"));a.push(this.lunStore.getById(i).get("bkpdata"))}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===h.get("type")){b.push(h.get("name"));f.push(this.lunStore.getById(i).get("bkpdata"))}}},this);this.AjaxRequest({action:d,locluntasks:c.join(","),loclunnames:a.join(","),netluntasks:b.join(","),netlunnames:f.join(",")},e)},onEditBackupTask:function(){var c=this.getSelectedTask();var b=c.get("data_type");if("lun"===b){this.doLUNEdit(this.lunStore.getById(c.get("name")))}else{var e=(c.get("type").split(":"))[0];var a=(c.get("type").split(":"))[1];var d=new SYNO.SDS.Backup.TaskEditDialog({taskList:this.getStore(),targetType:e,transferType:a,owner:this.appWin,taskId:c.get("task_id"),repoId:c.get("repo_id")});this.mon(d,"close",function(){this.loadSelectedTask(c)},this);this.doDialogOpen(d)}},loadSelectedTask:function(a){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Task.Data",version:1,method:"get",params:{task_id:a.get("task_id"),additional:["progress","schedule","last_bkp_time","last_bkp_result","next_bkp_time"]},scope:this,callback:function(e,b,d){this.appWin.clearStatusBusy();if(!e){this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var c=SYNO.SDS.Backup.TaskDisplayFormat(b);c.bkp_dest=a.get("bkp_dest");c.dest=a.get("dest");c.volume=a.get("volume");c.share=a.get("share");c.bucket=a.get("bucket");this.getStore().loadData({task_list:[c]},true)}})},doLUNEdit:function(a){var b=new SYNO.SDS.Backup.LUNEditDialog({owner:this.appWin,type:a.get("type")});this.onStopPolling();this.mon(b,"close",this.onStartPolling,this);b.load(a)},AjaxRequest:function(b,a){this.appWin.setStatusBusy();if(a){this.onStopPolling()}Ext.Ajax.request({url:this.appWin.getURL("lunbackup.cgi"),params:b,scope:this,callback:function(e,f,d){this.appWin.clearStatusBusy();if(a){this.onStartPolling()}var c;if(f&&d.responseText){c=Ext.util.JSON.decode(d.responseText);if(!c.success){this.appwin.getMsgBox().alert(_T("tree","leaf_backup"),_T(c.errinfo.sec,c.errinfo.key))}}else{this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"))}}})},getView:function(){if(!this.view){var a={store:this.getStore(),owner:this,listeners:{selectionchange:{scope:this,fn:this.setBtnStatus}}};this.view=new SYNO.SDS.Backup.BackupTaskExpandView(a)}return this.view},getStore:function(){if(!this.store){this.store=new SYNO.API.Store({api:"SYNO.Backup.Task",version:1,method:"list",baseParams:{offset:0,limit:-1,additional:["progress","next_bkp_time"]},appWindow:false,reader:new Ext.data.JsonReader({idProperty:"task_id",root:"task_list",totalProperty:"total",fields:[{name:"id",mapping:"task_id"},{name:"task_id",mapping:"task_id"},{name:"repo_id",mapping:"repo_id"},{name:"target_id",mapping:"target_id"},{name:"name",mapping:"name"},{name:"data_type",mapping:"data_type"},{name:"status",mapping:"status"},{name:"type",mapping:"type"},{name:"transfer_type",mapping:"transfer_type"},{name:"target_type",mapping:"target_type"},{name:"next_bkp_time",mapping:"next_bkp_time"},{name:"progress",mapping:"progress"},{name:"processed_size",mapping:"processed_size"},{name:"total_size",mapping:"total_size"},{name:"step",mapping:"step"},{name:"step_str",mapping:"step_str"},{name:"bkp_shares",mapping:"bkp_shares"},{name:"bkp_apps",mapping:"bkp_apps"},{name:"bkp_dest",mapping:"bkp_dest"},{name:"bkp_schedule",mapping:"bkp_schedule"},{name:"last_bkp_time",mapping:"last_bkp_time"},{name:"last_bkp_result",mapping:"last_bkp_result"},{name:"last_bkp_result_str",mapping:"last_bkp_result_str"},{name:"status_cls",mapping:"status_cls"},{name:"deststatus",mapping:"deststatus"},{name:"deststatus_str",mapping:"deststatus_str"},{name:"dest",mapping:"dest"},{name:"volume",mapping:"volume"},{name:"share",mapping:"share"},{name:"bucket",mapping:"bucket"},{name:"server",mapping:"ip"},{name:"transmitted_size",mapping:"transmitted_size"}]})})}return this.store},getLunStore:function(){if(!this.lunStore){this.lunStore=new Ext.data.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"lun_task_list",totalProperty:"total",fields:[{name:"name",mapping:"name"},{name:"type",mapping:"type"},{name:"bkp_dest_type",mapping:"bkp_dest_type"},{name:"bkpdata",mapping:"bkpdata"},{name:"dest",mapping:"dest"},{name:"destDirectory",mapping:"destDirectory"},{name:"deststatus",mapping:"deststatus"},{name:"status",mapping:"status"},{name:"progress",mapping:"progress"}]})})}return this.lunStore},loadTaskList:function(b){var a=[];Ext.each(b.task_list,function(f,d,e){var g,c;if("lun"===f.data_type){a.push(f);f.bkp_shares=f.bkpdata;c=this.getStore().findExact("name",f.name);if(-1!==c){g=this.getStore().getAt(c);f.deststatus=g.get("deststatus");f.deststatus_str=g.get("deststatus_str")}}g=this.getStore().getById(f.task_id);if(g){f.deststatus=g.get("deststatus");f.dest=g.get("dest");f.volume=g.get("volume");f.share=g.get("share");f.bucket=g.get("bucket")}f=SYNO.SDS.Backup.TaskDisplayFormat(f)},this);this.getLunStore().loadData({lun_task_list:a});this.getStore().loadData(b)},setDeleteBtnStatus:function(){if(_S("demo_mode")){this.getTopToolbar().getComponent("btn_delete").disable();return}var a=this.getView().getSelectedRecords();if(0<a.length&&!this.isRestoring&&!this.isSnapshotRestoring&&!this.isDownloading){this.getTopToolbar().getComponent("btn_delete").enable();Ext.each(a,function(d,b,c){if("data"===d.get("data_type")&&"none"!==d.get("status")){this.getTopToolbar().getComponent("btn_delete").disable();return false}if("lun"===d.get("data_type")&&("syncing"===d.get("status")||"waiting"===d.get("status")||"restore"===d.get("status"))){this.getTopToolbar().getComponent("btn_delete").disable();return false}},this)}else{this.getTopToolbar().getComponent("btn_delete").disable()}},setBtnStatus:function(){var b=this.getView().getSelectedRecords();this.setDeleteBtnStatus();var a="";if(0!==b.length){a=b[0].get("status")}if(1===b.length&&!this.isRestoring&&!this.isSnapshotRestoring&&!this.isDownloading&&a!=="backup"&&a!=="syncing"&&a!=="waiting"&&a!=="canceling"){this.getTopToolbar().getComponent("btn_backup").enable();this.getTopToolbar().getComponent("btn_edit").enable()}else{this.getTopToolbar().getComponent("btn_backup").disable();this.getTopToolbar().getComponent("btn_edit").disable()}if(1!==b.length){this.getTopToolbar().getComponent("btn_cancel").disable()}else{if("lun"!==b[0].get("data_type")){if("none"===a){this.getTopToolbar().getComponent("btn_cancel").disable()}else{if("restore"===a){this.getTopToolbar().getComponent("btn_cancel").disable()}else{if("canceling"===a){this.getTopToolbar().getComponent("btn_cancel").disable()}else{this.getTopToolbar().getComponent("btn_cancel").enable()}}}}else{if("waiting"===a||"syncing"===a){this.getTopToolbar().getComponent("btn_cancel").enable()}else{if("restore"===a){this.getTopToolbar().getComponent("btn_cancel").disable()}else{if("canceling"===a){this.getTopToolbar().getComponent("btn_cancel").disable()}else{this.getTopToolbar().getComponent("btn_cancel").disable()}}}}}}});SYNO.SDS.Backup.ScheduleToString=function(c){var a=function(g){var e="";var f=g.week_name;e+=_T("schedule","schedule_date")+": ";if(0===g.date_type){if(f){if("0,1,2,3,4,5,6"===f){e+=_T("schedule","schedule_daily")}else{if("1,2,3,4,5"===f){e+=_T("schedule","schedule_weekdays")}else{if("0,6"===f){e+=_T("schedule","schedule_weekend")}else{e+=SYNO.SDS.Backup.GenWeekString(f)}}}}}else{if(g.date.getMonth){e+=g.date.format("Y/m/d")}else{if(g.date.search("-")!==-1){var d=g.date.replace("-","/");e+=d.replace("-","/").slice(0,10)}else{e+=g.date}}e+=" ";if(1===g.repeat){e+=_T("schedule","repeat_monthly")}else{if(2===g.repeat){e+=_T("schedule","repeat_yearly")}else{e+=_T("schedule","no_repeat")}}}return e};var b=function(e){var d="";d+=_T("schedule","schedule_time")+": ";if(0===e.repeat_hour){d+=String.leftPad(String(e.hour),2,"0")+":"+String.leftPad(String(e.min),2,"0")}else{d+=String.leftPad(String(e.hour),2,"0")+":"+String.leftPad(String(e.min),2,"0")+" ~ "+String.leftPad(String(e.last_work_hour),2,"0")+":"+String.leftPad(String(e.min),2,"0");d+=" "+_T("schedule","schedule_every_each")+" "+e.repeat_hour+" "+_T("schedule","schedule_hour")}return d};return _T("schedule","schedule_already_set")+"<br/>"+b(c)+" "+a(c)};SYNO.SDS.Backup.TaskDisplayFormat=function(i){var f=function(j,l,k){if("backup"===j||"syncing"===j||"waiting"===j||"canceling"===j){return"status-backup"}if(!l||""===k||"modified"===k){return"status-none"}if("success"===k||"done"===k||"partial"===k){return"status-done"}if("cancel"===k){return"status-error"}return"status-error"};var c=function(k,j){if(!k||""===j||"modified"===j){return _T("localbkp","localbkp_not_bkp")}if("success"===j||"done"===j){return _T("usbbackup","usbbkp_succeed")}if("cancel"===j){return _T("common","cancel")}if("partial"===j){return _T("usbbackup","usbbkp_succeed")+'&nbsp(<a class="help_link" href="#">'+_T("backup","attention_required")+"</a>)"}return _T("usbbackup","usbbkp_error")};var a=i.progress?i.progress.progress:0;var b=i.progress?i.progress.step:"none";var e=i.progress?i.progress.processed_size:0;var d=i.progress?i.progress.total_size:0;i.transmitted_size=i.progress?i.progress.transmitted_size:0;i.progress=a;if("canceling"===i.status){i.step="canceling"}else{if("waiting"===i.status){i.step="waiting";i.step_str=SYNO.SDS.Backup.GetBackupStepStr(i.step)}else{i.step=b;i.step_str=SYNO.SDS.Backup.GetBackupStepStr(i.step)}}i.processed_size=SYNO.SDS.Backup.ConverSize(e,2);i.total_size=SYNO.SDS.Backup.ConverSize(d,2);i.status_cls=f(i.status,i.last_bkp_time,i.last_bkp_result);if("backup"!==i.status&&"syncing"!==i.status&&"waiting"!==i.status&&"canceling"!==i.status){i.last_bkp_result_str=c(i.last_bkp_time,i.last_bkp_result)}i.deststatus_str=SYNO.SDS.Backup.GetDestStatusStr(i.deststatus);i.last_bkp_time=i.last_bkp_time?i.last_bkp_time:_T("localbkp","localbkp_not_bkp");i.next_bkp_time=i.next_bkp_time?i.next_bkp_time:_T("widget","no_backup");i.bkp_schedule=i.schedule&&i.schedule.schedule_enable?SYNO.SDS.Backup.ScheduleToString(i.schedule.schedule):_T("widget","no_backup");if(i.source){var h={};Ext.each(i.source.folder_list,function(m,j,l){var k,n=0;var o=m.folderPath.split("/");if(m.dataEncryped&&(2<o.length)){k=o[1];n=1}else{k=m.folderPath.substring(1)}if(k in h){h[k]+=n}else{h[k]=n}},this);var g=[];Ext.iterate(h,function(j,k){if(k>0){g.push(j+"/"+k+" "+_T("backup","folders"))}else{g.push(j)}},this);i.bkp_shares=0!==g.length?g.join(", "):_T("common","none");i.bkp_apps=0!==i.source.app_name_list.length?i.source.app_name_list.join(", "):_T("common","none")}return Ext.apply({},i)};SYNO.SDS.Backup.GetBackupStepStr=function(a){switch(a){case"waiting":return _T("localbkp","localbkp_wait_sync");case"syncing":case"data_backup":return _T("netbackup","netbkp_backuping");case"prebackup":return _T("usbbackup","usbbkp_init");case"config_backup":return _T("backup","bkpstatus_sys");case"app_backup":return _T("backup","bkpstatus_app");case"total_size_count":return _T("localbkp","localbkp_check_dest_size");case"postbackup":return _T("backup","backup_finishing");case"canceling":return _T("backup","backup_do_cancel")}return _T("common","none")};SYNO.SDS.Backup.GetDestStatusStr=function(a){switch(a){case"int_ok":case"online":return _T("usbbackup","usbbkp_online");case"online rsync":return _T("netbackup","netbackup_online_rsync");case"online ssh":return _T("netbackup","netbackup_online_ssh");case"target broken":return _T("backup","err_broken_task");case"normal":return _T("usbbackup","usbbkp_online");case"int_fail":return'<font class="red-status">'+_T("system","none_opt")+"</font>";case"ext_fail":case"offline":return'<font class="red-status">'+_T("usbbackup","usbbkp_offline")+"</font>";case"connected":return _T("netbackup","netbkp_connect");case"disconnected":return'<font class="red-status">'+_T("netbackup","netbkp_disconnect")+"</font>";case"unknow":return _T("backup","getting_dest_status");case"error":return'<font class="red-status">'+_T("error","error_error")+"</font>";default:return'<font class="red-status">'+_T("usbbackup","usbbkp_offline")+"</font>"}};Ext.define("SYNO.SDS.Backup.Restore.TaskExpandView",{extend:"SYNO.SDS.Backup.ExpandableListView",constructor:function(a){a.innerTpl=a.innerTpl||this.getInnerTpl();this.callParent(arguments);this.addClass("syno-backup-restore-listview");this.mon(this,"toggle",this.onToggleClick,this)},createTpl:function(){var b='<div class="syno-backup-usage {step}"><tpl if="processed_size != \'\' && total_size != \'\' && total_size != \'0 B\'"><span style="color:#00AAFF">{processed_size}</span>&nbsp;/&nbsp;{total_size}</tpl><div class="syno-backup-percentage-bar-bg"><div class="syno-backup-percentage-bar" style="width:{progress * 2.2}px"></div></div></div>';var a=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap">','<div class="item-summary">','<div class="item-icon {icon_cls} icon-task"></div>','<div class="syno-backup-restore-icon {status_cls}"></div>',"<div>",'<span class="item-title">{name:htmlEncode}</span>',"<tpl if=\"status == 'restore'\">",'<div class="item-status">{step_str} <span class="syno-backup-restore {step}">'+_T("common","colon")+" {progress}&#37</div></span>","</tpl>","</div>","<tpl if=\"status == 'restore'\">",b,"</tpl>","<tpl if=\"task_id != '-1'\">",(this.innerTpl)?'<div class="item-toggle"><div class="item-toggle-img"></div></div>':"","</tpl>","</div>",'<div class="item-detail" style="display:none">',(this.innerTpl)?this.innerTpl.html:"","</div>","</div>","</tpl>",'<div class="x-clear"></div>');return a},getInnerTpl:function(){var d='<tr><td class="syno-backup-tpl-key">{0}</td><td class="syno-backup-tpl-value">{1}</td></tr>';var c='<tpl if="type == \'share:local\'">ext:qtip="{share:htmlEncode}&nbsp/&nbsp{target_id:htmlEncode}"</tpl><tpl if="type == \'image:image_local\'">ext:qtip="{volume:htmlEncode}"</tpl><tpl if="type == \'image:image_remote\'">ext:qtip="{dest:htmlEncode}&nbsp'+_T("common","colon")+'&nbsp{volume:htmlEncode}"</tpl><tpl if="target_type == \'cloud\'">ext:qtip="{addon_name:htmlEncode}&nbsp'+_T("common","colon")+"&nbsp{bucket:htmlEncode}&nbsp/&nbsp{target_id:htmlEncode}\"</tpl><tpl if=\"type == 'share:rsync_ds' || type == 'share:rsync'\">ext:qtip=\"{dest:htmlEncode}&nbsp"+_T("common","colon")+'&nbsp{share:htmlEncode}&nbsp/&nbsp{target_id:htmlEncode}"</tpl>';var b=String.format(d,_T("usbbackup","usbbkp_backup_shares"),"{bkp_shares:htmlEncode}")+String.format(d,_T("backup","backup_app"),"{bkp_apps:htmlEncode}")+String.format(d,_T("localbkp","localbkp_dest"),"<a "+c+' class="repo_links link-font" href="#">{bkp_dest:htmlEncode}</a>');var e=String.format(d,_T("lunbkp","lun_source"),"{bkp_shares:htmlEncode}")+"<tpl if=\"type == 'netlunbkp' \">"+String.format(d,_T("backup","backup_server_name"),"{server:htmlEncode}")+"</tpl>"+String.format(d,_T("localbkp","localbkp_dest"),'<span class="link-font" href="#">{bkp_dest:htmlEncode}</span>&nbsp(&nbsp{deststatus_str}&nbsp)');var a=new Ext.XTemplate('<div">','<table style="width: 100%;">',"<tpl if=\"data_type != 'lun'\">",b,"</tpl>","<tpl if=\"data_type == 'lun'\">",e,"</tpl>",String.format(d,_T("usbbackup","usbbkp_lasttime"),"{last_bkp_time}"),"</table>","</div>");return a},prepareData:function(c,b,a){var d={loclunbkp:"syno-backup-task-local-lun",netlunbkp:"syno-backup-task-remote-lun","share:local":"syno-backup-task-local-single","image:image_local":"syno-backup-task-local-multi","share:rsync_ds":"syno-backup-task-remote-single","share:rsync":"syno-backup-task-remote-rsync","image:image_remote":"syno-backup-task-remote-multi"};if(c.type in d){c.icon_cls=d[c.type]}else{if(c.target_type==="cloud"){c.icon_cls="syno-backup-task-cloud-"+c.transfer_type;c.addon_name=SYNO.SDS.Backup.Addon.GetStr(c.transfer_type,"addon","name")}else{c.icon_cls="syno-backup-task-local-single"}}if(c.task_id===-1){c.icon_cls="syno-backup-task-retore"}return c},onClick:function(d,c,b){this.callParent(arguments);var a=Ext.fly(c);if(a&&(a.hasClass("repo_links"))){var f=this.getSelectedRecords();if(f[0]){this.owner.appWin.selectPage("SYNO.SDS.Backup.Repository.MainPage");this.owner.appWin.getActivePage().selectRepoId=f[0].get("repo_id")}}},onToggleClick:function(a,b){var c=this.getSelectedRecords();if(0>=c.length||-1===c[0].get("task_id")||!b.child(".item-toggle-expanded")){return}if(0===c[0].get("task_id")){return}if("lun"===c[0].get("data_type")){this.onGetLunDestStatus(c)}else{this.loadTaskDetail(c)}},toggleDetail:function(a,b){var c=this.getSelectedRecords();if(0>=c.length||-1===c[0].get("task_id")){return}this.callParent(arguments)},onGetDestStatusDone:function(c,f,a){this.owner.appWin.clearStatusBusy();if(!f||!a||!a.responseText){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));return}var e=Ext.util.JSON.decode(a.responseText);if(!e.success){this.appwin.getMsgBox().alert(_T("tree","leaf_backup"),_T(e.errinfo.sec,e.errinfo.key));return}var d,b=this.getStore().findExact("name",e.taskName);if(-1!==b){d=this.getStore().getAt(b);d.set("deststatus",e.deststatus);d.set("deststatus_str",SYNO.SDS.Backup.GetDestStatusStr(e.deststatus))}},onGetLunDestStatus:function(){var b=this.getSelectedRecords();var a=b[0].get("name");this.owner.appWin.setStatusBusy();Ext.Ajax.request({url:this.owner.appWin.getURL("lunbackup.cgi"),params:{action:"load_lun_dest_status",taskName:a},callback:this.onGetDestStatusDone,scope:this})},loadTaskDetail:function(a){this.owner.appWin.setStatusBusy();this.sendWebAPI({scope:this,compound:{stopwhenerror:true,params:[{api:"SYNO.Backup.Task.Data",version:1,method:"get",params:{task_id:a[0].id,additional:["progress","last_bkp_time","last_bkp_result","next_bkp_time"]}},{api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:a[0].get("repo_id")}}]},callback:this.updateDetail})},updateDetail:function(e,b,d){this.owner.appWin.clearStatusBusy();if(!e){this.owner.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var c=this.taskDisplayFormat(b.result[0].data);var a=b.result[1].data;if(c.deststatus==="target broken"){this.owner.appWin.getMsgBox().alert(_T("leaf","backup"),String.format(_T("backup","err_broken_task"),c.name))}c.bkp_dest=a.name;c.dest=a.dest;c.volume=a.volume;c.share=a.share;c.bucket=a.bucket;this.getStore().loadData({task_list:[c]},true)}});Ext.define("SYNO.SDS.Backup.Restore.ConflictWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},fillConfig:function(a){var c=new SYNO.SDS.Backup.ConflictPanel({owner:this,conflict_user:a.conflict_user,conflict_group:a.conflict_group});var b={title:_T("confbackup","confbkp_user_group_conflict_title"),resizable:false,width:600,height:450,buttons:[{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",scope:this,handler:function(){a.nextFunc.apply(a.nextScope,a.nextParams);this.close()}},{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.close}],items:[c]};Ext.apply(b,a);return b}});Ext.define("SYNO.SDS.Backup.ConflictPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},createFieldSet:function(a,g,e,f){var c=new Ext.XTemplate('<dl class="syno-backup-task-list-row">',String.format('<div class="syno-backup-task-list-column blue-status" style="width:50%">{0}</div>',e),String.format('<div class="syno-backup-task-list-column blue-status" style="width:50%">{0}</div>',f),'<div class="x-clear"></div>',"</dl>",'<tpl for=".">','<dl class="syno-backup-task-list-row">','<div class="syno-backup-task-list-column" style="width:50%">{name_current:htmlEncode}</div>','<div class="syno-backup-task-list-column" style="width:50%">{name_after:htmlEncode}</div>','<div class="x-clear"></div>',"</dl>","</tpl>");var b=new Ext.data.ArrayStore({fields:["name_current","name_after"]});var d=[];Ext.each(a,function(h){var i=[];i.push(h.name_current);i.push(h.name_after);d.push(i)});b.loadData(d);return new SYNO.ux.FieldSet({title:g,items:[{indent:1,xtype:"dataview",store:b,tpl:c,autoHeight:true}]})},fillConfig:function(a){var d=a.conflict_user;var e=a.conflict_group;var b=[];b.push({xtype:"syno_displayfield",hideLabel:true,value:_T("confbackup","confbkp_user_group_conflict_desc")});if(d&&d.length>0){b.push(this.createFieldSet(d,_T("confbackup","confbkp_user_conflict_list"),_T("confbackup","confbkp_user_name_current"),_T("confbackup","confbkp_user_name_after")))}if(e&&e.length>0){b.push(this.createFieldSet(e,_T("confbackup","confbkp_group_conflict_list"),_T("confbackup","confbkp_group_name_current"),_T("confbackup","confbkp_group_name_after")))}var c=Ext.apply({height:365,items:[b]},a);return c}});Ext.define("SYNO.SDS.Backup.Restore.ShareConflictWindow",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},fillConfig:function(a){var c=new SYNO.SDS.Backup.ConflictSharePanel({owner:this,conflict_share:a.conflict_share});var b={title:_T("confbackup","confbkp_share_conflict_title"),resizable:false,width:600,height:450,buttons:[{xtype:"syno_button",text:_T("common","ok"),btnStyle:"blue",scope:this,handler:function(){a.nextFunc.apply(a.nextScope,a.nextParams);this.close()}},{xtype:"syno_button",text:_T("common","cancel"),scope:this,handler:this.close}],items:[c]};Ext.apply(b,a);return b}});Ext.define("SYNO.SDS.Backup.ConflictSharePanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=this.fillConfig(a);return this.callParent([b])},createFieldSet:function(a,g,e,f){var c=new Ext.XTemplate('<dl class="syno-backup-task-list-row">',String.format('<div class="syno-backup-task-list-column blue-status" style="width:50%">{0}</div>',e),String.format('<div class="syno-backup-task-list-column blue-status" style="width:50%">{0}</div>',f),'<div class="x-clear"></div>',"</dl>",'<tpl for=".">','<dl class="syno-backup-task-list-row">','<div class="syno-backup-task-list-column" style="width:50%">','<tpl if="encrypted==\'true\'"><div class="syno-backup-config-share-enc-true"></div></tpl>','<tpl if="encrypted==\'false\'"><div class="syno-backup-config-share-enc-false"></div></tpl>',"{name_current:htmlEncode}","</div>",'<div class="syno-backup-task-list-column" style="width:50%">','<tpl if="encrypted!=\'NA\'"><div class="syno-backup-config-share-enc-true"></div></tpl>',"{name_after:htmlEncode}","</div>",'<div class="x-clear"></div>',"</dl>","</tpl>");var b=new Ext.data.ArrayStore({fields:["name_current","name_after","encrypted"]});var d=[];Ext.each(a,function(h){var i=[];i.push(h.name_current);i.push(h.name_after);if(h.is_encryption&&h.is_encrypted){i.push("true")}else{if(h.is_encryption){i.push("false")}else{i.push("NA")}}d.push(i)});b.loadData(d);return new SYNO.ux.FieldSet({title:g,items:[{indent:1,xtype:"dataview",store:b,tpl:c,autoHeight:true}]})},fillConfig:function(a){var d=a.conflict_share;var b=[];b.push({xtype:"syno_displayfield",hideLabel:true,value:_T("confbackup","confbkp_share_conflict_description")});if(d&&d.length>0){b.push(this.createFieldSet(d,_T("confbackup","confbkp_share_conflict_list"),_T("confbackup","confbkp_share_name_current"),_T("confbackup","confbkp_share_name_after")))}var c=Ext.apply({height:365,items:[b]},a);return c}});Ext.define("SYNO.SDS.Backup.Restore.ConfigTreePanel",{extend:"SYNO.SDS.Backup.BasicTreePanel",constructor:function(a){this.dss_version=a.dss_version;this.dss_path=a.dss_path;this.dss_id=a.dss_id;this.overwrite=a.overwrite;var b=Ext.apply({},a);return this.callParent([b])},getConfigRootText:function(a){if("confbkp_v4"===a||"confbkp_v3"===a){return _T("confbackup","confbkp_all")}if("confbkp_v1"===a||"confbkp_v2"===a){return _T("confbackup","confbkp_user_group")}return""},createConfigNodeFn:function(a){var b=function(c,d){var e=SYNO.SDS.Backup.converLanString(c[d]);if(e){c[d]=e}};b(a,"text");if(!("children" in a)){a.leaf=true}if("info"===a.type){if(a.value_multi){b(a,"value_multi");a.value=a.value_multi}if(a.value){a.text=a.text+' : <element class="green-status">'+a.value+"</element>"}}else{a.iconCls="syno-backup-config";a.checked=false}a.qtip=a.text},getCheckedService:function(b){var a=[];var c=function(d){d.eachChild(function(f){var e=f.getUI()||{};if(!Ext.isFunction(e.getCheckValue)){return}if(true===e.getCheckValue()){if("category"===f.attributes.type){Ext.each(f.attributes.children,function(g){a.push(g)})}else{a.push(f)}}else{if("gray"===e.getCheckValue()){c(f)}}})};c(b||this.root);return a},getRestoreServiceList:function(){var a=[];if(true===this.root.getUI().getCheckValue()&&this.dsm_version<4980){a.push("all")}else{Ext.each(this.getCheckedService(),function(b){a.push(b.id)})}return a},isRestoreConfig:function(){return false!==this.getNodeById("config_root").getUI().getCheckValue()},showShareConflictWindow:function(c,b){if(c&&c.length>0){var a=new SYNO.SDS.Backup.Restore.ShareConflictWindow({conflict_share:c,nextFunc:this.checkRenameLeaveAdmin,nextScope:this,nextParams:b});a.open()}else{this.checkRenameLeaveAdmin.apply(this,b)}},showUGConflictWindow:function(d,e,c,b){if((d&&d.length>0)||(e&&e.length>0)){var a=new SYNO.SDS.Backup.Restore.ConflictWindow({conflict_user:d,conflict_group:e,nextFunc:this.showShareConflictWindow,nextScope:this,nextParams:[c,b]});a.open()}else{this.showShareConflictWindow(c,b)}},checkUGConflict:function(c,b,d,a){if(false===this.isRestoreConfig()){b.call(d);return}if(undefined===a){a=false}d.setStatusBusy();d.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"list_conflict",version:1,params:{types:a?["user","group","share"]:["user","group"],dss_path:this.dss_path,dss_id:this.dss_id,overwrite:c,category_or_service_ids:this.getRestoreServiceList()},callback:function(e,h){d.clearStatusBusy();if(!e||!h){var g=SYNO.SDS.Backup.ERR_INTERNAL_ERROR;var f;if(h){g=h.code}if(h.errors){if(h.errors.max_user_account&&g==SYNO.SDS.Backup.ERR_USER_EXCEED_MAX){f=String.format(_T("confbackup","confbkp_user_exceed_max_param"),h.errors.max_user_account)}else{if(h.errors.max_group_account&&g==SYNO.SDS.Backup.ERR_GROUP_EXCEED_MAX){f=String.format(_T("confbackup","confbkp_group_exceed_max_param"),h.errors.max_group_account)}else{f=SYNO.SDS.Backup.GetErrorString(g)}}}else{f=SYNO.SDS.Backup.GetErrorString(g)}d.getMsgBox().alert(_T("tree","leaf_bkp"),f);return}this.showUGConflictWindow(h.user,h.group,h.share,[c,b,d,a])},scope:this})},checkRenameLeaveAdmin:function(d,b,e,a){if(false===this.isRestoreConfig()){return}var c=a?_T("confbackup","upload_confirm_minutes"):_T("confbackup","upload_confirm");e.setStatusBusy();e.sendWebAPI({api:"SYNO.Backup.Config.Restore",method:"check",version:1,params:{dss_path:this.dss_path,dss_id:this.dss_id,overwrite:d,category_or_service_ids:this.getRestoreServiceList()},callback:function(f,g){e.clearStatusBusy();if(!f){e.getMsgBox().alert(_T("tree","leaf_bkp"),SYNO.SDS.Backup.GetErrorString(g.code))}else{e.getMsgBox().confirm(_T("tree","leaf_bkp"),c,function(h){if("yes"===h){b.call(e)}},this)}},scope:this})}});Ext.define("SYNO.SDS.Backup.Restore.ConfigStep",{extend:"SYNO.SDS.Backup.FormPanel",constructor:function(a){Ext.copyTo(this,a,"owner");this.configTree=new SYNO.SDS.Backup.Restore.ConfigTreePanel({loader:new SYNO.SDS.Backup.TreeLoader(),disabled:true,rootVisible:true,autoWidth:true,height:295});var c=new Ext.tree.AsyncTreeNode({expanded:false,id:"config_root",allowDrop:false,leaf:false,checked:false,iconCls:"syno-backup-config",loader:this.createTreeLoader(),uiProvider:SYNO.SDS.Backup.TriTreeNodeUI});this.configTree.setRootNode(c);var d=new SYNO.ux.FieldSet({title:_T("confbackup","confbkp_restore_select"),items:[{xtype:"syno_radio",boxLabel:_T("backup","restore_config_no"),name:"config_selected",itemId:"config_selected_no",groupFields:[],inputValue:"no",indent:0,hideLabel:true,scope:this,checked:true},{xtype:"syno_radio",boxLabel:_T("backup","restore_config_yes")+":",name:"config_selected",itemId:"config_selected_yes",groupFields:["version_selector"],inputValue:"yes",indent:0,hideLabel:true,scope:this,listeners:{scope:this,check:this.onConfigYesChecked},checked:false},{width:240,xtype:"syno_combobox",hideLabel:true,itemId:"version_selector",name:"version_selector",forceSelection:true,allowBlank:false,autoSelect:true,displayField:"text",valueField:"version_id",indent:1,store:new Ext.data.SimpleStore({id:"version_id",fields:["version_id","text"]}),listeners:{scope:this,select:function(f,g,e){this.reloadTree(g.get("version_id"))}}},{xtype:"syno_checkbox",boxLabel:_T("confbackup","bkp_overwrite"),disabled:true,hiddenName:"overwrite",name:"overwrite"},this.configTree]});var b={items:d};Ext.apply(b,a);this.callParent([b])},onConfigYesChecked:function(a,b){if((b&&!this.isConfigInvalid)||!b&&this.newestDssId){this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable()}if(this.isConfigInvalid){return}this.configTree.setDisabled(!b);this.configTree.getRootNode().getUI().setCheckValue(b);this.getForm().findField("overwrite").setValue(b);this.getForm().findField("overwrite").setDisabled(!b)},setConfigInvalid:function(b,a){this.isConfigInvalid=b;if(!b&&(this.getForm().findField("config_selected_no").getValue())){this.owner.getButton("next").setDisabled(b);return}if(b){this.configTree.getEl().mask(a)}else{this.configTree.getEl().unmask()}this.configTree.getRootNode().getUI().setCheckValue(!b);this.getForm().findField("overwrite").setDisabled(b);this.getForm().findField("overwrite").setValue(!b);this.owner.getButton("next").setDisabled(b)},createTreeLoader:function(){var a=new SYNO.SDS.Backup.TreeLoader({sendWebAPI:this.configTree.sendWebAPI.createDelegate(this.configTree),webapi:{api:"SYNO.Backup.Config.Restore",method:"list",version:2,timeout:360000},baseParams:{is_show_shared_folder:false},parseWebApiResponse:this.parseWebApiResponse.createDelegate(this),createNodeFn:function(b){this.configTree.createConfigNodeFn(b);if(!this.owner.isSingle){delete b.checked}},createNodeScope:this});a.on("beforeload",function(e,c,b){var d;if(!this.owner.el.isMasked()){this.owner.setStatusBusy()}this.owner.getButton("next").disable();d=this.getLoadVersionListParams();d.version_id=this.configTree.version_id;Ext.apply(e.baseParams,d)},this);a.on("loadexception",function(e,c,b){var d=SYNO.SDS.Backup.GetErrorString(b.code);if(b.code==SYNO.SDS.Backup.ERR_CONFIG_VERSION_WRONG||b.code==SYNO.SDS.Backup.ERR_CONFIG_VERSION_FUTURE){this.setConfigInvalid(true,d)}else{this.setConfigInvalid(true);this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),d,function(){this.owner.close()},this)}this.owner.clearStatusBusy()},this);a.on("load",function(d,c,b){this.setConfigInvalid(false);this.owner.clearStatusBusy()},this);return a},parseWebApiResponse:function(b,a){if(!this.newestDssId){this.newestDssId=a.dss_id}this.configTree.dss_id=a.dss_id;return a.config_info_list},getLoadVersionListParams:function(){return Ext.apply({offset:0,limit:-1},this.owner.getBaseParams())},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);if(this.isConfigInvalid){this.owner.getButton("next").disable()}},activate:function(){var d=this.getLoadVersionListParams();var b;var a;var c;if(this.lastQueryVersionList!==Ext.encode(d)){this.newestDssId="";this.getForm().findField("config_selected_no").setValue(true);a=this.getForm().findField("version_selector");a.getStore().loadData([],false);a.clearValue();b=this.configTree.getRootNode();this.owner.setStatusBusy({text:_T("backup","search_restore_config")});if(!this.owner.isSingle){c=_T("confbackup","confbkp_all")+' <element class="red-status">('+_T("confbackup","bkp_overwrite")+")</element>";b.setText(c);b.setTooltip(c);this.getForm().findField("overwrite").setVisible(false)}else{c=_T("confbackup","confbkp_all");b.setText(c);b.setTooltip(c);this.getForm().findField("overwrite").setVisible(true)}d.sort_direction="desc";d.filter_name="success";this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:d,scope:this,callback:this.loadVersionDone})}},loadVersionDone:function(e,b,c){if(!e){this.owner.clearStatusBusy();this.reportFatalError(SYNO.SDS.Backup.GetErrorString(b.code));return}var a=this.getForm().findField("version_selector");var d=[];if(!b||!(b.version_info_list)||0===b.version_info_list.length){this.setConfigInvalid(true);this.owner.clearStatusBusy();if(!this.owner.isSingle){this.reportFatalError(_T("backup","no_avail_version"))}else{this.reportFatalError(_T("confbackup","confbkp_file_not_found"))}return}Ext.each(b.version_info_list,function(f){var g;if(0===f.timestamp){d.push([f.version_id,_T("confbackup","confbkp_old_config_format")])}else{g=new Date(f.timestamp*1000);d.push([f.version_id,g.toLocaleString()])}},this);this.newestVersionId=d[0][0];a.getStore().loadData(d,false);a.setValue(d[0][0]);a.setRawValue(d[0][1]);this.lastQueryVersionList=Ext.encode(this.getLoadVersionListParams());this.reloadTree(d[0][0])},reportFatalError:function(a){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),a||_T("common","commfail"),function(b){this.owner.close()},this)},getNext:function(){var a=this.nextId;var b=this.isOverwrite();if(this.isRestoreConfig()){this.configTree.checkUGConflict(b,function(){this.goNext(a)},this.owner)}else{return a}return false},summary:function(a){var b;if(this.isRestoreConfig()){a.append(_T("backup","select_version"),this.getForm().findField("version_selector").getRawValue());b=_T("common","yes")+", ";b+=_T("netbackup","netbkp_restore_enhance")}else{b=_T("common","no")}a.append(_T("confbackup","bkp_import"),b)},reloadTree:function(b){var a;this.configTree.dss_id="";this.configTree.version_id=b;a=this.configTree.getRootNode();a.reload();a.expand()},getVersionId:function(){if(this.isRestoreConfig()){return this.getForm().findField("version_selector").getValue()}else{if(this.owner.isSingle){return this.newestVersionId}else{return -1}}},isOverwrite:function(){if(!this.owner.isSingle){return this.configTree.isRestoreConfig()}return this.getForm().findField("overwrite").getValue()},getNewestDssId:function(){return this.newestDssId},getDssId:function(){return this.configTree.dss_id},isRestoreConfig:function(){return this.getForm().findField("config_selected_yes").getValue()&&this.configTree.isRestoreConfig()},getBaseParams:function(){var b={};var a=this.getVersionId();if(-1!==a){b.version_id=a}return b},getParams:function(){if(!this.isRestoreConfig()){return{}}return{config_list:this.configTree.getRestoreServiceList(),option:{overwrite:this.isOverwrite()}}}});(function(){var o=function(r){var s=r.clone();s.setHours(0);s.setMinutes(0);s.setSeconds(0);s.setMilliseconds(0);return s},h=function(r){var s=r.clone();s.setHours(0);s.setMinutes(0);s.setSeconds(0);s.setMilliseconds(0);s.setDate(1);return s},g=function(v,t,r){var s=new Ext.Template(t,{compiled:true,disableFormats:true}),u=s.append(v,r||{},true);return u},c=function(v,t,r){var s=new Ext.Template(t,{compiled:true,disableFormats:true}),u=s.overwrite(v,r||{},true);return u},q=function(s,r){return s.format("Y-m-d")===r.format("Y-m-d")},p=function(s,r){if(!Ext.isDefined(s)&&!Ext.isDefined(r)){return true}else{if(!Ext.isDefined(s)||!Ext.isDefined(r)){return false}}return s.version_id===r.version_id},a=function(s){var r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return s.format("Y ")+r[s.getMonth()]},d="syno-backup-timeline-wrapper",l="syno-backup-timeline-scroller",b="syno-backup-timeline-pin",i="syno-backup-timeline-pin-bg",k="syno-backup-timeline-calendar",f="Y-m-d",m="Y-m",e=1000*60*60*24,j=30,n=10980;Ext.define("SYNO.SDS.Backup.VersionMenu",{extend:"Ext.menu.Menu",cls:"syno-backup-timeline-version-menu",initComponent:function(){var r;Ext.apply(this,{plain:true,showSeparator:false});r=this.callParent(arguments);this.addEvents("select")},renderVersinfo:function(){if(!this.rendered){this.mon(this,"afterrender",this.renderVersinfo,this);return}var v=['<div class="syno-backup-timeline-version-ct">','<div class="version-menu-header">',"<b>{vers_count}</b> {vers_desc} {vers_date}","</div>","</div>"],u,x,s=[],t=this.getVersinfo(),r,w=this.owner.selectedVersion;s.push("<table>");for(u=0;u<t.length;u+=2){r=p(t[u],w);s.push('<tr><td data-index="'+u+'" '+(r?'class="version-selected"':"")+" >"+t[u].date.format("H:i:s")+"</td>");if(u+1<t.length){r=p(t[u+1],w);s.push('<td data-index="'+(u+1)+'" '+(r?'class="version-selected"':"")+" >"+t[u+1].date.format("H:i:s")+"</td>")}s.push("</tr>")}s.push("</table>");x=c(this.getEl(),v.join(""),{vers_desc:_T("backup","timeline_versions"),vers_count:t.length,vers_date:t[0].date.format("Y-m-d")});this._box=new Ext.BoxComponent({renderTo:x,cls:"version-menu-ct",html:s});if(t.length>10){this._box.setHeight(169-27);this._box.updateScroller(0)}x.on("click",this.onClickVersion,this);return x},setVersinfo:function(r){this.versinfo=r;this.changed=false;return this.renderVersinfo(r)},getVersinfo:function(){return this.versinfo},onClickVersion:function(t,u,s){if(u.tagName==="TD"){var r=u.getAttribute("data-index");this.changed=true;this.selectedVersion=this.getVersinfo()[r];this.fireEvent("select",this.selectedVersion);this.hide(true)}}});Ext.define("SYNO.SDS.Backup.TimeLine",{extend:"Ext.Panel",calendar:null,minDate:null,maxDate:null,selectedDate:null,versionMenu:null,versionList:null,_elMonth:null,_elTimeline:null,defaultVersion:null,panelWidth:0,statusBusy:false,constructor:function(r){var s=new Date(),t=Ext.apply({owner:r.owner,border:false,frame:false,minDate:s.add(Date.YEAR,-1),maxDate:s},r);t.minDate=o(t.minDate);t.maxDate=o(t.maxDate);this._elMonth={};this.versionList={};return this.callParent([t])},initComponent:function(){this.callParent(arguments);this.addEvents("select");this.mon(this,"afterrender",this.onAfterRender,this)},onAfterRender:function(){this.renderTimeLine();this.loadVersionSummary()},getPanelWidth:function(){return this._elTimeline.getWidth()},getScrollerWidth:function(){return this._elTimeline.child(".syno-backup-timeline-scroller").getWidth()},getDateByOffsetX:function(s){if(s===undefined){s=-this.scroll.x}var r=-Math.ceil((this.getScrollerWidth()-(this.getPanelWidth()/2+15)-s)/j);return this.maxDate.add(Date.DAY,r)},getOffsetXByDate:function(r){var s=o(r);return this.getScrollerWidth()-(this.getPanelWidth()/2+15)-((this.maxDate-s)/e)*j},getOffsetXByMonthDate:function(r){return this.getOffsetXByDate(r.getFirstDateOfMonth())},getMonthEl:function(r){var s=r.getFirstDateOfMonth();return this._elMonth[s.format(f)]},setMonthEl:function(r,s){var t=r.getFirstDateOfMonth();this._elMonth[t.format(f)]=s},getVersionDomByVersionInfo:function(s){var r=s[0].date,t=this.getMonthEl(r);return t.dom.childNodes[r.getDate()]},getVersionId:function(){if(this.selectedVersion){return this.selectedVersion.version_id}else{return undefined}},getVersionDate:function(){if(this.selectedVersion){return this.selectedVersion.name}else{return undefined}},renderTimeLine:function(){var s=this,r=g(s.getEl(),['<div class="{wrapper_cls}">','<div class="{scroller_cls}"></div>','<div class="{calendar_cls}"></div>','<div class="{pin_bg_cls}"></div>','<div class="{pin_cls}"></div>',"</div>"],{wrapper_cls:d,scroller_cls:l,calendar_cls:k,pin_cls:b,pin_bg_cls:i});s.scroll=new SYNO.SDS.Utils.IScroll(r.dom,{scrollX:true,scrollY:false,mouseWheel:true,deceleration:0.01,startX:r.getWidth()*1.2-n,tap:Ext.isIE8?false:true});r.on(Ext.isIE8?"click":"tap",function(v,u,t){var w=null;if(u.hasClassName("syno-backup-timeline-calendar")){s.onCalendarClick(u)}else{if(u.hasClassName("version-prev")){s.onClickPrevVersion()}else{if(u.hasClassName("version-next")){s.onClickNextVersion()}else{if(u.hasClassName("version-time")||u.hasClassName("version-count")){w=u.parentNode.parentNode;s.onDateClick(w)}else{if(u.tagName==="B"){w=u.parentNode;if(w!==s._lastClickDom){s.onDateClick(w)}else{w=null}}else{if(u.tagName==="TD"){w=u.parentNode.parentNode.parentNode.parentNode;s.onDateClick(w)}else{if(s.versionMenu&&s.versionMenu.isVisible()){s.versionMenu.hide()}}}}}}}s._lastClickDom=w});s.scroll.on("beforeScrollStart",function(){if(s.versionMenu&&s.versionMenu.isVisible()){s.versionMenu.hide()}});s.scroll.on("scrollEnd",function(){s.updateCurrentView()});s._elTimeline=r;this.panelWidth=s._elTimeline.getWidth();return r},renderMonth:function(s){if(this.getMonthEl(s)){return this.getMonthEl(s)}var w=this,u,v,r=s.getDaysInMonth(),t=['<ul class="timeline-month" style="left:{offsetX}px; width:{width}px">','<div class="month-label">{month}</div>'];for(u=1;u<=r;u+=1){if(u%2===0&&u!==r){t.push('<li data-day="'+u+'"><a>'+u+"</a></li>")}else{t.push('<li data-day="'+u+'"></li>')}}t.push("</ul>");v=g(w._elTimeline.child("."+l),t,{offsetX:w.getOffsetXByMonthDate(s),month:a(s),width:r*j});v.date=s.getFirstDateOfMonth();w.setMonthEl(s,v);if(this.versionList[s.format(m)]&&0<this.versionList[s.format(m)].length){this.renderVersions(this.versionList[s.format(m)])}return v},setVersionInfo:function(s){var r=s[0].date,v,u=r.getDate()-r.getFirstDateOfMonth().getDate()+1,t=this.renderMonth(r);v=t.dom.childNodes[u];if(!t.versions){t.versions=[]}t.versions[u]=s;this.renderVersionTag(t,u)},renderVersions:function(r){var s={};Ext.each(r,function(t){var u=Date.parseDate(t.timestamp,"U");var v=u.format(f);t.date=u;if(s[v]){s[v].push(t)}else{s[v]=[t]}},this);Ext.iterate(s,function(t,u){this.setVersionInfo(u)},this)},scrollToDate:function(r,s){this.scroll.scrollTo(-this.getOffsetXByDate(r)+this.getPanelWidth()-(this.getPanelWidth()/2+15),0,s)},updateMonthOffset:function(){for(var r in this._elMonth){if(this._elMonth[r]){this._elMonth[r].setLeft(this.getOffsetXByDate(this._elMonth[r].date))}}},resizeScroller:function(s){var r=s-this.getScrollerWidth();this._elTimeline.child(".syno-backup-timeline-scroller").setWidth(s);this.updateMonthOffset();this.scroll.refresh();this.scroll.scrollTo(this.scroll.x-r,0,0)},onResize:function(v,s,r,u){this.callParent(arguments);var t=v-this.panelWidth;this.panelWidth=v;if(this.selectedVersion){this.resizeScroller(this.getScrollerWidth()+t);this.scrollToDate(this.selectedVersion.date,0)}},renderVersionTagByDate:function(r,s){return this.renderVersionTag(this.getMonthEl(r),r.getDate(),s)},renderVersionTag:function(v,u,t){var x=v.dom.childNodes[u],s=v.versions[u],r="";x.removeClassName("version-exists");x.removeClassName("version-select");x.removeClassName("version-show");if(u%2===0&&u!==v.date.getDaysInMonth()){r="<a>"+u+"</a>"}if(!Ext.isDefined(s)){x.innerHTML=r;return x}if(!Ext.isDefined(t)||t===false){x.innerHTML="<b>"+s.length+"</b>"+r;x.addClassName("version-exists");return x}if(t===true){x.addClassName("version-show");x.innerHTML="<b></b>"+r;var w=this.createVersionMenu(s);w.show(x.childNodes[0],"b-t?")}else{x.addClassName("version-select");x.innerHTML='<div class="version-box"><div class="version-count">'+s.length+'</div><div class="version-prev">&nbsp;</div><div class="version-time">'+t.date.format("Y-m-d H:i:s")+'</div><div class="version-next">&nbsp;</div></div><b></b>'+r}return x},createVersionMenu:function(r){var s=this;if(!s.versionMenu){s.versionMenu=new SYNO.SDS.Backup.VersionMenu({width:200,owner:s,enableScrolling:false,listeners:{hide:s.onVersionMenuHide,scope:s}})}s.versionMenu.setVersinfo(r);return s.versionMenu},updateCurrentView:function(){var s=this.getDateByOffsetX(-this.scroll.x);var r=this.getPreloadWindow(s,5);if(r){this.loadVersionList(r.minDate,r.maxDate)}},checkVersionLoaded:function(r){return this.versionList[r.format(m)]},onCalendarClick:function(r){if(null===this.calendar){this.calendar=new Ext.menu.DateMenu({hideOnClick:true,focusOnSelect:false});this.calendar.addClass("syno-ux-datefield-menu");this.calendar.picker.setMinDate(this.minDate);this.calendar.picker.setMaxDate(this.maxDate);this.mon(this.calendar,"select",function(t,s){this.scrollToDate(s,700)},this)}this.calendar.show(r,"bl-tl?")},selectVersion:function(s){if(!s){return}var r=this.selectedVersion;this.selectedVersion=s;if(r){this.renderVersionTagByDate(r.date,false)}this.renderVersionTagByDate(s.date,s);this.scrollToDate(this.selectedVersion.date,700);this.fireEvent("select",this.selectedVersion)},onDateClick:function(t){var s=Ext.get(t.parentNode),r=s.versions[t.getAttribute("data-day")];if(!r||r.length<=0){SYNO.Debug("renderVersions: failed?");return}if(r.length===1){this.selectVersion(r[0],true)}else{this.renderVersionTagByDate(r[0].date,true)}},onVersionMenuHide:function(r){if(r.changed){if(this.selectedVersion){if(p(this.selectedVersion,r.selectedVersion)){this.renderVersionTagByDate(this.selectedVersion.date,this.selectedVersion);return}this.renderVersionTagByDate(this.selectedVersion.date,false)}this.selectVersion(r.selectedVersion)}else{if(!this.selectedVersion){this.renderVersionTagByDate(r.getVersinfo()[0].date,false);return}if(!q(this.selectedVersion.date,r.getVersinfo()[0].date)){this.renderVersionTagByDate(r.getVersinfo()[0].date,false);return}this.renderVersionTagByDate(this.selectedVersion.date,this.selectedVersion)}},setDateInterval:function(r,s){this.minDate=o(r);this.maxDate=o(s);if(this.calendar){this.calendar.picker.setMinDate(this.minDate);this.calendar.picker.setMaxDate(this.maxDate)}this.resizeScroller(((this.maxDate.getTime()-this.minDate.getTime())/86400000*j)+this.getPanelWidth());return this},loadVersionList:function(s,u,r){if(!this.statusBusy){this.owner.setStatusBusy();this.statusBusy=true}var t=Ext.apply(this.getBaseParams(),{time_from:h(s).getTime()/1000,time_to:h(u).add(Date.MONTH,1).getTime()/1000,filter_name:"success"});this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:t,scope:this,callback:function(x,v,w){this.owner.clearStatusBusy();this.statusBusy=false;if(!x){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(v.code),function(){this.owner.close()},this);return}this.updateVersionList(s,u,v.version_info_list);this.renderVersionList(s,u,r)}})},updateVersionList:function(s,t,r){while(s<=t){if(!this.versionList[s.format(m)]){this.versionList[s.format(m)]=[]}s=s.add(Date.MONTH,1)}Ext.each(r,function(x,v,w){if("success"!==x.status){return}var u=Date.parseDate(x.timestamp,"U");if(!this.versionList[u.format(m)]){this.versionList[u.format(m)]=[]}this.versionList[u.format(m)].unshift(x)},this)},renderVersionList:function(s,t,r){while(t>=s){this.renderMonth(t);t=t.add(Date.MONTH,-1)}if(r){this.selectVersion(r)}},getPreloadWindow:function(t,s){var r={},u=h(t),v=true;if(this.checkVersionLoaded(u)){if(!this.checkVersionLoaded(u.add(Date.MONTH,-1))){u=u.add(Date.MONTH,-1)}else{if(!this.checkVersionLoaded(u.add(Date.MONTH,1))){u=u.add(Date.MONTH,1)}else{return undefined}}}r.maxDate=u;r.minDate=u;while(true===v){v=false;if(!this.checkVersionLoaded(r.minDate.add(Date.MONTH,-1))&&0<s){r.minDate=r.minDate.add(Date.MONTH,-1);--s;v=true}if(!this.checkVersionLoaded(r.maxDate.add(Date.MONTH,1))&&0<s){r.maxDate=r.maxDate.add(Date.MONTH,1);--s;v=true}}return r},loadNextVersionInfo:function(r,t){if(!this.statusBusy){this.owner.setStatusBusy();this.statusBusy=true}var s=Ext.apply(this.getBaseParams(),{offset:0,limit:1,filter_name:"success"});if(0>=t){s.sort_direction="desc";s.time_from=1;s.time_to=Math.floor(r.getTime()/1000)-1}else{s.sort_direction="asc";s.time_from=Math.floor(r.getTime()/1000)+1;s.time_to=-1}this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:s,scope:this,callback:function(y,w,x){if(!y){this.owner.clearStatusBusy();this.statusBusy=false;this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(w.code),function(){this.owner.close()},this);return}if(w.version_info_list.length<1){this.owner.clearStatusBusy();this.statusBusy=false;return}var u=w.version_info_list[0];u.date=Date.parseDate(u.timestamp,"U");var v=this.getPreloadWindow(u.date,5);if(v){this.loadVersionList(v.minDate,v.maxDate,u)}else{this.owner.clearStatusBusy();this.statusBusy=false;this.selectVersion(u)}}})},loadVersionSummary:function(){if(!this.statusBusy){this.owner.setStatusBusy();this.statusBusy=true}var r=this.getBaseParams();this.sendWebAPI({api:"SYNO.Backup.Version",version:1,method:"summary",params:r,scope:this,callback:function(w,s,u){if(!w){this.loadVersionSummaryCompatible();return}if(s.version_count<1){this.owner.clearStatusBusy();this.statusBusy=false;this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("backup","no_avail_version"),function(){this.owner.close()},this);return}var t=new Date();var v=Date.parseDate(s.start_time,"U");this.setDateInterval(v,this.maxDate);if(this.defaultVersion){this.loadNextVersionInfo(Date.parseDate(this.defaultVersion+3,"U"),-1)}else{this.loadNextVersionInfo(t,-1)}}})},loadVersionSummaryCompatible:function(){if(!this.statusBusy){this.owner.setStatusBusy();this.statusBusy=true}var r=Ext.apply(this.getBaseParams(),{offset:0,limit:1,sort_direction:"asc",filter_name:"success"});this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:r,scope:this,callback:function(w,s,u){if(!w||s.version_info_list.length<1){this.owner.clearStatusBusy();this.statusBusy=false;this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(s.code),function(){this.owner.close()},this);return}var t=new Date();var v=Date.parseDate(s.version_info_list[0].timestamp,"U");this.setDateInterval(v,this.maxDate);this.loadNextVersionInfo(t,-1)}})},onClickPrevVersion:function(){if(this.selectedVersion){this.loadNextVersionInfo(this.selectedVersion.date,-1)}},onClickNextVersion:function(){if(this.selectedVersion){this.loadNextVersionInfo(this.selectedVersion.date,1)}}})})();Ext.define("SYNO.SDS.Backup.VersionFileTree",{extend:"SYNO.SDS.Backup.BasicTreePanel",constructor:function(a){Ext.copyTo(this,a,"owner,isSingle");var b=Ext.apply({border:false,loader:this.createTreeLoader(),root:this.createTreeRoot()},a);return this.callParent([b])},createTreeRoot:function(){var a=new Ext.tree.AsyncTreeNode({draggable:false,expanded:false,id:"fm_root",allowDrop:false,text:_T("tree","leaf_sharefolder"),iconCls:"syno-backup-share",checked:false,uiProvider:SYNO.SDS.Backup.TriTreeDisableCheckNodeUI});return a},createTreeLoader:function(){return new SYNO.SDS.Backup.TreeLoader({sendWebAPI:this.sendWebAPI.createDelegate(this),scope:this,webapi:{api:"SYNO.Backup.Share.Restore",method:"list",version:1},baseParams:{offset:0,limit:-1},listeners:{beforeload:this.onBeforeLoad,load:this.onLoad,loadexception:this.onLoadException,scope:this},createNodeFn:this.createNodeFn,createNodeScope:this,parseWebApiResponse:this.parseWebApiResponse.createDelegate(this)})},onBeforeLoad:function(d,a,c){var b;this.owner.setStatusBusy();b=this.getBaseParams();if(a.id==="fm_root"){if(this.owner.getStep("config").isRestoreConfig()){b.dss_id=this.owner.getStep("config").getDssId()}else{if(this.owner.isSingle){b.dss_id=this.owner.getStep("config").getNewestDssId()}}d.webapi.api="SYNO.Backup.Share.Restore";d.webapi.method="list"}else{d.webapi.api="SYNO.Backup.Version";d.webapi.method="list_folder"}Ext.apply(d.baseParams,b,{path:a.id,version_id:this.getVersionId()})},onLoad:function(d,c,b){var a=0;if("fm_root"===c.id){c.eachChild(function(e){if(!(e.disabled)){a++}});if(0===c.childNodes.size()){c.disable();c.appendChild(new Ext.tree.AsyncTreeNode({checked:false,leaf:true,uiProvider:SYNO.SDS.Backup.TriTreeNodeUI,text:'<element class="red-status">'+_T("download","download_task_dest_not_exist")+"</element>",disabled:true}))}else{if(0===a){c.disable()}else{c.enable()}}}this.owner.clearStatusBusy()},onLoadException:function(c,b,a){this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(a.code),function(){this.owner.close()},this);return},createNodeFn:function(a){a.uiProvider="SYNO.SDS.Backup.TriTreeDisableCheckNodeUI";a.checked=false;a.text=a.qtip=a.name;if(a.file_path){a.id=a.file_path}else{a.id="/"+a.name;if("@"===a.text.charAt(0)){a.text=a.text.replace(/@/g,"");a.qtip=a.text.replace(/@/g,"");a.iconCls="syno-backup-share-encrypted"}}delete a.name;if(a.conflict){if(a.conflict.startsWith("cluster")){a.disabled=true;if("cluster_overwrite"===a.conflict){a.shareConflict="overwrite"}}else{if(a.conflict.startsWith("err_")){a.disabled=true;a.qtip=_T("backup",a.conflict)}}a.shareConflict=a.conflict;delete a.conflict}a.leaf=this.isSingle||a.disabled},parseWebApiResponse:function(b,a){var c=[];if(b.id==="fm_root"){this.dss_id=a.dss_id;return a.share_info_list}else{Ext.each(a.file_list,function(d){if(d.is_dir===false){return}c.push(d)});return c}},getVersionPanel:function(){return this.versionPanel},getVersionId:function(){return this.getVersionPanel().getVersionId()},checkShare:function(){var e="";this.getRootNode().eachChild(function(h){var g=h.getUI()||{};if(!Ext.isFunction(g.getCheckValue)||!(g.checkbox)){return}if(true===g.getCheckValue()||"gray"===g.getCheckValue()){var f=h.attributes.shareConflict;if(f&&f.startsWith("cluster_err")){e=String.format(_T("backup",f),h.text);return false}}},this);if(this.isSingle){this.owner.setStatusBusy();var c=false;var d=false;var a=this.getFolderList();var b={};Ext.each(a,function(f){var h=false;var g=false;f=f.substr(1);f=f.toLowerCase();if("@"===f.charAt(0)){f=f.substr(1,f.length-2);h=true}if(b[f]){g=(b[f]==="enc_share");if(g===h){c=true}else{d=true}return false}else{b[f]=h?"enc_share":"share"}});this.owner.clearStatusBusy();if(c){e=_T("netbackup","netbkp_restore_conflict_share")}else{if(d){e=_T("backup","restore_the_same_share_err")}}}return e},getFolderList:function(){var a=[];Ext.each(this.getCheckedSubTreeRoot(this.getRootNode()),function(b){a.push(b.id)});return a}});Ext.define("SYNO.SDS.Backup.VersionSelector",{extend:"SYNO.SDS.Backup.FormPanel",constructor:function(a){Ext.copyTo(this,a,"owner");var b=Ext.apply({style:"border-top: 1px solid #D7E1EB; padding: 12px 20px 0px 20px;",items:[{labelWidth:260,width:240,fieldLabel:_T("backup","select_version"),xtype:"syno_combobox",itemId:"version_selector",name:"version_selector",forceSelection:true,allowBlank:false,autoSelect:true,displayField:"name",valueField:"version_id",store:this.createStore(a),listeners:{scope:this,select:function(d,e,c){this.getVersionPanel().reloadTree(e.get("version_id"))}}}]},a);return this.callParent([b])},createStore:function(a){return new SYNO.API.Store({api:"SYNO.Backup.Version",version:2,method:"list",baseParams:Ext.apply({},this.params),appWindow:this.owner.findAppWindow(),reader:new Ext.data.JsonReader({idProperty:"version_id",root:"version_info_list",totalProperty:"total",fields:[{name:"version_id",mapping:"version_id"},{name:"name",mapping:"name"},{name:"modify",mapping:"modify"},{name:"status",mapping:"status"},{name:"timestamp",mapping:"timestamp"}]})})},getVersionId:function(){return this.getComponent("version_selector").getValue()},getVersionDate:function(){var a=this.getVersionId();return this.getComponent("version_selector").getStore().getById(a).get("name")},getVersionPanel:function(){return this.versionPanel}});Ext.define("SYNO.SDS.Backup.Restore.ShareStep",{extend:"Ext.Container",loaded:false,version_selector:(Ext.isIE6||Ext.isIE7)?"combobox":"timeline",constructor:function(a){Ext.copyTo(this,a,"owner,repoId,targetId,taskId");this.versionFileTree=new SYNO.SDS.Backup.VersionFileTree({itemId:"version_file_tree",owner:this.owner,versionPanel:this,isSingle:this.owner.isSingle,getBaseParams:this.getLoadVersionListParams.createDelegate(this),height:380});var b=Ext.apply({itemId:"version_panel",style:{padding:"12px 20px 0px 20px"},layout:"vbox",layoutConfig:{align:"stretch",pack:"start"},items:[new SYNO.ux.FieldSet({flex:1,title:_T("backup","reswizard_share_title"),layout:"fit",items:[this.versionFileTree]})]},a);return this.callParent([b])},getFileSourcePanel:function(){return this.versionFileTree},getVersionSelectPanel:function(){return this.versionSelector},showVersionSelector:function(a){if(this.versionSelector){this.versionSelector.setVisible(a)}else{if(a){if(this.version_selector==="timeline"){this.versionSelector=new SYNO.SDS.Backup.TimeLine({owner:this.owner,getBaseParams:this.getLoadVersionListParams.createDelegate(this),height:120,listeners:{select:this.reloadTree,scope:this}})}else{this.versionSelector=new SYNO.SDS.Backup.VersionSelector({owner:this.owner,height:60,versionPanel:this})}this.add(this.versionSelector)}}if(a&&this.version_selector==="timeline"){this.owner.getFooterToolbar().getEl().addClass("syno-backup-timeline-fbar")}else{this.owner.getFooterToolbar().getEl().removeClass("syno-backup-timeline-fbar")}},isReloadNeeded:function(){var a=this.getLoadVersionListParams();a=Ext.encode(a);if(this.lastQuery===a){return false}this.lastQuery=a;return true},activate:function(){if(this.owner.isSingle!==this.getFileSourcePanel().isSingle){this.getFileSourcePanel().isSingle=this.owner.isSingle;this.getFileSourcePanel().loader=this.getFileSourcePanel().createTreeLoader()}if(-1!==this.owner.getStep("config").getVersionId()){this.showVersionSelector(false);if(this.isReloadNeeded()){this.reloadTree()}}else{this.showVersionSelector(true);if(this.isReloadNeeded()){this.reloadVersionList()}}},getNext:function(){var a=this.getFileSourcePanel().checkShare();if(""!==a){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),a);return false}this.owner.getFooterToolbar().getEl().removeClass("syno-backup-timeline-fbar");if(this.owner.getStep("app").isReloadNeeded()){this.isAppSkip=false;this.owner.setStatusBusy();this.owner.getStep("app").getStore().load({params:this.owner.getStep("app").getVersionAppParams(),scope:this,callback:function(b,c,d){this.owner.clearStatusBusy();if(d&&0===b.length){this.isAppSkip=true;this.owner.goNext(this.owner.getStep("app").getNext())}else{this.owner.goNext(this.nextId)}}})}else{if(this.isAppSkip){this.owner.goNext(this.owner.getStep("app").getNext())}else{this.owner.goNext(this.nextId)}}return false},getBack:function(){this.owner.getFooterToolbar().getEl().removeClass("syno-backup-timeline-fbar")},summary:function(c){var b=this.getFileSourcePanel().getFolderList();var a=[];Ext.each(b,function(e){var d=e.split("/")[1];if("@"===d[0]){e=e.replace(d,d.replace(/@/g,""))}a.push(e.substring(1))});if(-1===this.owner.getStep("config").getVersionId()){c.append(_T("backup","select_version"),this.getVersionDate())}if(0===a.length){c.append(_T("backup","restore_share"),_T("system","none_opt"))}else{c.append(_T("backup","restore_share"),a.join(", "))}},getLoadVersionListParams:function(){return Ext.apply({offset:0,limit:-1},this.owner.getBaseParams())},reloadVersionList:function(){if(this.version_selector==="combobox"){var a=this.getLoadVersionListParams();this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:a,scope:this,callback:function(f,c,d){this.owner.clearStatusBusy();if(!f){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(c.code),function(){this.owner.close()},this);return}var b=this.getVersionSelectPanel();var e=[];Ext.each(c.version_info_list,function(i,g,h){if("success"!==i.status){return}e.push(i)},this);if(0===e.length){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("backup","no_avail_version"),function(){this.owner.close()},this);return}b=b.getComponent("version_selector");b.getStore().loadData({version_info_list:e});b.setValue(e[0].version_id);b.setRawValue(e[0].name);if(this.lastQueryVersionList){this.getFileSourcePanel().getRootNode().reload()}this.getFileSourcePanel().getRootNode().expand()}})}else{if(this.version_selector==="timeline"){this.remove(this.versionSelector);this.versionSelector=null;this.showVersionSelector(true);this.doLayout()}}},getVersionId:function(){var a=this.owner.getStep("config").getVersionId();if(-1!==a){return a}if(this.getVersionSelectPanel()){return this.getVersionSelectPanel().getVersionId()}return -1},getVersionDate:function(){return this.getVersionSelectPanel().getVersionDate()},reloadTree:function(){this.getFileSourcePanel().getRootNode().removeAll();this.getFileSourcePanel().getRootNode().getUI().setCheckValue(false);this.getFileSourcePanel().getRootNode().reload()},getFolderList:function(){var b=this.getFileSourcePanel().getFolderList();var a=[];if(!this.owner.isSingle){return b}Ext.each(b,function(c){a.push(c.substring(1,c.length))});return a},getDssId:function(){return this.getFileSourcePanel().dss_id},getBaseParams:function(){var a={};if(this.versionSelector&&this.versionSelector.isVisible()){a.version_id=this.getVersionId()}return a},getParams:function(){return{dss_id:this.getDssId(),version_id:this.getVersionId(),share_list:this.getFolderList(),option:{conflict:"overwrite"}}}});Ext.define("SYNO.SDS.Backup.Restore.ProgressView",{extend:"SYNO.SDS.Backup.ExpandableListView",WINDOW_SIZE:5,constructor:function(a){this.transSizeBuf=[];this.callParent(arguments);this.addClass("syno-backup-restore-progress-listview")},createTpl:function(){var d='<span class="item-title">{name:htmlEncode}</span>';var b='<div class="{status_class}">{status_str}</div>';var a='<div class="syno-backup-usage" ext:qtip="{tran_speed}"><span class="blue-status" ext:qtip="{tran_speed}">{progress_left}</span>{progress_right}<div class="syno-backup-percentage-bar-bg"><div class="syno-backup-percentage-bar" style="width:{percentage * 2.2}px"></div></div></div>';var c=new Ext.XTemplate('<tpl for=".">','<div class="item-wrap">','<div class="item-summary">','<div class="item-icon {icon_cls} icon-task"></div>',"<div>",d,b,"</div>",'<tpl if="has_progress">',a,"</tpl>","</div>","</div>","</tpl>",'<div class="x-clear"></div>');return c},calTranSpeed:function(b){var d=this.transSizeBuf;var c=parseInt(b.get("processed_size"),10);if(d.size()>0&&d[0].tran_size>c){d.length=0}d.unshift({tran_size:c,tran_time:new Date().getTime()});if(d.size()>this.WINDOW_SIZE){d.pop()}if(d.size()>1){var a=(d[0].tran_size-d[d.size()-1].tran_size)*1000;if(a>=0){var e=a/(d[0].tran_time-d[d.size()-1].tran_time);b.data.tran_speed=SYNO.SDS.Backup.ConverSize(e,2)+"/s"}else{b.data.tran_speed=""}}else{b.data.tran_speed=""}},appStatusStringGet:function(a,c){var b;if("install"===c){b="installing_something"}else{if("reinstall"===c){b="reinstalling_something"}else{if("upgrade"===c){b="upgrading_something"}else{b="restoring_something"}}}return String.format(_T("backup",b),a)},prepareData:function(d,b,a){if("done"===d.status){d.status_str=_T("backup","restore_success");d.status_class="green-status"}else{if("waiting"===d.status){d.status_str=_T("netbackup","netbkp_wait_sync");d.status_class="disable-font"}else{if("failed"===d.status){d.status_str=_T("backup","restore_fail");d.status_class="red-status"}else{if("canceled"===d.status){d.status_str=_T("usbbackup","usbbkp_cancel");d.status_class="red-status"}else{if("partial"===d.status){d.status_str=_T("backup","restore_fail");d.status_class="red-status"}else{if("canceling"===d.status){d.status_str=_T("backup","restore_do_cancel");d.status_class="red-status"}else{if("app"===d.stage){d.progress_left=d.processed_size+"";d.progress_right="&nbsp;/&nbsp;"+d.total_size;if(d.current_object_name){d.status_str=this.appStatusStringGet(d.current_object_name,d.current_object_status)}else{d.status_str=_T("backup","restoring")}}else{if("shared_folder"===d.stage){if("0"!==d.total_size){this.calTranSpeed(a);d.progress_left=SYNO.SDS.Backup.ConverSize(d.processed_size,2);d.progress_right="&nbsp;/&nbsp;"+SYNO.SDS.Backup.ConverSize(d.total_size,2);if(d.current_object_name){d.status_str=String.format(_T("backup","restoring_something"),d.current_object_name)}else{d.status_str=_T("backup","restoring")}}else{d.status_str=_T("backup","restoring")}}else{if("system_config"){d.progress_left=d.percentage+"%";if("initializing"===d.current_object_id){d.status_str=_T("confbackup","confbkp_st_init")}else{if("stopping_system_service"===d.current_object_id){d.status_str=_T("confbackup","confbkp_st_service_stop")}else{if("starting_system_service"===d.current_object_id){d.status_str=_T("confbackup","confbkp_st_service_start")}else{if(d.current_object_name){d.status_str=String.format(_T("backup","restoring_something"),SYNO.SDS.Backup.converLanString(d.current_object_name))}else{d.status_str=_T("backup","restoring")}}}}}}}d.status_class="blue-status"}}}}}}d.has_progress=(d.progress_left)?true:false;var c={system_config:_T("confbackup","config"),shared_folder:_T("backup","data"),app:_T("backup","application")};if(d.stage in c){d.name=c[d.stage]}else{d.name=d.stage}d.icon_cls="syno-backup-restore-progress-"+d.stage;return d}});Ext.define("SYNO.SDS.Backup.Restore.ProgressPanel",{extend:"SYNO.ux.Panel",constructor:function(a){a=this.fillConfig(a);this.callParent([a])},initEvents:function(){this.on("afterrender",this.startPolling,this);this.on("beforeclose",this.stopPolling,this)},fillConfig:function(a){return Ext.apply({items:[this.fieldSet=new SYNO.ux.FieldSet({title:_T("backup","restore_progress"),items:[this.getView()]})]},a)},startPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Restore",version:1,method:"status",params:{restore_id:this.owner.restore_id}},interval:2,immediate:true,scope:this,status_callback:this.onPollingDone})},stopPolling:function(){this.pollUnreg(this.pollingID)},setCancelStatus:function(c){this.isCanceling=true;var b=[];var a=false;Ext.each(this.getStore().data.items,function(d){var e={};e.stage=d.data.stage;if(e.stage===c){a=true}e.status=a?"canceling":d.data.status;b.push(e)});this.getStore().loadData(b)},onPollingDone:function(d,a,c,b){if(!d){return}if(-1===this.owner.restore_id){this.owner.restore_id=a.restore_id;this.stopPolling();this.startPolling()}if("init"===a.current_stage||"system_config"===a.current_stage||"none"===a.current_stage||this.isCanceling){this.owner.getButton("cancel").disable()}else{this.owner.getButton("cancel").enable()}if(!(a.entire_stage)||0===a.entire_stage.length){if(0===this.owner.maskCnt){this.owner.setStatusBusy();this.fieldSet.hide()}return}if(a.finish){this.owner.getButton("ok").enable();this.owner.getButton("cancel").disable();this.owner.raiseIssue(a.app_issue_list);Ext.each(a.entire_stage,function(e){if("app"===e.stage){SYNO.SDS.StatusNotifier.fireEvent("thirdpartychanged")}},this);this.stopPolling();if(Ext.isDefined(a.init_error_code)){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.init_error_code),function(){this.owner.close()},this)}}else{if(this.isCanceling){return}}if(!a.finish&&"success"===a.current_stage){if(0===this.owner.maskCnt){this.owner.setStatusBusy()}}else{this.owner.clearStatusBusy()}this.view.setHeight(10+a.entire_stage.length*50);this.fieldSet.setVisible(true);this.getStore().loadData(a.entire_stage)},getStore:function(){if(!this.store){this.store=new Ext.data.JsonStore({id:"stage",fields:["stage","status","percentage","total_size","processed_size","current_object_id","current_object_name","current_object_status"]})}return this.store},getView:function(){if(!this.view){var a={store:this.getStore(),owner:this,autoFlexcroll:false};this.view=new SYNO.SDS.Backup.Restore.ProgressView(a)}return this.view}});Ext.define("SYNO.SDS.Backup.Restore.ProgressWindow",{extend:"SYNO.SDS.ModalWindow",dsmStyle:"v5",constructor:function(a){Ext.copyTo(this,a,"owner");var b=Ext.apply({resizable:false,banner:false,layout:"fit",width:820,height:580,bodyCssClass:"sds-wizard-step",items:[this.wrapPanel=new SYNO.ux.Panel({autoFlexcroll:true,bwrapCfg:{cls:"x-panel-bwrap sds-wizard-step-bwrap"},items:[this.progressPanel=new SYNO.SDS.Backup.Restore.ProgressPanel({owner:this})]})],buttons:[{xtype:"syno_button",itemId:"ok",btnStyle:"blue",disabled:true,text:_T("common","ok"),btnStle:"blue",scope:this,handler:this.close},{xtype:"syno_button",itemId:"cancel",disabled:true,text:_T("common","cancel"),scope:this,handler:function(){this.getMsgBox().confirm(_T("tree","leaf_backup"),_T("backup","restore_cancel_confirm"),function(c){if(c==="yes"){this.onRestoreCancel()}},this)}}]},a);this.callParent([b])},getButton:function(a){return this.getFooterToolbar().getComponent(a)},raiseIssue:function(a){if(!a||0===a.length){return}Ext.each(a,function(b){b.err=SYNO.SDS.Backup.convertAppError(b.error_code,b.error_string)},this);this.wrapPanel.add(new SYNO.ux.FieldSet({title:_T("backup","app_issues"),items:[new Ext.Container({data:a,cls:"syno-ux-expandable-listview",tpl:'<tpl for="."><div class="item-wrap"><div class="item-summary"><div class="item-icon" style="background-size: cover;background-image:url('+SYNO.SDS.Backup.AppIconPath+');"}></div><div><span class="item-title">{name:htmlEncode}</span><tpl if="version != null && version != \'\'"><span class="normal-font"> ({version:htmlEncode}) </span></tpl><div class="red-status">{err:htmlEncode}</div></div></div></div></tpl><div class="x-clear"></div>'})]}));this.wrapPanel.doLayout()},onRestoreCancel:function(){this.getButton("cancel").disable();this.setStatusBusy();this.progressPanel.stopPolling();this.sendWebAPI({api:"SYNO.Backup.Restore",version:1,method:"cancel",scope:this,callback:function(c,a,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}this.progressPanel.setCancelStatus(a.current_stage);this.progressPanel.startPolling()}})}});Ext.define("SYNO.SDS.Backup.SummaryStep",{extend:"SYNO.SDS.Wizard.SummaryStep",fieldRenderer:function(a){return'<b ext:qtip="'+a+'">'+a+"</b>"}});Ext.define("SYNO.SDS.Backup.Restore.BasicRestoreWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",deepApply:function(c,a){for(var b in a){if("object"===typeof a[b]&&a[b].constructor===Object&&"object"===typeof c[b]&&c[b].constructor===Object&&c[b]){Ext.apply(c[b],a[b])}else{c[b]=a[b]}}},getParams:function(){var a={task_id:this.taskId};Ext.each(this.stepStack,function(c){var b=this.getStep(c);if(Ext.isFunction(b.getParams)){this.deepApply(a,b.getParams())}},this);return a},getBaseParams:function(b){var c={task_id:this.taskId};var a=this.stepStack.slice(0);if(b&&-1===a.indexOf(b)){a.push(b)}Ext.each(a,function(e){var d=this.getStep(e);if(Ext.isFunction(d.getBaseParams)){this.deepApply(c,d.getBaseParams())}else{if(Ext.isFunction(d.getParams)){this.deepApply(c,d.getParams())}}},this);return c},onRestore:function(){var a=this.getParams();this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Restore",method:"restore",version:2,params:a,scope:this,callback:function(d,b,c){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(b.code));return}var e=new SYNO.SDS.Backup.Restore.ProgressWindow({restore_id:b.restore_id,owner:this.owner});this.un("close",this.restoreTaskPage.onStartPolling,this.restoreTaskPage);e.on("close",this.restoreTaskPage.onStartPolling,this.restoreTaskPage);this.close();e.open()}})}});Ext.define("SYNO.SDS.Backup.Restore.RestoreWizard",{extend:"SYNO.SDS.Backup.Restore.BasicRestoreWizard",dsmStyle:"v5",constructor:function(a){Ext.copyTo(this,a,"owner");this.taskRecord=a.taskRecord;this.targetType=this.taskRecord.get("type").split(":")[0];this.transferType=this.taskRecord.get("type").split(":")[1];this.taskSupportMutiVersion=this.taskRecord.get("task_multi_version");this.repoId=this.taskRecord.get("repo_id");this.targetId=this.taskRecord.get("target_id");this.taskId=this.taskRecord.get("task_id");this.blChangeRcvrSrc=true;this.isSingle=(("share"===this.targetType||"cloud"===this.targetType)&&true!==this.taskSupportMutiVersion);var b=Ext.apply({resizable:false,banner:false,layout:"fit",width:800,height:580,steps:this.createSteps(),listeners:{activate:{scope:this,fn:this.onActivate}}},a);return this.callParent([b])},createSteps:function(){var a=[new SYNO.SDS.Backup.Restore.ConfigStep({itemId:"config",nextId:"share",owner:this}),new SYNO.SDS.Backup.Restore.ShareStep({itemId:"share",nextId:"app",owner:this}),new SYNO.SDS.Backup.Restore.AppStep({itemId:"app",nextId:"summary",owner:this}),new SYNO.SDS.Backup.SummaryStep({itemId:"summary",nextId:null,getNext:function(){this.owner.onRestore();return false},owner:this})];return a}});Ext.define("SYNO.SDS.Backup.Restore.LocalDestStep",{extend:"SYNO.ux.FormPanel",comboboxWidth:340,constructor:function(b){Ext.copyTo(this,b,"owner");var a=[];if(!this.owner._D("usbstation")){this.addVersionBackupFields(a)}this.addLocalBackupFields(a);this.callParent([Ext.apply({items:[{xtype:"syno_fieldset",title:_T("backup","local_restore_folder_title"),defaults:{labelWidth:300},items:a}]},b)])},addVersionBackupFields:function(a){a.push({xtype:"syno_radio",boxLabel:_T("backup","version_restore"),name:"target_type",itemId:"version_backup",inputValue:"image"},{xtype:"syno_combobox",indent:1,fieldLabel:_T("volume","volume"),name:"volume",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,listeners:{scope:this,select:this.onVolumeSelect},tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",indent:1,fieldLabel:_T("backup","task_name"),emptyText:_T("backup","no_available_target"),name:"image_target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value","display"]}),displayField:"display",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,tpl:'<tpl for="."><div ext:qtip="{display:htmlEncode}" class="x-combo-list-item">{display:htmlEncode}</div></tpl>'})},addLocalBackupFields:function(b){var a=1;if(this.owner._D("usbstation")){a=0}b.push({xtype:"syno_radio",boxLabel:_T("backup","local_restore_share"),name:"target_type",itemId:"local_backup",hidden:this.owner._D("usbstation")?true:false,inputValue:"share"},{xtype:"syno_combobox",indent:a,fieldLabel:_T("backup","local_restore_rcvr_folder"),name:"share",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,listeners:{scope:this,select:this.onShareSelect},tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",indent:a,fieldLabel:_T("backup","backup_dest_directory"),emptyText:_T("backup","no_available_target"),name:"local_target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'})},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){var a;a=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"target_type",{image:["image_target","volume"],share:["local_target","share"]})},this,{single:true})},onShareSelect:function(c,a,b){this.loadLocalTarget(c.getValue())},onVolumeSelect:function(c,a,b){this.loadImageTarget(c.getValue())},activate:function(){},getOption:function(){return this.getForm().findField("target_type").getGroupValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.owner.setSingle("share"===this.getOption());return this.nextId},getParams:function(){var a=this.getForm(),c=function(d){return a.findField(d).getValue()};var b=this.getOption();if(b==="share"){return{target_type:"share",transfer_type:"local",share:c("share"),target_id:c("local_target")}}else{return{target_type:"image",transfer_type:"image_local",volume:c("volume"),target_id:c("image_target")}}},summary:function(a){var c=this.getParams();if(c.target_type==="image"){var b=SYNO.SDS.Backup.Util.parseImgTaskDisplay(this.getForm().findField("image_target").rawValue);a.append(_T("backup","restore_type"),_T("backup","local_restore"));a.append(_T("backup","backup_restore_source"),c.volume);a.append(_T("smart","smart_id"),c.target_id);if(""!==b.task_name){a.append(_T("backup","task_name"),b.task_name)}if(""!==b.host_name){a.append(_T("backup","source_host_name"),b.host_name)}}else{a.append(_T("backup","restore_type"),_T("backup","local_restore"));a.append(_T("backup","backup_restore_source"),c.share+"/"+c.target_id)}},loadData:function(c){var b,a=this.getComponent(0);if(!this.owner._D("usbstation")){if(this.loadVolumeData(c.result[1].result_list[0])){b="image";a.getComponent("version_backup").enable()}else{a.getComponent("version_backup").disable()}}if(this.loadShareData(c.result[0].result_list[0])){b=b||"share";a.getComponent("local_backup").enable()}else{a.getComponent("local_backup").disable()}if(b){this.getForm().setValues({target_type:b});return true}else{return false}},loadShareData:function(c){var a=this.getForm().findField("share");var b=this.getForm().findField("local_target");SYNO.SDS.Backup.Util.comboboxLoadData(a,c.share_list);SYNO.SDS.Backup.Util.comboboxLoadData(b,c.target_list);if(c.share_list&&c.share_list.length>0&&c.target_list&&c.target_list.length>0){b.lastSelectShare=c.share_list[0];this.getComponent(0).getComponent("local_backup").enable();return true}else{this.getComponent(0).getComponent("local_backup").disable();return false}},loadVolumeData:function(c){var a=this.getForm().findField("volume");var b=this.getForm().findField("image_target");SYNO.SDS.Backup.Util.comboboxLoadData(a,c.volume_list);SYNO.SDS.Backup.Util.createImgTaskDisplay(c.target_list);SYNO.SDS.Backup.Util.comboboxLoadData(b,c.target_list,"target_id","display");if(c.volume_list.length>0&&c.target_list.length>0){a.setValue(c.selected);b.lastSelectVolume=c.selected;this.getComponent(0).getComponent("version_backup").enable();return true}else{this.getComponent(0).getComponent("version_backup").disable();return false}},loadLocalTarget:function(a){if(this.lastSelectedShare===a){return}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.owner.api.send({api:"SYNO.Backup.Target",method:"find",params:{target_type:"share",transfer_type:"local",share:a},version:1,callback:function(d,c,b){this.owner.clearStatusBusy();if(!d){this.owner.api.alert(c);return}this.lastSelectShare=a;this.loadLocalTargetData(c)},scope:this})},loadLocalTargetData:function(b){var a=this.getForm().findField("local_target");return SYNO.SDS.Backup.Util.comboboxLoadData(a,b.target_list,"target_id","display")},loadImageTarget:function(a){if(this.lastSelectedVolume===a){return}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.owner.api.send({api:"SYNO.Backup.Target",method:"find",params:{target_type:"image",transfer_type:"image_local",volume:a},version:1,callback:function(d,c,b){this.owner.clearStatusBusy();if(!d){this.owner.api.alert(c);return}this.lastSelectedVolume=a;this.loadImageTargetData(c)},scope:this})},loadImageTargetData:function(b){var a=this.getForm().findField("image_target");SYNO.SDS.Backup.Util.createImgTaskDisplay(b.target_list);return SYNO.SDS.Backup.Util.comboboxLoadData(a,b.target_list,"target_id","display")}});Ext.define("SYNO.SDS.Backup.Restore.NetworkAuthStep",{extend:"SYNO.ux.FormPanel",constructor:function(b){var a=[];Ext.copyTo(this,b,"owner");this.fieldLabelWidth=300;this.server_type=0;this.configFields(a);this.callParent([Ext.apply({trackResetOnLoad:true,items:[{xtype:"syno_fieldset",title:_T("netbackup","recover_serverset_title"),defaults:{labelWidth:this.fieldLabelWidth},items:a}]},b)]);this.mon(this,"activate",function(){var c=this.getForm().findField("sshportcheck");if(this.isSynologyServer()&&c&&c.getEl()&&3===Ext.getDom(c.getEl()).parentNode.childNodes.length){SYNO.SDS.Utils.AddTip(c.getEl(),_T("netbackup","netbkp_ssh_port_info_restore"))}},this,{single:true})},configFields:function(a){a.push({xtype:"syno_combobox",name:"network_type",fieldLabel:_T("netbackup","netbkp_slct_server"),allowBlank:false,store:new Ext.data.ArrayStore({fields:["type_name"],data:[[String.format(_T("netbackup","synology_server"),_D("company_title"))],[_T("netbackup","rsync_compatible_server")]]}),displayField:"type_name",valueField:"type_name",editable:false,value:String.format(_T("netbackup","synology_server"),_D("company_title")),listeners:{scope:this,select:function(c,b,d){c.setValue(b.get("type_name"));this.server_type=d;this.changeView()}}},new SYNO.SDS.Backup.HostCombobox({name:"server",owner:this.owner}),{xtype:"syno_textfield",fieldLabel:_T("netbackup","netbkp_account"),name:"account",allowBlank:false},{xtype:"syno_textfield",fieldLabel:_T("common","password"),name:"password",allowBlank:true,inputType:"password"},{xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_checkbox",name:"sshportcheck",boxLabel:_T("netbackup","encryption_enable"),width:this.fieldLabelWidth-5,scope:this,handler:function(c,b){if(b){this.getForm().findField("enc_port").enable()}else{this.getForm().findField("enc_port").disable()}}},{xtype:"syno_numberfield",maxlength:5,vtype:"port",disabled:true,name:"enc_port",width:200,allowBlank:false,value:22}]},{xtype:"syno_displayfield",value:""},{xtype:"syno_combobox",name:"module",fieldLabel:_T("netbackup","netbkp_module"),store:new Ext.data.ArrayStore({fields:["value"]}),valueField:"value",displayField:"value",editable:true,triggerAction:"all",mode:"local",hidden:true,disabled:true,onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadModule()){this.scope.loadModules()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},listeners:{select:this.onSelectModule,scope:this},scope:this,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",fieldLabel:_T("backup","backup_dest_directory"),name:"rsync_target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",hidden:true,disabled:true,onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadTarget()){this.scope.loadTarget()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},scope:this,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'})},isSynologyServer:function(){if(0===this.server_type){return true}return false},changeView:function(){var a=this.getForm().findField("sshportcheck");if(this.isSynologyServer()){this.getForm().findField("module").setVisible(false);this.getForm().findField("module").setDisabled(true);this.getForm().findField("rsync_target").setVisible(false);this.getForm().findField("rsync_target").setDisabled(true);if(a&&a.getEl()&&3===Ext.getDom(a.getEl()).parentNode.childNodes.length){SYNO.SDS.Utils.AddTip(a.getEl(),_T("netbackup","netbkp_ssh_port_info_restore"))}}else{this.getForm().findField("module").setVisible(true);this.getForm().findField("module").setDisabled(false);this.getForm().findField("rsync_target").setVisible(true);this.getForm().findField("rsync_target").setDisabled(false);if(a&&a.getEl()&&4===Ext.getDom(a.getEl()).parentNode.childNodes.length){Ext.getDom(a.getEl()).parentNode.lastChild.remove(true)}}},getNext:function(){if(!this.getForm().isValid()){return false}if(this.isSynologyServer()){this.loadDestOptions();return false}else{this.owner.setSingle(true);return this.owner.getStep(this.nextId).nextId}},getParams:function(){var a=this.getForm(),d=function(e){return a.findField(e).getValue()};var c=a.findField("server");var b={account:d("account"),dest:c.getHostName()?c.getHostName():c.getHostIp(),pwd:d("password"),enc_port:d("sshportcheck")?d("enc_port"):0};if(!this.isSynologyServer()){b.target_type="share";b.transfer_type="rsync";b.module=d("module");b.target_id=d("rsync_target")}return b},summary:function(a){if(!this.isSynologyServer()){var b=this.getParams();a.append(_T("backup","restore_type"),_T("backup","network_restore"));a.append(_T("netbackup","netbkp_slct_server"),_T("netbackup","rsync_compatible_server"));a.append(_T("backup","backup_server_name"),b.dest);a.append(_T("netbackup","netbkp_auth_user"),b.account);a.append(_T("backup","backup_restore_source"),b.module+"/"+b.target_id)}},loadDestOptions:function(){var a=this.getParams();a=Ext.apply({connect_list:[{target_type:"share",transfer_type:"rsync_ds",enc_port:a.enc_port},{target_type:"image",transfer_type:"image_remote"}]},a);delete a.enc_port;this.owner.setStatusBusy({text:_T("netbackup","netbkp_wait_server")});this.sendWebAPI({api:"SYNO.Backup.Repository",method:"find",version:1,params:a,callback:this.onLoadDestOptions,scope:this})},onLoadDestOptions:function(d,c,b){var a=this.owner.getStep(this.nextId);this.owner.clearStatusBusy();if(!d){this.owner.api.alert(c);return}if(a.loadData(c)){this.owner.goNext(this.nextId)}},getListModuleRequest:function(){var a=this.getParams();a=Ext.apply({connect_list:[{target_type:a.target_type,transfer_type:a.transfer_type,enc_port:a.enc_port}]},a);delete a.transfer_type;delete a.target_type;delete a.enc_port;delete a.module;delete a.target_id;return a},needReloadModule:function(){var a=this.getListModuleRequest();return this.lastQueryModule!==Ext.encode(a)},loadModules:function(){var a=this.getListModuleRequest();if(!a.account||!a.dest||Ext.isEmpty(a.connect_list[0].enc_port,false)){return}this.owner.setStatusBusy({text:_T("netbackup","rsync_get_module_mask")});this.sendWebAPI({api:"SYNO.Backup.Repository",method:"find",version:1,params:a,callback:function(d,c,b){this.owner.clearStatusBusy();if(!d){this.owner.api.alert(c);return}this.lastQueryModule=Ext.encode(a);this.loadModulesData(c.result_list[0])},scope:this})},loadModulesData:function(b){var a=this.getForm().findField("module");if(!b.share_list||b.share_list.length<1){return false}return SYNO.SDS.Backup.Util.comboboxLoadData(a,b.share_list)},onSelectModule:function(a){this.loadTarget(a.getValue())},getLoadTargetParam:function(){var a=this.getParams();delete a.target_id;return a},needReloadTarget:function(){var a=this.getLoadTargetParam();return this.lastQueryTarget!==Ext.encode(a)},loadTarget:function(a){var b=this.getLoadTargetParam();if(!b.account||!b.dest||Ext.isEmpty(b.enc_port,false)||!b.module){return}if(this.lastQueryTarget===Ext.encode(b)){return}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.sendWebAPI({api:"SYNO.Backup.Target",method:"find",version:1,params:b,callback:function(e,d,c){this.owner.clearStatusBusy();if(!e){this.loadTargetData({target_list:[]});this.owner.api.alert(d);delete this.lastQueryTarget;return}this.lastQueryTarget=Ext.encode(b);if(!this.loadTargetData(d)){this.owner.api.alert(_T("netbackup","bkp_host_share_no_dir"))}},scope:this})},loadTargetData:function(b){var a=this.getForm().findField("rsync_target");if(!b||!b.target_list||b.target_list.length<1){a.getStore().removeAll();a.setValue("");return false}SYNO.SDS.Backup.Util.comboboxLoadData(a,b.target_list,"target_id");a.setValue(b.target_list[0].target_id);return true}});Ext.define("SYNO.SDS.Backup.Restore.NetworkDestStep",{extend:"SYNO.ux.FormPanel",comboboxWidth:340,constructor:function(b){var a=[];Ext.copyTo(this,b,"owner");this.addVersionBackupFields(a);this.addNetworkBackupFields(a);this.callParent([Ext.apply({items:[{xtype:"syno_fieldset",title:_T("netbackup","netbkp_restore_share_title"),defaults:{labelWidth:300},items:a}]},b)])},addVersionBackupFields:function(a){a.push({xtype:"syno_radio",boxLabel:_T("backup","version_restore"),name:"target_type",itemId:"version_backup",inputValue:"image"},{xtype:"syno_combobox",indent:1,fieldLabel:_T("volume","volume"),name:"volume",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",listeners:{scope:this,select:this.onVolumeSelect},width:this.comboboxWidth,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",indent:1,fieldLabel:_T("backup","task_name"),emptyText:_T("backup","no_available_target"),name:"image_target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.JsonStore({root:"target_list",idProperty:"target_id",fields:["target_id","support_multi_version","display"]}),displayField:"display",valueField:"target_id",triggerAction:"all",mode:"local",width:this.comboboxWidth,tpl:'<tpl for="."><div ext:qtip="{display:htmlEncode}" class="x-combo-list-item">{display:htmlEncode}</div></tpl>'},{xtype:"syno_displayfield",name:"version_backup_error_message",value:"",style:{color:"red"},hidden:true,indent:1})},addNetworkBackupFields:function(a){a.push({xtype:"syno_radio",boxLabel:_T("backup","network_restore_share"),name:"target_type",itemId:"network_backup",inputValue:"share"},{xtype:"syno_combobox",indent:1,fieldLabel:_T("netbackup","restore_share_folder"),name:"share",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,listeners:{scope:this,select:this.onShareSelect},tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",indent:1,fieldLabel:_T("backup","backup_dest_directory"),name:"network_target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.ArrayStore({fields:["value"]}),displayField:"value",valueField:"value",triggerAction:"all",mode:"local",width:this.comboboxWidth,onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadShareTarget()){this.scope.loadShareTarget()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},scope:this,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_displayfield",name:"network_backup_error_message",value:"",style:{color:"red"},hidden:true,indent:1})},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){var a;a=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"target_type",{image:["image_target","volume"],share:["network_target","share"]})},this,{single:true})},onShareSelect:function(a){this.loadShareTarget(a.getValue())},onVolumeSelect:function(a){this.loadImageTarget(a.getValue())},getOption:function(){return this.getForm().findField("target_type").getGroupValue()},activate:function(){if(this.getComponent(0).getComponent("version_backup").disabled){this.getForm().findField("volume").setVisible(false);this.getForm().findField("image_target").setVisible(false);this.getForm().findField("version_backup_error_message").setVisible(true)}else{this.getForm().findField("volume").setVisible(true);this.getForm().findField("image_target").setVisible(true);this.getForm().findField("version_backup_error_message").setVisible(false)}if(this.getComponent(0).getComponent("network_backup").disabled){this.getForm().findField("share").setVisible(false);this.getForm().findField("network_target").setVisible(false);this.getForm().findField("network_backup_error_message").setVisible(true)}else{this.getForm().findField("share").setVisible(true);this.getForm().findField("network_target").setVisible(true);this.getForm().findField("network_backup_error_message").setVisible(false)}},getNext:function(){if(!this.getForm().isValid()){return false}if(("image"===this.getOption()&&!this.getComponent(0).getComponent("version_backup").disabled)||("share"===this.getOption()&&!this.getComponent(0).getComponent("network_backup").disabled)){this.owner.setSingle("share"===this.getOption());return this.nextId}this.owner.api.alert(_T("backup","restore_no_dest"));return false},getParams:function(){var a=this.getForm(),b=function(c){return a.findField(c).getValue()};if(this.getOption()==="image"){return{transfer_type:"image_remote",target_type:"image",volume:b("volume"),target_id:b("image_target")}}else{return{transfer_type:"rsync_ds",target_type:"share",module:b("share"),target_id:b("network_target")}}},summary:function(a){var c=this.owner.getParams();if(c.target_type==="image"){var b=SYNO.SDS.Backup.Util.parseImgTaskDisplay(this.getForm().findField("image_target").rawValue);a.append(_T("backup","restore_type"),_T("backup","network_restore"));a.append(_T("netbackup","netbkp_slct_server"),String.format(_T("netbackup","synology_server"),_D("company_title")));a.append(_T("backup","backup_server_name"),c.dest);a.append(_T("netbackup","netbkp_auth_user"),c.account);a.append(_T("backup","backup_restore_source"),c.volume);a.append(_T("smart","smart_id"),c.target_id);if(""!==b.task_name){a.append(_T("backup","task_name"),b.task_name)}if(""!==b.host_name){a.append(_T("backup","source_host_name"),b.host_name)}}else{a.append(_T("backup","restore_type"),_T("backup","network_restore"));a.append(_T("netbackup","netbkp_slct_server"),String.format(_T("netbackup","synology_server"),_D("company_title")));a.append(_T("backup","backup_server_name"),c.dest);a.append(_T("netbackup","netbkp_auth_user"),c.account);a.append(_T("backup","backup_restore_source"),c.module+"/"+c.target_id)}},loadData:function(c){var b,a=this.getComponent(0);if(this.loadVolumeData(c.result_list[1])){b="image";a.getComponent("version_backup").enable()}else{a.getComponent("version_backup").disable()}if(this.loadShareData(c.result_list[0])){b=b||"share";a.getComponent("network_backup").enable()}else{a.getComponent("network_backup").disable()}if(b){this.getForm().setValues({target_type:b})}return true},loadShareData:function(d){var a=this.getForm().findField("share");var b=this.getForm().findField("network_target");if(d.share_list&&d.share_list.length>0){return SYNO.SDS.Backup.Util.comboboxLoadData(a,d.share_list)}else{SYNO.SDS.Backup.Util.comboboxLoadData(b,[]);var c;if(d.code){c=SYNO.SDS.Backup.GetErrorString(d.code)}else{c=String.format(_T("netbackup","err_no_share"))}this.getForm().findField("network_backup_error_message").setValue(c);return false}},loadVolumeData:function(c){var a=this.getForm().findField("volume");SYNO.SDS.Backup.Util.comboboxLoadData(a,c.volume_list);this.loadImageTargetData(c);if((c.volume_list&&c.volume_list.length>0)&&(c.target_list&&c.target_list.length>0)){a.setValue(c.selected);this.lastSelectedVolume=c.selected;return true}else{var b;if(c.code){b=SYNO.SDS.Backup.GetErrorString(c.code)}else{b=String.format(_T("netbackup","err_no_volume")+"<br>"+_T("backup","no_restore_volume_reason"))}this.getForm().findField("version_backup_error_message").setValue(b);return false}},getLoadShareTargetParams:function(){var a=this.getParams();delete a.target_id;return Ext.apply(this.owner.getParams(),a)},needReloadShareTarget:function(){var a=this.getLoadShareTargetParams();return this.lastSelectedShare!==Ext.encode(a)},loadShareTarget:function(a){var b=this.getLoadShareTargetParams();if(this.lastSelectedShare===Ext.encode(b)){return}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.sendWebAPI({api:"SYNO.Backup.Target",method:"find",version:1,params:b,callback:function(e,d,c){this.owner.clearStatusBusy();if(!e){this.loadShareTargetData({target_list:[]});this.owner.api.alert(d);delete this.lastSelectedShare;return}this.lastSelectedShare=Ext.encode(b);if(!this.loadShareTargetData(d)){this.owner.api.alert(_T("netbackup","bkp_host_share_no_dir"))}},scope:this})},loadShareTargetData:function(b){var a=this.getForm().findField("network_target");if(!b||!b.target_list||b.target_list.length<1){a.getStore().removeAll();a.setValue("");return false}SYNO.SDS.Backup.Util.comboboxLoadData(a,b.target_list,"target_id");a.setValue(b.target_list[0].target_id);return true},loadImageTarget:function(a){var b=Ext.apply({target_type:"image",transfer_type:"image_remote",volume:a},this.owner.getParams());delete b.enc_port;if(this.lastSelectedVolume===Ext.encode(b)){return}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.sendWebAPI({api:"SYNO.Backup.Target",method:"find",version:1,params:b,callback:function(e,d,c){this.owner.clearStatusBusy();if(!e){this.owner.api.alert(d);return}this.lastSelectedVolume=Ext.encode(b);this.loadImageTargetData(d)},scope:this})},loadImageTargetData:function(b){var a=this.getForm().findField("image_target");if(!b||!b.target_list||b.target_list.length<1){a.getStore().removeAll();a.setValue("");return false}SYNO.SDS.Backup.Util.createImgTaskDisplay(b.target_list);a.getStore().loadData(b,false);a.setValue(b.target_list[0].target_id);return true}});Ext.define("SYNO.SDS.Backup.Restore.OtherDestWizard",{extend:"SYNO.SDS.Backup.Restore.BasicRestoreWizard",constructor:function(b){var i=[];Ext.copyTo(this,b,"owner");this.api=new SYNO.SDS.Backup.ApiHelper({owner:this});this.taskId=-1;var f=SYNO.SDS.Backup.Addon.getList(this.owner);var d={};var a=[];var g=[];var c=function(j,k,l){j.push({xtype:"syno_radio",boxLabel:SYNO.SDS.Backup.Addon.GetStr(k,"addon","restore_wizard_name"),name:"bkptype",inputValue:k,checked:l});j.push({xtype:"syno_displayfield",value:SYNO.SDS.Backup.Addon.GetStr(k,"addon","restore_wizard_desc"),indent:1})};var h=function(m,j){var l=m+"_dest";var k=SYNO.SDS.Backup.Addon.GetSymbol(m,"Restore.DestStep");if(!k){return undefined}return new k({owner:j,itemId:l,nextId:"config"})};var e=true;Ext.each(f,function(k){var j=h(k.id,this);if(j){g.push(j);d[k.id]=k.id+"_dest";c(a,k.id,e);e=false}});this.addCommonSteps(i,d,a);this.addLocalSteps(i);this.addNetworkSteps(i);i=i.concat(g);return this.callParent([Ext.apply({title:_T("netbackup","netbkp_recovery"),width:800,height:580,banner:false,steps:i},b)])},setSingle:function(a){this.isSingle=a},addCommonSteps:function(a,c,d){var b={local:"local_dest",synology:"network_auth",cloud:"cloud_dest"};a.push(new SYNO.SDS.Backup.Restore.DestTypeStep({owner:this,itemId:"dest_type",nextId:b}),new SYNO.SDS.Backup.Restore.CloudTypeStep({itemId:"cloud_dest",nextId:c,addon_fields:d,owner:this}),new SYNO.SDS.Backup.Restore.ConfigStep({headline:_T("confbackup","bkp_import"),description:_T("confbackup","bkp_import"),itemId:"config",nextId:"share",owner:this}),new SYNO.SDS.Backup.Restore.ShareStep({headline:_T("backup","reswizard_share_app_title"),description:_T("backup","reswizard_share_app_title"),itemId:"share",nextId:"app",owner:this}),new SYNO.SDS.Backup.Restore.AppStep({headline:_T("backup","reswizard_share_app_title"),description:_T("backup","reswizard_share_app_title"),itemId:"app",nextId:"summary",owner:this}),new SYNO.SDS.Backup.SummaryStep({headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.onRestore();return false},owner:this}))},addLocalSteps:function(a){a.push(new SYNO.SDS.Backup.Restore.LocalDestStep({itemId:"local_dest",nextId:"config",owner:this}))},addNetworkSteps:function(a){a.push(new SYNO.SDS.Backup.Restore.NetworkAuthStep({itemId:"network_auth",nextId:"network_dest",owner:this}),new SYNO.SDS.Backup.Restore.NetworkDestStep({itemId:"network_dest",nextId:"config",owner:this}))},getDestType:function(){return this.getStep("dest_type").getOption()},reportError:function(a,b){b=b||{};if(!this.reporter){this.reporter=new SYNO.SDS.Backup.ApiHelper({owner:this})}this.reporter.alert(a,b.callback,b.scope)}});Ext.define("SYNO.SDS.Backup.Restore.DestTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(b){Ext.copyTo(this,b,"owner");var a=Ext.apply({items:{xtype:"syno_fieldset",title:_T("backup","restore_new_task"),items:this.configFields()}},b);return this.callParent([a])},configFields:function(){var a=[];a=[{xtype:"syno_radio",boxLabel:_T("backup","local_restore"),name:"bkptype",itemId:"local",inputValue:"local",checked:true},{xtype:"syno_displayfield",value:_T("backup","local_restore_desc"),indent:1},{xtype:"syno_radio",boxLabel:_T("backup","network_restore"),name:"bkptype",inputValue:"synology"},{xtype:"syno_displayfield",value:String.format(_T("backup","network_restore_desc"),_D("company_title")),indent:1},{xtype:"syno_radio",boxLabel:_T("backup","cloud_restore"),name:"bkptype",inputValue:"cloud"},{xtype:"syno_displayfield",value:_T("backup","cloud_restore_desc"),indent:1}];return a},getParams:function(){return{bkptype:this.getOption()}},getOption:function(){return this.getForm().findField("bkptype").getGroupValue()},getNext:function(){if(this.getOption()==="local"&&!this.loaded){this.loadLocalDestData();return false}return this.nextId[this.getOption()]},loadLocalDestData:function(){var a=[{api:"SYNO.Backup.Repository",method:"find",params:{connect_list:[{target_type:"share",transfer_type:"local"}]},version:1}];if(!this._D("usbstation")){a.push({api:"SYNO.Backup.Repository",method:"find",params:{connect_list:[{target_type:"image",transfer_type:"image_local"}]},version:1})}this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.owner.api.send(a,function(f,e,d){var b=this.nextId[this.getOption()];var c=this.owner.getStep(b);this.owner.clearStatusBusy();if(!f){this.owner.api.alert(e);return}if(c.loadData(e)){this.owner.goNext(b);this.loaded=true}else{this.owner.api.alert(_T("backup","restore_no_dest"),function(){this.getComponent(0).getComponent("local").disable();this.getForm().setValues({bkptype:"synology"})},this)}},this)}});Ext.define("SYNO.SDS.Backup.Restore.CloudTypeStep",{extend:"SYNO.ux.FormPanel",constructor:function(b){Ext.copyTo(this,b,"owner");var a=Ext.apply({items:{xtype:"syno_fieldset",title:_T("backup","restore_new_task"),items:b.addon_fields}},b);return this.callParent([a])},getParams:function(){return{bkptype:this.getOption()}},getOption:function(){return this.getForm().findField("bkptype").getGroupValue()},getNext:function(){return this.nextId[this.getOption()]}});Ext.define("SYNO.SDS.Backup.LUNResTypePanel",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,taskStore:null,constructor:function(b){this.bkptaskList=[];var d=b.grid;var e=true;var c;for(c=0;c<d.getCount();c++){var f=d.getAt(c);if(("success"===f.data.status)&&((SYNO.SDS.Backup.BKPTASK_LOCLUN===f.data.type)||(SYNO.SDS.Backup.BKPTASK_NETLUN===f.data.type))){this.bkptaskList.push([f.data.name,f.data.type,f.data.bkp_dest_type]);e=false}}this.taskStore=new Ext.data.SimpleStore({id:"bkptaskstore",fields:["bkpset","bkptype","bkp_dest_type"],data:this.bkptaskList});this.taskStore.loadData(this.bkptaskList,false);var a={items:[{xtype:"syno_displayfield",value:_T("backup","restore_current_task")},{xtype:"syno_radio",boxLabel:_T("backup","select_task"),name:"bkptype",inputValue:SYNO.SDS.Backup.BKPTASK_EXISTED,checked:true,disabled:e,indent:1},{xtype:"syno_combobox",name:"select_current_task",hiddenName:"select_current_task",width:200,listWidth:200,store:this.taskStore,valueField:"bkpset",displayField:"bkpset",editable:false,forceSelection:true,triggerAction:"all",selectOnFocus:true,scope:this,indent:2,hideLabel:true},{xtype:"syno_displayfield",value:String.format(_T("backup","restore_new_task"),_D("company_title"))},{xtype:"syno_radio",boxLabel:_T("lunbkp","local_lun_restore"),name:"bkptype",inputValue:SYNO.SDS.Backup.BKPTASK_LOCLUN,checked:e?true:false,indent:1},{xtype:"syno_displayfield",value:_T("lunbkp","local_lun_restore_desc"),indent:2},{xtype:"syno_radio",boxLabel:_T("lunbkp","network_lun_restore")+" ("+String.format(_T("netbackup","synology_server"),_D("company_title"))+")",name:"bkptype",inputValue:SYNO.SDS.Backup.BKPTASK_NETLUN,indent:1},{xtype:"syno_displayfield",value:String.format(_T("lunbkp","network_lun_restore_desc"),_D("company_title")),indent:2}]};Ext.apply(a,b);this.callParent([a])},registerEvent:function(){if(0<this.bkptaskList.length){this.getForm().findField("select_current_task").setValue(this.bkptaskList[0][0])}else{this.getForm().findField("select_current_task").setDisabled(true)}},activate:function(){if(!this.isActivatedBefore){this.isActivatedBefore=true;this.registerEvent()}},saveSettings:function(){var e=this.getForm();var c=e.findField("select_current_task").getValue();var a=e.findField("bkptype").getGroupValue();var d;this.owner.taskname=c;this.owner.bkptype=a;this.owner.desttype=a;if(SYNO.SDS.Backup.BKPTASK_EXISTED===this.owner.bkptype){this.owner.blExistedTask=true;var b=e.findField("select_current_task").getValue();for(d=0;d<this.taskStore.getTotalCount();d++){if(b===this.taskStore.getAt(d).data.bkpset){this.owner.bkptype=this.taskStore.getAt(d).data.bkptype;this.owner.desttype=this.taskStore.getAt(d).data.bkp_dest_type;break}}}else{this.owner.blExistedTask=false}},getNext:function(){this.saveSettings();if(this.owner.blExistedTask){return this.nextId[0]}else{if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.owner.bkptype){return this.nextId[2]}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===this.owner.bkptype){return this.nextId[3]}else{return false}}}},summary:function(a){}});Ext.define("SYNO.SDS.Backup.LUNResSynoSerPanel",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,ServerStore:null,constructor:function(b){this.ServerList=[];this.ServerStore=new Ext.data.SimpleStore({fields:["value","display"],data:this.ServerList});var a={items:[{xtype:"syno_combobox",fieldLabel:_T("netbackup","netbkp_set_ip"),hiddenName:"server",name:"server",forceSelection:false,allowBlank:false,emptyText:_T("netbackup","netbkp_input_addr"),editable:true,store:this.ServerStore,displayField:"display",valueField:"value",triggerAction:"all",lazyRender:true,queryDelay:1800000,width:200,validateOnBlur:true,validationEvent:"blur",validator:function(h){var e=b.owner.selfHostName;var c=b.owner.selfIPs;var g=new RegExp(e,"gi");if(h===c||h==="127.0.0.1"||(h.match(g)&&h.length===e.length)){return _T("netbackup","netbkp_sync_self")}var f=c.split(",");for(var d=0;d<f.length;d++){if(h===f[d]){return _T("netbackup","netbkp_sync_self")}}return true},onTriggerClick:function(){if(0!==this.getStore().getCount()){if(this.isExpanded()){this.collapse();this.el.focus()}else{this.onFocus({});this.expand();this.el.focus()}}else{this.scope.serverListLoaded=true;this.el.focus();SYNO.SDS.Backup.onLoadSynologyServer(this,this.scope.ServerList,this.scope.owner)}},scope:this},{xtype:"syno_textfield",fieldLabel:_T("netbackup","netbkp_account"),hiddenName:"account",name:"account",allowBlank:false,width:200,vtype:"username_ext"},{xtype:"syno_textfield",fieldLabel:_T("common","password"),name:"password",inputType:"password",width:200},{xtype:"syno_button",id:this.btnTestId=Ext.id(),labelSeparator:"",name:"testconbtn",hiddenName:"testconbtn",text:_T("netbackup","netbkp_test_connection"),handler:this.onTestConnectionButton,scope:this}]};Ext.apply(a,b);this.callParent([a])},activate:function(){},saveSettings:function(){this.owner.netRcvrParams={};this.owner.netRcvrParams.account=this.getForm().findField("account").getValue();this.owner.netRcvrParams.password=this.getForm().findField("password").getValue();var a=this.getForm().findField("server").getRawValue();this.owner.netRcvrParams.server=SYNO.SDS.Backup.GetServerName(a);this.owner.netRcvrParams.ip=SYNO.SDS.Backup.GetServerIP(a)},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();this.onTestConnectionButton("next");return false},summary:function(a){},TestServerVersionDone:function(c,d,b){var a;this.owner.clearStatusBusy();if(d&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_connection_testing_success"))}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_connection_testing_fail"))}},TestConnectionDone:function(c,e,b){var a;if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){var d={};d.action="remoteversioncheck";d.servertype="synology";d.share="share";d=this.getParamsVal(d);d.ip=a.ip;Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(d),callback:this.TestServerVersionDone,scope:this},this)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_connection_testing_fail"))}},TestServerVersionWhenGoNext:function(c,d,b){var a;this.owner.clearStatusBusy();if(d&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success||"netbkp_e_unknown"!==a.errinfo.key){this.owner.goNext(this.nextId)}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("lunbkp","server_version_error"))}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_connection_testing_fail"))}},TestConnectionWhenGoNext:function(c,e,b){var a;if(e&&b.responseText!==null){a=Ext.util.JSON.decode(b.responseText);if(a.success){var d={};d.action="enumnetlundir";d.servertype="synology";d.share="share";d=this.getParamsVal(d);d.ip=a.ip;Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(d),callback:this.TestServerVersionWhenGoNext,scope:this},this)}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key))}}else{this.owner.clearStatusBusy();this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_connection_testing_fail"))}},onTestConnectionButton:function(b){var a={};a.action="testconnections";a.servertype=SYNO.SDS.Backup.LUNBKP_SYNO_SERVER;a=this.getParamsVal(a);if(a){var c=b==="next"?this.TestConnectionWhenGoNext:this.TestConnectionDone;SYNO.SDS.Backup.onTestSvrConnection(a,this,c)}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_err_host_str"))}},getParamsVal:function(e){var d=this.getForm();var b=d.findField("server").getRawValue();var a=SYNO.SDS.Backup.GetServerName(b);var c=SYNO.SDS.Backup.GetServerIP(b);if(a===""&&c===""){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","netbkp_err_host_str"));return false}e.server=a;e.ip=c;e.account=d.findField("account").getValue();e.password=d.findField("password").getValue();e.module="";e.incrbkp_enable=false;e.ssh_enable=false;e.compression_enable=false;e.blockbkp_enable=false;return e}});Ext.define("SYNO.SDS.Backup.LUNResNetShare",{extend:"SYNO.ux.FormPanel",initialized:false,RemoteStore:null,constructor:function(b){this.RemoteList=[];this.RemoteStore=new Ext.data.SimpleStore({id:"dsRemoteShare",fields:["value","display"],data:this.RemoteList});var a={items:[{xtype:"syno_combobox",fieldLabel:_T("netbackup","restore_share_folder"),name:"remoteShare",store:this.RemoteStore,allowBlank:false,displayField:"display",valueField:"value",width:250}]};Ext.apply(a,b);this.callParent([a])},activate:function(){if(!this.initialized){this.remoteShareEnum()}},saveSettings:function(){this.owner.netRcvrParams.module=this.getForm().findField("remoteShare").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();return this.nextId},summary:function(a){},remoteShareEnumDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}for(var b=0;b<a.items.length;b++){this.RemoteList.push([a.items[b].share,a.items[b].share])}this.RemoteStore.loadData(this.RemoteList,false);if(0<this.RemoteList.length){this.getForm().findField("remoteShare").setValue(this.RemoteList[0][0]);this.owner.netRcvrParams.ip=a.server_ip;this.owner.getButton("next").enable()}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("ftp","ftp_no_share"));this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","error_system"));this.owner.getButton("next").disable()}},remoteShareEnum:function(){var b;var a=this.owner.PanelSynoServer.getForm().findField("server").getRawValue();this.RemoteStore.removeAll();this.RemoteList.length=0;b={};b.action="lunenumremoteshare";b.user=this.owner.PanelSynoServer.getForm().findField("account").getRawValue();b.password=this.owner.PanelSynoServer.getForm().findField("password").getRawValue();b.server=SYNO.SDS.Backup.GetServerName(a);b.ip=SYNO.SDS.Backup.GetServerIP(a);b.type="lunrtor";this.owner.setStatusBusy({text:_T("netbackup","netbkp_search_folder")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(b),method:"POST",callback:this.remoteShareEnumDone,scope:this},this)}});Ext.define("SYNO.SDS.Backup.LUNResLocSrc",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,constructor:function(c){var a=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:c.owner.localRcvrSrcList});c.owner.localRcvrSrcStore=a;var d=new SYNO.ux.ComboBox({fieldLabel:_T("backup","local_restore_rcvr_folder"),hiddenName:"localrcvrsrc",name:"localrcvrsrc",forceSelection:true,editable:false,store:c.owner.localRcvrSrcStore,displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,width:200,value:"",mode:"local"});var b={items:[d]};Ext.apply(b,c);this.callParent([b])},activate:function(){if(!this.isActivatedBefore){this.isActivatedBefore=true;this.localRcvrSrcRequest()}},saveSettings:function(){this.owner.localRcvrSrc=this.getForm().findField("localrcvrsrc").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();return this.nextId},summary:function(a){},localRcvrSrcDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}for(var b=0;b<a.total;b++){this.owner.localRcvrSrcList.push([a.items[b],a.items[b]])}this.owner.localRcvrSrcStore.loadData(this.owner.localRcvrSrcList,false);if(0<this.owner.localRcvrSrcList.length){this.getForm().findField("localrcvrsrc").setValue(this.owner.localRcvrSrcList[0][0]);this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","error_system"));this.owner.getButton("next").disable()}},localRcvrSrcRequest:function(){this.owner.localRcvrSrcList.length=0;this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"enumlocalshare"},method:"POST",callback:this.localRcvrSrcDone,scope:this},this)}});Ext.define("SYNO.SDS.Backup.ResLocSrcCID",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,constructor:function(c){var b=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:c.owner.localSrcCIDList});c.owner.localSrcCIDStore=b;var d=new SYNO.ux.ComboBox({fieldLabel:_T("backup","backup_dest_directory"),hiddenName:"localsrccid",name:"localsrccid",forceSelection:true,editable:false,store:c.owner.localSrcCIDStore,displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,width:200,value:"",mode:"local"});var a={items:[d]};Ext.apply(a,c);this.callParent([a]);d.on("select",function(){this.owner.blChangeRcvrSrc=true},this)},activate:function(){this.localSrcCIDRequest()},saveSettings:function(){this.owner.localSrcCID=this.getForm().findField("localsrccid").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();return this.nextId},summary:function(a){},localSrcCIDDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}for(var b=0;b<a.total;b++){this.owner.localSrcCIDList.push([a.items[b],a.items[b]])}this.owner.localSrcCIDStore.loadData(this.owner.localSrcCIDList,false);if(0<this.owner.localSrcCIDList.length){this.getForm().findField("localsrccid").setValue(this.owner.localSrcCIDList[0][0]);this.owner.getButton("next").enable()}else{this.getForm().findField("localsrccid").setValue("");this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","error_system"));this.owner.getButton("next").disable()}},localSrcCIDRequest:function(){var a={};this.owner.localSrcCIDList.length=0;a.action="enumlocallundir";a.share=this.owner.localRcvrSrc;this.owner.setStatusBusy({text:_T("lunbkp","search_client_folder")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.localSrcCIDDone,scope:this},this)}});Ext.define("SYNO.SDS.Backup.ResDestVol",{extend:"SYNO.ux.FormPanel",isActivatedBefore:false,lunName:null,constructor:function(d){var e="yes"===_D("support_vaai","no")?true:false;var b=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:d.owner.destVolumeList});d.owner.destVolumeStore=b;var f=new SYNO.ux.ComboBox({fieldLabel:_T("localbkp","localbkp_dest"),hiddenName:"destvolume",name:"destvolume",forceSelection:true,editable:false,store:d.owner.destVolumeStore,displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,width:200,value:"",mode:"local"});var c={items:[f]};if(e){var a=new SYNO.ux.ComboBox({fieldLabel:_T("iscsitrg","iscsitrg_vaai"),hiddenName:"vaai_support",name:"vaai_support",forceSelection:true,editable:false,store:[[true,_T("common","yes")],[false,_T("common","no")]],displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,width:200,value:e,mode:"local"});c.items.push(a)}Ext.apply(c,d);SYNO.SDS.Backup.ResDestVol.superclass.constructor.call(this,c);f.on("select",function(i,h,g){this.getForm().findField("destvolume").el.dom.qtip=this.owner.destVolumeList[g][1]},this)},addVAAITip:function(){var a=this;if("yes"===_D("support_vaai","no")){SYNO.SDS.Utils.AddTip(a.getForm().findField("vaai_support").getEl(),Ext.util.Format.htmlEncode(_T("iscsitrg","iscsitrg_vaai_notify")))}},activate:function(){if(!this.isActivatedBefore){this.isActivatedBefore=true;this.destVolumeRequest();if(this.addVAAITip){this.addVAAITip()}}if(this.owner.blExistedTask){this.loadLUNBkpConf(this.owner.taskname)}else{if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.owner.bkptype){this.enumLocLUNName()}else{if(SYNO.SDS.Backup.BKPTASK_NETLUN===this.owner.bkptype){this.enumNetLUNName()}}}},saveSettings:function(){this.owner.destVolume=this.getForm().findField("destvolume").getValue();if("yes"===_D("support_vaai","no")){this.owner.advLun=this.getForm().findField("vaai_support").getValue()}},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();return this.nextId},setVAAISupport:function(){var a=this.getForm().findField("vaai_support");if(4096==this.owner.blocksize){a.disable();a.setValue(false)}else{a.enable();a.setValue(true)}},enumLocLUNNameDone:function(c,d,b){this.owner.clearStatusBusy();if(d&&b.responseText!==null){var a=Ext.util.JSON.decode(b.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}this.owner.lunName=a.items[0].lunname_org;this.owner.lunSize=a.items[0].lunsize;this.owner.renamedLun=a.items[0].lunname_new;this.owner.blocksize=a.items[0].blocksize;this.setVAAISupport()}},enumLocLUNName:function(){var a={};a.action="enumlocreslunname";a.share=this.owner.localRcvrSrc;a.dir=this.owner.localSrcCID;this.owner.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.enumLocLUNNameDone,scope:this},this)},enumNetLUNNameDone:function(c,d,b){this.owner.clearStatusBusy();if(d&&b.responseText!==null){var a=Ext.util.JSON.decode(b.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}this.owner.lunName=a.items[0].lunname_org;this.owner.renamedLun=a.items[0].lunname_new;this.owner.lunSize=a.items[0].lunsize;this.owner.blocksize=a.items[0].blocksize;this.setVAAISupport()}},enumNetLUNName:function(){var a={};a.action="enumnetreslunname";a.share=this.owner.netRcvrParams.module;a.dir=this.owner.netSrcCID;this.owner.PanelSynoServer.getParamsVal(a);this.owner.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(a),method:"POST",callback:this.enumNetLUNNameDone,scope:this},this)},loadLUNBkpConfDone:function(c,d,b){this.owner.clearStatusBusy();if(d&&b.responseText!==null){var a=Ext.util.JSON.decode(b.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}this.owner.serverIP=a.items[0].ip;this.owner.account=a.items[0].user;this.owner.sourcePath=a.items[0].dest;this.owner.lunName=a.items[0].lunname_org;this.owner.renamedLun=a.items[0].lunname_new;this.owner.blocksize=a.items[0].blocksize;this.setVAAISupport()}},loadLUNBkpConf:function(a){var b={};b.action="loadlunbkpconf";b.taskname=a;this.owner.setStatusBusy();Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:Ext.util.JSON.encode(b),method:"POST",callback:this.loadLUNBkpConfDone,scope:this},this)},summary:function(a){if(this.owner.blExistedTask){if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.owner.bkptype){a.append(_T("backup","restore_type"),_T("lunbkp","local_lun_restore"))}else{a.append(_T("backup","restore_type"),_T("lunbkp","network_lun_restore"));a.append(_T("netbackup","netbkp_slct_server"),String.format(_T("netbackup","synology_server"),_D("company_title")));a.append(_T("netbackup","restore_server"),this.owner.serverIP);a.append(_T("netbackup","netbkp_auth_user"),this.owner.account)}a.append(_T("netbackup","netbkp_restore_folder"),this.owner.sourcePath)}else{if(SYNO.SDS.Backup.BKPTASK_LOCLUN===this.owner.bkptype){a.append(_T("backup","restore_type"),_T("lunbkp","local_lun_restore"));a.append(_T("netbackup","netbkp_restore_folder"),this.owner.localRcvrSrc+"/"+this.owner.localSrcCID+"/")}else{a.append(_T("backup","restore_type"),_T("lunbkp","network_lun_restore"));a.append(_T("netbackup","netbkp_slct_server"),String.format(_T("netbackup","synology_server"),_D("company_title")));var b=(this.owner.netRcvrParams.server.length>0)?this.owner.netRcvrParams.server:this.owner.netRcvrParams.ip;a.append(_T("netbackup","restore_server"),b);a.append(_T("netbackup","netbkp_auth_user"),this.owner.netRcvrParams.account);a.append(_T("netbackup","netbkp_restore_folder"),this.owner.netRcvrParams.module+"/"+this.owner.netSrcCID+"/")}}this.owner.dest=this.owner.destVolume+"/"+this.owner.renamedLun;a.append(_T("lunbkp","restore_lun"),this.owner.lunName);a.append(_T("lunbkp","name_after_restored"),this.owner.dest);if("yes"===_D("support_vaai","no")){a.append(_T("iscsitrg","iscsitrg_vaai"),_T("common",(this.owner.advLun?"yes":"no")))}},destVolumeDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}this.owner.blChangeRcvrSrc=true;for(var b=0;b<a.volume_list.length;b++){this.owner.destVolumeList.push([a.volume_list[b].mount_point.substring(1,a.volume_list[b].mount_point.length),a.volume_list[b].display])}this.owner.destVolumeStore.loadData(this.owner.destVolumeList,false);if(0<this.owner.destVolumeList.length){this.getForm().findField("destvolume").setValue(this.owner.destVolumeList[0][0]);this.getForm().findField("destvolume").el.dom.qtip=this.owner.destVolumeList[0][1];this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","error_system"));this.owner.getButton("next").disable()}},destVolumeRequest:function(){this.owner.destVolumeList.length=0;this.owner.setStatusBusy({text:_T("lunbkp","search_dest_volume")});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"enumvolume"},method:"POST",callback:this.destVolumeDone,scope:this},this)}});Ext.define("SYNO.SDS.Backup.ResNetSrcCID",{extend:"SYNO.ux.FormPanel",loadFinished:false,enableNext:false,isActivatedBefore:false,taskPolling:null,constructor:function(c){var a=new Ext.data.SimpleStore({id:"value",fields:["value","display"],data:c.owner.netSrcCIDList});c.owner.netSrcCIDStore=a;var d=new SYNO.ux.ComboBox({fieldLabel:_T("backup","backup_dest_directory"),hiddenName:"netSrcCID",name:"netSrcCID",forceSelection:true,editable:false,store:c.owner.netSrcCIDStore,displayField:"display",valueField:"value",typeAhead:true,triggerAction:"all",lazyRender:true,width:200,value:"",mode:"local"});var b={items:[d]};Ext.apply(b,c);d.on("select",function(){this.owner.blChangeRcvrSrc=true},this);this.callParent([b])},load:function(){this.owner.netSrcCIDList.length=0;this.netSrcCIDRequest()},activate:function(){this.enableNext=false;this.loadFinished=false;this.owner.netSrcCIDStore.loadData([],false);this.getForm().findField("netSrcCID").clearValue();if(!this.isActivatedBefore){this.load()}},checkState:function(){SYNO.SDS.Wizard.Step.prototype.checkState.apply(this,arguments);if(this.loadFinished){if(this.enableNext){this.owner.getButton("next").enable()}else{this.owner.getButton("next").disable()}}else{this.owner.getButton("next").disable()}},saveSettings:function(){this.owner.netSrcCID=this.getForm().findField("netSrcCID").getValue()},getNext:function(){if(!this.getForm().isValid()){return false}this.saveSettings();return this.nextId},summary:function(a){},netSrcCIDDone:function(d,e,c){this.owner.clearStatusBusy();if(e&&c.responseText!==null){var a=Ext.util.JSON.decode(c.responseText);if(!a.success){this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(a.errinfo.sec,a.errinfo.key));return}this.enableNext=true;this.loadFinished=true;this.checkState();for(var b=0;b<a.total;b++){this.owner.netSrcCIDList.push([a.items[b],a.items[b]])}if(this.owner.netSrcCIDStore!==null){this.owner.netSrcCIDStore.loadData(this.owner.netSrcCIDList,false)}if(a.params){this.owner.netRcvrParams=a.params}if(0<this.owner.netSrcCIDList.length){this.getForm().findField("netSrcCID").setValue(this.owner.netSrcCIDList[0][0]);this.owner.getButton("next").enable()}else{this.getForm().findField("netSrcCID").setValue("");this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("netbackup","bkp_host_no_dir"));this.owner.getButton("next").disable()}}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","error_system"))}},netSrcCIDRequest:function(){var a={};a.action="enumnetlundir";a.servertype="synology";a.share=this.owner.netRcvrParams.module;this.GetParams(a);a=Ext.util.JSON.encode(a);this.AjaxRequest(a,_T("backup","search_restore_folder"),this.netSrcCIDDone)},GetParams:function(a){a.account=this.owner.netRcvrParams.account;a.ip=this.owner.netRcvrParams.ip;a.server=this.owner.netRcvrParams.server;a.module=this.owner.netRcvrParams.module;a.password=this.owner.netRcvrParams.password},AjaxRequest:function(c,b,a){this.owner.setStatusBusy(_T("lunbkp","search_directory"));Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:c,method:"POST",callback:a,scope:this},this)}});Ext.define("SYNO.SDS.Backup.LUNRestoreWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",selfIPs:null,selfHostName:null,PanelWelcome:null,PanelType:null,PanelSummary:null,PanelSynoServer:null,PanelLocSrc:null,PanelLocSrcCID:null,PanelDest:null,PanelNetSrcCID:null,PanelNetShare:null,taskname:null,bkptype:null,desttype:null,blExistedTask:false,blChangeRcvrSrc:true,localRcvrSrcStore:null,localRcvrSrc:null,localSrcCIDStore:null,localSrcCID:null,netSrcShareStore:null,netSrcShare:null,netSrcCIDStore:null,netSrcCID:null,destVolumeStore:null,destVolume:null,serverIP:null,account:null,sourcePath:null,lunName:null,renamedLun:null,lunSize:null,advLun:null,blocksize:null,selectedShareCount:0,shareStore:null,dest:null,restoreConflict:0,excuteConfirm:0,constructor:function(b){var c=SYNO.SDS.Backup;this.localRcvrSrcList=[];this.localSrcCIDList=[];this.netSrcShareList=[];this.netSrcCIDList=[];this.destVolumeList=[];this.shareList=[];this.netRcvrParams={};this.PanelWelcome=new SYNO.SDS.Wizard.WelcomeStep({headline:_T("lunbkp","lun_restore_welcome_title"),description:_T("lunbkp","lun_restore_welcome_desc"),itemId:"welcome",nextId:"type",leftTitle:"LUN Restore Wizard"});this.PanelType=new c.LUNResTypePanel({headline:_T("backup","restore_wizard_desttype_title"),description:_T("backup","reswizard_type_title"),itemId:"type",nextId:["dest-volume","net-srccid","loc-src","syno-server"],grid:b.grid,owner:this});this.PanelSynoServer=new c.LUNResSynoSerPanel({headline:_T("netbackup","recover_serverset_title"),description:_T("netbackup","netbkp_serverset3_desc"),itemId:"syno-server",nextId:"net-share",owner:this});this.PanelNetShare=new c.LUNResNetShare({headline:_T("lunbkp","source_folder_title"),description:_T("lunbkp","source_folder_desc"),itemId:"net-share",nextId:"net-srccid",owner:this});this.PanelLocSrc=new c.LUNResLocSrc({headline:_T("lunbkp","source_folder_title"),description:_T("lunbkp","source_folder_desc"),itemId:"loc-src",nextId:"loc-srccid",owner:this});this.PanelLocSrcCID=new c.ResLocSrcCID({headline:_T("lunbkp","directory_title"),description:_T("lunbkp","directory_desc"),itemId:"loc-srccid",nextId:"dest-volume",owner:this});this.PanelDest=new c.ResDestVol({headline:_T("lunbkp","dest_vol_select"),description:_T("lunbkp","dest_vol_select_desc"),itemId:"dest-volume",nextId:"summary",owner:this});this.PanelNetSrcCID=new c.ResNetSrcCID({headline:_T("lunbkp","directory_title"),description:_T("lunbkp","directory_desc"),itemId:"net-srccid",nextId:"dest-volume",owner:this});this.PanelSummary=new SYNO.SDS.Wizard.SummaryStep({headline:_T("localbkpwizard","summary_title"),description:_T("wizcommon","summary_descr"),itemId:"summary",nextId:null,getNext:function(){this.owner.applySetting();return false},owner:this});var a=[this.PanelWelcome,this.PanelType,this.PanelSynoServer,this.PanelNetShare,this.PanelLocSrc,this.PanelLocSrcCID,this.PanelDest,this.PanelNetSrcCID,this.PanelSummary];b=Ext.apply({title:_T("lunbkp","restwizard_title"),width:600,height:520,steps:a},b);this.callParent([b]);this.setActiveStep("welcome")},genApplyParams:function(){var b={};b.action="restorelun";var a=this.bkptype;b.rcvrtype=a;if(this.blExistedTask){b.bytask=true;b.taskname=this.taskname;b.destvolume=this.destVolume;b.lunname=this.lunName;b.advLun=this.advLun}else{if(SYNO.SDS.Backup.BKPTASK_LOCLUN===a){b.dest=this.destVolume;b.share=this.localRcvrSrc;b.dir=this.localSrcCID;b.lunname=this.lunName;b.lunsize=this.lunSize;b.advLun=this.advLun;b.blocksize=this.blocksize}else{b.dest=this.destVolume;b.share=this.netRcvrParams.module;b.dir=this.netSrcCID;b.lunname=this.lunName;b.lunsize=this.lunSize;b.advLun=this.advLun;b.blocksize=this.blocksize;b.account=this.netRcvrParams.account;b.ip=this.netRcvrParams.ip;b.server=this.netRcvrParams.server;b.password=this.netRcvrParams.password}}return Ext.util.JSON.encode(b)},applyDone:function(b,d,a){this.clearStatusBusy();if(d){var c=Ext.decode(a.responseText);if(false===c.success){if(c.errinfo){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T(c.errinfo.sec,c.errinfo.key))}}else{this.close()}}else{this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),_T("common","commfail"))}},applySetting:function(){this.AjaxRequest(this.genApplyParams(),_T("common","saving"),this.applyDone)},Show:function(){Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:{action:"selfhost"},callback:function(c,d,b){if(d&&b.responseText){var a=Ext.util.JSON.decode(b.responseText);this.selfIPs=a.selfIPs;this.selfHostName=a.selfHostName}},scope:this},this);this.open()},AjaxRequest:function(c,b,a){this.setStatusBusy({text:b});Ext.Ajax.request({url:this.owner.getURL("lunbackup.cgi"),params:c,method:"POST",callback:a,scope:this},this)},getURL:function(a){return this.owner.getURL(a)}});Ext.define("SYNO.SDS.Backup.PathBar",{extend:"Ext.Container",cls:"syno-sds-backup-pathbar",path:"",historyManager:null,initComponent:function(){this.callParent(arguments);if(!this.historyManager){this.historyManager=new SYNO.SDS.Backup.HistoryManager()}if(!Ext.isEmpty(this.defaultPath)){this.setPath(this.defaultPath)}this.addEvents("updatepath")},setPath:function(c,b){if(c==this.path){return false}var d=c.trim().split("/").filter(function(e){return !Ext.isEmpty(e)});this.removeAll();if("@pathRoot"!==d[0]){d.unshift("@pathRoot")}var a="";Ext.each(d,function(g,e,f){if(Ext.isEmpty(g)){return true}a+=("/"+g);var h="syno-sds-backup-pathbutton";if(0===e&&"@pathRoot"==g){return true}else{if(1===e){h="syno-sds-backup-pathbutton-first"}}this.add(new SYNO.SDS.Backup.PathButton({path:a,cls:h,owner:this,listeners:{click:{fn:function(){this.owner.setPath(this.path)}}}}))},this);this.path=a;this.doLayout();b=typeof b!=="undefined"?b:false;if(this.historyManager&&!b){this.historyManager.addEvent(this.path)}this.fireEvent("updatepath",this)},getPath:function(){return this.path},getRelatedPath:function(){return this.path.substr("/@pathRoot".length+1)},moveToPrevPath:function(){var a=null;if(this.historyManager){a=this.historyManager.moveToPrevEvent();if(a){this.setPath(a,true)}}return a},moveToNextPath:function(){var a=null;if(this.historyManager){a=this.historyManager.moveToNextEvent();if(a){this.setPath(a,true)}}return a},getPrevPath:function(){var a=null;if(this.historyManager){a=this.historyManager.getPrevEvent()}return a},getNextPath:function(){var a=null;if(this.historyManager){a=this.historyManager.getNextEvent()}return a}});Ext.define("SYNO.SDS.Backup.PathButton",{extend:"SYNO.ux.Button",cls:"syno-sds-backup-pathbutton",iconCls:"syno-sds-backup-pathbutton-text",path:"",initComponent:function(){this.setPath(this.path);this.callParent(arguments)},setPath:function(a){if(!Ext.isEmpty(this.path)){this.path=a;this.text=this.path.split("/").pop();this.tooltip=this.text}},getPath:function(){return this.path}});Ext.define("SYNO.SDS.Backup.HistoryManager",{history:[],historyPoint:-1,historyMaxLength:30,addEvent:function(a){if(this.history[this.historyPoint]===a){return}this.history.splice(this.historyPoint+1,this.history.length-(this.historyPoint+1),a);if(this.history.length>this.historyMaxLength){this.history.shift()}this.historyPoint=this.history.length-1},moveToPrevEvent:function(){var a=null;if(0<this.historyPoint){this.historyPoint--;a=this.history[this.historyPoint]}return a},moveToNextEvent:function(){var a=null;if((this.historyPoint+1)<this.history.length){this.historyPoint++;a=this.history[this.historyPoint]}return a},getPrevEvent:function(){var a=null;if(0<this.historyPoint){a=this.history[this.historyPoint-1]}return a},getNextEvent:function(){var a=null;if((this.historyPoint+1)<this.history.length){a=this.history[this.historyPoint+1]}return a}});Ext.define("SYNO.SDS.Backup.FileBrowser.Filter.FormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.dateType={custom:1,today:2,yesterday:4,lastweek:8,lastmonth:16};this.dataRange=[[this.dateType.custom,_T("log","date_custom")],[this.dateType.today,_T("log","date_today")],[this.dateType.yesterday,_T("log","date_yesterday")],[this.dateType.lastweek,_T("log","date_lastweek")],[this.dateType.lastmonth,_T("log","date_lastmonth")]];this.defaultAnimation=["#000",1,{duration:0.35}];Ext.apply(this,a||{});var b=this.fillConfig(a);this.callParent([b]);this.defineBehaviors()},initComponent:function(){this.callParent(arguments);this.addEvents("filter")},fillConfig:function(c){var a,e,b,g,h;var d=[];a=this.createKeyword();e=this.createFileType();b=this.createFileSize();g=this.createFriendlyDate();h=this.createCustDate();d.push(a);d.push(e);d.push(b);d.push(g);d.push(h);d.push({xtype:"toolbar",border:false,itemId:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("common","filter_label_text"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]});var f={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:d,listeners:{actionfailed:{fn:function(){this.form.reset()},scope:this},beforeshow:{fn:function(){this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}},scope:this}]};return f},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" ext:qtip="{displayText:htmlEncode}">',"{displayText:htmlEncode}","</div>","</tpl>")},createKeyword:function(){return[{xtype:"syno_displayfield",value:_T("log","attr_keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""}]},createFileType:function(){this.FileTypeComboBox=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"fileType",tpl:this.createTpl(),resizable:true,store:this.getFileTypeStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,flex:6,value:"any"});return[{xtype:"syno_displayfield",value:_T("backup","file_type")+_T("common","colon"),flex:1},this.FileTypeComboBox]},getFileTypeStore:function(){return new Ext.data.SimpleStore({autoDestroy:true,fields:["value","displayText"],data:[["any","Any"],["folder","Any Folder"],["file","Any File"]]})},createFileSize:function(){this.FileSizeField=new SYNO.ux.CompositeField({hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[{xtype:"syno_combobox",mode:"local",editable:false,name:"fileSizeOption",tpl:this.createTpl(),resizable:true,store:this.getFileSizeStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,value:"any",listeners:{select:{fn:function(c,b,a){this.enableDisableItem(b.get("value"),this.form.findField("fileSize"))},scope:this}}},{xtype:"syno_numberfield",name:"fileSize",minValue:0,maxValue:4294967296,disabled:true}]});return[{xtype:"syno_displayfield",value:_T("common","size")+" ("+_T("common","size_kb")+")"+_T("common","colon"),flex:1},this.FileSizeField]},getFileSizeStore:function(){return new Ext.data.SimpleStore({autoDestroy:true,fields:["value","displayText"],data:[["any",_T("search","search_any")],["equal",_T("search","size_equal")],["greater",_T("search","size_greater")],["less",_T("search","size_less")]]})},setDate:function(c,b,a){if(a===true){this.frameAnimation(this.form.findField("searchdatefrom").el,this.defaultAnimation);this.frameAnimation(this.form.findField("searchdateto").el,this.defaultAnimation)}this.form.findField("searchdatefrom").setMaxValue(b);this.form.findField("searchdateto").setMinValue(c);this.form.findField("searchdatefrom").setValue(c);this.form.findField("searchdateto").setValue(b)},getFromToDate:function(c){var e,d,b=new Date();if(c===this.dateType.today){e=b;d=b}else{if(c===this.dateType.yesterday){e=b.add(Date.DAY,-1);d=e}else{if(c===this.dateType.lastweek){var a=b.getDay();e=b.add(Date.DAY,-7-a);d=e.add(Date.DAY,6)}else{if(c===this.dateType.lastmonth){b=b.add(Date.MONTH,-1);e=b.getFirstDateOfMonth();d=b.getLastDateOfMonth()}}}}return{from:e,to:d}},friendlyDateSelect:function(c,e,a){var b=e.get("id"),d=this.getFromToDate(b);this.setDate(d.from,d.to,true)},getFriendlyDateStore:function(){var a=this.dataRange;return new Ext.data.ArrayStore({autoDestroy:true,fields:["id","displayText"],data:a})},createFriendlyDate:function(){this.FriendlyDate=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"dateRange",tpl:this.createTpl(),resizable:true,store:this.getFriendlyDateStore(),displayField:"displayText",valueField:"id",triggerAction:"all",lazyRender:true,flex:6,value:this.dateType.custom,listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.friendlyDateSelect}});return[{xtype:"syno_displayfield",value:_T("backup","modified_date")+_T("common","colon"),flex:1},this.FriendlyDate]},createCustDate:function(){this.DateFrom=new SYNO.ux.DateField({name:"searchdatefrom",editable:false,format:"m/d/Y",emptyText:_T("log","date_from"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdateto").setMinValue(a)}}});this.DateTo=new SYNO.ux.DateField({name:"searchdateto",editable:false,format:"m/d/Y",emptyText:_T("log","date_to"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdatefrom").setMaxValue(a)}}});return[{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.DateFrom,this.DateTo]}]},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)){b.setValue(a)}b.focus("",1)},enableDisableItem:function(b,a){if(b!=="any"){this.frameAnimation(a.el,this.defaultAnimation);a.enable();return 1}else{a.reset();a.disable();return 0}},onSearch:function(a,b){if(!this.getForm().isValid()){return}this.fireEvent("filter",this)},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null)},getParams:function(){var e,d,b,c,a,h,g;var f;e=this.getForm();a=e.findField("keyword").getValue();d=e.findField("fileType").getValue();b=e.findField("fileSizeOption").getValue();c=e.findField("fileSize").getValue();h=e.findField("searchdatefrom").getRawValue();g=e.findField("searchdateto").getRawValue();f={filter_keyword:a,filter_type:d,filter_size_option:b,filter_size:c*1024,filter_date_from:h?new Date(h+" 00:00:00").getTime()/1000:0,filter_date_to:g?new Date(g+" 23:59:59").getTime()/1000:0};return f}});Ext.define("SYNO.SDS.Backup.PathSelector.Window",{extend:"SYNO.SDS.ModalWindow",selectedPath:null,constructor:function(a){var b=Ext.apply({buttons:[{itemId:"btn_apply",text:_T("common","apply"),btnStyle:"blue",handler:function(){this.fireEvent("apply",this,this.getParams());this.close()},scope:this},{text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},a);return this.callParent([b])},initEvents:function(){this.callParent(arguments);this.addEvents("apply");this.mon(this.treePanel.getSelectionModel(),"selectionchange",function(b,a){if(a){this.selectedPath=a.attributes.abspath}},this);this.mon(this.treePanel.getLoader(),"load",this.onTreeLoad,this)},initComponent:function(){this.callParent(arguments);this.treeLoader=new SYNO.SDS.Backup.TreeLoader({nodeParameter:"folder_path",sendWebAPI:this.sendWebAPI.createDelegate(this),webapi:{api:"SYNO.Core.File",method:"list",version:1},createNodeScope:this,createNodeFn:function(a){a.checked=null;if(a.spath){a.id=a.spath;a.abspath=a.path;a.path=a.spath;if(""!==a.mountType){a.hidden=true}}else{if(a.path){a.id=a.path;a.abspath=a.additional.real_path;a.text=a.name;if(""!==a.additional.mount_point_type){a.hidden=true}}}},parseWebApiResponse:function(b,a){if(a.files){return a.files.filter(function(c){return !SYNO.SDS.Backup.Util.isRecycleBinFolder(c.path)})}else{return a.filter(function(c){return"RW"===c.right})}},baseParams:{superuser:false,status_filter:"valid",filetype:"dir",additional:["real_path","mount_point_type"]},owner:this});this.treePanel=new SYNO.SDS.Backup.PathSelector.TreePanel({loader:this.treeLoader,border:false,root:new Ext.tree.AsyncTreeNode({name:"fm_root",id:"/",path:"/",text:_S("hostname"),cls:"root_node",expanded:true,disabled:true}),autoFlexcroll:true,cls:"syno-sds-backup-filebrowser-treepanel"});this.add(this.treePanel)},getParams:function(){var a={dest_path:this.selectedPath,overwrite:this.treePanel.getBottomToolbar().getComponent("overwrite").checked};return a},onTreeLoad:function(a,c,b){if(!this.selectedPath&&0<b.length){this.treePanel.getSelectionModel().select(this.treePanel.getNodeById(b[0].id))}}});Ext.define("SYNO.SDS.Backup.PathSelector.TreePanel",{extend:"SYNO.SDS.Backup.BasicTreePanel",initComponent:function(){this.bbar=[new Ext.form.Label({height:32,text:_T("backup","same_file_description")+":"}),new SYNO.ux.DisplayField({style:"width: 13px",fieldLabel:"",value:"&nbsp;"}),new SYNO.ux.Radio({itemId:"skip",boxLabel:_T("backup","skip"),name:"writestrategy",inputValue:"skip",checked:true}),new SYNO.ux.DisplayField({style:"width: 13px",fieldLabel:"",value:"&nbsp;"}),new SYNO.ux.Radio({itemId:"overwrite",boxLabel:_T("backup","overwrite"),name:"writestrategy",inputValue:"overwrite"})];this.callParent(arguments)}});Ext.define("SYNO.SDS.Backup.FileBrowser.Window",{extend:"SYNO.SDS.ModalWindow",title:_T("backup","backup_filebrowser"),minHeight:580,minWidth:800,layout:"fit",isDownloading:false,support_filter:false,support_download:false,hostname:_T("backup","unknown_host"),initComponent:function(){if(this.support_filter){this.pathBarMargin=292}else{this.pathBarMargin=98}this.pathBar=new SYNO.SDS.Backup.PathBar({width:this.width-this.pathBarMargin});var b=[{xtype:"syno_button",iconCls:"syno-sds-backup-filebrowser-tbar-back",disabled:true,listeners:{click:{fn:function(){this.pathBar.moveToPrevPath()},scope:this}}},{xtype:"syno_button",iconCls:"syno-sds-backup-filebrowser-tbar-next",disabled:true,listeners:{click:{fn:function(){this.pathBar.moveToNextPath()},scope:this}}},this.pathBar];if(this.support_filter){this.filterPanel=new SYNO.SDS.Backup.FileBrowser.Filter.FormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,hidden:true,owner:this});b.push("->");this.searchField=new SYNO.SDS.Backup.AdvancedSearchField({owner:this,cls:"syno-ux-textfilter-text",width:188,emptyText:_T("common","filter_label_text"),searchPanel:this.filterPanel});b.push(this.searchField)}this.pathToolbar=new SYNO.ux.Toolbar({cls:"syno-sds-backup-filebrowser-tbar",items:b});this.menuToolbar=new SYNO.ux.Toolbar({items:[{xtype:"syno_button",itemId:"btn_copy",text:_T("backup","copy_to")+" ...",disabled:true,listeners:{scope:this,click:this.launchPathSelector}},{xtype:"syno_button",itemId:"btn_restore",text:_T("backup","restore"),disabled:true,listeners:{scope:this,click:this.onRestoreApply}},{xtype:"syno_button",itemId:"btn_download",text:_T("backup","download"),disabled:true,listeners:{scope:this,click:this.onDownloadApply}}]});this.tbar=new Ext.Container({layout:{type:"vbox",pack:"start",align:"stretch"},height:36*2,defaults:{flex:1},items:[this.pathToolbar,this.menuToolbar]});this.callParent(arguments);if(!this.treeloader){this.treeloader=new SYNO.SDS.Backup.TreeLoader({sendWebAPI:this.sendWebAPI.createDelegate(this),webapi:{api:"SYNO.Backup.Target.Folder",method:"list",version:1},baseParams:this.getBaseParams(),createNodeFn:function(c){c.text=c.name;c.id=c.path},createNodeScope:this,owner:this})}this.treePanel=new SYNO.SDS.Backup.BasicTreePanel({loader:this.treeloader,root:new Ext.tree.AsyncTreeNode({name:"@pathRoot",id:"@pathRoot",path:"@pathRoot",text:this.hostname,cls:"root_node",expanded:true,disabled:true,loaded:true}),autoFlexcroll:true,region:"west",cls:"syno-sds-backup-filebrowser-treepanel",split:true,width:200,minWidth:150,maxWidth:500});if(!this.gridStore){this.gridStore=new Ext.data.JsonStore({proxy:new SYNO.API.Proxy({api:"SYNO.Backup.Target.File",method:"list",version:1}),totalProperty:"total",root:"files",fields:["name","path","size","mtime","type"],baseParams:this.getBaseParams(),hasMultiSort:true,multiSortInfo:{sorters:[{field:"type",direction:"DESC"},{field:"name",direction:"ASC"}],direction:"ASC"},listeners:{scope:this,beforeload:function(c,d){Ext.apply(d.params,this.getBaseParams());return d},exception:function(f,g,h,e,d,c){if(SYNO.SDS.Backup.ERR_SHARE_NOT_FOUND===d.code){this.gridPanel.getStore().removeAll();this.gridPanel.bwrap.mask(_T("backup","no_folder"),"syno-ux-mask-info");return false}this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(d.code),function(){this.close()},this)}}})}this.gridMenu=new SYNO.ux.Menu({cls:"syno-sds-backup-filebrowser-menu",items:[{text:_T("backup","copy_to")+" ...",iconCls:"syno-sds-backup-filebrowser-copy-icon",itemId:"menu_copy",disabled:true,listeners:{scope:this,click:this.launchPathSelector}},{text:_T("backup","restore"),iconCls:"syno-sds-backup-filebrowser-restore-icon",itemId:"menu_restore",disabled:true,listeners:{scope:this,click:this.onRestoreApply}},{text:_T("backup","download"),iconCls:"syno-sds-backup-filebrowser-download-icon",itemId:"menu_download",disabled:true,listeners:{scope:this,click:this.onDownloadApply}}]});var a=null;if(this.support_filter){a=new SYNO.ux.PagingToolbar({store:this.gridStore,pageSize:1000,displayInfo:true,showRefreshBtn:false})}this.gridPanel=new SYNO.ux.GridPanel({colModel:new Ext.grid.ColumnModel({columns:[{header:_T("common","name"),dataIndex:"name",renderer:function(g,d,c,h,f,e){if("Folder"===c.data.type){return'<div class="syno-sds-backup-filebrowser-folder-icon">&nbsp;'+g+"</div>"}else{return'<div class="syno-sds-backup-filebrowser-file-icon">&nbsp;'+g+"</div>"}}},{header:_T("common","size"),dataIndex:"size",renderer:function(g,d,c,h,f,e){return SYNO.SDS.Backup.ConverSize(g,2)}},{header:_T("backup","file_type"),dataIndex:"type"},{header:_T("backup","modified_date"),dataIndex:"mtime",renderer:function(g,d,c,i,f,e){var h=new Date(g*1000);return h.toLocaleString()}}]}),store:this.gridStore,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),loadMask:true,cls:"syno-sds-backup-filebrowser-gridpanel",collapsible:false,region:"center",bbar:a,margins:"5 0 0 0",listeners:{contextmenu:{fn:function(c){this.gridMenu.showAt(c.getXY())},scope:this},rowcontextmenu:{fn:function(c,g,d){var f=c.getSelectionModel();if(!f.isSelected(g)){f.selectRow(g)}},scope:this}}});this.timeline=new SYNO.SDS.Backup.TimeLine({owner:this,cls:"syno-backup-timeline",defaultVersion:this.defaultVersion,getBaseParams:Ext.createDelegate(this.getBaseParams,this),region:"south",height:122});this.add(new SYNO.ux.Panel({layout:"border",border:false,cls:"syno-sds-backup-filebrowser-mainpanel",viewConfig:{forceFit:true},defaults:{split:true,fit:true},items:[this.treePanel,this.gridPanel,this.timeline]}))},initEvents:function(){this.callParent(arguments);this.mon(this,"resize",function(c,b,a){this.pathBar.setWidth(b-this.pathBarMargin)},this);this.mon(this,"afterrender",function(){if(this.isDownloading){this.launchProgressPanel()}},this);this.mon(this.treePanel.getSelectionModel(),"selectionchange",function(b,a){if(a){this.pathBar.setPath(a.attributes.path);this.updateGridPanel()}},this);this.mon(this.gridPanel,"rowdblclick",function(c,b,d){var a=c.getStore().getAt(b);if("Folder"===a.get("type")){this.pathBar.setPath(a.get("path"))}else{if("File"===a.get("type")){this.onDownloadApply()}}},this);this.mon(this.gridPanel.getSelectionModel(),"selectionchange",function(b){var a=true;b.getSelections().each(function(c){if(c.get("type")!=="File"){a=false;return false}});if(1===b.getSelections().length){this.menuToolbar.getComponent("btn_copy").enable();this.menuToolbar.getComponent("btn_restore").enable();this.gridMenu.getComponent("menu_copy").enable();this.gridMenu.getComponent("menu_restore").enable();if(a){this.menuToolbar.getComponent("btn_download").enable();this.gridMenu.getComponent("menu_download").enable()}else{this.menuToolbar.getComponent("btn_download").disable();this.gridMenu.getComponent("menu_download").disable()}}else{this.menuToolbar.getComponent("btn_copy").disable();this.menuToolbar.getComponent("btn_restore").disable();this.menuToolbar.getComponent("btn_download").disable();this.gridMenu.getComponent("menu_copy").disable();this.gridMenu.getComponent("menu_restore").disable();this.gridMenu.getComponent("menu_download").disable()}},this);this.mon(this.pathBar,"updatepath",this.onPathBarUpdate,this);this.mon(this.timeline,"select",this.onTimelineSelect,this);this.mon(this.treePanel.getLoader(),"load",this.onTreeLoad,this);if(this.filterPanel){this.mon(this.filterPanel,"filter",this.updateGridPanel,this)}},getBaseParams:function(){var a={};if(this.taskId){Ext.apply(a,{task_id:this.taskId})}else{Ext.apply(a,{repo_id:this.repoId,target_id:this.targetId})}if(this.versionId){Ext.apply(a,{version_id:this.versionId})}if(this.pathBar&&this.pathBar.getRelatedPath()){Ext.apply(a,{node:this.pathBar.getRelatedPath()})}if(this.filterPanel&&this.filterPanel.getParams()){Ext.apply(a,this.filterPanel.getParams())}return a},onTimelineSelect:function(){this.versionId=this.timeline.getVersionId();this.updateTreePanel()},onPathBarUpdate:function(){if(!this.pathBar.getPrevPath()){this.pathToolbar.items.items[0].disable()}else{this.pathToolbar.items.items[0].enable()}if(!this.pathBar.getNextPath()){this.pathToolbar.items.items[1].disable()}else{this.pathToolbar.items.items[1].enable()}this.treePanel.selectPath(this.pathBar.getPath(),"name",Ext.createDelegate(this.onTreeSelect,this))},onTreeLoad:function(a,c,b){var d=this.pathBar.getPath();if((!d||"/@pathRoot"===d)&&0<b.length){d=this.treePanel.getNodeById(b[0].id).getPath();this.pathBar.setPath(d)}if(c.isRoot){this.treePanel.selectPath(d,"name",Ext.createDelegate(this.onTreeSelect,this))}},onTreeSelect:function(a,b){if(!a){this.gridPanel.getStore().removeAll();this.gridPanel.bwrap.mask(_T("backup","no_folder"),"syno-ux-mask-info")}},onPathSelectorApply:function(a,c){var d=this.gridPanel.getSelectionModel();var b={action:"copy",source_path:d.getSelected().data.path};Ext.apply(b,this.getBaseParams());Ext.apply(b,c);this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target.File",version:1,method:"copy",params:b,scope:this,callback:function(g,e,f){this.clearStatusBusy();if(!g){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(e.code));return}this.launchProgressPanel()}})},onDownloadApply:function(){var c=this.gridPanel.getSelectionModel();var a=c.getSelected().data.path;var b=Ext.copyTo({source_path:a},this.getBaseParams(),"version_id,task_id,repo_id,target_id");this.findAppWindow().downloadWebAPI({filename:a.replace(/^.*\//,""),webapi:{api:"SYNO.Backup.Target.File",version:1,method:"download",params:b},scope:this,callback:function(f,e,g,d){if(!g&&d){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(d.code))}}})},onRestoreApply:function(){this.getMsgBox().confirm(_T("tree","leaf_bkp"),_T("backup","restore_overwrite_hint"),function(a){if("yes"===a){var c=this.gridPanel.getSelectionModel();var b={action:"restore",overwrite:true,source_path:c.getSelected().data.path,dest_path:c.getSelected().data.path};Ext.apply(b,this.getBaseParams());this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target.File",version:1,method:"restore",params:b,scope:this,callback:function(f,d,e){this.clearStatusBusy();if(!f){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(d.code));return}this.launchProgressPanel()}})}},this)},onCancelApply:function(b,d,a,c){if("close"!==c){this.sendWebAPI({api:"SYNO.Backup.Target.File",version:1,method:"cancel",scope:this})}},onStartPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Target.File",version:1,method:"status"},interval:2,immediate:true,scope:this,status_callback:this.onPollingDone})},onStopPolling:function(){this.pollUnreg(this.pollingID)},onPollingDone:function(h,d,g,f){if(!h){this.msgBox.close()}else{if("none"===d.status){this.msgBox.close();if("success"===d.result){if("restore"===d.action){this.getMsgBox().alert(_T("leaf","backup"),_T("backup","fb_restore_success"))}else{this.getMsgBox().alert(_T("leaf","backup"),_T("backup","fb_copy_success"))}}else{if("failed"===d.result){if("restore"===d.action){this.getMsgBox().alert(_T("leaf","backup"),_T("backup","fb_restore_failed"))}else{this.getMsgBox().alert(_T("leaf","backup"),_T("backup","fb_copy_failed"))}}}}else{if(this.msgBox.progressBar.textEl){if(0<d.total_size){var e=d.processed_size/d.total_size;var b=SYNO.SDS.Backup.ConverSize(d.processed_size,2);var c=SYNO.SDS.Backup.ConverSize(d.total_size,2);var a=String.format("{0}% ({1}/{2})",(e*100).toFixed(2),b,c);this.msgBox.updateProgress(e,a,d.current_file_path,true)}}}}},mask:function(a,c,b){if(!c){c=_T("common","loading")}if(!b){b="x-mask-loading"}this.callParent([a,c,b])},launchPathSelector:function(){var a=new SYNO.SDS.Backup.PathSelector.Window({title:_T("backup","copy_to")+" ... - "+_T("backup","select_path"),bodyStyle:"padding-right: 20px; padding-left: 20px;",width:480,height:500,layout:"fit",minWidth:480,minHeight:500,owner:this});a.open();this.mon(a,"apply",this.onPathSelectorApply,this,{single:true})},launchProgressPanel:function(){this.getMsgBox().show({title:"",cls:"syno-sds-backup-filebrowser-dlg",msg:_T("common","msg_waiting"),buttons:Ext.Msg.CANCEL,progress:true,closable:false,progressText:"0%",fn:this.onCancelApply,scope:this});this.onStartPolling();this.mon(this.msgBox,"close",this.onStopPolling,this,{single:true})},updateTreePanel:function(){var b=this.treePanel.getRootNode();var a=this.treePanel.getLoader();this.treePanel.getEl().mask();a.baseParams=this.getBaseParams();var c=Ext.apply({},{params:Ext.apply({preload:this.pathBar.getPath().replace(/^\/@pathRoot\//,"")},a.getParams(b)),argument:{callback:undefined,node:b,scope:undefined},callback:function(i,d,h,f){var e=f.argument,g=e.node;this.treePanel.getEl().unmask();while(g.firstChild){g.removeChild(g.firstChild)}a.handleNodeData(g,d)},scope:this},a.webapi);this.sendWebAPI(c)},updateGridPanel:function(){var a=this.gridPanel.getStore();var b=this.getBaseParams();if(this.support_filter){this.searchField.setValue(b.filter_keyword)}a.load({params:b})}});Ext.define("SYNO.SDS.Backup.Restore.MainPage",{extend:"SYNO.ux.Panel",isRestoring:false,constructor:function(a){Ext.copyTo(this,a,"appWin");a=this.fillConfig(a);this.callParent([a]);this.isSnapshotRestoring=false;this.isDownloading=false},fillConfig:function(a){return Ext.apply({border:false,layout:"fit",tbar:this.getToolBar(),items:[this.getView()]},a)},initEvents:function(){this.callParent(arguments);this.mon(this,"resize",this.getView().refresh,this.getView())},getToolBar:function(){if(this.toolbar){return this.toolbar}var a=[{text:_T("lunbkp","data_restore"),useBuffer:true,listeners:{click:this.onRestoreFromOther,scope:this}}];if(this.appWin._D("support_iscsi_lunbkp","no")==="yes"){a.push({text:_T("lunbkp","lun_restore"),useBuffer:true,listeners:{click:this.onLUNRestore,scope:this}})}this.toolbar=new SYNO.ux.Toolbar({items:[{xtype:"syno_button",itemId:"btn_restore",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:true,hidden:true,text:_T("netbackup","netbkp_recovery"),menu:{xtype:"syno_menu",items:[{text:_T("backup","backup_standard_restore"),itemId:"menu_standard_restore",handler:this.onRestoreTask,scope:this},{text:_T("backup","backup_file_restore"),itemId:"menu_file_restore",disabled:true,handler:this.onFileRestore,scope:this}]}},{xtype:"syno_button",itemId:"btn_restore_single",tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:true,text:_T("netbackup","netbkp_recovery"),handler:this.onRestoreTask,scope:this},{xtype:"syno_button",itemId:"btn_restore_from_other",disabled:true,text:_T("backup","restore_from_other"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",menu:{xtype:"syno_menu",items:a}},{xtype:"syno_button",itemId:"btn_cancel",disabled:true,text:_T("common","cancel"),handler:this.onRestoreCancel,scope:this}]});return this.toolbar},onPageActivate:function(){this.onStartPolling()},onPageDeactivate:function(){this.onStopPolling()},onStartPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Task",version:1,method:"list",params:{offset:0,limit:-1,additional:["progress","restore_task","last_bkp_time","last_bkp_result","detail"]}},interval:3,immediate:true,scope:this,status_callback:this.onPollingDone})},onStopPolling:function(){this.pollUnreg(this.pollingID)},onPollingDone:function(d,a,c,b){if(!d){return}if(a.is_data_restoring&&!this.isProgressShow){this.isProgressShow=true;var e=new SYNO.SDS.Backup.Restore.ProgressWindow({restore_id:-1,owner:this.appWin});this.onStopPolling();e.on("close",this.onStartPolling,this);e.on("close",function(){this.isProgressShow=false},this);e.open()}this.loadTaskList(a);if(a.is_downloading){this.sendWebAPI({api:"SYNO.Backup.Target.File",version:1,method:"status",scope:this,callback:function(i,f,g){var h=new SYNO.SDS.Backup.FileBrowser.Window({height:580,width:900,useStatusBar:false,closable:true,cls:"syno-sds-backup-filebrowser",repoId:f.repo_id,targetId:f.target_id,versionId:f.version_id,isDownloading:true,owner:this.owner});this.onStopPolling();this.mon(h,"close",this.onStartPolling,this);h.open()}})}},getSelectedTask:function(){var a=this.getView().getSelectedRecords();return a[0]},onRestoreCancel:function(){var a=this.getSelectedTask();this.appWin.getMsgBox().confirm(_T("tree","leaf_backup"),_T("backup","restore_cancel_confirm"),function(b){if(b==="yes"){if(a&&"lun"===a.get("data_type")){this.doLunRestoreCancel()}}},this)},onRestoreFromOther:function(){if(this.isRestoring){return}var a=new SYNO.SDS.Backup.Restore.OtherDestWizard({restoreTaskPage:this,owner:this.appWin});this.onStopPolling();a.on("close",this.onStartPolling,this);a.open()},getView:function(){if(!this.view){var a={store:this.getStore(),owner:this,taskDisplayFormat:this.taskDisplayFormat.createDelegate(this),listeners:{selectionchange:{scope:this,fn:this.setBtnStatus}}};this.view=new SYNO.SDS.Backup.Restore.TaskExpandView(a)}return this.view},getStore:function(){if(!this.store){this.store=new SYNO.API.Store({id:this.restoreID=Ext.id(),api:"SYNO.Backup.Task",version:1,method:"list",baseParams:{offset:0,limit:-1,additional:["progress","last_bkp_time","last_bkp_result"]},appWindow:false,reader:new Ext.data.JsonReader({idProperty:"task_id",root:"task_list",totalProperty:"total",fields:[{name:"id",mapping:"task_id"},{name:"task_id",mapping:"task_id"},{name:"repo_id",mapping:"repo_id"},{name:"target_id",mapping:"target_id"},{name:"name",mapping:"name"},{name:"data_type",mapping:"data_type"},{name:"status",mapping:"status"},{name:"type",mapping:"type"},{name:"target_type",mapping:"target_type"},{name:"transfer_type",mapping:"transfer_type"},{name:"task_multi_version",mapping:"task_multi_version"},{name:"progress",mapping:"progress"},{name:"processed_size",mapping:"processed_size"},{name:"total_size",mapping:"total_size"},{name:"step",mapping:"step"},{name:"step_str",mapping:"step_str"},{name:"bkp_shares",mapping:"bkp_shares"},{name:"bkp_apps",mapping:"bkp_apps"},{name:"bkp_dest",mapping:"bkp_dest"},{name:"last_bkp_time",mapping:"last_bkp_time"},{name:"last_bkp_result",mapping:"last_bkp_result"},{name:"status_cls",mapping:"status_cls"},{name:"deststatus",mapping:"deststatus"},{name:"deststatus_str",mapping:"deststatus_str"},{name:"dest",mapping:"dest"},{name:"volume",mapping:"volume"},{name:"share",mapping:"share"},{name:"bucket",mapping:"bucket"},{name:"server",mapping:"ip"}]})})}return this.store},getLunStore:function(){if(!this.lunStore){this.lunStore=new Ext.data.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"lun_task_list",totalProperty:"total",fields:[{name:"name",mapping:"name"},{name:"type",mapping:"type"},{name:"bkp_dest_type",mapping:"bkp_dest_type"},{name:"bkpdata",mapping:"bkpdata"},{name:"dest",mapping:"dest"},{name:"destDirectory",mapping:"destDirectory"},{name:"deststatus",mapping:"deststatus"},{name:"status",mapping:"status"},{name:"progress",mapping:"progress"}]})})}return this.lunStore},taskDisplayFormat:function(e){var c=e.progress?e.progress.progress:0;var d=e.progress?e.progress.step:"none";var a=e.progress?e.progress.processed_size:0;var b=e.progress?e.progress.total_size:0;if(e.progress&&this.isRestoreCancel){e.step="canceling"}else{e.step=d}e.progress=c;e.step_str=SYNO.SDS.Backup.GetRestoreStepStr(e.step);e.processed_size=SYNO.SDS.Backup.ConverSize(a,2);e.total_size=SYNO.SDS.Backup.ConverSize(b,2);e.status_cls="restore"===e.status?"status-syncing":"status-none";e.deststatus_str=SYNO.SDS.Backup.GetDestStatusStr(e.deststatus);e.last_bkp_time=e.last_bkp_time?e.last_bkp_time:_T("localbkp","localbkp_not_bkp");if(e.source){Ext.each(e.source.file_list,function(h,f,g){g[f]=h.substring(1)},this);e.bkp_shares=0!==e.source.file_list.length?e.source.file_list.join(", "):_T("common","none");e.bkp_apps=0!==e.source.app_name_list.length?e.source.app_name_list.join(", "):_T("common","none")}return Ext.apply({},e)},loadTaskList:function(c){this.isRestoring=c.is_restoring;this.isRestoreCancel=c.is_restore_cancel;this.isBackingup=c.is_backing_up;this.isSnapshotRestoring=c.is_snapshot_restoring;this.isDownloading=c.is_downloading;var a=[];Ext.each(c.task_list,function(g,e,f){var h,d;if("lun"===g.data_type){a.push(g);g.bkp_shares=g.bkpdata;d=this.getStore().findExact("name",g.name);if(-1!==d){h=this.getStore().getAt(d);g.deststatus=h.get("deststatus");g.deststatus_str=h.get("deststatus_str")}}if("backup"===g.status||"waiting"===g.status||"syncing"===g.status){this.isBackingup=true}h=this.getStore().getById(g.task_id);if(h){g.deststatus=h.get("deststatus");g.dest=h.get("dest");g.volume=h.get("volume");g.share=h.get("share");g.bucket=h.get("bucket")}g=this.taskDisplayFormat(g)},this);this.getLunStore().loadData({lun_task_list:a});if(c.restore_task&&c.restore_task.progress){var b=c.restore_task.progress;c.restore_task.name=_T("backup","restore_from_other");c.restore_task.total_size=b?SYNO.SDS.Backup.ConverSize(b.total_size,2):0;c.restore_task.processed_size=b?SYNO.SDS.Backup.ConverSize(b.processed_size,2):0;c.restore_task.step=b?b.step:"none";c.restore_task.step_str=SYNO.SDS.Backup.GetRestoreStepStr(b.step);c.restore_task.progress=b?b.progress:0;c.task_list.push(c.restore_task)}this.getStore().loadData(c);this.setBtnStatus()},isCancelable:function(){if(!this.isRestoring||this.isRestoreCancel){return false}var a=this.getSelectedTask();return("lun"===a.get("step"))},setBtnStatus:function(){if(_S("demo_mode")){this.getToolBar().getComponent("btn_restore_from_other").disable();this.getToolBar().getComponent("btn_restore").disable();this.getToolBar().getComponent("btn_restore_single").disable();return}if(this.isBackingup||this.isRestoring||this.isRestoreCancel||this.isSnapshotRestoring||this.isDownloading){this.getToolBar().getComponent("btn_restore_from_other").disable()}else{this.getToolBar().getComponent("btn_restore_from_other").enable()}var a=this.getView().getSelectedRecords();if(1===a.length&&"image"===a[0].data.target_type){this.getToolBar().getComponent("btn_restore").menu.getComponent("menu_file_restore").enable();this.getToolBar().getComponent("btn_restore").show();this.getToolBar().getComponent("btn_restore_single").hide()}else{this.getToolBar().getComponent("btn_restore").menu.getComponent("menu_file_restore").disable();this.getToolBar().getComponent("btn_restore").hide();this.getToolBar().getComponent("btn_restore_single").show()}if(1===a.length&&!this.isBackingup&&!this.isRestoring&&!this.isRestoreCancel&&!this.isSnapshotRestoring&&!this.isDownloading){this.getToolBar().getComponent("btn_restore").enable();this.getToolBar().getComponent("btn_restore_single").enable()}else{this.getToolBar().getComponent("btn_restore").disable();this.getToolBar().getComponent("btn_restore_single").disable()}if(1===a.length&&this.isCancelable()){this.getToolBar().getComponent("btn_cancel").enable()}else{this.getToolBar().getComponent("btn_cancel").disable()}},getSelectTask:function(){var a=this.getView().getSelectedRecords();return a[0]},onFileRestore:function(){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target",version:1,method:"get_property",params:{task_id:this.getSelectedTask().get("task_id")},scope:this,callback:function(d,a,b){this.owner.clearStatusBusy();if(!d){if(SYNO.SDS.Backup.ERR_IMGBKP_SERVER_VERSION_TOO_OLD==a.code){a.host_name=_T("backup","unknown_host");a.support_download=false;a.support_filter=false}else{this.owner.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(a.code));return}}var c=new SYNO.SDS.Backup.FileBrowser.Window({height:580,width:900,useStatusBar:false,closable:true,taskId:this.getSelectedTask().get("task_id"),support_download:a.support_download,support_filter:a.support_filter,hostname:a.host_name,cls:"syno-sds-backup-filebrowser",owner:this.owner});this.onStopPolling();this.mon(c,"close",this.onStartPolling,this);c.open()}})},onRestoreTask:function(){if(this.isRestoring){return}var b=this.getSelectTask();if("lun"===b.get("data_type")){this.onLUNRestore()}else{var a=new SYNO.SDS.Backup.Restore.RestoreWizard({restoreTaskPage:this,owner:this.appWin,taskRecord:b,listeners:{close:this.onStartPolling,scope:this}});this.onStopPolling();a.open()}},onLUNRestore:function(){var a=new SYNO.SDS.Backup.LUNRestoreWizard({owner:this.appWin,grid:this.lunStore});this.onStopPolling();a.on("close",this.onStartPolling,this);a.Show()},doLunRestoreCancel:function(){this.appWin.setStatusBusy();Ext.Ajax.request({url:this.appWin.getURL("lunbackup.cgi"),params:{action:"lunrtorcancel"},scope:this,callback:function(b,d,a){this.appWin.clearStatusBusy();if(!d){this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),_T("common","error_system"));return}var c=Ext.util.JSON.decode(a.responseText);if(!c.success){this.appwin.getMsgBox().alert(_T("tree","leaf_backup"),_T(c.errinfo.sec,c.errinfo.key))}}})}});SYNO.SDS.Backup.GetRestoreStepStr=function(a){switch(a){case"lun":return _T("backup","restore_lun_executing");case"init":return _T("usbbackup","usbbkp_init");case"conf":return _T("confbackup","bkp_import_progress");case"app":return _T("backup","restore_app");case"share":return _T("backup","restore_executing");case"success":return _T("backup","backup_finishing");case"canceling":return _T("backup","backup_do_cancel")}return _T("common","none")};Ext.define("SYNO.SDS.Backup.Restore.AppUtil",{treePanel:null,constructor:function(a){Ext.apply(this,a)},convertLanguage:function(a,b){var c=SYNO.SDS.Backup.converLanString(a[b]);if(c){if((b+"_param") in a){c=String.format(c,a[b+"_param"])}a[b]=c}},onCreateAppNode:function(a){this.convertLanguage(a,"text");this.convertLanguage(a,"qtip");if("warn"===a.type){a.text='<element class="red-status">'+a.text+"</element>";a.qtip='<element class="red-status">'+a.qtip+"</element>"}},getAppCheckedSubTreeRoot:function(b){var a=[];var c=function(d){d.eachChild(function(f){var e=f.getUI()||{};if(!Ext.isFunction(e.getCheckValue)||!(e.checkbox)){return}if(true===e.getCheckValue()||"gray"===e.getCheckValue()){a.push(f);c(f)}})};c(b);return a},getAppList:function(b){var a=[];Ext.each(this.getAppCheckedSubTreeRoot(this.treePanel.getNodeById("app_root")),function(c){a.push(c.id)});return a},getCheckAppApi:function(){var a=[];Ext.each(this.getAppList(),function(d){var c={};var b;if("mysql"===d){var e=this.treePanel.getNodeById("mysql_pwd");if(e){b=e.getUI().getInputValue()}else{b=""}c.api="SYNO.Backup.App.Restore";c.version=1;c.method="mysql_check";c.params={};c.params.mysql_pwd=b;a.push(c)}else{if("surveillance"===d){c.api="SYNO.Backup.App.Restore";c.version=1;c.method="surveillance_check";a.push(c)}}},this);return a}});Ext.define("SYNO.SDS.Backup.Repository.CreateWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",repoList:undefined,constructor:function(a){Ext.copyTo(this,a,"owner,repoList");return this.callParent([Ext.apply({title:_T("backup","repo_create_title"),cls:"syno-backup-repository-window",width:600,height:550,steps:SYNO.SDS.Backup.Repository.CreateSteps(this,"backup_dest",null),banner:false},a)])},goNext:function(a,b){if(null===a){this.createRepo();return}this.callParent(arguments)},createRepo:function(){var a=this.getActiveStep();if(!a||(Ext.isFunction(a.isValid)&&!a.isValid())){return false}var b=this.getActiveStep().getParams();if(!this.isRepoNameValid(b.repo_name)){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","repo_name_duplicate"));return false}this.setStatusBusy();SYNO.SDS.Backup.Repository.CreateRepo(this,b,this.onCreateRepoDone)},onCreateRepoDone:function(c,a,b){this.clearStatusBusy();if(!c||a.has_fail){this.reportError(a);return}if(this.callbacks&&Ext.isFunction(this.callbacks.apply)){this.callbacks.apply.call(this.callbacks.scope||window,a,b)}if("image_local"===this.getActiveStep().getParams().transfer_type){this.getComponent("steps").getComponent("repo_privilege").setRepoId(a.repo_id);this.setAutoScroll(false);this.goNext("repo_privilege")}else{this.close()}},createRepoDefaultName:function(c){var a,b=1;while(true){a=String.format("{0} {1}",c,b);if(-1===this.repoList.findExact("name",a)){break}b++}return a},isRepoNameValid:function(a){return -1===this.repoList.findExact("name",a)},reportError:function(a,b){b=b||{};if(!this.reporter){this.reporter=new SYNO.SDS.Backup.ApiHelper({owner:this})}this.reporter.alert(a,b.callback,b.scope)}});Ext.define("SYNO.SDS.Backup.RepoCloudTypePanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){var b=Ext.apply({items:{xtype:"syno_fieldset",title:_T("backup","public_cloud_desc"),collapsible:false,items:a.addon_fields}},a);return this.callParent([b])},getOption:function(){return this.getForm().getValues().mode},getNext:function(){var a=this.getOption();return this.nextId[a]}});Ext.define("SYNO.SDS.Backup.RepoTypePanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){Ext.copyTo(this,a,"owner");var c=Ext.apply({items:[{xtype:"syno_fieldset",title:_T("backup","repo_create_type_headline"),collapsible:false,items:[{xtype:"syno_radio",boxLabel:_T("tree","leaf_usbbkp"),name:"mode",itemId:"local",inputValue:"local",checked:this.owner instanceof SYNO.SDS.Backup.TaskCreateWizard?false:true},{xtype:"syno_displayfield",indent:1,value:_T("bkpwizard","localbkp_desc")},{xtype:"syno_radio",boxLabel:_T("tree","leaf_netbkp"),name:"mode",inputValue:"network"},{xtype:"syno_displayfield",indent:1,value:String.format(_T("backup","netbkp_dest_desc"),_D("company_title"))},{xtype:"syno_radio",boxLabel:_T("backup","public_cloud_title"),name:"mode",inputValue:"cloud"},{xtype:"syno_displayfield",indent:1,value:_T("backup","public_cloud_desc")}]}]},a);this.selectRepoRec=null;if(this.owner instanceof SYNO.SDS.Backup.TaskCreateWizard){this.owner.repoList=this.getStore();c.items[0].items.unshift({width:240,indent:1,hideLabel:true,border:false,xtype:"syno_combobox",name:"destination",itemId:"dest_combo",forceSelection:true,allowBlank:false,displayField:"name",valueField:"repo_id",store:this.owner.repoList,listeners:{beforeselect:{scope:this,fn:function(f,d,e){this.selectRepoRec=d}}},owner:this,validator:function(d){if(this.owner.clickNext&&!this.owner.selectRepoRec){return false}return true},tpl:'<tpl for="."><div class="x-combo-list-item">{name:htmlEncode}</div></tpl>'});c.items[0].items.unshift({xtype:"syno_radio",boxLabel:_T("backup","select_dest_repo"),name:"mode",itemId:"dest_radio",inputValue:"existing",listeners:{change:function(f,e,d){if(!e){this.getComponent(0).getComponent("dest_combo").disable()}else{this.getComponent(0).getComponent("dest_combo").enable()}}}})}var b=this.callParent([c]);return b},initEvents:function(){this.callParent(arguments);this.mon(this,"afterlayout",function(){var a;a=new SYNO.ux.Utils.EnableRadioGroup(this.getForm(),"mode",{existing:["dest_combo"]})},this,{single:true})},getOption:function(){return this.getForm().getValues().mode},getNext:function(){this.clickNext=true;var a=this.getOption();if(a==="local"){this.loadLocalRepoOptions();return false}else{if(a=="existing"){if(!this.getForm().isValid()){this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});return false}var b=this.getParams().repo_id;this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:b,additional:["support_ssl","support_rotate"]},callback:function(e,c,d){this.owner.clearStatusBusy();if(!e){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(c.code));return false}this.owner.support_ssl=c.support_ssl;this.owner.support_rotate=c.support_rotate;if(c.deststatus==="offline"){this.owner.getMsgBox().alert(_T("leaf","backup"),_T("backup","general_backup_destination_disconnect"));return false}this.owner.goNext(this.nextId[a])},scope:this});return false}}return this.nextId[a]},loadLocalRepoOptions:function(){var a=[];if(!this.owner._D("usbstation")){a.push({api:"SYNO.Backup.Storage.Volume.Local",method:"list",version:1})}a.push({api:"SYNO.Backup.Storage.Share.Local",method:"list",version:1,params:{additional:["volume"]}});this.owner.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:false,params:a},callback:this.loadLocalRepoOptionsHandler,scope:this})},loadLocalRepoOptionsHandler:function(e,a,c){var d=this,b=d.getOption();d.owner.clearStatusBusy();if(!e||a.has_fail){d.owner.reportError(a);return false}if(d.owner.getStep(d.nextId[b]).loadData(a)!==false){d.owner.goNext(d.nextId[b])}else{d.owner.reportError(_T("backup","repo_local_no_resouce"),function(){d.getComponent(0).getComponent("local").disable();d.getForm().setValues({mode:"network"})})}},getStore:function(){if(!this.store){this.store=new SYNO.API.Store({api:"SYNO.Backup.Repository",version:1,method:"list",baseParams:{offset:0,limit:-1,additional:["local_volume"]},remoteSort:false,sortInfo:{field:"repo_id",direction:"DESC"},appWindow:false,reader:new Ext.data.JsonReader({idProperty:"repo_id",root:"repo_list",totalProperty:"total",fields:[{name:"repo_id",mapping:"repo_id"},{name:"account",mapping:"account"},{name:"name",mapping:"name"},{name:"local_volume",mapping:"local_volume"},{name:"share",mapping:"share"},{name:"bucket",mapping:"bucket"},{name:"target_type",mapping:"target_type"},{name:"transfer_type",mapping:"transfer_type"},{name:"remoteshell",mapping:"remoteshell"}]}),listeners:{scope:this,load:function(){this.owner.clearStatusBusy();if(this.store.totalLength>0){this.getComponent(0).getComponent("dest_combo").enable();this.getComponent(0).getComponent("dest_radio").setValue(true);this.getComponent(0).getComponent("dest_combo").setValue(this.store.data.items[0].get("repo_id"));this.selectRepoRec=this.store.data.items[0]}else{this.getComponent(0).getComponent("dest_combo").disable();this.getComponent(0).getComponent("dest_radio").disable();this.getComponent(0).getComponent("local").setValue(true)}}}});this.store.load({add:true})}return this.store},getParams:function(){if(this.getComponent(0).getComponent("dest_radio").getValue()){return{transfer_type:this.selectRepoRec.get("transfer_type"),repo_id:this.selectRepoRec.get("repo_id"),target_type:this.selectRepoRec.get("target_type"),share:this.selectRepoRec.get("share"),remoteshell:this.selectRepoRec.get("remoteshell")}}else{return{}}},getLocalRepoVolume:function(){if(this.getComponent(0).getComponent("dest_radio").getValue()){return this.selectRepoRec.get("local_volume")}else{return null}}});Ext.define("SYNO.SDS.Backup.Repository.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){this.repoId=a.repoId;this.fieldLabelWidth=210;this.verify_cert=false;var b=Ext.apply({title:_T("common","alt_edit"),width:480,minWidth:480,height:this.isRemote(a.transferType)?380:300,layout:"fit",closable:true,items:[{xtype:"syno_formpanel",trackResetOnLoad:true,itemId:"edit_panel",labelWidth:this.fieldLabelWidth,items:this.createItems(a.targetType,a.transferType)}],buttons:[{xtype:"syno_button",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.applySetting},{xtype:"syno_button",text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},a);return this.callParent([b])},getPanel:function(){return this.getComponent("edit_panel")},loadPanelOptions:function(a){var c;var b=[];c=SYNO.SDS.Backup.Addon.GetSymbol(a,"Repository.EditParams");c(b);return b},isRemote:function(a){if("rsync"===a||"rsync_ds"===a||"image_remote"===a){return true}return false},createItems:function(c,a){var b=[{xtype:"syno_textfield",name:"name",width:200,allowBlank:false,fieldLabel:_T("backup","repo_name"),maxLength:32,vtype:"backup_destination"}];if("cloud"===c){b=b.concat(this.loadPanelOptions(a))}else{if(this.isRemote(a)){b.push({xtype:"syno_textfield",name:"dest",allowBlank:false,fieldLabel:_T("netbackup","netbkp_set_ip"),width:200,validator:function(d){return this.scope.isHostnameValid(d)},scope:this});b.push({xtype:"syno_textfield",name:"account",allowBlank:false,fieldLabel:_T("netbackup","netbkp_account"),width:200,validator:function(g){var e="@";var f="\\";var d;d=g.indexOf(f);if(d>0&&d<g.length-1){return true}d=g.indexOf(e);if(d>0&&d<g.length-1){return true}return Ext.form.VTypes.username(g)}});b.push({xtype:"syno_textfield",name:"pwd",fieldLabel:_T("common","password"),width:200,inputType:"password"});if("rsync"===a||"rsync_ds"===a){b.push({xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_checkbox",name:"sshportcheck",boxLabel:_T("netbackup","netbkp_enable_ssh_port"),width:this.fieldLabelWidth,scope:this,handler:function(e,d){if(d){this.getPanel().getForm().findField("enc_port").enable()}else{this.getPanel().getForm().findField("enc_port").disable()}}},{xtype:"syno_numberfield",maxlength:5,vtype:"port",disabled:true,name:"enc_port",width:200,allowBlank:false}]})}}}if("image_local"===a){b.push({xtype:"syno_displayfield",height:10});b.push(new SYNO.SDS.Backup.Repository.EditDialog.WhiteListFieldset({repoId:this.repoId,owner:this}))}else{if("image_remote"===a){b.push({xtype:"syno_displayfield",name:"verify_cert",hidden:true,fieldLabel:_T("backup","certificate_auth")},{xtype:"syno_button",text:_T("backup","resume"),style:"margin-left: 215px",itemId:"resume_button",hidden:true,handler:this.onResumeBtnClick,scope:this});b.push({xtype:"syno_displayfield",height:10});b.push({xtype:"syno_displayfield",name:"white_list_edit_hint",hidden:true,value:_T("backup","repo_white_list_hint")})}}return b},onOpen:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:this.repoId,additional:["support_ssl","support_rotate"]},callback:function(e,a,b){if(!e){this.clearStatusBusy();this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}if(Ext.isDefined(a.enc_port)){a.sshportcheck=false;if(0!==a.enc_port){a.sshportcheck=true}else{a.enc_port=""}}var d=this.getPanel().getForm().findField("verify_cert");var c=this.getPanel().getComponent("resume_button");if(d&&c&&(a.support_ssl||SYNO.SDS.Backup.ERR_SSL_VERIFY_FAIL===a.desterror)){d.removeClass("syno-backup-orange-status");d.removeClass("syno-backup-green-status");if(true===a.verify_cert){this.verify_cert=true;d.addClass("syno-backup-green-status");d.setValue(_T("backup","certificate_auth_status_enable"))}else{this.verify_cert=false;d.addClass("syno-backup-orange-status");d.setValue(_T("backup","certificate_auth_status_skip"));SYNO.SDS.Utils.AddTip(d.getEl(),_T("backup","certificate_auth_hint"))}delete a.verify_cert;d.show();c.show()}this.getPanel().getForm().setValues(a);this.orgName=a.name;if(a.deststatus==="offline"){this.clearStatusBusy();this.disableAllowList();return}this.checkRepoPermission()},scope:this});this.sendWebAPI({api:"SYNO.Core.System",method:"info",version:1,params:{type:"network"},callback:this.onQueryHostnameDone,scope:this});return this.callParent(arguments)},checkRepoPermission:function(){this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"check_permission",params:{repo_id:this.repoId,repo_action:"edit_permission"},callback:function(d,a,b){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}var c=this.getPanel().getForm().findField("white_list_edit_hint");if(c&&a.allow){c.show()}if(!a.allow){this.disableAllowList()}},scope:this})},disableAllowList:function(){var a=this.getPanel().getComponent("white_list_field_set");if(a){a.getComponent("allow_list_button").disable();a.getComponent("allow_list_button").setTooltip(_T("backup","general_backup_destination_disconnect"))}},onClose:function(){return this.callParent(arguments)},applySetting:function(){var a=this.getPanel().getForm();var b=a.getFieldValues(true);if(!a.isValid()){return false}if(!a.isDirty()){this.close();return true}if(Ext.isDefined(b.name)&&!this.isNameValid(b.name)){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","repo_name_duplicate"));return false}b.repo_id=this.repoId;b.transfer_type=this.transferType;b.target_type=this.targetType;if(a.findField("sshportcheck")){if(a.findField("sshportcheck").getValue()){b.enc_port=a.findField("enc_port").getValue()}else{b.enc_port=0}}if(a.findField("verify_cert")){if(this.verify_cert){b.verify_cert=true}else{b.verify_cert=false}}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"set",params:b,callback:this.onApplyDone,scope:this})},isNameValid:function(a){return this.orgName===a||-1===this.repoList.findExact("name",a)},isHostnameValid:function(c){var b=c.toLowerCase();var d=/^(localhost|127\.0\.0\.1|::1|0:0:0:0:0:0:0:1)$/;var a=this.selfIPs;if(b.match(d)||(b===this.selfHostName)||(a&&-1!==a.indexOf(b))){return _T("netbackup","netbkp_sync_self")}if(!Ext.form.VTypes.netbiosName(b)&&!Ext.form.VTypes.looseip(b)&&!Ext.form.VTypes.hostname(b)){return _T("netbackup","netbkp_err_host_str")}return true},onApplyDone:function(d,a,b){var c;this.clearStatusBusy();if(!d){if(4455===a.code&&Ext.isDefined(a.errors)&&Ext.isDefined(a.errors.errorlist)){c="<li>"+_T("backup","network_backup")+"<BR>"+SYNO.SDS.Backup.GetErrorString(a.errors.errorlist.rsync)+"</li>";c+="<li>"+_T("backup","encrypt_backup")+"<BR>"+SYNO.SDS.Backup.GetErrorString(a.errors.errorlist.ssh)+"</li>";this.getMsgBox().alert(_T("leaf","backup"),c)}else{this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code))}return}this.close()},onQueryHostnameDone:function(d,c,b){var a=[];if(!d||c===undefined||!Ext.isArray(c.nif)){return}this.selfHostName=c.hostname.toLowerCase();Ext.each(c.nif,function(e){a.push(e.addr);if(Ext.isArray(e.ipv6)){Ext.each(e.ipv6,function(f){a.push(f.addr)})}});this.selfIPs=a},onResumeBtnClick:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository.Certificate",version:1,method:"verify",params:{repo_id:this.repoId},callback:function(d,a,b){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_T("tree","leaf_backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}var c=this.getPanel().getForm().findField("verify_cert");if(c){c.removeClass("syno-backup-orange-status");c.removeClass("syno-backup-green-status");if(true===a.verify_cert){this.verify_cert=true;c.addClass("syno-backup-green-status");c.setValue(_T("backup","certificate_auth_status_enable"))}else{this.verify_cert=false;c.addClass("syno-backup-orange-status");c.setValue(_T("backup","certificate_auth_status_skip"));SYNO.SDS.Utils.AddTip(c.getEl(),_T("backup","certificate_auth_hint"));this.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","certificate_auth_failed"))}}},scope:this})}});SYNO.SDS.Backup.Repository.EditDialog.WhiteListFieldset=Ext.extend(SYNO.ux.FieldSet,{constructor:function(a){this.repoId=a.repoId;this.owner=a.owner;var b=Ext.apply({title:_T("backup","repo_white_list_title"),border:true,hideMode:"display",itemId:"white_list_field_set",items:this.createItems()},a);SYNO.SDS.Backup.TargetPropertyDialog.WhiteListFieldset.superclass.constructor.call(this,b)},editWhiteList:function(){var a=new SYNO.SDS.Backup.Repository.PrivilegeDialog({owner:this.owner,domainUserHomeEnabled:true,ldapUserHomeEnabled:true,apiURL:"SYNO.Backup.Repository.PrivilegedUser",repoId:this.repoId,title:_T("backup","repo_choose_white_list")});a.open()},createItems:function(){var a=[{xtype:"syno_displayfield",value:_T("backup","repo_white_list_desc")},{xtype:"syno_button",text:_T("backup","backup_white_list"),scope:this,handler:this.editWhiteList,itemId:"allow_list_button"}];return a}});(function(){var a=(function(){var e=new Ext.XTemplate('<table class="syno-backup-listview-attr-table">','<tpl for="properties">',"<tr>",'<td class="syno-backup-attr-key">{key:htmlEncode}</td>','<td class="syno-backup-attr-value" ext:qtip="{qtip:htmlEncode}">{text}</td>',"</tr>","</tpl>","</table>",'<div class="syno-backup-attr-key" style="margin-top:10px;">{[_T("backup", "task_list_title")]}</div>','<div class="syno-backup-task-list">','<div class="syno-backup-task-list-header">',"<tpl if=\"target_type != 'image'\">",'<div style="float:left;width:35%">ID</div>','<div style="float:left;width:65%">{[_T("localbkp", "localbkp_bkpset_name")]}</div>',"</tpl>","<tpl if=\"target_type == 'image'\">",'<div style="float:left;width:10%">ID</div>','<div style="float:left;width:47%">{[_T("localbkp", "localbkp_bkpset_name")]}</div>','<div style="float:left;width:25%">{[_T("backup", "backup_restore_source")]}</div>','<div style="float:left;width:18%">{[_T("common", "action")]}</div>',"</tpl>",'<div class="x-clear"></div>',"</div>",'<div class="syno-backup-task-list-body">',"<tpl if=\"this.itemLength(values.target_list) == -1 && deststatus != 'error'\">",'<div style="padding-left:10px;height:28px;line-height:28px">{[_T("common", "loading")]}</div>',"</tpl>","<tpl if=\"this.itemLength(values.target_list) == -1 && deststatus == 'error'\">",'<div style="padding-left:10px;height:28px;line-height:28px">{[_T("backup", "no_task_desc")]}</div>',"</tpl>",'<tpl if="this.itemLength(values.target_list) == 0">','<div style="padding-left:10px;height:28px;line-height:28px">{[_T("backup", "no_task_desc")]}</div>',"</tpl>",'<tpl if="this.itemLength(values.target_list) &gt; 0 ">','<tpl for="target_list">','<dl class="syno-backup-task-list-row">',"<tpl if=\"parent.target_type == 'image'\">",'<dt class="syno-backup-task-list-column" style="width:10%">{target_id:htmlEncode}',"</tpl>","<tpl if=\"parent.target_type != 'image'\">",'<dt class="syno-backup-task-list-column" style="width:35%">{target_id:htmlEncode}',"</tpl>","</dt>","<tpl if=\"parent.target_type == 'image'\">",'<dt class="syno-backup-task-list-column" style="width:47%">',"</tpl>","<tpl if=\"parent.target_type != 'image'\">",'<dt class="syno-backup-task-list-column" style="width:65%">',"</tpl>","<tpl if=\"task_name != ''\">","{task_name:htmlEncode}","</tpl>","<tpl if=\"task_name == ''\">","<tpl if=\"parent.target_type != 'image'\">",'<span ext:qtip=\'{[_T("backup", "unknown_task_name_hint")]}\'>&#45&nbsp&#45</span>',"</tpl>","<tpl if=\"parent.target_type == 'image'\">",'<span ext:qtip=\'{[_T("backup", "unknown_task_name_hint_5.1")]}\'>&#45&nbsp&#45</span>',"</tpl>","</tpl>","</dt>","<tpl if=\"parent.target_type == 'image'\">",'<dt class="syno-backup-task-list-column" style="width:25%">',"<tpl if=\"host_name != ''\">","{host_name:htmlEncode}","</tpl>","<tpl if=\"host_name == ''\">","<span ext:qtip='{[this.getNoSourceTip()]}'>&#45&nbsp&#45</span>","</tpl>","</dt>",'<dt class="syno-backup-task-list-column" style="float:right;width:18%">','<div class="syno-backup-task-relink" style="width:30px;','<tpl if="support_relink != true">'," visibility:hidden;","</tpl>",'"></div>','<tpl if="support_property == true">','<div class="syno-backup-task-property ','<tpl if="support_edit == true">',"syno-backup-task-support-edit ","</tpl>",'<tpl if="enable_edit == true">',"syno-backup-task-enable-edit ","</tpl>",'" style="width:30px" ext:qtip="{[_T("common", "properties")]}"></div>',"</tpl>",'<div class="syno-backup-task-version-mgr" ext:qtip="{[_T("backup", "version_info")]}" style="width:30px;','<tpl if="support_multi_version != true">'," visibility:hidden;","</tpl>",'"></div>','<div class="syno-backup-task-delete" ext:qtip="{[_T("common", "delete")]}" style="width:30px;','<tpl if="support_remove != true">'," visibility:hidden;","</tpl>",'"></div>',"</dt>","</tpl>",'<div class="x-clear"></div>',"</dl>","</tpl>","</tpl>","</div>","</div>",{itemLength:function(f){if(!f){return -1}return f.length},getNoSourceTip:function(){return String.format(_T("backup","old_sever_not_support"),"DSM 5.1")}});e.compile();return e}());function c(e,g){var f=[];f.push({key:_T("tunnel","tunnel_status"),text:g.deststatus?SYNO.SDS.Backup.GetDestStatusStr(g.deststatus):_T("common","loading"),qtip:g.desterror?SYNO.SDS.Backup.GetErrorString(g.desterror):undefined});g.properties=f.concat(e);return a.apply(g)}function d(e){return(e.transfer_type==="image_remote"||e.transfer_type==="rsync"||e.transfer_type==="rsync_ds")}function b(f,h,e){var g=SYNO.SDS.Backup.Addon.GetSymbol(f,"Repository.PrepareData");if(!g){return}e.push({key:_T("backup","s3_provider"),text:SYNO.SDS.Backup.Addon.GetStr(h.transfer_type,"addon","name")});g(h,e);return}Ext.define("SYNO.SDS.Backup.Repository.RepoListView",{extend:"SYNO.SDS.Backup.ExpandableListView",constructor:function(e){this.callParent(arguments);this.addClass("syno-backup-repo-listview");this.mon(this,"toggle",this.onToggleClick,this)},prepareData:function(i,h,e){var g="";i.title=i.name;if(d(i)){g=i.dest+_T("common","colon")+" "}if(i.target_type==="share"){g+=i.share;i.status=g;i.iconCls="syno-backup-repo-"+(d(i)?"remote":"local")+"-share";i.detail_html=this.renderShareRepoDetail(i,h,e);if(i.transfer_type==="rsync"){i.iconCls="syno-backup-repo-rsync-share"}}else{if(i.target_type==="image"){g+=i.volume;i.status=g;i.iconCls="syno-backup-repo-"+(d(i)?"remote":"local")+"-image";i.detail_html=this.renderImageRepoDetail(i,h,e)}else{if(i.target_type==="cloud"){var f=[];b(i.transfer_type,i,f);i.detail_html=c(f,i)}}}return i},renderShareRepoDetail:function(h,g,e){var f=[];if(d(h)){f.push({key:_T("common","ip_addr"),text:h.dest});if(h.enc_port&&0<h.enc_port){f.push({key:_T("netbackup","netbkp_sshd_port"),text:h.enc_port})}f.push({key:_T("common","username"),text:h.account})}f.push({key:_T("tree","leaf_sharefolder"),text:h.share});return c(f,h)},renderImageRepoDetail:function(h,g,e){var f=[];if(d(h)){f.push({key:_T("common","ip_addr"),text:h.dest});f.push({key:_T("common","username"),text:h.account})}f.push({key:_T("volume","volume"),text:h.volume});if(h.host!==""&&h.creator!==""){f.push({key:_T("backup","repo_creator"),text:h.creator});f.push({key:_T("backup","repo_creator_host"),text:h.host})}return c(f,h)},onClick:function(k,l,j){this.callParent(arguments);var g=this.getSelectedRecords();if(1!==g.length){return}var n;var h=g[0].get("repo_id");var i=g[0].get("name");var m=g[0].get("dest");var f=Ext.fly(l);if(f&&(f.hasClass("syno-backup-task-relink"))){n=f.parent().parent().first().dom.innerHTML;this.page.taskRelink(h,n)}if(f&&(f.hasClass("syno-backup-task-version-mgr"))){n=f.parent().parent().first().dom.innerHTML;this.page.versionMgr(h,n)}if(f&&(f.hasClass("syno-backup-task-delete"))){n=f.parent().parent().first().dom.innerHTML;this.page.targetDelete(h,n)}if(f&&f.hasClass("syno-backup-task-property")){n=f.parent().parent().first().dom.innerHTML;this.page.targetEdit(h,n,i,f.hasClass("syno-backup-task-support-edit"),f.hasClass("syno-backup-task-enable-edit"),m)}},onToggleClick:function(e,f){var g=this.getSelectedRecords();if(0>=g.length||!f.child(".item-toggle-expanded")){return}this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:g[0].id,additional:["target_list"]},callback:this.updateDetail,scope:this})},updateDetail:function(h,e,f){var g=this.getStore().getById(f.repo_id);if(!g){return}if(!h){SYNO.Debug(e.code);g.set("deststatus","error");g.set("desterror",SYNO.SDS.Backup.ERR_INTERNAL_ERROR);return}this.getStore().loadData({repo_list:[e]},true)}})})();Ext.define("SYNO.SDS.Backup.TargetPropertyDialog",{extend:"SYNO.SDS.ModalWindow",labelWidth:290,constructor:function(a){this.repoId=a.repoId;this.targetId=a.targetId;this.repoName=a.repoName;this.dest=a.dest;var d=[];this.infoField=new SYNO.SDS.Backup.TargetPropertyDialog.InfoFieldset({repoId:a.repoId,targetId:a.targetId,owner:this,labelWidth:this.labelWidth});d.push(this.infoField);this.whiteListField=new SYNO.SDS.Backup.TargetPropertyDialog.WhiteListFieldset({repoId:a.repoId,targetId:a.targetId,owner:this,enableEdit:a.enableEdit,repoName:a.repoName});if(a.supportEdit){d.push(this.whiteListField)}this.ownerField=new SYNO.SDS.Backup.TargetPropertyDialog.OwnerFieldset({repoId:a.repoId,targetId:a.targetId,repoName:a.repoName,owner:this,enableEdit:a.enableEdit,labelWidth:this.labelWidth});d.push(this.ownerField);var c=[];if(a.enableEdit){c.push({xtype:"syno_button",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.applySetting});c.push({xtype:"syno_button",text:_T("common","cancel"),handler:function(){this.close()},scope:this})}else{c.push({xtype:"syno_button",text:_T("common","finish"),handler:function(){this.close()},scope:this})}var b=Ext.apply({title:_T("common","properties"),width:730,autoHeight:true,layout:"fit",closable:true,resizable:false,buttons:c,items:[{xtype:"syno_formpanel",layout:"form",trackResetOnLoad:true,waitMsgTarget:true,hideMode:"display",hidden:false,border:false,height:496,autoScroll:true,items:d}]},a);return this.callParent([b])},refineUserName:function(a){if(a.search("@")>=0||this.dest.empty()){return a}return String.format("{0}@{1}",a,this.dest)},onOpen:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target",version:1,method:"get_property",params:{repo_id:this.repoId,target_id:this.targetId},callback:function(c,a,b){if(!c){this.clearStatusBusy();this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code),function(){this.close()},this);return}this.ownerField.loadData(this.refineUserName(a.owner_name),a.owner_id,a.support_change_owner);this.infoField.loadData(a);this.clearStatusBusy()},scope:this});return this.callParent(arguments)},applySetting:function(){return this.ownerField.applySetting()},onClose:function(){return this.callParent(arguments)}});SYNO.SDS.Backup.TargetPropertyDialog.WhiteListFieldset=Ext.extend(SYNO.ux.FieldSet,{constructor:function(a){this.repoId=a.repoId;this.targetId=a.targetId;this.owner=a.owner;var b=Ext.apply({title:_T("backup","target_white_list_title"),border:true,hideMode:"display",name:"whiteListFieldset",items:this.createItems(a.enableEdit)},a);SYNO.SDS.Backup.TargetPropertyDialog.WhiteListFieldset.superclass.constructor.call(this,b)},editWhiteList:function(){var a=new SYNO.SDS.Backup.Repository.PrivilegeDialog({owner:this.owner,domainUserHomeEnabled:true,ldapUserHomeEnabled:true,apiURL:"SYNO.Backup.Target.PrivilegedUser",repoId:this.repoId,targetId:this.targetId,title:_T("backup","target_choose_white_list"),repoPermAutoAdd:true,repoName:this.repoName});a.open()},createItems:function(b){var a=[{xtype:"syno_displayfield",value:_T("backup","target_white_list_desc")},{xtype:"syno_button",text:_T("backup","backup_white_list"),scope:this,disabled:!b,tooltip:!b?_T("backup","no_permission_edit_target"):undefined,handler:this.editWhiteList}];return a}});SYNO.SDS.Backup.TargetPropertyDialog.InfoFieldset=Ext.extend(SYNO.ux.FieldSet,{constructor:function(a){this.repoId=a.repoId;this.targetId=a.targetId;this.repoName=a.repoName;this.owner=a.owner;var b=Ext.apply({title:_T("common","general"),border:true,hideMode:"display",name:"infoFieldset",items:this.createItems()},a);SYNO.SDS.Backup.TargetPropertyDialog.InfoFieldset.superclass.constructor.call(this,b)},createItems:function(){var a=[{xtype:"syno_displayfield",fieldLabel:_T("backup","task_name"),name:"task_name",itemId:"task_name",width:"auto"},{xtype:"syno_displayfield",fieldLabel:_T("backup","source_host_name"),name:"host_name",itemId:"host_name",width:"auto"},{xtype:"syno_displayfield",fieldLabel:_T("backup","space_usage"),name:"used_size",itemId:"used_size",width:"auto"},{xtype:"syno_displayfield",fieldLabel:_T("usbbackup","usbbkp_backup_shares"),name:"bkp_folder",itemId:"bkp_folder",width:"auto"},{xtype:"syno_displayfield",fieldLabel:_T("backup","backup_app"),name:"bkp_app",itemId:"bkp_app",width:"auto"},{xtype:"syno_displayfield",fieldLabel:_T("backup","backup_synoea_option"),name:"enable_thum",itemId:"enable_thum",width:"auto"}];return a},showSize:function(a){if(0>a){return _T("backup","calculating")+" ..."}return Ext.util.Format.htmlEncode(SYNO.SDS.Backup.ConverSize(a*1024,2))},shortName:function(a){return SYNO.SDS.Backup.Util.widthEllipsis(a,340)},loadData:function(b){var a=b.host_name;if(b.source_ip&&b.source_ip!==""){a+=" ("+b.source_ip+")"}this.get("task_name").setValue(b.task_name);this.get("host_name").setValue(a);this.get("used_size").setValue(this.showSize(b.used_size));this.get("bkp_folder").setValue(0===b.bkp_folder.length?_T("common","none"):this.shortName(b.bkp_folder));this.get("bkp_app").setValue(0===b.bkp_app.length?_T("common","none"):this.shortName(b.bkp_app));this.get("enable_thum").setValue(b.enable_thum?_T("common","yes"):_T("common","no"));if(0>b.used_size){this.startPollingSize()}},startPollingSize:function(){this.gCalcRequest=this.addWebAPITask({api:"SYNO.Backup.Target",method:"get_space",version:1,interval:5000,params:{repo_id:this.repoId,target_id:this.targetId},callback:function(c,b,a){if(this.isDestroyed){if(this.gCalcRequest){this.gCalcRequest.stop();this.gCalcRequest=0}return}if(c&&0<=b.space){this.gCalcRequest.stop();this.gCalcRequest=0;this.get("used_size").setValue(this.showSize(b.space))}else{if(!c){this.gCalcRequest.stop();this.gCalcRequest=0;this.get("used_size").setValue("N/A")}}},scope:this});this.gCalcRequest.start(true)}});SYNO.SDS.Backup.TargetPropertyDialog.OwnerFieldset=Ext.extend(SYNO.ux.FieldSet,{constructor:function(a){this.repoId=a.repoId;this.targetId=a.targetId;this.repoName=a.repoName;this.owner=a.owner;var b=Ext.apply({title:_T("backup","target_owner_title"),border:true,hideMode:"display",name:"ownerFieldset",height:"auto",items:this.createItems(a.enableEdit)},a);SYNO.SDS.Backup.TargetPropertyDialog.OwnerFieldset.superclass.constructor.call(this,b)},createItems:function(b){var c=new SYNO.FileStation.PropertyDialog.ACLPrivilege.IconCombo({labelStyle:"margin-left: 0px; width: 180px;",displayField:"name",iconClsField:"type",iconClsPrefix:"acl-combo-item-",valueField:"value",triggerAction:"all",mode:"remote",pageSize:50,editable:true,listEmptyText:_T("backup","error_invalid_user_or_group"),valueNotFoundText:_T("backup","error_invalid_user_or_group"),grow:true,maxHeight:360,minChars:1,typeAhead:true,fieldLabel:_T("backup","filetable_owner"),width:350,listWidth:350,itemId:"owner_cmb",queryParam:"substr",readOnly:!b,hidden:true,validator:function(d){if(d===_T("backup","error_invalid_user_or_group")){return false}return true},listeners:{focus:{scope:this,fn:function(d){if(d.getRawValue()===_T("backup","error_invalid_user_or_group")){d.clearValue()}}}}});var a=[{xtype:"syno_displayfield",value:_T("backup","backup_target_owner_desc")},{xtype:"syno_displayfield",fieldLabel:_T("backup","filetable_owner"),itemId:"init_owner",hidden:false,width:"auto"},c,{xtype:"syno_displayfield",fieldLabel:_T("backup","filetable_owner"),itemId:"unedit_owner",hidden:true,width:"auto"}];return a},loadData:function(f,c,a){if(this.isDestroyed){return}var e=this.get("owner_cmb");var b=this.get("unedit_owner");var g=this.get("init_owner");e.setDefaultValue(f,"user",c);this.defOwnerId=c;b.setValue(String.format('<div class="x-combo-list-item acl-icon-combo-item acl-combo-item-user">{0}</div>',f));g.hide();if(!a){e.hide();b.show()}else{e.show();b.hide();var d=f+" ("+_T("backup","no_permission_edit_target")+")";if(!this.enableEdit){Ext.QuickTips.register({target:e,text:d})}}e.store=new Ext.data.Store({autoDestroy:true,proxy:new SYNO.API.Proxy({api:"SYNO.Core.User",method:"list",version:1}),reader:new Ext.data.JsonReader({root:"users",totalProperty:"total",idProperty:"value",fields:[{name:"type",convert:function(){return"user"}},{name:"name"},{name:"value",mapping:"uid"}]}),paramNames:{start:"offset",limit:"limit"},remoteSort:true,pruneModifiedRecords:true,baseParams:{type:"all",additional:["uid"]}})},validateData:function(){var a=this.get("owner_cmb");return !a.valueNotFound()},applySetting:function(){if(!this.validateData()){this.owner.getMsgBox().alert(_T("error","error_error"),_T("backup","error_invalid_user_or_group"));return}var a=this.get("owner_cmb");this.newOwnerId=a.getValue();this.newOwnerName=a.getRawValue();if(this.defOwnerId===a.getValue()){this.owner.close();return}this.owner.getMsgBox().confirm(_T("common","note"),_T("backup","backup_target_owner_change_hint")+"<br>"+_T("common","ask_cont"),function(b){if("yes"==b){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target.Owner",version:1,method:"set",params:{repo_id:this.repoId,target_id:this.targetId,owner_id:this.newOwnerId},callback:this.onApplyDone,scope:this})}},this)},onApplyDone:function(c,a,b){if(!c){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));this.owner.clearStatusBusy();return}this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"check_permission",params:{repo_id:this.repoId,user_id:this.newOwnerId,repo_action:"backup"},scope:this,callback:this.confirmAllowList})},confirmAllowList:function(c,a,b){this.owner.clearStatusBusy();if(!c){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));this.owner.close();return}if(a.allow){this.owner.close();return}this.owner.getMsgBox().confirm(_T("backup","repo_choose_white_list"),String.format(_T("backup","auto_add_white_list_confirm"),this.newOwnerName,this.repoName),function(d){if("yes"===d){this.addWhiteList(this.newOwnerId)}else{this.owner.close()}},this)},addWhiteList:function(a){var b=[];b.push([this.newOwnerId,"user"]);this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository.PrivilegedUser",method:"add",params:{repo_id:this.repoId,target_id:this.targetId,user_id:b},version:1,scope:this,callback:function(e,d,c){this.owner.clearStatusBusy();if(!e){this.owner.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(d.code));return}this.owner.close()}})}});Ext.define("SYNO.SDS.Backup.VersionDialog",{extend:"SYNO.SDS.ModalWindow",dsmStyle:"v5",pageSize:50,constructor:function(a){this.isPolling=false;var b=Ext.apply({title:_T("backup","version_info"),closable:true,width:720,height:500,layout:"fit",useStatusBar:false,minWidth:720,minHeight:300,items:[{xtype:"syno_gridpanel",itemId:"version_grid",store:this.getStore(),loadMask:true,autoExpandColumn:"timestamp",enableHdMenu:false,enableColumnMove:false,enableColumnResize:false,disableSelection:true,trackMouseOver:true,defaults:{sortable:false},colModel:this.getColModel(false),bbar:new SYNO.ux.PagingToolbar({store:this.getStore(),displayInfo:true,pageSize:this.pageSize,listeners:{beforechange:{fn:this.addGridLoadMask,scope:this}},showRefreshBtn:true})}],listeners:{close:this.stopPolling,scope:this}},a);this.callParent([b])},getColModel:function(b){var a=30;return new Ext.grid.ColumnModel([{header:"",dataIndex:"locked",width:a,hidden:b,resizable:false,align:"center",renderer:this.renderLocked.createDelegate(this)},{header:_T("backup","version_time"),dataIndex:"timestamp",width:b?(270+a):270,align:"left",renderer:this.formatTime},{header:_T("backup","version_status"),dataIndex:"status",width:250,resizable:false,align:"left",renderer:this.statusToStr.createDelegate(this)}])},initEvents:function(){this.callParent(arguments);this.mon(this.getGrid(),"rowclick",function(b,f,d){var c=Ext.fly(d.target);if(!c){return}var a=this.store.getAt(f);if(c.hasClass("syno-backup-version-browse")){this.defaultVersion=a.get("timestamp");this.onFileRestore()}else{if(c.hasClass("syno-backup-version-delete")){this.onVersionDelete(a.get("version_id"),a.get("timestamp"))}else{if(c.hasClass("syno-backup-version-lock")){this.onVersionUnLock(a.get("version_id"))}else{if(c.hasClass("syno-backup-version-unlock")){this.lockVersion(a.get("version_id"),true)}}}}},this);this.mon(this.getGrid(),"rowdblclick",function(a,f,c){var d=a.getStore().getAt(f);var b=Ext.fly(c.target);if(b&&(b.hasClass("syno-backup-version-lock")||b.hasClass("syno-backup-version-unlock")||b.hasClass("syno-backup-version-lock-disable")||b.hasClass("syno-backup-version-delete")||b.hasClass("syno-backup-version-delete-disable"))){return true}if(d.get("status")==="success"){this.onFileRestore(d.get("timestamp"))}},this)},onShow:function(){if(this.getGrid().loadMask){this.getGrid().loadMask.show()}this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Version",version:2,method:"list",params:{repo_id:this.repoId,target_id:this.targetId,offset:0,limit:this.pageSize,additional:["version_operate_property"],filter_name:"available"},scope:this,callback:function(c,a,b){if(this.getGrid().loadMask){this.getGrid().loadMask.hide()}this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code),function(){this.close()},this);return}this.supportLock=a.support_lock;this.permitDelete=a.permit_delete;if(!this.permitDelete){this.getGrid().reconfigure(this.getStore(),this.getColModel(true))}this.getStore().loadData(a,false)}})},onFileRestore:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target",version:1,method:"get_property",params:{repo_id:this.repoId,target_id:this.targetId},scope:this,callback:function(d,a,b){this.clearStatusBusy();if(!d){this.getMsgBox().alert(_T("netbackup","netbkp_recovery"),SYNO.SDS.Backup.GetErrorString(a.code),function(){this.close()},this);return}var c=new SYNO.SDS.Backup.FileBrowser.Window({height:580,width:900,useStatusBar:false,closable:true,repoId:this.repoId,targetId:this.targetId,support_download:a.support_download,support_filter:a.support_filter,hostname:a.host_name,defaultVersion:this.defaultVersion,cls:"syno-sds-backup-filebrowser",owner:this});this.stopPolling();this.mon(c,"close",this.startPolling,this);c.open()}})},onVersionDelete:function(a,b){this.getMsgBox().confirmDelete(this.title,String.format(_T("common","remove_cfrmrmv")+"<br />"+this.formatTime(b)),function(c){if("yes"===c){this.deleteVersion(a)}},this)},onVersionUnLock:function(a){this.getMsgBox().confirm(this.title,_T("backup","confirm_unlock_version"),function(b){if("yes"===b){this.lockVersion(a,false)}},this)},lockVersion:function(b,a){this.setStatusBusy();this.stopPolling();this.sendWebAPI({api:"SYNO.Backup.Version",version:1,method:"lock",params:{repo_id:this.repoId,target_id:this.targetId,version_id:b,lock:a},callback:function(e,c,d){if(!e){this.startPolling();this.clearStatusBusy();this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(c.code));return}var f=this.store.find("version_id",b);if(-1<f){this.store.data.itemAt(f).data.locked=a;this.getGrid().getView().refreshRow(f)}this.startPolling();this.clearStatusBusy()},scope:this})},formatTime:function(b){var a=new Date(b*1000);return a.toLocaleString()},getStore:function(){if(!this.store){this.store=new SYNO.API.Store({api:"SYNO.Backup.Version",version:2,method:"list",baseParams:{offset:0,limit:this.pageSize,filter_name:"available"},appWindow:false,autoLoad:false,reader:new Ext.data.JsonReader({idProperty:"version_id",root:"version_info_list",totalProperty:"total",fields:["version_id","timestamp","modify","status","locked"]}),listeners:{scope:this,beforeload:this.onBeforeLoad,loadexception:this.onLoadException,load:this.onLoadDone}})}return this.store},getGrid:function(){return this.getComponent("version_grid")},deleteVersion:function(a){this.setStatusBusy();this.stopPolling();this.sendWebAPI({api:"SYNO.Backup.Version",version:1,method:"delete",params:{repo_id:this.repoId,target_id:this.targetId,version_id_list:[a]},callback:function(d,b,c){if(!d){this.startPolling();this.clearStatusBusy();this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var e=this.store.find("version_id",a);if(-1<e){this.store.data.itemAt(e).data.status="deleting";this.getGrid().getView().refreshRow(e)}this.clearStatusBusy();this.startPolling()},scope:this})},getVersionStatus:function(b){var a={none:{msg:_T("common","none"),textCls:"blue-status",deleteCls:"syno-backup-version-delete-hide",browserCls:"syno-backup-version-browse-hide"},backup:{msg:_T("backup","version_status_backing_up"),textCls:"blue-status",deleteCls:"syno-backup-version-delete-disable",browserCls:"syno-backup-version-browse-disable"},success:{msg:_T("backup","version_status_success"),textCls:"green-status",deleteCls:(b.get("locked")?"syno-backup-version-delete-disable":"syno-backup-version-delete"),browserCls:"syno-backup-version-browse"},failed:{msg:_T("backup","version_status_failed"),textCls:"red-status",deleteCls:"syno-backup-version-delete",browserCls:"syno-backup-version-browse-hide"},partial:{msg:_T("backup","version_status_partial"),textCls:"red-status",deleteCls:"syno-backup-version-delete",browserCls:"syno-backup-version-browse-hide"},cancel:{msg:_T("backup","version_status_canceled"),textCls:"red-status",deleteCls:"syno-backup-version-delete",browserCls:"syno-backup-version-browse-hide"},deleting:{msg:_T("backup","version_deleting"),textCls:"blue-status",deleteCls:"syno-backup-version-delete-disable",browserCls:"syno-backup-version-browse-hide"}};if(b.get("status") in a){return a[b.get("status")]}else{return a.none}},statusToStr:function(e,d,b){var a=this.getVersionStatus(b);var c=new Ext.XTemplate('<span class="syno-backup-version-status {textCls}">{msg}</span>'+(this.permitDelete?'<div class="{deleteCls}" ext:qtip="{deleteQtip}"></div>':"")+'<div class="{browserCls}" ext:qtip="{browserQtip}"></div>');if(a.deleteCls!=="syno-backup-version-delete-hide"){if(b.get("locked")){a.deleteQtip=_T("backup","version_lock_delete_fail")}else{a.deleteQtip=_T("common","delete")}}if(a.browserCls!=="syno-backup-version-browse-hide"){a.browserQtip=_T("backup","backup_filebrowser")}return c.apply(a)},renderLocked:function(e,d,b){var c=new Ext.XTemplate('<div class="{lockCls}" ext:qtip="{lockQtip}"></div>');var a="";var f="";if(this.supportLock){switch(b.get("status")){case"backup":case"success":if(e){a="syno-backup-version-lock";f=_T("backup","backup_lock_qtip")}else{a="syno-backup-version-unlock";f=_T("backup","backup_unlock_qtip")}break;case"none":case"failed":case"partial":case"cancel":case"deleting":a="syno-backup-version-lock-disable";break}}else{a="syno-backup-version-lock-disable";f=_T("backup","version_lock_not_support")}return c.apply({lockCls:a,lockQtip:f})},onBeforeLoad:function(a){a.setBaseParam("repo_id",this.repoId);a.setBaseParam("target_id",this.targetId)},addGridLoadMask:function(){if(this.getGrid().initialConfig.loadMask){if(this.getGrid().loadMask){this.getGrid().loadMask.destroy()}this.getGrid().loadMask=new Ext.LoadMask(this.getGrid().bwrap,Ext.apply({},{store:this.getStore()},true))}},onLoadDone:function(b,a,c){if(this.getGrid().loadMask){this.getGrid().loadMask.destroy();this.getGrid().loadMask=false}if(this.isTaskRunning()){this.startPolling()}else{this.stopPolling()}if(this.isPolling&&c.isPollReload){setTimeout(function(){b.reload({isPollReload:true})},3000)}},onLoadException:function(c,b,a){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code),function(){this.close()},this)},isTaskRunning:function(){var a=false;this.getStore().each(function(c){var b=c.get("status");if("deleting"===b||"backup"===b){a=true;return false}});return a},startPolling:function(){if(this.isPolling){return}this.isPolling=true;this.getStore().reload({isPollReload:true})},stopPolling:function(){if(!this.isPolling){return}this.isPolling=false}});Ext.define("SYNO.SDS.Backup.RelinkDialog",{extend:"SYNO.SDS.ModalWindow",dsmStyle:"v5",constructor:function(a){var b=Ext.apply({title:"FIXME! Relink info",closable:true,width:300,height:400,layout:"fit",items:[{xtype:"syno_formpanel",itemId:"relink_panel",items:[{xtype:"syno_displayfield",fieldLabel:"TBD"}]}],listeners:{scope:this,activate:this.onActivate}},a);this.callParent([b])},onActivate:function(){this.sendWebAPI({api:"SYNO.Backup.Task",version:1,method:"relink",params:{repo_id:this.repoId,target_id:this.targetId},scope:this,callback:function(c,a,b){if(!c){alert(a.code);return}}})}});Ext.define("SYNO.SDS.Backup.Repository.MainPage",{extend:"SYNO.ux.Panel",selectRepoId:undefined,constructor:function(a){this.pollingInterval=5;this.isRestoring=false;this.isSnapshotRestoring=false;this.isDownloading=false;Ext.copyTo(this,a,"appWin");a=this.fillConfig(a);this.callParent([a])},fillConfig:function(a){return Ext.apply({layout:"fit",tbar:this.getToolBar(),items:[this.getView()]},a)},getToolBar:function(){if(this.toolbar){return this.toolbar}this.toolbar=new SYNO.ux.Toolbar({items:[{xtype:"syno_button",text:_T("common","create"),scope:this,handler:this.onCreate},{xtype:"syno_button",itemId:"btn_edit",text:_T("common","alt_edit"),disabled:true,scope:this,handler:this.onEdit},{xtype:"syno_button",itemId:"btn_delete",text:_T("common","delete"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):"",disabled:true,scope:this,handler:this.onDelete}]});return this.toolbar},getView:function(){if(this.view){return this.view}this.view=new SYNO.SDS.Backup.Repository.RepoListView({owner:this.appWin,page:this,multiSelect:false,singleSelect:true,store:this.getStore(),listeners:{selectionchange:this.updateButtonState,scope:this}});return this.view},getStore:function(){if(this.store){return this.store}this.store=new SYNO.API.Store({api:"SYNO.Backup.Repository",version:1,method:"list",baseParams:{offset:0,limit:-1},appWindow:this.appWin,reader:new Ext.data.JsonReader({idProperty:"repo_id",root:"repo_list",totalProperty:"total",fields:[{name:"id",mapping:"repo_id"},{name:"repo_id",mapping:"repo_id"},{name:"name",mapping:"name"},{name:"dest",mapping:"dest"},{name:"deststatus",mapping:"deststatus"},{name:"desterror",mapping:"desterror"},{name:"volume",mapping:"volume"},{name:"share",mapping:"share"},{name:"bucket",mapping:"bucket"},{name:"target_type",mapping:"target_type"},{name:"transfer_type",mapping:"transfer_type"},{name:"account",mapping:"account"},{name:"space",mapping:"space"},{name:"target_list",mapping:"target_list"},{name:"creator",mapping:"creator"},{name:"host",mapping:"host"},{name:"enc_port",mapping:"enc_port"}]})});return this.store},doDialogOpen:function(a){if(!a){return}this.stopPollingTask();this.mon(a,"close",this.startPollingTask,this);a.open()},updateButtonState:function(a,b){var c=this.getTopToolbar();c.getComponent("btn_edit").disable();c.getComponent("btn_delete").disable();if(1===b.length&&!this.isRestoring&&!this.isSnapshotRestoring&&!this.isDownloading){c.getComponent("btn_edit").enable()}if(1==b.length&&!_S("demo_mode")&&!this.isRestoring&&!this.isSnapshotRestoring&&!this.isDownloading){c.getComponent("btn_delete").enable()}},onCreate:function(){var a=new SYNO.SDS.Backup.Repository.CreateWizard({owner:this.appWin,repoList:this.getStore()});this.doDialogOpen(a)},onEdit:function(){var b=this.getView().getSelectedRecords();var c;if("cloud"===b[0].get("target_type")){var a=SYNO.SDS.Backup.Addon.GetSymbol(b[0].get("transfer_type"),"Repository.EditDialog");if(!a){return}c=new a({repoList:this.getStore(),owner:this.appWin,repoId:b[0].get("repo_id")})}else{c=new SYNO.SDS.Backup.Repository.EditDialog({repoList:this.getStore(),owner:this.appWin,repoId:b[0].get("repo_id"),targetType:b[0].get("target_type"),transferType:b[0].get("transfer_type")})}this.doDialogOpen(c)},onDelete:function(){var d=this.getView().getSelectedRecords();var b=[];var a=[];Ext.each(d,function(g,e,f){if("image"===g.get("target_type")){a.push(g.get("name"))}else{b.push(g.get("name"))}},this);var c=new SYNO.SDS.Backup.RepoDeleteCheck({owner:this.appWin,deleteRepoList:d,singleVersionRepoList:b,multiVersionRepoList:a,callbacks:{apply:this.onDeleteSuccess,scope:this}});this.doDialogOpen(c)},onDeleteSuccess:function(){var a=this.getView();a.clearSelections();a.collapseAll()},onPageActivate:function(){this.startPollingTask();this.getView().refresh()},onPageDeactivate:function(){this.stopPollingTask()},startPollingTask:function(){this.longPollingCount=0;this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Repository",version:1,method:"list",params:{offset:0,limit:-1,additional:["storage_space","repo_usage"]}},interval:this.pollingInterval,immediate:true,scope:this,status_callback:this.pollingTaskHandler});return this.pollingID},stopPollingTask:function(){this.pollUnreg(this.pollingID)},pollingTaskHandler:function(d,a,c,b){if(!d){return}this.isRestoring=a.is_restoring;this.isSnapshotRestoring=a.is_snapshot_restoring;this.isDownloading=a.is_downloading;this.loadData(a);if(Ext.isDefined(this.selectRepoId)){this.getView().selectAndExpandById(this.selectRepoId);this.selectRepoId=undefined}},loadData:function(a){Ext.each(a.repo_list,function(d,b,c){var g=this.getStore().getById(d.repo_id),e={};if(g){Ext.each(["target_list","deststatus","desterror","space","creator","host"],function(h){e[h]=g.get(h)});Ext.applyIf(d,e);var f=this.getView().toggledItemIds;if("offline"===g.data.deststatus&&(0<=f.indexOf(d.repo_id))){this.pollingRepoDetail(g.data.id)}}},this);if(this._lastData!==Ext.encode(a)){this.getStore().loadData(a);this._lastData=Ext.encode(a)}},taskRelink:function(a,b){if(!a||!b){return}var c=new SYNO.SDS.Backup.RelinkDialog({repoId:a,targetId:b,owner:this.appWin});this.doDialogOpen(c)},versionMgr:function(b,c){if(!b||!c){return}var a=new SYNO.SDS.Backup.VersionDialog({repoId:b,targetId:c,owner:this.appWin});this.doDialogOpen(a)},targetDelete:function(a,b){if(!a||!b){return}var c=new SYNO.SDS.Backup.TargetDeleteCheck({owner:this.appWin,repoId:a,targetId:b});this.doDialogOpen(c);this.mon(c,"close",function(){this.updateRepoDetail(a)},this)},targetEdit:function(a,d,e,g,b,c){if(!a||!d){return}var f=new SYNO.SDS.Backup.TargetPropertyDialog({owner:this.appWin,repoId:a,targetId:d,repoName:e,supportEdit:g,enableEdit:b,dest:c});this.doDialogOpen(f);this.mon(f,"close",function(){this.updateRepoDetail(a)},this)},updateRepoDetail:function(a){this.appWin.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:a,additional:["target_list"]},scope:this,callback:function(e,b,c){this.appWin.clearStatusBusy();if(!e){this.appWin.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(b.code));return}var d=this.getStore().getById(b.repo_id);d.set("deststatus",b.deststatus);d.set("desterror",b.desterror);d.set("target_list",b.target_list)}})},pollingRepoDetail:function(a){if(0>=this.longPollingCount){this.longPollingCount=120/this.pollingInterval;this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:a,additional:["target_list"]},scope:this,callback:function(e,b,c){this.longPollingCount=0;if(!e){return}var d=this.getStore().getById(b.repo_id);d.set("deststatus",b.deststatus);d.set("desterror",b.desterror);d.set("target_list",b.target_list)}})}else{this.longPollingCount--}}});Ext.define("SYNO.SDS.Backup.RepoDeleteCheck",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=_T("backup","remove_repo_data");this.transfer_type=a.deleteRepoList[0].data.transfer_type;this.repoId=a.deleteRepoList[0].data.id;if(0<a.multiVersionRepoList.length&&0<a.singleVersionRepoList.length){b+="&nbsp(&nbsp"+_T("backup","img_repo_only")+"&nbsp)"}var c=Ext.apply({title:_T("common","delete"),width:460,height:400,layout:"fit",items:[{xtype:"syno_formpanel",trackResetOnLoad:true,itemId:"form_panel",autoScroll:true,items:[{xtype:"syno_displayfield",name:"none_img_repo_delete_warning",hidden:false,value:"image_local"===this.transfer_type?_T("backup","repo_delete_warn_local"):_T("backup","repo_delete_warn")},{xtype:"syno_checkbox",boxLabel:b,name:"remove_data",hidden:"image_remote"!==this.transfer_type,inputValue:"remove",checked:false,disabled:false,listeners:{scope:this,check:function(d,e){if(e){this.getFormField("confirm_check").show();this.getFooterToolbar().getComponent("btn_apply").disable();this.doLayout()}else{this.getFormField("confirm_check").setValue(false);this.getFormField("confirm_check").hide();this.getFooterToolbar().getComponent("btn_apply").enable();this.doLayout()}}}},{xtype:"syno_checkbox",name:"confirm_check",hidden:true,indent:1,boxLabel:String.format('<span class="red-status">{0}</span>',_T("backup","delete_repo_data_delete_check")),scope:this,handler:function(e,d){if(d){this.getFooterToolbar().getComponent("btn_apply").enable()}else{this.getFooterToolbar().getComponent("btn_apply").disable()}}},{xtype:"syno_displayfield",name:"repo_delete_withou_data_hint",hidden:true,value:_T("backup","repo_delete_hint")}]}],buttons:[{xtype:"syno_button",itemId:"btn_apply",btnStyle:"red",text:_T("common","delete"),disabled:"image_remote"===this.transfer_type||"image_local"===this.transfer_type,scope:this,handler:this.onDelete},{xtype:"syno_button",text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},a);return this.callParent([c])},initEvents:function(){this.callParent(arguments);this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"check_permission",params:{repo_id:this.repoId,repo_action:"delete"},scope:this,callback:this.setDialog})},setDialog:function(h,b,f){var e=b.allow,a=this.getFormField("remove_data"),c=this.getFormField("confirm_check"),d=this.getFooterToolbar().getComponent("btn_apply"),g=this.getFormField("repo_delete_withou_data_hint");a.setValue(e||this.transfer_type==="image_local");if(e){a.enable();c.show()}else{a.disable();c.hide();d.enable();if(!a.hidden){g.show()}}this.clearStatusBusy()},getFormField:function(a){return this.getComponent("form_panel").getForm().findField(a)},onDelete:function(c){var a=[];Ext.each(this.deleteRepoList,function(f,d,e){a.push(f.get("repo_id"))},this);var b=this.getFormField("remove_data").getValue();this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"delete",params:{repo_id_list:a,remove_repo_data:b},callback:function(f,d,e){this.clearStatusBusy();if(!f){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(d.code));return}if(this.callbacks&&this.callbacks.apply){this.callbacks.apply.call(this.callbacks.scope||window,d,e)}this.close()},scope:this})},getRepoListString:function(f,d,b){var a="";var c="";var e="";c=Ext.util.Format.htmlEncode(f.join(", "));if(0<d.length){if(b){e='<span class="red-status">'+Ext.util.Format.htmlEncode(d.join(", "))+"</span>"}else{e=Ext.util.Format.htmlEncode(d.join(", "))}}if(0<c.length&&0<e.length){a=e+", "+c}else{if(0<c.length){a=c}else{if(0<e.length){a=e}}}return a}});Ext.define("SYNO.SDS.Backup.TargetDeleteCheck",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){var b=Ext.apply({title:_T("common","delete"),width:460,height:250,layout:"fit",items:[{xtype:"syno_formpanel",trackResetOnLoad:true,itemId:"form_panel",items:[{xtype:"syno_displayfield",name:"desc",value:_T("common","remove_cfrmrmv")},{xtype:"syno_displayfield",itemId:"delete_warn",value:String.format('<span class="red-status">{0}</span>',_T("backup","target_delete_warn")),indent:1}]}],buttons:[{xtype:"syno_button",itemId:"btn_apply",btnStyle:"red",text:_T("common","delete"),scope:this,handler:this.onDelete},{xtype:"syno_button",text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},a);return this.callParent([b])},onDelete:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Target",version:1,method:"delete",params:{repo_id:this.repoId,target_id:this.targetId},callback:function(c,a,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}this.close()},scope:this})}});Ext.define("SYNO.SDS.Backup.S2SServicePanel",{extend:"SYNO.SDS.Utils.FormPanel",title:_T("s2s","s2s_wiz_tab_svc"),constructor:function(a){return this.callParent([Ext.apply({items:[this.configSettings(),this.configInfo()]},a)])},configSettings:function(a){return Ext.apply({xtype:"syno_fieldset",title:_T("s2s","s2s_wiz_tab_svc"),items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("s2s","s2s_wiz_lbl_enable_desc")},{xtype:"syno_checkbox",name:"s2sservice_enable",boxLabel:_T("s2s","s2s_wiz_lbl_svc_enable")}]},a)},configInfo:function(a){return Ext.apply({xtype:"syno_fieldset",title:_T("s2s","s2s_wiz_lbl_svcInfo_title"),items:[{xtype:"syno_displayfield",name:"server_status",fieldLabel:_T("s2s","s2s_wiz_lbl_svr_status")},{xtype:"syno_displayfield",name:"paired_ds_name",fieldLabel:_T("s2s","s2s_wiz_lbl_svr_pair")},{xtype:"syno_displayfield",hideLabel:true,hidden:true,value:String.format('<font class="red-status">{0}</font>',_T("s2s","s2s_warn_multisrc_upgrade"))},{xtype:"syno_displayfield",hideLabel:true,hidden:true,value:_T("s2s","s2s_wiz_lbl_reset_desc")},{xtype:"syno_button",text:_T("common","alt_reset"),handler:this.onResetS2SPair,scope:this}]},a)},onResetS2SPair:function(){console.log("onResetS2SPair")}});Ext.define("SYNO.SDS.Backup.ServerOptionPage",{extend:"SYNO.SDS.Utils.TabPanel",constructor:function(a){var b=[];Ext.copyTo(this,a,"appWin,jsConfig,owner");if(this._D("netbkp")==="yes"){b.push(new SYNO.SDS.Backup.NetBackupServiceFromPanel({itemId:"rsync_service",appWin:a.appWin,owner:this}));if(this._D("support_timebkp_server")==="yes"){b.push(new SYNO.SDS.Backup.TimeBackupServiceFormPanel({itemId:"tbkp_service",appWin:a.appWin,owner:this}))}}if(this._D("support_img_backupd")==="yes"){b.push(new SYNO.SDS.Backup.VersionBackupServiceFormPanel({itemId:"vbkp_service",appWin:a.appWin,owner:this}))}return this.callParent([Ext.apply({activeTab:0,applyDirtyOnly:true,loadDirtyOnly:true,items:b},a)])},getHelpParam:function(){switch(this.getActiveTab().itemId){case"rsync_service":return"BackupApp/netbkp_service.html";case"s2s_service":return"BackupApp/netbkp_sharesync.html";case"tbkp_service":return"BackupApp/netbkp_service.html";case"vbkp_service":return"BackupApp/netbkp_service.html";default:return"BackupApp/netbkp_service.html"}},onPageActivate:function(){this.loadAllForm()},onPageDeactivate:function(){var b=this.getAllForms(),a;for(a=0;a<b.length;a++){if(b[a].isDirty()){return false}}return true},getNetbkpServicePanel:function(){return this.getComponent("rsync_service")},getTimebkpServicePanel:function(){return this.getComponent("tbkp_service")},getVersionbkpServicePanel:function(){return this.getComponent("vbkp_service")}});Ext.define("SYNO.SDS.Backup.NetBackupServiceFromPanel",{extend:"SYNO.SDS.Utils.FormPanel",title:_T("tree","leaf_netbkp"),isLoadingData:false,constructor:function(b){var a=SYNO.SDS.BandwidthControl.SchedulePanelConfig(this,"NetworkBackup");this.callParent([Ext.apply({webapi:{api:"SYNO.Backup.Service.NetworkBackup",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_displayfield",value:_T("service","desc_backup_service"),name:"synorsync_desc"},{xtype:"syno_checkbox",boxLabel:_T("service","enable_backup_service"),name:"enable",scope:this,handler:function(d,c){this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.S2S.Server",version:1,method:"get",callback:function(i,f,g){var h=false;var e=false;if(this.owner.getTimebkpServicePanel()){e=this.owner.getTimebkpServicePanel().getForm().findField("enable").getValue()}this.owner.clearStatusBusy();if(i){h=f.enable}if(!c&&!this.isLoadingData&&(e||h)){this.owner.appWin.getMsgBox().confirm(this.title,_T("service","service_netbkp_warn_disable_deps"),function(j){if("yes"===j){if(this.owner.getTimebkpServicePanel()){this.owner.getTimebkpServicePanel().getForm().findField("enable").setValue(false)}}else{d.setValue(true)}},this)}},scope:this})}},{indent:1,xtype:"syno_numberfield",fieldLabel:_T("netbackup","netbkp_sshd_port"),maxlength:5,vtype:"port",name:"rsync_sshd_port",validator:function(c){if(SYNO.SDS.Utils.isReservedPort("ssh",c,c)){return _T("service","error_dl_port_in_used")}else{return true}}},{indent:1,xtype:"syno_checkbox",boxLabel:_T("service","enable_rsync_config"),name:"enable_custom_config",scope:this,handler:function(d,c){var e=("yes"===this._D("support_s2s")&&"yes"!==this._D("usbstation"));if(c&&!this.isLoadingData&&(e||this.owner.getTimebkpServicePanel())){this.owner.appWin.getMsgBox().confirm(this.title,_T("service","service_netbkp_warn_customized_rsync"),function(f){if("yes"===f){if(this.owner.getTimebkpServicePanel()){this.owner.getTimebkpServicePanel().getForm().findField("enable").setValue(false)}}else{d.setValue(false)}},this)}}},a]},b)]);this.mon(this,"afterlayout",function(){var c;c=new SYNO.ux.Utils.EnableCheckGroup(this.getForm(),"enable",["rsync_sshd_port","enable_custom_config","NetworkBackup_policy"])},this,{single:true})},processBandwidthParams:function(f,d){if("set"===f){var c;var e=true;var a={api:"SYNO.Backup.Service.NetworkBackup",method:"set",version:1};var b={api:"SYNO.Core.BandwidthControl.Protocol",method:"set",version:1};for(c=0;c<d.length;c++){if(true===SYNO.ux.Utils.checkApiConsistency(a,d[c])){if(false===d[c].params.enable){e=false}break}}for(c=0;c<d.length;c++){if(true===SYNO.ux.Utils.checkApiConsistency(b,d[c])){d[c].params=SYNO.SDS.BandwidthControl.reConstructApiKey("set","NetworkBackup",d[c].params);if(false===e){d[c].params.policy="disabled"}break}}this.NetBackupServiceChange=this.getForm().findField("enable").isDirty()}},processParams:function(b,a){this.processBandwidthParams(b,a);return this.callParent(arguments)},processBandwidthReturnData:function(d,c){var a={api:"SYNO.Core.BandwidthControl.Protocol",method:"get",version:1,protocol:"NetworkBackup"};for(var b=0;b<d.result.length;b++){if(true===SYNO.ux.Utils.checkApiConsistency(a,d.result[b])&&c.compound[b].protocol===a.protocol){d.result[b].data=SYNO.SDS.BandwidthControl.reConstructApiKey("get",a.protocol,d.result[b].data)}}},processReturnData:function(e,d,c){if(d.has_fail===true){var a;Ext.each(d.result,function(h,f,g){if(!h.success){a=h.error.code;return false}},this);var b=SYNO.SDS.Backup.GetErrorString(a);if(SYNO.SDS.Backup.ERR_SERVICCE_PORT_CONFLICT===a){this.getForm().findField("rsync_sshd_port").markInvalid(b)}this.appWin.getMsgBox().alert(_T("tree","leaf_backup"),b);this.owner.setStatusError({text:b});return}this.processBandwidthReturnData(d,c);this.isLoadingData=true;this.getForm().loadRecords(d.result,c.compound);this.isLoadingData=false;this.sendServiceEvent()},sendServiceEvent:function(){if(this.NetBackupServiceChange){SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.NetBkpService",!this.getForm().findField("enable").getValue())}},getScheduleForm:function(){return this.getForm()}});Ext.define("SYNO.SDS.Backup.TimeBackupServiceFormPanel",{extend:"SYNO.SDS.Utils.FormPanel",title:_T("timebkp","tbk_service_title"),constructor:function(a){return this.callParent([Ext.apply({webapi:{api:"SYNO.Backup.Service.TimeBackup",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("timebkp","tbk_service_desc")},{xtype:"syno_displayfield",hideLabel:true,value:'<span class="syno-ux-note">'+_T("common","note")+_T("common","colon")+" </span>"+_T("timebkp","tbk_service_note")},{xtype:"syno_checkbox",boxLabel:_T("timebkp","tbk_lbl_enable_service"),name:"enable",scope:this,handler:function(e,d){if(d){var c=this.owner.getNetbkpServicePanel().getForm().findField("enable").getValue();var b=this.owner.getNetbkpServicePanel().getForm().findField("enable_custom_config").getValue();if(!c){this.owner.appWin.getMsgBox().confirm(this.title,_T("timebkp","tbk_warn_netbkp_service_disabled"),function(f){if("yes"===f){this.owner.getNetbkpServicePanel().getForm().findField("enable").setValue(true)}else{e.setValue(false)}},this)}else{if(b){this.owner.appWin.getMsgBox().confirm(this.title,_T("timebkp","tbk_warn_netbkp_switch_mode"),function(f){if("yes"===f){this.owner.getNetbkpServicePanel().getForm().findField("enable_custom_config").setValue(false)}else{e.setValue(false)}},this)}}}}}]},a)])}});Ext.define("SYNO.SDS.Backup.VersionBackupServiceFormPanel",{extend:"SYNO.SDS.Utils.FormPanel",title:_T("backup","versionbkp_service_title"),constructor:function(a){return this.callParent([Ext.apply({webapi:{api:"SYNO.Backup.Service.VersionBackup",methods:{get:"get",set:"set"},version:1},items:[{xtype:"syno_displayfield",hideLabel:true,value:_T("backup","versionbkp_service_desc")},{xtype:"syno_checkbox",boxLabel:_T("backup","versionbkp_lbl_enable_service"),name:"enable",scope:this}]},a)])},processParams:function(b,a){if("set"===b){this.VersionBackupServiceChange=this.getForm().findField("enable").isDirty()}return this.callParent(arguments)},processReturnData:function(c,b,a){this.callParent(arguments);this.sendServiceEvent()},sendServiceEvent:function(){if(this.VersionBackupServiceChange){SYNO.SDS.StatusNotifier.setServiceDisabled("SYNO.SDS.AdminCenter.VersionBkpService",!this.getForm().findField("enable").getValue())}}});Ext.ns("SYNO.SDS.S2S");SYNO.SDS.S2S.JobPollingIntervalSec=3;SYNO.SDS.S2S.BKPSET_MAX_LEN=32;SYNO.SDS.S2S.STATUS_SYNCING="syncing";SYNO.SDS.S2S.STATUS_IDLE="idle";SYNO.SDS.S2S.STATUS_WAITING="waiting";SYNO.SDS.S2S.LAST_RESULT_SUCC="succeed";SYNO.SDS.S2S.LAST_RESULT_ERR="error";SYNO.SDS.S2S.LAST_RESULT_CANCEL="cancel";SYNO.SDS.S2S.LAST_RESULT_PARTIAL="partial";SYNO.SDS.S2S.LAST_RESULT_NA="NA";SYNO.SDS.S2S.SCHD_REALTIME="realtime";SYNO.SDS.S2S.SCHD_MANUAL="manual";SYNO.SDS.S2S.SCHD_ADVANCE="advance";SYNO.SDS.S2S.SCHE_DAILY="daily";SYNO.SDS.S2S.SCHE_WEEKLY="weekly";SYNO.SDS.S2S.SCHE_MONTHLY="monthly";SYNO.SDS.S2S.SCHE_YEARLY="yearly";SYNO.SDS.S2S.SCHE_ONCE="once";SYNO.SDS.S2S.FIELD_ID="id";SYNO.SDS.S2S.FIELD_SHARE="sync_shares";SYNO.SDS.S2S.FIELD_SERVER="additional.server";SYNO.SDS.S2S.FIELD_STATUS="additional.status";SYNO.SDS.S2S.FIELD_RESULT="additional.last_sync_result";SYNO.SDS.S2S.FIELD_SCHD="additional.schedule";SYNO.SDS.S2S.RADIO_BY_WEEK="by_week";SYNO.SDS.S2S.RADIO_BY_DATE="by_date";SYNO.SDS.S2S.WEEK_ALL="1111111";SYNO.SDS.S2S.WEEK_END="1000001";SYNO.SDS.S2S.WEEK_NORMAL="0111110";SYNO.SDS.S2S.ACTION_EDIT="edit";SYNO.SDS.S2S.ACTION_DELETE="delete";SYNO.SDS.S2S.ACTION_CANCEL="cancel";SYNO.SDS.S2S.ACTION_SYNC_NOW="sync_now";SYNO.SDS.S2S.ACTION_SYNC_FULL="sync_full";SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_TYPE=401;SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_VALUE=402;SYNO.SDS.S2S.ERRCODE_NO_MEM=403;SYNO.SDS.S2S.ERRCODE_ALLOC_MEM=404;SYNO.SDS.S2S.ERRCODE_NO_SUCH_SHARE=405;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GENERIC=500;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_ENUM_JOB=501;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GET_JOB=502;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_SET_JOB=503;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_DEL_JOB=504;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_START_JOB=505;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_STOP_JOB=506;SYNO.SDS.S2S.ERRCODE_NO_SUCH_TASK=507;SYNO.SDS.S2S.ERRCODE_DUPLICATED_JOB_ID=508;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_UPDATE_FAKE_FILE=509;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_TEST_CONN=510;SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_PAIR=511;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GENERIC=600;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_STATUS=601;SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ALIVE=602;SYNO.SDS.S2S.ERRCODE_CUSTOMIZED_RSYNC_ENABLED=603;SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ENABLED=604;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_NETBKP_SETTING=605;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_NO_NETBKP_VOLUME=606;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_VOLUME_PATH=607;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_REGISTER_SERVICE=608;SYNO.SDS.S2S.ERRCODE_SERVER_ERR_UNREGISTER_SERVICE=609;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GENERIC=700;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_CONFIG_FILE=701;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_STATUS=702;SYNO.SDS.S2S.ERRCODE_NO_CONFIG=703;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_OPEN_SEMAPHORE=704;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_CONFIG=705;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_CONFIG=706;SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY=707;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_ADD_SECTION=708;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_SECTION=709;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_SECTION=710;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_HASH_VALUE=711;SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_HASH_VALUE=712;SYNO.SDS.S2S.ERRCODE_SHARE_LOCK=3328;SYNO.SDS.S2S.ScheduleDateToString=function(e){var d="";var c=e.week_day;d+=_T("schedule","schedule_date")+": ";switch(e.mode){case SYNO.SDS.S2S.SCHE_DAILY:case SYNO.SDS.S2S.SCHE_WEEKLY:switch(c){case SYNO.SDS.S2S.WEEK_ALL:d+=_T("schedule","schedule_daily");break;case SYNO.SDS.S2S.WEEK_END:d+=_T("schedule","schedule_weekend");break;case SYNO.SDS.S2S.WEEK_NORMAL:d+=_T("schedule","schedule_weekdays");break;default:var b=SYNO.SDS.S2S.ScheduleWeekDayToBackupFormat(c);d+=SYNO.SDS.Backup.GenWeekString(b)}break;default:var a=new Date(e.start_year,e.start_month-1,e.start_day);d+=a.format("Y/m/d");d+=" ";switch(e.mode){case SYNO.SDS.S2S.SCHE_MONTHLY:d+=_T("schedule","repeat_monthly");break;case SYNO.SDS.S2S.SCHE_YEARLY:d+=_T("schedule","repeat_yearly");break;case SYNO.SDS.S2S.SCHE_ONCE:d+=_T("schedule","no_repeat");break;default:d+=_T("schedule","schedule_unknown")}}return d};SYNO.SDS.S2S.ScheduleWeekDayToBackupFormat=function(c){var a=0;var b=[];for(a=0;a<7;a++){if(c.charAt(a)==="1"){b.push(a.toString())}}return b.join(",")};SYNO.SDS.S2S.ScheduleTimeToString=function(e){var d="";var a=(e.repeat_hour*60+e.repeat_min)*e.repeat_in_day;var c=e.first_hour+Math.floor((e.first_min+a)/60);var b=(e.first_min+a)%60;d+=_T("schedule","schedule_time")+": ";if(0===a){d+=String.leftPad(String(e.first_hour),2,"0")+":"+String.leftPad(String(e.first_min),2,"0")}else{d+=String.leftPad(String(e.first_hour),2,"0")+":"+String.leftPad(String(e.first_min),2,"0")+" ~ "+String.leftPad(String(c),2,"0")+":"+String.leftPad(String(b),2,"0");d+=" ";if(0===e.repeat_hour){d+=String.format(_T("s2s","s2s_lbl_sched_every_min"),e.repeat_min)}else{d+=String.format(_T("s2s","s2s_lbl_sched_mode_every"),e.repeat_hour)}}return d};SYNO.SDS.S2S.handleWebApiData=function(a,d,g,c){var f=false;var e=[];if(!Ext.isObject(d)||!Ext.isFunction(g)){return false}if(Ext.isArray(a)){e=a}else{e.push(a)}for(var b=0;b<e.length;b++){if(!SYNO.ux.Utils.checkApiConsistency(d,e[b])){continue}f=true;if(!g.call(c||this,e[b],b)){break}}if(!f){g.call(c||this,null,-1)}return true};SYNO.SDS.S2S.GetFakePswd=function(){var a;var b="";for(a=0;a<8;a++){b+=String.fromCharCode(65283)}return b};SYNO.SDS.S2S.TestConnection=function(a,c,d,b){a.setStatusBusy({text:_T("netbackup","netbkp_connection_testing")});a.sendWebAPI({api:"SYNO.S2S.Client.Job",version:1,method:"test_connection",params:c,callback:function(h,g,f,e){this.clearStatusBusy();d.call(b||this,h,g,f,e)},scope:a})};SYNO.SDS.S2S.TestConnectionCallBack=function(d,c,b,a){if(d){this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("netbackup","netbkp_connection_testing_success"))}else{this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:c},_T("netbackup","netbkp_connection_testing_fail")))}};SYNO.SDS.S2S.GetWebAPIErrorString=function(a,b){if(!a||!a.error){return b?b:_T("common","error_system")}if(a.error.errors){return _T(a.error.errors.sec,a.error.errors.key)}switch(a.error.code){case SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_TYPE:return _T("s2s","err_invalid_param_type");case SYNO.SDS.S2S.ERRCODE_INVALID_PARAM_VALUE:return _T("s2s","err_invalid_param_value");case SYNO.SDS.S2S.ERRCODE_NO_MEM:return _T("s2s","err_no_mem");case SYNO.SDS.S2S.ERRCODE_ALLOC_MEM:return _T("s2s","err_alloc_mem");case SYNO.SDS.S2S.ERRCODE_NO_SUCH_SHARE:return _T("s2s","s2s_warn_no_share");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GENERIC:return _T("s2s","err_client_job_generic");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_ENUM_JOB:return _T("s2s","err_client_job_enum_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_GET_JOB:return _T("s2s","err_client_job_get_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_SET_JOB:return _T("s2s","err_client_job_set_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_DEL_JOB:return _T("s2s","err_client_job_del_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_START_JOB:return _T("s2s","err_client_job_start_job");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_STOP_JOB:return _T("s2s","err_client_job_stop_job");case SYNO.SDS.S2S.ERRCODE_NO_SUCH_TASK:return _T("s2s","err_no_task");case SYNO.SDS.S2S.ERRCODE_DUPLICATED_JOB_ID:return _T("s2s","s2s_warn_duplicate_taskname");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_UPDATE_FAKE_FILE:return _T("s2s","err_client_job_update_fake_file");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_TEST_CONN:return _T("netbackup","netbkp_connection_testing_fail");case SYNO.SDS.S2S.ERRCODE_CLIENT_JOB_ERR_PAIR:return _T("s2s","err_client_job_pair");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GENERIC:return _T("s2s","err_server_generic");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_STATUS:return _T("s2s","err_server_get_status");case SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ALIVE:return String.format(_T("s2s","s2s_warn_should_start_bkp_service"),_T("s2s","s2s_app_title"),_T("netbackup","netbkp_main_subject"),_T("netbackup","netbkp_main_subject"));case SYNO.SDS.S2S.ERRCODE_CUSTOMIZED_RSYNC_ENABLED:return String.format(_T("s2s","s2s_warn_should_start_synorsync_server"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ENABLED:return String.format(_T("s2s","s2s_warn_should_start_bkp_service"),_T("s2s","s2s_app_title"),_T("netbackup","netbkp_main_subject"),_T("netbackup","netbkp_main_subject"));case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_NETBKP_SETTING:return _T("s2s","err_server_get_netbkp_setting");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_NO_NETBKP_VOLUME:return _T("share","error_volume_not_found");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_GET_VOLUME_PATH:return _T("s2s","err_server_get_volume_path");case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_REGISTER_SERVICE:return String.format(_T("s2s","err_server_register_service"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_SERVER_ERR_UNREGISTER_SERVICE:return String.format(_T("s2s","err_server_unregister_service"),_T("s2s","s2s_app_title"));case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GENERIC:return _T("s2s","err_pair_generic");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_CONFIG_FILE:return _T("s2s","err_pair_config_file");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_STATUS:return _T("s2s","err_pair_get_status");case SYNO.SDS.S2S.ERRCODE_NO_CONFIG:return _T("s2s","err_pair_no_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_OPEN_SEMAPHORE:return _T("s2s","err_pair_get_open_semaphore");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_CONFIG:return _T("s2s","err_pair_get_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_CONFIG:return _T("s2s","err_pair_set_config");case SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY:return _T("s2s","err_pair_empty_config");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_ADD_SECTION:return _T("s2s","err_pair_add_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_SECTION:return _T("s2s","err_pair_get_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_SECTION:return _T("s2s","err_pair_set_section");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_GET_HASH_VALUE:return _T("s2s","err_pair_get_hash_value");case SYNO.SDS.S2S.ERRCODE_PAIR_ERR_SET_HASH_VALUE:return _T("s2s","err_pair_set_hash_value");case SYNO.SDS.S2S.ERRCODE_SHARE_LOCK:return _T("s2s","err_share_action");case undefined:return b?b:_T("common","error_system");default:return b?b:_T("error","error_error_system")}};SYNO.SDS.S2S.SyncShareRenderer=function(b,c,a){if(null!==c){c.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b.join(","))+'"'}return b};SYNO.SDS.S2S.DestinationRenderer=function(c,b,a){return c.name};SYNO.SDS.S2S.CurStatusRenderer=function(b,c,a){switch(b){case SYNO.SDS.S2S.STATUS_SYNCING:return _T("s2s","s2s_lbl_status_sync");case SYNO.SDS.S2S.STATUS_WAITING:return _T("s2s","s2s_lbl_status_waiting");default:return _T("s2s","s2s_lbl_status_idle")}};SYNO.SDS.S2S.LastResultRenderer=function(c,d,b){var a;switch(c){case SYNO.SDS.S2S.LAST_RESULT_SUCC:a=_T("usbbackup","usbbkp_succeed");break;case SYNO.SDS.S2S.LAST_RESULT_ERR:a='<span class="red-status">'+_T("s2s","task_status_error")+"</span>";break;case SYNO.SDS.S2S.LAST_RESULT_PARTIAL:a='<span class="orange-status">'+_T("error","error_system_abnormal_warning")+"</span>";break;case SYNO.SDS.S2S.LAST_RESULT_CANCEL:a=_T("common","alt_cancel");break;default:a=_T("status","status_not_available");break}return a};SYNO.SDS.S2S.ScheduleRenderer=function(d,c,a){switch(d.mode){case SYNO.SDS.S2S.SCHD_REALTIME:return _T("s2s","s2s_lbl_sched_realtime");case SYNO.SDS.S2S.SCHD_MANUAL:return _T("s2s","s2s_lbl_sched_mode_man");default:var b=SYNO.SDS.S2S.ScheduleDateToString(d);b+="<br />";b+=SYNO.SDS.S2S.ScheduleTimeToString(d);if(null!==c){c.attr='ext:qtip="'+Ext.util.Format.htmlEncode(b)+'"'}return _T("schedule","schedule_advance")}};SYNO.SDS.S2S.GenGetJobParams=function(a){return{api:"SYNO.S2S.Client.Job",version:1,method:"get",params:{id:a,additional:["schedule","server","use_block","use_compression","use_ssh","ssh_port","user"]}}};SYNO.SDS.S2S.GenListJobParams=function(a){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"list"},a)};SYNO.SDS.S2S.GenGetShareParams=function(a){return Ext.apply({api:"SYNO.Core.Share",version:1,method:"list",params:{shareType:["local","enc","dec"]}},a)};SYNO.SDS.S2S.GenRunActionParamsByAction=function(c,a){var b={api:"SYNO.S2S.Client.Job",params:{id:a}};switch(c){case SYNO.SDS.S2S.ACTION_SYNC_NOW:b.version=1;b.method="start";b.params.sync_mode="normal";break;case SYNO.SDS.S2S.ACTION_SYNC_FULL:b.version=1;b.method="start";b.params.sync_mode="full_sync";break;case SYNO.SDS.S2S.ACTION_DELETE:b.version=1;b.method="delete";break;case SYNO.SDS.S2S.ACTION_CANCEL:b.version=1;b.method="stop";break;default:SYNO.Debug("SYNO.SDS.S2S.S2SaskPage: unknown action ["+c+"]");return}return b};SYNO.SDS.S2S.GenGetNetworkParams=function(a){return Ext.apply({api:"SYNO.Core.System",version:1,method:"info",params:{type:"network"}},a)};SYNO.SDS.S2S.GenCreateJobParams=function(a){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"create"},a)};SYNO.SDS.S2S.GenSetJobParams=function(a){return Ext.apply({api:"SYNO.S2S.Client.Job",version:1,method:"set"},a)};SYNO.SDS.S2S.GenListServerParams=function(a){return Ext.apply({api:"SYNO.S2S.Client",version:1,method:"list_server",params:{sort_by:"name"}},a)};SYNO.SDS.S2S.GenGetServerParams=function(a){return Ext.apply({api:"SYNO.S2S.Server",version:1,method:"get"},a)};SYNO.SDS.S2S.GenGetNetBkpParams=function(a){return Ext.apply({api:"SYNO.Backup.Service.NetworkBackup",version:1,method:"get"},a)};SYNO.SDS.S2S.GenSetNetBkpParams=function(a){return Ext.apply({api:"SYNO.Backup.Service.NetworkBackup",version:1,method:"set"},a)};SYNO.SDS.S2S.GenListPairParams=function(a){return Ext.apply({api:"SYNO.S2S.Server.Pair",version:1,method:"list",params:{additional:["sync_shares"]}},a)};SYNO.SDS.S2S.GenDelPairParams=function(a){return Ext.apply({api:"SYNO.S2S.Server.Pair",version:1,method:"delete"},a)};SYNO.SDS.S2S.GenSetServerParams=function(a){return Ext.apply({api:"SYNO.S2S.Server",version:1,method:"set"},a)};Ext.define("SYNO.SDS.S2S.S2STaskPage",{extend:"SYNO.ux.TabPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a])},getHelpParam:function(){return"BackupApp/sharedfoldersync.html"},fillConfig:function(a){this.owner=a.appWin;var b=[new SYNO.SDS.S2S.JobGrid({title:_T("s2s","tab_client"),owner:a.appWin})];if("yes"===this._D("netbkp")&&"yes"===this._D("support_s2s")&&"yes"!==this._D("usbstation")){b.push(new SYNO.SDS.S2S.ServerPanel({title:_T("s2s","tab_server"),owner:a.appWin}))}return Ext.apply({border:false,activeTab:0,title:_T("s2s","s2s_app_title"),items:b},a)},onPageActivate:function(){if(Ext.isFunction(this.activeTab.onPageActivate)){return this.activeTab.onPageActivate()}else{return true}},onPageDeactivate:function(){if(Ext.isFunction(this.activeTab.onPageDeactivate)){return this.activeTab.onPageDeactivate()}else{return true}}});Ext.define("SYNO.SDS.S2S.JobGrid",{extend:"SYNO.ux.GridPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.mon(this.getSelectionModel(),"rowselect",function(d,c,e){this.updateButtonStatus(d.getSelections())},this);this.mon(this.getSelectionModel(),"rowdeselect",function(d,c){this.updateButtonStatus(d.getSelections())},this);this.mon(this,"activate",function(c,d){this.applyActionAndReload(null);this.startPollStatus(false)},this);this.mon(this,"deactivate",function(c,d){this.stopPollStatus()},this)},fillConfig:function(a){var b=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:SYNO.SDS.S2S.FIELD_ID,root:"",fields:[{name:SYNO.SDS.S2S.FIELD_ID},{name:SYNO.SDS.S2S.FIELD_SHARE},{name:SYNO.SDS.S2S.FIELD_SERVER,sortType:function(c){return c.name}},{name:SYNO.SDS.S2S.FIELD_STATUS},{name:SYNO.SDS.S2S.FIELD_RESULT},{name:SYNO.SDS.S2S.FIELD_SCHD,sortType:function(c){switch(c.mode){case SYNO.SDS.S2S.SCHD_REALTIME:return _T("s2s","s2s_lbl_sched_realtime");case SYNO.SDS.S2S.SCHD_MANUAL:return _T("s2s","s2s_lbl_sched_mode_man");default:return _T("schedule","schedule_advance")}}}]})});this.addManagedComponent(b);return Ext.apply({store:b,cm:this.getColModel(),tbar:this.getToolbar(),selModel:new Ext.grid.RowSelectionModel({singleSelect:false})},a)},startPollStatus:function(a){if(this.pollStatus){return}this.pollStatus=this.pollReg({immediate:a,interval:SYNO.SDS.S2S.JobPollingIntervalSec,webapi:SYNO.SDS.S2S.GenListJobParams({params:{additional:["last_sync_result","server","schedule","status"]}}),status_callback:this.afterRequestJobs,scope:this})},stopPollStatus:function(){if(this.pollStatus){this.pollUnreg(this.pollStatus);this.pollStatus=null}},getColModel:function(){if(this.cm){return this.cm}this.cm=new Ext.grid.ColumnModel({defaults:{sortable:true,menuDisabled:true,align:"center"},columns:[{width:0.15,header:_T("s2s","col_task_name"),dataIndex:SYNO.SDS.S2S.FIELD_ID},{width:0.15,header:_T("s2s","s2s_lbl_src_share"),dataIndex:SYNO.SDS.S2S.FIELD_SHARE,renderer:SYNO.SDS.S2S.SyncShareRenderer},{width:0.15,header:_T("s2s","col_task_destination"),dataIndex:SYNO.SDS.S2S.FIELD_SERVER,renderer:SYNO.SDS.S2S.DestinationRenderer},{width:0.1,header:_T("s2s","col_task_status"),dataIndex:SYNO.SDS.S2S.FIELD_STATUS,renderer:SYNO.SDS.S2S.CurStatusRenderer},{width:0.15,header:_T("s2s","s2s_lbl_lastSync_result"),dataIndex:SYNO.SDS.S2S.FIELD_RESULT,renderer:SYNO.SDS.S2S.LastResultRenderer},{width:0.1,header:_T("s2s","s2s_lbl_sched_mode"),dataIndex:SYNO.SDS.S2S.FIELD_SCHD,renderer:SYNO.SDS.S2S.ScheduleRenderer}]});return this.cm},getToolbar:function(){if(this.toolbar){return this.toolbar}var a=function(b){return Ext.apply({xtype:"syno_button",disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""},b)};this.toolbar=new Ext.Toolbar({style:{background:"none"},items:[a({text:_T("common","create"),handler:this.onCreateJob,scope:this}),a({id:this.editBtnId=Ext.id(),disabled:true,text:_T("common","alt_edit"),handler:this.onEditJob,scope:this}),a({id:this.deleteBtnId=Ext.id(),disabled:true,text:_T("common","delete"),handler:function(b,c){this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("common","remove_cfrmrmv"),function(d){if(d==="yes"){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_DELETE)}},this)},scope:this}),a({id:this.cancelBtnId=Ext.id(),disabled:true,text:_T("netbackup","netbkp_cancel"),handler:function(b,c){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_CANCEL)},scope:this}),a({id:this.syncNowBtnId=Ext.id(),disabled:true,text:_T("s2s","s2s_btn_sync_imm"),handler:function(b,c){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_SYNC_NOW)},scope:this}),a({id:this.syncFullBtnId=Ext.id(),disabled:true,text:_T("s2s","s2s_btn_full_sync"),handler:function(b,c){this.applyActionAndReload(SYNO.SDS.S2S.ACTION_SYNC_FULL)},scope:this})]});return this.toolbar},onPageActivate:function(){this.startPollStatus(true);return true},onPageDeactivate:function(){this.stopPollStatus();return true},onCreateJob:function(b,f){var d=this.getStore().getCount();var a=this._D("s2s_task_max","2");a=parseInt(a,10);if(d>=a){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_reach_maxtask"))}else{this.stopPollStatus();var c=new SYNO.SDS.S2S.NewJobWizard({owner:this.owner});this.mon(c,"close",function(e){this.applyActionAndReload();this.startPollStatus(false)},this);c.open()}},onEditJob:function(b,c){var d=this.getSelectionModel().getSelected();if(!d){return}this.stopPollStatus();var a=new SYNO.SDS.S2S.ConfigDialog({owner:this.owner,jobId:d.get(SYNO.SDS.S2S.FIELD_ID)});this.mon(a,"close",function(e){this.applyActionAndReload();this.startPollStatus(false)},this);a.open()},afterRequestJobs:function(j,c,d,a){if(!j||!c||!Ext.isArray(c.jobs)){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.afterRequestJobs: get job list fail");c={jobs:[]}}this.owner.clearStatusBusy();var e=c.jobs.length;var h=this.getStore();var g=false;if(h.getTotalCount()!==e){g=true}else{for(var f=0;e>f;f++){var b=h.getById(c.jobs[f][SYNO.SDS.S2S.FIELD_ID]);if(!b){g=true;break}else{b.set(SYNO.SDS.S2S.FIELD_SHARE,c.jobs[f].sync_shares);b.set(SYNO.SDS.S2S.FIELD_SERVER,c.jobs[f].additional.server);b.set(SYNO.SDS.S2S.FIELD_STATUS,c.jobs[f].additional.status);b.set(SYNO.SDS.S2S.FIELD_RESULT,c.jobs[f].additional.last_sync_result);b.set(SYNO.SDS.S2S.FIELD_SCHD,c.jobs[f].additional.schedule)}}}if(g){h.loadData(c.jobs,false)}else{h.commitChanges()}this.updateButtonStatus(this.getSelectionModel().getSelections())},updateButtonStatus:function(g){if(_S("demo_mode")||!g){return}var c=true;var f=true;var e=true;var h=true;var a=true;if(1===g.length){if(this.isJobCan(SYNO.SDS.S2S.ACTION_EDIT,g[0].get(SYNO.SDS.S2S.FIELD_STATUS))){c=false}}for(var d=0;g.length>d;d++){var j=g[d].get(SYNO.SDS.S2S.FIELD_STATUS);if(this.isJobCan(SYNO.SDS.S2S.ACTION_DELETE,j)){f=false}if(this.isJobCan(SYNO.SDS.S2S.ACTION_CANCEL,j)){e=false}if(this.isJobCan(SYNO.SDS.S2S.ACTION_SYNC_NOW,j)){var b=g[d].get(SYNO.SDS.S2S.FIELD_SCHD).mode;if(SYNO.SDS.S2S.SCHD_REALTIME!==b){h=false}}if(this.isJobCan(SYNO.SDS.S2S.ACTION_SYNC_FULL,j)){a=false}}Ext.getCmp(this.editBtnId).setDisabled(c);Ext.getCmp(this.deleteBtnId).setDisabled(f);Ext.getCmp(this.cancelBtnId).setDisabled(e);Ext.getCmp(this.syncNowBtnId).setDisabled(h);Ext.getCmp(this.syncFullBtnId).setDisabled(a)},isJobCan:function(a,b){switch(a){case SYNO.SDS.S2S.ACTION_EDIT:case SYNO.SDS.S2S.ACTION_SYNC_NOW:case SYNO.SDS.S2S.ACTION_SYNC_FULL:case SYNO.SDS.S2S.ACTION_DELETE:return(b!==SYNO.SDS.S2S.STATUS_SYNCING);case SYNO.SDS.S2S.ACTION_CANCEL:return(b===SYNO.SDS.S2S.STATUS_SYNCING);default:return false}},applyActionAndReload:function(f){var d;var b=SYNO.SDS.S2S.GenListJobParams({params:{additional:["last_sync_result","server","schedule","status"]}});var a=[b];if(f){var e=this.getSelectionModel().getSelections();var c=this.getValidJobIdsByAction(f,e);d=SYNO.SDS.S2S.GenRunActionParamsByAction(f,c);if(d){a.unshift(d)}}this.owner.setStatusBusy();this.stopPollStatus();this.sendWebAPI({compound:{stopwhenerror:false,params:a},callback:function(j,i,h,g){this.owner.clearStatusBusy();this.startPollStatus(false);if(!j||!i){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: sendWebAPI fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));return}SYNO.SDS.S2S.handleWebApiData(i.result,d,function(l,k){if(!l){return}if(!l.success){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: command "+l.method+" fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString(l))}},this);SYNO.SDS.S2S.handleWebApiData(i.result,b,function(l,k){if(!l){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyActionAndReload: no list job result");return}this.afterRequestJobs(l.success,l.data)},this)},scope:this})},getValidJobIdsByAction:function(e,d){var b=[];if(d){loop_label:for(var a=0;d.length>a;a++){var c=d[a].get(SYNO.SDS.S2S.FIELD_STATUS);var f=d[a].get(SYNO.SDS.S2S.FIELD_SCHD).mode;switch(e){case SYNO.SDS.S2S.ACTION_SYNC_NOW:if((SYNO.SDS.S2S.STATUS_IDLE!==c)||(SYNO.SDS.S2S.SCHD_REALTIME===f)){continue}break;case SYNO.SDS.S2S.ACTION_SYNC_FULL:case SYNO.SDS.S2S.ACTION_DELETE:if(SYNO.SDS.S2S.STATUS_IDLE!==c){continue}break;case SYNO.SDS.S2S.ACTION_CANCEL:if(SYNO.SDS.S2S.STATUS_SYNCING!==c){continue}break;default:SYNO.Debug("SYNO.SDS.S2S.S2SaskPage: unknown btn pressed");break loop_label}b.push(d[a].get(SYNO.SDS.S2S.FIELD_ID))}}return b}});Ext.define("SYNO.SDS.S2S.ServerPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){this.isNetBkpEnable=false;this.isCustomNetBkpEnable=false;var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"activate",function(c,d){this.requestServerInfo()},this)},fillConfig:function(a){return Ext.apply({buttons:[{xtype:"syno_button",text:_T("common","commit"),disabled:_S("demo_mode"),btnStyle:"blue",handler:this.applyHandler,scope:this},{xtype:"syno_button",text:_T("common","reset"),handler:this.cancelHandler,scope:this}],items:[{xtype:"syno_fieldset",title:_T("s2s","s2s_wiz_tab_svc"),items:[{xtype:"syno_displayfield",value:_T("s2s","s2s_wiz_lbl_enable_desc")},{xtype:"syno_checkbox",id:this.enableServiceId=Ext.id(),boxLabel:_T("s2s","s2s_wiz_lbl_svc_enable"),handler:Ext.createDelegate(this.requestNetBkpStatus,this)}]},{xtype:"syno_fieldset",title:_T("s2s","s2s_wiz_lbl_svcInfo_title"),items:[{xtype:"syno_compositefield",border:false,hideLabel:true,items:[{xtype:"syno_displayfield",width:230,value:_T("s2s","s2s_wiz_lbl_svr_status")+":"},{xtype:"syno_displayfield",id:this.statusId=Ext.id(),value:this.getServerStatusString(SYNO.SDS.S2S.STATUS_UNKNOWN)}]},{xtype:"syno_compositefield",border:false,hideLabel:true,items:[{xtype:"syno_displayfield",id:this.pairLstLabelId=Ext.id(),hidden:true,width:230,value:_T("s2s","s2s_wiz_lbl_svr_pair")+":"},{xtype:"syno_displayfield",id:this.pairLstId=Ext.id(),hidden:true}]},{xtype:"syno_displayfield",id:this.upgradeDescId=Ext.id(),hidden:true,value:'<span class="red-status">'+_T("s2s","s2s_warn_multisrc_upgrade")+"</span>"},{xtype:"syno_displayfield",id:this.resetDescId=Ext.id(),hidden:true,value:_T("s2s","s2s_wiz_lbl_reset_desc")},{xtype:"syno_button",id:this.resetBtnId=Ext.id(),hidden:true,name:"resetS2Sbtn",text:_T("s2s","s2s_btn_cancel_sharepair"),handler:this.resetPairHandler,scope:this}]}]},a)},requestServerInfo:function(c){var a=SYNO.SDS.S2S.GenListPairParams();var b=SYNO.SDS.S2S.GenGetServerParams();this.owner.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:false,params:[a,b]},callback:function(h,g,f,e){var d={clients:[],enable:false,status:SYNO.SDS.S2S.STATUS_UNKNOWN,isMultiClient:true};this.owner.clearStatusBusy();if(!h||!g){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: sendWebAPI fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));return}SYNO.SDS.S2S.handleWebApiData(g.result,a,function(j,i){if(!j||!j.data){if(!j.error||j.error.code!==SYNO.SDS.S2S.ERRCODE_NO_CONFIG||j.error.code!==SYNO.SDS.S2S.ERRCODE_CONFIG_EMPTY){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: get clients fail")}return}d.clients=j.data.clients},this);SYNO.SDS.S2S.handleWebApiData(g.result,b,function(j,i){if(!j||!j.data){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestServerInfo: get server config fail");return}d.enable=j.data.enable;d.status=j.data.status;d.isMultiClient=j.data.is_multi_client},this);this.setValues(d);this.doLayout()},scope:this})},requestNetBkpStatus:function(b,a){if(!a){return}this.owner.setStatusBusy();this.sendWebAPI(SYNO.SDS.S2S.GenGetNetBkpParams({callback:function(f,e,d,c){this.owner.clearStatusBusy();if(!f||!e){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.requestNetBkpStatus: getNetBkpWebAPI fail");return}this.isNetBkpEnable=e.enable;this.isCustomNetBkpEnable=e.enable_custom_config},scope:this}))},getServerStatusString:function(a){switch(a){case SYNO.SDS.S2S.STATUS_SYNCING:return'<span class="green-status">'+_T("s2s","s2s_lbl_status_sync")+"</span>";case SYNO.SDS.S2S.STATUS_IDLE:return'<span class="green-status">'+_T("s2s","s2s_lbl_status_idle")+"</span>";default:return'<span class="red-status">'+_T("s2s","server_status_unknown")+"</span>"}},setValues:function(b){if(!b){SYNO.Debug("SYNO.SDS.S2S.ServerPanel.setValues");return}var a=this.getServerStatusString(b.status);this.getForm().setValues([{id:this.enableServiceId,value:b.enable},{id:this.statusId,value:a},{id:this.pairLstId,value:Ext.util.Format.ellipsis(Ext.pluck(b.clients,"name").join(", "),50)}]);Ext.getCmp(this.resetBtnId).setVisible(b.enable);Ext.getCmp(this.pairLstLabelId).setVisible(b.enable);Ext.getCmp(this.pairLstId).setVisible(b.enable);this.isMultiClient=b.isMultiClient;if(b.enable&&!b.isMultiClient){Ext.getCmp(this.resetDescId).setVisible(true);Ext.getCmp(this.upgradeDescId).setVisible(true)}else{Ext.getCmp(this.resetDescId).setVisible(false);Ext.getCmp(this.upgradeDescId).setVisible(false)}if(b.isMultiClient){Ext.getCmp(this.resetBtnId).setText(_T("s2s","s2s_btn_cancel_sharepair"))}else{Ext.getCmp(this.resetBtnId).setText(_T("common","alt_reset"))}},applyHandler:function(d,c){var a=Ext.getCmp(this.enableServiceId);var e=a.getValue();if(!a.isDirty()){this.setStatusError({text:_T("error","nochange_subject"),clear:true});return}if(!e||(this.isNetBkpEnable&&!this.isCustomNetBkpEnable)){this.applySetting(e,false)}else{var b=false;if(!this.isNetBkpEnable){b=String.format(_T("s2s","s2s_warn_should_start_bkp_service"),_T("s2s","s2s_app_title"),_T("netbackup","netbkp_main_subject"),_T("netbackup","netbkp_main_subject"))}else{b=String.format(_T("s2s","s2s_warn_should_start_synorsync_server"),_T("s2s","s2s_app_title"))}this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),b,function(f){if(f==="yes"){this.applySetting(true,true)}else{a.setValue(false)}},this)}},applySetting:function(f,a){var c=Ext.getCmp(this.enableServiceId);var e=SYNO.SDS.S2S.GenSetServerParams({params:{enable:f}});var b=SYNO.SDS.S2S.GenSetNetBkpParams({params:{enable:true,enable_custom_config:false}});var d=[e];if(a){d.unshift(b)}this.owner.setStatusBusy({text:_T("common","saving")});this.sendWebAPI({compound:{stopwhenerror:true,params:d},callback:function(l,k,j,i){this.owner.clearStatusBusy();if(!l||!k){c.setValue(false);this.setStatusError({text:_T("common","error_system"),clear:true})}else{if(k.has_fail){var h="";var g=0;SYNO.SDS.S2S.handleWebApiData(k.result,e,function(n,m){if(!n||!n.success){SYNO.Debug("SYNO.SDS.S2S.ServerPanel.applySetting: setServerWebAPI fail");h=SYNO.SDS.S2S.GetWebAPIErrorString(n);g=n.error.code;return}},this);SYNO.SDS.S2S.handleWebApiData(k.result,b,function(n,m){if(n&&n.error){SYNO.Debug("SYNO.SDS.S2S.ServerPanel.applySetting: setNetBkpWebAPI fail");h=SYNO.SDS.Backup.GetErrorString(n.error.code);return}},this);if(h){if(SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ALIVE===g||SYNO.SDS.S2S.ERRCODE_CUSTOMIZED_RSYNC_ENABLED===g||SYNO.SDS.S2S.ERRCODE_RSYNC_NOT_ENABLED===g){this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),h,function(m){if(m==="yes"){this.applySetting(true,true)}else{c.setValue(false)}},this)}else{c.setValue(false);this.setStatusError({text:h,clear:true})}}}else{this.setStatusOK();this.requestServerInfo()}}},scope:this})},cancelHandler:function(){this.getForm().reset()},resetPairHandler:function(){if(this.isMultiClient){var a=new SYNO.SDS.S2S.PairDialog({owner:this.owner});this.mon(a,"close",this.requestServerInfo,this);a.show()}else{this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_cfm_upgrade_reset"),function(b){if("yes"!==b){return}this.sendWebAPI(SYNO.SDS.S2S.GenDelPairParams({callback:function(f,e,d,c){if(f){this.requestServerInfo()}else{this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:e}))}},scope:this}))},this)}}});Ext.define("SYNO.SDS.S2S.PairDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){this.owner=b.owner;var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"afterlayout",function(c){this.setStatusBusy();this.sendWebAPI(SYNO.SDS.S2S.GenListPairParams({callback:this.afterRequestPairs,scope:this}))},this,{single:this})},fillConfig:function(a){return Ext.apply({width:500,height:320,padding:15,title:_T("s2s","s2s_dlg_pairinfo_title"),layout:{type:"fit"},items:[this.pairGrid=this.createGridPanel()],buttons:[{text:_T("common","close"),handler:function(){this.close()},scope:this}]},a)},createGridPanel:function(){return new SYNO.ux.GridPanel({border:false,store:this.createPairStore(),autoExpandColumn:"descr",columns:[{menuDisabled:true,sortable:false,width:200,header:_T("s2s","s2s_col_sharename"),dataIndex:"share"},{id:"descr",menuDisabled:true,sortable:false,width:150,header:_T("s2s","s2s_col_pairedclient"),dataIndex:"display",renderer:Ext.util.Format.htmlEncode}],tbar:{xtype:"toolbar",style:{background:"none"},items:[{xtype:"syno_button",id:this.resetBtnId=Ext.id(),disabled:true,text:_T("s2s","s2s_btn_unlink"),handler:this.onResetBtnClick,scope:this}]},selModel:new Ext.grid.RowSelectionModel({singleSelect:false,listeners:{selectionchange:{fn:function(a){if(_S("demo_mode")){return}if(0===a.getSelections().length){Ext.getCmp(this.resetBtnId).disable()}else{Ext.getCmp(this.resetBtnId).enable()}},scope:this}}})})},createPairStore:function(){var a=new SYNO.API.JsonStore({root:"",fields:[{name:"client_id"},{name:"client_name"},{name:"share"},{name:"display"}]});this.addManagedComponent(a);return a},afterRequestPairs:function(h,d,e,a){this.clearStatusBusy();if(!h||!d||!Ext.isArray(d.clients)){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage: get clients fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:d}));return}var k=d.clients;var b=[];for(var g=0;k.length>g;g++){var c=k[g].additional.sync_shares;for(var f=0;c.length>f;f++){b.push({client_id:k[g].id,client_name:k[g].name,share:c[f],display:k[g].name+" \\ "+c[f]})}}this.pairGrid.getStore().loadData(b)},onResetBtnClick:function(){var a=this.pairGrid.getSelectionModel().getSelections();var b=[];Ext.each(a,function(e,d,c){b.push(e.get("share"))},this);this.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_cfm_reset_sharepair"),function(c){if(c==="yes"){this.applyDeletePairByShareName(b)}},this)},applyDeletePairByShareName:function(c){var b=SYNO.SDS.S2S.GenListPairParams();var a=SYNO.SDS.S2S.GenDelPairParams({params:{id_type:"sync_share",id:c}});this.setStatusBusy({text:_T("common","reset")});this.sendWebAPI({compound:{stopwhenerror:true,params:[a,b]},callback:function(h,g,f,e){var d=false;this.clearStatusBusy();if(!h||!g){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: sendWebAPI fail");this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));return}SYNO.SDS.S2S.handleWebApiData(g.result,a,function(j,i){if(!j||!j.success){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: deletePairWebAPI fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(j);return}},this);SYNO.SDS.S2S.handleWebApiData(g.result,b,function(j,i){if(!j){SYNO.Debug("SYNO.SDS.S2S.S2STaskPage.applyDeletePairByShareName: listPairWebAPI fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(j);return}this.afterRequestPairs(j.success,j.data)},this);if(d){this.getMsgBox().alert(_T("s2s","s2s_app_title"),d)}},scope:this})}});Ext.define("SYNO.SDS.S2S.NewJobWizard",{extend:"SYNO.SDS.Wizard.ModalWindow",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.mon(this.panelDestination,"test_connection",this.onTestConnection,this);this.mon(this,"afterlayout",this.requestJobsAndShares,this,{single:true})},fillConfig:function(b){var a=[this.panelName=new SYNO.SDS.S2S.IdPanel({itemId:"taskname",nextId:"srcShare",header:false,headline:_T("s2s","s2s_wiz_lbl_create_task"),description:_T("s2s","s2s_wiz_lbl_create_task_name"),owner:this}),this.panelShare=new SYNO.SDS.S2S.SharePanel({itemId:"srcShare",nextId:"destnet",header:false,headline:_T("s2s","s2s_wiz_lbl_srcShare_select"),description:_T("s2s","s2s_wiz_sub_srcShare_select"),owner:this}),this.panelDestination=new SYNO.SDS.S2S.DestinationPanel({itemId:"destnet",nextId:"schedule",header:false,headline:_T("s2s","s2s_wiz_lbl_set_dest"),description:_T("s2s","s2s_wiz_sub_set_dest"),owner:this}),this.panelSchedule=new SYNO.SDS.S2S.SchdPanel({itemId:"schedule",nextId:"summary",header:false,headline:_T("s2s","s2s_wiz_lbl_setSched_title"),description:_T("s2s","s2s_wiz_sub_setSched"),owner:this}),this.panelOverview=new SYNO.SDS.S2S.OverviewPanel({itemId:"summary",nextId:null,header:false,headline:_T("s2s","s2s_wiz_lbl_summary"),description:_T("wizcommon","summary_descr"),owner:this,getNext:function(){this.owner.applyNewJob();return false}})];return Ext.apply({title:_T("s2s","s2s_wiz_title"),width:600,height:530,steps:a},b)},onTestConnection:function(a){var b=a.getValues();b.sync_shares=this.panelShare.getSelectedShares();SYNO.SDS.S2S.TestConnection(this,b,SYNO.SDS.S2S.TestConnectionCallBack,this)},requestJobsAndShares:function(){var c=SYNO.SDS.S2S.GenListJobParams();var b=SYNO.SDS.S2S.GenGetShareParams();var a=SYNO.SDS.S2S.GenGetNetworkParams();this.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:false,params:[c,b,a]},callback:function(h,g,f,e){var d=false;this.clearStatusBusy();if(!h||!g){SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: sendWebAPI fail");this.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"),function(){this.close()},this);return}SYNO.SDS.S2S.handleWebApiData(g.result,c,function(j,i){if(!j||!j.data){SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: listJobWebAPI fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(j);return}this.panelName.initUniqueId(j.data.jobs)},this);SYNO.SDS.S2S.handleWebApiData(g.result,b,function(j,i){if(!j||!j.data){SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: getShareWebAPI fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(j);return}this.panelShare.setValues(j.data.shares,[])},this);SYNO.SDS.S2S.handleWebApiData(g.result,a,function(k,j){if(!k||!k.data){SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.requestJobsAndShares: request network fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(k);return}var i=[];Ext.each(k.data.nif,function(n,l,m){i.push(n.addr);if(Ext.isArray(n.ipv6)){Ext.each(n.ipv6,function(o){i.push(o.addr)})}});i.push(k.data.hostname.toLowerCase());this.panelDestination.setInvalidDests(i)},this);if(d){this.getMsgBox().alert(_T("s2s","s2s_app_title"),d,function(){this.close()},this)}},scope:this})},applyNewJob:function(){var a={};Ext.apply(a,this.panelName.getForm().getValues());Ext.apply(a,this.panelShare.getValues());Ext.apply(a,this.panelDestination.getValues());Ext.apply(a,this.panelSchedule.getValues());this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI(SYNO.SDS.S2S.GenCreateJobParams({params:a,callback:function(e,d,c,b){this.clearStatusBusy();if(e){this.close()}else{this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:d}))}},scope:this}))}});Ext.define("SYNO.SDS.S2S.ConfigDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){this.jobId=b.jobId;var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"afterlayout",this.requestJobConfAndShares,this,{single:true});this.mon(this.panelDestination,"test_connection",this.onTestConnection,this);this.mon(this.panelDestination,"destination_change",this.onDestinationChange,this)},fillConfig:function(b){var a=[this.panelShare=new SYNO.SDS.S2S.SharePanel({checkConfirmRename:true,header:false,title:_T("s2s","s2s_lbl_src_share"),headline:_T("s2s","s2s_wiz_lbl_srcShare_select"),description:_T("s2s","s2s_wiz_sub_srcShare_select"),owner:this}),this.panelDestination=new SYNO.SDS.S2S.DestinationPanel({header:false,title:_T("s2s","tab_destination"),headline:_T("s2s","s2s_wiz_lbl_set_dest"),description:_T("s2s","s2s_wiz_sub_set_dest"),owner:this}),this.panelSchedule=new SYNO.SDS.S2S.SchdPanel({header:false,title:_T("s2s","s2s_wiz_lbl_schedule"),headline:_T("s2s","s2s_wiz_lbl_setSched_title"),description:_T("s2s","s2s_wiz_sub_setSched"),owner:this})];return Ext.apply({width:600,height:470,minWidth:300,minHeight:250,padding:15,layout:{type:"fit"},items:[{xtype:"syno_tabpanel",deferredRender:false,plain:true,activeTab:0,items:a}],fbar:{xtype:"statusbar",defaultText:"&nbsp",statusAlign:"left",buttonAlign:"left",items:[{text:_T("common","apply"),xtype:"syno_button",btnStyle:"blue",handler:this.applyHandler,scope:this},{text:_T("common","cancel"),xtype:"syno_button",btnStyle:"grey",handler:this.cancelHandler,scope:this}]}},b)},applyHandler:function(){var a=this.panelShare.getSelectedShares();if(0===a.length){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("usbbackup","usbbkp_no_share"));return false}if(false===this.panelShare.hasConfirmRename()){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_accept_share_change"));return false}if(!this.panelDestination.getForm().isValid()){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("error","error_bad_field"));return false}if(true===this.panelShare.isFirstSyncHomes()){this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_disable_server_home_service"),function(b){if("yes"===b){this.testConnection()}},this);return false}this.testConnection()},testConnection:function(){var a=this.panelDestination.getValues();a.sync_shares=this.panelShare.getSelectedShares();a.id=this.jobId;SYNO.SDS.S2S.TestConnection(this,a,function(e,d,c,b){if(e){this.applyJob()}else{this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:d},_T("netbackup","netbkp_connection_testing_fail")))}},this)},cancelHandler:function(){this.close()},onDestinationChange:function(a){this.panelShare.setConfirm(false)},onTestConnection:function(a){var b=a.getValues();b.sync_shares=this.panelShare.getSelectedShares();b.id=this.jobId;SYNO.SDS.S2S.TestConnection(this,b,SYNO.SDS.S2S.TestConnectionCallBack,this)},requestJobConfAndShares:function(){var c=SYNO.SDS.S2S.GenGetShareParams();var b=SYNO.SDS.S2S.GenGetJobParams(this.jobId);var a=SYNO.SDS.S2S.GenGetNetworkParams();this.setStatusBusy();this.sendWebAPI({compound:{stopwhenerror:false,params:[c,b,a]},callback:function(i,h,g,e){var f={};var d=false;this.clearStatusBusy();if(!i||!h){SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: sendWebAPI fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"),function(){this.close()},this);return}SYNO.SDS.S2S.handleWebApiData(h.result,b,function(k,j){if(!k||!k.data){SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request jobs fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(k);return}f=k.data.jobs[0];this.panelDestination.setValues(f.additional);this.panelSchedule.setValues(f.additional.schedule)},this);SYNO.SDS.S2S.handleWebApiData(h.result,c,function(k,j){if(!k||!k.data){SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request shares fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(k);return}this.panelShare.setValues(k.data.shares,f.sync_shares?f.sync_shares:[])},this);SYNO.SDS.S2S.handleWebApiData(h.result,a,function(l,k){if(!l||!l.data){SYNO.Debug("SYNO.SDS.S2S.ConfigDialog.requestJobConfAndShares: request network fail");d=SYNO.SDS.S2S.GetWebAPIErrorString(l);return}var j=[];Ext.each(l.data.nif,function(o,m,n){j.push(o.addr);if(Ext.isArray(o.ipv6)){Ext.each(o.ipv6,function(p){j.push(p.addr)})}});j.push(l.data.hostname.toLowerCase());this.panelDestination.setInvalidDests(j)},this);if(d){this.getMsgBox().alert(_T("s2s","s2s_app_title"),d,function(){this.close()},this)}},scope:this})},applyJob:function(){var a={id:this.jobId};Ext.apply(a,this.panelShare.getValues());Ext.apply(a,this.panelDestination.getValues());Ext.apply(a,this.panelSchedule.getValues());this.setStatusBusy({text:_T("common","saving")});this.sendWebAPI(SYNO.SDS.S2S.GenSetJobParams({params:a,callback:function(e,d,c,b){this.clearStatusBusy();if(e){this.close()}else{this.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:d}))}},scope:this}))}});Ext.define("SYNO.SDS.S2S.IdPanel",{extend:"SYNO.SDS.Utils.FormPanel",ID_PREFIX:"Folder Sync ",constructor:function(b){var a=this.fillConfig(b);this.callParent([a])},fillConfig:function(a){return Ext.apply({title:_T("s2s","col_task_destination"),items:[{xtype:"syno_textfield",name:"id",id:this.nameId=Ext.id(),allowBlank:false,maxLength:SYNO.SDS.S2S.BKPSET_MAX_LEN,vtype:"sharename",fieldLabel:_T("s2s","s2s_lbl_task_name")}]},a)},checkIdConflict:function(){this.owner.setStatusBusy();this.sendWebAPI(SYNO.SDS.S2S.GenListJobParams({callback:function(e,d,c,b){this.owner.clearStatusBusy();if(!e||!d||!d.jobs){SYNO.Debug("SYNO.SDS.S2S.SharePanel.checkIdConflict: list job fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),SYNO.SDS.S2S.GetWebAPIErrorString({error:d}));return}var a=Ext.getCmp(this.nameId).getValue();if(!this.existJobId(d.jobs,a)){this.owner.goNext(this.nextId)}else{SYNO.Debug("SYNO.SDS.S2S.SharePanel.setValues: id exists");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_duplicate_taskname"),function(){Ext.getCmp(this.nameId).focus(true)},this)}},scope:this}))},existJobId:function(a,c){if(!a){return false}for(var b=0;a.length>b;b++){if(a[b].id===c){return true}}return false},initUniqueId:function(b){var c=1;var a=this.ID_PREFIX+c;if(b){while(this.existJobId(b,a)){c++;a=this.ID_PREFIX+c}}Ext.getCmp(this.nameId).setValue(a);Ext.getCmp(this.nameId).focus(true)},getValues:function(){return this.getForm().getValues()},getNext:function(){if(!this.getForm().isValid()){this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});Ext.getCmp(this.nameId).focus(true);return false}var a=Ext.util.Format.trim(Ext.getCmp(this.nameId).getValue());Ext.getCmp(this.nameId).setValue(a);this.checkIdConflict();return false},summary:function(a){a.append(_T("s2s","col_summary_task_name"),Ext.getCmp(this.nameId).getValue());return}});Ext.define("SYNO.SDS.S2S.SharePanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"afterlayout",function(){this.setConfirm(a.checkConfirmRename)},this,{single:true});this.mon(this.selectCol,"click",function(){this.setConfirm(false)},this);this.mon(Ext.getCmp(this.shareGridId),"headerclick",function(e,d,c){if(0===d){this.setConfirm(false)}},this)},fillConfig:function(b){var c=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"",fields:[{name:"selected"},{name:"name"}]})});this.addManagedComponent(c);var a=new Ext.grid.ColumnModel({defaults:{menuDisabled:true},columns:[this.selectCol=new SYNO.ux.EnableColumn({width:75,header:_T("usbbackup","usbbkp_select_all"),align:"center",dataIndex:"selected"}),{sortable:true,width:350,header:_T("s2s","col_share_name"),align:"center",dataIndex:"name"}]});return Ext.apply({checkConfirmRename:false,layout:{type:"vbox",align:"stretch"},items:[{xtype:"syno_gridpanel",id:this.shareGridId=Ext.id(),loadMask:true,enableColumnMove:false,enableHdMenu:false,flex:1,cm:a,ds:c,plugins:[this.selectCol],selModel:new Ext.grid.CellSelectionModel()},{xtype:"syno_checkbox",name:"confirmRename",id:this.confirmRenameId=Ext.id(),height:"auto",boxLabel:_T("s2s","s2s_wiz_warn_shareData_del")}]},b)},setConfirm:function(a){Ext.getCmp(this.confirmRenameId).setValue(a)},setValues:function(c,b){if(!Ext.isArray(c)||!Ext.isArray(b)){SYNO.Debug("SYNO.SDS.S2S.SharePanel.setValues: set shares fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("error","error_error_system"));return}var a=0;var d={};for(a=0;b.length>a;a++){d[b[a]]=true}for(a=0;c.length>a;a++){c[a].selected=(d[c[a].name]?true:false)}Ext.getCmp(this.shareGridId).getStore().loadData(c,false)},getSelectedShares:function(){var d=Ext.getCmp(this.shareGridId).getStore();var b=[];for(var a=0;d.getTotalCount()>a;a++){var c=d.getAt(a);if(c.get("selected")){b.push(c.get("name"))}}return b},getValues:function(){return{sync_shares:this.getSelectedShares()}},hasConfirmRename:function(){return Ext.getCmp(this.confirmRenameId).getValue()},isFirstSyncHomes:function(){var c=Ext.getCmp(this.shareGridId).getStore();var b=c.getModifiedRecords();var a=false;Ext.each(b,function(d){if(d.get("selected")&&d.get("name")==="homes"){a=true;return false}});return a},getNext:function(){var a=this.getSelectedShares();if(0===a.length){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("usbbackup","usbbkp_no_share"));return false}if(false===this.hasConfirmRename()){this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_accept_share_change"));return false}if(this.isFirstSyncHomes()===true){this.owner.getMsgBox().confirm(_T("s2s","s2s_app_title"),_T("s2s","s2s_warn_disable_server_home_service"),function(b){if(b==="yes"){this.owner.goNext(this.nextId)}},this);return false}return this.nextId},summary:function(b){var a=this.getSelectedShares();if(0===a.length){b.append(_T("s2s","col_summary_share_list"),_T("s2s","no_selected_share"))}else{b.append(_T("s2s","col_summary_share_list"),a.join(","))}return}});Ext.define("SYNO.SDS.S2S.DestinationPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){this.hasFindServer=false;var a=this.fillConfig(b);this.callParent([a]);this.addEvents("test_connection","destination_change");this.mon(this,"afterlayout",function(c,d){SYNO.SDS.Utils.AddTip(this.getForm().findField("use_block").getEl(),_T("s2s","s2s_wiz_desc_enable_blockLvl"))},this,{single:true});this.mon(this,"afterlayout",function(){var c=this.getForm().findField("ssh_port_check").getEl().next("label").createChild({tag:"span"});SYNO.SDS.Utils.AddTip(c,_T("s2s","s2s_wiz_desc_customize_ssh_port"))},this,{single:true})},fillConfig:function(b){var a=275;var c=new SYNO.API.Store({reader:new Ext.data.JsonReader({idProperty:"name",root:"",fields:[{name:"ip"},{name:"name"},{name:"display"}]})});this.addManagedComponent(c);return Ext.apply({labelWidth:a,items:[this.combServer=new SYNO.ux.ComboBox({name:"server",allowBlank:false,editable:true,width:250,mode:"local",displayField:"display",valueField:"display",triggerAction:"all",fieldLabel:_T("netbackup","netbkp_set_ip"),emptyText:_T("netbackup","netbkp_input_addr"),owner:this,store:c,validator:Ext.createDelegate(this.validateServerName,this),onTriggerClick:function(){this.owner.onServerComboClick()},listeners:{change:{fn:function(d){this.fireEvent("destination_change")},scope:this}}}),{xtype:"syno_textfield",name:"user",allowBlank:false,fieldLabel:_T("netbackup","netbkp_account")},{xtype:"syno_textfield",name:"password",fieldLabel:_T("common","password"),inputType:"password"},{xtype:"syno_checkbox",name:"ssh_port_check",boxLabel:_T("s2s","s2s_lbl_customize_ssh_port"),scope:this,handler:function(e,d){if(d){this.getForm().findField("ssh_port").enable()}else{this.getForm().findField("ssh_port").disable()}}},{xtype:"syno_numberfield",name:"ssh_port",disabled:true,allowBlank:false,indent:1,maxlength:5,vtype:"port",fieldLabel:_T("common","port")},{xtype:"syno_checkbox",name:"use_ssh",boxLabel:_T("netbackup","encryption_enable")},{xtype:"syno_checkbox",name:"use_compression",boxLabel:_T("netbackup","compression_enable")},{xtype:"syno_checkbox",name:"use_block",boxLabel:_T("s2s","s2s_wiz_lbl_enable_blockLvl")},{xtype:"syno_button",text:_T("netbackup","netbkp_test_connection"),handler:function(d,f){this.fireEvent("test_connection",this)},scope:this}]},b)},validateServerName:function(b){var e=/^(localhost|127\.0\.0\.1|0\.0\.0\.0|::1|0:0:0:0:0:0:0:1)$/;var a=this.invalidDests;var c=b.indexOf("(");var d=b.indexOf(")");b=b.toLowerCase();if(c>0&&c<d&&d===(b.length-1)){b=b.substring(c+1,d)}if(new RegExp("\\s").exec(b)){return false}if(e.match(b)||(a&&-1!==a.indexOf(b))){return _T("netbackup","netbkp_sync_self")}if(!Ext.form.VTypes.netbiosName(b)&&!Ext.form.VTypes.looseip(b)&&!Ext.form.VTypes.hostname(b)){return _T("netbackup","netbkp_err_host_str")}return true},getHostName:function(c){var b=c.indexOf("(");var a=c;if(b>0){a=c.substring(0,b)}if(Ext.form.VTypes.netbiosName(a)||(Ext.form.VTypes.hostname(a)&&!Ext.form.VTypes.looseip(a))){return a}return""},getHostIp:function(c){var a=c.indexOf("(");var b=c.indexOf(")");var d=c;if(a>0&&a<b&&b===(c.length-1)){d=c.substring(a+1,b)}if(Ext.form.VTypes.looseip(d)){return d}return""},onServerComboClick:function(){var a=this.combServer;if(this.hasFindServer&&(0<a.getStore().getTotalCount())){if(a.isExpanded()){a.collapse()}else{a.onFocus({});a.expand()}a.el.focus()}else{a.el.focus();this.owner.setStatusBusy({text:_T("netbackup","netbkp_wait_server")});this.sendWebAPI(SYNO.SDS.S2S.GenListServerParams({callback:this.afterFindServers,scope:this}))}},afterFindServers:function(e,d,c,b){this.owner.clearStatusBusy();if(!e||!d||!Ext.isArray(d.servers)){SYNO.Debug("SYNO.SDS.S2S.NewJobWizard.afterFindServers: sendWebAPI fail");this.owner.getMsgBox().alert(_T("s2s","s2s_app_title"),_T("common","error_system"));return}if(0<d.servers.length){this.hasFindServer=true}var g=[];for(var a=0;d.servers.length>a;a++){var f=d.servers[a].name;if(d.servers[a].ip!==f){f+="("+d.servers[a].ip+")"}g.push({ip:d.servers[a].ip,name:d.servers[a].name,display:f})}if(!this.combServer.isExpanded()){this.combServer.el.focus()}this.combServer.getStore().loadData(g)},setInvalidDests:function(a){if(!a){this.invalidDests=null}else{if(Ext.isArray(a)){this.invalidDests=a.slice(0)}else{this.invalidDests=[a]}}},setValues:function(b){if(!b){SYNO.Debug("SYNO.SDS.S2S.DestinationPanel.setValues: fail");return}var e=b.server.name;var a=b.server.ip;var d=e;if(a!==d){d+="("+a+")"}this.combServer.setValue(d);var c=this.getForm();c.findField("use_block").setValue(b.use_block);c.findField("use_compression").setValue(b.use_compression);c.findField("use_ssh").setValue(b.use_ssh);c.findField("ssh_port_check").setValue(0!==b.ssh_port);c.findField("ssh_port").setValue(b.ssh_port?b.ssh_port:"");c.findField("user").setValue(b.user);c.findField("password").setValue(SYNO.SDS.S2S.GetFakePswd())},getValues:function(c,f){var d=this.getForm();var b=d.findField("server").getValue();var g=this.getHostName(b);var a=this.getHostIp(b);return{server_ip:a,server_name:g,use_block:d.findField("use_block").getValue(),use_compression:d.findField("use_compression").getValue(),use_ssh:d.findField("use_ssh").getValue(),ssh_port:d.findField("ssh_port").disabled?0:parseInt(d.findField("ssh_port").getValue(),10),user:d.findField("user").getValue(),password:d.findField("password").getValue()}},getNext:function(){if(!this.getForm().isValid()){this.owner.setStatusError({text:_T("common","forminvalid"),clear:true});return false}return this.nextId},summary:function(b){var a=this.getForm();b.append(_T("netbackup","netbkp_account"),a.findField("user").getValue());if(a.findField("use_ssh").getValue()){b.append(_T("netbackup","netbkp_security"),_T("netbackup","netbkp_high_security"))}else{b.append(_T("netbackup","netbkp_security"),_T("netbackup","netbkp_low_security"))}if(!a.findField("ssh_port").disabled){b.append(_T("s2s","col_summary_customize_ssh_port"),a.findField("ssh_port").getValue())}else{b.append(_T("s2s","col_summary_customize_ssh_port"),_T("common","default"))}if(a.findField("use_compression").getValue()){b.append(_T("netbackup","netbkp_data_compression"),_T("common","enabled"))}else{b.append(_T("netbackup","netbkp_data_compression"),_T("common","disabled"))}if(a.findField("use_block").getValue()){b.append(_T("s2s","col_summary_blockbkp"),_T("common","enabled"))}else{b.append(_T("s2s","col_summary_blockbkp"),_T("common","disabled"))}}});Ext.define("SYNO.SDS.S2S.SchdPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"afterlayout",function(c,e){var f;f=new SYNO.ux.Utils.EnableRadioGroup(c.getForm(),this.scheduleRadio,{manual:[],realtime:[],advance:["btn_schedule"]});this.setValues({})},this,{single:true})},fillConfig:function(b){var a=new Date();this.advSchdMode=SYNO.SDS.S2S.SCHE_DAILY;this.schdData={week_day:SYNO.SDS.S2S.WEEK_ALL,mode:SYNO.SDS.S2S.SCHD_REALTIME,start_year:a.getFullYear(),start_month:a.getMonth()+1,start_day:a.getDate(),first_hour:0,first_min:0,repeat_hour:0,repeat_min:0,repeat_in_day:0};this.scheduleRadio="schedule_radio";return Ext.apply({title:Ext.util.Format.ellipsis(_T("usbbackup","usbbkp_schedule"),15),tabTip:_T("usbbackup","usbbkp_schedule"),items:[{xtype:"syno_radio",name:this.scheduleRadio,id:this.radioRealtimeId=Ext.id(),checked:true,inputValue:SYNO.SDS.S2S.SCHD_REALTIME,boxLabel:_T("s2s","s2s_wiz_lbl_setSched_realtime"),handler:this.schdModeChangeHandler,scope:this},{xtype:"syno_radio",name:this.scheduleRadio,id:this.radioManualId=Ext.id(),checked:false,inputValue:SYNO.SDS.S2S.SCHD_MANUAL,boxLabel:_T("s2s","s2s_wiz_lbl_setSched_man"),handler:this.schdModeChangeHandler,scope:this},{xtype:"syno_radio",name:this.scheduleRadio,id:this.radioAdvanceId=Ext.id(),checked:false,inputValue:SYNO.SDS.S2S.SCHD_ADVANCE,boxLabel:_T("schedule","schedule_advance"),handler:this.schdModeChangeHandler,scope:this},{xtype:"syno_button",id:"btn_schedule",text:_T("schedule","schedule_title"),indent:1,handler:function(d,f){var c=new SYNO.SDS.S2S.AdvSchdDialog({title:_T("schedule","schedule_advance"),owner:this.owner});this.mon(c,"confirm",this.onApplyAdvSchd,this);c.setValues(this.schdData);c.open()},scope:this},{xtype:"syno_displayfield",name:"txtadvscheduletime",indent:1,labelSeparator:"",value:""},{xtype:"syno_displayfield",name:"txtadvscheduleday",indent:1,labelSeparator:"",value:""}]},b)},setValues:function(a){if(!a){return}Ext.apply(this.schdData,a);switch(this.schdData.mode){case SYNO.SDS.S2S.SCHD_MANUAL:case SYNO.SDS.S2S.SCHD_REALTIME:this.getForm().findField(this.scheduleRadio).setValue(this.schdData.mode);break;default:this.advSchdMode=this.schdData.mode;this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.SCHD_ADVANCE)}},getValues:function(){return{schedule_mode:this.schdData.mode,schedule_start_year:this.schdData.start_year,schedule_start_month:this.schdData.start_month,schedule_start_day:this.schdData.start_day,schedule_first_hour:this.schdData.first_hour,schedule_first_min:this.schdData.first_min,schedule_repeat_hour:this.schdData.repeat_hour,schedule_repeat_min:this.schdData.repeat_min,schedule_repeat_in_day:this.schdData.repeat_in_day,schedule_week_day:this.schdData.week_day}},schdModeChangeHandler:function(b,a){if(a){switch(b.getId()){case this.radioManualId:this.schdData.mode=SYNO.SDS.S2S.SCHD_MANUAL;this.getForm().findField("txtadvscheduletime").setValue("");this.getForm().findField("txtadvscheduleday").setValue("");break;case this.radioRealtimeId:this.schdData.mode=SYNO.SDS.S2S.SCHD_REALTIME;this.getForm().findField("txtadvscheduletime").setValue("");this.getForm().findField("txtadvscheduleday").setValue("");break;default:this.schdData.mode=this.advSchdMode;this.printAdvSchd()}}},onApplyAdvSchd:function(a,b){if(b){Ext.apply(this.schdData,b);this.advSchdMode=b.mode;this.printAdvSchd()}},printAdvSchd:function(){var a=this.getForm().findField("txtadvscheduletime");var b=this.getForm().findField("txtadvscheduleday");a.setValue(SYNO.SDS.S2S.ScheduleDateToString(this.schdData));b.setValue(SYNO.SDS.S2S.ScheduleTimeToString(this.schdData))},getNext:function(){return this.nextId},summary:function(b){var a="";switch(this.schdData.mode){case SYNO.SDS.S2S.SCHD_REALTIME:a=_T("s2s","s2s_lbl_sched_realtime");break;case SYNO.SDS.S2S.SCHD_MANUAL:a=_T("s2s","s2s_lbl_sched_mode_man");break;default:a=SYNO.SDS.S2S.ScheduleDateToString(this.schdData);a+=", ";a+=SYNO.SDS.S2S.ScheduleTimeToString(this.schdData)}b.append(_T("s2s","s2s_wiz_lbl_schedule"),a)}});Ext.define("SYNO.SDS.S2S.OverviewPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a])},fillConfig:function(a){return Ext.apply({border:false,layout:{type:"fit"},items:[this.grid=new SYNO.SDS.Wizard.SummaryStep({})]},a)},activate:function(){var a=this.owner.stepStack;var c=null;this.grid.getStore().removeAll(true);for(var b=0;b<a.length;b++){c=this.owner.getStep(a[b]);if(Ext.isFunction(c.summary)){c.summary(this.grid.getStore())}}this.grid.getView().refresh()}});Ext.define("SYNO.SDS.S2S.AdvSchdPanel",{extend:"SYNO.SDS.Utils.FormPanel",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.mon(this,"afterlayout",function(c,d){var e;e=new SYNO.ux.Utils.EnableRadioGroup(c.getForm(),this.scheduleRadio,{by_week:[this.weekDayId],by_date:[this.startDateId,this.byDateId]})},this,{single:this})},fillConfig:function(a){var e=function(j,h){var i=new Ext.data.ArrayStore({fields:["display","value"],data:h});j.addManagedComponent(i);return i};var g=function(n,l,k,j){var h=[];for(var m=l;k>=m;m++){h.push(j(m))}return e(n,h)};var f=function(h){return Ext.apply({xtype:"syno_combobox",editable:false,triggerAction:"all",mode:"local",displayField:"display",valueField:"value"},h)};var c=g(this,0,23,function(h){return[String.leftPad(String(h),2,"0"),h]});var b=g(this,0,59,function(h){return[String.leftPad(String(h),2,"0"),h]});var d=e(this,[[_T("schedule","no_repeat"),SYNO.SDS.S2S.SCHE_ONCE],[_T("schedule","repeat_monthly"),SYNO.SDS.S2S.SCHE_MONTHLY],[_T("schedule","repeat_yearly"),SYNO.SDS.S2S.SCHE_YEARLY]]);this.periodStore=e(this,[]);this.lastWorkHourStore=e(this,[]);this.scheduleRadio="scheduleRadio";return Ext.apply({height:500,items:[{xtype:"syno_fieldset",title:_T("time","time_date"),items:[{xtype:"syno_radio",name:this.scheduleRadio,boxLabel:_T("schedule","run_on_days"),inputValue:SYNO.SDS.S2S.RADIO_BY_WEEK},{xtype:"syno_schedulefield",id:this.weekDayId=Ext.id(),allowBlank:false,editable:false},{xtype:"syno_displayfield",height:5,value:"&nbsp;"},{xtype:"syno_radio",name:this.scheduleRadio,boxLabel:_T("schedule","by_date"),inputValue:SYNO.SDS.S2S.RADIO_BY_DATE},{xtype:"syno_datefield",id:this.startDateId=Ext.id(),allowBlank:false,editable:false,format:"Y/n/j",maxValue:"2037/12/31",minValue:"2005/1/1"},f({id:this.byDateId=Ext.id(),value:SYNO.SDS.S2S.SCHE_ONCE,store:d})]},{xtype:"syno_fieldset",title:_T("time","time_time"),items:[{xtype:"syno_compositefield",hideLabel:true,items:[{xtype:"syno_displayfield",width:180,value:_T("schedule","run_time_first")+":"},f({id:this.fisrtHourId=Ext.id(),width:60,store:c,listeners:{select:{fn:function(){this.updatePeriodStore();this.updateLastWorkTimeStore()},scope:this}}}),{xtype:"syno_displayfield",value:":"},f({id:this.firstMinId=Ext.id(),width:60,store:b,listeners:{select:{fn:function(){this.updatePeriodStore();this.updateLastWorkTimeStore()},scope:this}}})]},f({id:this.periodId=Ext.id(),value:0,fieldLabel:_T("schedule","schedule_every"),store:this.periodStore,listeners:{select:{fn:function(){this.updateLastWorkTimeStore()},scope:this}}}),f({id:this.repeatTimesId=Ext.id(),value:0,fieldLabel:_T("schedule","run_time_last"),store:this.lastWorkHourStore})]}]},a)},setValues:function(b){if(!b){return}var a=[];for(var c=0;b.week_day.length>c;c++){if("0"!==b.week_day.charAt(c)){a.push(c)}}Ext.getCmp(this.weekDayId).setValue(a.join(","));Ext.getCmp(this.startDateId).setValue(new Date(b.start_year,b.start_month-1,b.start_day));if(!Ext.getCmp(this.startDateId).isValid()){Ext.getCmp(this.startDateId).setValue(new Date())}Ext.getCmp(this.fisrtHourId).setValue(b.first_hour);Ext.getCmp(this.firstMinId).setValue(b.first_min);this.updatePeriodStore();Ext.getCmp(this.periodId).setValue(b.repeat_hour*60+b.repeat_min);this.updateLastWorkTimeStore();Ext.getCmp(this.repeatTimesId).setValue(b.repeat_in_day);switch(b.mode){case SYNO.SDS.S2S.SCHE_MONTHLY:case SYNO.SDS.S2S.SCHE_YEARLY:case SYNO.SDS.S2S.SCHE_ONCE:this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.RADIO_BY_DATE);Ext.getCmp(this.byDateId).setValue(b.mode);break;default:this.getForm().findField(this.scheduleRadio).setValue(SYNO.SDS.S2S.RADIO_BY_WEEK);Ext.getCmp(this.byDateId).setValue(SYNO.SDS.S2S.SCHE_ONCE);break}},getValues:function(){var f=this.getForm().findField(this.scheduleRadio).getGroupValue();var d=Ext.getCmp(this.startDateId).getValue();var c="";var b=["0","0","0","0","0","0","0"];var a=Ext.getCmp(this.weekDayId).getValue().split(",");for(var e=0;a.length>e;e++){var g=parseInt(a[e],10);b[g]="1"}switch(f){case SYNO.SDS.S2S.RADIO_BY_WEEK:c=SYNO.SDS.S2S.SCHE_WEEKLY;break;default:case SYNO.SDS.S2S.RADIO_BY_DATE:c=Ext.getCmp(this.byDateId).getValue()}return{mode:c,start_year:d.getFullYear(),start_month:d.getMonth()+1,start_day:d.getDate(),first_hour:Ext.getCmp(this.fisrtHourId).getValue(),first_min:Ext.getCmp(this.firstMinId).getValue(),repeat_hour:Math.floor(Ext.getCmp(this.periodId).getValue()/60),repeat_min:Ext.getCmp(this.periodId).getValue()%60,repeat_in_day:Ext.getCmp(this.repeatTimesId).getValue(),week_day:b.join("")}},updatePeriodStore:function(){var a=[];var c=Ext.getCmp(this.fisrtHourId).getValue();var d=Ext.getCmp(this.firstMinId).getValue();var e=24*60-(c*60+d);var g;a.push([_T("schedule","schedule_every_once"),0]);if(e>15){a.push([String.format(_T("s2s","s2s_lbl_sched_every_min"),15),15])}if(e>30){a.push([String.format(_T("s2s","s2s_lbl_sched_every_min"),30),30])}for(var f=1;e>f*60;f++){g=String.format(_T("s2s","s2s_lbl_sched_mode_every"),f);a.push([g,f*60])}this.periodStore.loadData(a);var b=Ext.getCmp(this.periodId).getValue();if(b>e){Ext.getCmp(this.periodId).setValue(0)}},updateLastWorkTimeStore:function(){var e=[];var a=24*60;var b=Ext.getCmp(this.fisrtHourId).getValue();var i=Ext.getCmp(this.firstMinId).getValue();var d=b*60+i;var k=d;var j=Ext.getCmp(this.repeatTimesId).getValue();var l=Ext.getCmp(this.periodId).getValue();var c=0;while(k<a){var h=Math.floor(k/60);var f=k%60;var g=String.leftPad(String(h),2,"0")+":"+String.leftPad(String(f),2,"0");e.push([g,c]);c++;k=d+c*l;if(0===l){break}}this.lastWorkHourStore.loadData(e);if(j>=c){Ext.getCmp(this.repeatTimesId).setValue(0)}else{Ext.getCmp(this.repeatTimesId).setValue(j)}}});Ext.define("SYNO.SDS.S2S.AdvSchdDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(b){var a=this.fillConfig(b);this.callParent([a]);this.addEvents("confirm")},fillConfig:function(a){this.panelSchedule=new SYNO.SDS.S2S.AdvSchdPanel({owner:this});return Ext.apply({title:a.title,width:510,height:450,items:[this.panelSchedule],buttons:[{text:_T("common","apply"),handler:this.applyHandler,btnStyle:"blue",scope:this},{text:_T("common","cancel"),handler:this.cancelHandler,scope:this}]},a)},applyHandler:function(){this.fireEvent("confirm",this,this.getValues());this.close()},cancelHandler:function(){this.fireEvent("confirm",this,null);this.close()},getValues:function(){return this.panelSchedule.getValues()},setValues:function(a){this.panelSchedule.setValues(a)}});Ext.define("SYNO.SDS.Backup.AdvancedSearchField",{extend:"SYNO.ux.SearchField",initEvents:function(){this.callParent(arguments);this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this);this.mon(this,"keypress",function(b,a){if(a.getKey()===Ext.EventObject.ENTER){this.searchPanel.setKeyWord(this.getValue());this.searchPanel.onSearch()}},this)},isInnerComponent:function(c,b){var a=false;b.items.each(function(d){if(d instanceof Ext.form.ComboBox){if(d.view&&c.within(d.view.getEl())){a=true;return false}}else{if(d instanceof Ext.form.DateField){if(d.menu&&c.within(d.menu.getEl())){a=true;return false}}else{if(d instanceof Ext.form.CompositeField){if(this.isInnerComponent(c,d)){a=true;return false}}}}},this);return a},onMouseDown:function(b){var a=this.searchPanel;if(a&&a.isVisible()&&!a.isDestroyed&&!a.inEl&&!b.within(a.getEl())&&!b.within(this.searchtrigger)&&!this.isInnerComponent(b,this.searchPanel.getForm())){a.hide()}},onSearchTriggerClick:function(){if(this.searchPanel.isVisible()){this.searchPanel.hide();return}this.searchPanel.getEl().alignTo(this.wrap,"tr-br?",[6,0]);this.searchPanel.show();this.searchPanel.setKeyWord(this.getValue())},onTriggerClick:function(){this.callParent();this.searchPanel.onReset();this.searchPanel.onSearch()}});Ext.define("SYNO.SDS.Backup.SearchFormPanel",{extend:"SYNO.ux.FormPanel",constructor:function(a){this.dateType={custom:1,today:2,yesterday:4,lastweek:8,lastmonth:16};this.dataRange=[[this.dateType.custom,_T("log","date_custom")],[this.dateType.today,_T("log","date_today")],[this.dateType.yesterday,_T("log","date_yesterday")],[this.dateType.lastweek,_T("log","date_lastweek")],[this.dateType.lastmonth,_T("log","date_lastmonth")]];this.logLevelType={info:"1",warn:"2",error:"3"};this.logLevel=[[this.logLevelType.info,_T("log","info_level")],[this.logLevelType.warn,_T("log","warn_level")],[this.logLevelType.error,_T("log","error_level")]];this.defaultAnimation=["#000",1,{duration:0.35}];Ext.apply(this,a||{});var b=this.fillConfig(a);this.callParent([b]);this.defineBehaviors()},initComponent:function(){this.callParent([this]);this.addEvents("search")},getAllLogType:function(a){var b=[];a.each(function(c){b.push(c[0])});return b.join(",")},getAllLogDisplayText:function(a){var b=[];a.each(function(c){b.push(c[1])});return b.join(",")},fillConfig:function(b){var a,f,g,e;var c=[];this.logType=b.logType;a=this.createKeyword();f=this.createFriendlyDate();g=this.createCustDate();e=this.createLevel();c.push(a);c.push(f);c.push(g);c.push(e);c.push({xtype:"toolbar",border:false,itemId:"btns",toolbarCls:"search-panel-fbar-btnPanel",items:[{xtype:"lctbtext",itemId:"search-loading",text:""},{xtype:"lctbtext",itemId:"msg",height:26,style:"-webkit-text-size-adjust:none;font-size:11px;height:26px;overflow:hidden;",cls:"red-status",text:""},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("log","search"),itemId:"btn_search",handler:this.onSearch,scope:this},{xtype:"syno_button",btnStyle:"blue",style:"margin-right: 10px",text:_T("smart","smart_test_button_stop"),itemId:"btn_stop",hidden:true,handler:this.onStop,scope:this},{xtype:"syno_button",minWidth:80,text:_T("common","reset"),handler:this.onReset,scope:this}]});var d={width:368,heigh:480,floating:true,labelAlign:"left",trackResetOnLoad:true,waitMsgTarget:true,border:true,bodyStyle:"padding: 20px; padding-top: 0px; font-size: 24px;",autoFlexcroll:false,defaults:{hideLabel:true,anchor:"100%"},items:c,listeners:{actionfailed:{fn:function(){this.setMsg("");this.form.reset()},scope:this},beforeshow:{fn:function(){this.doLayout()},single:true},show:{fn:this.doLayout,single:true}},keys:[{key:[10,13],fn:function(){if(!this.isVisible()){return}if(!this.btnSearch.hidden&&!this.btnSearch.disabled){this.onSearch()}else{if(!this.btnStop.hidden&&!this.btnStop.disabled){this.onStop()}}},scope:this}]};return d},setComboBoxValue:function(b,a){this.frameAnimation(b.el,this.defaultAnimation);if(b.setMultiValue){b.setMultiValue(a.split(","))}},getComboBoxValue:function(b){var a=this.getForm().findField(b);return a.getMultiValue?a.getMultiValue().toString():a.getValue()},multiSelect:function(c,e,a,d,b){Ext.applyIf(c,{setMultiValue:function(f){if(!Ext.isArray(f)){f=[f]}this.multiValue=f},getMultiValue:function(){return this.multiValue&&this.multiValue.length>0?this.multiValue:this.getValue().split(",")}});if("more"===e.get("value")){this.attriWin=new SYNO.SDS.LogCenter.MultiSelectedDialog({title:d,combo:c,emptyValue:b,anim:this.defaultAnimation,owner:this.owner.appInst});this.attriWin.showUp();c.collapse();return false}},createTpl:function(){return new Ext.XTemplate('<tpl for=".">','<div class="x-combo-list-item" ext:qtip="{displayText:htmlEncode}">',"{displayText:htmlEncode}","</div>","</tpl>")},logSelect:function(c,a,b){this.setComboBoxValue(c,c.getValue())},createKeyword:function(){return[{xtype:"syno_displayfield",value:_T("log","attr_keyword")+_T("common","colon"),flex:1},{xtype:"syno_textfield",msgTarget:"qtip",validateOnBlur:true,validationEvent:"blur",name:"keyword",flex:2,vaule:""}]},setDate:function(c,b,a){if(a===true){this.frameAnimation(this.form.findField("searchdatefrom").el,this.defaultAnimation);this.frameAnimation(this.form.findField("searchdateto").el,this.defaultAnimation)}this.form.findField("searchdatefrom").setMaxValue(b);this.form.findField("searchdateto").setMinValue(c);this.form.findField("searchdatefrom").setValue(c);this.form.findField("searchdateto").setValue(b)},getFromToDate:function(c){var e,d,b=new Date();if(c===this.dateType.today){e=b;d=b}else{if(c===this.dateType.yesterday){e=b.add(Date.DAY,-1);d=e}else{if(c===this.dateType.lastweek){var a=b.getDay();e=b.add(Date.DAY,-7-a);d=e.add(Date.DAY,6)}else{if(c===this.dateType.lastmonth){b=b.add(Date.MONTH,-1);e=b.getFirstDateOfMonth();d=b.getLastDateOfMonth()}}}}return{from:e,to:d}},friendlyDateSelect:function(c,e,a){var b=e.get("id"),d=this.getFromToDate(b);this.setDate(d.from,d.to,true)},getFriendlyDateStore:function(){var a=this.dataRange;return new Ext.data.ArrayStore({autoDestroy:true,fields:["id","displayText"],data:a})},createFriendlyDate:function(){this.FriendlyDate=new SYNO.ux.ComboBox({mode:"local",editable:false,name:"dateRange",tpl:this.createTpl(),resizable:true,store:this.getFriendlyDateStore(),displayField:"displayText",valueField:"id",triggerAction:"all",lazyRender:true,flex:6,value:this.dateType.custom,listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.friendlyDateSelect}});return[{xtype:"syno_displayfield",value:_T("log","date_range")+_T("common","colon"),flex:1},this.FriendlyDate]},createCustDate:function(){this.DateFrom=new SYNO.ux.DateField({name:"searchdatefrom",editable:false,format:"m/d/Y",emptyText:_T("log","date_from"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdateto").setMinValue(a)}}});this.DateTo=new SYNO.ux.DateField({name:"searchdateto",editable:false,format:"m/d/Y",emptyText:_T("log","date_to"),value:"",listeners:{scope:this,select:function(b,a){this.form.findField("searchdatefrom").setMaxValue(a)}}});return[{xtype:"syno_displayfield",value:_T("time","time_date")+_T("common","colon")},{xtype:"syno_compositefield",hideLabel:true,defaults:{flex:1},defaultMargins:"0 8 0 0",items:[this.DateFrom,this.DateTo]}]},getLogLevelStore:function(){var a=this.logLevel.slice(0,this.logLevel.length);if(a.length>1){a.splice(0,0,["",_T("log","log_all")])}return new Ext.data.ArrayStore({autoDestroy:true,fields:["value","displayText"],data:a})},multiLogLevelSelect:function(b,c,a){this.multiSelect(b,c,a,_T("log","logattr"),"")},createLevel:function(){this.LogLevel=new SYNO.ux.ComboBox({xtype:"syno_combobox",mode:"local",editable:false,name:"logLevel",tpl:this.createTpl(),resizable:true,store:this.getLogLevelStore(),displayField:"displayText",valueField:"value",triggerAction:"all",lazyRender:true,flex:3,value:"",listeners:{scope:this,beforequery:function(a){delete a.combo.lastQuery},beforeselect:this.multiLogLevelSelect,select:this.logSelect}});return[{xtype:"syno_displayfield",name:"logLevelLabel",value:_T("log","logattr")+_T("common","colon"),flex:1},this.LogLevel]},hideItems:function(b){var c;if(!Ext.isArray(b)){b=[b]}for(var a=b.length-1;a>=0;a--){c=this.form.findField(b[a]);if(c){c.setVisible(false)}}},frameAnimation:function(a,b){if(a&&a.isVisible()){Ext.Element.prototype.frame.apply(a,b)}},defineBehaviors:function(){var a=this.get("btns");this.btnSearch=a.get("btn_search");this.btnStop=a.get("btn_stop")},setMsg:function(c){var a=this.get("btns");var b=a.get("msg");b.setText(c);if(c.trim()!==""){this.frameAnimation(b.el,this.defaultAnimation)}},setKeyWord:function(a){var b=this.form.findField("keyword");if(b&&Ext.isString(a)){b.setValue(a)}b.focus("",1)},onShowHideBtn:function(a){if(a){this.btnSearch.hide();this.btnStop.show()}else{this.btnSearch.show();this.btnStop.hide()}},onEnableDisableBtn:function(a){if(a){this.btnSearch.enable();this.btnStop.enable()}else{this.btnSearch.disable();this.btnStop.disable()}},isOwnerDestroyed:function(){return(this.owner&&this.owner.isDestroyed)},showMsg:function(b,a){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().alert(b,a)}},hideMsg:function(){if(!this.isOwnerDestroyed()){this.owner.getMsgBox().hide()}},isFieldDirty:function(a){return this.form.findField(a).isDirty()},validateForm:function(){if(!this.form.isValid()){return false}return this.isFieldDirty("searchdatefrom")||this.isFieldDirty("searchdateto")||this.isFieldDirty("keyword")},onSearch:function(c,f){var d,b,i,h,a;var g;d=this.getForm();b=d.findField("keyword").getValue();i=d.findField("searchdatefrom").getRawValue();h=d.findField("searchdateto").getRawValue();a=this.getComboBoxValue("logLevel");g={filter_keyword:b,filter_level:a,filter_date_from:i?new Date(i+" 00:00:00").getTime()/1000:0,filter_date_to:h?new Date(h+" 23:59:59").getTime()/1000:0};this.fireEvent("search",this,g)},onReset:function(){this.form.items.each(function(a){if(a.isDirty()){this.frameAnimation(a.el,this.defaultAnimation)}},this);this.setMsg("");this.form.reset();this.form.findField("searchdatefrom").setMaxValue(null);this.form.findField("searchdateto").setMinValue(null);this.form.findField("logLevel").multiValue=""}});Ext.define("SYNO.SDS.Backup.Comp.TextItem",{extend:"Ext.Toolbar.TextItem",onRender:function(b,a){this.autoEl={cls:"xtb-text",html:this.text||"","ext:qtip":this.text||""};SYNO.SDS.Backup.Comp.TextItem.superclass.onRender.call(this,b,a)},setText:function(a){SYNO.SDS.Backup.Comp.TextItem.superclass.setText.call(this,a);if(this.rendered){this.el.set({"ext:qtip":a})}}});Ext.reg("lctbtext",SYNO.SDS.Backup.Comp.TextItem);Ext.define("SYNO.SDS.Backup.BaseLogUI",{extend:"Ext.Panel",itemsPerPage:1000,logType:[["syslog",_T("log","log_link_system")]],title:_T("tree","leaf_log"),itemId:"logPanel",appInst:undefined,baseURL:undefined,topwin:undefined,store:undefined,columnModel:undefined,constructor:function(a){Ext.copyTo(this,a,["listeners","baseURL","topwin","appInst","logType","title","itemId","jsConfig"]);this.cgiHandler=this.baseURL+"/LogViewer.cgi";this.store=a.ds;this.columnModel=a.cm;this.itemsPerPage=a.appInst.appInstance.getUserSettings(this.itemId+"-dsPageLimit")||this.itemsPerPage;Ext.apply(a,this);this.callParent([a]);this.mon(this,"resize",function(b,d,c){this.updateFbarItems(d)},this)},getPageRecordStore:function(){var a=new Ext.data.SimpleStore({fields:["value","display"],data:[[100,100],[500,500],[1000,1000],[3000,3000]]});return a},initPageComboBox:function(a){var b=new SYNO.ux.ComboBox({name:"page_rec",hiddenName:"page_rec",hiddenId:Ext.id(),store:a,displayField:"display",valueField:"value",triggerAction:"all",value:this.itemsPerPage,editable:false,width:72,mode:"local",listeners:{select:{fn:this.onChangeDisplayRecord,scope:this}}});return b},initPagingToolbar:function(){var a=new SYNO.ux.PagingToolbar({store:this.store,displayInfo:true,pageSize:this.itemsPerPage,showRefreshBtn:true,items:["-",_T("common","items_perpage"),this.initPageComboBox(this.getPageRecordStore()),"-",{xtype:"tbtext",text:"",itemId:"infoLevel"},"-",{xtype:"tbtext",text:"",itemId:"warnLevel"},"-",{xtype:"tbtext",text:"",itemId:"errorLevel"},"-"]});return a},initSearchForm:function(){var a=new SYNO.SDS.Backup.SearchFormPanel({cls:"syno-sds-fs-search-panel",renderTo:Ext.getBody(),shadow:false,jsConfig:this.jsConfig,hidden:true,owner:this,logType:this.logType});return a},initComponent:function(){this.searchPanel=this.initSearchForm();this.paging=this.initPagingToolbar();this.grid=new SYNO.ux.GridPanel({view:new SYNO.ux.FleXcroll.grid.BufferView({rowHeight:27,scrollDelay:30,borderHeight:1}),region:"center",store:this.store,bbar:this.paging,colModel:this.columnModel,loadMask:true,stripeRows:true});Ext.apply(this,{itemId:this.itemId,border:false,header:false,layout:"border",items:[this.grid]});this.callParent([this])},getInfoCompoent:function(){return this.paging.getComponent("infoLevel")},getWarnCompoent:function(){return this.paging.getComponent("warnLevel")},getErrorCompoent:function(){return this.paging.getComponent("errorLevel")},updateFbarItems:function(b){var a=0;if(!this.isVisible()){return}if(b<880){for(a=16;a<23;a++){this.paging.items.get(a).hide()}}else{for(a=16;a<23;a++){this.paging.items.get(a).show()}}}});Ext.define("SYNO.SDS.Backup.BaseLog",{extend:"SYNO.SDS.Backup.BaseLogUI",searchBuffer:200,constructor:function(a){this.callParent([a]);this.searchBuffer=a.searchBuffer||this.searchBuffer},initEvents:function(){this.mon(this.searchPanel,"search",this.onSearch,this,{buffer:this.searchBuffer});this.mon(this,"activate",this.onActive,this);this.mon(this.grid.getStore(),"load",this.onAfterStoreLoad,this);this.mon(this.grid.getStore(),"beforeload",this.onBeforeStoreLoad,this)},onChangeDisplayRecord:function(c,d,b){var a=this.grid.getStore();if(this.itemsPerPage!==c.getValue()){this.itemsPerPage=c.getValue();this.paging.pageSize=this.itemsPerPage;a.load({params:{start:0,limit:this.itemsPerPage}});this.appInst.appInstance.setUserSettings(this.itemId+"-dsPageLimit",this.itemsPerPage)}},getLogTypes:function(a){var b=[];this.logType.each(function(c){b.push(c[0])});return b.join(a||",")},isTheSame:function(b,a){var c;for(c in a){if(a[c]!==b[c]){return false}}return true},onSearch:function(b,c){var a=this.grid.getStore();if(!this.isTheSame(a.baseParams,c)){Ext.apply(a.baseParams,c);this.loadData()}},onActive:function(){var a=this.grid.getStore(),b={datefrom:0,dateto:0,keyword:"",loglevel:""};Ext.applyIf(a.baseParams,b);if(this.requestLogType){Ext.apply(a.baseParams,{logtype:this.requestLogType})}this.loadData();delete this.requestLogType},searchLogType:function(a){},loadData:function(){var a=this.grid.getStore(),b={start:0,limit:this.itemsPerPage};a.load({params:b})},onBeforeStoreLoad:function(a,b){this.grid.getGridEl().unmask()},onAfterStoreLoad:function(a,e,c){var d,b;if(e.length<1){this.grid.getGridEl().mask(_T("log","no_log_available"))}else{this.grid.getGridEl().unmask()}d=a.reader.jsonData;b='<div class="{0}" style="width:40px;" ext:qtip="{1}">{2}</div>';this.setLogLevelText(this.getInfoCompoent(),b,"syno-log-info",_T("log","info_level"),d.info_count);this.setLogLevelText(this.getWarnCompoent(),b,"syno-log-warn",_T("log","warn_level"),d.warn_count);this.setLogLevelText(this.getErrorCompoent(),b,"syno-log-err",_T("log","error_level"),d.error_count);this.setPagingToolbar(a,this.grid,this.paging)},setPagingToolbar:function(a,b,c){this.setPagingToolbarVisible(c,a.getTotalCount()>this.itemsPerPage)},setPagingToolbarVisible:function(b,c){var a=0;for(a=0;a<13;a++){if(a===9||a===10||a===11){continue}b.items.items[a].setVisible(c)}b.setButtonsVisible(true)},setLogLevelText:function(b,a,c,e,d){if(b){d=d||"0";b.setText(String.format(a,c,e,d))}},doSearchFormLayout:function(){this.doLayout()},onExportCSV:function(){this.onLogSave("csv")},onExportHtml:function(){this.onLogSave("html")},onLogSave:function(a){if(_S("demo_mode")){this.appInst.getMsgBox().alert(this.appInst.title,_JSLIBSTR("uicommon","error_demo"));return}this.saveLog(a)},saveLog:function(f){var k=this.grid.getStore();var d="LOCAL";var l="backup,netbackup,usbcopy";var i=k.sortInfo.field;var e=k.baseParams.loglevel;var b=k.baseParams.keyword;var g=k.baseParams.datefrom;var j=k.baseParams.dateto;var a=k.baseParams.offset;var h=f;if(k.baseParams.filter_level){var c=k.baseParams.filter_level;if("1"===c){e="info"}else{if("2"===c){e="warning"}else{if("3"===c){e="err"}else{e=""}}}}if(k.baseParams.filter_keyword){b=k.baseParams.filter_keyword}if(k.baseParams.filter_date_from){g=k.baseParams.filter_date_from}if(k.baseParams.filter_date_to){j=k.baseParams.filter_date_to}this.appInst.downloadWebAPI({webapi:{api:"SYNO.Core.SyslogClient.Log",version:1,method:"export",params:{target:d,logtype:l,offset:a,sort:i,level:e,date_from:g,date_to:j,keyword:b,format:h}}})},onLogClear:function(){if(_S("demo_mode")){this.appInst.getMsgBox().alert(this.appInst.title,_JSLIBSTR("uicommon","error_demo"));return}this.topwin.getMsgBox().confirm(_T("tree","leaf_log"),_T("log","log_cfrm_clear"),function(a,b){if(a==="yes"){this.clearLog()}},this)},clearLog:function(){var a=this.grid.getStore();a.load({params:{action:"clear",logtype:this.getLogTypes()}})},destroy:function(){if(this.rowNav){Ext.destroy(this.rowNav);this.rowNav=null}this.callParent([this])}});Ext.define("SYNO.SDS.Backup.LogsPage",{extend:"SYNO.ux.Panel",constructor:function(a){Ext.apply(this,a);var b=this.fillConfig(a);this.callParent([b])},enableExportButton:function(a){this.ExportButton.setDisabled(!a)},initToolbar:function(){var a=new SYNO.ux.Toolbar();this.ExportButton=new SYNO.ux.SplitButton({xtype:"syno_splitbutton",text:_TT("SYNO.SDS.LogCenter.Instance","logview","btn_export"),handler:this.onExportHtml,scope:this,menu:{items:[{text:_T("log","html_type"),handler:this.onExportHtml,scope:this},{text:_T("log","csv_type"),handler:this.onExportCSV,scope:this}]}});this.SearchField=new SYNO.SDS.Backup.AdvancedSearchField({iconStyle:"filter",owner:this});this.SearchField.searchPanel=this.generalLog.searchPanel;a.add(this.ExportButton);a.add("->");a.add(this.SearchField);return a},fillConfig:function(b){var d;var a={};a={jsConfig:this.jsConfig,baseURL:this.jsConfig.jsBaseURL,topwin:this,appInst:this.appWin};d=new SYNO.SDS.Backup.GeneralLogBuilder();this.generalLog=d.create(Ext.apply({},a));var c={title:_T("log","log_link_backup"),border:false,trackResetOnLoad:true,tbar:this.initToolbar(),layout:"fit",activeItem:0,items:[this.generalLog]};Ext.apply(c,b);return c},onPageActivate:function(){this.generalLog.onActive()},onExportHtml:function(){this.generalLog.onExportHtml()},onExportCSV:function(){this.generalLog.onExportCSV()}});Ext.define("SYNO.SDS.Backup.GeneralLogBuilder",{extend:"Object",create:function(e){var d=[["syslog",_T("log","log_link_system")]],h=_T("log","backup"),g="backup",c="backup";var b=this.getStore();var f=this.getColumnModel();var a={logType:d,title:h,itemId:g,fileTitle:c,ds:b,cm:f};Ext.applyIf(e,a);return new SYNO.SDS.Backup.BaseLog(e)},getStore:function(a){var b=new SYNO.API.Store({api:"SYNO.Backup.Log",version:1,method:"list",baseParams:{offset:0,limit:-1},appWindow:false,autoLoad:true,sortInfo:{field:"time",direction:"DESC"},remoteSort:false,reader:new Ext.data.JsonReader({idProperty:"id",root:"log_list",totalProperty:"total",fields:[{name:"level",mapping:"level"},{name:"log_type",mapping:"log_type"},{name:"time",mapping:"time"},{name:"user",mapping:"user"},{name:"event",mapping:"event"}]})});return b},logLevelRenderer:function(a){switch(a){case"emerg":case"alert":case"crit":case"err":return"<span class='red-status'>Error</span>";case"warn":case"warning":case"notice":return"<span class='orange-status'>Warning</span>";case"info":case"debug":return"<span class='green-status'>Information</span>";default:return"Undefined"}},htmlEncodeRender:function(c,b){var a=Ext.util.Format.htmlEncode(c);b.attr='ext:qtip="'+Ext.util.Format.htmlEncode(a)+'"';return a},getColumnModel:function(){var a=new Ext.grid.ColumnModel({columns:[{menuText:_T("log","logattr"),header:_TT("SYNO.SDS.LogCenter.Instance","logattr","attr_priority"),dataIndex:"level",width:100,align:"center",renderer:this.logLevelRenderer},{header:_T("log","log_time"),dataIndex:"time",width:150,align:"center",renderer:this.htmlEncodeRender},{header:_T("log","log_account"),dataIndex:"user",width:100,align:"center",renderer:this.htmlEncodeRender},{id:"descr",header:_T("log","log_action"),dataIndex:"event",css:"white-space:normal;",width:300,renderer:this.htmlEncodeRender}],defaults:{sortable:false,menuDisabled:false}});return a}});Ext.define("SYNO.SDS.Backup.ApiHelper",{extend:"Object",owner:null,title:"",defaultErrorSec:"common",defaultErrorKey:"error_system",getDefaultErrorMsg:function(){return _T(this.defaultErrorSec,this.defaultErrorKey)},constructor:function(a){Ext.apply(this,a);if(this.owner&&!this.title){this.title=this.owner.title}},send:function(b,c,a){if(typeof b!=="object"){return false}if(b instanceof Array){this.sendCompound(b,c,a)}else{this.sendSingle(b,c,a)}},sendCompound:function(e,g,c){var d=this;if(!Ext.isFunction(g)){g=Ext.emptyFn}var a={count:0,callback:g,scope:c,api:[]};function f(h){if(h.api){return"_"+h.api+Ext.encode(h.params)}else{if(h.compound){return"_compound"+Ext.encode(h.compound)}else{if(h.url){return"_"+h.url+Ext.encode(h.params)}}}}function b(i,k,h){var j=f(i);a[j]={};if(i.callback){a[j].callback=i.callback.createDelegate(i.scope||window)}if(i.api||i.compound){i.callback=function(l,n,m){a[j].success=l;a[j].response=n;a[j].options=m;a[j].request.callback=null;a.count-=1;k.call(h,a)};delete i.scope}else{if(i.url){if(!Ext.isDefined(i.method)){i.method="POST"}i.callback=function(m,l,o){var n=d.parseAjaxResponse(m,l,o);a[j].success=!!(l&&n.success);a[j].response=n;a[j].options=m;a[j].request.callback=null;a.count-=1;k.call(h,a)};delete i.scope}else{return false}}a[j].request=i;a.api.push(j);return j}Ext.each(e,function(h){var i=Ext.apply({},h);var j;j=b(i,d.sendCompoundHandler,d);if(!j){return true}if(i.api||i.compound){if(!d.owner.sendWebAPI(i)){a[j].success=false;a[j].response={success:false,error:{code:102}};return true}}else{if(i.url){Ext.Ajax.request(i)}}a.count+=1})},sendCompoundHandler:function(a){var c=0;var b={result:[]};if(a.count!==0){return}Ext.each(a.api,function(f){var e=a[f];var d=e.response;if(e.callback){e.callback(e.success,d,e.options)}if(!e.success){c+=1}if(e.request.api){Ext.copyTo(d,e.request,"api,method,version")}else{Ext.copyTo(d,e.request,"url,params")}b.result.push(d)});b.has_fail=(c>0);if(a.callback){a.callback.call(a.scope||window,c!==a.api.length,b)}},sendSingle:function(c,e,a){var b=this;var d=Ext.emptyFn;if(c.callback){d=c.callback.createDelegate(c.scope||window)}if(!Ext.isFunction(e)){e=Ext.emptyFn}if(c.api||c.compound){c.callback=function(h,f,g){d(h,f,g);e.call(a,h,f,g)};this.owner.sendWebAPI(c)}else{if(!Ext.isDefined(c.method)){c.method="POST"}c.callback=function(h,f,g){var i=b.parseAjaxResponse(h,f,g);var j=(f&&i.success);d(j,i,h);e.call(a,j,i,h)};delete c.scope;Ext.Ajax.request(c)}},alert:function(a,e,b){var d=this.title,c=this.getDefaultErrorMsg();if(!a){}else{if(typeof a==="string"){c=a}else{if(typeof a==="number"){c=SYNO.SDS.Backup.GetErrorString(a)}else{if(a instanceof Array){Ext.each(a,function(f){if(!f.success){c=SYNO.SDS.Backup.GetErrorString(f.error.code);return false}})}else{if(typeof a==="object"){c=this.getResponseErrorMsg(a)}}}}}this.owner.getMsgBox().alert(d,c,e,b)},getResponseErrorMsg:function(a){var c=this.getDefaultErrorMsg();if(Ext.isDefined(a.code)){c=SYNO.SDS.Backup.GetErrorString(a.code)}else{if(Ext.isDefined(a.result)&&Ext.isDefined(a.has_fail)){Ext.each(a.result,function(d){if(!d.success){if(Ext.isDefined(d.code)){c=SYNO.SDS.Backup.GetErrorString(d.error.code)}else{if(Ext.isDefined(d.errinfo)){try{c=_T(d.errinfo.sec,d.errinfo.key)}catch(f){}}else{if(Ext.isDefined(d.errno)){try{c=_T(d.errno.sec,d.errno.key)}catch(f){}}}}return false}})}else{if(Ext.isDefined(a.errinfo)){try{c=_T(a.errinfo.sec,a.errinfo.key)}catch(b){}}else{if(Ext.isDefined(a.errno)){try{c=_T(a.errno.sec,a.errno.key)}catch(b){}}}}}return c},parseAjaxResponse:function(b,f,a){var c={success:false,errinfo:{sec:this.defaultErrorSec,key:this.defaultErrorKey}};try{c=Ext.util.JSON.decode(a.responseText)}catch(d){}return c}});Ext.define("SYNO.SDS.Backup.ComboBox",{extend:"SYNO.ux.ComboBox",owner:null,initComponent:function(){this.callParent(arguments);if(Ext.isObject(this.getParams)&&Ext.isFunction(this.getParams.handler)){this.getParams.scope=this.getParams.scope||this;this.getParams=Ext.createDelegate(this.getParams.handler,this.getParams.scope)}},initList:function(){if(!this.tpl){this.tpl='<tpl for="."><div ext:qtip="{qtip:htmlEncode}" class="x-combo-list-item {cls:htmlEncode}">{'+Ext.util.Format.htmlEncode(this.displayField)+":htmlEncode}</div></tpl>"}this.callParent(arguments);if(Ext.isFunction(this.prepareData)){this.view.prepareData=this.prepareData}if(this.store&&this.owner){this.mon(this.store,"beforeload",function(){this.owner.setStatusBusy()},this);this.mon(this.store,"load",function(b,a,c){this.owner.clearStatusBusy();this.cacheAPIParam=Ext.encode(c.params)},this);this.mon(this.store,"exception",function(c,d,e,b,a){this.owner.clearStatusBusy();this.owner.reportError(a)},this)}this.mon(this,"beforeselect",this.onBeforeSelect,this)},getParams:function(){return{}},onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.isExpanded()){this.collapse()}else{this.onFocus({});var a=this.getParams();if(this.cacheAPIParam===Ext.encode(a)){this.expand()}else{this.store.load({params:a})}}this.el.focus()},onBeforeLoad:function(){if(!this.hasFocus){return}this.selectedIndex=-1},onBeforeSelect:function(c,a,b){return !a.get("disable")}});Ext.define("SYNO.SDS.Backup.Addon.Util.S3.Repository.CreateBucket",{extend:"SYNO.SDS.ModalWindow",dsmStyle:"v5",constructor:function(c){var f=450,a=200;this.s3key=c.s3key;this.s3secret=c.s3secret;this.support_region=c.support_region;this.region_system=c.region_system;this.addon_id=c.addon_id;var d=[{xtype:"syno_textfield",name:"bucket",allowBlank:false,fieldLabel:_T("backup","s3_bucket"),owner:this}];if(this.support_region){var b="";if(this.region_system==="s3_china"){b="cn-north-1"}d.push({xtype:"syno_combobox",name:"region",fieldLabel:_T("backup","netbkp_s3_select_region"),store:this.getRegionStore(),displayField:"region",valueField:"value",value:b,owner:this})}var e=Ext.apply({title:_T("backup","s3_create_bucket"),width:f,height:a,minWidth:f,minHeight:a,layout:"fit",items:[{xtype:"syno_formpanel",trackResetOnLoad:true,itemId:"form_panel",items:d}],buttons:[{itemId:"btn_apply",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.onCreate},{text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},c);return this.callParent([e])},getRegionStore:function(){if(!this.support_region){return undefined}var a=[[_T("backup","s3_region_us_east_virginia"),""],[_T("backup","s3_region_us_west_california"),"us-west-1"],[_T("backup","s3_region_us_west_oregon"),"us-west-2"],[_T("backup","s3_region_eu_ireland"),"eu-west-1"],[_T("backup","s3_region_eu_frankfurt"),"eu-central-1"],[_T("backup","s3_region_asia_tokyo"),"ap-northeast-1"],[_T("backup","s3_region_asia_singapore"),"ap-southeast-1"],[_T("backup","s3_region_asia_sydney"),"ap-southeast-2"],[_T("backup","s3_region_south_america_sao_paulo"),"sa-east-1"]];if(this.region_system==="s3_china"){a=[[_T("backup","s3_region_china_beijing"),"cn-north-1"]]}if(!this.regionStore){this.regionStore=new Ext.data.ArrayStore({fields:["region","value"],data:a})}return this.regionStore},onCreate:function(){if(!this.items.get(0).getForm().isValid()){return}this.setStatusBusy();var a={key:this.s3key,secret:this.s3secret,transfer_type:this.addon_id,bucket:this.items.get(0).getForm().findField("bucket").getValue()};if(this.support_region){a.region=this.items.get(0).getForm().findField("region").getValue();a.region_system=this.region_system}this.sendWebAPI({api:"SYNO.Backup.Storage.S3.Bucket",version:1,method:"create",params:a,scope:this,callback:function(e,b,c){var d;if(this.support_region){this.items.get(0).getForm().findField("region").getValue()}var f=this.items.get(0).getForm().findField("bucket").getValue();this.clearStatusBusy();if(!e){this.showPossibleBucketError(b.code,f,d);return false}this.close()}})},showPossibleBucketError:function(b,e,c){if(this.customizedBucketErrorFilter&&Ext.isFunction(this.customizedBucketErrorFilter)){return this.customizedBucketErrorFilter(b,e,c)}var d="";var a=/([1-9][0-9]{0,1}|1[013-9][0-9]|12[0-689]|2[01][0-9]|22[0-3])([.]([1-9]{0,1}[0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])){2}[.]([1-9][0-9]{0,1}|1[0-9]{2}|2[0-4][0-9]|25[0-5])/;if(!e.match(/^[a-z0-9\.-]*$/)){d=d.concat("<BR>- ",_T("netbackup","s3_bucket_name_non_us_standard_letter_limit"))}if(!e.match(/^[a-z0-9]/)||!e.match(/[a-z0-9]$/)){d=d.concat("<BR>- ",_T("netbackup","s3_bucket_name_leading_letter_limit"))}if(3>e.length||63<e.length){d=d.concat("<BR>- ",String.format(_T("netbackup","s3_bucket_name_length_limit"),"3","63"))}if(e.match(a)){d=d.concat("<BR>- ",_T("netbackup","s3_bucket_name_ip_limit"))}if(e.match(/\.-/)||e.match(/-\./)){d=d.concat("<BR>- ",_T("netbackup","s3_bucket_name_period_limit"))}if(d.length>0){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("netbackup","s3_bucket_name_invalid_short")+" "+_T("netbackup","s3_bucket_name_meet_condition")+" "+_T("common","colon")+d);return}if(b===SYNO.SDS.Backup.ERR_BUCKET_NAME_INVALID_CHAR||b===SYNO.SDS.Backup.ERR_INVALID_ARGUMENT){d=_T("netbackup","s3_bucket_name_invalid_short");this.getMsgBox().alert(_T("tree","leaf_backup"),d);return}d=SYNO.SDS.Backup.GetErrorString(b);this.getMsgBox().alert(_T("tree","leaf_backup"),d);return}});Ext.define("SYNO.SDS.Backup.Addon.Util.S3.Repository.CreateStep",{extend:"SYNO.SDS.Backup.FormPanel",constructor:function(a){this.addon_id=a.addon_id;this.support_region=a.support_region?a.support_region:false;var c=Ext.apply({items:[{xtype:"syno_fieldset",title:SYNO.SDS.Backup.Addon.GetStr(this.addon_id,"addon","repo_wizard_headline"),collapsible:false,defaults:{labelWidth:300},items:[{xtype:"syno_textfield",name:"name",value:SYNO.SDS.Backup.Addon.GetStr(this.addon_id,"addon","repo_name_prefix")||"My Storage",allowBlank:false,fieldLabel:_T("backup","repo_name"),maxLength:32,vtype:"backup_destination"},{xtype:"syno_compositefield",hidden:!this.support_region,fieldLabel:_T("backup","s3_region_system"),width:225,name:"region_system_global",items:[{xtype:"syno_radio",boxLabel:_T("backup","s3_region_system_global"),name:"region_system",width:220,inputValue:"s3_global",checked:true}]},{xtype:"syno_compositefield",hidden:!this.support_region,fieldLabel:"&nbsp;",labelSeparator:"",width:225,items:[{xtype:"syno_radio",boxLabel:_T("backup","s3_region_system_china"),name:"region_system",width:220,inputValue:"s3_china"}]},{xtype:"syno_textfield",name:"key",allowBlank:false,fieldLabel:_T("backup","s3_access_key")},{xtype:"syno_textfield",name:"secret",allowBlank:false,inputType:"password",fieldLabel:_T("backup","s3_secret_key")},{xtype:"syno_combobox",name:"bucket",fieldLabel:_T("netbackup","netbkp_s3_select_bucket"),store:this.getBucketStore(),displayField:"bucket",allowBlank:false,valueField:"bucket",scope:this,emptyText:_T("netbackup","s3_bucket_empty_text"),onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadBucket()){this.scope.loadBucketStore()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},listeners:{select:function(f,d,e){if(e===0){this.createBucket();return}},beforeselect:function(e,d,f){if(d.get("status")>0){return false}},scope:this},tpl:'<tpl for="."><div ext:qtip="{[Ext.util.Format.htmlEncode(values.status === 1 ? String.format(_T("backup", "repo_already_exist") + " [" + values.conflict_repo + "]") : values.bucket)]}" class="x-combo-list-item {[values.status === 1 ? "syno-backup-disabled-list-item" : "syno-backup-enabled-list-item"]}">{bucket:htmlEncode}</div></tpl>'}]}]},a);var b=this.callParent([c]);this.mon(this,"activate",function(){var d=this.getForm().findField("region_system_global").items.get(0);SYNO.SDS.Utils.AddTip(d.getEl(),_T("backup","s3_region_system_global_hint"))},this,{single:true});return b},createBucket:function(){var b={s3key:this.getForm().findField("key").getValue(),s3secret:this.getForm().findField("secret").getValue(),addon_id:this.addon_id,support_region:this.support_region,owner:this.owner};if(this.support_region){b.region_system=this.getForm().findField("region_system").getGroupValue()}var a=new SYNO.SDS.Backup.Addon.Util.S3.Repository.CreateBucket(b);this.mon(a,"close",function(){var c=a.items.get(0).getForm().findField("bucket").getValue();this.getForm().findField("bucket").clearValue();this.loadBucketStore(c)},this);a.open()},getBucketStore:function(){if(!this.bucketStore){this.bucketStore=new Ext.data.ArrayStore({fields:["bucket","status","conflict_repo"]})}return this.bucketStore},getLoadBucketParams:function(){var a=this.getForm(),b=function(d){return a.findField(d).getValue()};var c={key:b("key"),secret:b("secret"),transfer_type:this.addon_id};if(this.support_region){c.region_system=this.getForm().findField("region_system").getGroupValue()}return c},needReloadBucket:function(){var a=this.getLoadBucketParams();return this.lastQuery!==Ext.encode(a)},loadBucketStore:function(a){var b=this.getLoadBucketParams();if(!b.key||!b.secret){return}this.owner.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Storage.S3.Bucket",version:1,method:"list",params:b,scope:this,callback:function(h,c,d){var g=this.getForm().findField("bucket");var e=new Ext.data.Record.create(["bucket","status","conflict_repo"]);var f=new e({bucket:_T("backup","s3_create_bucket"),status:0,conflict_repo:""});this.owner.clearStatusBusy();if(!h){this.owner.reportError(c);return}this.lastQuery=Ext.encode(b);this.getBucketStore().loadData(c.bucket_list);this.getBucketStore().insert(0,f);if(a&&-1!==this.getBucketStore().findExact("bucket",a)&&0===this.getBucketStore().getAt(this.getBucketStore().findExact("bucket",a)).get("status")){g.setValue(a);return}g.el.focus();g.expand();g.restrictHeight()}})},activate:function(){this.getForm().setValues({name:this.owner.createRepoDefaultName(SYNO.SDS.Backup.Addon.GetStr(this.addon_id,"addon","repo_name_prefix")||"My Storage")})},getParams:function(){var a={};a=this.getForm().getFieldValues();a.target_type="cloud";a.transfer_type=this.addon_id;a.repo_name=a.name;if(this.support_region){a.region_system=this.getForm().findField("region_system").getGroupValue()}delete a.name;return a},getNext:function(){if(!this.getForm().isValid()){return false}return this.nextId},isValid:function(){return this.getForm().isValid()}});Ext.define("SYNO.SDS.Backup.Addon.Util.S3.Repository.EditDialog",{extend:"SYNO.SDS.ModalWindow",constructor:function(a){this.transferType=a.addon_id;this.targetType="cloud";var b=Ext.apply({title:_T("common","alt_edit"),width:460,height:300,layout:"fit",closable:true,items:[{xtype:"syno_formpanel",trackResetOnLoad:true,itemId:"edit_panel",items:this.createItems()}],buttons:[{xtype:"syno_button",text:_T("common","apply"),btnStyle:"blue",scope:this,handler:this.applySetting},{xtype:"syno_button",text:_T("common","cancel"),handler:function(){this.close()},scope:this}]},a);return this.callParent([b])},getPanel:function(){return this.getComponent("edit_panel")},createItems:function(){var a=[{xtype:"syno_textfield",name:"name",width:200,allowBlank:false,fieldLabel:_T("backup","repo_name"),maxLength:32,vtype:"backup_destination"}];return a},onOpen:function(){this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"get",params:{repo_id:this.repoId},callback:function(c,a,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}this.getPanel().getForm().setValues(a);this.orgName=a.name},scope:this});return this.callParent(arguments)},onClose:function(){return this.callParent(arguments)},applySetting:function(){var a=this.getPanel().getForm();var b=a.getFieldValues(true);if(!a.isValid()){return false}if(!a.isDirty()){this.close();return true}if(Ext.isDefined(b.name)&&!this.isNameValid(b.name)){this.getMsgBox().alert(_T("tree","leaf_backup"),_T("backup","repo_name_duplicate"));return false}b.repo_id=this.repoId;b.transfer_type=this.transferType;b.target_type=this.targetType;this.setStatusBusy();this.sendWebAPI({api:"SYNO.Backup.Repository",version:1,method:"set",params:b,callback:this.onApplyDone,scope:this})},isNameValid:function(a){return this.orgName===a||-1===this.repoList.findExact("name",a)},onApplyDone:function(c,a,b){this.clearStatusBusy();if(!c){this.getMsgBox().alert(_T("leaf","backup"),SYNO.SDS.Backup.GetErrorString(a.code));return}this.close()}});Ext.define("SYNO.SDS.Backup.Addon.Util.S3.Restore.DestStep",{extend:"SYNO.ux.FormPanel",S3_BUCKET_LENGTH:63,constructor:function(b){var a=[];Ext.copyTo(this,b,"owner");this.support_region=b.support_region;this.configFields(a);this.callParent([Ext.apply({trackResetOnLoad:true,items:[{xtype:"syno_fieldset",title:SYNO.SDS.Backup.Addon.GetStr(b.addon_id,"addon","restore_wizard_headline"),defaults:{labelWidth:300},items:a}]},b)]);this.mon(this,"activate",function(){var c=this.getForm().findField("region_system_global").items.get(0);SYNO.SDS.Utils.AddTip(c.getEl(),_T("backup","s3_region_system_global_hint"))},this,{single:true})},configFields:function(a){a.push({xtype:"syno_compositefield",fieldLabel:_T("backup","s3_region_system"),hidden:!this.support_region,width:225,name:"region_system_global",items:[{xtype:"syno_radio",boxLabel:_T("backup","s3_region_system_global"),name:"region_system",width:220,inputValue:"s3_global",checked:true}]},{xtype:"syno_compositefield",fieldLabel:"&nbsp;",labelSeparator:"",hidden:!this.support_region,width:225,items:[{xtype:"syno_radio",boxLabel:_T("backup","s3_region_system_china"),name:"region_system",width:110,inputValue:"s3_china"}]},{xtype:"syno_textfield",fieldLabel:_T("backup","s3_access_key"),name:"accesskey",width:200,allowBlank:false},{xtype:"syno_textfield",fieldLabel:_T("backup","s3_secret_key"),name:"secretkey",width:200,inputType:"password",allowBlank:false},{xtype:"syno_combobox",name:"bktselect",fieldLabel:_T("netbackup","netbkp_s3_select_bucket"),emptyText:_T("netbackup","netbkp_s3_select_bucket"),store:new Ext.data.ArrayStore({fields:["value"]}),forceSelection:false,valueField:"value",displayField:"value",allowBlank:false,triggerAction:"all",mode:"local",maxlength:this.S3_BUCKET_LENGTH,onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadBuckets()){this.scope.loadBuckets()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},listeners:{select:this.onSelectBucket,scope:this},scope:this,tpl:'<tpl for="."><div class="x-combo-list-item">{value:htmlEncode}</div></tpl>'},{xtype:"syno_combobox",fieldLabel:_T("backup","backup_dest_directory"),name:"target",forceSelection:true,editable:false,allowBlank:false,store:new Ext.data.JsonStore({root:"target_list",idProperty:"target_id",fields:["target_id","support_multi_version"]}),displayField:"target_id",valueField:"target_id",triggerAction:"all",mode:"local",onTriggerClick:function(){if(this.readOnly||this.disabled){return}if(this.scope.needReloadTarget()){this.scope.loadTarget()}else{SYNO.ux.ComboBox.prototype.onTriggerClick.call(this,arguments)}},scope:this,tpl:'<tpl for="."><div class="x-combo-list-item">{target_id:htmlEncode}</div></tpl>'})},onSelectBucket:function(a){this.loadTarget(a.getValue())},activate:function(){},getNext:function(){if(!this.getForm().isValid()){return false}if(!this.getForm().isDirty()){return this.nextId}var a=this.getForm().findField("target");var b=a.getStore().getById(a.getValue());if(b.get("support_multi_version")){this.owner.setSingle(false);return this.nextId}else{this.testConnection();return false}},getParams:function(){var a=this.getForm(),b=function(d){return a.findField(d).getValue()};var c={accesskey:b("accesskey"),secretkey:b("secretkey"),bucketname:b("bktselect"),providername:this.provider,destDirectory:b("target"),rcvrfolder:b("target"),macfolder:b("target"),key:b("accesskey"),secret:b("secretkey"),bucket:b("bktselect"),target_id:b("target"),target_type:"cloud",transfer_type:this.addon_id};if(this.support_region){c.region_system=this.getForm().findField("region_system").getGroupValue()}return c},summary:function(a){var b=this.getParams();a.append(_T("backup","restore_type"),_T("backup","cloud_restore"));a.append(_T("netbackup","netbkp_slct_server"),SYNO.SDS.Backup.Addon.GetStr(this.addon_id,"addon","name"));a.append(_T("backup","backup_restore_source"),b.bucketname+"/"+b.destDirectory)},getListBucketRequest:function(){var a=Ext.copyTo({},this.getParams(),"key,secret,transfer_type,region_system");delete a.accesskey;delete a.secretkey;delete a.bucketname;delete a.providername;delete a.destDirectory;delete a.rcvrfolder;delete a.macfolder;return a},needReloadBuckets:function(){var a=this.getListBucketRequest();return this.lastQueryModule!==Ext.encode(a)},loadBuckets:function(){var a=this.getListBucketRequest();if(!a.key||!a.secret){return}this.owner.setStatusBusy({text:_T("netbackup","s3_retrieve_bucket")});this.sendWebAPI({api:"SYNO.Backup.Storage.S3.Bucket",version:1,method:"list",params:a,scope:this,callback:function(d,b,c){this.owner.clearStatusBusy();if(!d){this.loadBucketsData();this.owner.reportError(b);delete this.lastQueryModule;return}this.lastQueryModule=Ext.encode(a);this.loadBucketsData(b)}})},loadBucketsData:function(b){var a=this.getForm().findField("bktselect");return SYNO.SDS.Backup.Util.comboboxLoadData(a,b?b.bucket_list:[],0)},getLoadTargetParams:function(){var a=this.getParams();delete a.target_id;delete a.accesskey;delete a.secretkey;delete a.bucketname;delete a.providername;delete a.destDirectory;delete a.rcvrfolder;delete a.macfolder;return a},needReloadTarget:function(){var a=this.getLoadTargetParams();return this.lastQueryTarget!==Ext.encode(a)},loadTarget:function(b){var a=this.getLoadTargetParams();if(!a.key||!a.secret||!a.bucket){return}if(this.lastQueryTarget===Ext.encode(a)){return}this.lastQueryTarget=Ext.encode(a);this.owner.setStatusBusy({text:_T("backup","search_restore_folder")});this.owner.api.send({api:"SYNO.Backup.Target",method:"find",version:1,params:a,callback:function(e,c,d){this.owner.clearStatusBusy();if(!e){this.owner.api.alert(c);this.loadTargetData({target_list:[]});delete this.lastQueryTarget;return}this.lastQueryTarget=Ext.encode(a);this.loadTargetData(c);if(!c.target_list||c.target_list.length<1){this.owner.api.alert(_T("backup","no_available_target"))}},scope:this})},loadTargetData:function(b){var a=this.getForm().findField("target");if(!b||!b.target_list||b.target_list.length<1){a.getStore().removeAll();a.setValue("");return false}a.getStore().loadData(b,false);a.setValue(b.target_list[0].target_id);return true},testConnection:function(){var a=this.getParams();this.owner.setStatusBusy({text:_T("netbackup","netbkp_connection_testing")});this.sendWebAPI({api:"SYNO.Backup.Storage.S3.Bucket",version:1,method:"list",params:a,scope:this,callback:function(e,b,c){var d=this.getForm();this.owner.clearStatusBusy();if(!e){this.owner.reportError(b);return}this.owner.setSingle(true);this.owner.goNext(this.nextId);d.setValues(d.setValues())}})}});Ext.define("SYNO.SDS.Backup.ScheduleBackupWidget",{extend:"SYNO.SDS._Widget.GridPanel",constructor:function(a){this.NUM_REC_PER_PAGE=2;this.callParent(arguments)},initEvents:function(){this.callParent(arguments);this.mon(this,"beforedestroy",this.onDeactivateScheduleView,this,{single:true})},onActivateScheduleDone:function(d,b,c,a){if(d){this.ProcessBackupStatus(b.task_list)}},onStartPolling:function(){this.pollingID=this.pollReg({webapi:{api:"SYNO.Backup.Task",version:1,method:"list",params:{additional:["schedule","next_bkp_time","last_bkp_time","last_bkp_result"]}},interval:10,immediate:true,scope:this,status_callback:this.onActivateScheduleDone})},onStopPolling:function(){this.pollUnreg(this.pollingID)},onGridCellClick:function(){},onClick:function(d,c,b){this.callParent(arguments);var a=Ext.fly(c);if(a&&(a.hasClass("help_link"))){SYNO.SDS.AppLaunch("SYNO.SDS.Backup.Application",{fn:"SYNO.SDS.Backup.LogsPage"})}},onDeactivateScheduleView:function(){this.onStopPolling()},onActivateScheduleView:function(){this.onStartPolling()},getColumnModel:function(){if(this.cmSystemLog){return this.cmSystemLog}var a=new Ext.grid.ColumnModel({columns:[{id:"bkpstatus",width:290,renderer:this.backupTaskRenderer.createDelegate(this)}]});this.cmSystemLog=a;return a},getStore:function(){if(this.dsSystemLog){return this.dsSystemLog}var a=new Ext.data.Store({reader:new Ext.data.ArrayReader({},[{name:"type"},{name:"task"},{name:"tasks"},{name:"status"},{name:"total"},{name:"time"}])});this.dsSystemLog=a;this.addManagedComponent(a);return a},getTime:function(b){var a=parseInt(b,10);return String.format("{0}:{1}",String.leftPad(Math.floor(a/60),2,"0"),String.leftPad(a%60,2,"0"))},taskRender:function(a,b){var c=_T("widget",a);if(c){return String.format(c,b)}return a},contentRender:function(b,a,e){var c=this.taskRender(b,e);var d=String.format('<div class = "syno-sds-backupapp-scedule-task" ext:qtip="{1}">{0}: {2}</div>',_T("localbkp","localbkp_bkpset_name"),Ext.util.Format.htmlEncode(Ext.util.Format.htmlEncode(c)),Ext.util.Format.htmlEncode(c));if(a){d+=String.format('<div ext:qtip="{2}">{0}: {1}</div>',_T("widget","backup_status"),a,Ext.util.Format.htmlEncode(a))}return d},backupTaskRenderer:function(c,a,b){return new SYNO.SDS.Backup.BackupTaskView(b.json).getDecorator()},getLastBkp:function(h){var b={},f=[],g=[],e=[],a=[];var d=["syno-sds-backupapp-scedule-icon inactive","syno-sds-backupapp-scedule-icon active"];h.each(function(i){if("success"===i.last_bkp_result||"done"===i.last_bkp_result){f.push(i)}else{if("failed"===i.last_bkp_result){g.push(i)}else{if("partial"===i.last_bkp_result){a.push(i)}else{e.push(i)}}}},this);var c=function(j,i){return new Date(i.last_bkp_time).getTime()-new Date(j.last_bkp_time).getTime()};f.sort(c);g.sort(c);a.sort(c);b.title=_T("widget","last_backup");b.cls="syno-sds-backupapp-scedule-enable";if(g.length===1){g[0]=SYNO.SDS.Backup.TaskDisplayFormat(g[0]);b.name=g[0].name;b.time=g[0].last_bkp_time;b.iconCls=d[0];b.content=this.contentRender(g[0].name,g[0].last_bkp_result_str,0)}else{if(g.length>1){g[0]=SYNO.SDS.Backup.TaskDisplayFormat(g[0]);b.name="more_failed";b.time="";b.iconCls=d[0];b.content=this.contentRender("more_failed",g[0].last_bkp_result_str,g.length)}else{if(a.length===1){a[0]=SYNO.SDS.Backup.TaskDisplayFormat(a[0]);b.name=a[0].name;b.time=a[0].last_bkp_time;b.iconCls=d[0];b.content=this.contentRender(a[0].name,a[0].last_bkp_result_str,0)}else{if(a.length>1){g[0]=SYNO.SDS.Backup.TaskDisplayFormat(a[0]);b.name="more_partial";b.time="";b.iconCls=d[0];b.content=this.contentRender("more_partial",a[0].last_bkp_result_str,a.length)}else{if(f.length>0){f[0]=SYNO.SDS.Backup.TaskDisplayFormat(f[0]);b.name=f[0].name;b.time=f[0].last_bkp_time;b.iconCls=d[1];b.content=this.contentRender(f[0].name,f[0].last_bkp_result_str,0)}else{b.name="no_backup";b.time=String.format("--{0}--{0}--",_T("common","colon"));b.iconCls=d[0];b.content=this.contentRender("no_backup","",0)}}}}}return b},getNextBkp:function(e){var d=[],a={};var c=["syno-sds-backupapp-scedule-icon inactive","syno-sds-backupapp-scedule-icon active"];e.each(function(f){f.next_bkp_epoch_time=Date.parseDate(f.next_bkp_time,"Y-m-d H:i");if(undefined!==f.next_bkp_epoch_time){d.push(f)}},this);var b=function(g,f){if(undefined!==g.next_bkp_epoch_time){return -1}else{if(undefined!==f.next_bkp_epoch_time){return 1}else{return g.next_bkp_epoch_time-f.next_bkp_epoch_time}}};d.sort(b);a.title=_T("widget","next_backup");a.cls="syno-sds-backupapp-scedule-enable";if(0!==d.length){a.name=d[0].name;a.iconCls=c[1];a.time=d[0].next_bkp_time}else{a.name="no_backup";a.iconCls=c[0];a.time=String.format("--{0}--{0}--",_T("common","colon"))}a.content=this.contentRender(a.name,"",0);return a},ProcessBackupStatus:function(b){var a=[];a.push(this.getLastBkp(b));a.push(this.getNextBkp(b));this.getStore().loadData(a,false);this.doLayout()},onActivate:function(){this.onStartPolling()},onDeactivate:function(){this.onStopPolling()}});SYNO.SDS.Backup.BackupTaskView=function(a){this.cfg=a;this.getDecorator=function(){return String.format('<div class = "{0}">{1}</div>',this.cfg.cls,this.getContent(this.cfg))};this.getContent=function(b){var c=String.format('<div class = "{0}"></div>',b.iconCls);var e=String.format('<div class = "syno-sds-backupapp-scedule-title-bar"><div class = "syno-sds-backupapp-scedule-title" ext:qtip="{0}">{0}</div><span class = "syno-sds-backupapp-scedule-time" ext:qtip="{1}">{1}</span></div>',b.title,b.time);var d=String.format('<div class = "{0}">{1}</div>',b.contentCls,b.content);return c+'<div class = "syno-sds-backupapp-scedule-content">'+e+d+"</div>"}};Ext.define("SYNO.SDS.Backup.Application",{extend:"SYNO.SDS.AppInstance",appWindowName:"SYNO.SDS.Backup.MainWindow"});Ext.define("SYNO.SDS.Backup.MainWindow",{extend:"SYNO.SDS.PageListAppWindow",activePage:"SYNO.SDS.Backup.OverviewPage",constructor:function(b){var a=[{text:_T("backup","overview"),iconCls:"icon-overview",fn:"SYNO.SDS.Backup.OverviewPage"},{text:_T("tree","leaf_backup"),iconCls:"icon-backup",help:"BackupApp/databackup.html",fn:"SYNO.SDS.Backup.BackupTaskPage"},{text:_T("desktop","restore"),iconCls:"icon-restore",help:"BackupApp/restore.html",fn:"SYNO.SDS.Backup.Restore.MainPage"},{text:_T("backup","bkp_storage"),iconCls:"icon-repository",help:"BackupApp/repository.html",fn:"SYNO.SDS.Backup.Repository.MainPage"}];if(this._D("netbkp")==="yes"||this._D("support_img_backupd")==="yes"){a.push({text:_T("backup","service_opt"),iconCls:"icon-server-option",help:"BackupApp/netbkp_service.html",fn:"SYNO.SDS.Backup.ServerOptionPage"})}a.push({text:_T("backup","replication"),iconCls:"icon-s2s",help:"BackupApp/sharesync_service.html",fn:"SYNO.SDS.S2S.S2STaskPage"},{text:_T("tree","leaf_log"),iconCls:"icon-logs",fn:"SYNO.SDS.Backup.LogsPage"});var c=this.callParent([Ext.apply({cls:"syno-app-backup",width:990,height:580,minWidth:930,minHeight:440,listItems:a},b)]);SYNO.SDS.Backup.CGI_BACKUP=this.getURL("backup.cgi");SYNO.SDS.Backup.CGI_LUNBACKUP=this.getURL("lunbackup.cgi");return c},getURL:function(a){return this.jsConfig.jsBaseURL+"/"+a}});