/* Copyright (c) 2015 Synology Inc. All rights reserved. */

Ext.define("SYNO.SDS.DSMNotify.ShowAllDialog",{extend:"SYNO.SDS.AppWindow",itemsPerPage:50,constructor:function(a){this.callParent([this.fillConfig(a)]);this.on("show",function(){this.grid.getStore().load({params:{start:0,limit:this.itemsPerPage}})},this);this.mon(SYNO.SDS.StatusNotifier,"notificationPanelClearAll",function(){this.paging.changePage(1)},this)},fillConfig:function(a){var b={width:600,height:300,showHelp:false,minimizable:false,toggleMinimizable:false,pinable:false,layout:"fit",items:[this.getGridPanel()]};Ext.apply(b,a);return b},onClose:function(){this.hide();return false},getGridPanel:function(){var a=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"modules/DSMNotify/dsmnotify.cgi",method:"POST"}),baseParams:{action:"load",all:true},reader:new Ext.data.JsonReader({root:"data.items",totalProperty:"data.total"},["title","msg","time","className","fn"]),sortInfo:{field:"time",direction:"DESC"},listeners:{scope:this,load:function(){if(!_S("demo_mode")){Ext.getCmp(this.clearAllBtnId).setDisabled(0===this.grid.getStore().getCount())}}}});this.paging=new SYNO.ux.PagingToolbar({store:a,displayInfo:true,pageSize:this.itemsPerPage,refreshText:_T("log","log_reload")});this.grid=new SYNO.ux.GridPanel({title:_T("dsmnotify","title"),loadMask:true,stripeRows:true,store:a,colModel:new Ext.grid.ColumnModel({defaults:{width:50,sortable:true},columns:[{header:_T("backup","application"),dataIndex:"title",renderer:this.titleRenderer},{width:120,header:_T("notification","notification_content"),dataIndex:"msg",id:"msg",renderer:this.msgRenderer},{header:_T("log","log_time"),dataIndex:"time",renderer:this.timeRenderer}]}),autoExpandColumn:"msg",sm:new Ext.grid.RowSelectionModel({singleSelect:true}),bbar:this.paging,tbar:new Ext.Toolbar({defaultType:"syno_button",items:[{text:_T("log","log_reload"),scope:this,handler:function(){this.paging.doRefresh()}},{text:_T("dsmnotify","clearall"),scope:this,handler:this.clearAll,id:this.clearAllBtnId=Ext.id(),disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}]})});return this.grid},clearAll:function(){this.grid.getStore().removeAll();Ext.Ajax.request({url:"modules/DSMNotify/dsmnotify.cgi",method:"POST",params:{action:"apply",clean:"all"},scope:this,success:function(a,b){this.paging.changePage(1);SYNO.SDS.StatusNotifier.fireEvent("checknotify")}});Ext.getCmp(this.clearAllBtnId).setDisabled(true)},timeRenderer:function(a){var b=(new Date(a*1000)).format("Y-m-d H:i:s");return'<div ext:qtip="'+b+'">'+b+"</div>"},msgRenderer:function(e,b,a){var d=SYNO.SDS.DSMNotify.Utils.getMsg(e,true,a.data.className,a.data.fn);var c=Ext.util.Format.htmlEncode(d);return String.format('<div class="{0}" ext:qtip="{1}">{2}</div>',SYNO.SDS.Utils.SelectableCLS,c,d)},titleRenderer:function(e,b,a){var d=SYNO.SDS.DSMNotify.Utils.getTitle(e,true,a.data.className,a.data.fn);var c=Ext.util.Format.htmlEncode(d);return String.format('<div class="{0}" ext:qtip="{1}">{2}</div>',SYNO.SDS.Utils.SelectableCLS,c,d)}});Ext.define("SYNO.SDS.DSMNotify.DSMUpdateAction",{singleton:true,msgBox:null,getMsgBox:function(){if(!this.msgBox||this.msgBox.isDestroyed){this.msgBox=new SYNO.SDS.MessageBoxV5({modal:true,draggable:false,renderTo:document.body})}return this.msgBox.getWrapper()},checkAutoUpdate:function(){SYNO.API.Request({api:"SYNO.Core.Upgrade.AutoUpgrade",method:"status",version:1,scope:this,callback:function(d,a,c,b){if(!d){return}if(!a.autoupdate_status){return}if("preparing"===a.autoupdate_status){this.getMsgBox().confirm(_T("update","autoupdate_title"),_T("update","autoupdate_noti_cancel_confirm_text"),this.cancelAutoUpdate,this);return}else{if("running"===a.autoupdate_status){this.getMsgBox().alert(_T("update","autoupdate_title"),_T("update","autoupdate_cancel_failed_running"))}else{this.getMsgBox().alert(_T("update","autoupdate_title"),_T("update","autoupdate_cancel_failed_no_task"))}}}})},cancelAutoUpdate:function(a){if("yes"!==a){return}var b=_T("update","autoupdate_cancel_failed");SYNO.API.Request({api:"SYNO.Core.Upgrade.AutoUpgrade",method:"cancel",version:1,scope:this,callback:function(f,c,e,d){if(!f){if(c&&c.code){b=SYNO.API.getErrorString(c.code)}}else{b=_T("update","autoupdate_cancel_success")}this.getMsgBox().alert(_T("update","autoupdate_title"),b)}})}});Ext.define("SYNO.SDS.DSMNotify.Utils",{statics:{isAppEnabled:function(a){return Ext.isEmpty(a)||(SYNO.SDS.StatusNotifier.isAppEnabled(a)===true)},getTitle:function(d,a,c,b){if(this.isAppEnabled(c)!==true){return _T("dsmnotify","error_title")}return this.localizeMsgByFn(b,a,c)||this.localizeMsg(d,a,c)},getMsg:function(d,a,c,b){if(this.isAppEnabled(c)!==true){return _T("dsmnotify","error_msg")}return this.localizeMsgByFn(b,a,c)||this.localizeMsg(d,a,c)},localizeMsgByFn:function(g,b,d){var e=[],f,c;if(!Ext.isArray(g)){g=[g]}for(var a=1;a<g.length;a++){e.push(SYNO.SDS.Utils.GetLocalizedString(g[a]+"",d))}c=Ext.isString(g[0])?Ext.getClassByName(g[0]):"";if(!Ext.isEmpty(c)){f=c.apply(window,e)}if(b){return Ext.util.Format.stripTags(f)}else{return f}},localizeMsg:function(f,b,c){var d=[],e;if(!Ext.isArray(f)){f=[f]}for(var a=0;a<f.length;a++){d.push(SYNO.SDS.Utils.GetLocalizedString(f[a],c))}e=String.format.apply(String,d);if(b){return Ext.util.Format.stripTags(e)}else{return e}}}});Ext.define("SYNO.SDS.DSMNotify.Application",{extend:"SYNO.SDS.AppInstance",trayItem:[],initInstance:function(a){if(!this.trayItem[0]){this.trayItem[0]=new SYNO.SDS.DSMNotify.Tray({appInstance:this});this.addInstance(this.trayItem);this.trayItem[0].open(a)}this.createShowAllWindow();Ext.getCmp("sds-taskbar").doLayout()},createShowAllWindow:function(){if(!this.window){this.window=new SYNO.SDS.DSMNotify.ShowAllDialog({appInstance:this});this.addInstance(this.window)}},onRequest:function(a){if("showPanel"==a.action){this.trayItem[0].onClick()}}});Ext.define("SYNO.SDS.DSMNotify.Tray",{extend:"SYNO.SDS.AppTrayItem",panel:null,constructor:function(a){SYNO.SDS.DSMNotify.Tray.superclass.constructor.apply(this,arguments);this.panel=new SYNO.SDS.DSMNotify.Panel({module:this,baseURL:this.jsConfig.jsBaseURL});this.addManagedComponent(this.panel);this.mon(Ext.getDoc(),"mousedown",this.onMouseDown,this);this.mon(SYNO.SDS.StatusNotifier,"checknotify",this.panel.reload,this.panel);this.mon(SYNO.SDS.StatusNotifier,"systemTrayNotifyMsg",this.panel.hide.createDelegate(this.panel,[true],false),this.panel);Ext.EventManager.onWindowResize(this.adjustPos,this)},onMouseDown:function(a){if(a.within(this.taskButton.el)){return}if(this.panel.isVisible()&&!a.within(this.panel.el)){this.panel.hideBox()}},onBeforeDestroy:function(){this.panel=null;SYNO.SDS.DSMNotify.Tray.superclass.onBeforeDestroy.apply(this,arguments)},adjustPos:function(){if(this.panel.isVisible()){this.panel.el.alignTo(Ext.getBody(),"tr-tr",[0,SYNO.SDS.TaskBar.getHeight()])}},onClick:function(){if(this.panel.isVisible()){this.panel.hideBox()}else{SYNO.SDS.StatusNotifier.fireEvent("taskBarPanelShow");this.panel.show();this.panel.el.alignTo(Ext.getBody(),"tr-tr",[0,SYNO.SDS.TaskBar.getHeight()])}}});Ext.define("SYNO.SDS.DSMNotify.Panel",{extend:"Ext.Panel",storeId:"NotificationCenterTray",maxUnreadNum:30,currentUnreadNum:0,lastSeen:0,lastRead:0,pollTask:null,pollTaskConfig:null,pollingInterval:30*1000,reloadTask:null,reloadDelay:1000,badgeNumberId:Ext.id(),currentData:null,badge:null,constructor:function(a){SYNO.SDS.DSMNotify.Panel.superclass.constructor.call(this,Ext.apply({hidden:true,floating:true,shadow:false,title:_T("dsmnotify","title"),height:Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight(),cls:"sds-notify-tray-panel",renderTo:document.body,layout:"fit",bbar:[{xtype:"syno_button",btnStyle:"blue",text:_T("common","show_all"),scope:this,handler:this.onClickShowAll,id:this.showAllBtnId=Ext.id()},{xtype:"tbfill"},{xtype:"syno_button",btnStyle:"grey",text:_T("dsmnotify","clearall"),scope:this,handler:this.onClickClear,disabled:_S("demo_mode"),tooltip:_S("demo_mode")?_JSLIBSTR("uicommon","error_demo"):""}],items:new SYNO.ux.FleXcroll.DataView({itemSelector:"div.item",setEmptyText:function(){return String.format('<div class="sds-notify-empty-text" style="line-height:{0}px">{1}</div>',Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight()-36-48,_T("dsmnotify","empty_text"))},emptyText:this.setEmptyText,itemId:"dataview",cls:"sds-notify-tray-panel-dataview",refresh:function(){this.emptyText=this.setEmptyText();SYNO.ux.FleXcroll.DataView.superclass.refresh.call(this)},store:new Ext.data.JsonStore({autoDestroy:true,storeId:this.storeId,fields:["title","contents","read","className","fn"]}),tpl:new Ext.XTemplate('<div class="sds-notify-tray-panel-dataview-wrapper">','<tpl for=".">','<div class="item">','<tpl if="read == false"> <div class="unreaditem"><span class="badge" style="{[this.showUnreadBadgeNumber(values.contents, values.read)]}"></span></tpl>','<tpl if="read == true"> <div class="readitem"> </tpl>','<div class="title" ext:qtip="{[this.localizeTitleNoTags(values.title, true, values.className)]}">{[this.showUnreadTagLeft(values.read)]}{[this.localizeTitle(values.title, false, values.className)]}{[this.showUnreadTagRight(values.read)]}</div>','<tpl for="contents">','<div class="msg {this.selectableCls}" ext:qtip="{[this.localizeNoTags(values.msg, true, values.className, values.fn)]}">{[this.localize(values.msg, false, values.className, values.fn)]}</div>','<div class="time">{[(new Date(values.time * 1000)).format("Y-m-d H:i:s")]}</div>',"</tpl>",'<div class="sds-notify-tray-panel-split"></div>',"</div>","</div>","</tpl>","</div>",{compiled:true,disableFormats:true,localizeTitle:this.getTitle.createDelegate(this,[false],true),localizeTitleNoTags:this.encodedTitle.createDelegate(this,[true],true),localize:this.getMsg.createDelegate(this,[false],true),localizeNoTags:this.encodedMsg.createDelegate(this,[true],true),showUnreadTagLeft:this.showUnreadTag.createDelegate(this,[true],true),showUnreadTagRight:this.showUnreadTag.createDelegate(this,[false],true),showUnreadBadgeNumber:this.showUnreadBadgeNumber.createDelegate(this,[false],true),selectableCls:SYNO.SDS.Utils.SelectableCLS})})},a));Ext.StoreMgr.get(this.storeId).removeAll();this.lastRead=SYNO.SDS.UserSettings.getProperty(this.module.jsConfig.jsID,"lastRead")||0;this.pollTaskConfig={interval:this.pollingInterval,autoJsonDecode:true,url:this.baseURL+"/dsmnotify.cgi",method:"POST",params:{action:"load",lastRead:this.lastRead,lastSeen:this.lastSeen},scope:this,success:this.onFirstData};this.pollTask=this.addAjaxTask(this.pollTaskConfig).start(true);this.reloadTask=new Ext.util.DelayedTask(this.pollTask.restart,this.pollTask);this.mon(SYNO.SDS.StatusNotifier,"redirect",this.pollTask.stop,this.pollTask);this.mon(SYNO.SDS.StatusNotifier,"halt",this.pollTask.stop,this.pollTask)},reload:function(){this.reloadTask.delay(this.reloadDelay)},showUnreadTag:function(b,a){if(!b){if(a){return"<b>"}return"</b>"}return""},getTitle:function(d,a,c,b){return SYNO.SDS.DSMNotify.Utils.getTitle(d,a,c,b)},getMsg:function(d,a,c,b){return SYNO.SDS.DSMNotify.Utils.getMsg(d,a,c,b)},encodedMsg:function(d,a,c,b){return Ext.util.Format.htmlEncode(this.getMsg(d,a,c,b))},encodedTitle:function(d,a,c,b){return Ext.util.Format.htmlEncode(this.getTitle(d,a,c,b))},sendNotify:function(b){if(!Ext.isArray(b)){return}var a=b[0].time;Ext.each(b,function(c){var d=SYNO.SDS.AppMgr.getByAppName(c.className);if(c.time<=this.lastSeen||(d.length>0&&false===d[0].shouldNotifyMsg(c.tag,c))||c.time>a){return}a=c.time;SYNO.SDS.SystemTray.notifyMsg(c.className,this.getTitle(c.title,false,c.className),this.getMsg(c.msg,false,c.className,c.fn))},this)},onClickClear:function(){Ext.StoreMgr.get(this.storeId).removeAll();this.hideBox();Ext.Ajax.request({url:this.baseURL+"/dsmnotify.cgi",method:"POST",params:{action:"apply",clean:"all"},scope:this,success:function(a,b){SYNO.SDS.StatusNotifier.fireEvent("notificationPanelClearAll")}});this.currentData=null},onClickShowAll:function(){this.module.appInstance.window.open();this.hideBox()},getFormatData:function(){var h=[];var c={};var d=[];var e=0,g,f;if(!this.currentData){return null}for(e=0;e<this.currentData.total;e++){g=this.currentData.items[e];if(g.time>this.lastRead){if(!(c[g.title] instanceof Array)){c[g.title]=[]}c[g.title].push(g)}else{f={};f.read=true;f.contents=new Array(g);f.title=g.title;f.className=g.className;d.push(f)}}for(var a in c){if(c.hasOwnProperty(a)){f={};f.read=false;f.title=a;for(e=0;e<c[a].size();e++){var b=c[a][e];if(!(f.contents instanceof Array)){f.contents=[]}f.contents.push(b);f.className=b.className}h.push(f)}}h=h.concat(d);return h},onShow:function(){var b=this.getFormatData();this.lastRead=this.lastSeen;this.pollTaskConfig.params.lastRead=this.lastRead;SYNO.SDS.UserSettings.setProperty(this.module.jsConfig.jsID,"lastRead",this.lastRead);SYNO.SDS.DSMNotify.Panel.superclass.onShow.apply(this,arguments);this.pollTask.stop();var a=_T("common","show_all");if(this.currentUnreadNum>this.maxUnreadNum){a=_T("common","unread").replace("{@}",(this.currentUnreadNum-this.maxUnreadNum))}Ext.getCmp(this.showAllBtnId).setText(a);if(!Ext.isEmpty(this.currentData)){Ext.StoreMgr.get(this.storeId).loadData(b)}this.setHeight(Ext.lib.Dom.getViewHeight()-SYNO.SDS.TaskBar.getHeight());if(this.badge){this.badge.setNum(0)}},onFirstData:function(a,b){if(!a.success){return}this.currentData=a.data;if(Ext.isArray(a.data.items)&&a.data.items.length){this.lastSeen=a.data.items[0].time;if(!_S("demo_mode")&&a.data.unread>0){Ext.defer(this.updateUnreadNumber,500,this,[a.data.unread])}}Ext.apply(this.pollTaskConfig,{interval:this.pollingInterval,params:{action:"load",lastRead:this.lastRead,lastSeen:this.lastSeen},success:this.onPaddingData});this.pollTask.applyConfig(this.pollTaskConfig);this.updateGroupSettingsMTime(a.data)},onPaddingData:function(a,b){if(!a.success){return}this.updateGroupSettingsMTime(a.data);if(!Ext.isArray(a.data.items)){return}if(0===a.data.items.length){Ext.StoreMgr.get(this.storeId).removeAll();this.hideBox(true);return}this.sendNotify(a.data.items);this.lastSeen=a.data.items[0].time;this.pollTaskConfig.params.lastRead=this.lastRead;this.pollTaskConfig.params.lastSeen=this.lastSeen;this.pollTask.applyConfig(this.pollTaskConfig);this.currentData=a.data;if(this.isVisible()){Ext.StoreMgr.get(this.storeId).loadData(this.getFormatData())}if(!this.isVisible()){Ext.defer(this.updateUnreadNumber,500,this,[a.data.unread])}},updateGroupSettingsMTime:function(a){if(a&&a.admingrpsetmtime){SYNO.SDS.GroupSettings.reload(a.admingrpsetmtime)}},showUnreadBadgeNumber:function(d,b){if(true===b){return""}var c=d.size();if(c===0){return""}if(c>99){c=100}var a=(14*(c-1));return String.format("background-position: left -{0}px",a)},updateUnreadNumber:function(a){if(!this.badge){this.badge=new SYNO.SDS.Utils.Notify.Badge({badgeClassName:"sds-notify-badge-num badge-fix-position",renderTo:this.module.taskButton.btnEl,alignOffset:[0,-3]});this.module.taskButton.badge=this.badge}else{if(this.badge){this.badge.updateBadgePos()}}if(this.badge.badgeNum!=a){this.badge.setNum(a)}},hideBox:function(a){if(!a){this.pollTask.start()}this.module.taskButton.toggle(false,true);this.hide()}});