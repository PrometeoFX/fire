/* All rights reserved. */

Ext.namespace("SYNO.SDS.PixlrImageEditor");SYNO.SDS.PixlrImageEditor.Application=Ext.extend(SYNO.SDS.AppInstance,{appWindowName:"SYNO.SDS.PixlrImageEditor.MainWindow"});SYNO.SDS.PixlrImageEditor.MainWindow=Ext.extend(SYNO.SDS.LegacyAppWindow,{pixlrlang:{cht:"zh-tw",chs:"zh-cn",enu:"en",ger:"de",jpn:"jp",krn:"kr",spn:"es",fre:"fr",ita:"it",ptb:"pt-br",ptg:"pt-br",hun:"en",trk:"tr",rus:"ru",dan:"dk",sve:"sv",nor:"no",nld:"nl",plk:"pl",csy:"cs"},picniklang:{cht:"zh_HK",chs:"zh_CN",enu:"en_US",ger:"de_DE",jpn:"jp_JP",krn:"ko_KR",spn:"es_ES",fre:"fr_FR",ita:"it_IR",ptb:"pt_BR",ptg:"pt_BR",hun:"en_US",trk:"en_US",rus:"ru_RU",dan:"en_US",sve:"sv_SV",nor:"no_NO",nld:"en_US",plk:"en_US",csy:"en_US"},cls:"syno-sds-pixlr-win",blPostMessage:!Ext.isGecko,constructor:function(a){SYNO.SDS.PixlrImageEditor.MainWindow.superclass.constructor.call(this,Ext.apply(a,{pinable:false,showHelp:false}));this.initMessager()},onOpen:function(a){SYNO.SDS.PixlrImageEditor.MainWindow.superclass.onOpen.apply(this,arguments);return this.onRequest(a)},onRequest:function(a){this.setDoc(a.herf,a.mode,a.path);return SYNO.SDS.PixlrImageEditor.MainWindow.superclass.onRequest.apply(this,arguments)},destory:function(){if(this.blPostMessage){Ext.EventManager.un(window,"message",this.onPostMessasge,this)}return SYNO.SDS.PixlrImageEditor.MainWindow.superclass.destory.apply(this,arguments)},initMessager:function(b){if(this.blPostMessage){Ext.EventManager.on(window,"message",this.onPostMessasge,this)}else{var a=this.addTask({interval:800,run:function(){var d=document.location.hash,c=/^#?\d+&/;if(d!==this.last_hash&&c.test(d)){a.stop();this.last_hash=d;this.onMessasge(Ext.decode(decodeURIComponent(d.replace(c,""))));document.location.hash=""}},scope:this}).start(false)}this.addAjaxTask({url:this.jsConfig.jsBaseURL+"/editor.cgi",interval:_S("dsm_timeout")*30000,method:"POST",params:{action:"avoid_timeout"}}).start(false)},onPostMessasge:function(a){if(a.browserEvent.origin!==this.herf){return}this.onMessasge(Ext.decode(a.browserEvent.data))},onMessasge:function(a){if(a&&a.action=="save"&&a.taskid){this.getEl().mask(_T("common","saving"));this.polltask=this.addAjaxTask({interval:1000,autoJsonDecode:true,url:this.jsConfig.jsBaseURL+"/editor.cgi",method:"POST",params:{action:"read",taskid:a.taskid},scope:this,success:this.onSaveSuccess}).start(true)}else{if(a&&a.action=="exit"){window.close()}else{var b=_T("error","error_error_system");if(a&&a.errno){b=_T(a.errno.section,a.errno.key)}this.getMsgBox().alert(this.title,b,function(){window.close()})}}},onSaveSuccess:function(c){if(c.success&&false===c.running){var b=c.data;this.getEl().unmask();this.polltask.stop();var d=String.format(_T("pixlr","save_image"),Ext.util.Format.htmlEncode(b.filename));if(!b.success){var a='<a class="allowDefCtxMenu" href="'+b.url+'">'+Ext.util.Format.ellipsis(b.url,100)+"</a>";d=String.format(_T("pixlr","save_err"),a);if(b.errno){d+="<br>("+_T("error","error_error")+": "+_T(b.errno.section,b.errno.key)+")"}}this.getMsgBox().alert(this.title,d,function(){window.close()})}},getLang:function(a){if(a=="picnik"){return this.picniklang[_S("lang")]}return this.pixlrlang[_S("lang")]},setDoc:function(r,e,g){var i=g.substr(0,g.lastIndexOf("/"));var m=window.location.protocol+"//apps.pixlr.com/"+e+"/?method=get",k=g.substr(1+g.lastIndexOf("/"));var c=Ext.util.Cookies.get("id");if(e=="picnik"){m=window.location.protocol+"//www.picnik.com/service/?method=get&_apikey=a713c3535ee61b4c0b751058afa39e4a"}var n=k;var a=encodeURIComponent(n);var b=SYNO.webfm.utils.bin2hex(g);var h="fbdownload";var d=k.substr(k.lastIndexOf(".")+1);var f=String.format("{0}/"+h+"/{1}?dlink={2}&_sid={3}&SynoToken={4}&mode=open&ip=false&_dc={5}&f=f.{6}",r,a,b,c,(_S("SynoToken")||"token"),(new Date().getTime()),d);var p=String.format("{0}//{1}",window.location.protocol,window.location.host);var l=String.format(p+"/webman/"+this.jsConfig.jsBaseURL+"/editor.cgi?sid={0}&_dc={1}",c,(new Date().getTime()));this.herf=p;var o={referrer:_S("hostname"),image:f,title:n,target:Ext.urlAppend(l,Ext.urlEncode({action:"save",path:SYNO.webfm.utils.bin2hex(i),name:k,mode:e,pm:this.blPostMessage})),exit:"javascript:window.parent.close()",loc:this.getLang()};if(e=="picnik"){o._import=o.image;o._export=o.target;o._host_name=o.referrer;o._title=o.title;o._export_method="GET";o._export_agent="browser";o.type="jpg";o._locale=this.getLang("picnik");o._exclude="in,create,out";delete o.image;delete o.referrer;delete o.target;delete o.exit;delete o.loc}for(var j in o){if(o.hasOwnProperty(j)){m+="&"+j+"="+encodeURIComponent(o[j])}}this.setURL(Ext.SSL_SECURE_URL);this.setURL.defer(500,this,[m]);var q=(("picnik"===e)?"Picnik":(("editor"===e)?"Pixlr Editor":"Pixlr Express"));document.title=q+" - "+Ext.util.Format.htmlEncode(k)}});